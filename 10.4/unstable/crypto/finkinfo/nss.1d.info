Package: nss.1d
Version: 3.12.6
Revision: 1
Architecture: powerpc, i386
BuildDepends: <<
	fink (>= 0.24.12),
	nspr.0d,
	sqlite3 (>= 3.6.13-3)
<<
Depends: %N-shlibs (= %v-%r)
BuildDependsOnly: true
BuildConflicts: nspr
Source: ftp://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/NSS_3_12_6_RTM/src/nss-%v.tar.gz
Source-MD5: da42596665f226de5eb3ecfc1ec57cd1
SourceDirectory: nss-%v/mozilla/security
PatchFile: %n.patch
PatchFile-MD5: 04624808214a982ca6ca686d548ccd92
PatchScript: <<
#!/bin/sh -ev
	patch -p3 < %{PatchFile}
	cp %p/include/sqlite3.h nss/lib/sqlite

	echo "NSS is available under the Mozilla Public License, the GNU General Public License, and the GNU Lesser General Public License." > LICENSE
<<
NoSetCPPFLAGS: true
NoSetLDFLAGS: true
NoSetMAKEFLAGS: true
SetMAKEFLAGS: MOZILLA_CLIENT=1 NSPR_INCLUDE_DIR=%p/include/nspr NSPR_LIB_DIR=%p/lib/nspr SQLITE_LIB_DIR=%p/lib libdir=%p/lib/nss
CompileScript: <<
	make -C nss build_coreconf
	make -C dbm all
	make -C nss/lib/sqlite all
	make -C nss all

	sed 's,@VERSION@,%v,; s,@prefix@,%p,' nss.pc.in > nss.pc
	sed 's,@MOD_MAJOR_VERSION@,3,; s,@MOD_MINOR_VERSION@,12,; s,@MOD_PATCH_VERSION@,6,; s,@prefix@,%p,' nss-config.in > nss-config

<<
InstallScript: <<
#!/bin/sh -ev
	libdir=%p/lib/nss

	mkdir -p %d$libdir
	for file in \
		libnss3.dylib \
		libnssckbi.1d.so \
		libnssutil3.dylib \
		libsmime3.dylib \
		libssl3.dylib \
	; do
		install -m 644 ../dist/*.OBJ/lib/$file %d$libdir
	done

	SO_VERSION=1d
	pushd %d$libdir
		files=lib*.dylib
		linkers="lib*.dylib lib*.so"
		echo "adjusting sonames of '$files' and links to them in '$linkes'"
		# loop through all linker libs
		for file in $files; do
			sofile=`echo $file | sed "s/\.dylib$/.${SO_VERSION}&/"`

			# change SONAME to include libversion
			install_name_tool -id $libdir/$sofile $file

			# place actual file at libversioned, leaving ld link
			mv $file $sofile
			ln -s $sofile $file

			# change dyld links pointing to SONAME
			for dylib in $linkers; do
				install_name_tool -change $libdir/$file $libdir/$sofile $dylib
			done
		done
	popd

	mkdir -p %i/lib/pkgconfig
	install -m 644 nss.pc %i/lib/pkgconfig

	mkdir -p %i/bin
	install -m 755 nss-config %i/bin

	mkdir -p %i/include/nss
	install -m 644 ../dist/public/nss/*.h %i/include/nss
<<
DocFiles: LICENSE
SplitOff: <<
	Package: %N-shlibs
	Depends: <<
		nspr.0d-shlibs,
		sqlite3-shlibs (>= 3.6.13-3)
	<<
	Files: <<
		lib/nss/lib*.1d.dylib
		lib/nss/lib*.1d.so
	<<
	Shlibs: <<
		%p/lib/nss/libnss3.1d.dylib 1.0.1 %n (>= 3.12.6-1)
		%p/lib/nss/libnssutil3.1d.dylib 1.0.1 %n (>= 3.12.6-1)
		%p/lib/nss/libsmime3.1d.dylib 1.0.1 %n (>= 3.12.6-1)
		%p/lib/nss/libssl3.1d.dylib 1.0.1 %n (>= 3.12.6-1)
	<<
	DocFiles: LICENSE
<<
SplitOff2: <<
	Package: %N-bin
	Depends: <<
		%N-shlibs (>= %v-%r),
		nspr.0d-shlibs,
		sqlite3-shlibs (>= 3.6.13-3)
	<<
	InstallScript: <<
		mkdir -p %i/bin
		install -m 755 ../dist/*.OBJ/bin/* %i/bin
	<<
	DocFiles: LICENSE
<<
Description: Network Security Service
DescDetail: <<
This is a set of libraries designed to support cross-platform
development of security-enabled client and server applications. It can
support SSLv2 and v4, TLS, PKCS #5, #7, #11, #12, S/MIME, X.509 v3
certificates and other security standards.
<<
DescPackaging: <<
	Contains export-restricted crypto and upstream makes a big
	deal about following export restrictions even for source
	mirrors. Setting License:Restrictive until we know better.
	"LICENSE" is cut'n'pasted from upstream homepage.

	Follow debian soname packaging convention and makefile magic
	(moz projects don't seem too good about updating install_name
	or compatibility_version when changing interface). Hack our
	install_name after-the-fact instead of fighting makefile zoo.

	3.12.3->3.12.6 added symbols to public headers, so bump
	compatibility_version manually.

	Fix extension of loadable module and make sure it builds with
	libversion to allow placement in -shlibs pkg.

	Bury library files so don't accidentally find them (avoid
	masking other pkgs' buried libs with a top-level one).

	do not use SDKs...don't need portability or fat.

	Not autotooled, just simple makefile, so pass flags as needed
	to get paths for dep libs, etc. Thanks to debian's source
	package for some hints about the variables and that need to
	install by manual copying (and borrowed their nss.pc.in and
	nss-config.in templates also).

	Lots of missing internal dependencies...make sure to build
	libs before other libs need to link against them. Yeesh:/

	Hard to get local-then-global -I ordering, but fortunately,
	nspr has buried headers and libs in its own private location.
	Hack -L for sqlite3 where it's needed, and copy external
	sqlite3.h into internal path (and don't actually build any
	internal lib at all) rather than playing with global -I paths.

	Reported unbuildable on x86_64:
		drbg.c: In function 'RNG_RandomUpdate':
		drbg:509: error: size of array 'arg' is negative
	does lots of word-size determinations, apparently doesn't
	do it correctly/self-consistently on this darwin arch
<<
License: Restrictive
Maintainer: Daniel Macks <dmacks@netspace.org>
Homepage: http://www.mozilla.org/projects/security/pki/nss/
