Package: dbus
Version: 1.2.14
Revision: 1
Description: Message bus system for applications 
License: OSI-Approved
# dual license: Academic Free License, GPL2
Maintainer: Benjamin Reed <dbus@fink.racoonfink.com>

BuildDepends: <<
	autoconf (>= 2.63-1),
	automake1.10,
	expat1,
	fink (>= 0.24.12-1),
	gettext-tools,
	glib2-dev (>= 2.12.0-1),
	gtk-doc (>= 1.8-1),
	libgettext3-dev,
	libiconv-dev,
	libtool2,
	passwd (>= 20060201-1),
	pkgconfig (>= 0.22-1)
<<
Depends: <<
	%N-shlibs (>= %v-%r),
	daemonic,
	expat1-shlibs
<<

Source: http://%n.freedesktop.org/releases/%n/%n-%v.tar.gz
Source-MD5: 2c267ccd45d0b18db8c9edacad63ec98
Source2: http://%n.freedesktop.org/releases/%n-0.62.tar.gz
Source2-MD5: ba7692f63d0e9f1ef06703dff56cb650
Source2ExtractDir: %n-%v
Source3: http://%n.freedesktop.org/releases/%n-glib/%n-glib-0.80.tar.gz
Source3-MD5: 86ea60ba2118a1b9deafe8257f6a6a1a
Source3ExtractDir: %n-%v

PatchFile: %n.patch
PatchFile-MD5: 0289367faf03ac4a4b40f69f35e09a84

PatchScript: <<
	/usr/bin/sed -e 's,DBUS_LAUNCHD_SESSION_BUS_SOCKET,DBUS_FINK_SESSION_BUS_SOCKET,g' -e 's,org.freedesktop.dbus-session,org.finkproject.dbus-session,g' -e 's,@FINKPREFIX@,%p,g' %{PatchFile} | /usr/bin/patch -p1
	perl -pi -e 's,DBUS_LAUNCHD_SESSION_BUS_SOCKET,DBUS_FINK_SESSION_BUS_SOCKET,g; s,org.freedesktop.dbus-session,org.finkproject.dbus-session,g' dbus/*.c dbus/*.h
	autoreconf -fvi
<<

SetCFLAGS: -Os -g
ConfigureParams: <<
	--mandir=%p/share/man \
	--libexecdir=%p/sbin \
	--disable-static \
	--with-dbus-user=messagebus \
	--with-dbus-daemondir=%p/bin \
	--enable-console-owner-file \
	--disable-asserts \
	--disable-tests \
	--enable-checks \
	--enable-kqueue \
	--enable-launchd \
	--with-launchd-agent-dir=%p/share/dbus/launchd \
	--disable-userdb-cache \
	--disable-ansi \
	--with-xml=expat \
	--disable-xml-docs \
	--disable-doxygen-docs \
	--disable-dependency-tracking \
	--without-x \
	ac_cv_func_poll=no
<<
RuntimeVars: DBUS_SESSION_BUS_ADDRESS: launchd:env=DBUS_FINK_SESSION_BUS_SOCKET

CompileScript: <<
#!/bin/sh -ev

	MBID=`id -u messagebus 2>/dev/null || echo 0`
	if [ $MBID -eq 0 ]; then
		echo "You must install the 'passwd' package for D-Bus to build properly."
		exit 1
	fi

	# D-Bus 0.62 for backwards-compatibility
	pushd dbus-0.62
		./configure %c
		pushd dbus
			make
		popd
	popd

	# D-Bus %v
	./configure %c
	make
	# temporary, for the glib bindings
	make -j1 install DESTDIR="%b/tmproot"

	# D-Bus GLib bindings
	pushd dbus-glib*
	PKG_CONFIG_PATH="%b/tmproot%p/lib/pkgconfig" ./configure %c --enable-gtk-doc
	DYLD_LIBRARY_PATH="%b/tmproot%p/lib:$DYLD_LIBRARY_PATH" make DBUS_CFLAGS="-I%b/tmproot%p/include/dbus-1.0 -I%b/tmproot%p/lib/dbus-1.0/include" DBUS_LIBS="%b/dbus/libdbus-1.la"
	popd
<<

InstallScript: <<
#!/bin/sh -ev

	# D-Bus 0.62
	pushd dbus-0.62/dbus
	make -j1 install DESTDIR="%d"
	popd

	# D-Bus %v
	make -j1 install DESTDIR="%d"

	# D-Bus GLib bindings
	pushd dbus-glib*
	make -j1 install DESTDIR="%d"
	popd

	perl -pi -e 's,%b/tmproot,,' %i/lib/*.la

	install -d -m 755 "%i/var/lib/dbus" "%i/var/run/dbus" "%i/share/dbus-1" "%i/etc/dbus-1"

	# the rest
	install -c -m 755 start-*-bus.sh %i/bin/

	install -d -m 755 %i/etc/profile.d
	echo "%p/bin/start-session-bus.sh" > %i/etc/profile.d/%N.sh
	echo "%p/bin/start-session-bus.sh" > %i/etc/profile.d/%N.csh
	chmod 755 %i/etc/profile.d/*

	install -d -m 755 %i/share/%N
	mv %i/bin/dbus-uuidgen %i/share/%N
<<

DocFiles: AUTHORS COPYING ChangeLog HACKING NEWS README*

SplitOff: <<
	Package: %N-shlibs
	Depends: glib2-shlibs (>= 2.12.0-1), libgettext3-shlibs, libiconv, passwd (>= 20060201-1)
	Files: << 
		lib/libdbus-1.*.dylib
		lib/libdbus-glib-1.*.dylib
		share/%N/dbus-uuidgen
	<<
	Shlibs: <<
		%p/lib/libdbus-1.2.dylib      3.0.0 %n (>= 0.60-1)
		%p/lib/libdbus-1.3.dylib      8.0.0 %n (>= 1.2.1-1)
		%p/lib/libdbus-glib-1.2.dylib 4.0.0 %n (>= 0.74-1)
	<<
	DocFiles: COPYING
	PostInstScript: <<
		if [ "$1" = "configure" ]; then
			%p/share/%N/dbus-uuidgen --ensure >>/tmp/%N-postinst.log 2>&1 || :
		fi
	<<
<<

SplitOff2: <<
	Package: %N-dev
	Depends: %N-shlibs (= %v-%r), pkgconfig (>= 0.22-1)
	Replaces: %N (<< %v-%r)
	BuildDependsOnly: true
	Files: <<
		bin/dbus-binding-tool
		include
		lib
	<<
	DocFiles: COPYING
<<

PreInstScript: <<
echo "*** WARNING ***"
echo ""
echo "D-Bus starts a system and session bus on your system by default,"
echo "or a lot of stuff would break.  If you don't want it to do that,"
echo "touch the file '%p/etc/dbus-1/disable-dbus'.  Be warned that many"
echo "Gnome (and other) packages will fail without D-Bus."
echo ""
echo "If you want to disable the system bus, you can run:"
echo "  %p/bin/daemonic disable %N"
echo ""
read -t 10 FOO || :
exit 0
<<

PostInstScript: <<
	if [ "$1" = "configure" ]; then
		if [ -x "%p/bin/daemonic" ]; then
			%p/bin/daemonic install %N >/dev/null 2>&1 || :
			%p/bin/daemonic enable  %N >/dev/null 2>&1 || :
		fi
	fi
	chown -R messagebus:messagebus "%p/var/lib/dbus" "%p/var/run/dbus" "%p/share/dbus" "%p/share/dbus-1" "%p/etc/dbus-1"
	chown root:wheel %p/share/dbus/launchd/org.finkproject.dbus-session.plist
	chmod 644        %p/share/dbus/launchd/org.finkproject.dbus-session.plist
	%p/bin/start-system-bus.sh >/tmp/dbus-postinst.log 2>&1 || :
<<
PostRmScript: <<
	if [ "$1" = "remove" ]; then
		if [ ! -x "%p/bin/daemonic" ]; then
			%p/bin/daemonic disable %N >/dev/null 2>&1 || :
			%p/bin/daemonic remove  %N >/dev/null 2>&1 || :
		fi
	fi
<<

DaemonicFile: <<
	<service>
		<description>D-Bus System Bus</description>
		<message>D-Bus System Bus</message>
		<daemon name="%N">
			<executable background="no">%p/bin/start-system-bus.sh</executable>
		</daemon>
	</service>
<<

DescDetail: <<
By default, D-Bus will enable the session bus whenever you create a
fink-enabled shell (ie, use %p/bin/init.sh).  You can disable this
by touching the file %p/etc/dbus-1/disable-dbus -- the D-Bus
startup scripts will then do nothing.
<<

Homepage: http://dbus.freedesktop.org/
