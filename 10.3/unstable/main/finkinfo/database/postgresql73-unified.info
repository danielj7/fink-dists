Package: postgresql73-unified
Version: 7.3.15
Revision: 11
Description: PostgreSQL open-source database
License: BSD
Maintainer: Benjamin Reed <postgresql73@fink.racoonfink.com>

Depends: readline5-shlibs, passwd (>= 20030906-1), daemonic (>= 20010902-1), %N-shlibs (>= %v-%r)
BuildDepends: readline5, autoconf, bison, system-openssl-dev, passwd (>= 20030906-1)
Conflicts: postgresql-ssl (<< %v-%r), postgresql (<< %v-%r)
Replaces: postgresql (<< %v-%r), postgresql-shlibs, postgresql-ssl-shlibs, postgresql-ssl, postgresql-python, postgresql-ssl-python, postgresql-perl, postgresql-ssl-perl, postgresql73, postgresql73-ssl
GCC: 3.3

CustomMirror: <<
	afr-ZA: ftp://ftp.za.postgresql.org/mirror/ftp.postgresql.org
	asi-CN: ftp://ftp.cn.postgresql.org/ftp.postgresql.org
	asi-GE: ftp://ftp.ge.postgresql.org/pub/postgresql
	asi-HK: ftp://ftp.hk.postgresql.org/postgresql
	asi-ID: ftp://ftp8.id.postgresql.org/pub/PostgreSQL
	asi-ID: ftp://ftp9.id.postgresql.org/postgresql
	asi-JP: ftp://ftp.jp.postgresql.org
	asi-KR: ftp://ftp.kr.postgresql.org/mirror/database/postgresql
	asi-TW: ftp://ftp.tw.postgresql.org/pub/postgresql
	asi-TW: ftp://ftp3.tw.postgresql.org/pub/postgresql
	asi-TW: ftp://ftp5.tw.postgresql.org/pub/Unix/Database/PostgreSQL
	aus-AU: ftp://ftp.au.postgresql.org/pub/postgresql
	aus-AU: ftp://ftp2.au.postgresql.org/pub/postgresql
	aus-AU: ftp://ftp3.au.postgresql.org/pub/postgresql
	aus-NZ: ftp://ftp.nz.postgresql.org/postgresql
	eur-AT: ftp://ftp.at.postgresql.org/db/www.postgresql.org/pub
	eur-BE: ftp://ftp.be.postgresql.org/postgresql
	eur-BA: ftp://ftp.ba.postgresql.org/pub/postgresql
	eur-BG: ftp://ftp3.bg.postgresql.org/postgresql
	eur-CH: ftp://ftp2.ch.postgresql.org/mirror/postgresql
	eur-CZ: ftp://ftp.cz.postgresql.org/pub/ftp.postgresql.org
	eur-CZ: ftp://ftp2.cz.postgresql.org/pub/postgresql
	eur-DE: ftp://ftp.de.postgresql.org/mirror/postgresql
	eur-DE: ftp://ftp3.de.postgresql.org/pub/Mirrors/ftp.postgresql.org
	eur-DE: ftp://ftp7.de.postgresql.org/pub/ftp.postgresql.org
	eur-DE: ftp://ftp8.de.postgresql.org/pub/misc/pgsql
	eur-DE: ftp://ftp9.de.postgresql.org/unix/databases/postgresql
	eur-DK: ftp://ftp.dk.postgresql.org/mirrors/postgresql
	eur-EE: ftp://ftp.ee.postgresql.org/mirrors/postgresql
	eur-ES: ftp://ftp5.es.postgresql.org/mirror/postgresql
	eur-FR: ftp://ftp.fr.postgresql.org
	eur-FR: ftp://ftp2.fr.postgresql.org/postgresql
	eur-FR: ftp://ftp3.fr.postgresql.org/pub/postgresql
	eur-GR: ftp://ftp.gr.postgresql.org/pub/databases/postgresql
	eur-GR: ftp://ftp2.gr.postgresql.org/pub/databases/postgresql
	eur-HR: ftp://ftp.hr.postgresql.org/postgresql
	eur-HU: ftp://ftp3.hu.postgresql.org/pub/postgresql
	eur-IE: ftp://ftp.ie.postgresql.org/mirrors/ftp.postgresql.org/pub
	eur-IE: ftp://ftp2.ie.postgresql.org/mirrors/ftp.postgresql.org
	eur-IL: ftp://ftp.il.postgresql.org/ftp.postgresql.org
	eur-IS: ftp://ftp.is.postgresql.org/pub/postgresql
	eur-IT: ftp://ftp2.it.postgresql.org/mirrors/postgres
	eur-IT: ftp://ftp6.it.postgresql.org/pub/PostgreSQL
	eur-IT: ftp://ftp7.it.postgresql.org/pub/unix/postgres
	eur-LV: ftp://ftp.lv.postgresql.org/pub/software/postgresql
	eur-NL: ftp://ftp.eu.postgresql.org/pub/unix/db/postgresql
	eur-NL: ftp://ftp.nl.postgresql.org:21/pub/mirror/postgresql
	eur-NL: ftp://ftp2.nl.postgresql.org/mirror/postgresql
	eur-NL: ftp://ftp4.nl.postgresql.org/postgresql.zeelandnet.nl
	eur-NO: ftp://ftp.no.postgresql.org/pub/databases/postgresql
	eur-PL: ftp://ftp6.pl.postgresql.org/pub/postgresql
	eur-PL: ftp://ftp7.pl.postgresql.org/pub/mirror/ftp.postgresql.org
	eur-PL: ftp://ftp8.pl.postgresql.org/pub/postgresql
	eur-PT: ftp://ftp.pt.postgresql.org/postgresql
	eur-RO: ftp://ftp6.ro.postgresql.org/pub/mirrors/ftp.postgresql.org
	eur-RU: ftp://ftp.ru.postgresql.org/pub/mirrors/pgsql
	eur-RU: ftp://ftp2.ru.postgresql.org/pub/databases/postgresql
	eur-RU: ftp://ftp3.ru.postgresql.org/pub/mirror/postgresql/pub
	eur-RU: ftp://ftp6.ru.postgresql.org/pub/pgsql
	eur-SE: ftp://ftp.se.postgresql.org/pub/database/relational/postgresql
	eur-SK: ftp://ftp2.sk.postgresql.org/pub/postgresql
	eur-UK: ftp://ftp2.uk.postgresql.org/sites/ftp.postgresql.org
	eur-UK: ftp://ftp4.uk.postgresql.org/sites/ftp.postgresql.org
	eur-UK: ftp://ftp8.uk.postgresql.org/sites/ftp.postgresql.org
	nam-CA: ftp://ftp3.ca.postgresql.org/pub
	nam-CA: ftp://ftp4.ca.postgresql.org/pub/postgresql
	sam-BR: ftp://ftp.br.postgresql.org/pub/PostgreSQL
	sam-CL: ftp://ftp.cl.postgresql.org/ftp/pub/postgresql
	sam-CO: ftp://ftp.co.postgresql.org/pub/mirrors/postgresql
	nam-US: ftp://ftp.us.postgresql.org/pub/mirrors/postgresql
	nam-US: ftp://ftp3.us.postgresql.org/pub/postgresql
	nam-US: ftp://ftp4.us.postgresql.org/pub/postgresql
	nam-US: ftp://ftp5.us.postgresql.org/pub/PostgreSQL
	nam-US: ftp://ftp8.us.postgresql.org/postgresql
	nam-US: ftp://ftp9.us.postgresql.org/pub/mirrors/postgresql
	nam-US: ftp://ftp10.us.postgresql.org/pub/postgresql
	nam-US: ftp://ftp22.us.postgresql.org/mirrors/ftp.postgresql.org
<<
Source: mirror:custom:source/v%v/postgresql-%v.tar.bz2
Source2: http://www.postgis.org/download/postgis-1.1.2.tar.gz
Source-MD5: 9157234d677200bd4a28cbf4cfc261ee
Source2-MD5: 4b170cc30d9b7fec493fe779e46aa50c
PatchScript: sed 's|@INSTPREFIX@|%p|g' < %a/%n.patch | patch -p1

SetMAKEFLAGS: -j1
NoSetMAKEFLAGS: true
ConfigureParams: --prefix=%p --docdir=%p/share/doc --mandir=%p/share/man --enable-multibyte --enable-recode --with-CXX --without-perl --without-python --with-openssl --with-libraries=%p/lib --with-includes=%p/include --without-tcl --without-java --enable-odbc --with-pam --enable-syslog --with-krb5=/usr
CompileScript: <<
#!/bin/sh -e

	export lt_cv_sys_max_cmd_len=65536
	export CPPFLAGS="-I%p/lib/system-openssl/include -I%p/include/gnugetopt -I%p/include"
	export LDFLAGS="-L%p/lib/system-openssl/lib -L%p/lib"

	PG_ID=`id -u postgres 2>/dev/null || true`
	if [ -z "$PG_ID" ]; then
		echo "Whoa there!  You must have a postgres user to build this package."
		echo "Please do a 'fink reinstall passwd' and make sure you hit 'y' when it"
		echo "asks if you want to update your users."
		exit 1
	fi
	# postgresql
	autoconf && \
	perl -pi.bak -e 's,hardcode_direct=yes,hardcode_direct=no,g' configure && \
	./configure %c && \
	make includedir=%p/include/postgresql includedir_internal=%p/include/postgresql/internal includedir_server=%p/include/postgresql && \
	make -C contrib && \
	make install install-all-headers includedir=%p/include/postgresql includedir_internal=%p/include/postgresql/internal includedir_server=%p/include/postgresql DESTDIR=%d INSTALLSITEMAN3DIR=%i/share/man/man3

	pushd ../postgis-1.1.2
	./configure --prefix=%p --with-pgsql=%i/bin/pg_config && \
	perl -pi -e 's,^PROJ_DIR=%p,PROJ_DIR=%i,; s,^PGFFEINCLUDES=.*,PGFEINCLUDES=-I%i/include/postgresql -I%i/include -I%p/include,; s,^PGBEINCLUDES=.*,PGBEINCLUDES=-I%i/include/postgresql -I%i/include -I%p/include,; s,^PGFELIBS=.*,PGFELIBS=-L%i/lib -L%p/lib -lpq,; s,^PGBELIBS=.*,PGBELIBS=-L%i/lib -L%p/lib -lpostgres,; s,^libdir=.*,libdir=%p/lib/postgresql-7.3,; s,^datadir=.*,datadir=%p/share/postgresql-7.3,; s,^DLFLAGS=.*,DLFLAGS=-undefined dynamic_lookup -multiply_defined suppress,;' Makefile.config && \
	make || exit 3
	popd
<<

InstallScript: <<
#!/bin/sh -e

	# postgresql
	make install install-all-headers includedir=%p/include/postgresql includedir_internal=%p/include/postgresql/internal includedir_server=%p/include/postgresql DESTDIR=%d INSTALLSITEMAN3DIR=%i/share/man/man3 || exit 10
	make -C contrib install includedir=%p/include/postgresql includedir_internal=%p/include/postgresql/internal includedir_server=%p/include/postgresql DESTDIR=%d INSTALLSITEMAN3DIR=%i/share/man/man3
	install -m 755 contrib/adddepend/adddepend %i/bin/adddepend

	mv %i/share/doc/postgresql %i/share/doc/%N >/dev/null 2>&1

	# postgis
	pushd ../postgis-1.1.2
	make install DESTDIR=%d
	popd

	ranlib %i/lib/*.a

	install -d -m 755 %i/share/doc/%N
	find contrib -name README.* -exec cp {} %i/share/doc/%N/ \;

	install -d -m 755 %i/bin
	install -c -m 755 pgsql.sh %i/bin/

	install -d -m 755 %i/var/postgresql
	echo "be sure to back up this database before any upgrades!" >> %i/var/postgresql/README

	rm -rf %i/bin/postmaster
	ln -sf postgres-7.3 %i/bin/postmaster

	install -d -m 755 %i/var/log
	ln -sf %p/var/postgresql/pgsql.log %i/var/log/pgsql-7.3.log

	mv %i/lib/libecpg.3.4.1.dylib %i/lib/libecpg.3.4.1.dylib-7.3
	rm -rf %i/lib/libecpg.*.dylib

	mv %i/lib/libpq.3.0.dylib %i/lib/libpq.3.0.dylib-7.3
	rm -rf %i/lib/libpq.*.dylib

	for file in `ls -1 %i/bin/`; do
		mv "%i/bin/${file}" "%i/bin/${file}-7.3"
		echo "${file}" >> %i/var/postgresql/binary.list
		install_name_tool -change %p/lib/libpq.3.dylib   %p/lib/libpq.3.0.dylib   "%i/bin/${file}-7.3" >/dev/null 2>&1 || :
		install_name_tool -change %p/lib/libecpg.3.dylib %p/lib/libecpg.3.4.dylib "%i/bin/${file}-7.3" >/dev/null 2>&1 || :
	done

	for file in `find %i/lib -type f`; do
		install_name_tool -change %p/lib/libpq.3.dylib   %p/lib/libpq.3.0.dylib   "$file" >/dev/null 2>&1 || :
		install_name_tool -change %p/lib/libecpg.3.dylib %p/lib/libecpg.3.4.dylib "$file" >/dev/null 2>&1 || :
	done

	for file in `ls -1 %i/share/man/man1/`; do
		mv "%i/share/man/man1/${file}" "%i/share/man/man1/${file}-7.3"
		echo "${file}" >> %i/var/postgresql/man1.list
	done

	for file in `ls -1 %i/share/man/man7/`; do
		mv "%i/share/man/man7/${file}" "%i/share/man/man7/${file}-7.3"
		echo "${file}" >> %i/var/postgresql/man7.list
	done

	cat <<END > %i/var/postgresql/remove-alternatives.sh
#!/bin/sh

for arg in "\$@"; do
	case \$arg in
		-h|--h|--he|--hel|--help)
			echo "usage: \$0 [-h]"
			echo ""
			echo "  -h, --help          this help"
			echo ""
			exit 0;
			;;
		*)
			echo "\$0: unknown argument '\$arg'"
			exit 1;
			;;
	esac
done

update-alternatives --remove "libpq.3.0.dylib"     "%p/lib/libpq.3.0.dylib-7.3"
update-alternatives --remove "libpq.3.dylib"       "%p/lib/libpq.3.0.dylib-7.3"

update-alternatives --remove "libecpg.3.4.1.dylib" "%p/lib/libecpg.3.4.1.dylib-7.3"
update-alternatives --remove "libecpg.3.4.dylib"   "%p/lib/libecpg.3.4.1.dylib-7.3"
update-alternatives --remove "libecpg.3.dylib"     "%p/lib/libecpg.3.4.1.dylib-7.3"

for tuple in %p/bin:binary.list %p/share/man/man1:man1.list %p/share/man/man7:man7.list; do
	TUPLE_PATH=\`echo \$tuple | cut -d: -f1\`
	TUPLE_FILE=\`echo \$tuple | cut -d: -f2\`

	for file in \`cat %p/var/postgresql/\${TUPLE_FILE}\`; do
#		echo update-alternatives --remove "\${file}" "\${TUPLE_PATH}/\${file}-7.3"
		     update-alternatives --remove "\${file}" "\${TUPLE_PATH}/\${file}-7.3"
	done
done

END

	cat <<END > %i/var/postgresql/update-alternatives.sh
#!/bin/sh

FORCE=0

for arg in "\$@"; do
	case \$arg in
		-h|--h|--he|--hel|--help)
			echo "usage: \$0 [-h] [-f]"
			echo ""
			echo "  -h, --help          this help"
#			echo "  -f, --force         force this version of PostgreSQL, even if there is a newer one"
			echo ""
			exit 0;
			;;
#		-f|--f|--fo|--for|--forc|--force)
#			FORCE=1
#			;;
		*)
			echo "\$0: unknown argument '\$arg'"
			exit 1;
			;;
	esac
done

if [ -e "%p/lib/libpq.3.0.dylib-7.3" ]; then
	update-alternatives --install "%p/lib/libpq.3.0.dylib"     "libpq.3.0.dylib"     "%p/lib/libpq.3.0.dylib-7.3" 0300000703
	update-alternatives --install "%p/lib/libpq.3.dylib"       "libpq.3.dylib"       "%p/lib/libpq.3.0.dylib-7.3" 0300000703
else
	echo "WARNING: %p/lib/libpq.3.0.dylib-7.3 does not exist"
fi

if [ -e "%p/lib/libecpg.3.4.1.dylib-7.3" ]; then
	update-alternatives --install "%p/lib/libecpg.3.4.1.dylib" "libecpg.3.4.1.dylib" "%p/lib/libecpg.3.4.1.dylib-7.3" 0304010703
	update-alternatives --install "%p/lib/libecpg.3.4.dylib"   "libecpg.3.4.dylib"   "%p/lib/libecpg.3.4.1.dylib-7.3" 0304010703
	update-alternatives --install "%p/lib/libecpg.3.dylib"     "libecpg.3.dylib"     "%p/lib/libecpg.3.4.1.dylib-7.3" 0304010703
else
	echo "WARNING: %p/lib/libecpg.3.4.1.dylib-7.3 does not exist"
fi

for tuple in %p/bin:binary.list %p/share/man/man1:man1.list %p/share/man/man7:man7.list; do
	TUPLE_PATH=\`echo \$tuple | cut -d: -f1\`
	TUPLE_FILE=\`echo \$tuple | cut -d: -f2\`

	for file in \`cat %p/var/postgresql/\${TUPLE_FILE}\`; do
		if [ -e "\${TUPLE_PATH}/\${file}-7.3" ]; then
			update-alternatives --install "\${TUPLE_PATH}/\${file}" "\${file}" "\${TUPLE_PATH}/\${file}-7.3" 73
		fi
	done
done

END

	chmod 755 %i/var/postgresql/*.sh
	perl -pi -e 's,^%d,,' %i/bin/pg_config*
<<
DocFiles: COPYRIGHT HISTORY INSTALL README
SplitOff: <<
	Package: %N-dev
	Description: PostgreSQL development headers and libraries
	Depends: %N (>= %v-%r)
	Conflicts: postgresql74-dev, postgresql74-ssl-dev, postgresql74-unified-dev, postgresql80-dev, postgresql80-ssl-dev, postgresql80-unified-dev, postgresql81-dev
	Replaces: postgresql (<< %v-%r), postgresql73-dev (<< %v-%r), postgresql73-ssl-dev (<< %v-%r), postgresql74-dev, postgresql74-ssl-dev, postgresql74-unified-dev, postgresql80-dev, postgresql80-ssl-dev, postgresql80-unified-dev, postgresql81-dev
	BuildDependsOnly: true
	Files: <<
		bin/pg_config*
		include
		lib/*.a
		lib/libecpg.dylib
		lib/libpq.dylib
		share/man/man1/pg_config*
	<<
	PostInstScript: [ -x %p/var/postgresql/update-alternatives.sh ] && %p/var/postgresql/update-alternatives.sh
	PreRmScript: [ -x %p/var/postgresql/remove-alternatives.sh ] && %p/var/postgresql/remove-alternatives.sh
	PostRmScript: [ -x %p/var/postgresql/update-alternatives.sh ] && %p/var/postgresql/update-alternatives.sh
<<
SplitOff2: <<
	Package: %N-shlibs
	Description: PostgreSQL shared libraries
	Replaces: %N, postgresql (<< %v-%r), postgresql-shlibs, postgresql-ssl-shlibs, postgresql73-shlibs (<< %v-%r), postgresql73-ssl-shlibs (<< %v-%r)
	Files: lib/*.dylib* var/postgresql/*.sh var/postgresql/*.list
	Shlibs: <<
		%p/lib/libecpg.3.dylib 3.0.0 postgresql73-unified-shlibs (>= 7.3.9-1)
		%p/lib/libpq.3.dylib   3.0.0 postgresql73-unified-shlibs (>= 7.3.9-1) | postgresql74-unified-shlibs (>= 7.4-1)
	<<
	PostInstScript: [ -x %p/var/postgresql/update-alternatives.sh ] && %p/var/postgresql/update-alternatives.sh
	PreRmScript: [ -x %p/var/postgresql/remove-alternatives.sh ] && %p/var/postgresql/remove-alternatives.sh
<<
SplitOff3: <<
	Package: postgresql73
	Description: upgrade package for postgresql73
	Depends: %N (>= %v-%r)
	DocFiles: COPYRIGHT HISTORY INSTALL README
<<
SplitOff4: <<
	Package: postgresql73-shlibs
	Description: upgrade package for postgresql73-shlibs
	Depends: %N-shlibs (>= %v-%r)
	DocFiles: COPYRIGHT HISTORY INSTALL README
<<
SplitOff5: <<
	Package: postgresql73-dev
	Description: upgrade package for postgresql73-dev
	Depends: %N-dev (>= %v-%r)
	DocFiles: COPYRIGHT HISTORY INSTALL README
<<
SplitOff6: <<
	Package: postgresql73-ssl
	Description: upgrade package for postgresql73-ssl
	Depends: %N (>= %v-%r)
	DocFiles: COPYRIGHT HISTORY INSTALL README
<<
SplitOff7: <<
	Package: postgresql73-ssl-shlibs
	Description: upgrade package for postgresql73-ssl-shlibs
	Depends: %N-shlibs (>= %v-%r)
	DocFiles: COPYRIGHT HISTORY INSTALL README
<<
SplitOff8: <<
	Package: postgresql73-ssl-dev
	Description: upgrade package for postgresql73-ssl-dev
	Depends: %N-dev (>= %v-%r)
	DocFiles: COPYRIGHT HISTORY INSTALL README
<<

PostInstScript: <<
INSTALL_PHASE="$1"

[ -x %p/var/postgresql/update-alternatives.sh ] && %p/var/postgresql/update-alternatives.sh

# remove the old "pgsql" entries from netinfo; the username was switched to
# "postgres" but the old ones hang around because of the way niload works
niutil -destroy . /users/pgsql  >/dev/null 2>&1 || true
niutil -destroy . /groups/pgsql >/dev/null 2>&1 || true

die () {
	echo "failed"
	echo ""
	echo "*** bailing because an error ocurred:"
	echo ""
	echo "$*"
	exit 1
}

# update daemonic init script if necessary
daemonic install %N
<<
PreRmScript: <<
[ -x %p/var/postgresql/remove-alternatives.sh ] && %p/var/postgresql/remove-alternatives.sh

# clean up
daemonic remove postgresql       >/dev/null 2>&1 || true
daemonic remove postgresql73     >/dev/null 2>&1 || true
daemonic remove postgresql73-ssl >/dev/null 2>&1 || true
if [ $1 != "upgrade" ]; then
	daemonic remove %N
fi
<<
PostRmScript: [ -x %p/var/postgresql/update-alternatives.sh ] && %p/var/postgresql/update-alternatives.sh
DaemonicFile: <<
	<service>
	<description>PostgreSQL database server</description>
	<message> PostgreSQL database server</message>
	
	<daemon name="%N">
		<executable background="no">%p/bin/pgsql.sh-7.3</executable>
		<parameters>start</parameters>
	</daemon>
	
	</service>
<<

Homepage: http://www.postgresql.org/
DescUsage: <<
The package runs initdb on installation as the user 'postgres'.

The best way to run it is using the supplied pgsql.sh script, i.e.
'sudo pgsql.sh start'.  Or, you can run
'sudo daemonic enable %N' as root to create a
StartupItem for it.

Unless you set up admin users in the database, the easiest way to
run psql commands with administrator access is to prefix them with
the command "sudo -u postgres".  This will ask you your administrator
password, and then run the command as the postgres user.

For example, to create a new database, you would run:

  sudo -u postgres createdb mydb
<<
DescPackaging: <<
IMPORTANT: The location of the data files has changed from early
revisions of this package. If you're upgrading from an earlier
revision, note that this one expects the data files to be installed
at <prefix>/var/postgresql/data.

When run from the startup script, logs output to 
<prefix>/var/postgresql/pgsql.log
<<
DescPort: <<
Rearranged a lot of the PostgreSQL build to be more "correct" on
Darwin, including making proper dylibs (instead of bundles, which
ended up creating static binaries).
<<

