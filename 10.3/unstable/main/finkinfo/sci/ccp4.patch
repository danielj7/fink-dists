diff -ruN ccp4-5.0.1-orig/ccp4i/scripts/dhm_tool.script ccp4-5.0.1/ccp4i/scripts/dhm_tool.script
--- ccp4-5.0.1-orig/ccp4i/scripts/dhm_tool.script	2004-07-02 08:56:14.000000000 -0700
+++ ccp4-5.0.1/ccp4i/scripts/dhm_tool.script	2004-07-12 16:12:40.000000000 -0700
@@ -10,7 +10,8 @@
 
 if { $PDB_EXTRACT == 1 && $XML != 1 } {
 
-        if { $EXTRACT_STEP == "scaling" && $SCALING != "" } {
+        if { $EXTRACT_STEP == "scaling" && $SCALING != "" && 
+             ($SCALING_LOGIN != "" || $SCALING1_LOGIN != "" || $SCALING_CIFIN != "") } {
                append cmd " -s " $SCALING
 	       if { $SCALING_LOGIN != "" } {
 		        append cmd " -iLOG " $SCALING_LOGIN
@@ -25,7 +26,9 @@
         }
 
 
-	if { $EXTRACT_STEP == "phasing" && $EXP_MENU != "" && $PHASING != ""} {
+	if { $EXTRACT_STEP == "phasing" && $EXP_MENU != "" && $PHASING != ""
+		&& ($PHASING_LOGIN != "" || $PHASING1_LOGIN != "" ||
+                   $PHASING_PDBIN != "" || $PHASING_CIFIN != "") } {
 		append cmd " -e " $EXP_MENU
 		append cmd " -p " $PHASING
 		if { $PHASING_LOGIN != "" } {
@@ -44,7 +47,9 @@
 	}
 
 
-	if { $EXTRACT_STEP == "replacement" &&  $REPLACEMENT != "" } {
+	if { $EXTRACT_STEP == "replacement" &&  $REPLACEMENT != "" &&
+           ( $REPLACEMENT_LOGIN != "" || $REPLACEMENT1_LOGIN != "" || 
+             $REPLACEMENT_CIFIN != "") } {
 		append cmd " -m " $REPLACEMENT
 		if { $REPLACEMENT_LOGIN != "" } {
 			append cmd " -iLOG " $REPLACEMENT_LOGIN
@@ -59,7 +64,8 @@
 	}
 
 
-	if { $EXTRACT_STEP == "den_mod" && $DEN_MOD != "" } {
+	if { $EXTRACT_STEP == "den_mod" && $DEN_MOD != "" &&
+             ( $DM_LOGIN != "" || $DM_CIFIN != "") } {
 		append cmd " -d " $DEN_MOD  
 		if { $DM_LOGIN != "" } {
 			append cmd " -iLOG " $DM_LOGIN
@@ -71,7 +77,8 @@
 	}
 
 
-	if { $EXTRACT_STEP == "refinement" && $REFINEMENT != "" } {
+	if { $EXTRACT_STEP == "refinement" && $REFINEMENT != "" &&
+             ($REFINE_CIFIN != "" || $REFINE_PDBIN != "" ||  $REFINE_LOGIN != "")} {
 		append cmd " -r " $REFINEMENT
 		if { $REFINE_CIFIN != "" } {
 			append cmd " -iCIF " $REFINE_CIFIN
@@ -97,7 +104,8 @@
 
 	if { $EXTRACT_STEP == "merge" } {
 
-            if { $SCALING != "" } {
+            if { $SCALING != "" && 
+             ($SCALING_LOGIN != "" || $SCALING1_LOGIN != "" || $SCALING_CIFIN != "")} {
                append cmd " -s " $SCALING
 	       if { $SCALING_LOGIN != "" } {
 		        append cmd " -iLOG " $SCALING_LOGIN
@@ -111,7 +119,9 @@
             }
 
 
-	    if { $EXP_MENU != "" && $PHASING != ""} {
+	    if { $EXP_MENU != "" && $PHASING != "" &&
+            ($PHASING_LOGIN != "" || $PHASING1_LOGIN != "" || 
+             $PHASING_PDBIN != "" || $PHASING_CIFIN != "" )} {
 		append cmd " -e " $EXP_MENU
 		append cmd " -p " $PHASING
 		if { $PHASING_LOGIN != "" } {
@@ -129,7 +139,9 @@
 	    }
 
 
-	    if { $REPLACEMENT != "" } {
+	    if { $REPLACEMENT != "" && 
+            ($REPLACEMENT_LOGIN != "" || $REPLACEMENT1_LOGIN != ""||
+             $REPLACEMENT_CIFIN != "") } {
 		append cmd " -m " $REPLACEMENT
 		if { $REPLACEMENT_LOGIN != "" } {
 			append cmd " -iLOG " $REPLACEMENT_LOGIN
@@ -143,7 +155,8 @@
 	    }
 
 
-	    if { $DEN_MOD != "" } {
+	    if { $DEN_MOD != "" &&
+            ($DM_LOGIN != "" || $DM_CIFIN != "")} {
 		append cmd " -d " $DEN_MOD  
 		if { $DM_LOGIN != "" } {
 			append cmd " -iLOG " $DM_LOGIN
@@ -154,7 +167,8 @@
 	    }
 
 
-	    if {  $REFINEMENT != "" } {
+	    if {  $REFINEMENT != "" && 
+            ($REFINE_CIFIN != "" ||  $REFINE_PDBIN != "" || $REFINE_LOGIN != "")} {
 		append cmd " -r " $REFINEMENT
 		if { $REFINE_CIFIN != "" } {
 			append cmd " -iCIF " $REFINE_CIFIN
diff -ruN ccp4-5.0.1-orig/ccp4i/tasks/fffear.tcl ccp4-5.0.1/ccp4i/tasks/fffear.tcl
--- ccp4-5.0.1-orig/ccp4i/tasks/fffear.tcl	2004-01-26 03:24:01.000000000 -0800
+++ ccp4-5.0.1/ccp4i/tasks/fffear.tcl	2004-07-12 16:13:14.000000000 -0700
@@ -140,8 +140,8 @@
 					emp-turn_b-9 \
 					emp-helixend-9 \
 					theor-helix-10 \
-					theor-strand-5 \
-					theor-helix-10 \
+					theor-helix-5 \
+					theor-strand-10 \
 					theor-strand-5 ]
 	
 
diff -ruN ccp4-5.0.1-orig/etc/xloggraph ccp4-5.0.1/etc/xloggraph
--- ccp4-5.0.1-orig/etc/xloggraph	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.1/etc/xloggraph	2004-07-12 16:13:49.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=/sw/lib/app-defaults/XCCPJiffy
+xloggraph.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.1-orig/etc/xplot84 ccp4-5.0.1/etc/xplot84
--- ccp4-5.0.1-orig/etc/xplot84	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.1/etc/xplot84	2004-07-12 16:13:44.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=/sw/lib/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.1-orig/etc/xplot84driver ccp4-5.0.1/etc/xplot84driver
--- ccp4-5.0.1-orig/etc/xplot84driver	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.1/etc/xplot84driver	2004-07-12 16:13:44.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=/sw/lib/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.1-orig/include/ccp4.setup-bash ccp4-5.0.1/include/ccp4.setup-bash
--- ccp4-5.0.1-orig/include/ccp4.setup-bash	2004-07-05 07:53:54.000000000 -0700
+++ ccp4-5.0.1/include/ccp4.setup-bash	1969-12-31 16:00:00.000000000 -0800
@@ -1,355 +0,0 @@
-#!/bin/bash
-# CCP4 setup file for bash or ksh (untested) users.  -*- shell-script -*-
-# Actually, the aliases can't work asis in ksh.  Should use builtins instead
-# and not worry about ease of keeping in step with the csh one.
-
-# $Id: ccp4.setup-bash,v 1.61 2004/07/05 14:53:54 pjx Exp $
-
-# This file is site specific and may also contain machine-specifics.  The CCP4
-# administrator will have to edit this file and then have anyone who wants to
-# use CCP4 source it from their .login file.  They will require the full path
-# name since no environment variables relevant to CCP4 are known until this is
-# executed.
-
-# For sites with more than one machine, it is recommended that the suite is
-# installed on a single machine and other machines access the source code, and
-# shareable files (such as this one) via shared file systems with NFS, RFS
-# etc.  Non-shareable files reside in $CBIN and $CLIB (see below).
-
-# Copy this file to ccp4.setup and customise it for your needs. There are
-# three sections. You MUST check the first section. You may want to check
-# the second. You don't need to look at the third.
-
-################### THIS SECTION SHOULDN'T NEED EDITING #####################
-
-# first emulate csh setenv and alias so we can keep the bash and csh
-# versions as similar as possible
-setenv  () { export $1="$2" ; }
-# Note that bash has a (different) alias command so we need to undo this
-# later.  I wonder if it is robust :-)
-if [ "`basename $SHELL`" != "ksh" ]; then # can't redefine alias in ksh
-alias () { eval `echo $1; shift; echo '() { ' $*; echo '; }'` ; }
-fi
-
-################### THIS SECTION MUST BE EDITED #####################
-
-# CCP4_MASTER is the location of the top-level directory containing `ccp4-<version>'
-# This is usually the directory in which you ran the tar command to unpack the
-# code, and is assumed to be shared between machines at a multi-machine site.
-
-setenv CCP4_MASTER	/xtal                    
-setenv CCP4		$CCP4_MASTER/ccp4-5.0.1
-
-# Check for existence of CCP4_MASTER
-if (! test -d $CCP4_MASTER) ; then
-    echo "********************* WARNING **********************"
-    echo "The directory $CCP4_MASTER"
-    echo "(assigned to CCP4_MASTER) does not exist."
-    echo "The CCP4 programs will not run correctly, and any"
-    echo "installation attempt will have errors or will fail."
-    echo "********************* WARNING **********************"
-fi
-
-# CCP4_SCR: a per-user directory for run-time-generated scratch
-# files. A dedicated scratch filesystem is probably better than (/usr)/tmp
-# BINSORT_SCR: a scratch directory for binsort's use; normally same as CCP4_SCR
-
-setenv CCP4_SCR      /tmp/$USER	
-# check to see if this exists and if not try to make it
-test -d $CCP4_SCR || mkdir $CCP4_SCR
-test -d $CCP4_SCR || \
-    echo "Unable to make CCP4_SCR. CCP4 progs will not run correctly."
-
-setenv BINSORT_SCR   $CCP4_SCR
-
-### CCP4i setup - you may need to edit CCP4I_TCLTK ###
-# CCP4I_TOP - the top directory of the interface
-setenv CCP4I_TOP ${CCP4}/ccp4i
-# CCP4I_TCLTK - directory containing tclsh,wish and bltwish executables
-#               as used in $CCP4I_TOP/bin/ccp4i,ccp4ish,loggraph
-#               For 'standard' installations this is /usr/local/bin
-#               but note the SGI distributed version of Tcl/Tk is not 
-#               appropriate version
-setenv CCP4I_TCLTK /usr/local/bin        
-# CCP4I_HELP - directory contain ccp4i help - default is $CCP4I_TOP/help
-setenv CCP4I_HELP ${CCP4I_TOP}/help
-
-### Optional - setting http_proxy environment
-# The commented out 'setenv' line below may have to be declared to download
-# and edit protein sequences using the new "Import/Edit Protein Sequences"
-# (This may also be required for remote job submission in arp/warp.)
-# task. If so, uncomment this line and replace the example proxy URL with your
-# relevant URL
-
-#setenv HTTP_PROXY wwwblah.blah.ac.uk:xxxx/blah.blah
-
-################### NOVICE USERS STOP HERE #####################
-
-################### OPTIONS TO CUSTOMISE CCP4 #####################
-
-# By default, CCP4 directories are appended to the end of paths (PATH,
-# LD_LIBRARY_PATH, and DYLD_LIBRARY_PATH). If ccp4_first_in_path is set
-# to 1, then they will be prepended to the beginning of paths.
-ccp4_first_in_path=0
-
-# The commented-out switch statement below provides an example of how
-# to use this file for several machines/architectures sharing $CCP4_MASTER.
-# If necessary, uncomment and edit this.  Otherwise, if you're only supporting
-# a single system alter the uncommented part as necessary.
-#
-# The significance of the environment variables is as follows:
-#   CBIN: location of the executables -- must be on your path (see below);
-#   CLIB: location of (binary) library files such as libccp4.a and libccp4.so;
-#   MANPATH: set this if your system's `man' looks at such an environment
-#      variable to determine where to look for man pages.  By adding 
-#      $CCP4/man to the normal path you get the CCP4 man pages 
-#      with keyword searching as system ones.  
-#   MCTYPE: used for LAUE make -- see LAUE documentation
-#   CCP4_BROWSER: set this if you intend to use the html documentation
-#      (recommended).  It should have the path and name of a html browser eg
-#      /usr/bin/X11/netscape or /usr/local/bin/lynx. The browser will be
-#      started with the alias ccp4help and will open the file
-#      $CHTML/INDEX.html.
-
-#   case `hostname` in			# edit this case statement if used
-#                                       # for multiple systems
-#   foo)
-    setenv CBIN      $CCP4/bin		
-    setenv CLIB      $CCP4/lib	
-
-    setenv CCP4_BROWSER  netscape             
-
-    if test "$MANPATH"; then
-      if [ $ccp4_first_in_path -eq 1 ]; then
-        setenv MANPATH ${CCP4}/man:${MANPATH}
-      else
-        setenv MANPATH ${MANPATH}:${CCP4}/man
-      fi
-    else
-      if [ $ccp4_first_in_path -eq 1 ]; then
-        setenv MANPATH ${CCP4}/man:/usr/share/man
-      else
-        setenv MANPATH /usr/share/man:${CCP4}/man
-      fi
-    fi
-    setenv MCTYPE        unix 			# (only for Laue)
-#     ;;
-#   *)
-#     echo "CCP4 not implemented on this system"
-#     exit 1
-#     ;;
-# esac
-
-case `uname` in
-*Darwin* )
-  ulimit -s 65536
-  ;;
-* )
-  ;;
-esac
-
-# The following are for all systems
-setenv CCP4_LIB $CLIB
-setenv CCP4_BIN $CBIN
-
-# CLASSPATH for Java
-if test "$CLASSPATH"; then
-  if [ $ccp4_first_in_path -eq 1 ]; then
-    setenv CLASSPATH ${CBIN}:${CLASSPATH}
-  else
-    setenv CLASSPATH ${CLASSPATH}:${CBIN}
-  fi
-else
-  if [ $ccp4_first_in_path -eq 1 ]; then
-    setenv CLASSPATH ${CBIN}:.
-  else
-    setenv CLASSPATH .:${CBIN}
-  fi
-fi
-
-### PLOT_COMMAND PRINT_COMMAND for the XCCPJIFFY programs to compile ###
-setenv PLOT_COMMAND   'lp -s -dmicrolaser'  
-setenv PRINT_COMMAND  'lp -s -denscript'    
-
-# HARVESTHOME specifies location of harvesting files (defaults to $HOME)
-#setenv HARVESTHOME     
-
-### CCP4_OPEN ###
-# CCP4_OPEN may be set to 'UNKNOWN' to stop open failures for files opened 
-# as NEW that already exist.  Novices should use 'NEW' to avoid inadvertant 
-# over-writing of existing files, which is then treated as a fatal error.
-
-setenv CCP4_OPEN        UNKNOWN	
-
-### BINSORT_MEM ###
-# BINSORT_MEM is workspace used by the binsort program.  In principle this
-# value is machine-dependent.  It may benefit from being enlarged, but values
-# higher than 2M have been reported to cause excessive paging on some systems.
-# You might like to experiment with a program such as fft with different
-# values -- 102400 (bytes) is the default.  csh's `time' command can tell you
-# about paging.
-#
-#  setenv BINSORT_MEM     8388608
-
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-# at runtime
-if test "$LD_LIBRARY_PATH"; then
-  if [ $ccp4_first_in_path -eq 1 ]; then
-    setenv LD_LIBRARY_PATH ${CLIB}:${LD_LIBRARY_PATH}
-  else
-    setenv LD_LIBRARY_PATH ${LD_LIBRARY_PATH}:${CLIB}
-  fi
-else
-  setenv LD_LIBRARY_PATH ${CLIB}
-fi
-
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.dylib)
-# at runtime (used on Mac OS X)
-if test "$DYLD_LIBRARY_PATH"; then
-  if [ $ccp4_first_in_path -eq 1 ]; then
-    setenv DYLD_LIBRARY_PATH ${CLIB}:${DYLD_LIBRARY_PATH}
-  else
-    setenv DYLD_LIBRARY_PATH ${DYLD_LIBRARY_PATH}:${CLIB}
-  fi
-else
-  setenv DYLD_LIBRARY_PATH ${CLIB}
-fi
-
-### XAPPLRESDIR ###
-
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
-# application defaults directory since it requires reading by xrdb to sort out
-# the differences for monochrome displays.  At Daresbury a version of the file
-# assuming a monochrome display is kept in the directory
-# $CCP4_LIB/X11/app-defaults and this is picked up through the
-# XUSERFILESEARCHPATH environment variable.  That means you only see black and
-# white on a colour display.  Alternatively you might make sure that it is
-# read by xrdb on startup of the X Windows system or delegate the
-# responsibility to users to run it.  There are disadvantages to putting an
-# invocation of xrdb in here, one being that the correct value of DISPLAY may
-# not be set at the time this file is read.  Thus edit this part as
-# appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-# instead of /usr; others may want /usr/local/lib or somw such):
-if test "$XUSERFILESEARCHPATH"; then
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:$XUSERFILESEARCHPATH
-else
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:/usr/lib/X11/app-defaults
-fi
-
-### TRAPPFE ###
-# TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
-# point exceptions under IRIX.  It shouldn't cause harm on other systems, but
-# edit this to comment it out if necessary. 
-setenv TRAP_FPE "OVERFL=ABORT; DIVZERO=ABORT; INVALID=ABORT"
-
-# The following can be used to put a message of the day to announce news about
-# CCP4 or whatever to CCP4 users.  You might also want to edit this part to
-# have machine-specific messages dependent on `hostname`.
-test -r $CCP4/include/ccp4.msg && cat $CCP4/include/ccp4.msg
-
-################### EXPERIENCED USERS STOP HERE #####################
-
-################### THE REST SHOULDN'T NEED EDITING #####################
-
-### MMCIFDIC is now defined here. cif_mmdic.lib is a binary file ===
-# so on multiple installs it need to be unique and not in $CLIBD
-
-setenv MMCIFDIC $CLIB/cif_mmdic.lib
-
-### MOLREPLIB Point to the location of the files bs-zeros.dat  ps.resource  symlib.blc
-# They are distributed with CCP4 in $CLIBD. This env must have the trailing \ or /
-
-setenv MOLREPLIB $CCP4/lib/data/monomers/
-
-### CLIBD_MON Point to the location of the dictionary files for REFMAC5
-# They are distributed with CCP4 in $CLIBD/monomers. This env must have 
-# the trailing \ or /
-
-setenv CLIBD_MON $CCP4/lib/data/monomers/
-
-### PUBLIC_FONT84, CCP4_HELPDIR, HELPDIR, MOSHELPFILE ###
-# (essential for the relevant programs)
-setenv PUBLIC_FONT84   $CLIB/font84.dat  # plot84 fonts [used by plot84lib]
-
-# location of VMS-style help files required for mosflm [used by hlplib, chelp,
-#   chlp, (ip)mosflm]:
-setenv CCP4_HELPDIR    $CCP4/help/            # NB trailing /
-setenv HELPDIR $CCP4_HELPDIR			# for chelp
-setenv MOSHELPFILE     mosflm			# required by (ip)mosflm
-
-# Rasmol path. Needed for prog. to find rasmol.hlp
-setenv RASMOLPATH $CCP4/x-windows/RasMol/src
-
-# CCP4 executables and scripts live in $CBIN and $CETC respectively; put them
-# on the path in an appropriate order for scripts to be used as wrappers for
-# binaries of the same name.  Put ccp4 stuff after the current path to avoid
-# confusion with `.' or whatever in the path:
-#
-# This construct prevents the path getting longer each time ccp4.setup is
-# executed (A. Perrakis)
-ccp4pathlist="${CCP4}/etc ${CBIN} ${CCP4I_TOP}/bin "
-#
-for dir in ${ccp4pathlist}; do
-  if [ `expr ":${PATH}:" : ".*:${dir}:"` -eq 0 ]; then
-    if [ $ccp4_first_in_path -eq 1 ]; then
-      setenv PATH ${dir}:${PATH}
-    else
-      setenv PATH ${PATH}:${dir}
-    fi
-  fi
-done
-
-# Optional (useful) additional environment variables
-  setenv CCP4             $CCP4
-  setenv CDOC             $CCP4/doc
-  setenv CHTML            $CCP4/html
-  setenv CETC             $CCP4/etc
-  setenv CEXAM            $CCP4/examples
-  setenv CINCL            $CCP4/include
-  setenv CLIBD            $CCP4/lib/data
-  setenv CLIBS            $CCP4/lib/src
-  setenv CPROG            $CCP4/src
-
-if [ "`basename $SHELL`" != "ksh" ]; then
-# useful aliases, at least for developers
-  alias ccp4   'pushd $CCP4>/dev/null'
-  alias xtal   'pushd $CCP4_MASTER>/dev/null'
-  alias cbin   'pushd $CBIN>/dev/null'
-  alias cetc   'pushd $CETC>/dev/null'
-  alias cprog  'pushd $CPROG>/dev/null'
-  alias cincl  'pushd $CINCL>/dev/null'
-  alias clib   'pushd $CLIB>/dev/null'
-  alias clibd  'pushd $CLIBD>/dev/null'
-  alias clibs  'pushd $CLIBS>/dev/null'
-  alias cbin   'pushd $CBIN>/dev/null'
-  alias cexam  'pushd $CEXAM>/dev/null'
-  alias cdoc   'pushd $CDOC>/dev/null'
-  alias chtml  'pushd $CHTML>/dev/null'
-  alias ccp4help '$CCP4_BROWSER $CHTML/INDEX.html \&'
-
-### laue, lget, linkimages ###
-# Essential aliases for the Laue software suite
-  alias laue '$CCP4_MASTER/laue/cmd/laue.cmd'
-  alias lget '$CCP4_MASTER/laue/cmd/lget.cmd'
-  alias linkimages '$CCP4_MASTER/laue/cmd/linkimages.cmd'
-
-# additional useful aliases for Laue directories
-  alias llaue  'pushd $CCP4_MASTER/laue'
-  alias lsrc   'pushd $CCP4_MASTER/laue/src>/dev/null'
-  alias llib   'pushd $CCP4_MASTER/laue/lib>/dev/null'
-  alias llibs  'pushd $CCP4_MASTER/laue/lib/src>/dev/null'
-  alias ldoc   'pushd $CCP4_MASTER/laue/doc>/dev/null'
-  alias lmak   'pushd $CCP4_MASTER/laue/make>/dev/null'
-  alias lutils 'pushd $CCP4_MASTER/laue/utils>/dev/null'
-  alias lcmd   'pushd $CCP4_MASTER/laue/cmd>/dev/null'
-  alias ldl    'pushd $CCP4_MASTER/laue/dl>/dev/null'
-  alias ltestd 'pushd $CCP4_MASTER/laue/testdata>/dev/null'
-  alias lxdl   'pushd $CCP4_MASTER/laue/xdl_view>/dev/null'
-  alias lxdls  'pushd $CCP4_MASTER/laue/xdl_view/src>/dev/null'
-  alias lgnom  'pushd $CCP4_MASTER/laue/gnom>/dev/null'
-  alias lgnoms 'pushd $CCP4_MASTER/laue/gnom/src>/dev/null'
-  alias lbin   'pushd $CBIN>/dev/null'
-
-  unset alias  # clean up
-fi             # ksh test
diff -ruN ccp4-5.0.1-orig/include/ccp4.setup-dist ccp4-5.0.1/include/ccp4.setup-dist
--- ccp4-5.0.1-orig/include/ccp4.setup-dist	2004-07-05 07:53:55.000000000 -0700
+++ ccp4-5.0.1/include/ccp4.setup-dist	2004-07-12 16:09:21.000000000 -0700
@@ -54,10 +54,10 @@
 setenv CCP4I_TOP ${CCP4}/ccp4i
 # CCP4I_TCLTK - directory containing tclsh,wish and bltwish executables
 #               as used in $CCP4I_TOP/bin/ccp4i,ccp4ish,loggraph
-#               For 'standard' installations this is /usr/local/bin
+#               For 'standard' installations this is /sw/bin
 #               but note the SGI distributed version of Tcl/Tk is not 
 #               appropriate version
-setenv CCP4I_TCLTK /usr/local/bin        
+setenv CCP4I_TCLTK /sw/bin        
 # CCP4I_HELP - directory contain ccp4i help - default is $CCP4I_TOP/help
 setenv CCP4I_HELP ${CCP4I_TOP}/help
 
@@ -94,7 +94,7 @@
 #   MCTYPE: used for LAUE make -- see LAUE documentation
 #   CCP4_BROWSER: set this if you intend to use the html documentation
 #      (recommended).  It should have the path and name of a html browser eg
-#      /usr/bin/X11/netscape or /usr/local/bin/lynx. The browser will be
+#      /usr/bin/X11/open or /sw/bin/lynx. The browser will be
 #      started with the alias ccp4help and will open the file
 #      $CHTML/INDEX.html.
 
@@ -104,7 +104,7 @@
     setenv CBIN      $CCP4/bin		
     setenv CLIB      $CCP4/lib	
 
-    setenv CCP4_BROWSER  netscape             
+    setenv CCP4_BROWSER  open             
 
     if (${?MANPATH}) then
       if ($ccp4_first_in_path) then
@@ -155,8 +155,8 @@
 endif
 
 ### PLOT_COMMAND PRINT_COMMAND for the XCCPJIFFY programs to compile ###
-setenv PLOT_COMMAND   'lp -s -dmicrolaser'  
-setenv PRINT_COMMAND  'lp -s -denscript'    
+setenv PLOT_COMMAND   'lpr'  
+setenv PRINT_COMMAND  'lpr'    
 
 # HARVESTHOME specifies location of harvesting files (defaults to $HOME)
 #setenv HARVESTHOME     
@@ -178,51 +178,10 @@
 #
 #  setenv BINSORT_MEM     8388608
 
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-# at runtime
-if (${?LD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv LD_LIBRARY_PATH ${CLIB}:${LD_LIBRARY_PATH}
-  else
-    setenv LD_LIBRARY_PATH ${LD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv LD_LIBRARY_PATH ${CLIB}
-endif
-
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.dylib)
-# at runtime (used on Mac OS X)
-if (${?DYLD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv DYLD_LIBRARY_PATH ${CLIB}:${DYLD_LIBRARY_PATH}
-  else
-    setenv DYLD_LIBRARY_PATH ${DYLD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv DYLD_LIBRARY_PATH ${CLIB}
-endif
+# LD_LIBRARY_PATH and DYLD_LIBRARY_PATH unset per fink policy
 
-### XAPPLRESDIR ###
 
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
-# application defaults directory since it requires reading by xrdb to sort out
-# the differences for monochrome displays.  At Daresbury a version of the file
-# assuming a monochrome display is kept in the directory
-# $CCP4_LIB/X11/app-defaults and this is picked up through the
-# XUSERFILESEARCHPATH environment variable.  That means you only see black and
-# white on a colour display.  Alternatively you might make sure that it is
-# read by xrdb on startup of the X Windows system or delegate the
-# responsibility to users to run it.  There are disadvantages to putting an
-# invocation of xrdb in here, one being that the correct value of DISPLAY may
-# not be set at the time this file is read.  Thus edit this part as
-# appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-# instead of /usr; others may want /usr/local/lib or somw such):
-if ($?XUSERFILESEARCHPATH) then
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:$XUSERFILESEARCHPATH
-else
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:/usr/lib/X11/app-defaults
-endif
+# XUSERFILESEARCHPATH environment variable set in wrapper shell scripts.  
 
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
@@ -274,8 +233,9 @@
 # confusion with `.' or whatever in the path:
 #
 # This construct prevents the path getting longer each time ccp4.setup is
-# executed (A. Perrakis)
-set ccp4pathlist = "${CCP4}/etc ${CBIN} ${CCP4I_TOP}/bin "
+# executed (A. Perrakis).  This was done wrong in the original file.
+#
+set ccp4pathlist = "${CCP4}/etc:${CBIN}:${CCP4I_TOP}/bin"
 #
 foreach dir ( ${ccp4pathlist} )
   if ( ${?PATH} ) then
diff -ruN ccp4-5.0.1-orig/include/ccp4.setup-sh ccp4-5.0.1/include/ccp4.setup-sh
--- ccp4-5.0.1-orig/include/ccp4.setup-sh	2003-11-12 07:23:49.000000000 -0800
+++ ccp4-5.0.1/include/ccp4.setup-sh	2004-07-12 16:05:09.000000000 -0700
@@ -1,9 +1,8 @@
 #! /bin/sh
 # [The above is just for emacs -- this file should not be executed.]
 
-# CCP4 setup file for bash or ksh (untested) users.  Actually, the aliases 
-# can't work asis in ksh.  Should use builtins instead and not worry about
-# ease of keeping in step with the csh one.
+# CCP4 setup file for OS X bash or zsh users.  
+
 
 # $Id: ccp4.setup-sh,v 1.3 2003/11/12 15:23:49 ccb Exp $
 
@@ -13,22 +12,15 @@
 # name since no environment variables relevant to CCP4 are known until this is
 # executed.
 
-# For sites with more than one machine, it is recommended that the suite is
-# installed on a single machine and other machines access the source code, and
-# shareable files (such as this one) via shared file systems with NFS, RFS
-# etc.  Non-shareable files reside in $CBIN and $CLIB (see below).
-
-# Copy this file to ccp4.setup and customise it for your needs. There are
-# three sections. You MUST check the first section. You may want to check
-# the second. You don't need to look at the third.
+# This should be set up correctly for fink users of CCP4.
 
-################### THIS SECTION MUST BE EDITED #####################
+################### THIS SECTION has already been EDITED #####################
 
 # CCP4_MASTER is the location of the top-level directory containing `ccp4'.  
-# This is assumed to be shared between machines at a multi-machine site.
+# This is usually /sw/share/xtal for a fink installation.
 
 export CCP4_MASTER=/xtal                    
-export CCP4=$CCP4_MASTER/ccp4-5.0d
+export CCP4=$CCP4_MASTER/ccp4-5.0.1
 
 # CCP4_SCR: a per-user directory for run-time-generated scratch
 # files. A dedicated scratch filesystem is probably better than (/usr)/tmp
@@ -46,7 +38,7 @@
 export CCP4I_TOP=$CCP4/ccp4i
 # CCP4I_TCLTK - directory containing tclsh,wish and bltwish executables
 #               as used in $CCP4I_TOP/bin/ccp4i,ccp4ish,loggraph
-#               For 'standard' installations this is /usr/local/bin
+#               For 'standard' installations this is /sw/bin
 #               but note the SGI distributed version of Tcl/Tk is not 
 #               appropriate version
 export CCP4I_TCLTK=/sw/bin        
@@ -81,7 +73,7 @@
 #   MCTYPE: used for LAUE make -- see LAUE documentation
 #   CCP4_BROWSER: set this if you intend to use the html documentation
 #      (recommended).  It should have the path and name of a html browser eg
-#      /usr/bin/X11/netscape or /usr/local/bin/lynx. The browser will be
+#      /usr/bin/X11/netscape or /sw/bin/lynx. The browser will be
 #      started with the alias ccp4help and will open the file
 #      $CHTML/INDEX.html.
 
@@ -91,7 +83,7 @@
     export CBIN=$CCP4/bin		
     export CLIB=$CCP4/lib	
 
-    export CCP4_BROWSER=safari             
+    export CCP4_BROWSER=open             
     export MANPATH=$CCP4/man:$MANPATH           # edit this if necessary
     export MCTYPE=unix 			# (only for Laue)
 #     ;;
@@ -110,8 +102,8 @@
 export CLASSPATH=$CBIN:$CLASSPATH                      # edit this if necessary
 
 ### PLOT_COMMAND PRINT_COMMAND for the XCCPJIFFY programs to compile ###
-export PLOT_COMMAND='lp -s'  
-export PRINT_COMMAND='lp -s'    
+export PLOT_COMMAND='lpr'  
+export PRINT_COMMAND='lpr'    
 
 # HARVESTHOME specifies location of harvesting files (defaults to $HOME)
 export HARVESTHOME=$HOME     
@@ -133,39 +125,11 @@
 #
 #  export BINSORT_MEM=8388608
 
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-# at runtime
-if test "LD_LIBRARY_PATH"; then
-  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CLIB
-else
-  export LD_LIBRARY_PATH=$CLIB
-fi
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries
-# (e.g. libccp4.dylib) at runtime
-if test "DYLD_LIBRARY_PATH"; then
-  export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$CLIB
-else
-  export DYLD_LIBRARY_PATH=$CLIB
-fi
+# Fink does not allow LD_LIBRARY_PATH or DYLD_LIBRARY_PATH to be set
 
 ### XAPPLRESDIR ###
-
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
-# application defaults directory since it requires reading by xrdb to sort out
-# the differences for monochrome displays.  At Daresbury a version of the file
-# assuming a monochrome display is kept in the directory
-# $CCP4_LIB/X11/app-defaults and this is picked up through the
-# XUSERFILESEARCHPATH environment variable.  That means you only see black and
-# white on a colour display.  Alternatively you might make sure that it is
-# read by xrdb on startup of the X Windows system or delegate the
-# responsibility to users to run it.  There are disadvantages to putting an
-# invocation of xrdb in here, one being that the correct value of DISPLAY may
-# not be set at the time this file is read.  Thus edit this part as
-# appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-# instead of /usr; others may want /usr/local/lib or somw such):
-
-export XAPPLRESDIR=/sw/etc/app-defaults/
+# XUSERFILESEARCHPATH environment variable will be set in shell script wrapper.
+ 
 
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
@@ -217,8 +181,10 @@
 # confusion with `.' or whatever in the path:
 #
 # This construct prevents the path getting longer each time ccp4.setup is
-# executed (A. Perrakis)
-ccp4pathlist="${CCP4}/etc ${CBIN} ${CCP4I_TOP}/bin "
+# executed (A. Perrakis)  This was done wrong in the original file and is not
+# needed for zsh users.
+#
+ccp4pathlist="${CCP4}/etc:${CBIN}:${CCP4I_TOP}/bin"
 #
 for dir in ${ccp4pathlist}
 do
diff -ruN ccp4-5.0.1-orig/lib/src/cmaplib_f.c ccp4-5.0.1/lib/src/cmaplib_f.c
--- ccp4-5.0.1-orig/lib/src/cmaplib_f.c	2004-03-10 09:22:52.000000000 -0800
+++ ccp4-5.0.1/lib/src/cmaplib_f.c	2004-07-23 14:43:28.000000000 -0700
@@ -76,6 +76,7 @@
 #include"ccp4_fortran.h"
 #include"ccp4_parser.h"
 #include"csymlib.h"
+#include"ccp4_general.h"
 static char rcsid[] = "$Id: cmaplib_f.c,v 1.16 2004/03/10 17:22:52 mdw Exp $";
 
 static struct _IOConvMap *ioArray[MAXFILES];
@@ -1899,15 +1900,21 @@
 	      (const fpstr label, int label_len))
 {
   char *temp_label;
-  int nlabel,i;
+  int nlabel=0,i;
+
+  /* no output map, nothing to do */
+  if (last_Write == -1) return;
 
   temp_label = ccp4_FtoCString(FTN_STR(label), FTN_LEN(label));
-  
-  nlabel = ccp4_cmap_number_label(ioArray[last_Read]->mapfile);
-  for (i=0 ; i != nlabel ; ++i) 
-    ccp4_cmap_set_label(ioArray[last_Write]->mapfile,
+
+  if (last_Read != -1) {
+    nlabel = ccp4_cmap_number_label(ioArray[last_Read]->mapfile);
+    for (i=0 ; i != nlabel ; ++i) 
+      ccp4_cmap_set_label(ioArray[last_Write]->mapfile,
 			ccp4_cmap_get_label(ioArray[last_Read]->mapfile,i),
 			i);
+  }
+
   ccp4_cmap_set_label(ioArray[last_Write]->mapfile, temp_label,nlabel);
 
   free(temp_label);
@@ -1921,15 +1928,21 @@
      /* see MTTCPY */
 {
   char *temp_label;
-  int nlabel,i;
+  int nlabel=0,i;
+
+  /* no output map, nothing to do */
+  if (last_Write == -1) return;
 
   temp_label = ccp4_FtoCString(FTN_STR(label), FTN_LEN(label));
   
-  nlabel = ccp4_cmap_number_label(ioArray[last_Read]->mapfile);
-  for (i=0 ; i != nlabel ; ++i) 
-    ccp4_cmap_set_label(ioArray[last_Write]->mapfile,
+  if (last_Read != -1) {
+    nlabel = ccp4_cmap_number_label(ioArray[last_Read]->mapfile);
+    for (i=0 ; i != nlabel ; ++i) 
+      ccp4_cmap_set_label(ioArray[last_Write]->mapfile,
 			ccp4_cmap_get_label(ioArray[last_Read]->mapfile,i),
 			i);
+  }
+
   ccp4_cmap_set_label(ioArray[last_Write]->mapfile, temp_label,nlabel);
 
   free(temp_label);
diff -ruN ccp4-5.0.1-orig/src/fft.f ccp4-5.0.1/src/fft.f
--- ccp4-5.0.1-orig/src/fft.f	2004-01-26 02:08:19.000000000 -0800
+++ ccp4-5.0.1/src/fft.f	2004-07-23 14:42:29.000000000 -0700
@@ -6235,7 +6235,7 @@
       CALL MTZINI
       CALL CCPOPN(5,'DATA',5,1,LDUM,IFAIL)
       CALL CCPOPN(6,'PRINTER',6,1,LDUM,IFAIL)
-      CALL CCPRCS(6,'FFT','$Date: 2004/01/26 10:08:19 $')
+      CALL CCPRCS(6,'FFT','$Date: 2004/07/19 11:11:31 $')
 C          ***********************************
 C
 C---- Read input including spacegroup number
@@ -9753,7 +9753,9 @@
 C -- Not a patterson
          IF (ISQ.GT.0) THEN
 C          These pattersons can be set. No others..
-           IF(NLAFFT.EQ.4) NSPFFT = 10
+C   fft10 has a bug - disable it altogether..
+C          IF(NLAFFT.EQ.4) NSPFFT = 10
+           IF(NLAFFT.EQ.4) NSPFFT = 2
            IF(NLAFFT.EQ.6) NSPFFT = 47
 C -- Set to P1 (from P1bar) because permution of axes permitted
            IF(NLAFFT.EQ.3) NSPFFT = 1
diff -ruN ccp4-5.0.1-orig/x-windows/XCCPJIFFY/plot84_file.h ccp4-5.0.1/x-windows/XCCPJIFFY/plot84_file.h
--- ccp4-5.0.1-orig/x-windows/XCCPJIFFY/plot84_file.h	2004-06-03 08:27:20.000000000 -0700
+++ ccp4-5.0.1/x-windows/XCCPJIFFY/plot84_file.h	2004-07-12 16:11:20.000000000 -0700
@@ -28,7 +28,7 @@
   float      dvymin;     /* device viewport Y min (mm) */
   float      dvymax;     /* device viewport Y max (mm) */
   int        npics;      /* number of pictures in this file */           
-  char       paswrd [9]; /* password "PLOT%%84" */
+  char       paswrd [8]; /* password "PLOT%%84" */
   int        spare [15]; /* spare bytes */
   char       titleh [80];/* plot title */
   int        lastspare [68]; /* filled to 512 bytes */
