diff -r -u lilypond-1.8.0-orig/buildscripts/clean-fonts.sh lilypond-1.8.0/buildscripts/clean-fonts.sh
--- lilypond-1.8.0-orig/buildscripts/clean-fonts.sh	Sun Aug 10 11:56:23 2003
+++ lilypond-1.8.0/buildscripts/clean-fonts.sh	Sun Aug 10 11:57:06 2003
@@ -20,6 +20,7 @@
 /var/texfonts
 /var/cache/fonts
 /usr/share/texmf/fonts
+@prefix@/var/lib/texmf
 "
 
 for i in $dirs; do
diff -r -u lilypond-1.8.0-orig/lexer-gcc-3.1.sh lilypond-1.8.0/lexer-gcc-3.1.sh
--- lilypond-1.8.0-orig/lexer-gcc-3.1.sh	Sun Aug 10 11:56:32 2003
+++ lilypond-1.8.0/lexer-gcc-3.1.sh	Sun Aug 10 12:07:55 2003
@@ -8,7 +8,7 @@
 
 if [ -z "$FLEXLEXER" ]; then
 
-includes="$HOME/usr/include /usr/local/include /usr/include"
+includes="$HOME/usr/include $PREFIX/include /usr/local/include /usr/include" 
 
 for i in $includes; do
     file=$i/FlexLexer.h
@@ -43,9 +43,9 @@
 echo -n "Copying and fixing $file... "
 mkdir -p lily/$outdir
 rm -f lily/$outdir/FlexLexer.h
-sed -e 's/iostream.h/iostream/' \
-    -e 's/\<istream\>/std::istream/' \
-    -e 's/\<ostream\>/std::ostream/' \
+perl -p -e 's/iostream.h/iostream/g;' \
+    -e 's/\bistream\b/std::istream/g;' \
+    -e 's/\bostream\b/std::ostream/' \
     $file > lily/$outdir/FlexLexer.h
 echo "done"
 
@@ -58,9 +58,9 @@
     make conf=$CONF -C lily $outdir/lexer.cc > /dev/null 2>&1 || true
 
     mv $file $file.orig
-    sed -e 's/\<cin\>/std::cin/g' \
-	-e 's/\<cout\>/std::cout/g' \
-	-e 's/\<cerr\>/std::cerr/g' \
+    perl -p -e 's/\bcin\b/std::cin/g;' \
+	-e 's/\bcout\b/std::cout/g;' \
+	-e 's/\bcerr\b/std::cerr/g' \
 	$file.orig > $file
     echo "done"
 fi
Only in lilypond-1.8.0: lexer-gcc-3.1.sh~
diff -r -u lilypond-1.8.0-orig/lily/kpath.cc lilypond-1.8.0/lily/kpath.cc
--- lilypond-1.8.0-orig/lily/kpath.cc	Sun Aug 10 11:56:24 2003
+++ lilypond-1.8.0/lily/kpath.cc	Sun Aug 10 11:57:06 2003
@@ -26,6 +26,7 @@
 #define popen REALLYUGLYKLUDGE
 #define pclose ANOTHERREALLYUGLYKLUDGE
 #define getopt YAKLUDGE
+#define __GNU_LIBRARY__
 
 #if HAVE_KPATHSEA_KPATHSEA_H
 extern "C" {
diff -r -u lilypond-1.8.0-orig/lily/lily-guile.cc lilypond-1.8.0/lily/lily-guile.cc
--- lilypond-1.8.0-orig/lily/lily-guile.cc	Sun Aug 10 11:56:24 2003
+++ lilypond-1.8.0/lily/lily-guile.cc	Sun Aug 10 11:57:06 2003
@@ -37,6 +37,11 @@
 #include "interval.hh"
 #include "pitch.hh"
 #include "dimensions.hh"
+//
+// source-file.h includes cmath which undefines isinf and isnan
+//
+inline int (isinf)(Real r) { return isinf(r); }
+inline int (isnan)(Real r) { return isnan(r); }
 #include "source-file.hh"
 
 // #define TEST_GC
diff -r -u lilypond-1.8.0-orig/lily/my-lily-parser.cc lilypond-1.8.0/lily/my-lily-parser.cc
--- lilypond-1.8.0-orig/lily/my-lily-parser.cc	Sun Aug 10 11:56:24 2003
+++ lilypond-1.8.0/lily/my-lily-parser.cc	Sun Aug 10 11:57:06 2003
@@ -7,6 +7,10 @@
        Jan Nieuwenhuizen <janneke@gnu.org>
 */
 
+//
+// Work aroung a gcc 3.1 (?) bug
+//
+#include <iostream.h>
 #include "my-lily-parser.hh"
 #include "my-lily-lexer.hh"
 #include "warn.hh"
diff -r -u lilypond-1.8.0-orig/stepmake/stepmake/c++-rules.make lilypond-1.8.0/stepmake/stepmake/c++-rules.make
--- lilypond-1.8.0-orig/stepmake/stepmake/c++-rules.make	Sun Aug 10 11:56:28 2003
+++ lilypond-1.8.0/stepmake/stepmake/c++-rules.make	Sun Aug 10 12:08:09 2003
@@ -25,4 +25,5 @@
 	rm -f $(outdir)/$(*F).cc # avoid recompiling the .cc file 
 
 $(outdir)/%.cc: %.ll
-	$(FLEX) -Cfe -p -p -t $< > $@
+	$(FLEX) -Cfe -p -p -t $< >> $@
+	perl -i -pe 's/^class istream;/#include <iostream>;\nusing namespace std;/' $@
Only in lilypond-1.8.0/stepmake/stepmake: c++-rules.make~
diff -r -u lilypond-1.8.0-orig/stepmake/stepmake/c-vars.make lilypond-1.8.0/stepmake/stepmake/c-vars.make
--- lilypond-1.8.0-orig/stepmake/stepmake/c-vars.make	Sun Aug 10 11:56:28 2003
+++ lilypond-1.8.0/stepmake/stepmake/c-vars.make	Sun Aug 10 11:57:06 2003
@@ -13,4 +13,4 @@
 
 ALL_C_SOURCES += $(H_FILES) $(C_FILES) $(Y_FILES) $(L_FILES)
 
-ALL_CFLAGS = $(CFLAGS) $(ICFLAGS) $(DEFINES) $(addprefix -I,$(INCLUDES)) $(USER_CFLAGS) $(EXTRA_CFLAGS) $(MODULE_CFLAGS)
+ALL_CFLAGS = $(CFLAGS) $(CPPFLAGS) $(ICFLAGS) $(DEFINES) $(addprefix -I,$(INCLUDES)) $(USER_CFLAGS) $(EXTRA_CFLAGS) $(MODULE_CFLAGS)
diff -r -u lilypond-1.8.0-orig/stepmake/stepmake/compile-vars.make lilypond-1.8.0/stepmake/stepmake/compile-vars.make
--- lilypond-1.8.0-orig/stepmake/stepmake/compile-vars.make	Sun Aug 10 11:56:28 2003
+++ lilypond-1.8.0/stepmake/stepmake/compile-vars.make	Sun Aug 10 11:57:06 2003
@@ -3,7 +3,7 @@
 ALL_LDFLAGS = $(LDFLAGS) $(ILDFLAGS) $(EXTRA_LDFLAGS) $($(PACKAGE)_LDFLAGS) $(MODULE_LDFLAGS) $(USER_LDFLAGS)
 
 PIC_FLAGS = -fpic -fPIC
-SHARED_FLAGS = -shared
+SHARED_FLAGS = -bundle -flat_namespace -undefined suppress
 
 o-dep-out = $(outdir)/$(subst .o,.dep,$(notdir $@))#
 DO_O_DEP = rm -f $(o-dep-out); DEPENDENCIES_OUTPUT="$(o-dep-out) $(outdir)/$(notdir $@)"
diff -r -u lilypond-1.8.0-orig/stepmake/stepmake/install-out-targets.make lilypond-1.8.0/stepmake/stepmake/install-out-targets.make
--- lilypond-1.8.0-orig/stepmake/stepmake/install-out-targets.make	Sun Aug 10 11:56:28 2003
+++ lilypond-1.8.0/stepmake/stepmake/install-out-targets.make	Sun Aug 10 12:08:19 2003
@@ -6,13 +6,13 @@
 # urg, parameterise
 local-install-outfiles: $(INSTALLATION_OUT_FILES) $(foreach suff, $(INSTALLATION_OUT_SUFFIXES), $(INSTALLATION_OUT_FILES$(suff)))
 	-$(INSTALL) -d $(INSTALLATION_OUT_DIR)
-	$(foreach i, $(INSTALLATION_OUT_FILES), \
-		$(INSTALL) -m 644 $(i) $(INSTALLATION_OUT_DIR)/ && ) true
+	for i in $(INSTALLATION_OUT_FILES) ; do \
+		$(INSTALL) -m 644 $$i $(INSTALLATION_OUT_DIR)/; done
 	$(foreach suff, $(INSTALLATION_OUT_SUFFIXES),  \
 		($(INSTALL) -d $(INSTALLATION_OUT_DIR$(suff))/ || true) && \
-		$(foreach i, $(INSTALLATION_OUT_FILES$(suff)), \
-			$(INSTALL) -m 644 $(i) $(INSTALLATION_OUT_DIR$(suff))/ && ) true && ) true
-
+		for i in $(INSTALLATION_OUT_FILES$(suff)); do \
+			$(INSTALL) -m 644 $$i $(INSTALLATION_OUT_DIR$(suff))/; \
+			done && ) true
 
 local-uninstall: local-uninstall-outfiles local-uninstall-files 
 
diff -r -u lilypond-1.8.0-orig/stepmake/stepmake/install-targets.make lilypond-1.8.0/stepmake/stepmake/install-targets.make
--- lilypond-1.8.0-orig/stepmake/stepmake/install-targets.make	Sun Aug 10 11:56:28 2003
+++ lilypond-1.8.0/stepmake/stepmake/install-targets.make	Sun Aug 10 12:08:19 2003
@@ -7,12 +7,13 @@
 local-install-files: $(INSTALLATION_FILES)
 	$(PRE_INSTALL)
 	-$(INSTALL) -d $(INSTALLATION_DIR)
-	$(foreach i,  $(INSTALLATION_FILES),\
-		$(INSTALL) -m 644 $(i) $(INSTALLATION_DIR)/ &&)true
+	for i in $(INSTALLATION_FILES) ; do \
+		$(INSTALL) -m 644 $$i $(INSTALLATION_DIR)/; done
 	$(foreach suff, $(INSTALLATION_SUFFIXES),  \
 		($(INSTALL) -d $(INSTALLATION_DIR$(suff)) || true) && \
-		$(foreach i, $(INSTALLATION_FILES$(suff)), \
-			$(INSTALL) -m 644 $(i) $(INSTALLATION_DIR$(suff))/  && )  && ) true
+		for i in $(INSTALLATION_FILES$(suff)) ; do \
+			$(INSTALL) -m 644 $$i $(INSTALLATION_DIR$(suff))/ ; \
+		done && ) true
 	$(POST_INSTALL)
 
 local-uninstall: local-uninstall-outfiles local-uninstall-files 
