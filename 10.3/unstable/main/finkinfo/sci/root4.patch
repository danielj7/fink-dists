--- root.orig/build/unix/makelib.sh	Mon Mar 22 07:16:22 2004
+++ root.new/build/unix/makelib.sh	Thu Mar 25 09:30:34 2004
@@ -84,10 +84,16 @@
    fi
    # We need two library files: a .dylib to link to and a .so to load
    BUNDLE=`echo $LIB | sed s/.dylib/.so/`
+   # Add versioning information to shared library if available
+   if [ "x$MAJOR" != "x" ]; then
+       VERSION="-compatibility_version ${MAJOR} -current_version ${MAJOR}.${MINOR}.${REVIS}"
+       SONAME=`echo $SONAME | sed "s/.*\./&${MAJOR}./"`
+       LIB=`echo $LIB | sed "s/\/*.*\/.*\./&${MAJOR}.${MINOR}./"`
+   fi
    echo $LD $SOFLAGS$SONAME -o $LIB $OBJS \
-	`[ -d ${FINKDIR}/lib ] && echo -L${FINKDIR}/lib` -ldl $EXTRA
+	`[ -d ${FINKDIR}/lib ] && echo -L${FINKDIR}/lib` -ldl $EXTRA $VERSION
    $LD $SOFLAGS$SONAME -o $LIB $OBJS \
-	`[ -d ${FINKDIR}/lib ] && echo -L${FINKDIR}/lib` -ldl $EXTRA
+	`[ -d ${FINKDIR}/lib ] && echo -L${FINKDIR}/lib` -ldl $EXTRA $VERSION
    if [ "x`echo $SOFLAGS | grep -- '-g'`" != "x" ]; then
       opt=-g
    else
@@ -136,9 +142,16 @@
    exit $linkstat
 fi
 
-if [ "x$MAJOR" != "x" ] && [ -f $LIB.$MAJOR.$MINOR ]; then
-   ln -fs $SONAME.$MAJOR.$MINOR $LIB.$MAJOR
-   ln -fs $SONAME.$MAJOR        $LIB
+if [ "x$MAJOR" != "x" ]; then
+    if [ -f $LIB.$MAJOR.$MINOR ]; then
+        # Versioned library has format foo.so.3.05
+	ln -fs $SONAME.$MAJOR.$MINOR $LIB.$MAJOR
+	ln -fs $SONAME.$MAJOR        $LIB
+    elif [ -f $LIB ]; then
+	# Versioned library has format foo.3.05.so
+	ln -fs `echo $SONAME | sed "s/.*\./&${MINOR}./"` `echo $LIB | sed "s/\.${MINOR}//"`
+	ln -fs `echo $SONAME | sed "s/.*\./&${MINOR}./"` `echo $LIB | sed "s/\.${MAJOR}\.${MINOR}//"`
+    fi
 fi
 
 if [ $PLATFORM = "hpux" ]; then
--- root.orig/config/Makefile.macosx	Wed Sep  3 13:41:47 2003
+++ root.new/config/Makefile.macosx	Mon Sep  8 14:38:54 2003
@@ -59,6 +59,7 @@
 
 # Fortran:
 F77           = g77
+F77FLAGS      = -single_module
 F77LIBS       = -lg2c
 
 # Override default in Makefile.config
--- root.orig/hbook/Module.mk	Mon Sep 16 15:07:39 2002
+++ root.new/hbook/Module.mk	Mon Sep  8 14:26:26 2003
@@ -41,7 +41,7 @@
 
 $(HBOOKLIB):    $(HBOOKO) $(HBOOKDO) $(MAINLIBS) $(HBOOKLIBDEP)
 		@$(MAKELIB) $(PLATFORM) $(LD) "$(LDFLAGS)" \
-		   "$(SOFLAGS)" libHbook.$(SOEXT) $@ "$(HBOOKO1) $(HBOOKDO)" \
+		   "$(F77FLAGS) $(SOFLAGS)" libHbook.$(SOEXT) $@ "$(HBOOKO1) $(HBOOKDO)" \
 		   "$(HBOOKO2) $(CERNLIBDIR) $(CERNLIBS) $(RFIOLIBEXTRA) \
 		    $(SHIFTLIBDIR) $(SHIFTLIB) $(HBOOKLIBEXTRA) $(F77LIBS)"
 
--- root.orig/test/Makefile.arch	Fri Mar 12 00:35:54 2004
+++ root.new/test/Makefile.arch	Thu Mar 25 10:40:39 2004
@@ -439,15 +439,16 @@
 MACOSX_MINOR := $(shell sw_vers -productVersion | cut -d'.' -f2)
 CXX           = c++
 CXXFLAGS      = -O -pipe -Wall -W -Woverloaded-virtual
-LD            = c++
 LDFLAGS       = -O -Xlinker -bind_at_load -flat_namespace
 # The SOFLAGS will be used to create the .dylib; the .so will
 # be created separately
 DllSuf        = dylib
 ifeq ($(MACOSX_MINOR),3)
 UNDEFOPT      = dynamic_lookup
+LD            = MACOSX_DEPLOYMENT_TARGET=10.3 c++
 else
 UNDEFOPT      = suppress
+LD            = c++
 endif
 SOFLAGS       = -dynamiclib -flat_namespace -undefined $(UNDEFOPT)
 endif
@@ -458,15 +459,16 @@
 MACOSX_MINOR := $(shell sw_vers -productVersion | cut -d'.' -f2)
 CXX           = xlC
 CXXFLAGS      = 
-LD            = g++
 LDFLAGS       = -O -Xlinker -bind_at_load -flat_namespace
 # The SOFLAGS will be used to create the .dylib; the .so will
 # be created separately
 DllSuf        = dylib
 ifeq ($(MACOSX_MINOR),3)
 UNDEFOPT      = dynamic_lookup
+LD            = MACOSX_DEPLOYMENT_TARGET=10.3 g++
 else
 UNDEFOPT      = suppress
+LD            = g++
 endif
 SOFLAGS       = -dynamiclib -flat_namespace -undefined $(UNDEFOPT)
 endif
