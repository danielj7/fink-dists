diff -uNr pbzip2-0.9.4/pbzip2.cpp pbzip2-0.9.4-patched/pbzip2.cpp
--- pbzip2-0.9.4/pbzip2.cpp	2005-08-30 11:30:11.000000000 -0400
+++ pbzip2-0.9.4-patched/pbzip2.cpp	2005-08-30 22:25:58.000000000 -0400
@@ -88,6 +88,9 @@
 #ifdef WIN32
 #include <windows.h>
 #endif
+#ifdef __APPLE__
+#include <sys/sysctl.h>
+#endif
 
 // uncomment for debug output
 //#define PBZIP_DEBUG
@@ -1340,7 +1343,7 @@
 	fprintf(stderr, " -f       : force, overwrite existing output file\n");
 	fprintf(stderr, " -k       : keep input file, don't delete\n");
 	fprintf(stderr, " -p#      : where # is the number of processors (default");
-#ifdef _SC_NPROCESSORS_ONLN
+#if defined(_SC_NPROCESSORS_ONLN) || defined(__APPLE__)
 	fprintf(stderr, ": autodetect)\n");
 #else
 	fprintf(stderr, " 2)\n");
@@ -1424,7 +1427,14 @@
 	}
 
 	// Autodetect the number of CPUs on a box, if available
-	#ifdef _SC_NPROCESSORS_ONLN
+	#if defined(__APPLE__)
+		size_t len = sizeof(numCPU);
+		int mib[2];
+		mib[0] = CTL_HW;
+		mib[1] = HW_NCPU;
+		if (sysctl(mib, 2, &numCPU, &len, 0, 0) < 0 || len != sizeof(numCPU))
+			numCPU = 1;
+	#elif defined(_SC_NPROCESSORS_ONLN)
 		numCPU = sysconf(_SC_NPROCESSORS_ONLN);
 	#endif
 
