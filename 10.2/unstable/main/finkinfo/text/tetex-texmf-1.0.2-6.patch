diff -ruN texmf/tex/latex/graphics/pdftex.def texmf-patched/tex/latex/graphics/pdftex.def
--- texmf/tex/latex/graphics/pdftex.def	Mon Sep 13 04:04:03 1999
+++ texmf-patched/tex/latex/graphics/pdftex.def	Fri Aug 23 18:46:50 2002
@@ -1,9 +1,9 @@
-\ProvidesFile{pdftex.def}[1999/10/13 v0.02r graphics/color for pdftex]
+\ProvidesFile{pdftex.def}[2000/11/10 v0.03f graphics/color for pdftex]
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 %%
 %% LaTeX Colour and Graphics support for PDFTeX
 %%
-%% David Carlisle, Sebastian Rahtz and Hans Hagen
+%% David Carlisle, Sebastian Rahtz, Hans Hagen and Heiko Oberdiek
 %%
 %% It may be used by specifying the pdftex option to any of the
 %% supported packages, for example:
@@ -11,9 +11,56 @@
 %% \usepackage[pdftex]{graphicx}
 %%
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
+%
+% History
+% ...
+% 2000/04/20 v0.02s:
+%  * gray color model directly supported (HO).
+% 2000/05/02 v0.02t:
+%  * \pagecolor supported (HO).
+% 2000/05/12 v0.02u:
+%  * support for multipage pdf files, option `page' added (HO).
+% 2000/05/31 v0.02v:
+%  * Option `page' is defined at begin document,
+%    if package `keyval' is loaded after `pdftex.def'.
+% 2000/06/16 v0.03a:
+%  * Added Heiko to author list (DPC).
+% 2000/08/31 v0.03b:
+%  * support for alternate print images: option `print' added (HO).
+%    * This feature is not supported by Ghostscript, xpdf, or AR3.
+%    * The images should have the same dimensions/resolution.
+%  * Two experimental options added (HO):
+%    * `quiet': log messages are suppressed.
+%    * `resolution': sets \pdfimageresolution.
+%    Because these options are not supported by graphicx,
+%    they have to be set after \usepackage{graphicx}, eg.
+%      \setkeys{Gin}{quiet,resolution=300}
+%    Option `quiet' (for pdftex) can be make known to graphic{s,x}
+%    with this line in graphics.cfg:
+%      \DeclareOption{quiet}{\let\Gin@log\@gobble}
+%    Caution: both options are experimental and can be
+%    change in next versions!
+%  * \pdfpage{width,height} are only set, if \paperwidth
+%    is defined (HO).
+% 2000/09/04 v0.03c
+%  * Redefinition of `natwidth' and `natheight' \AtBeginDocument (HO).
+% 2000/09/14 v0.03d
+%  * Fixes for `viewport' and `trim' (HO).
+%  * Clip support added for viewport and trim (HO).
+% 2000/09/14 v0.03e
+%  * Options `bbllx', `bblly', `bburx', `bbury' disabled,
+%    option `bb' redirected with a warning to `viewport' (HO).
+% 2000/11/10 v0.03f
+%  * Bug, that produces an error message, if package `graphics'
+%    is used (introduced in 0.03d), fixed: If \Gin@vllx is not
+%    defined (graphics), then clipping and the moves of options
+%    viewport/trim are silently disabled.
+%
+% prefix of internal commands for this file `pdftex.def':
+%   \GPT@ (Graphics bundle PdfTex driver)
 
 \ifx\pdftexversion\@undefined
- \def\driver@release{1}%
+  \def\driver@release{1}%
 \else
   \ifnum\pdftexversion<12
     \def\driver@release{2}%
@@ -25,24 +72,29 @@
         \def\driver@release{4}%
       \fi
     \else
-     \ifnum\pdftexversion=13
-       \def\driver@release{5}%
-     \else
+      \ifnum\pdftexversion=13
+        \def\driver@release{5}%
+      \else
         \ifnum\pdftexversion=14
           \def\driver@release{6}%
         \else
           \def\driver@release{7}%
         \fi
-     \fi
+      \fi
     \fi
   \fi
 \fi
 
+\def\GPT@warn{\PackageWarning{pdftex.def}}
+\ifx\Gin@log\@undefined
+  \def\Gin@log{\message}
+\fi
+
 % Colour Support. The following models may be used.
 %   * cmyk   supported directly.
 %   * rgb    supported directly.
 %   * RGB    converted to rgb by this file.
-%   * gray   converted to rgb by this file.
+%   * gray   supported directly.
 %   * named  converted to cmyk by this file.
 %
 \def\c@lor@arg#1{%
@@ -50,7 +102,8 @@
   \ifdim\dimen@<\z@\dimen@\maxdimen\fi
   \ifdim\dimen@>\p@
     \PackageError{color}{Argument `#1' not in range [0,1]}\@ehd
-  \fi}
+  \fi
+}
 \def\color@cmyk#1#2{\c@lor@@cmyk#2\@@#1}
 \def\c@lor@@cmyk#1,#2,#3,#4\@@#5{%
   \c@lor@arg{#4}%
@@ -58,40 +111,87 @@
   \c@lor@arg{#2}%
   \c@lor@arg{#3}%
   \edef#5{#1 #2 #3 #4 k #1 #2 #3 #4 K}%
-  }
-\def\color@gray#1#2{\c@lor@@rgb#2,#2,#2\@@#1}
+}
+\def\color@gray#1#2{%
+  \c@lor@arg{#2}%
+  \edef#1{#2 g #2 G}%
+}
 \def\color@rgb#1#2{\c@lor@@rgb#2\@@#1}
 \def\c@lor@@rgb#1,#2,#3\@@#4{%
   \c@lor@arg{#1}%
   \c@lor@arg{#2}%
   \c@lor@arg{#3}%
   \edef#4{#1 #2 #3 rg #1 #2 #3 RG}%
-  }
+}
 \def\color@RGB#1#2{\c@lor@@RGB#2\@@#1}
 \def\c@lor@@RGB#1,#2,#3\@@#4{%
- \c@lor@RGB@rgb{#1}\@tempa
- \c@lor@RGB@rgb{#2}\@tempb
- \c@lor@RGB@rgb{#3}\@tempc
- \c@lor@@rgb\@tempa,\@tempb,\@tempc\@@#4%
-  }
+  \c@lor@RGB@rgb{#1}\@tempa
+  \c@lor@RGB@rgb{#2}\@tempb
+  \c@lor@RGB@rgb{#3}\@tempc
+  \c@lor@@rgb\@tempa,\@tempb,\@tempc\@@#4%
+}
 \def\c@lor@RGB@rgb#1#2{%
   \dimen@#1\p@
   \divide\dimen@\@cclv
-  \edef#2{\strip@pt\dimen@}}
+  \edef#2{\strip@pt\dimen@}%
+}
 
 \def\color@named#1#2{\c@lor@@named#2,,\@@#1}
 \def\c@lor@@named#1,#2,#3\@@#4{%
-  \@ifundefined{col@#1}%
-    {\PackageError{color}{Undefined color `#1'}\@ehd}%
-  {\edef#4{\csname col@#1\endcsname}}%
-  }
+  \@ifundefined{col@#1}{%
+    \PackageError{color}{Undefined color `#1'}\@ehd
+  }{%
+    \edef#4{\csname col@#1\endcsname}%
+  }%
+}
 
-\def\set@color{\pdfliteral{\current@color}\aftergroup\reset@color}
+\def\set@color{%
+  \pdfliteral{\current@color}%
+  \aftergroup\reset@color
+}
 \def\reset@color{\pdfliteral{\current@color}}
 \def\define@color@named#1#2{%
-   \expandafter\edef\csname col@#1\endcsname{#2}}
-\def\current@color{1 1 1 1 k 1 1 1 1 K}
+  \expandafter\edef\csname col@#1\endcsname{#2}%
+}
+\def\current@color{0 g 0 G}
 
+% v0.02t: support for \pagecolor
+\def\set@page@color{%
+  \global\let\current@page@color\current@color
+  \@ifundefined{GPTorg@shipout}{%
+    \global\let\GPTorg@shipout\shipout
+    \gdef\shipout{%
+      \afterassignment\GPT@shipout
+      \global\setbox\@cclv=%
+    }%
+    \gdef\GPT@shipout{%
+      \ifvoid\@cclv\relax
+         \aftergroup\GPT@@shipout
+         \GPT@pageliteral
+      \else
+        \GPTorg@shipout\vbox{%
+          \GPT@pageliteral
+          \box\@cclv
+        }%
+      \fi
+    }%
+    \gdef\GPT@@shipout{%
+      \GPTorg@shipout\box\@cclv\relax
+    }%
+    \gdef\GPT@pageliteral{%
+      \pdfliteral direct{%
+        q % gsave
+        \current@page@color\space
+        n % newpath
+        0 0 \strip@pt\pdfpagewidth\space
+        \strip@pt\pdfpageheight\space re % rectangle
+        % there is no need to convert to bp
+        f % fill
+        Q% grestore
+      }%
+    }%
+  }{}%
+}
 
 % Need the `colorfix' modifications as no internal colour stack
 % is maintained
@@ -100,12 +200,13 @@
   \let\@ldc@l@r\color
   \def\color{\if@inlabel\leavevmode\fi\@ldc@l@r}%
   \let\@lduseb@x\usebox
-  \def\usebox#1{\@lduseb@x{#1}\set@color}}
+  \def\usebox#1{\@lduseb@x{#1}\set@color}%
+}
 %</colorfix>
 
 %
 % Graphic inclusion. Currently supports .tif, .png, .jpg, .mps and .pdf inclusion;
-% .mps is MetaPost output. 
+% .mps is MetaPost output.
 % .mps inclusion depends on loading a CONTEXT module by Hans Hagen;
 % .pdf also needs a Context module unless pdftex 0.12n or later.
 %
@@ -116,9 +217,85 @@
 % prevent it fouling up with file names starting with "depth".
 \def\Gread@png#1{%
   \setbox\@tempboxa\hbox{\pdfimage\noexpand\noexpand\noexpand\@empty#1\relax}%
-   \def\Gin@llx{0}\let\Gin@lly\Gin@llx
-   \Gin@defaultbp\Gin@urx{\wd\@tempboxa}%
-   \Gin@defaultbp\Gin@ury{\ht\@tempboxa}}
+  \def\Gin@llx{0}\let\Gin@lly\Gin@llx
+  \Gin@defaultbp\Gin@urx{\wd\@tempboxa}%
+  \Gin@defaultbp\Gin@ury{\ht\@tempboxa}%
+}
+
+%
+% support for
+% * multipage pdf images (pdfTeX v0.14+)
+% * alternate print image (bitmaps only)
+%   * driver version>=5 (0.14)
+%   * printed image can be resused, but not the base image,
+%     because it's dictionary contains the additional key /Alternates.
+%   * not supported by Ghostscript or xpdf.
+% * option quiet
+%
+% \GPT@page: page number of pdf image or \@empty otherwise.
+\let\GPT@page\@empty
+% \GPT@print: file name for alternate image or \@empty otherwise.
+\let\GPT@print\@empty
+\begingroup
+  \toks@{%
+    \ifnum\driver@release>5
+      \define@key{Gin}{page}{%
+        \def\GPT@page{#1}%
+      }%
+      \define@key{Gin}{print}{%
+        \def\GPT@print{#1}%
+      }%
+    \else
+      \define@key{Gin}{page}{%
+        \GPT@warn{%
+          pdfTeX >= 0.14 required for option\MessageBreak `page'%
+        }%
+      }%
+      \define@key{Gin}{print}{%
+        \GPT@warn{%
+          pdfTeX >= 0.14 required for option\MessageBreak `print'%
+        }%
+      }%
+    \fi
+    \define@key{Gin}{quiet}[]{%
+      \let\Gin@log\@gobble
+    }%
+    \define@key{Gin}{resolution}{%
+      \pdfimageresolution#1\relax
+    }%
+  }%
+  \@ifundefined{define@key}{%
+    \edef\x{\endgroup
+      \noexpand\AtBeginDocument{%
+        \noexpand\@ifundefined{define@key}{}{\the\toks@}%
+      }%
+    }\x
+  }{%
+    \expandafter\endgroup\the\toks@
+  }
+
+% redefinitions of some graphicx options:
+\def\GPT@disable#1{%
+  \GPT@warn{%
+    Option `#1' is not supported, use\MessageBreak
+    option `viewport' instead%
+  }%
+}
+\AtBeginDocument{%
+  \@ifpackageloaded{graphicx}{%
+    \def\KV@Gin@bb{%
+      \GPT@warn{%
+        Option `bb' does not make sense,\MessageBreak
+        using `viewport' instead%
+      }%
+      \KV@Gin@viewport
+    }%
+    \define@key{Gin}{bbllx}{\GPT@disable{bbllx}}%
+    \define@key{Gin}{bblly}{\GPT@disable{bblly}}%
+    \define@key{Gin}{bburx}{\GPT@disable{bburx}}%
+    \define@key{Gin}{bbury}{\GPT@disable{bbury}}%
+  }{}%
+}
 
 %
 % mechanism for re-use of objects also
@@ -126,96 +303,248 @@
 % this works for all graphics types.
 %
 \newcount\Gread@gobject
+\def\GPT@ReusedName#1{%
+  \ifx\GPT@print\@empty
+    #1%
+  \else
+    \GPT@print
+  \fi
+}
 \def\Gread@pdftex#1{%
-\@ifundefined{#1 image}{%
- \ifnum\driver@release>4
-   \ifnum\driver@release>5
-     \pdfximage{#1}%
-     \setbox\@tempboxa=\hbox{\pdfrefximage\pdflastximage}%
-   \else
-     \setbox\@tempboxa=\hbox{\pdfimage{#1}}%
-   \fi
- \else
-  \setbox\@tempboxa=\hbox{\pdfimage\noexpand\noexpand\noexpand\@empty#1\relax}%
- \fi
- \def\Gin@llx{0}\let\Gin@lly\Gin@llx
- \Gin@defaultbp\Gin@urx{\wd\@tempboxa}%
- \Gin@defaultbp\Gin@ury{\ht\@tempboxa}%
- \expandafter\xdef\csname#1 width\endcsname{\the\wd\@tempboxa}%
- \expandafter\xdef\csname#1 height\endcsname{\the\ht\@tempboxa}%
- \message{<#1 \the\wd\@tempboxa, \the\ht\@tempboxa,}% 
- \ifnum\driver@release>5
-   \message{image \the\pdflastximage>}%
-   \expandafter\xdef\csname#1 image\endcsname{\pdfrefximage\the\pdflastximage}%
- \else
-   \pdfform\@tempboxa
-   \Gread@gobject=\pdflastform
-   \message{obj \the\Gread@gobject>}%
-   \expandafter\xdef\csname#1 image\endcsname{\pdfrefform\the\Gread@gobject}%
- \fi
- }{%
- \def\Gin@llx{0}\let\Gin@lly\Gin@llx
- \Gin@defaultbp\Gin@urx{\csname#1 width\endcsname}%
- \Gin@defaultbp\Gin@ury{\csname#1 height\endcsname}%
- }%
+  % Ensure that option `print' works only on bitmap images.
+  \ifGPT@IsBitmap
+  \else
+    \ifx\GPT@print\@empty
+    \else
+      \GPT@warn{%
+        Option `print' can only be used\MessageBreak
+        for bitmap images%
+      }%
+      \let\GPT@print\@empty
+    \fi
+  \fi
+  % If option `print' is set, the screen image object
+  % will contain an additional /Alternate entry
+  % and will therefore not be reused.
+  \ifx\GPT@print\@empty
+  \else
+    \expandafter\expandafter\expandafter\@firstoftwo\expandafter\@gobbletwo
+  \fi
+  \@ifundefined{#1 image\GPT@page}{%
+    \ifnum\driver@release>4
+      \ifnum\driver@release>5
+        \ifx\GPT@print\@empty
+          \let\GPT@RuleAttr\@empty
+        \else
+          \@ifundefined{\GPT@print\space image\GPT@page}{%
+            \immediate\pdfximage{\GPT@print}%
+            \setbox\@tempboxa=\hbox{\pdfrefximage\pdflastximage}%
+            \edef\GPT@PrintObj{\the\pdflastximage}%
+            \expandafter\xdef\csname\GPT@print\space
+              image\GPT@page\endcsname{\pdfrefximage\GPT@PrintObj}%
+            \immediate\pdfobj{%
+              [<<%
+                /Image \GPT@PrintObj\space 0 R%
+                /DefaultForPrinting true%
+              >>]%
+            }%
+            \def\GPT@RuleAttr{%
+              width\wd\@tempboxa height\ht\@tempboxa
+              attr{/Alternates \the\pdflastobj\space 0 R}%
+            }%
+          }{%
+            \edef\GPT@PrintObj{%
+              \expandafter\expandafter\expandafter\@gobble
+              \csname\GPT@print\space image\GPT@page\endcsname
+            }%
+            \immediate\pdfobj{%
+              [<<%
+                /Image \GPT@PrintObj \space 0 R%
+                /DefaultForPrinting true%
+              >>]%
+            }%
+            \def\GPT@RuleAttr{%
+              width \csname\GPT@print\space width\GPT@page\endcsname
+              height \csname\GPT@print\space height\GPT@page\endcsname
+              attr{/Alternates \the\pdflastobj\space 0 R}%
+            }%
+          }%
+        \fi
+        \pdfximage \GPT@RuleAttr
+        \ifx\GPT@page\@empty
+        \else
+          page \GPT@page
+        \fi
+        {#1}%
+        \setbox\@tempboxa=\hbox{\pdfrefximage\pdflastximage}%
+      \else
+        \setbox\@tempboxa=\hbox{\pdfimage{#1}}%
+      \fi
+    \else
+      \setbox\@tempboxa=\hbox{%
+        \pdfimage\noexpand\noexpand\noexpand\@empty#1\relax
+      }%
+    \fi
+    \def\Gin@llx{0}\let\Gin@lly\Gin@llx
+    \Gin@defaultbp\Gin@urx{\wd\@tempboxa}%
+    \Gin@defaultbp\Gin@ury{\ht\@tempboxa}%
+    \expandafter\xdef\csname\GPT@ReusedName{#1} width\GPT@page\endcsname{%
+      \the\wd\@tempboxa
+    }%
+    \expandafter\xdef\csname\GPT@ReusedName{#1} height\GPT@page\endcsname{%
+      \the\ht\@tempboxa
+    }%
+    \ifnum\driver@release>5
+      \expandafter\xdef\csname #1 image\GPT@page
+        \ifx\GPT@print\@empty\else!\fi\endcsname{%
+        \pdfrefximage\the\pdflastximage
+      }%
+    \else
+      \pdfform\@tempboxa
+      \Gread@gobject=\pdflastform
+      \expandafter\xdef\csname#1 image\endcsname{%
+        \pdfrefform\the\Gread@gobject
+      }%
+    \fi
+    \Gin@log{%
+       <#1, id=%
+       \ifnum\driver@release>5
+         \the\pdflastximage
+         \ifx\GPT@page\@empty\else , page=\GPT@page\fi
+         \ifx\GPT@print\@empty
+         \else
+            , print=\GPT@print, id=\GPT@PrintObj
+         \fi
+       \else
+         \the\Gread@gobject
+       \fi
+       , \the\wd\@tempboxa\space x \the\ht\@tempboxa
+       >%
+     }%
+  }{%
+    \def\Gin@llx{0}\let\Gin@lly\Gin@llx
+    \Gin@defaultbp\Gin@urx{\csname#1 width\GPT@page\endcsname}%
+    \Gin@defaultbp\Gin@ury{\csname#1 height\GPT@page\endcsname}%
+  }%
 }
 \def\Ginclude@pdftex#1{%
- \def\@tempa{!}%
- \ifx\Gin@scaley\@tempa
+  \def\@tempa{!}%
+  \ifx\Gin@scaley\@tempa
     \let\Gin@scaley\Gin@scalex
- \else
+  \else
     \ifx\Gin@scalex\@tempa\let\Gin@scalex\Gin@scaley\fi
- \fi
- \ifGin@clip
-  \typeout{no clipping support in pdfTeX}%
- \fi
- \message{<use #1>}%
- \hbox{\Gscale@box{\Gin@scalex}[\Gin@scaley]{\csname#1 image\endcsname}}%
+  \fi
+  \Gin@log{%
+    <use #1%
+    \ifx\GPT@page\@empty\else, page \GPT@page\fi
+    >%
+  }%
+  \hbox{%
+    \Gscale@box{\Gin@scalex}[\Gin@scaley]{%
+      \@ifundefined{Gin@vllx}{%
+        \GPT@viewportfalse
+        % without viewport/trim clipping does not make sense
+        % for pdfTeX
+        \Gin@clipfalse
+      }{}%
+      \ifGin@clip
+        \ifnum\driver@release<6
+          \GPT@warn{No clipping support in pdfTeX < 0.14}%
+        \else
+          \if!\Gin@vllx\Gin@vlly\Gin@vurx\Gin@vury!%
+          \else
+            \let\GPT@clipend\GPT@DoClipEnd
+            \setbox\@tempboxa\hbox\bgroup
+          \fi
+        \fi
+      \fi
+      \ifGPT@viewport
+        \ifdim\Gin@vlly\p@=\z@
+        \else
+          \lower\Gin@vlly bp\hbox\bgroup
+        \fi
+        \ifdim\Gin@vllx\p@=\z@
+        \else
+          \hskip-\Gin@vllx bp\relax
+        \fi
+      \fi
+      \csname#1 image\GPT@page
+        \ifx\GPT@print\@empty\else!\fi
+      \endcsname
+      \ifGPT@viewport
+        \ifdim\Gin@vlly\p@=\z@
+        \else
+          \egroup
+        \fi
+        \GPT@clipend
+      \fi
+    }%
+  }%
+}
+\newif\ifGPT@viewport
+\GPT@viewporttrue
+\let\GPT@clipend\relax
+\def\GPT@DoClipEnd{%
+  \egroup
+  \dp\@tempboxa\z@
+  % \Gin@urx and \Gin@ury already contain the correct values,
+  % so both cases viewport and trim can be handled together:
+  \dimen@\Gin@urx\p@
+  \advance\dimen@ -\Gin@vllx\p@
+  \wd\@tempboxa\strip@pt\dimen@ bp\relax
+  \dimen@\Gin@ury\p@
+  \advance\dimen@ -\Gin@vlly\p@
+  \ht\@tempboxa\strip@pt\dimen@ bp\relax
+  \pdfxform\@tempboxa
+  \pdfrefxform\pdflastxform
+}
+\newif\ifGPT@IsBitmap
+\def\Gread@pdfbitmap#1{%
+  \GPT@IsBitmaptrue
+  \Gread@pdftex{#1}%
+  \GPT@IsBitmapfalse
 }
-\ifnum\driver@release>3
-  \let\Gread@jpg\Gread@png
-\fi
-\ifnum\driver@release>5
-  \let\Gread@tif\Gread@png
-\fi
 
 \edef\Gread@MBox{/MediaBox}
 \def\Gread@pdf#1{%
   \begingroup
-  \@tempcnta\z@
-   \loop\ifnum\@tempcnta<\@xxxii
-   \catcode\@tempcnta14 %
-   \advance\@tempcnta\@ne
-  \repeat
-  \catcode127=14 %
-  \let\do\@makeother\dospecials\catcode`\ 10 %
-  \catcode\endlinechar5 %
-  \immediate\openin\@inputcheck#1 %
-  \ifeof\@inputcheck
-    \@latex@error{File `#1' not found}\@ehc
-  \else
-     \Gread@true
-     \let\@tempb\Gread@false
-     \loop
+    \@tempcnta\z@
+    \loop
+    \ifnum\@tempcnta<\@xxxii
+      \catcode\@tempcnta14 %
+      \advance\@tempcnta\@ne
+    \repeat
+    \catcode127=14 %
+    \let\do\@makeother\dospecials\catcode`\ 10 %
+    \catcode\endlinechar5 %
+    \immediate\openin\@inputcheck#1 %
+    \ifeof\@inputcheck
+      \@latex@error{File `#1' not found}\@ehc
+    \else
+      \Gread@true
+      \let\@tempb\Gread@false
+      \loop
 % v0.02e: use \. not \@tempa so the space is preserved before [
-       \read\@inputcheck to\.%
-       \ifeof\@inputcheck
-         \Gread@false
-       \else
-         \expandafter\Gread@find@mbox\. []\\%
-       \fi
-     \ifGread@
-     \repeat
-    \immediate\closein\@inputcheck
-  \fi
-  \ifGin@bbox\else
-    \@latex@error
+        \read\@inputcheck to\.%
+        \ifeof\@inputcheck
+          \Gread@false
+        \else
+          \expandafter\Gread@find@mbox\. []\\%
+        \fi
+      \ifGread@
+      \repeat
+      \immediate\closein\@inputcheck
+    \fi
+    \ifGin@bbox
+    \else
+      \@latex@error
       {Cannot determine size of graphic in #1 (no BoundingBox)}%
       \@ehc
-    \gdef\@gtempa{0 0 72 72 }%
-  \fi
+      \gdef\@gtempa{0 0 72 72 }%
+    \fi
   \endgroup
-  \expandafter\Gread@parse@bb\@gtempa\\}
+  \expandafter\Gread@parse@bb\@gtempa\\%
+}
 \long\def\Gread@find@mbox#1 [#2]#3\\{%
   \def\@tempa{#1}%
   \ifx\@tempa\Gread@MBox
@@ -229,58 +558,61 @@
 % v0.02f add \@depth\z@ (from Sebastian)
     \pdfimage
       \@height\Gin@req@height \@width\Gin@req@width \@depth\z@
-      \noexpand\noexpand\noexpand\@empty#1\relax}}
+      \noexpand\noexpand\noexpand\@empty#1\relax
+  }%
+}
 
 \def\Ginclude@mps#1{%
-   \def\@tempa{!}%
-   \ifx\Gin@scaley\@tempa
-     \let\Gin@scaley\Gin@scalex
-   \else
+  \def\@tempa{!}%
+  \ifx\Gin@scaley\@tempa
+    \let\Gin@scaley\Gin@scalex
+  \else
     \ifx\Gin@scalex\@tempa\let\Gin@scalex\Gin@scaley\fi
-   \fi    
-   \hbox{%
-     \convertMPtoPDF{#1}{\Gin@scalex}{\Gin@scaley}%
-        }%
+  \fi
+  \hbox{%
+    \convertMPtoPDF{#1}{\Gin@scalex}{\Gin@scaley}%
+  }%
 }
 \def\Gread@mps{\Gread@eps}
 \ifnum\driver@release>5
- \let\Gread@tif\Gread@pdftex
- \let\Ginclude@tif\Ginclude@pdftex
+  \let\Gread@tif\Gread@pdfbitmap
+  \let\Ginclude@tif\Ginclude@pdftex
 \fi
 \ifnum\driver@release>3
- \let\Ginclude@png\Ginclude@pdftex
- \let\Ginclude@jpg\Ginclude@pdftex
- \let\Ginclude@pdf\Ginclude@pdftex
- \let\Gread@pdf\Gread@pdftex
- \let\Gread@png\Gread@pdftex
- \let\Gread@jpg\Gread@pdftex
+  \let\Ginclude@png\Ginclude@pdftex
+  \let\Ginclude@jpg\Ginclude@pdftex
+  \let\Ginclude@pdf\Ginclude@pdftex
+  \let\Gread@pdf\Gread@pdftex
+  \let\Gread@png\Gread@pdfbitmap
+  \let\Gread@jpg\Gread@pdfbitmap
 \else
- \def\Ginclude@pdf#1{%
-   \def\@tempa{!}%
-   \ifx\Gin@scaley\@tempa
-     \let\Gin@scaley\Gin@scalex
-   \else
-    \ifx\Gin@scalex\@tempa\let\Gin@scalex\Gin@scaley\fi
-   \fi    
-   \hbox{%
-\convertPDFtoPDF{#1}{\Gin@scalex}{\Gin@scaley} {0bp} {0bp}{\Gin@req@width}{\Gin@req@height}%
-        }%
-}
+  \def\Ginclude@pdf#1{%
+    \def\@tempa{!}%
+    \ifx\Gin@scaley\@tempa
+      \let\Gin@scaley\Gin@scalex
+    \else
+      \ifx\Gin@scalex\@tempa\let\Gin@scalex\Gin@scaley\fi
+    \fi
+    \hbox{%
+      \convertPDFtoPDF{#1}{\Gin@scalex}{\Gin@scaley} {0bp} {0bp}%
+      {\Gin@req@width}{\Gin@req@height}%
+    }%
+  }
 \fi
 
 % v0.02e: restrict the rules to just the types that pdftex can currently
 % deal with.
 \ifnum\driver@release>3
- \ifnum\driver@release>5
-  \def\Gin@extensions{.png,.pdf,.jpg,.mps,.tif}
-  \@namedef{Gin@rule@.tif}#1{{tif}{.tif}{#1}}
-  \@namedef{Gin@rule@.jpg}#1{{jpg}{.jpg}{#1}}
- \else
-  \def\Gin@extensions{.png,.pdf,.jpg,.mps}
-  \@namedef{Gin@rule@.jpg}#1{{jpg}{.jpg}{#1}}
- \fi
+  \ifnum\driver@release>5
+    \def\Gin@extensions{.png,.pdf,.jpg,.mps,.tif}
+    \@namedef{Gin@rule@.tif}#1{{tif}{.tif}{#1}}
+    \@namedef{Gin@rule@.jpg}#1{{jpg}{.jpg}{#1}}
+  \else
+    \def\Gin@extensions{.png,.pdf,.jpg,.mps}
+    \@namedef{Gin@rule@.jpg}#1{{jpg}{.jpg}{#1}}
+  \fi
 \else
- \def\Gin@extensions{.png,.pdf,.mps}
+  \def\Gin@extensions{.png,.pdf,.mps}
 \fi
 \@namedef{Gin@rule@.png}#1{{png}{.png}{#1}}
 \@namedef{Gin@rule@.mps}#1{{mps}{.mps}{#1}}
@@ -291,47 +623,55 @@
 % slightly hacky, but set width of box 0 to 0pt otherwise
 % the CTM gets restored in the wrong place.
 
-% Patrick Daly found an error here with doubled minus signs when \Grot@sin is 
+% Patrick Daly found an error here with doubled minus signs when \Grot@sin is
 % negative. Fixed.
 \def\Grot@start{%
-\pdfliteral{ q
+  \pdfliteral{ q
      \Grot@cos\space\Grot@sin\space\if-\Grot@sin\else-\Grot@sin\fi\space\Grot@cos\space
-     0 0 cm}%
-  \wd\z@\z@}
+     0 0 cm%
+  }%
+  \wd\z@\z@
+}
 
 \def\Grot@end{\pdfliteral{ Q}}
 
 % Scaling is OK, as graphics package does it right here.
 \def\Gscale@start{%
   \pdfliteral{ q
-   \Gscale@x\space0 0 \Gscale@y\space 0 0 cm}}
+    \Gscale@x\space0 0 \Gscale@y\space 0 0 cm%
+  }%
+}
 
 \let\Gscale@end\Grot@end
 
 % undo the trig.sty `optimisation' so that these 0 1 and -1 values
 % get written out as digits, not unexpandable TeX primitives.
 \AtBeginDocument{%
-\expandafter\def\csname sin(0)\endcsname{0}%
-\expandafter\def\csname cos(0)\endcsname{1}%
-\expandafter\def\csname sin(90)\endcsname{1}%
-\expandafter\def\csname cos(90)\endcsname{0}%
-\expandafter\def\csname sin(-90)\endcsname{-1}%
-\expandafter\def\csname cos(-90)\endcsname{0}%
-\expandafter\def\csname sin(180)\endcsname{0}%
-\expandafter\def\csname cos(180)\endcsname{-1}}
+  \expandafter\def\csname sin(0)\endcsname{0}%
+  \expandafter\def\csname cos(0)\endcsname{1}%
+  \expandafter\def\csname sin(90)\endcsname{1}%
+  \expandafter\def\csname cos(90)\endcsname{0}%
+  \expandafter\def\csname sin(-90)\endcsname{-1}%
+  \expandafter\def\csname cos(-90)\endcsname{0}%
+  \expandafter\def\csname sin(180)\endcsname{0}%
+  \expandafter\def\csname cos(180)\endcsname{-1}%
+}
 
 % Are we running under PDFTeX?
 \ifx\pdfpageheight\@undefined
   \PackageWarningNoLine\@currname
     {pdftex option does not work with standard TeX}
 \else
-   \pdfpageheight\paperheight
-   \pdfpagewidth\paperwidth
-   \pdfoutput=1
+  \ifx\paperwidth\@undefined
+  \else
+    \pdfpageheight\paperheight
+    \pdfpagewidth\paperwidth
+  \fi
+  \pdfoutput=1
 \fi
 
 
-% v0.02e: Restore catcodes of context letters. 
+% v0.02e: Restore catcodes of context letters.
 % Not needed with current version of supp-pdf
 % but protects against older versions.
 \AtBeginDocument{%
@@ -340,20 +680,17 @@
     \catcode`\noexpand\@\the\catcode`\@
     \catcode`\noexpand\?\the\catcode`\? }%
   \InputIfFileExists{supp-pdf}{}{}%
-  \@tempa}
+  \@tempa
+}
 
 % these seem to upset pdftex. ignore them. SPQR 1999/08/02
 % allow for plain graphics, not graphicx.
-\@ifundefined{define@key}{%
-  \AtBeginDocument{%
-    \@ifundefined{define@key}{}{%
-      \define@key{Gin}{natwidth}{}%
-      \define@key{Gin}{natheight}{}%
-    }%
+% pdftex.def is loaded before the definition in graphicx,
+% so do all the stuff \AtBeginDocument:
+\AtBeginDocument{%
+  \@ifundefined{define@key}{}{%
+    \define@key{Gin}{natwidth}{}%
+    \define@key{Gin}{natheight}{}%
   }%
-}{%
-  \define@key{Gin}{natwidth}{}%
-  \define@key{Gin}{natheight}{}%
-}
+}%
 \endinput
-
diff -ruN texmf/tex/texinfo/texinfo.tex texmf-patched/tex/texinfo/texinfo.tex
--- texmf/tex/texinfo/texinfo.tex	Sat Sep 25 10:31:21 1999
+++ texmf-patched/tex/texinfo/texinfo.tex	Fri Aug 23 18:46:50 2002
@@ -3,10 +3,10 @@
 % Load plain if necessary, i.e., if running under initex.
 \expandafter\ifx\csname fmtname\endcsname\relax\input plain\fi
 %
-\def\texinfoversion{1999-09-25.10}
+\def\texinfoversion{2001-07-25.07}
 %
-% Copyright (C) 1985, 86, 88, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99
-% Free Software Foundation, Inc.
+% Copyright (C) 1985, 86, 88, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,
+%               2000, 01 Free Software Foundation, Inc.
 %
 % This texinfo.tex file is free software; you can redistribute it and/or
 % modify it under the terms of the GNU General Public License as
@@ -170,6 +170,16 @@
 }%
 \fi
 
+% add check for \lastpenalty to plain's definitions.  If the last thing
+% we did was a \nobreak, we don't want to insert more space.
+% 
+\def\smallbreak{\ifnum\lastpenalty<10000\par\ifdim\lastskip<\smallskipamount
+  \removelastskip\penalty-50\smallskip\fi\fi}
+\def\medbreak{\ifnum\lastpenalty<10000\par\ifdim\lastskip<\medskipamount
+  \removelastskip\penalty-100\medskip\fi\fi}
+\def\bigbreak{\ifnum\lastpenalty<10000\par\ifdim\lastskip<\bigskipamount
+  \removelastskip\penalty-200\bigskip\fi\fi}
+
 % For @cropmarks command.
 % Do @cropmarks to get crop marks.
 %
@@ -214,6 +224,9 @@
     \normalturnoffactive  % \ in index entries must not stay \, e.g., if
                    % the page break happens to be in the middle of an example.
     \shipout\vbox{%
+      % Do this early so pdf references go to the beginning of the page.
+      \ifpdfmakepagedest \pdfmkdest{\the\pageno} \fi
+      %
       \ifcropmarks \vbox to \outervsize\bgroup
         \hsize = \outerhsize
         \vskip-\topandbottommargin
@@ -243,8 +256,6 @@
         \unvbox\footlinebox
       \fi
       %
-      \ifpdfmakepagedest \pdfmkdest{\the\pageno} \fi
-      %
       \ifcropmarks
           \egroup % end of \vbox\bgroup
         \hfil\egroup % end of (centering) \line\bgroup
@@ -430,7 +441,7 @@
   % environments.  --karl, 6may93
   %{\advance \baselineskip by -\singlespaceskip
   %\kern \baselineskip}%
-  \setleading \singlespaceskip
+  \setleading\singlespaceskip
 }
 
 %% Simple single-character @ commands
@@ -687,16 +698,54 @@
 \def\nofillexdentyyy #1{{\advance \leftskip by -\exdentamount
 \leftline{\hskip\leftskip{\rm#1}}}}
 
-% @inmargin{TEXT} puts TEXT in the margin next to the current paragraph.
-
-\def\inmargin#1{%
-\strut\vadjust{\nobreak\kern-\strutdepth
-  \vtop to \strutdepth{\baselineskip\strutdepth\vss
-  \llap{\rightskip=\inmarginspacing \vbox{\noindent #1}}\null}}}
+% @inmargin{WHICH}{TEXT} puts TEXT in the WHICH margin next to the current
+% paragraph.  For more general purposes, use the \margin insertion
+% class.  WHICH is `l' or `r'.
+%
 \newskip\inmarginspacing \inmarginspacing=1cm
 \def\strutdepth{\dp\strutbox}
-
-%\hbox{{\rm#1}}\hfil\break}}
+%
+\def\doinmargin#1#2{\strut\vadjust{%
+  \nobreak
+  \kern-\strutdepth
+  \vtop to \strutdepth{%
+    \baselineskip=\strutdepth
+    \vss
+    % if you have multiple lines of stuff to put here, you'll need to
+    % make the vbox yourself of the appropriate size.
+    \ifx#1l%
+      \llap{\ignorespaces #2\hskip\inmarginspacing}%
+    \else
+      \rlap{\hskip\hsize \hskip\inmarginspacing \ignorespaces #2}%
+    \fi
+    \null
+  }%
+}}
+\def\inleftmargin{\doinmargin l}
+\def\inrightmargin{\doinmargin r}
+%
+% @inmargin{TEXT [, RIGHT-TEXT]}
+% (if RIGHT-TEXT is given, use TEXT for left page, RIGHT-TEXT for right;
+% else use TEXT for both).
+% 
+\def\inmargin#1{\parseinmargin #1,,\finish}
+\def\parseinmargin#1,#2,#3\finish{% not perfect, but better than nothing.
+  \setbox0 = \hbox{\ignorespaces #2}% 
+  \ifdim\wd0 > 0pt
+    \def\lefttext{#1}%  have both texts
+    \def\righttext{#2}%
+  \else
+    \def\lefttext{#1}%  have only one text
+    \def\righttext{#1}%
+  \fi
+  %
+  \ifodd\pageno
+    \def\temp{\inrightmargin\righttext}% odd page -> outside is right margin
+  \else
+    \def\temp{\inleftmargin\lefttext}%
+  \fi
+  \temp
+}
 
 % @include file    insert text of that file as input.
 % Allow normal characters that  we make active in the argument (a file name).
@@ -885,13 +934,17 @@
     \fi
       \ifx\empty\imagewidth\else width \imagewidth \fi
       \ifx\empty\imageheight\else height \imageheight \fi
-      {#1.pdf}%
+      \ifnum\pdftexversion<13
+	 #1.pdf%
+       \else
+         {#1.pdf}%
+       \fi
     \ifnum\pdftexversion < 14 \else
       \pdfrefximage \pdflastximage
     \fi}
-  \def\pdfmkdest#1{\pdfdest name{#1@} xyz}
+  \def\pdfmkdest#1{{\normalturnoffactive \pdfdest name{#1} xyz}}
   \def\pdfmkpgn#1{#1@}
-  \let\linkcolor = \Cyan
+  \let\linkcolor = \Blue  % was Cyan, but that seems light?
   \def\endlink{\Black\pdfendlink}
   % Adding outlines to PDF; macros for calculating structure of outlines
   % come from Petr Olsak
@@ -906,7 +959,8 @@
       \closein 1 
       \indexnofonts
       \def\tt{}
-      % thanh's hack / proper braces in bookmarks  
+      \let\_ = \normalunderscore
+      % Thanh's hack / proper braces in bookmarks  
       \edef\mylbrace{\iftrue \string{\else}\fi}\let\{=\mylbrace
       \edef\myrbrace{\iffalse{\else\string}\fi}\let\}=\myrbrace
       %
@@ -986,6 +1040,7 @@
   \def\pdfurl#1{%
     \begingroup
       \normalturnoffactive\def\@{@}%
+      \let\value=\expandablevalue
       \leavevmode\Red
       \startlink attr{/Border [0 0 0]}%
         user{/Subtype /Link /A << /S /URI /URI (#1) >>}%
@@ -1013,9 +1068,8 @@
   \def\makelink{\addtokens{\toksB}%
     {\noexpand\pdflink{\the\toksC}}\toksC={}\global\countA=0}
   \def\pdflink#1{%
-    \startlink attr{/Border [0 0 0]} goto name{\mkpgn{#1}}
+    \startlink attr{/Border [0 0 0]} goto name{\pdfmkpgn{#1}}
     \linkcolor #1\endlink}
-  \def\mkpgn#1{#1@} 
   \def\done{\edef\st{\global\noexpand\toksA={\the\toksB}}\st}
 \fi % \ifx\pdfoutput
 
@@ -1032,9 +1086,29 @@
 % We don't need math for this one.
 \def\ttsl{\tenttsl}
 
+% Default leading.
+\newdimen\textleading  \textleading = 13.2pt
+
+% Set the baselineskip to #1, and the lineskip and strut size
+% correspondingly.  There is no deep meaning behind these magic numbers
+% used as factors; they just match (closely enough) what Knuth defined.
+%
+\def\lineskipfactor{.08333}
+\def\strutheightpercent{.70833}
+\def\strutdepthpercent {.29167}
+%
+\def\setleading#1{%
+  \normalbaselineskip = #1\relax
+  \normallineskip = \lineskipfactor\normalbaselineskip
+  \normalbaselines
+  \setbox\strutbox =\hbox{%
+    \vrule width0pt height\strutheightpercent\baselineskip
+                    depth \strutdepthpercent \baselineskip
+  }%
+}
+
 % Use Computer Modern fonts at \magstephalf (11pt).
-\newcount\mainmagstep
-\mainmagstep=\magstephalf
+\newcount\mainmagstep \mainmagstep=\magstephalf
 
 % Set the font macro #1 to the font named #2, adding on the
 % specified font prefix (normally `cm').
@@ -1101,6 +1175,18 @@
 \font\smalli=cmmi9
 \font\smallsy=cmsy9
 
+% Fonts for small examples (8pt).
+\setfont\smallerrm\rmshape{8}{1000}
+\setfont\smallertt\ttshape{8}{1000}
+\setfont\smallerbf\bfshape{10}{800}
+\setfont\smallerit\itshape{8}{1000}
+\setfont\smallersl\slshape{8}{1000}
+\setfont\smallersf\sfshape{8}{1000}
+\setfont\smallersc\scshape{10}{800}
+\setfont\smallerttsl\ttslshape{10}{800}
+\font\smalleri=cmmi8
+\font\smallersy=cmsy8
+
 % Fonts for title page:
 \setfont\titlerm\rmbshape{12}{\magstep3}
 \setfont\titleit\itbshape{10}{\magstep4}
@@ -1189,7 +1275,7 @@
   \let\tenrm=\textrm \let\tenit=\textit \let\tensl=\textsl
   \let\tenbf=\textbf \let\tentt=\texttt \let\smallcaps=\textsc
   \let\tensf=\textsf \let\teni=\texti \let\tensy=\textsy \let\tenttsl=\textttsl
-  \resetmathfonts}
+  \resetmathfonts \setleading{\textleading}}
 \def\titlefonts{%
   \let\tenrm=\titlerm \let\tenit=\titleit \let\tensl=\titlesl
   \let\tenbf=\titlebf \let\tentt=\titlett \let\smallcaps=\titlesc
@@ -1218,7 +1304,14 @@
   \let\tenbf=\smallbf \let\tentt=\smalltt \let\smallcaps=\smallsc
   \let\tensf=\smallsf \let\teni=\smalli \let\tensy=\smallsy
   \let\tenttsl=\smallttsl
-  \resetmathfonts \setleading{11pt}}
+  \resetmathfonts \setleading{10.5pt}}
+\def\smallerfonts{%
+  \let\tenrm=\smallerrm \let\tenit=\smallerit \let\tensl=\smallersl
+  \let\tenbf=\smallerbf \let\tentt=\smallertt \let\smallcaps=\smallersc
+  \let\tensf=\smallersf \let\teni=\smalleri \let\tensy=\smallersy
+  \let\tenttsl=\smallerttsl
+  \resetmathfonts \setleading{9.5pt}}
+\let\smallexamplefonts = \smallerfonts
 
 % Set up the default fonts, so we can use them for creating boxes.
 %
@@ -1521,6 +1614,10 @@
    \oldpage
    \endgroup
    %
+   % Need this before the \...aftertitlepage checks so that if they are
+   % in effect the toc pages will come out with page numbers.
+   \HEADINGSon
+   %
    % If they want short, they certainly want long too.
    \ifsetshortcontentsaftertitlepage
      \shortcontents
@@ -1536,8 +1633,6 @@
    \fi
    %
    \ifpdf \pdfmakepagedesttrue \fi
-   %
-   \HEADINGSon
 }
 
 \def\finishtitlepage{%
@@ -1670,7 +1765,10 @@
 }
 
 % Subroutines used in generating headings
-% Produces Day Month Year style of output.
+% This produces Day Month Year style of output.
+% Only define if not already defined, in case a txi-??.tex file has set
+% up a different format (e.g., txi-cs.tex does this).
+\ifx\today\undefined
 \def\today{%
   \number\day\space
   \ifcase\month
@@ -1679,6 +1777,7 @@
   \or\putwordMSep\or\putwordMOct\or\putwordMNov\or\putwordMDec
   \fi
   \space\number\year}
+\fi
 
 % @settitle line...  specifies the title of the document, for headings.
 % It generates no output of its own.
@@ -2295,13 +2394,15 @@
 %
 \def\ignore{\doignore{ignore}}
 
-% Ignore @ifinfo, @ifhtml, @ifnottex, @html, @menu, and @direntry text.
+% Also ignore @ifinfo, @ifhtml, @ifnottex, @html, @menu,
+% @documentdescription, and @direntry text.
 %
 \def\ifinfo{\doignore{ifinfo}}
 \def\ifhtml{\doignore{ifhtml}}
 \def\ifnottex{\doignore{ifnottex}}
 \def\html{\doignore{html}}
 \def\menu{\doignore{menu}}
+\def\documentdescription{\doignore{documentdescription}}
 \def\direntry{\doignore{direntry}}
 
 % @dircategory CATEGORY  -- specify a category of the dir file
@@ -2408,10 +2509,14 @@
     \let\tenrm=\nullfont \let\tenit=\nullfont \let\tensl=\nullfont
     \let\tenbf=\nullfont \let\tentt=\nullfont \let\smallcaps=\nullfont
     \let\tensf=\nullfont
-    % Similarly for index fonts (mostly for their use in smallexample).
+    % Similarly for index fonts.
     \let\smallrm=\nullfont \let\smallit=\nullfont \let\smallsl=\nullfont
     \let\smallbf=\nullfont \let\smalltt=\nullfont \let\smallsc=\nullfont
     \let\smallsf=\nullfont
+    % Similarly for smallexample fonts.
+    \let\smallerrm=\nullfont \let\smallerit=\nullfont \let\smallersl=\nullfont
+    \let\smallerbf=\nullfont \let\smallertt=\nullfont \let\smallersc=\nullfont
+    \let\smallersf=\nullfont
     %
     % Don't complain when characters are missing from the fonts.
     \tracinglostchars = 0
@@ -2587,42 +2692,48 @@
 }
 
 % @defindex foo  ==  \newindex{foo}
-
+%
 \def\defindex{\parsearg\newindex}
 
 % Define @defcodeindex, like @defindex except put all entries in @code.
-
+%
+\def\defcodeindex{\parsearg\newcodeindex}
+%
 \def\newcodeindex#1{%
   \iflinks
     \expandafter\newwrite \csname#1indfile\endcsname
     \openout \csname#1indfile\endcsname \jobname.#1
   \fi
   \expandafter\xdef\csname#1index\endcsname{%
-    \noexpand\docodeindex{#1}}
+    \noexpand\docodeindex{#1}}%
 }
 
-\def\defcodeindex{\parsearg\newcodeindex}
 
 % @synindex foo bar    makes index foo feed into index bar.
 % Do this instead of @defindex foo if you don't want it as a separate index.
-% The \closeout helps reduce unnecessary open files; the limit on the
-% Acorn RISC OS is a mere 16 files.
-\def\synindex#1 #2 {%
-  \expandafter\let\expandafter\synindexfoo\expandafter=\csname#2indfile\endcsname
-  \expandafter\closeout\csname#1indfile\endcsname
-  \expandafter\let\csname#1indfile\endcsname=\synindexfoo
-  \expandafter\xdef\csname#1index\endcsname{% define \xxxindex
-    \noexpand\doindex{#2}}%
-}
-
+% 
 % @syncodeindex foo bar   similar, but put all entries made for index foo
 % inside @code.
-\def\syncodeindex#1 #2 {%
-  \expandafter\let\expandafter\synindexfoo\expandafter=\csname#2indfile\endcsname
-  \expandafter\closeout\csname#1indfile\endcsname
-  \expandafter\let\csname#1indfile\endcsname=\synindexfoo
-  \expandafter\xdef\csname#1index\endcsname{% define \xxxindex
-    \noexpand\docodeindex{#2}}%
+% 
+\def\synindex#1 #2 {\dosynindex\doindex{#1}{#2}}
+\def\syncodeindex#1 #2 {\dosynindex\docodeindex{#1}{#2}}
+
+% #1 is \doindex or \docodeindex, #2 the index getting redefined (foo),
+% #3 the target index (bar).
+\def\dosynindex#1#2#3{%
+  % Only do \closeout if we haven't already done it, else we'll end up
+  % closing the target index.
+  \expandafter \ifx\csname donesynindex#2\endcsname \undefined
+    % The \closeout helps reduce unnecessary open files; the limit on the
+    % Acorn RISC OS is a mere 16 files.
+    \expandafter\closeout\csname#2indfile\endcsname
+    \expandafter\let\csname\donesynindex#2\endcsname = 1
+  \fi
+  % redefine \fooindfile:
+  \expandafter\let\expandafter\temp\expandafter=\csname#3indfile\endcsname
+  \expandafter\let\csname#2indfile\endcsname=\temp
+  % redefine \fooindex:
+  \expandafter\xdef\csname#2index\endcsname{\noexpand#1{#3}}%
 }
 
 % Define \doindex, the driver for all \fooindex macros.
@@ -2854,16 +2965,17 @@
         % Now the real index entry with the fonts.
         \toks0 = {#2}%
         %
-        % If third (subentry) arg is present, add it to the index
-        % string.  And include a space.
+        % If the third (subentry) arg is present, add it to the index
+        % line to write.
         \ifx\thirdarg\emptymacro \else
-          \toks0 = \expandafter{\the\toks0 \space #3}%
+          \toks0 = \expandafter{\the\toks0{#3}}%
         \fi
         %
-        % Set up the complete index entry, with both the sort key
-        % and the original text, including any font commands.  We write
-        % three arguments to \entry to the .?? file, texindex reduces to
-        % two when writing the .??s sorted result.
+        % Set up the complete index entry, with both the sort key and
+        % the original text, including any font commands.  We write
+        % three arguments to \entry to the .?? file (four in the
+        % subentry case), texindex reduces to two when writing the .??s
+        % sorted result.
         \edef\temp{%
           \write\csname#1indfile\endcsname{%
             \realbackslash entry{\indexsorttmp}{\folio}{\the\toks0}}%
@@ -3085,11 +3197,18 @@
 \def\primary #1{\line{#1\hfil}}
 
 \newskip\secondaryindent \secondaryindent=0.5cm
-
-\def\secondary #1#2{
-{\parfillskip=0in \parskip=0in
-\hangindent =1in \hangafter=1
-\noindent\hskip\secondaryindent\hbox{#1}\indexdotfill #2\par
+\def\secondary#1#2{{%
+  \parfillskip=0in
+  \parskip=0in
+  \hangindent=1in
+  \hangafter=1
+  \noindent\hskip\secondaryindent\hbox{#1}\indexdotfill
+  \ifpdf
+    \pdfgettoks#2.\ \the\toksA % The page number ends the paragraph.
+  \else
+    #2
+  \fi
+  \par
 }}
 
 % Define two-column mode, which we use to typeset indexes.
@@ -3149,7 +3268,6 @@
   %
   % Double the \vsize as well.  (We don't need a separate register here,
   % since nobody clobbers \vsize.)
-  \advance\vsize by -\ht\partialpage
   \vsize = 2\vsize
 }
 
@@ -3163,6 +3281,7 @@
   % previous page.
   \dimen@ = \vsize
   \divide\dimen@ by 2
+  \advance\dimen@ by -\ht\partialpage
   %
   % box0 will be the left-hand column, box2 the right.
   \setbox0=\vsplit255 to\dimen@ \setbox2=\vsplit255 to\dimen@
@@ -3170,15 +3289,18 @@
   \unvbox255
   \penalty\outputpenalty
 }
+%
+% Re-output the contents of the output page -- any previous material,
+% followed by the two boxes we just split, in box0 and box2.
 \def\pagesofar{%
-  % Re-output the contents of the output page -- any previous material,
-  % followed by the two boxes we just split, in box0 and box2.
   \unvbox\partialpage
   %
   \hsize = \doublecolumnhsize
   \wd0=\hsize \wd2=\hsize
   \hbox to\pagewidth{\box0\hfil\box2}%
 }
+% 
+% All done with double columns.
 \def\enddoublecolumns{%
   \output = {%
     % Split the last of the double-column material.  Leave it on the
@@ -3203,8 +3325,9 @@
   % \endgroup where \vsize got restored).
   \pagegoal = \vsize
 }
+%
+% Called at the end of the double column material.
 \def\balancecolumns{%
-  % Called at the end of the double column material.
   \setbox0 = \vbox{\unvbox255}% like \box255 but more efficient, see p.120.
   \dimen@ = \ht0
   \advance\dimen@ by \topskip
@@ -4080,9 +4203,17 @@
 % is reset to zero; thus the \afterenvbreak inserts no space -- but the
 % start of the next paragraph will insert \parskip
 %
-\def\aboveenvbreak{{\advance\envskipamount by \parskip
-\endgraf \ifdim\lastskip<\envskipamount
-\removelastskip \penalty-50 \vskip\envskipamount \fi}}
+\def\aboveenvbreak{{%
+  \ifnum\lastpenalty < 10000
+    \advance\envskipamount by \parskip
+    \endgraf
+    \ifdim\lastskip<\envskipamount
+      \removelastskip
+      \penalty-50
+      \vskip\envskipamount
+    \fi
+  \fi
+}}
 
 \let\afterenvbreak = \aboveenvbreak
 
@@ -4214,7 +4345,7 @@
 \def\smalllispx{\begingroup
   \def\Esmalllisp{\nonfillfinish\endgroup}%
   \def\Esmallexample{\nonfillfinish\endgroup}%
-  \smallfonts
+  \smallexamplefonts
   \lisp
 }
 
@@ -4225,12 +4356,12 @@
   \let\Edisplay = \nonfillfinish
   \gobble
 }
-
+%
 % @smalldisplay (when @smallbook): @display plus smaller fonts.
 %
 \def\smalldisplayx{\begingroup
   \def\Esmalldisplay{\nonfillfinish\endgroup}%
-  \smallfonts \rm
+  \smallexamplefonts \rm
   \display
 }
 
@@ -4242,12 +4373,12 @@
   \let\Eformat = \nonfillfinish
   \gobble
 }
-
+%
 % @smallformat (when @smallbook): @format plus smaller fonts.
 %
 \def\smallformatx{\begingroup
   \def\Esmallformat{\nonfillfinish\endgroup}%
-  \smallfonts \rm
+  \smallexamplefonts \rm
   \format
 }
 
@@ -4265,6 +4396,7 @@
   \gobble
 }
 
+
 % @quotation does normal linebreaking (hence we can't use \nonfillstart)
 % and narrows the margins.
 %
@@ -4287,6 +4419,158 @@
 }
 
 
+% LaTeX-like @verbatim...@end verbatim and @verb{<char>...<char>}
+% If we want to allow any <char> as delimiter, 
+% we need the curly braces so that makeinfo sees the @verb command, eg:
+% `@verbx...x' would look like the '@verbx' command.  --janneke@gnu.org
+%
+% [Knuth]: Donald Ervin Knuth, 1996.  The TeXbook.
+%
+% [Knuth] p. 344; only we need to do '@' too
+\def\dospecials{%
+  \do\ \do\\\do\@\do\{\do\}\do\$\do\&%
+  \do\#\do\^\do\^^K\do\_\do\^^A\do\%\do\~}
+%
+% [Knuth] p. 380
+\def\uncatcodespecials{%
+  \def\do##1{\catcode`##1=12}\dospecials}
+%
+% [Knuth] pp. 380,381,391
+% Disable Spanish ligatures ?` and !` of \tt font
+\begingroup
+  \catcode`\`=\active\gdef`{\relax\lq}
+\endgroup
+%
+% Setup for the @verb command.
+%
+% Eight spaces for a tab
+\begingroup
+  \catcode`\^^I=\active
+  \gdef\tabeightspaces{\catcode`\^^I=\active\def^^I{\ \ \ \ \ \ \ \ }}
+\endgroup
+%
+\def\setupverb{%
+  \tt  % easiest (and conventionally used) font for verbatim
+  \def\par{\leavevmode\endgraf}%
+  \catcode`\`=\active
+  \tabeightspaces
+  % Respect line breaks,
+  % print special symbols as themselves, and
+  % make each space count
+  % must do in this order:
+  \obeylines \uncatcodespecials \sepspaces
+}
+
+% Setup for the @verbatim environment
+%
+% Real tab expansion
+\newdimen\tabw \setbox0=\hbox{\tt\space} \tabw=8\wd0 % tab amount
+%
+\def\starttabbox{\setbox0=\hbox\bgroup}
+\begingroup
+  \catcode`\^^I=\active
+  \gdef\tabexpand{%
+    \catcode`\^^I=\active
+    \def^^I{\leavevmode\egroup
+      \dimen0=\wd0 % the width so far, or since the previous tab
+      \divide\dimen0 by\tabw
+      \multiply\dimen0 by\tabw % compute previous multiple of \tabw
+      \advance\dimen0 by\tabw  % advance to next multiple of \tabw
+      \wd0=\dimen0 \box0 \starttabbox
+    }%
+  }
+\endgroup
+\def\setupverbatim{%
+  % Easiest (and conventionally used) font for verbatim
+  \tt
+  \def\par{\leavevmode\egroup\box0\endgraf}%
+  \catcode`\`=\active
+  \tabexpand
+  % Respect line breaks,
+  % print special symbols as themselves, and
+  % make each space count
+  % must do in this order:
+  \obeylines \uncatcodespecials \sepspaces
+  \everypar{\starttabbox}%
+}
+
+% Do the @verb magic: verbatim text is quoted by unique 
+% delimiter characters.  Before first delimiter expect a 
+% right brace, after last delimiter expect closing brace:
+%
+%    \def\doverb'{'<char>#1<char>'}'{#1}
+%
+% [Knuth] p. 382; only eat outer {}
+\begingroup
+  \catcode`[=1\catcode`]=2\catcode`\{=12\catcode`\}=12
+  \gdef\doverb{#1[\def\next##1#1}[##1\endgroup]\next]
+\endgroup
+%
+\def\verb{\begingroup\setupverb\doverb}
+%
+%
+% Do the @verbatim magic: define the macro \doverbatim so that
+% the (first) argument ends when '@end verbatim' is reached, ie:
+%
+%     \def\doverbatim#1@end verbatim{#1}
+%
+% For Texinfo it's a lot easier than for LaTeX, 
+% because texinfo's \verbatim doesn't stop at '\end{verbatim}':
+% we need not redefine '\', '{' and '}'
+%
+% Inspired by LaTeX's verbatim command set [latex.ltx]
+%% Include LaTeX hack for completeness -- never know
+%% \begingroup
+%% \catcode`|=0 \catcode`[=1
+%% \catcode`]=2\catcode`\{=12\catcode`\}=12\catcode`\ =\active
+%% \catcode`\\=12|gdef|doverbatim#1@end verbatim[
+%% #1|endgroup|def|Everbatim[]|end[verbatim]]
+%% |endgroup
+\begingroup
+  \catcode`\ =\active
+  \gdef\doverbatim#1@end verbatim{#1\end{verbatim}}
+\endgroup
+%
+\def\verbatim{%
+  \def\Everbatim{\nonfillfinish\endgroup}%
+  \begingroup
+    \nonfillstart
+    \advance\leftskip by -\defbodyindent
+    \begingroup\setupverbatim\doverbatim
+}
+
+% @verbatiminclude FILE - insert text of file in verbatim environment.
+%
+% Allow normal characters that we make active in the argument (a file name).
+\def\verbatiminclude{%
+  \begingroup
+    \catcode`\\=12
+    \catcode`~=12
+    \catcode`^=12
+    \catcode`_=12
+    \catcode`|=12
+    \catcode`<=12
+    \catcode`>=12
+    \catcode`+=12
+    \parsearg\doverbatiminclude
+}
+\def\setupverbatiminclude{%
+  \begingroup
+    \nonfillstart
+    \advance\leftskip by -\defbodyindent
+    \begingroup\setupverbatim
+}
+%
+\def\doverbatiminclude#1{%
+     % Restore active chars for included file.
+  \endgroup
+  \begingroup
+  \def\thisfile{#1}%
+  \expandafter\expandafter\setupverbatiminclude\input\thisfile
+  \endgroup\nonfillfinish\endgroup
+}
+
+
 \message{defuns,}
 % @defun etc.
 
@@ -4710,7 +4994,8 @@
 \def\deftypeivarheader#1#2#3{%
   \dosubind{vr}{\code{#3}}{\putwordof\ \code{#1}}% entry in variable index
   \begingroup
-    \defname{#3}{\putwordInstanceVariableof\ \code{#1}}%
+    \defname{\defheaderxcond#2\relax$$$#3}
+            {\putwordInstanceVariableof\ \code{#1}}%
     \defvarargs{#3}%
   \endgroup
 }
@@ -5244,13 +5529,15 @@
   \ifpdf
     \leavevmode
     \getfilename{#4}%
-    \ifnum\filenamelength>0
-      \startlink attr{/Border [0 0 0]}%
-        goto file{\the\filename.pdf} name{#1@}%
-    \else
-      \startlink attr{/Border [0 0 0]}%
-        goto name{#1@}%
-    \fi
+    {\normalturnoffactive
+     \ifnum\filenamelength>0
+       \startlink attr{/Border [0 0 0]}%
+         goto file{\the\filename.pdf} name{#1}%
+     \else
+       \startlink attr{/Border [0 0 0]}%
+         goto name{#1}%
+     \fi
+    }%
     \linkcolor
   \fi
   %
@@ -5530,24 +5817,6 @@
 
 }%end \catcode `\@=11
 
-% Set the baselineskip to #1, and the lineskip and strut size
-% correspondingly.  There is no deep meaning behind these magic numbers
-% used as factors; they just match (closely enough) what Knuth defined.
-%
-\def\lineskipfactor{.08333}
-\def\strutheightpercent{.70833}
-\def\strutdepthpercent {.29167}
-%
-\def\setleading#1{%
-  \normalbaselineskip = #1\relax
-  \normallineskip = \lineskipfactor\normalbaselineskip
-  \normalbaselines
-  \setbox\strutbox =\hbox{%
-    \vrule width0pt height\strutheightpercent\baselineskip
-                    depth \strutdepthpercent \baselineskip
-  }%
-}
-
 % @| inserts a changebar to the left of the current line.  It should
 % surround any changed text.  This approach does *not* work if the
 % change spans more than two lines of output.  To handle that, we would
@@ -5619,8 +5888,10 @@
 % Arguments to @image:
 % #1 is (mandatory) image filename; we tack on .eps extension.
 % #2 is (optional) width, #3 is (optional) height.
-% #4 is just the usual extra ignored arg for parsing this stuff.
-\def\imagexxx#1,#2,#3,#4\finish{%
+% #4 is (ignored optional) html alt text.
+% #5 is (ignored optional) extension.
+% #6 is just the usual extra ignored arg for parsing this stuff.
+\def\imagexxx#1,#2,#3,#4,#5,#6\finish{%
   \ifpdf
     \centerline{\dopdfimage{#1}{#2}{#3}}%
   \else
@@ -5628,7 +5899,8 @@
     \setbox0 = \hbox{\ignorespaces #2}\ifdim\wd0 > 0pt \epsfxsize=#2\relax \fi
     \setbox0 = \hbox{\ignorespaces #3}\ifdim\wd0 > 0pt \epsfysize=#3\relax \fi
     \begingroup
-      \catcode`\^^M = 5 % in case we're inside an example
+      \catcode`\^^M = 5     % in case we're inside an example
+      \normalturnoffactive  % allow _ et al. in names
       % If the image is by itself, center it.
       \ifvmode
         \nobreak\bigskip
@@ -5714,8 +5986,9 @@
 }
 
 % Parameters in order: 1) textheight; 2) textwidth; 3) voffset;
-% 4) hoffset; 5) binding offset; 6) topskip.  Then whoever calls us can
-% set \parskip and call \setleading for \baselineskip.
+% 4) hoffset; 5) binding offset; 6) topskip.  We also call
+% \setleading{\textleading}, so the caller should define \textleading.
+% The caller should also set \parskip.
 %
 \def\internalpagesizes#1#2#3#4#5#6{%
   \voffset = #3\relax
@@ -5736,14 +6009,25 @@
   \normaloffset = #4\relax
   \bindingoffset = #5\relax
   %
+  \setleading{\textleading}
+  %
   \parindent = \defaultparindent
   \setemergencystretch
 }
 
+% Use `small' versions.
+% 
+\def\smallenvironments{%
+  \let\smalldisplay = \smalldisplayx
+  \let\smallexample = \smalllispx
+  \let\smallformat = \smallformatx
+  \let\smalllisp = \smalllispx
+}
+
 % @letterpaper (the default).
 \def\letterpaper{{\globaldefs = 1
   \parskip = 3pt plus 2pt minus 1pt
-  \setleading{13.2pt}%
+  \textleading = 13.2pt
   %
   % If page is nothing but text, make it come out even.
   \internalpagesizes{46\baselineskip}{6in}{\voffset}{.25in}{\bindingoffset}{36pt}%
@@ -5752,7 +6036,7 @@
 % Use @smallbook to reset parameters for 7x9.5 (or so) format.
 \def\smallbook{{\globaldefs = 1
   \parskip = 2pt plus 1pt
-  \setleading{12pt}%
+  \textleading = 12pt
   %
   \internalpagesizes{7.5in}{5.in}{\voffset}{.25in}{\bindingoffset}{16pt}%
   %
@@ -5762,17 +6046,13 @@
   \contentsrightmargin = 0pt
   \deftypemargin = 0pt
   \defbodyindent = .5cm
-  %
-  \let\smalldisplay = \smalldisplayx
-  \let\smallexample = \smalllispx
-  \let\smallformat = \smallformatx
-  \let\smalllisp = \smalllispx
+  \smallenvironments
 }}
 
 % Use @afourpaper to print on European A4 paper.
 \def\afourpaper{{\globaldefs = 1
-  \setleading{12pt}%
   \parskip = 3pt plus 2pt minus 1pt
+  \textleading = 12pt
   %
   \internalpagesizes{53\baselineskip}{160mm}{\voffset}{4mm}{\bindingoffset}{44pt}%
   %
@@ -5780,23 +6060,39 @@
   \hfuzz = 1pt
 }}
 
+% Use @afivepaper to print on European A5 paper.
+% From romildo@urano.iceb.ufop.br, 2 July 2000.
+% He also recommends making @example and @lisp be small.
+\def\afivepaper{{\globaldefs = 1
+  \parskip = 2pt plus 1pt minus 0.1pt
+  \textleading = 12.5pt
+  %
+  \internalpagesizes{166mm}{120mm}{\voffset}{-8mm}{\bindingoffset}{8pt}%
+  %
+  \lispnarrowing = 0.2in
+  \tolerance = 800
+  \hfuzz = 1.2pt
+  \contentsrightmargin = 0mm
+  \deftypemargin = 0pt
+  \defbodyindent = 2mm
+  \tableindent = 12mm
+  %
+  \smallenvironments
+}}
+
 % A specific text layout, 24x15cm overall, intended for A4 paper.  Top margin
 % 29mm, hence bottom margin 28mm, nominal side margin 3cm.
 \def\afourlatex{{\globaldefs = 1
-  \setleading{13.6pt}%
+  \textleading = 13.6pt
   %
   \afourpaper
   \internalpagesizes{237mm}{150mm}{3.6mm}{3.6mm}{3mm}{7mm}%
-  %
-  \globaldefs = 0
 }}
 
 % Use @afourwide to print on European A4 paper in wide format.
 \def\afourwide{%
   \afourpaper
-  \internalpagesizes{9.5in}{6.5in}{\hoffset}{\normaloffset}{\bindingoffset}{7mm}%
-  %
-  \globaldefs = 0
+  \internalpagesizes{6.5in}{9.5in}{\hoffset}{\normaloffset}{\bindingoffset}{7mm}%
 }
 
 % @pagesizes TEXTHEIGHT[,TEXTWIDTH]
@@ -5810,7 +6106,7 @@
   \globaldefs = 1
   %
   \parskip = 3pt plus 2pt minus 1pt
-  \setleading{13.2pt}%
+  \setleading{\textleading}%
   %
   \internalpagesizes{#1}{\hsize}{\voffset}{\normaloffset}{\bindingoffset}{44pt}%
 }}
diff -ruN texmf/texmf.cnf.macosx texmf-patched/texmf.cnf.macosx
--- texmf/texmf.cnf.macosx	Wed Dec 31 19:00:00 1969
+++ texmf-patched/texmf.cnf.macosx	Fri Aug 23 18:49:36 2002
@@ -0,0 +1,44 @@
+% Our directory setup as explained in /usr/local/teTeX/share/README.macosx
+% TEXMFOS contains Mac OS specific defaults and additions
+TEXMFOS = $SELFAUTOPARENT/share/texmf.os
+% TEXMFLOCAL contains any local system TeXadmin overrides
+TEXMFLOCAL = $SELFAUTOPARENT/share/texmf.local
+% $VARTEXMF is where texconfig writes its local settings
+VARTEXMF = $TEXMFLOCAL
+% User texmf trees can be catered for like this...
+HOMETEXMF = $HOME/Library/texmf
+
+% Our complete search path, the last three are searched through
+% ls-R exclusively, which means that you have to run texhash
+% after you have added, moved or deleted files in the tree
+TEXMF={$HOMETEXMF,!!$TEXMFLOCAL,!!$TEXMFOS,!!$TEXMFMAIN}
+
+% If you want to disable the HOME trees, use this:
+% TEXMF=!!{$TEXMFLOCAL,$TEXMFOS,$TEXMFMAIN}
+
+% The system trees.  These are the trees that are shared by all the users.
+SYSTEXMF = !!{$TEXMFLOCAL,$TEXMFMAIN}
+
+% Where generated fonts may be written.  This tree is used when the sources
+% were found in a system tree and either that tree wasn't writable, or the
+% varfonts feature was enabled in MT_FEATURES in mktex.cnf.
+VARTEXFONTS = /var/tmp/texfonts
+
+% Make fonts when unavailable (not all fonts are available for pdf directly)
+% Useful when using non-pdf-available fonts and going the tex->dvi->ps->pdf route
+MKTEXPK.pdftex = 1
+MKTEXPK.pdflatex = 1
+MKTEXPK.pdfetex = 1
+MKTEXPK.pdfelatex = 1
+
+% Run time processing by ConTeXt needs this I think. Uncomment if needed
+% (I think this might have security implications, especially if you
+% run tex jobs as administrator, so I keep it turned of by default, just
+% like Thomas Esser.
+% shell_escape = t
+%
+% files for xdvi
+PKFONTS.XDvi    = .:$TEXMF/%s:$VARTEXFONTS/pk/{%m,modeless}//
+VFFONTS.XDvi    = .:$TEXMF/%s
+PSHEADERS.XDvi  = .:$TEXMF/%q{dvips,fonts/type1}//
+PSFIGURES.XDvi  = .:$TEXMF/%q{dvips,tex}//
