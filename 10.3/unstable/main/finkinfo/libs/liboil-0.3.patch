diff -uNr liboil-0.3.8/configure liboil-0.3.8-new/configure
--- liboil-0.3.8/configure	Tue Mar 21 15:37:46 2006
+++ liboil-0.3.8-new/configure	Sat May  6 15:52:34 2006
@@ -19294,14 +19294,6 @@
 
 
   case "x${host_cpu}" in
-    xi?86 | k?)
-      HAVE_I386=yes
-
-cat >>confdefs.h <<\_ACEOF
-#define HAVE_I386 1
-_ACEOF
-
-      ;;
     xx86_64|xamd64)
       HAVE_AMD64=yes
 
diff -uNr liboil-0.3.8/liboil/i386/copy8x8_i386.c liboil-0.3.8-new/liboil/i386/copy8x8_i386.c
--- liboil-0.3.8/liboil/i386/copy8x8_i386.c	Tue Aug  2 16:59:46 2005
+++ liboil-0.3.8-new/liboil/i386/copy8x8_i386.c	Sat May  6 15:52:34 2006
@@ -37,7 +37,11 @@
 copy8x8_u8_mmx (uint8_t *dest, int dstr, uint8_t *src, int sstr)
 {
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                      \n\t"
+#else
     "  .balign 16                      \n\t"
+#endif
 
     "  lea         (%2, %2, 2), %%edi  \n\t"
 
diff -uNr liboil-0.3.8/liboil/i386/diff8x8_i386.c liboil-0.3.8-new/liboil/i386/diff8x8_i386.c
--- liboil-0.3.8/liboil/i386/diff8x8_i386.c	Fri Oct 28 13:05:33 2005
+++ liboil-0.3.8-new/liboil/i386/diff8x8_i386.c	Sat May  6 15:52:34 2006
@@ -40,7 +40,11 @@
 diff8x8_s16_u8_mmx (int16_t *dest, uint8_t *src1, int ss1, uint8_t *src2, int ss2)
 {
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm7, %%mm7     \n\t" 
 
@@ -82,11 +86,14 @@
   const int16_t tmp[4] = { 0x0080, 0x0080, 0x0080, 0x0080 };
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm7, %%mm7     \n\t" 
     "  movq        (%3), %%mm1  \n\t"
-
     ".rept 8                        \n\t"
     "  movq        (%0), %%mm0      \n\t" /* mm0 = FiltPtr */
     "  movq        %%mm0, %%mm2     \n\t" /* dup to prepare for up conversion */
@@ -117,7 +124,11 @@
 diff8x8_average_s16_u8_mmx (int16_t *dest, uint8_t *src1, int ss1, uint8_t *src2, int ss2, uint8_t *src3)
 {
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm7, %%mm7     \n\t" 
 
diff -uNr liboil-0.3.8/liboil/i386/error8x8_i386.c liboil-0.3.8-new/liboil/i386/error8x8_i386.c
--- liboil-0.3.8/liboil/i386/error8x8_i386.c	Wed Dec 21 16:46:59 2005
+++ liboil-0.3.8-new/liboil/i386/error8x8_i386.c	Sat May  6 15:52:34 2006
@@ -42,7 +42,11 @@
   uint32_t  xxsum;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm5, %%mm5     \n\t"
     "  pxor        %%mm6, %%mm6     \n\t"
@@ -104,7 +108,11 @@
   uint32_t  xxsum;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm5, %%mm5     \n\t"
     "  pxor        %%mm6, %%mm6     \n\t"
@@ -176,7 +184,11 @@
   uint32_t xxsum;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pcmpeqd     %%mm4, %%mm4     \n\t"	/* fefefefefefefefe in mm4 */
     "  paddb       %%mm4, %%mm4     \n\t"
@@ -263,7 +275,11 @@
   uint32_t xxsum;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm4, %%mm4     \n\t"
     "  pxor        %%mm5, %%mm5     \n\t"
diff -uNr liboil-0.3.8/liboil/i386/recon8x8_i386.c liboil-0.3.8-new/liboil/i386/recon8x8_i386.c
--- liboil-0.3.8/liboil/i386/recon8x8_i386.c	Thu Dec 22 03:04:08 2005
+++ liboil-0.3.8-new/liboil/i386/recon8x8_i386.c	Sat May  6 15:52:34 2006
@@ -44,7 +44,11 @@
 recon8x8_intra_i386_mmx (uint8_t *dest, int ds, int16_t *change)
 {
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                      \n\t"
+#else
     "  .balign 16                      \n\t"
+#endif
 
     "  movq        (%3), %%mm0       \n\t" /* Set mm0 to 0x8080808080808080 */
 
@@ -79,7 +83,11 @@
 {
   /* FIXME doesn't handle ss */
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                      \n\t"
+#else
     "  .balign 16                      \n\t"
+#endif
 
     "  pxor        %%mm0, %%mm0        \n\t"
     "  lea         128(%1), %%edi      \n\t"
@@ -119,7 +127,11 @@
 {
   /* FIXME doesn't handle ss1, ss2 */
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                      \n\t"
+#else
     "  .balign 16                      \n\t"
+#endif
 
     "  pxor        %%mm0, %%mm0        \n\t"
     "  lea         128(%1), %%edi      \n\t"
diff -uNr liboil-0.3.8/liboil/i386/rowcolsad8x8_i386.c liboil-0.3.8-new/liboil/i386/rowcolsad8x8_i386.c
--- liboil-0.3.8/liboil/i386/rowcolsad8x8_i386.c	Tue Aug  2 21:25:11 2005
+++ liboil-0.3.8-new/liboil/i386/rowcolsad8x8_i386.c	Sat May  6 15:52:34 2006
@@ -40,7 +40,11 @@
   uint32_t MaxSad;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm6, %%mm6     \n\t"	/* zero out mm6 for unpack */
     "  pxor        %%mm7, %%mm7     \n\t" 	/* zero out mm7 for unpack */
@@ -92,7 +96,11 @@
   uint32_t MaxSad;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  movd        (%1), %%mm0      \n\t"
     "  movd        (%2), %%mm1      \n\t"
@@ -122,7 +130,11 @@
   uint32_t MaxSad;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm3, %%mm3     \n\t"	/* zero out mm3 for unpack */
     "  pxor        %%mm4, %%mm4     \n\t"	/* mm4 low sum */
@@ -205,7 +217,11 @@
   uint32_t MaxSad;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pxor        %%mm3, %%mm3     \n\t"	/* zero out mm3 for unpack */
     "  pxor        %%mm4, %%mm4     \n\t"	/* mm4 low sum */
diff -uNr liboil-0.3.8/liboil/i386/sad8x8_i386.c liboil-0.3.8-new/liboil/i386/sad8x8_i386.c
--- liboil-0.3.8/liboil/i386/sad8x8_i386.c	Tue Aug  2 21:28:44 2005
+++ liboil-0.3.8-new/liboil/i386/sad8x8_i386.c	Sat May  6 15:52:34 2006
@@ -40,7 +40,11 @@
   uint32_t diff;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
     "  pxor        %%mm6, %%mm6     \n\t"	/* zero out mm6 for unpack */
     "  pxor        %%mm7, %%mm7     \n\t" 	/* mm7 contains the result */
     ".rept 8                         \n\t"
@@ -89,7 +93,11 @@
   uint32_t diff;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
     "  pxor %%mm7, %%mm7            \n\t" 	/* mm7 contains the result */
 
     ".rept 7                        \n\t"
diff -uNr liboil-0.3.8/liboil/i386/sad8x8avg_i386.c liboil-0.3.8-new/liboil/i386/sad8x8avg_i386.c
--- liboil-0.3.8/liboil/i386/sad8x8avg_i386.c	Wed Dec 21 16:35:08 2005
+++ liboil-0.3.8-new/liboil/i386/sad8x8avg_i386.c	Sat May  6 15:52:34 2006
@@ -39,7 +39,11 @@
   uint32_t diff;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
 
     "  pcmpeqd     %%mm5, %%mm5     \n\t"	/* fefefefefefefefe in mm5 */
     "  paddb       %%mm5, %%mm5     \n\t"
@@ -106,7 +110,11 @@
   uint32_t  diff;
 
   __asm__ __volatile__ (
+#ifdef __APPLE__
+    "  .align 4                   \n\t"
+#else
     "  .balign 16                   \n\t"
+#endif
     "  pxor %%mm7, %%mm7            \n\t" 	/* mm7 contains the result */
     "  mov $0x01010101, %%eax       \n\t"
     "  movd %%eax, %%mm6            \n\t"
diff -uNr liboil-0.3.8/liboil/liboilprofile.c liboil-0.3.8-new/liboil/liboilprofile.c
--- liboil-0.3.8/liboil/liboilprofile.c	Mon Mar 20 17:20:59 2006
+++ liboil-0.3.8-new/liboil/liboilprofile.c	Sat May  6 15:53:27 2006
@@ -158,7 +158,7 @@
 }
 #endif
 
-#if defined(__powerpc__)
+#if defined(__powerpc__) || defined(__PPC__) || defined(__ppc__)
 static unsigned long
 oil_profile_stamp_tb(void)
 {
@@ -274,7 +274,7 @@
 #if defined(__amd64__)
   _oil_profile_stamp = oil_profile_stamp_tsc;
 #endif
-#if defined(__powerpc__)
+#if defined(__powerpc__) || defined(__PPC__) || defined(__ppc__)
   _oil_profile_stamp = oil_profile_stamp_tb;
 #endif
 #if defined(__alpha__)
diff -uNr liboil-0.3.8/liboil/powerpc/md5.c liboil-0.3.8-new/liboil/powerpc/md5.c
--- liboil-0.3.8/liboil/powerpc/md5.c	Thu Nov  3 02:01:27 2005
+++ liboil-0.3.8-new/liboil/powerpc/md5.c	Sat May  6 15:52:49 2006
@@ -25,6 +25,8 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
+#if 0
+
 #ifdef HAVE_CONFIG_H
 #include "config.h"
 #endif
@@ -510,3 +512,4 @@
 
 OIL_DEFINE_IMPL_ASM (md5_asm3, md5);
 
+#endif
diff -uNr liboil-0.3.8/unroll-rept.pl liboil-0.3.8-new/unroll-rept.pl
--- liboil-0.3.8/unroll-rept.pl	Wed Dec 31 19:00:00 1969
+++ liboil-0.3.8-new/unroll-rept.pl	Sat May  6 15:52:34 2006
@@ -0,0 +1,45 @@
+#!/usr/bin/perl
+
+for my $file (@ARGV) {
+	my $in_rept = 0;
+	my $rept_block = '';
+	my $rept_count = 0;
+	my $line_count = 0;
+	my $in_rept_count = 0;
+	if (open (FILEIN, $file)) {
+		if (open (FILEOUT, ">${file}.unrolled")) {
+			while (my $line = <FILEIN>) {
+				if ($in_rept) {
+					if ($line =~ /^\s*"\s*\.endr/i) {
+						$in_rept = 0;
+					} else {
+						$rept_block .= $line;
+					}
+				} elsif ($line =~ /^\s*"\s*\.rept\s+(\d+)/) {
+					$rept_count = $1;
+					$in_rept = 1;
+				} elsif ($rept_count) {
+					while ($rept_count > 0) {
+						print FILEOUT $rept_block;
+						$rept_count--;
+					}
+					$rept_count = 0;
+					$rept_block = '';
+					print FILEOUT $line;
+				} else {
+					print FILEOUT $line;
+				}
+			}
+			close (FILEOUT);
+		} else {
+			warn "unable to write to ${file}.unrolled\n";
+		}
+		close (FILEIN);
+	} else {
+		warn "unable to read from $file\n";
+	}
+
+	if (-s "${file}.unrolled") {
+		system("/bin/mv", "${file}.unrolled", $file);
+	}
+}
