Package: ccp4-gfortran
Version: 6.0
Revision: 1005
GCC: 4
Source: ftp://ftp.ccp4.ac.uk/ccp4/%v.0/packed/ccp4-%v.0-core-src.tar.gz
Source2: ftp://ftp.ccp4.ac.uk/ccp4/%v.0/packed/phaser-1.3.2-cctbx-src.tar.gz
Source-MD5: 00fe64b4600c9602aef56af0135f3016  
Source2-MD5: e4eee45ca8a299242a1089e35e63c7a0
SourceDirectory: ccp4-%v
Source3: http://chemistry.ucsc.edu/~wgscott/xtal/xtalfink/XCCPJiffy-custom.gz
Source3-MD5: 21568dd2475505929573a3fd452c538f
Source4: http://chemistry.ucsc.edu/~wgscott/xtal/xtalfink/ccp4_i686-apple-darwin8.6.1_libtool.gz
Source4-MD5: e40104835406c75c8aee16471b2dd06e
Depends: x11, tcltk, blt
BuildDepends: gcc4, f2c, fort77, tcltk-dev
Replaces: mosflm (<= 6.2.3-2), mosflm-small (<= 6.2.3-2), refmac (<= 5.1999-3), ccp4-shlibs, ccp4, ccp4-dev, bundle-ccp4, clipper-bin
Conflicts: ccp4-shlibs, ccp4, ccp4-dev, bundle-ccp4
NoSetCPPFLAGS: true
NoSetLDFLAGS: true
#
################################################################################
Patch: ccp4.patch
PatchScript: <<
#!/bin/zsh -ef
umask 0022
#
# setup script for tcsh, zsh and bash users
export TEMPXTAL=$PWD:h
#
perl -pi.bak -e 's|/xtal|\$TEMPXTAL|g' include/ccp4.setup*   # build prefix (changed in install)
perl -pi.bak -e 's|/prefix|%p|g' include/ccp4.setup*            # location of tcktk, blt
perl -pi.bak -e 's|/usr/local/bin|%p/bin|g' include/ccp4.setup*   # same
#
perl -pi.bak -e 's|SW_PREFIX|%p|g' **/configure            # location of tcktk, blt  
cp include/ccp4.setup-dist include/ccp4.setup
rm -f include/ccp4.setup-bash **/configure.bak include/ccp4.setup*.bak
#
# Set up XCCPJiffy wrapper scripts in $CCP4/etc
# These are small wrapper scripts for xplot84driver and xloggraph generated by the patch
 chmod a+x etc/x*
# Fix the dylib install path in configure
perl -pi.bak -e 's|\$rpath|%p/lib/ccp4-%v|g' **/configure
 
 # We need the mmdbold clipper libraries built for COOT:
perl -pi.bak -e 's|enable_mmdbold=no|enable_mmdbold=yes|g' lib/clipper/configure*
<<
################################################################################
CompileScript: <<
#!/bin/zsh -ef
umask 0022
 # These are required for the build environment
export TEMPXTAL=$PWD:h
source include/ccp4.setup-zsh
export DYLD_LIBRARY_PATH=$CLIB
export rpath=%p/lib/ccp4-%v
export RPATH=%p/lib/ccp4-%v
 # The cctbx sub-package requires us to use the system's own Python
export PATH=/System/Library/Frameworks/Python.framework/Versions/Current/bin:$PATH
export PYTHONHOME="/System/Library/Frameworks/Python.framework/Versions/Current"
export PYTHONPATH="/System/Library/Frameworks/Python.framework/Versions/Current/lib/python2.3"
 # gfortran is actually used by default, but to ensure the right thing happens, specify it.
 # Build static libs only for now. (Problems with dylibs and g++-4).
FC="gfortran" FOPTIM="-O0" CC="%p/lib/gcc4/bin/gcc" CXX="%p/lib/gcc4/bin/g++"  ./configure --with-x Darwin
# FC="gfortran" ./configure --with-x --with-shared-libs --with-fftw=%p Darwin
#  fix some post-configure bugs by getting rid of -lg2c
perl -pi.bak -e 's|-lg2c||g' x-windows/**/*akefile*
#
# change molrep optimization:
perl -pi.bak -e "s|molrep_FLAGS='-fno-second-underscore -O1'|molrep_FLAGS='-fno-second-underscore -O0'|g" src/Makefile

# perl -pi.bak -e 's|FC = g77 -fno-second-underscore||g' x-windows/XCCPJIFFY/Makefile

perl -pi.bak -e 's|%p/lib/gcc4/bin/||g' lib/clipper/**/Makefile*

# Replace the ccp4 libtool file with one that works and compiles cpirate:
cp ../ccp4_i686-apple-darwin8.6.1_libtool.gz  lib/clipper/libtool.gz 
mv -f lib/clipper/libtool lib/clipper/libtool-dist
gunzip lib/clipper/libtool.gz
chmod a+x lib/clipper/libtool

#################
make -i
make -i install
#################

# xloggraph will fail, but we will link it with fort77 below
#
# Make wrappers for xplot84driver and xloggraph, so rename the executables
cd  x-windows/XCCPJIFFY
cp xplot84driver  $CBIN/xplot84driver.exe
rm -f $CBIN/xplot84driver
#
# Manually link xloggraph with fort77 (fails in make)
echo ""
echo "**********************************************************************"
echo "Re-linking xloggraph with fort77.  Ignore previous error messages."
echo "**********************************************************************"
echo ""
#
 perl -pi.bak -e 's|FC = g77 -fno-second-underscore||g' Makefile
 make -i xloggraph  2>/dev/null
 fort77 -o xloggraph msg_box.o ZDr2d.o EditString.o hardcopy_ctrl.o xloggraph.o log_file.o tom_fortran_interface.o bits_and_pieces.o graphics.o -g -Os -I/usr/include/X11R6 -L/usr/X11R6/lib -lXaw -lXmu -lXt -lSM -lICE -lXpm -lXext -lX11 -lm -lgfortran -L%p/lib/gcc4/lib

#
sleep 10
#
cp xloggraph $CBIN/xloggraph.exe
cd ../..
#
# Cleanup:
#
# make realclean
/bin/rm -f **/*.o
/bin/rm -f **/*.bak
/bin/rm -R src 
/bin/rm -R x-windows 
/bin/rm -R unsupported
/bin/rm -R testcomp* 
/bin/rm -R BINARY*
cd $CLIB
/bin/rm -f **/*.c 
/bin/rm -f **/*.f 
/bin/rm -f **/*.cpp
echo "Compile Phase Completed!"
echo "There are $(command ls -1 $CBIN | wc -l) programs in $CBIN; "
echo "there should be 200"
<<
################################################################################
InstallScript: <<
#!/bin/zsh -ef
umask 0022
export TEMPXTAL=$PWD:h
source include/ccp4.setup-zsh
export DYLD_LIBRARY_PATH=$CLIB
ORIGDIR=$(dirname $PWD)
# Change environment scripts to match final installation
perl -pi -e 's|\$TEMPXTAL|%p/share/xtal|g' include/ccp4.setup*      # install prefix
#
#
 cp ../XCCPJiffy-custom.gz  XCCPJiffy.gz ; gunzip XCCPJiffy.gz; chmod a+x XCCPJiffy
 perl -pi -e 's|5.0.1|%v|g' XCCPJiffy
 mv -f  XCCPJiffy lib/X11/app-defaults/XCCPJiffy
#  
 perl -pi.bak -e 's|/src/fink.build/ccp4-%v-%r|/share/xtal|g' bin/clipper-config
 rm -f bin/clipper-config.bak
 perl -pi.bak -e 's|lclipper |lclipper-core |g' bin/clipper-config
 rm -f bin/clipper-config.bak                                
 perl -pi.bak -e 's|lib/lib -lrfftw -lfftw |lib/ccp4-%v -lsrfftw -lsfftw |g' bin/clipper-config
 rm -f bin/clipper-config.bak                                
#
# Fix path in libfoo.la libtool files:
#  
 perl -pi.bak -e 's|/src/fink.build/ccp4-%v-%r/ccp4-%v/lib|/lib/ccp4-%v|g' lib/**/*.la
 rm -f lib/**/*.la.bak
#
# Now install:
#
 mkdir -p %i/lib
 cp -R lib %i/lib/ccp4-%v
 mkdir -p %i/bin
#
 mkdir -p %i/share/xtal/ccp4-%v/help
 mkdir -p %i/share/man/man1
# set up man pages in a fink-compliant manner
 cd $PWD/doc
 mv rasmol.doc eightbit_rasmol.doc
 foreach docfilepage ( *.doc )
     cp ${docfilepage}  %i/share/man/man1/${docfilepage:r}.1
     cp ${docfilepage}  %i/share/xtal/ccp4-%v/help/${docfilepage:r}
end
# back to build directory
 cd ..
#                                
/bin/rm -rf lib 
#/bin/mv  lib lib-save

 cp -R * %i/share/xtal/ccp4-%v/.
 ln -s   %p/lib/ccp4-%v      %i/share/xtal/ccp4-%v/lib
#
# making scripts for %p/etc/profile.d  
 mkdir -p %i/etc/profile.d
#
 echo "source %p/share/xtal/ccp4-%v/include/ccp4.setup"                 > %i/etc/profile.d/ccp4.csh
 echo "setenv CLIB %p/lib/ccp4-%v "                                    >> %i/etc/profile.d/ccp4.csh
#

echo "if [ -z \$ZSH_NAME ];then                           "             > %i/etc/profile.d/ccp4.sh 
echo "    source %p/share/xtal/ccp4-%v/include/ccp4.setup-sh "         >> %i/etc/profile.d/ccp4.sh    
echo "else                                               "             >> %i/etc/profile.d/ccp4.sh
echo "    source %p/share/xtal/ccp4-%v/include/ccp4.setup-zsh"         >> %i/etc/profile.d/ccp4.sh
echo "fi                                                 "             >> %i/etc/profile.d/ccp4.sh
echo "export CLIB=%p/lib/ccp4-%v "                                     >> %i/etc/profile.d/ccp4.sh
#
 chmod a+x %i/etc/profile.d/ccp4.*
#
 chmod a+x  %i/share/xtal/ccp4-%v/ccp4i/etc/osx_ccp4_mail
#
# chmod a+x %i/share/xtal/ccp4-%v/etc/ccp4help 
#
 ranlib %i/lib/ccp4-%v/*.a
 ranlib %i/lib/ccp4-%v/**/*.a
#
<<
################################################################################
PostInstScript: <<
# Make the user read the license conditions
more %p/share/xtal/ccp4-%v/conditions.txt
<<
################################################################################
################################################################################
SplitOff: <<
Package: %N-dev
BuildDependsOnly: true
Description: CCP4 static libraries and libtool files
Files:<<
lib/ccp4-6.0/*.a  
lib/ccp4-6.0/*.la
<<
DocFiles:  CHANGES COPYING INSTALL INSTALL.html INSTALL.ps README PROBLEMS academic_software_licence.pdf
<<
################################################################################
Description:  Macromolecular crystallography package
DescDetail: <<
These are the ccp4 programs compiled with gfortran instead of g77.
The (currently default) g77 version won't work on intel.  The hope
is that this will. (With gfortran-4.0.3, everything compiles.)

CCP4 macromolecular crystallography suite has approximately
200 programs and utilities. This version included Clipper
libraries, and ccif and phaser. If you need cctbx, please
install the cctbx fink package separately.

Type "ccp4help" for a summary listing of all ccp4 programs.
Type "ccp4help foo" for a detailed description of program "foo."

Invoke optional ccp4i gui for the first run using: sudo ccp4i
Thereafter, invoke without sudo.

This version compiles with the Apple Lapack/Blas framework
License agreement is part of configure file -- print out form and mail in,
additional comments at http://chemistry.ucsc.edu/~wgscott/xtal/ccp4.html
CCP4 files will be installed under /sw/share/xtal/ccp4-6.0
This revision includes all available CCP4 patches as of Feb 26, 2006. 
and new bash and zsh command completions specific to ccp4.
<<
DocFiles: README CHANGES COPYING PROBLEMS INSTALL INSTALL.html INSTALL.ps ccp4i_installation.html academic_software_licence.pdf  academic_software_licence.ps.gz  academic_software_licence.rtf
Homepage: http://www.ccp4.ac.uk  
License: Commercial
Maintainer: W. G. Scott <wgscott@users.sourceforge.net>
