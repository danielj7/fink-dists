Package: ekiga
Version: 2.0.12
Revision: 1
Maintainer: None <fink-devel@users.sourceforge.net>
GCC: 4.0
BuildDepends: <<
	atk1,
	audiofile,
	avahi-dev,
	cairo,
	dbus-dev,
	esound,
	evolution-data-server-1.12-dev,
	gail18-dev,
	gconf2-dev,
	glib2-dev,
	glitz,
	gnome-keyring-dev,
	gnome-vfs2-unified-dev,
	gtk+2-dev,
	gtk-doc,
	intltool,
	libart2,
	libavahi-glib1-dev,
	libbonobo2-dev,
	libbonoboui2-dev,
	libjpeg,
	libgettext3-dev,
	libgnome2-dev,
	libgnomecanvas2-dev,
	libgnomeui2-dev,
	libpng3,
	libxml2-bin,
	libxslt-bin,
	opal2 (>= 2.2.8),
	openh323-1 (>= 1.19.0-2),
	orbit2-dev, 
	pango1-xft2-ft219-dev,
	pixman,
	pkgconfig,
	popt,
	pwlib1 (>= 1.10.7),
	sed,
	x11-dev
<<
# sed : because of the patchscript...
# configure looks for: scrollkeeper, pkg-config, /sw/etc/gconf (-> probably depends: gconf2), XML::Parser, gnome-doc-utils, intltool
# help uses yelp...
# help: Advanced Topics:Changing Ports: gconf-editor is needed
## possibly this would warrant only a Recommends, but it simplifies the Depends (a lot?), thanks to recursivenes _ else have
## to study again the output of "DYLD_PRINT_LIBRARIES" (using also the help facility), + some other...
## One should contemplate to dispense with "-Wl,-bind_at_load" (from the src) only after everything is settled, to keep (+/- easily) track with dep changes...
# When launching ekiga (from a terminal under KDE), I see in `ps -lgxa`  /sw/libexec/evolution-data-server-1.6 coming up
# (-> dep on evolution-data-server), but also /sw/libexec/evolution/2.6/evolution-exchange-storage, from evolution-exchange,
#  and  /sw/sbin/gnome-vfs-daemon (-> dep on gnome-vfs2-unified
# (satisfied through gconf-editor -> libgnomeui2 -> gnome-vfs2-unified ) _
# probably forgotten dep in evolution-data-server, but from the PID's, they are called (all from '1') in the order :
# /sw/sbin/gnome-vfs-daemon  /sw/libexec/evolution/2.6/evolution-exchange-storage /sw/libexec/evolution-data-server-1.6)
Depends: <<
	evolution-exchange,
	gconf-editor, 
	opal2-shlibs (>= 2.2.8),
	openh323-1-shlibs (>= 1.19.0-2),
	rarian-compat,
	yelp
<<
# yelp-viewer-seamonkey depends on seamonkey _ not only -shlibs (provisionally fixed in seamonkey.info).
# Avoid for the moment a dep just on yelp, because :
# 1) dependency EDS also depends on seamonkey , and none has been tested to build correctly (let alone identical debs..) with eg firefox
# 2) additional risk (+ wasted footprint...) in having one of them depend on firefox and the other on seamonkey.. 
Source: mirror:gnome:sources/%n/2.0/%n-%v.tar.bz2
Source-MD5: d86636c2195b4fb95aec427c17570008
PatchScript: <<
#!/bin/sh -ev
	# to strip binaries (cf LDFLAGS):
	echo '__mh_execute_header' > symlst

	# link with dylibs (and opal2) :
	sed -ri -e '/darwin\* \)/,+2{ s, \-DSTATIC_LIBS_USED,, ; s,-lh323_Darwin_ppc_r_s -lpt_Darwin_ppc_r_s,-lpt -lopal, }' configure

	# cf e-d-s for next :
	for f in `find . -name ltmain.sh` ; do sed -ri.bak -e 's,(s%%/)(\[\^/\]\*\$%%%%),\1\\+\2,' $f ; done
<<
NoSetLDFLAGS: true
SetLDFLAGS: -Wl,-x -exported_symbols_list %b/symlst -dead_strip
SetLIBRARY_PATH: %p/lib
NoSetCPPFLAGS: true
## following just set for 1 run, to run afterwards the following cmd :
## egrep '^\.+ /(sw|usr/X)' /sw/var/logs/ekiga2.log|cut -f2 -d' '|sort -u|xargs dpkg -S|cut -f1 -d:|sort -u|xargs
#SetCPPFLAGS: -H
SetCFLAGS: -O3 -fstrict-aliasing -mdynamic-no-pic
SetCXXFLAGS: -O3 -fstrict-aliasing -mdynamic-no-pic -fno-exceptions
# -fno-rtti leads, in lib/gmcontacts/gmcontacts-ldap.cpp, and in src, to
# "/sw/include/ptlib/pfactory.h: In static member function 'static PFactory<_Abstract_T, _Key_T>& PFactory<_Abstract_T, _Key_T>::GetInstance()':
# /sw/include/ptlib/pfactory.h:338: error: cannot use typeid with -fno-rtti"
ConfigureParams: --disable-scrollkeeper --disable-schemas-install --mandir=%p/share/man --with-pwlib-dir=%p --with-opal-dir=%p --enable-dbus --disable-sdl
# enabling sdl doesn't work because of undefined symbol _SDL_main
CompileScript: <<
#!/bin/sh -ev
	export CPATH=%p/include
	export PKG_CONFIG_PATH=%p/lib/fontconfig2/lib/pkgconfig:%p/lib/freetype219/lib/pkgconfig:%p/lib/pango-ft219/lib/pkgconfig:${PKG_CONFIG_PATH}
	./configure %c
	make all

	# following _ to get correct LOAD_COMMANDS _ should be re-done by editing src/Makefile.in ..
	# also, should be checked, after eg sdl is enabled, to see if it deals correctly with frameworks
	pushd src
		ls=$(otool -L ekiga|fgrep -v "`otool -D ekiga`"|sed -r -e 's,^\t,,' -e 's, .*,,'|egrep -vx '/usr/lib/lib(System|gcc|stdc\+\+).*\.dylib'|fgrep "`nm -mfgu ekiga|fgrep ' (from '|sed -r -e 's,.* \(from ,/,' -e 's,\)$,,'|sort -u`"|sed -r -e 's,(.*)/([^/]+)\.framework/\2,-F\1 -framework \2,'|xargs)
		g++ -Wl,-x -exported_symbols_list %b/symlst -dead_strip -Wl,-bind_at_load -o ekiga `ls -1 *.o|fgrep -v 'dbus-helper.o'|xargs` ../lib/.libs/libekiga.a $ls
		ls=$(otool -L ekiga-helper|fgrep -v "`otool -D ekiga-helper`"|sed -r -e 's,^\t,,' -e 's, .*,,'|egrep -vx '/usr/lib/lib(System|gcc|stdc\+\+).*\.dylib'|fgrep "`nm -mfgu ekiga-helper|fgrep ' (from '|sed -r -e 's,.* \(from ,/,' -e 's,\)$,,'|sort -u`"|sed -r -e 's,(.*)/([^/]+)\.framework/\2,-F\1 -framework \2,'|xargs)
		g++ -Wl,-x -exported_symbols_list %b/symlst -dead_strip -Wl,-bind_at_load -o ekiga-helper dbus-helper.o $ls
	popd
<<
Infotest: <<
	TestScript: make -ik check
<<
InstallScript: <<
	make install DESTDIR=%d
<<
ConfFiles: %p/etc/gconf/schemas/ekiga.schemas
PostInstScript: <<
	if [ configure = "$1" ]; then
		scrollkeeper-update -q
		GCONF_CONFIG_SOURCE=`gconftool-2 --get-default-source` gconftool-2 --makefile-install-rule %p/etc/gconf/schemas/ekiga.schemas >/dev/null
	fi
<<
## How to express that it depends on gconf2 until purged ???
## Or just that executing "dpkg --purge" should if needed (provisionally) install gconf2 ??
## (trying to put a 'fink install gconf2" (+ removal at the end if needed) in the script is almost sure
## to lead to a dpkg db access deadlock)
PreRmScript: <<
	if [ purge = "$1" ]; then
		GCONF_CONFIG_SOURCE=`gconftool-2 --get-default-source` gconftool-2 --makefile-uninstall-rule %p/etc/gconf/schemas/ekiga.schemas >/dev/null
	fi
<<
PostRmScript: <<  
	if [ remove != "$1" ]; then
		scrollkeeper-update -q
	fi
<<
DocFiles: AUTHORS COPYING ChangeLog FAQ NEWS
Description: Voice and video over IP
DescPort: <<
	video seems to find neither plugins, nor the built-in camera
	of a MacBook_Pro...
<<
License: GPL
Homepage: http://www.ekiga.org/
