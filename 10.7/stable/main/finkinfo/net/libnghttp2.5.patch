diff -ru nghttp2-0.7.0.orig/src/shrpx_worker.cc nghttp2-0.7.0/src/shrpx_worker.cc
--- nghttp2-0.7.0.orig/src/shrpx_worker.cc	2015-01-06 11:44:23.000000000 -0500
+++ nghttp2-0.7.0/src/shrpx_worker.cc	2015-01-08 11:46:15.000000000 -0500
@@ -66,7 +66,9 @@
 }
 
 void Worker::run() {
+#ifndef NOTHREADS
   fut_ = std::async(std::launch::async, [this] { this->run_loop(); });
+#endif // NOTHREADS
 }
 
 void Worker::run_loop() {
@@ -74,7 +76,11 @@
   ev_run(loop_);
 }
 
-void Worker::wait() { fut_.get(); }
+void Worker::wait() { 
+#ifndef NOTHREADS
+fut_.get();
+#endif // NOTHREADS
+}
 
 void Worker::send(const WorkerEvent &event) {
   {
diff -ru nghttp2-0.7.0.orig/src/util.cc nghttp2-0.7.0/src/util.cc
--- nghttp2-0.7.0.orig/src/util.cc	2015-01-06 11:44:23.000000000 -0500
+++ nghttp2-0.7.0/src/util.cc	2015-01-08 11:46:59.000000000 -0500
@@ -41,6 +41,7 @@
 #include <nghttp2/nghttp2.h>
 
 #include "timegm.h"
+#include "shrpx.h"
 
 namespace nghttp2 {
 
