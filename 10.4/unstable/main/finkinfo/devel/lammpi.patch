--- lam-7.1.2/config/lam_memory_setup.m4.org	2006-07-07 22:31:19.000000000 -0400
+++ lam-7.1.2/config/lam_memory_setup.m4	2006-07-07 22:31:38.000000000 -0400
@@ -56,7 +56,7 @@
 AC_DEFUN([LAM_DARWIN_MALLOC_SETUP],[
 case "$host" in
   *apple-darwin*)
-    WRAPPER_EXTRA_LDFLAGS="-Wl,-u -Wl,_lam_darwin_malloc_linker_hack -Wl,-multiply_defined,suppress -Wl,-force_flat_namespace -Wl,-flat_namespace $WRAPPER_EXTRA_LDFLAGS"
+    WRAPPER_EXTRA_LDFLAGS="-Wl,-u -Wl,_lam_darwin_malloc_linker_hack -Wl,-multiply_defined,suppress -Wl,-flat_namespace $WRAPPER_EXTRA_LDFLAGS"
     LDFLAGS="-Wl,-multiply_defined,suppress $LDFLAGS"
     ;;
   *)

 	  	 
diff -uNr lam-7.1.3.org/otb/mpirun/mpirun.c lam-7.1.3/otb/mpirun/mpirun.c
--- lam-7.1.3.org/otb/mpirun/mpirun.c	2006-06-24 16:42:25.000000000 -0400
+++ lam-7.1.3/otb/mpirun/mpirun.c	2007-05-27 19:31:33.000000000 -0400
@@ -104,7 +104,12 @@
  */
 extern struct kio_t _kio;     /* kernel I/O block */
 extern struct fclient _ufd[FUMAX];    /* user file desc. */
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 /*
  * exported variables
diff -uNr lam-7.1.3.org/otb/sys/haltd/haltd.c lam-7.1.3/otb/sys/haltd/haltd.c
--- lam-7.1.3.org/otb/sys/haltd/haltd.c	2006-12-28 13:42:20.000000000 -0500
+++ lam-7.1.3/otb/sys/haltd/haltd.c	2007-05-27 19:32:26.000000000 -0400
@@ -44,7 +44,12 @@
 /*
  * Access the environment
  */
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 /*
  * local variables
diff -uNr lam-7.1.3.org/otb/sys/kernel/kernelio.c lam-7.1.3/otb/sys/kernel/kernelio.c
--- lam-7.1.3.org/otb/sys/kernel/kernelio.c	2006-06-24 16:42:25.000000000 -0400
+++ lam-7.1.3/otb/sys/kernel/kernelio.c	2007-05-27 19:33:12.000000000 -0400
@@ -91,7 +91,12 @@
  * external variables
  */
 extern struct kproc	*prun;			/* current running client */
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 /*
  * local variables
diff -uNr lam-7.1.3.org/share/boot/asc_parse.c lam-7.1.3/share/boot/asc_parse.c
--- lam-7.1.3.org/share/boot/asc_parse.c	2006-06-24 16:42:42.000000000 -0400
+++ lam-7.1.3/share/boot/asc_parse.c	2007-05-27 19:34:20.000000000 -0400
@@ -652,7 +652,12 @@
 int
 asc_environment(int exportme, char *varlist, char ***env)
 {
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 	extern char	**environ;		/* current environment */
+# endif
 	char		**p;
 	char		*v;
 	int		nenv;
diff -uNr lam-7.1.3.org/share/boot/hbootparse.c lam-7.1.3/share/boot/hbootparse.c
--- lam-7.1.3.org/share/boot/hbootparse.c	2006-06-24 16:42:42.000000000 -0400
+++ lam-7.1.3/share/boot/hbootparse.c	2007-05-27 19:35:13.000000000 -0400
@@ -33,7 +33,12 @@
 #include <proc_schema.h>
 #include <sfh.h>
 
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 static char *conffile;
 static char **av_psc_path;
diff -uNr lam-7.1.3.org/share/ssi/boot/base/ssi_boot_find_boot_schema.c lam-7.1.3/share/ssi/boot/base/ssi_boot_find_boot_schema.c
--- lam-7.1.3.org/share/ssi/boot/base/ssi_boot_find_boot_schema.c	2006-06-24 16:42:36.000000000 -0400
+++ lam-7.1.3/share/ssi/boot/base/ssi_boot_find_boot_schema.c	2007-05-27 19:36:12.000000000 -0400
@@ -31,7 +31,12 @@
  * Access the environment
  */
 
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 
 
diff -uNr lam-7.1.3.org/share/ssi/boot/bproc/src/ssi_boot_bproc.c lam-7.1.3/share/ssi/boot/bproc/src/ssi_boot_bproc.c
--- lam-7.1.3.org/share/ssi/boot/bproc/src/ssi_boot_bproc.c	2006-06-24 16:42:36.000000000 -0400
+++ lam-7.1.3/share/ssi/boot/bproc/src/ssi_boot_bproc.c	2007-05-27 19:37:18.000000000 -0400
@@ -101,7 +101,12 @@
 /*
  * External variables
  */
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 
 int 
diff -uNr lam-7.1.3.org/share/ssi/boot/globus/src/ssi_boot_globus.c lam-7.1.3/share/ssi/boot/globus/src/ssi_boot_globus.c
--- lam-7.1.3.org/share/ssi/boot/globus/src/ssi_boot_globus.c	2006-06-24 16:42:36.000000000 -0400
+++ lam-7.1.3/share/ssi/boot/globus/src/ssi_boot_globus.c	2007-05-27 19:38:32.000000000 -0400
@@ -42,7 +42,12 @@
 /*
  * Access the environment
  */
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 
 /*
diff -uNr lam-7.1.3.org/share/ssi/boot/tm/src/ssi_boot_tm.c lam-7.1.3/share/ssi/boot/tm/src/ssi_boot_tm.c
--- lam-7.1.3.org/share/ssi/boot/tm/src/ssi_boot_tm.c	2006-06-24 16:42:36.000000000 -0400
+++ lam-7.1.3/share/ssi/boot/tm/src/ssi_boot_tm.c	2007-05-27 19:39:20.000000000 -0400
@@ -82,7 +82,12 @@
 /*
  * External variables
  */
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 
 int 
diff -uNr lam-7.1.3.org/share/ssi/crlam/base/ssi_crlam.c lam-7.1.3/share/ssi/crlam/base/ssi_crlam.c
--- lam-7.1.3.org/share/ssi/crlam/base/ssi_crlam.c	2006-06-24 16:42:42.000000000 -0400
+++ lam-7.1.3/share/ssi/crlam/base/ssi_crlam.c	2007-05-27 19:40:21.000000000 -0400
@@ -49,7 +49,12 @@
 /*
  * external variables
  */
+# ifdef __APPLE__
+#  include <crt_externs.h>
+#  define environ (*_NSGetEnviron())
+# else
 extern char **environ;
+# endif
 
 #define signal_puts(S)  write(STDOUT_FILENO, (S), strlen(S))
 
diff -uNr lam-7.1.3.org/tools/wrappers/wrap.cc lam-7.1.3/tools/wrappers/wrap.cc
--- lam-7.1.3.org/tools/wrappers/wrap.cc	2006-06-24 16:42:29.000000000 -0400
+++ lam-7.1.3/tools/wrappers/wrap.cc	2007-05-27 19:41:50.000000000 -0400
@@ -42,9 +42,17 @@
 // External functions
 //
 
+# ifdef __APPLE__
+#  include <crt_externs.h>
+# endif
+
 extern "C" {
   extern int cnfexec(char *argv[]);
+# ifdef __APPLE__
+#  define environ (*_NSGetEnviron())
+# else
   extern char **environ;
+# endif
 }
 
 
diff -uNr lam-7.1.3.org/tools/wrappers/wrap_cc.cc lam-7.1.3/tools/wrappers/wrap_cc.cc
--- lam-7.1.3.org/tools/wrappers/wrap_cc.cc	2006-06-24 16:42:29.000000000 -0400
+++ lam-7.1.3/tools/wrappers/wrap_cc.cc	2007-05-27 19:42:52.000000000 -0400
@@ -42,9 +42,17 @@
 // External functions
 //
 
+# ifdef __APPLE__
+#  include <crt_externs.h>
+# endif
+
 extern "C" {
   extern int cnfexec(char *argv[]);
+# ifdef __APPLE__
+#  define environ (*_NSGetEnviron())
+# else
   extern char **environ;
+# endif
 }
 
 
diff -uNr lam-7.1.3.org/tools/wrappers/wrap_cxx.cc lam-7.1.3/tools/wrappers/wrap_cxx.cc
--- lam-7.1.3.org/tools/wrappers/wrap_cxx.cc	2006-06-24 16:42:29.000000000 -0400
+++ lam-7.1.3/tools/wrappers/wrap_cxx.cc	2007-05-27 19:43:48.000000000 -0400
@@ -42,9 +42,17 @@
 // External functions
 //
 
+# ifdef __APPLE__
+#  include <crt_externs.h>
+# endif
+
 extern "C" {
   extern int cnfexec(char *argv[]);
+# ifdef __APPLE__
+#  define environ (*_NSGetEnviron())
+# else
   extern char **environ;
+# endif
 }
 
 
diff -uNr lam-7.1.3.org/tools/wrappers/wrap_f77.cc lam-7.1.3/tools/wrappers/wrap_f77.cc
--- lam-7.1.3.org/tools/wrappers/wrap_f77.cc	2006-06-24 16:42:29.000000000 -0400
+++ lam-7.1.3/tools/wrappers/wrap_f77.cc	2007-05-27 19:44:55.000000000 -0400
@@ -42,9 +42,17 @@
 // External functions
 //
 
+# ifdef __APPLE__
+#  include <crt_externs.h>
+# endif
+
 extern "C" {
   extern int cnfexec(char *argv[]);
+# ifdef __APPLE__
+#  define environ (*_NSGetEnviron())
+# else
   extern char **environ;
+# endif
 }
 
 
