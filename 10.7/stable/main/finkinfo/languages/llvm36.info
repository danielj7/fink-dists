Info3: <<
Package: llvm36
Version: 3.6.2
Revision: 1
Description: Modular and reusable compiler
License: BSD
Maintainer: David Fang <fangism@users.sourceforge.net>

BuildDepends: <<
	fink (>= 0.32), 
# for xz
	cmake (>= 2.8.10.2-1), 
	# on darwin11+, for libc++
	xcode (>= 4.6),
# ccache is optional, for accelerating rebuilds
#	ccache,
# polly plug-in needs isl,gmp
	isl2 (>=0.14), 
	gmp5,
# build scripts need python2.7
	python27,
	libncurses5-dev,
# xml and lzma are used to build an uninstalled bin/c-index-test, so bdep-only
	libxml2,
	liblzma5,
# pre-xz fink dists need explicit dependence on xz
	xz
<<
Depends: %N-shlibs
# no longer uses cloog directly, only indirectly through isl
BuildConflicts: <<
	cloog, cloog-org, cloog-org2
<<

Source: http://llvm.org/releases/%v/llvm-%v.src.tar.xz
Source-MD5: 0c1ee3597d75280dee603bae9cbf5cc2
Source2: http://llvm.org/releases/%v/cfe-%v.src.tar.xz
Source2-MD5: ff862793682f714bb7862325b9c06e20
Source3: http://llvm.org/releases/%v/compiler-rt-%v.src.tar.xz
Source3-MD5: e3bc4eb7ba8c39a6fe90d6c988927f3c
Source4: http://llvm.org/releases/%v/polly-%v.src.tar.xz
Source4-MD5: 09dd91d06cc0832095379d00206bc3a1
Source5: http://llvm.org/releases/%v/libcxx-%v.src.tar.xz
Source5-MD5: 22214c90697636ef960a49aef7c1823a
Source6: http://llvm.org/releases/%v/openmp-%v.src.tar.xz
Source6-MD5: 65dd5863b9b270960a96817e9152b123
# Source7: http://llvm.org/releases/%v/test-suite-%v.src.tar.xz
# Source7-MD5: 
# libcxxabi is not needed, use system's libc++abi or libsupc++

SourceDirectory: llvm-%v.src
# NoSourceDirectory: true
UseMaxBuildJobs: true

PatchFile: %n.patch
PatchFile-MD5: b2cd54c1855e5242efe47bf939ec8efe
PatchFile2: %n-clang.patch
PatchFile2-MD5: d2a2b4207c19b7f09f197ae9769a51d2
PatchFile3: %n-compiler-rt.patch
PatchFile3-MD5: 52d26da064d12bc7ffc2b269a12faa25
PatchFile4: %n-polly.patch
PatchFile4-MD5: ff0df5b623d372dbab73229a445ae417
PatchFile5: %n-libcxx.patch
PatchFile5-MD5: 32427770d4b114d97ccb0787f673be50
# PatchFile6: %n-clang-omp.patch
# PatchFile6-MD5: fa3d84690b274fb9c70da6ceae17223a
# PatchFile7: %n-clang-iomp5.patch
# PatchFile7-MD5: ee4a8910c21e6ceb60393813d2fb0f1e
# PatchFile8: %n-openmp-rXXXXXX.patch
# PatchFile8-MD5: ce5bb00dd597263d838cdcd897dbe4c8 

PatchScript: <<
	#!/bin/sh -ev
	# set -o pipefail || :
	# tarballs have mixed versions b/c some components did not change
	# "brv" = branch version, 3.6
	brv=3.6
	darwin_vers=`uname -r | cut -d. -f1`
	osx_version=`sw_vers -productVersion | cut -d. -f-2`

	llvm_abs_srcdir=%b
	# manual unpack for pre-xz fink
	if test "$darwin_vers" -lt 9
	then
	  for a in llvm cfe compiler-rt polly libcxx openmp
	  do xz -dc $a-%v.src.tar.xz | tar xvf -
	  done
	  cd llvm-%v.src
	  llvm_abs_srcdir="$llvm_abs_srcdir/llvm-%v.src"
	fi
	build_root="$llvm_abs_srcdir/../build"

	# cmake build ties subproject dirs together into one build
	pushd tools
	  ln -f -s ../../cfe-%v.src ./clang
	  ln -f -s ../../polly-%v.src ./polly
	popd
	pushd projects
	ln -f -s ../../compiler-rt-%v.src compiler-rt
# uncomment the next line to enable test-suite (huge):
#	ln -f -s ../../test-suite-%v.src test-suite
	popd

	patch_filter="sed -e s|@FINK_PREFIX@|%p|g -e s|@DARWIN_VERSION@|$darwin_vers|g"
	$patch_filter %{PatchFile} | patch -p1
	pushd tools/clang
	  # Apply clang-omp merge before clang patch
	  # $patch_filter %{PatchFile6} | patch -p1
	  $patch_filter %{PatchFile2} | patch -p1
	  # $patch_filter %{PatchFile7} | patch -p1
	popd
	pushd tools/polly
	  $patch_filter %{PatchFile4} | patch -p1
	  if test "$darwin_vers" -lt 12
	  then
	    perl -pi -e 's|suppress|suppress %p/lib/libcurses.dylib|g' cmake/polly_macros.cmake
	  fi
	popd
	pushd projects/compiler-rt
	  $patch_filter %{PatchFile3} | patch -p1
	  sed -i.orig -e '/http.*Article/s|^|// |' lib/asan/asan_malloc_mac.cc
	  test "$darwin_vers" -gt 9 || sed -i.orig -e 's|__bzero|bzero|g' lib/sanitizer_common/sanitizer_common_interceptors.inc
	  # or do actual symbol check on nm /usr/lib/libc.dylib /usr/lib/system/libsystem_c.dylib
	popd
	pushd ../libcxx-%v.src
	  $patch_filter %{PatchFile5} | patch -p1
	  # add a timeout to libc++ test, in case of hanging
	  mv test/lit.cfg{,.orig}
	  awk '{
if ($1 == "cmd.append(exec_path)") {
	s1 = $0; s2 = $0;
	gsub("exec_path", "'\'gtimeout\''", s1);
	gsub("exec_path", "'\'1m\''", s2);
	print s1; print s2;
}
	print;
}' test/lit.cfg.orig > test/lit.cfg
	popd

	# point hard-coded paths to system g++-4.0.1's C++ includes
	# remove references to g++-4.2.1, never existed in Xcode 2.5
	if test "$darwin_vers" != 10
	then sed -i.orig -e "s|darwin10|darwin$darwin_vers|g" \
		tools/clang/lib/Frontend/InitHeaderSearch.cpp
	fi
	if test ! -d /usr/include/c++/4.0.0
	then sed -i.orig2 -e '/GnuCPlusPlusInclude.*4\.0\.0/,/);/d' \
		tools/clang/lib/Frontend/InitHeaderSearch.cpp
	fi
	if test ! -d /usr/include/c++/4.2.1
	then sed -i.orig2 -e '/GnuCPlusPlusInclude.*4\.2\.1/,/);/d' \
		tools/clang/lib/Frontend/InitHeaderSearch.cpp
	fi

	# Adjust path for relocation of libc++ headers (from xcode or system)
	test -d /usr/lib/c++/v1 ||
	test "$darwin_vers" -lt 11 ||
	{
	  sys_clang_path=`xcrun -find clang`
	  pushd `dirname $sys_clang_path`
	  if test -d ../lib/c++/v1
	  then
	    cd ../lib/c++/v1
	    sys_cxx_incdir=`pwd`
	  elif test -d ../include/c++/v1
	  then
	    cd ../include/c++/v1
	    sys_cxx_incdir=`pwd`
	  else
	    echo "Unable to find libc++ headers relative to $sys_clang_path (from xcrun)."
	    exit 1
	  fi
	  popd
	  echo "Found system libc++ headers in: $sys_cxx_incdir"
	  sed -i.orig3 -e 's|AddPath("/usr/include/c++/v1"|AddPath("'"$sys_cxx_incdir"'"|' \
		tools/clang/lib/Frontend/InitHeaderSearch.cpp
	}

	# add experimental cmake support to openmp
	pushd ../openmp-%v.src
	  # $patch_filter %{PatchFile8} | patch -p1
	  sed -i.orig -e '/message-converter/s|--enum=|--enum-file=|' \
		-e '/message-converter/s|--default=|--default-file=|' \
		runtime/CMakeLists.txt
	  sed -i.orig -e "s|= gcc|= $build_root/last/bin/clang-3.6|g" testsuite/Makefile
	popd
	
# needed for gcc-fsf-4.x only
#	sed -i.orig2 -e 's|compatibility_version|dylib_&|' tools/clang/tools/libclang/CMakeLists.txt

	# projects/test-suite expects built llvm/clang to have been configured
	# but sadly, we used cmake; don't include $llvmobjdir/Makefile.config
	# TODO: replace cmake build with autoconf'd build
	# sed -i.orig -e 's|HAS_LLVM := 1|HAS_LLVM := 0|' projects/test-suite/Makefile.config.in
<<
CompileScript: <<
	#!/bin/sh -ev
	# define some variables so this script can be easily used outside fink
	build_arch=%m
	fink_root=%p
	version=%v
	# tarballs have mixed versions b/c some components did not change
	brv=3.6
	darwin_vers=`uname -r | cut -d. -f1`
	osx_version=`sw_vers -productVersion | cut -d. -f-2`
	llvm_abs_srcdir=%b
	test "$darwin_vers" -gt 8 || llvm_abs_srcdir="$llvm_abs_srcdir/llvm-%v.src"
	libcxx_abs_srcdir="$llvm_abs_srcdir/../libcxx-%v.src"
	libcxx_rel_srcdir=../../libcxx-%v.src
	build_root="$llvm_abs_srcdir/../build"
	relsrcdir=../../llvm-%v.src
	# LLVM_ENABLE_ASSERTIONS:OFF and LIBCXX_ENABLE_ASSERTIONS:OFF
	# for production compiler build
	enable_assertions=OFF

	# darwin8: manually unpacked xz
	test "$darwin_vers" -ge 9 || cd llvm-%v.src

	# Do not want -DNDEBUG, cause linker errors (undef symbols)
	# LLVM_ENABLE_ASSERTIONS:ON should have removed -DNDEBUG
	# but it doesn't, so hack it out of cmake file
	test "$enable_assertions" = OFF ||
		sed -i.orig -e '/-DNDEBUG/s|.*|#&|' cmake/modules/HandleLLVMOptions.cmake

	COMMON_CMAKE_OPTIONS=( -DBUILD_SHARED_LIBS:BOOL=ON \
		-DLLVM_LIT_ARGS:STRING=-v \
		-DPYTHON_EXECUTABLE:FILEPATH=$fink_root/bin/python2.7 )
	LLVM_CMAKE_OPTIONS=( -DLLVM_ENABLE_ASSERTIONS:BOOL=$enable_assertions )
	# test "$darwin_vers" -ge 10 ||
	LLVM_CMAKE_OPTIONS=( "${LLVM_CMAKE_OPTIONS[@]}" \
		-DCMAKE_OSX_SYSROOT:STRING=/ \
		-DCMAKE_OSX_DEPLOYMENT_TARGET:STRING= )

	# always build the native archs' backends
#	case "$build_arch" in
#	ppc*|powerpc*) TARGET_ARCHS="PowerPC" ;;
#	i386*|x86*) TARGET_ARCHS="X86" ;;
#	esac
	# enable cross-compiling to other archs:
	TARGET_ARCHS="X86;PowerPC;ARM"
	# TARGET_ARCHS="all"
	echo "Target option: $TARGET_ARCHS"
	LLVM_CMAKE_OPTIONS=( "${LLVM_CMAKE_OPTIONS[@]}" -DLLVM_TARGETS_TO_BUILD="$TARGET_ARCHS" )

	# automatically use ccache if detected
	# ccache recommended, but not required
	# comment-out the next line if ccache is not desired
	test -x $p/bin/ccache && CCACHE=ccache || CCACHE=
	export CCACHE
	echo "ccache: CCACHE=$CCACHE"

	wrap_compiler() {
	cat >$2 <<EOF
#!/bin/sh
exec \$CCACHE $1 "\$@"
EOF
	chmod +x $2
	}


	# set up some possible stage-1 compilers
	fsfgccv=4.9
	# wrap ccache into single cmd b/c cmake can't handle "ccache g++"
	mkdir ../opt-bin
	pushd ../opt-bin
	  case "$darwin_vers" in
	  8|9|10)
	    # fink-build from clang34
	    wrap_compiler %p/bin/clang-3.4 ccclang
	    wrap_compiler %p/bin/clang++-3.4 ccclang++
	    ;;
	  *)
	    wrap_compiler clang ccclang
	    wrap_compiler clang++ ccclang++
	    ;;
	  esac
	  wrap_compiler gcc-fsf-$fsfgccv ccgcc-$fsfgccv
	  wrap_compiler g++-fsf-$fsfgccv ccg++-$fsfgccv
	# also setup bootstrap stage compilers
	# yes, ccache 3.1 supports compiler binary hashing
	  for s in 1 2 3
	  do
	    wrap_compiler st$s-clang cc-st$s-clang
	    wrap_compiler st$s-clang++ cc-st$s-clang++
	  done
	  # force system make for testsuite to pass
	  # if you suspect fink-make (4.0?) is troublesome, uncomment:
	  # ln -s /usr/bin/make make
	  export PATH=`pwd`:$PATH
	popd

	# stage 1 compiler (try to use ccache if available)
	# gcc-4.0.1 FAILS on darwin9
	case "$darwin_vers" in
	8|9|10)
	# bootstrap with clang-3.4 and libcxx1-dev
	  export PATH=%p/opt/llvm-3.4/bin:$PATH
	  export CC=ccclang
	  export CXX=ccclang++
#	  export CC=ccgcc-$fsfgccv
#	  export CXX=ccg++-$fsfgccv
	  ;;
	*)
	  # use system clang
	  export CC=ccclang
	  export CXX=ccclang++
	  ;;
	esac

	clang_arch=$build_arch
	cxxabi_arch=$build_arch
	case "$build_arch" in
	powerpc) clang_arch=ppc ;;
	powerpc64) clang_arch=ppc64 ;;
	i386) cxxabi_arch=i686 ;;
	esac
	case "$clang_arch" in
	ppc) other_arch=ppc64 ;;
	ppc64) other_arch=ppc ;;
	i386) other_arch=x86_64 ;;
	x86_64) other_arch=i386 ;;
	esac
	# script to assemble/link in missing .S units into libclang_rt
	asm_link_clang_rt() {
		# $CC, $CCAS_FLAGS already set
		# $1 is $clang_arch or $other_arch
		arch=$1
		builddir=projects/compiler-rt/lib
		crtsrcdir=$llvm_abs_srcdir/projects/compiler-rt
		objdir=CMakeFiles/clang_rt.builtins-$arch.dir/$arch
		libdir=../../../lib/clang/$version/lib/darwin
		libcrt=$libdir/libclang_rt.builtins-$arch.a
		. $crtsrcdir/lib/link-asm-libclang_rt.sh
		assemble_clang_rt
	}
	# link both 32b and 64b builtin libs
	asm_link_clang_rts() {
		asm_link_clang_rt $clang_arch
		asm_link_clang_rt $other_arch
	}

	# need to fix llvm-config to not point to build-dir, but instead
	# where libc++ headers and libs will be installed.
	# This is needed because llvm3x-shlibs links to the built
	# libc++ in the bootstrap process.
	# Keep this path in sync with libcxx_install_dir elsewhere in this file.
	fix_llvm_config_build_variables() {
		sed -i.orig -e "/LLVM_CXXFLAGS/s|$llvm_abs_srcdir[^ ]*/include|%p/include/c++/v1|" \
			-e "/LLVM_LDFLAGS/s|$llvm_abs_srcdir[^ ]*/lib|%p/lib/c++|" \
			tools/llvm-config/BuildVariables.inc
	}

	build_type=Release
#	build_type=RelWithDebInfo
	# do not let cmake auto-detect OSX_SYSROOT
	LLVM_CMAKE_OPTIONS=( "${LLVM_CMAKE_OPTIONS[@]}" \
		-DCMAKE_INSTALL_PREFIX:PATH=$fink_root/opt/llvm-$brv \
		-DCMAKE_BUILD_TYPE:STRING=$build_type )

	# somehow, the choice of C++ library in stage 1 influences
	# the output of TableGen in stage 2, which makes a 4th stage
	# necessary to converge.  So select system libc++ over libstdc++
	# on darwin 11 and 12 to make bootstrap finish in 3 stages.
	# darwin13+ already default to using libc++.
	# darwin10- lack a system libc++ altogether,
	# but libcxx1-dev (3.4) provides it
	force_stage1_system_libcxx=0
	force_stage1_fink_libcxx=0
	case "$darwin_vers" in
	8|9|10) force_stage1_fink_libcxx=1 ;;
	11|12) force_stage1_system_libcxx=1 ;;
	esac
	if test "$force_stage1_system_libcxx" = 1
	then STAGE1_LIBCXX_FLAGS=( -std=c++11 -stdlib=libc++ )
	fi
	if test "$force_stage1_fink_libcxx" = 1
	then STAGE1_LIBCXX_FLAGS=( -std=c++11 -stdlib=libc++ -cxx-isystem %p/include/c++/v1 -L%p/lib/c++ -Qunused-arguments )
	  STAGE1_LD_FLAGS=( -L%p/lib/c++ )
	fi
	if test "$darwin_vers" -lt 9
	then STAGE1_AS_FLAGS=( -B%p/lib/odcctools/bin )
	  STAGE1_LD_FLAGS=("${STAGE1_LD_FLAGS[@]}" -B%p/lib/odcctools/bin )
	fi
	if test "$build_arch" = powerpc
	then STAGE1_AS_FLAGS=( "${STAGE1_AS_FLAGS[@]}" -no-integrated-as )
	fi

	case "$build_arch" in
	# PowerPC is not ready for -integrated-as yet
	powerpc*) int_as_flag="-no-integrated-as -B$cctools_path" ;;
	esac

	STAGE1_CXX_OPTIONS="-fno-common \
		${STAGE1_LIBCXX_FLAGS[@]} \
		${STAGE1_AS_FLAGS[@]}"
	STAGE1_LD_FLAGS="${STAGE1_LD_FLAGS[@]} ${LDFLAGS[@]}"
	STAGE1_CMAKE_OPTIONS=( -DCMAKE_C_FLAGS=-fno-common \
		-DCMAKE_CXX_FLAGS="$STAGE1_CXX_OPTIONS" \
		-DCMAKE_SHARED_LINKER_FLAGS="$STAGE1_LD_FLAGS" \
		-DCMAKE_MODULE_LINKER_FLAGS="$STAGE1_LD_FLAGS" \
		-DCMAKE_EXE_LINKER_FLAGS="$STAGE1_LD_FLAGS" )
	echo "STAGE1_CMAKE_OPTIONS = ${STAGE1_CMAKE_OPTIONS[@]}"

	echo "######## START of BOOTSTRAP STAGE 1: building llvm/clang with the system compiler"
	# wd: %b
	mkdir -p ../build/stage1
	pushd ../build/stage1
	echo "LLVM_CMAKE_OPTIONS = ${COMMON_CMAKE_OPTIONS[@]} ${LLVM_CMAKE_OPTIONS[@]} ${STAGE1_CMAKE_OPTIONS[@]}"
	# Technically, we only need the native back-end in stage 1...
	cmake "${COMMON_CMAKE_OPTIONS[@]}" "${LLVM_CMAKE_OPTIONS[@]}" "${STAGE1_CMAKE_OPTIONS[@]}" $relsrcdir
	# kill -DNDEBUG with fire
	sed -i.orig -e 's| -DNDEBUG||g' CMakeCache.txt
	# fix_llvm_config_build_variables # not needed b/c not using libc++ yet
	# first make fails, but we have to run it first and then fix some deps
	make -k || make -j1 VERBOSE=1
	asm_link_clang_rts
	make
	# tests hardcode the .dylib extension for modules
	pushd lib
	  ln -s BugpointPasses.{dylib,so}
	  ln -s LLVMPolly.{so,dylib}
	  ln -s LLVMHello.{dylib,so}
	popd
	cd ..
	ln -s stage1 last
	popd
	# wd: %b
	# link stage1 compilers into opt-bin for next stage
	pushd ../opt-bin
	  ln -s ../build/stage1/bin/clang st1-clang
	  ln -s ../build/stage1/bin/clang++ st1-clang++
	popd
	# wd: %b
	# create some empty test logs, which we may overwrite and install to docs
	for f in ../build/stage1/{llvm,clang,polly,compiler-rt,openmp}-$version-check.log
	do echo "Stage 1 Tests were not run." > $f
	done
	echo "######## END of BOOTSTRAP STAGE 1: built llvm/clang with the system compiler"

	# LDFLAGS influences cmake, aggregate and re-export
	FINK_LDFLAGS=( "$LDFLAGS" )
	# beyond stage1, use the following flags for both libc++ and llvm
	STAGE2_COMMON_LDFLAGS=()
	# darwin8: stage2+ needs odcctools for linking and -no-integrated-as
	cctools_path=$fink_root/lib/odcctools/bin
	if test $darwin_vers -le 8
	then STAGE2_COMMON_LDFLAGS=( "-B$cctools_path" )
	fi

	case "$build_arch" in
	# PowerPC is not ready for -integrated-as yet
	powerpc*) int_as_flag="-no-integrated-as -B$cctools_path" ;;
	esac

	echo "######## START of BOOTSTRAP STAGE 1.5: building libc++ with stage 1 clang++"
	export CCACHE_COMPILERCHECK=content
	export CC=cc-st1-clang
	export CXX=cc-st1-clang++
	LIBCXX_CMAKE_OPTIONS=( -DCMAKE_BUILD_TYPE:STRING=$build_type )
	if test $darwin_vers -le 10
	then flags="$int_as_flag -DDARWIN_LIBSUPCXX=$darwin_vers"
		abi=libsupc++
		if test -f /usr/include/c++/4.2.1/cxxabi.h
		then sys_cxxabi_root=/usr/include/c++/4.2.1
		elif test -f /usr/include/c++/4.0.0/cxxabi.h
		then sys_cxxabi_root=/usr/include/c++/4.0.0
		fi
		abi_includes="$sys_cxxabi_root;$sys_cxxabi_root/$cxxabi_arch-apple-darwin$darwin_vers"
		LIBCXX_CMAKE_OPTIONS=( "${LIBCXX_CMAKE_OPTIONS[@]}" \
			-DLIBCXX_LIBSUPCXX_INCLUDE_PATHS="$abi_includes" )
	else	abi=libcxxabi
		abi_includes=/usr/include
		LIBCXX_CMAKE_OPTIONS=( "${LIBCXX_CMAKE_OPTIONS[@]}" \
			-DLIBCXX_LIBCXXABI_INCLUDE_PATHS="$abi_includes" )
	fi
	# on x86 darwin10+, build FAT
	if test $darwin_vers -ge 10
	then flags="$flags -arch i386 -arch x86_64"
	fi
	LIBCXX_CMAKE_OPTIONS=( "${LIBCXX_CMAKE_OPTIONS[@]}" \
		-DCMAKE_INSTALL_PREFIX=$fink_root \
		-DLIBCXX_ENABLE_ASSERTIONS:BOOL=$enable_assertions \
		-DCMAKE_CXX_FLAGS="$flags" \
		-DLIBCXX_CXX_ABI="$abi" \
		-DLIT_EXECUTABLE=$build_root/last/bin/llvm-lit \
		-DCMAKE_OSX_DEPLOYMENT_TARGET:STRING=$osx_version \
		-DCMAKE_OSX_ARCHITECTURES="$clang_arch" )

	mkdir -p ../build/stage1.5
	pushd ../build/stage1.5
	echo "LLVM_CMAKE_OPTIONS = ${COMMON_CMAKE_OPTIONS[@]} ${LIBCXX_CMAKE_OPTIONS[@]}"
	export LDFLAGS="${STAGE2_COMMON_LDFLAGS[@]} ${FINK_LDFLAGS[@]}"
	echo "LDFLAGS = $LDFLAGS"
	cmake "${COMMON_CMAKE_OPTIONS[@]}" "${LIBCXX_CMAKE_OPTIONS[@]}" $libcxx_rel_srcdir
	make
	cd ..
	ln -s stage1.5 last-libcxx
	popd
	echo "Stage 1.5 Tests were not run." > ../build/stage1.5/libcxx-$version-check.log
	echo "######## END of BOOTSTRAP STAGE 1.5: built libc++ with stage 1 clang++"
	libcxx_stage_dir=$build_root/last-libcxx/lib

	# don't bootstrap on powerpc-darwinX until all codegen issues fixed
#	If you do not wish to bootstrap, change the following value to 0:
	do_bootstrap=1
	test "$build_arch" != "powerpc" || do_bootstrap=0
	test "$darwin_vers" != 8 || do_bootstrap=0

if test $do_bootstrap = 1
then

	echo "######## START of BOOTSTRAP STAGE 2: building llvm/clang with stage 1 clang"
	libcxx_srcdir="$libcxx_abs_srcdir/include"
# if not bootstrapping libc++, use system C++ library (buried in XCode)
#	if test "$darwin_vers" -ge 13
#	then
#		sys_clang_path=`xcrun -find clang`
#		sys_cxx_incdir=`dirname $sys_clang_path`/../lib/c++/v1
#		libcxx_srcdir="$sys_cxx_incdir"
#	fi
	stage23_cxx_flags="-std=c++11 -stdlib=libc++ -cxx-isystem $libcxx_srcdir"
	# reuse CC and CXX from stage 1.5
	STAGE2_LLVM_LDFLAGS=( "-L$libcxx_stage_dir" )
	STAGE2_CMAKE_OPTIONS=( \
		-DCMAKE_CXX_FLAGS="$stage23_cxx_flags $int_as_flag ${STAGE2_LLVM_LDFLAGS[@]}" )
	mkdir -p ../build/stage2
	pushd ../build/stage2
	echo "LLVM_CMAKE_OPTIONS = ${COMMON_CMAKE_OPTIONS[@]} ${LLVM_CMAKE_OPTIONS[@]} ${STAGE2_CMAKE_OPTIONS[@]}"
	export LDFLAGS="${STAGE2_COMMON_LDFLAGS[@]} ${STAGE2_LLVM_LDFLAGS[@]} ${FINK_LDFLAGS[@]}"
	echo "LDFLAGS = $LDFLAGS"
	cmake "${COMMON_CMAKE_OPTIONS[@]}" "${LLVM_CMAKE_OPTIONS[@]}" "${STAGE2_CMAKE_OPTIONS[@]}" $relsrcdir
	fix_llvm_config_build_variables
	make -k || make VERBOSE=1
	export CCAS_FLAGS="$int_as_flag" ; asm_link_clang_rts
	make
	pushd lib
	  ln -s BugpointPasses.{dylib,so}
	  ln -s LLVMPolly.{so,dylib}
	  ln -s LLVMHello.{dylib,so}
	popd
	cd ..
	rm -f last
	ln -s stage2 last
	popd
	# wd: %b
	pushd ../opt-bin
	  ln -s ../build/stage2/bin/clang st2-clang
	  ln -s ../build/stage2/bin/clang++ st2-clang++
	popd
	# wd: %b
	for f in ../build/stage2/{llvm,clang,polly,compiler-rt,openmp}-$version-check.log
	do echo "Stage 2 Tests were not run." > $f
	done
	echo "######## END of BOOTSTRAP STAGE 2: built llvm/clang with stage 1 clang"

	echo "######## START of BOOTSTRAP STAGE 2.5: building libc++ with stage 2 clang++"
	export CC=cc-st2-clang
	export CXX=cc-st2-clang++
	export CCACHE_DISABLE=1
	mkdir -p ../build/stage2.5
	pushd ../build/stage2.5
	# use same flags as stage1.5
	echo "LLVM_CMAKE_OPTIONS = ${COMMON_CMAKE_OPTIONS[@]} ${LIBCXX_CMAKE_OPTIONS[@]}"
	export LDFLAGS="${STAGE2_COMMON_LDFLAGS[@]} ${FINK_LDFLAGS[@]}"
	echo "LDFLAGS = $LDFLAGS"
	cmake "${COMMON_CMAKE_OPTIONS[@]}" "${LIBCXX_CMAKE_OPTIONS[@]}" $libcxx_rel_srcdir
	make
	# link over to stage1 so built clang can use this
	cd ..
	rm -f last-libcxx
	ln -s stage2.5 last-libcxx
	popd
	echo "Stage 2.5 Tests were not run." > ../build/stage2.5/libcxx-$version-check.log
	echo "######## END of BOOTSTRAP STAGE 2.5: built libc++ with stage 2 clang++"
	# below, object compare stage 1.5 vs. 2.5

	echo "######## START of BOOTSTRAP STAGE 3: building llvm/clang with stage 2 clang"
	# reuse CC and CXX from stage 2.5
	# yes, reuse STAGE2_CMAKE_OPTIONS in stage 3
	mkdir -p ../build/stage3
	pushd ../build/stage3
	echo "LLVM_CMAKE_OPTIONS = ${COMMON_CMAKE_OPTIONS[@]} ${LLVM_CMAKE_OPTIONS[@]} ${STAGE2_CMAKE_OPTIONS[@]}"
	export LDFLAGS="${STAGE2_COMMON_LDFLAGS[@]} ${STAGE2_LLVM_LDFLAGS[@]} ${FINK_LDFLAGS[@]}"
	echo "LDFLAGS = $LDFLAGS"
	cmake "${COMMON_CMAKE_OPTIONS[@]}" "${LLVM_CMAKE_OPTIONS[@]}" "${STAGE2_CMAKE_OPTIONS[@]}" $relsrcdir
	fix_llvm_config_build_variables
	make -k || make VERBOSE=1
	export CCAS_FLAGS="$int_as_flag" ; asm_link_clang_rts
	make
	pushd lib
	  ln -s BugpointPasses.{dylib,so}
	  ln -s LLVMPolly.{so,dylib}
	  ln -s LLVMHello.{dylib,so}
	popd
	cd ..
	rm -f last
	ln -s stage3 last
	popd
	# wd: %b
	pushd ../opt-bin
	  ln -s ../build/stage3/bin/clang st3-clang
	  ln -s ../build/stage3/bin/clang++ st3-clang++
	popd
	# wd: %b
	for f in ../build/stage3/{llvm,clang,polly,compiler-rt,openmp}-$version-check.log
	do echo "Stage 3 Tests were not run." > $f
	done
	echo "######## END of BOOTSTRAP STAGE 3: built llvm/clang with stage 2 clang"

# bootstrap comparison routines
	diff_size() {
	# return 1 if non-zero diffs
	if test -s "$1" ; then echo "    $1 contains differences" ; return 1; fi
	}

	resolve_path_diffs() {
	# replace path strings between compared files and recheck diffs
	# $1 - file1
	# $2 - file2
	# $3 - substr to match
	# $4 - substr replacement
	# return exit status of last diff
	  sed -e "s|$3|$4|g" "$1" | tee $1.repl | diff -u - $2 > $2.repl-diff || :
	  diff_size $2.repl-diff && echo "    differences resolved."
	}

	resolve_obj_diffs() {
	# analyzes results in a 'compare' directory
	# $1 - dir1
	# $2 - dir2
	# $3 - common object file (.o)
	# return 1 if differences remain unresolved
	reserr=0
	set +o verbose
	mkdir -p `dirname compare/$f`
	b1=`echo $1 | cut -d/ -f1`
	b2=`echo $2 | cut -d/ -f1`
	set -o verbose
	# sequence of examinations
	# nm symbol list
	  nm -p $b1/$f | sed 1d > compare/$f.nm.1
	  nm -p $b2/$f | sed 1d > compare/$f.nm.2
	  diff -u compare/$f.nm.{1,2} > compare/$f.nm.diff ||
	  diff_size compare/$f.nm.diff ||
	  { echo "    Unresolved nm diffs." ; reserr=1 ;}
	# strings
	  strings $b1/$f > compare/$f.str.1
	  strings $b2/$f > compare/$f.str.2
	  diff -u compare/$f.str.{1,2} > compare/$f.str.diff ||
	  diff_size compare/$f.str.diff ||
	  resolve_path_diffs compare/$f.str.{1,2} $1 $2 ||
	  { echo "    Unresolved string diffs." ; reserr=1 ;}
	# disassemble
	  otool -tV $b1/$f | sed 1d > compare/$f.dis.1
	  otool -tV $b2/$f | sed 1d > compare/$f.dis.2
	  diff -u compare/$f.dis.{1,2} > compare/$f.dis.diff ||
	  diff_size compare/$f.dis.diff ||
	  resolve_path_diffs compare/$f.dis.{1,2} $1 $2 ||
	  { echo "    Unresolved disasm diffs." ; reserr=1 ;}
	return "$reserr"
	}

	diff_obj_dir_r () {
	# recursively descend directories in parallel
	# accumulate diffs in array
	# $1 is reference dir
	# $2 is target dir
	# return diffs in array (appended)
	for f in $2/*
	do
	  o=`basename $f`
	  if test -d $f
	  then diff_obj_dir_r $1/$o $f
	  else
	    r=`echo "$f" | cut -d/ -f2-`
	    case $f in
	    *.s.tmp.o) ;;
	    *.o|*.inc|*.h)
	      if test -f $1/$o
	      then diff -q $1/$o $f && echo "matches: $r" || diffs=("${diffs[@]}" $r)
	      fi ;;
	    esac
	  fi
	done
	}

	diff_obj_dir () {
	set +o verbose
	diff_obj_dir_r $1 $2
	set -o verbose
	}

	# pwd: %b
	pushd ../build
	  echo "######## Comparing objects from stage 1.5 vs. 2.5 libc++"
	  diffs=()
	  diff_obj_dir stage{1,2}.5
	  do_stage35=0
	  for f in "${diffs[@]}"
	  do echo "  $f -- not OK" ; do_stage35=1
	  done
	  # don't bother analyzing diffs
	popd

	export CC=cc-st3-clang
	export CXX=cc-st3-clang++
	export CCACHE_DISABLE=1
if test "$do_stage35" = 1
then
	echo "######## START of BOOTSTRAP STAGE 3.5: building libc++ with stage 2 clang++"
	mkdir -p ../build/stage3.5
	pushd ../build/stage3.5
	# use same flags as stage1.5
	echo "LLVM_CMAKE_OPTIONS = ${COMMON_CMAKE_OPTIONS[@]} ${LIBCXX_CMAKE_OPTIONS[@]}"
	export LDFLAGS="${STAGE2_COMMON_LDFLAGS[@]} ${FINK_LDFLAGS[@]}"
	echo "LDFLAGS = $LDFLAGS"
	cmake "${COMMON_CMAKE_OPTIONS[@]}" "${LIBCXX_CMAKE_OPTIONS[@]}" $libcxx_rel_srcdir
	make
	# link over to stage1 so built clang can use this
	cd ..
	rm -f last-libcxx
	ln -s stage3.5 last-libcxx
	popd
	echo "Stage 3.5 Tests were not run." > ../build/stage3.5/libcxx-$version-check.log
	echo "######## END of BOOTSTRAP STAGE 3.5: built libc++ with stage 3 clang++"
	pushd ../build
	  echo "######## Comparing objects from stage 2.5 vs. 3.5 libc++"
	  diffs=()
	  diff_obj_dir stage{2,3}.5
	  libcxx_err=0
	  for f in "${diffs[@]}"
	  do echo "  $f -- not OK" ; libcxx_err=1
	  done
	  # don't bother analyzing diffs
	popd
	test "$libcxx_err" = 0
else
	# libc++ already converged, no need to recompile it
	echo "######## Re-using STAGE 2.5 libc++ as STAGE 3.5"
	pushd ../build
	  ln -s stage{2,3}.5
	  rm -f last-libcxx
	  ln -s stage3.5 last-libcxx
	popd
fi

	llvm_stage_diff () {
	# compare stage N to N+1, analyzed results in 'compare' dir
	# $1 - dir1
	# $2 - dir2
	# return 1 if there are unresolved_diffs(), accumulated
	diffs=()
	diff_obj_dir $1 $2
	unresolved_diffs=()
	err=0
	echo "Objects that differ ($1 vs. $2):"
	for f in "${diffs[@]}"
	do echo "  examining: $f"
	  loc_err=0
	  mkdir -p `dirname compare/$f`
	  case $f in
	  *.inc|*.h|*.gen) diff -u {$1,$2}/$f > compare/$f.diff ||
	    diff_size compare/$f.diff ||
	    resolve_path_diffs {$1,$2}/$f $1 $2 || loc_err=1 ;;
	  tools/llvm-config/CMakeFiles/llvm-config.dir/llvm-config.cpp.o)
	    echo "  $f -- OK: asm sensitive to \$builddir" ;;
	  lib/Support/CMakeFiles/LLVMSupport.dir/CommandLine.cpp.o)
	    echo "  $f -- OK: __DATE__, __TIME__ cpp macros in strings" ;;
	  *.o) resolve_obj_diffs $1 $2 $f || loc_err=1 ;;
	  esac
	  test "$loc_err" = 0 || err=1 && unresolved_diffs=("${unresolved_diffs[@]}" $f)
	done
	if test "$err" = 1
	then echo "UNRESOLVED DIFFS ($1 vs. $2):"
	  for f in "${unresolved_diffs[@]}"
	  do echo "  $f"
	  done
	  return $err
	fi
	}

	pushd ../build
	  echo "######## Comparing objects from stage 2 vs. 3 of LLVM/Clang"
	  do_stage4=0
	  llvm_stage_diff stage{2,3} || do_stage4=1
	  mv compare{,2v3}
	popd

if test "$do_stage4" != 1
then echo "######## 3-STAGE BOOTSTRAP of llvm/clang PASSED"
else
	echo "######## 3-STAGE BOOTSTRAP of llvm/clang FAILED"
	if test "$darwin_vers" -ge 11
	then exit 1
	fi
	# on darwin10-, allow 4th stage as workaround due to switching
	# library from libstdc++ (stage 1) to libc++ (stage 2)
	echo "######## START of BOOTSTRAP STAGE 4: building llvm/clang with stage 3 clang"
	# reuse CC and CXX from stage 3.5
	# yes, reuse STAGE2_CMAKE_OPTIONS in stage 4
	mkdir -p ../build/stage4
	pushd ../build/stage4
	echo "LLVM_CMAKE_OPTIONS = ${COMMON_CMAKE_OPTIONS[@]} ${LLVM_CMAKE_OPTIONS[@]} ${STAGE2_CMAKE_OPTIONS[@]}"
	export LDFLAGS="${STAGE2_COMMON_LDFLAGS[@]} ${STAGE2_LLVM_LDFLAGS[@]} ${FINK_LDFLAGS[@]}"
	echo "LDFLAGS = $LDFLAGS"
	cmake "${COMMON_CMAKE_OPTIONS[@]}" "${LLVM_CMAKE_OPTIONS[@]}" "${STAGE2_CMAKE_OPTIONS[@]}" $relsrcdir
	fix_llvm_config_build_variables
	make -k || make VERBOSE=1
	export CCAS_FLAGS="$int_as_flag" ; asm_link_clang_rts
	make
	pushd lib
	  ln -s BugpointPasses.{dylib,so}
	  ln -s LLVMPolly.{so,dylib}
	  ln -s LLVMHello.{dylib,so}
	popd
	cd ..
	rm -f last
	ln -s stage4 last
	popd
	# wd: %b
	for f in ../build/stage4/{llvm,clang,polly,compiler-rt,openmp}-$version-check.log
	do echo "Stage 4 Tests were not run." > $f
	done
	echo "######## END of BOOTSTRAP STAGE 4: built llvm/clang with stage 3 clang"
	pushd ../build
	  echo "######## Comparing objects from stage 3 vs. 4 of LLVM/Clang"
	  rejoice=1
	  llvm_stage_diff stage{3,4} || rejoice=0
	  mv compare{,3v4}
	popd
	if test "$rejoice" = 1
	then echo "######## 4-STAGE BOOTSTRAP of llvm/clang PASSED"
	else echo "######## 4-STAGE BOOTSTRAP of llvm/clang FAILED" ; exit 1
	fi
# $do_stage4 != 1
fi
# $do_bootstrap = 1
fi

# symlinks for unittests so that @loader_path/../lib finds dependent libraries
	if test "$darwin_vers" -le 8
	then
	  pushd unittests
	  for d in `find . -type d | grep "/" | grep -v CMake | sed 's|^\./||'`
	  do
	    p=`echo $d | sed -e 's|[A-Za-z]*|..|g'`
	    echo "linking to 'lib' in $d/.."
	    pushd $d/.. && ln -s -f $p/lib . && popd
	  done
	  popd
	fi

# after clang is built, bootstrapped or not, build clang-openmp
	build_clang_omp=0
	# build_clang_omp=1
	case "%m" in
	powerpc) build_clang_omp=0 ;;
	powerpc64) build_clang_omp=0 ;;
	esac
	if test "$build_clang_omp" = 1
	then
	pushd ../build/last/bin
	  export PATH=`pwd`:$PATH
	popd
	pushd ../openmp-%v.src/runtime
	  mkdir build
	  pushd build
	    for a in 32 32e
	    do
	      CC=clang CXX=clang++ cmake -Dos=mac -Darch=$a ..
	      rm -f CMakeFiles/iomp5.dir/src/*.o *.dylib
	      make
	    done
	    make fat
	    # install to build dir first
	    install -m 755 ../exports/mac_32e/lib/libiomp5.dylib "$build_root/last/lib"
	    install -m 644 omp.h "$build_root/last/lib/clang/%v/include"
	  popd
	popd
	fi
<<
InfoTest: <<
# need bash because /bin/sh 2.0 on darwin8 is missing support for pipefail
# coreutils for gtimeout for tests, see %N.patch:utils/lit/lit/TestRunner.py
	TestDepends: <<
		# darwin8 needs fink's bash for pipefail
		# others need fink's bash for operability with python2.7 subprocess
		bash (>= 4.3),
		# bash 3.2 was good enough on darwin8
		# bash 4.2 was good enough on darwin9-12
		# bash 4.3 good enough on darwin13
		coreutils
	<<
	TestScript: <<
	#!/bin/sh -ev
	darwin_vers=`uname -r | cut -d. -f1`

	# test suite requires newer bash than /bin/bash 2.0 for pipefail
	# test the pipefail option of this shell first
	set -o pipefail || {
	sed -i.orig -e "/bashPath = None/s|None|'%p/bin/bash'|" utils/lit/lit/LitConfig.py
	test -x %p/bin/bash || { echo "Error: Fink-built bash >= 3.0 required for pipefail!" ; exit 1; }
	}

	# need path to bootstrapping compiler, and 'make' link
	pushd ../opt-bin
	  export PATH=`pwd`:$PATH
	popd
	cd ../build/last

#	echo "******** Running included LLVM and clang tests ... ********"
#	{ make -k TESTARGS=-v check-all 2>&1 || : ;} | tee llvm-clang-%v-check.log

	echo "******** Running included LLVM tests ... ********"
	{ make -k TESTARGS=-v check 2>&1 || : ;} | tee llvm-%v-check.log

	echo "******** Running included clang tests ... ********"
	{ make -k TESTARGS=-v check-clang 2>&1 || : ;} | tee clang-%v-check.log

	echo "******** Running included polly tests ... ********"
	( cd tools/polly/test ; make -k TESTARGS=-v polly-test 2>&1 || : ;) | tee polly-%v-check.log

	echo "******** Running included compiler-rt/libclang_rt tests ... ********"
	CC=`grep "CMAKE_C_COMPILER:FILEPATH" CMakeCache.txt | cut -d= -f2`
	( mkdir -p projects/compiler-rt/test
	cd projects/compiler-rt/test
	syslib="-lSystem"
	clang_arch=%m
	case "%m" in
	powerpc) clang_arch=ppc ;;
	powerpc64) clang_arch=ppc64 ;;
	esac
	test $darwin_vers -gt 10 || syslib="$syslib -lSystemStubs"
	cat >Makefile.custom <<EOF
ARCH = $clang_arch
OS = darwin
CC = $CC
LIBS = $syslib
LLVM_SRCDIR = %b
VERSION = %v
include \$(LLVM_SRCDIR)/projects/compiler-rt/test/builtins/Unit/test.mk
EOF
	make -k && make -f Makefile.custom check 2>&1 || : ;) | tee compiler-rt-%v-check.log

	echo "******** Running included libc++ tests ... ********"
	pushd ../last-libcxx
	  ( case $darwin_vers in
	    # we built FAT, but must test each arch separately
	    # TODO: double-test on darwin11+
	    10) sed -e '/cxx_flags/s| -arch x86_64||' test/lit.site.cfg > test/lit.site.cfg.32
	      sed -e '/cxx_flags/s| -arch i386||' test/lit.site.cfg > test/lit.site.cfg.64
	      echo "******** Checking -arch i386 (32b):"
	      mv test/lit.site.cfg{,.orig}
	      cp -f test/lit.site.cfg{.32,}
	      make -k check-libcxx || :
	      echo "******** Checking -arch x86_64 (64b):"
	      cp -f test/lit.site.cfg{.64,}
	      make -k check-libcxx || : ;;
	    # everything else: check single arch
	    *) make -k check-libcxx || : ;;
	    esac
	  ) 2>&1 | tee libcxx-%v-check.log
	popd

# pwd: ../build/last
	echo "******** Running included openmp tests ... ********"
# test clang-openmp
	build_clang_omp=0
	# build_clang_omp=1
	case "%m" in
	powerpc) build_clang_omp=0 ;;
	powerpc64) build_clang_omp=0 ;;
	esac
	if test "$build_clang_omp" = 1
	then
	( pushd %b/../openmp-%v.src/testsuite
	  export LIBRARY_PATH="%b/../build/last/lib:%p/lib"
	  export DYLD_LIBRARY_PATH="%b/../build/last/lib:%p/lib"
	  export C_INCLUDE_PATH="%b/../build/last/lib/clang/%v/include:%p/include:/usr/include"
	  # manually prune the ld warnings
	  make -j1 -k ctest 2>&1 | grep -v "ld: warning: directory not found for option '-L%p/opt/llvm-3.6/lib" || :
	popd
	) 2>&1 | tee openmp-%v-check.log
	fi

#	echo "******** Running massive test-suite ... ********"
#	( cd projects/test-suite ; make -k 2>&1 || : ;) | tee test-suite-%v-check.log
	<<
	TestSuiteSize: medium
<<
InstallScript: <<
	#!/bin/sh -ev
	darwin_vers=`uname -r | cut -d. -f1`
	# darwin8: manually unpacked xz
	test "$darwin_vers" -ge 9 || cd llvm-%v.src

	# "brv" = branch version, 3.6
	brv=3.6
	# optional: de-rpath shared library dependencies
	de_rpath_deps=1

	# need 'make' link
	pushd ../opt-bin
	  export PATH=`pwd`:$PATH
	popd
	pushd ../build/last
	  make -j1 install/fast DESTDIR="%d"
	  # install most recent stage libc++
	  cd ../last-libcxx
	  make install DESTDIR="%d"
	popd
	# there seems to be an extraneous include/c++/v1/c++/v1 dir
	pushd %i/include/c++/v1/
	  rm -rf c++ CMakeFiles
	  rm -f cmake* Makefile
	popd
# push libc++ libraries down a directory so they will not be found by default
# by user nor fink.  Force user to opt-in via -L%p/lib/c++.
# By default, clang++ will use system's libc++.
	libcxx_install_dir=%p/lib/c++
	pushd %i/lib
	  mkdir c++
	  mv libc++* c++/
	  # fix install_name below
	popd
	# there seems to be an extra copy of cxxabi.h, identical to system's
	# remove if identical?

	# boilerplate script for fixing post-cmake-install install_names
	# expect to find in lib/
	# libc++ will be in %p/lib and %p/include/c++/v1
	for stem in opt/llvm-$brv lib/c++
	do
	  iprefix=%i/$stem
	  prefix=%p/$stem
	  pushd $iprefix
	  for f in `find . -name '*.dylib'` `find . -name '*.so'`
	  do
		if test ! -L $f
		then
		dir=`dirname $f | sed -e 's|^\.\/||'`
		b=`basename $f`
		pushd $dir 2> /dev/null
		if test "$dir" = "."
		then iname="$prefix/$b"
		else iname="$prefix/$dir/$b"
		fi
		install_name_tool -id "$iname" "$b"
		case $f in
		*.dylib) filt="sed 1,2d" ;;
		*.so) filt="sed 1d" ;;
		esac
		deplibs=`otool -L $b | $filt | awk '{print $1;}' | tr '\n' ' '`
		for d in $deplibs
		do
		  # prefix absolute paths to llvm/clang's lib installation
		  # caution: assumes dependent libraries are in same dir
		  db=`basename $d`
		  case $d in
	  # NOTE: libc++ shared library lives in different prefix!
		  *stage*/lib/libc++*)
		    install_name_tool -change "$d" "$libcxx_install_dir/libc++.1.0.dylib" $b ;;
		  /*) ;;
		  @rpath/*) test $de_rpath_deps = 0 ||
		    install_name_tool -change "@rpath/$db" "$prefix/lib/$db" $b ;;
		  @loader_path/*) test $de_rpath_deps = 0 ||
		    install_name_tool -change "@loader_path/../lib/$db" "$prefix/lib/$d" $b ;;
		  *) install_name_tool -change "$d" "$prefix/lib/$d" $b ;;
		  esac
		done
		popd 2> /dev/null
		fi
	  done
	  popd
	done
	# for binaries and plug-in modules
	for stem in opt/llvm-$brv
	do
	  iprefix=%i/$stem
	  prefix=%p/$stem
	  pushd $iprefix/bin
	  for f in *
	  do
		if test ! -L $f
		then
		# check that executable is binary, not script/text
		ft=`file $f | cut -d: -f2-`
		if echo "$ft" | grep Mach-O
		then
		# darwin10 cctools introduced install_name -delete_rpath
		test $de_rpath_deps = 0 || test $darwin_vers -lt 10 ||
		  install_name_tool -delete_rpath "@executable_path/../lib" $f
		deplibs=`otool -L $f | sed 1d | awk '{print $1;}' | tr '\n' ' '`
		for d in $deplibs
		do
		  db=`basename $d`
		  # consider substituting with relative @executable_path/../lib ?
		  case $d in
	# NOTE: libc++ shared library lives in different prefix!
		  *stage*/lib/libc++*)
		    install_name_tool -change "$d" "$libcxx_install_dir/libc++.1.0.dylib" $f ;;
		  /*) ;;
		# de-rpath libs
		  @rpath/*) test $de_rpath_deps = 0 ||
		    install_name_tool -change "@rpath/$db" "$prefix/lib/$db" $f ;;
		  @loader_path/*) test $de_rpath_deps = 0 ||
		    install_name_tool -change "@loader_path/../lib/$db" "$prefix/lib/$d" $f ;;
		  *) install_name_tool -change "$d" "$prefix/lib/$d" $f ;;
		  esac
		done
		fi
		fi
	  done
	  popd
	done

	stem=opt/llvm-$brv
	iprefix=%i/$stem
	prefix=%p/$stem

	# clang-openmp
	build_clang_omp=0
	# build_clang_omp=1
	case "%m" in
	powerpc) build_clang_omp=0 ;;
	powerpc64) build_clang_omp=0 ;;
	esac
	if test "$build_clang_omp" = 1
	then
	install -m 755 %b/../build/last/lib/libiomp5.dylib $iprefix/lib
	install_name_tool -id "$prefix/lib/libiomp5.dylib" "$iprefix/lib/libiomp5.dylib"
	install -m 644 %b/../build/last/lib/clang/%v/include/omp.h $iprefix/lib/clang/%v/include
	fi

	# need symlink /usr/bin/ld so libLTO.dylib can be found relative to @executable_path
	pushd $iprefix/bin
		test -x /usr/bin/ld && ln -s /usr/bin/ld .
	popd

# convenient clang symlinks
	mkdir -p %i/bin
	pushd %i/bin
	  ln -s $prefix/bin/clang clang-$brv
	  ln -s $prefix/bin/clang++ clang++-$brv
	popd

# don't symlink libc++'s include/lib to clang's directories
# but rather require user to opt-in to use built libc++ over system's

	# documentation
	# pwd: llvm srcdir
	docdir=$prefix/share/doc
	idocdir=$iprefix/share/doc
	mkdir -p $idocdir
	cp -R docs $idocdir/llvm
	cp -R tools/clang/docs $idocdir/clang
	cp -R tools/clang/www $idocdir/clang-html
	cp -R tools/polly/www $idocdir/polly-html
	mkdir -p $idocdir/%n
	pushd $idocdir/%n
		mkdir testlogs
		cp %b/../build/last/*-check.log testlogs/
		cp %b/../build/last-libcxx/*-check.log testlogs/
	popd
<<
SplitOff: <<
	Package: clang36-tools
	Depends: clang36-shlibs (= %v-%r)
	Description: Extra tools for clang, such as formatting
	Files: <<
		opt/llvm-3.6/bin/*clang-format*
		opt/llvm-3.6/share/clang
	<<
<<
SplitOff2: <<
	Package: clang36-docs
	Description: Documenation for clang and related tools
	Files: <<
		opt/llvm-3.6/share/doc/clang
		opt/llvm-3.6/share/doc/clang-html
		opt/llvm-3.6/share/doc/%N/testlogs/clang-%v-check.log
		opt/llvm-3.6/share/doc/%N/testlogs/openmp-%v-check.log
		opt/llvm-3.6/share/doc/%N/testlogs/compiler-rt-%v-check.log
	<<
<<
SplitOff4: <<
	Package: clang36-dev
	BuildDependsOnly: true
	Depends: clang36-shlibs (= %v-%r)
	Description: Development headers for clang API
	Files: <<
		opt/llvm-3.6/include/clang
		opt/llvm-3.6/include/clang-c
		opt/llvm-3.6/lib/libclang.dylib
	<<
<<
SplitOff5: <<
	Package: clang36-shlibs
	Depends: %N-shlibs (= %v-%r)
	Description: Shared libraries for clang compiler
	Files: <<
		opt/llvm-3.6/lib/libclang*
		opt/llvm-3.6/lib/clang/%v/lib
	<<
	DocFiles: <<
		tools/clang/*.TXT
		tools/clang/INSTALL.txt
		tools/clang/ModuleInfo.txt
		tools/clang/NOTES.txt
		tools/clang/README.txt
	<<
	Shlibs: <<
	 	%p/opt/llvm-3.6/lib/libclang.3.6.dylib 1.0.0 %n (>= 3.6.0-0)
		!%p/opt/llvm-3.6/lib/libclangAnalysis.dylib
		!%p/opt/llvm-3.6/lib/libclangARCMigrate.dylib
		!%p/opt/llvm-3.6/lib/libclangAST.dylib
		!%p/opt/llvm-3.6/lib/libclangASTMatchers.dylib
		!%p/opt/llvm-3.6/lib/libclangBasic.dylib
		!%p/opt/llvm-3.6/lib/libclangCodeGen.dylib
		!%p/opt/llvm-3.6/lib/libclangDriver.dylib
		!%p/opt/llvm-3.6/lib/libclangDynamicASTMatchers.dylib
		!%p/opt/llvm-3.6/lib/libclangEdit.dylib
		!%p/opt/llvm-3.6/lib/libclangFormat.dylib
		!%p/opt/llvm-3.6/lib/libclangFrontend.dylib
		!%p/opt/llvm-3.6/lib/libclangFrontendTool.dylib
		!%p/opt/llvm-3.6/lib/libclangIndex.dylib
		!%p/opt/llvm-3.6/lib/libclangLex.dylib
		!%p/opt/llvm-3.6/lib/libclangParse.dylib
		!%p/opt/llvm-3.6/lib/libclangRewrite.dylib
		!%p/opt/llvm-3.6/lib/libclangRewriteFrontend.dylib
		!%p/opt/llvm-3.6/lib/libclangSema.dylib
		!%p/opt/llvm-3.6/lib/libclangSerialization.dylib
		!%p/opt/llvm-3.6/lib/libclangStaticAnalyzerCheckers.dylib
		!%p/opt/llvm-3.6/lib/libclangStaticAnalyzerCore.dylib
		!%p/opt/llvm-3.6/lib/libclangStaticAnalyzerFrontend.dylib
		!%p/opt/llvm-3.6/lib/libclangTooling.dylib
		!%p/opt/llvm-3.6/lib/libclangToolingCore.dylib
		!%p/opt/llvm-3.6/lib/clang/%v/lib/darwin/libclang_rt.asan_osx_dynamic.dylib
		!%p/opt/llvm-3.6/lib/clang/%v/lib/darwin/libclang_rt.asan_iossim_dynamic.dylib
	<<
<<
SplitOff6: <<
	Package: clang36
	Depends: <<
	# only darwin8 needs odcctools
	#	odcctools,
	# choosing to require opt-in instead of defaulting to libcxx1-dev
	#	libcxx1-dev,
		clang36-shlibs (= %v-%r),
		polly36-shlibs (= %v-%r)
	<<
	Description: Executables and runtime for clang compiler
	BuildDependsOnly: false
	Files: <<
		bin/clang*
		opt/llvm-3.6/bin/clang*
		opt/llvm-3.6/bin/ld
		opt/llvm-3.6/lib/clang
	<<
	DescUsage: <<
	To use clang/clang++, point your PATH to %p/opt/llvm-3.6/bin.
	clang++ uses the system C++ library by default.
	To use libcxx1-dev, pass "-cxx-isystem %p/include/c++/v1"
	and -L%p/lib/c++.
	<<
<<
SplitOff7: <<
	Package: polly36-docs
	Description: Documentation for Polly optimizer
	Files: <<
		opt/llvm-3.6/share/doc/polly-html
		opt/llvm-3.6/share/doc/%N/testlogs/polly-%v-check.log
	<<
<<
SplitOff8: <<
	Package: polly36-dev
	Depends: polly36-shlibs (= %v-%r)
	BuildDependsOnly: true
	Description: Development headers for Polly loop optimizer
	Files: <<
		opt/llvm-3.6/include/polly
	<<
<<
SplitOff9: <<
	Package: polly36-shlibs
	Description: Shared libraries for Polly loop optimizer
	Depends: <<
		%N-shlibs (= %v-%r),
		isl2-shlibs (>= 0.14), 
	#	cloog-org2-shlibs (>= 0.18),
		libgmpxx5-shlibs,
		gmp5-shlibs
	<<
	Files: <<
		opt/llvm-3.6/lib/LLVMPolly.so
		opt/llvm-3.6/lib/libPolly*.dylib
	<<
	DocFiles: tools/polly/LICENSE.txt tools/polly/CREDITS.txt
	Shlibs: <<
		!%p/opt/llvm-3.6/lib/LLVMPolly.so
		!%p/opt/llvm-3.6/lib/libPolly.dylib
	<<
<<
SplitOff10: <<
	Package: %N-docs
	Description: Documentation for LLVM tools and internals
	Files: <<
		opt/llvm-3.6/share/doc/llvm
		opt/llvm-3.6/share/doc/%N/testlogs/llvm-%v-check.log
	<<
<<
SplitOff11: <<
	Package: %N-dev
	Depends: %N-shlibs (= %v-%r)
	BuildDependsOnly: true
	Description: Developement headers for LLVM infrastructure
	Files: <<
		opt/llvm-3.6/include/llvm
		opt/llvm-3.6/include/llvm-c
		opt/llvm-3.6/share/llvm
	<<
<<
SplitOff12: <<
	Package: %N-shlibs
	Description: Shared libraries for LLVM infrastructure
	Depends: <<
	# only darwin10+ bootstraps with built libc++
		libcxx1-shlibs (>= %v-%r),
		libncurses5-shlibs
	<<
	Files: <<
		opt/llvm-3.6/lib/BugpointPasses.dylib
		opt/llvm-3.6/lib/LLVMHello.dylib
		opt/llvm-3.6/lib/libLLVM*.dylib
		opt/llvm-3.6/lib/libLTO.dylib
		opt/llvm-3.6/lib/libgtest*.dylib
	<<
	DocFiles: *.TXT README.txt
	Shlibs: <<
		!%p/opt/llvm-3.6/lib/libLTO.dylib
		!%p/opt/llvm-3.6/lib/BugpointPasses.dylib
		!%p/opt/llvm-3.6/lib/LLVMHello.dylib
		!%p/opt/llvm-3.6/lib/libLLVMARMAsmParser.dylib
		!%p/opt/llvm-3.6/lib/libLLVMARMAsmPrinter.dylib
		!%p/opt/llvm-3.6/lib/libLLVMARMCodeGen.dylib
		!%p/opt/llvm-3.6/lib/libLLVMARMDesc.dylib
		!%p/opt/llvm-3.6/lib/libLLVMARMDisassembler.dylib
		!%p/opt/llvm-3.6/lib/libLLVMARMInfo.dylib
		!%p/opt/llvm-3.6/lib/libLLVMAnalysis.dylib
		!%p/opt/llvm-3.6/lib/libLLVMAsmParser.dylib
		!%p/opt/llvm-3.6/lib/libLLVMAsmPrinter.dylib
		!%p/opt/llvm-3.6/lib/libLLVMBitReader.dylib
		!%p/opt/llvm-3.6/lib/libLLVMBitWriter.dylib
		!%p/opt/llvm-3.6/lib/libLLVMCodeGen.dylib
		!%p/opt/llvm-3.6/lib/libLLVMCore.dylib
		!%p/opt/llvm-3.6/lib/libLLVMDebugInfo.dylib
		!%p/opt/llvm-3.6/lib/libLLVMExecutionEngine.dylib
		!%p/opt/llvm-3.6/lib/libLLVMInstCombine.dylib
		!%p/opt/llvm-3.6/lib/libLLVMInstrumentation.dylib
		!%p/opt/llvm-3.6/lib/libLLVMInterpreter.dylib
		!%p/opt/llvm-3.6/lib/libLLVMIRReader.dylib
		!%p/opt/llvm-3.6/lib/libLLVMJIT.dylib
		!%p/opt/llvm-3.6/lib/libLLVMLinker.dylib
		!%p/opt/llvm-3.6/lib/libLLVMLTO.dylib
		!%p/opt/llvm-3.6/lib/libLLVMMC.dylib
		!%p/opt/llvm-3.6/lib/libLLVMMCAnalysis.dylib
		!%p/opt/llvm-3.6/lib/libLLVMMCDisassembler.dylib
		!%p/opt/llvm-3.6/lib/libLLVMLineEditor.dylib
		!%p/opt/llvm-3.6/lib/libLLVMMCJIT.dylib
		!%p/opt/llvm-3.6/lib/libLLVMMCParser.dylib
		!%p/opt/llvm-3.6/lib/libLLVMObjCARCOpts.dylib
		!%p/opt/llvm-3.6/lib/libLLVMObject.dylib
		!%p/opt/llvm-3.6/lib/libLLVMOption.dylib
		!%p/opt/llvm-3.6/lib/libLLVMPowerPCAsmParser.dylib
		!%p/opt/llvm-3.6/lib/libLLVMPowerPCAsmPrinter.dylib
		!%p/opt/llvm-3.6/lib/libLLVMPowerPCCodeGen.dylib
		!%p/opt/llvm-3.6/lib/libLLVMPowerPCDesc.dylib
		!%p/opt/llvm-3.6/lib/libLLVMPowerPCDisassembler.dylib
		!%p/opt/llvm-3.6/lib/libLLVMPowerPCInfo.dylib
		!%p/opt/llvm-3.6/lib/libLLVMProfileData.dylib
		!%p/opt/llvm-3.6/lib/libLLVMRuntimeDyld.dylib
		!%p/opt/llvm-3.6/lib/libLLVMScalarOpts.dylib
		!%p/opt/llvm-3.6/lib/libLLVMSelectionDAG.dylib
		!%p/opt/llvm-3.6/lib/libLLVMSupport.dylib
		!%p/opt/llvm-3.6/lib/libLLVMTableGen.dylib
		!%p/opt/llvm-3.6/lib/libLLVMTarget.dylib
		!%p/opt/llvm-3.6/lib/libLLVMTransformUtils.dylib
		!%p/opt/llvm-3.6/lib/libLLVMVectorize.dylib
		!%p/opt/llvm-3.6/lib/libLLVMipa.dylib
		!%p/opt/llvm-3.6/lib/libLLVMipo.dylib
		!%p/opt/llvm-3.6/lib/libLLVMX86AsmParser.dylib
		!%p/opt/llvm-3.6/lib/libLLVMX86AsmPrinter.dylib
		!%p/opt/llvm-3.6/lib/libLLVMX86CodeGen.dylib
		!%p/opt/llvm-3.6/lib/libLLVMX86Desc.dylib
		!%p/opt/llvm-3.6/lib/libLLVMX86Disassembler.dylib
		!%p/opt/llvm-3.6/lib/libLLVMX86Info.dylib
		!%p/opt/llvm-3.6/lib/libLLVMX86Utils.dylib
		!%p/opt/llvm-3.6/lib/libgtest.dylib
		!%p/opt/llvm-3.6/lib/libgtest_main.dylib
	<<
<<
SplitOff13: <<
	Package: libcxx1-shlibs
	Description: Standard library for libc++
	Files: lib/c++/libc++.*.*.dylib
	Shlibs: <<
	 	%p/lib/c++/libc++.1.0.dylib 1.0.0 %n (>= 3.6.0-0)
	<<
	DocFiles: ../libcxx-%v.src/*.TXT
	DescPort: <<
	This C++ library is always built using the system's C++ ABI library,
	not libc++abi from the LLVM project.  
	The system ABI could be either libc++abi or libsupc++.
	This allows for interoperability across different C++ libraries.  
	<<
	DescUsage: <<
	libc++ lives in a private location, which requires opt-in to use.
	To use libc++, you need to pass "-cxx-isystem %p/include/c++/v1"
	and -L%p/lib/c++ to clang++.  
	<<
<<
SplitOff14: <<
	Package: libcxx1-dev
	Description: Standard library headers for libc++
	Depends: libcxx1-shlibs (= %v-%r)
	BuildDependsOnly: true
	Files: <<
		include/c++
		lib/c++/libc++*.dylib
		opt/llvm-3.6/share/doc/%N/testlogs/libcxx-%v-check.log
	<<
	DescPort: <<
	This C++ library is always built using the system's C++ ABI library,
	not libc++abi from the LLVM project.  
	The system ABI could be either libc++abi or libsupc++.
	This allows for interoperability across different C++ libraries.  
	<<
	DescUsage: <<
	libc++ lives in a private location, which requires opt-in to use.
	To use libc++, you need to pass "-cxx-isystem %p/include/c++/v1"
	and -L%p/lib/c++ to clang++.  
	<<
<<
SplitOff15: <<
	Package: %N-bundle
	Description: Bundle of LLVM/Clang compiler tools
	Type: bundle
	Depends: <<
		%N,
		%N-docs,
		clang36,
		clang36-docs,
		clang36-tools,
		polly36-docs
	<<
	DescDetail: <<
	Installing this gets all of the binaries, libraries, and
	documentation for the llvm36 package set.
	The -dev headers are separate because they are build-depends-only:true.
	<<
<<
Homepage: http://llvm.org/
DescDetail: <<
The LLVM Project is a collection of modular and reusable compiler and
toolchain technologies.  Despite its name, LLVM has little to do with
traditional virtual machines, though it does provide helpful libraries
that can be used to build them.

The goal of the Clang project is to create a new C, C++, Objective C 
and Objective C++ front-end for the LLVM compiler.

Permission granted by Google to contribute packaging.
<<
DescPackaging: <<
clang binaries now live in the clang36 split-off.
The %N-bundle package installs the entire set except for -dev headers.  

libc++ is installed with headers at %p/include/c++/v1
and libraries in %p/lib/c++/, so opt to use them, pass to clang:
-cxx-isystem %p/include/c++/v1 -L%p/lib/c++
Otherwise the default is to use the system's libc++.

openmp runtime is installed privately under clang's per-version resource dir.

Built with shared-libraries to reduce the binary size and peak disk usage.
Targets enabled in CompileScript: X86, PowerPC, ARM.

The upstream build system now produces @rpath-linked libraries and binaries,
however, the InstallScript "de-rpaths" the install_name ids to 
satisfy packaging requirements.  There is also an optional step of
de-rpath-ing dylib *dependencies* that is controlled by the de_rpath_deps
variable.  Binaries work either way, but de-rpathing dependencies
closer resembles the packaging in earlier versions, llvm34.  
<<
DescPort: <<
Most of the patches are maintained at fangism's powerpc-darwin8 branches
of the llvm, clang, compiler-rt projects hosted at github:
	https://github.com/fangism/llvm/compare/release-3.6.0...powerpc-darwin8-rel-3.6.0.diff
	https://github.com/fangism/clang/compare/release-3.6.0...powerpc-darwin8-rel-3.6.0.diff
The following did not change since 3.6.0:
	https://github.com/fangism/compiler-rt/compare/release-3.6.0...powerpc-darwin8-rel-3.6.0.diff
	https://github.com/fangism/libcxx/compare/release-3.6.0...powerpc-darwin8-rel-3.6.0.diff

On darwin>9 and x86 architectures, the package build is done as a
3-stage bootstrap (self-host), now including a built libc++.  
Should stage 2 vs. 3 of bootstrap miscompare, a 4th stage is done, 
and then compared against stage 3 (only expected on darwin10).  
To accelerate testing, a user may also disable the bootstrap by 
setting do_bootstrap=0 in the CompileScript.

	*** LLVM/Clang-3.6 still has some codegen issues for PowerPC
	*** It is NOT considered production quality for PowerPC
	*** HELP WANTED: in stabilizing and fixing PowerPC CodeGen
	*** on llvm/clang svn trunk.
	*** status page: http://www.csl.cornell.edu/~fang/sw/llvm/
	*** IRC channel: #llvm-powerpc-darwin at irc.oftc.net

Original (pre-3.0) package maintained by 
	Benjamin Reed <llvm@fink.raccoonfink.com>
with contributions from
	Jack Howarth <howarth@bromo.med.uc.edu>
		clang-omp

PatchFile contains:
*	CMakeFile fixes, mostly missing dependencies
*	CodeGen patches related to ABI, mach-o
*	and much more!

Generate openmp-$rev with..
svn co -$rev http://llvm.org/svn/llvm-project/openmp/trunk/ openmp-$rev
tar --exclude=.svn -zcvf openmp-$rev.tar.gz openmp-$rev

The llvm36-openmp-rXXXXXX.patch was generated from a diff of the openmp 3.6.0
release and openmp trunk at r219214.

Current clang-omp.patch generated by diff of clang 3.5.0 source and clang-omp from
git co -b clang-omp https://github.com/clang-omp/clang.git
at commit 3f687cbc520a8b8f506d7941f0cebd6c5af1cef6

<<
<<
