diff -ruN ccp4-5.0.2-orig/ccp4i/etc/configure.def.dist ccp4-5.0.2/ccp4i/etc/configure.def.dist
--- ccp4-5.0.2-orig/ccp4i/etc/configure.def.dist	2004-01-26 03:13:25.000000000 -0800
+++ ccp4-5.0.2/ccp4i/etc/configure.def.dist	2004-08-08 14:56:41.000000000 -0700
@@ -53,8 +53,8 @@
 MESSAGE                   _text				""
 BLT_LIBRARY               _text                     ""
 MENU_LENGTH               _positiveint              25
-HYPERTEXT_VIEWER          _text                     netscape
-START_NETSCAPE	          _text			    netscape
+HYPERTEXT_VIEWER          _text                     Safari  
+START_NETSCAPE	          _text			    open    
 O_MAPMAN                  _text                     mapman
 MAPMAN_MAXSIZE		  _positiveint		    4194304
 QUANTA_MBKALL             _text                     mbkall
diff -ruN ccp4-5.0.2-orig/ccp4i/utils/start_netscape.csh ccp4-5.0.2/ccp4i/utils/start_netscape.csh
--- ccp4-5.0.2-orig/ccp4i/utils/start_netscape.csh	2002-02-22 05:50:38.000000000 -0800
+++ ccp4-5.0.2/ccp4i/utils/start_netscape.csh	2004-08-06 21:07:50.000000000 -0700
@@ -1,7 +1,5 @@
 #!/bin/csh
-setenv MOZILLA_HOME /usr/local/netscape
+setenv MOZILLA_HOME open                       
 # Its advisable to undo what was done in ccp4.setup
-setenv XUSERFILESEARCHPATH " "
-setenv XFILESEARCHPATH " "
-netscape file:$CCP4I_HELP/index.html >& /dev/null &
+open $CCP4I_HELP/index.html >& /dev/null &
 #netscape30 file:$CCP4I_HELP/start.html >& /dev/null &
diff -ruN ccp4-5.0.2-orig/etc/uniqueify ccp4-5.0.2/etc/uniqueify
--- ccp4-5.0.2-orig/etc/uniqueify	2004-06-17 03:19:45.000000000 -0700
+++ ccp4-5.0.2/etc/uniqueify	2004-08-08 15:00:50.000000000 -0700
@@ -124,10 +124,10 @@
 temp3=$CCP4_SCR/uniq3$$.mtz
 
 # find awk executable
-for myawk in nawk gawk awk
-do
-    test -f $myawk && break
-done
+
+myawk=/usr/bin/awk
+
+# fink's awk is gawk creating problems, system's awk works fine 
 
 # extract first crystal name from the input file
 xname=`mtzdmp $1 -n 0 | $myawk '                  
diff -ruN ccp4-5.0.2-orig/etc/xloggraph ccp4-5.0.2/etc/xloggraph
--- ccp4-5.0.2-orig/etc/xloggraph	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.2/etc/xloggraph	2004-08-06 21:01:46.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=/swprefix/lib/app-defaults/XCCPJiffy
+xloggraph.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.2-orig/etc/xplot84 ccp4-5.0.2/etc/xplot84
--- ccp4-5.0.2-orig/etc/xplot84	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.2/etc/xplot84	2004-08-06 21:01:06.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=/swprefix/lib/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.2-orig/etc/xplot84driver ccp4-5.0.2/etc/xplot84driver
--- ccp4-5.0.2-orig/etc/xplot84driver	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.2/etc/xplot84driver	2004-08-06 21:01:22.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=/swprefix/lib/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.2-orig/include/ccp4.setup-dist ccp4-5.0.2/include/ccp4.setup-dist
--- ccp4-5.0.2-orig/include/ccp4.setup-dist	2004-08-05 04:47:45.000000000 -0700
+++ ccp4-5.0.2/include/ccp4.setup-dist	2004-08-06 20:54:50.000000000 -0700
@@ -57,7 +57,7 @@
 #               For 'standard' installations this is /usr/local/bin
 #               but note the SGI distributed version of Tcl/Tk is not 
 #               appropriate version
-setenv CCP4I_TCLTK /usr/local/bin        
+setenv CCP4I_TCLTK /swprefix/bin        
 # CCP4I_HELP - directory contain ccp4i help - default is $CCP4I_TOP/help
 setenv CCP4I_HELP ${CCP4I_TOP}/help
 
@@ -107,7 +107,7 @@
     setenv CBIN      $CCP4/bin		
     setenv CLIB      $CCP4/lib	
 
-    setenv CCP4_BROWSER  netscape             
+    setenv CCP4_BROWSER  open        
 
     if (${?MANPATH}) then
       if ($ccp4_first_in_path) then
@@ -158,8 +158,8 @@
 endif
 
 ### PLOT_COMMAND PRINT_COMMAND for the XCCPJIFFY programs to compile ###
-setenv PLOT_COMMAND   'lp -s -dmicrolaser'  
-setenv PRINT_COMMAND  'lp -s -denscript'    
+setenv PLOT_COMMAND   'lpr'  
+setenv PRINT_COMMAND  'lpr'    
 
 # HARVESTHOME specifies location of harvesting files (defaults to $HOME)
 #setenv HARVESTHOME     
@@ -181,29 +181,11 @@
 #
 #  setenv BINSORT_MEM     8388608
 
+# Don't set these -- fink won't permit it
 # LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
 # at runtime
-if (${?LD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv LD_LIBRARY_PATH ${CLIB}:${LD_LIBRARY_PATH}
-  else
-    setenv LD_LIBRARY_PATH ${LD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv LD_LIBRARY_PATH ${CLIB}
-endif
-
 # DYLD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.dylib)
 # at runtime (used on Mac OS X)
-if (${?DYLD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv DYLD_LIBRARY_PATH ${CLIB}:${DYLD_LIBRARY_PATH}
-  else
-    setenv DYLD_LIBRARY_PATH ${DYLD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv DYLD_LIBRARY_PATH ${CLIB}
-endif
 
 ### XAPPLRESDIR ###
 
@@ -221,11 +203,6 @@
 # not be set at the time this file is read.  Thus edit this part as
 # appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
 # instead of /usr; others may want /usr/local/lib or somw such):
-if ($?XUSERFILESEARCHPATH) then
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:$XUSERFILESEARCHPATH
-else
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:/usr/lib/X11/app-defaults
-endif
 
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
@@ -277,8 +254,8 @@
 # confusion with `.' or whatever in the path:
 #
 # This construct prevents the path getting longer each time ccp4.setup is
-# executed (A. Perrakis)
-set ccp4pathlist = "${CCP4}/etc ${CBIN} ${CCP4I_TOP}/bin "
+# executed (A. Perrakis).  I've corrected the erronious syntax.
+set ccp4pathlist = "${CCP4}/etc:${CBIN}:${CCP4I_TOP}/bin"
 #
 foreach dir ( ${ccp4pathlist} )
   if ( ${?PATH} ) then
diff -ruN ccp4-5.0.2-orig/include/ccp4.setup-sh ccp4-5.0.2/include/ccp4.setup-sh
--- ccp4-5.0.2-orig/include/ccp4.setup-sh	2004-08-06 20:28:18.000000000 -0700
+++ ccp4-5.0.2/include/ccp4.setup-sh	2004-08-06 20:43:38.000000000 -0700
@@ -49,7 +49,7 @@
 #               For 'standard' installations this is /usr/local/bin
 #               but note the SGI distributed version of Tcl/Tk is not 
 #               appropriate version
-export CCP4I_TCLTK=/sw/bin        
+export CCP4I_TCLTK=/swprefix/bin        
 # CCP4I_HELP - directory contain ccp4i help - default is $CCP4I_TOP/help
 export CCP4I_HELP=$CCP4I_TOP/help
 
@@ -91,7 +91,7 @@
     export CBIN=$CCP4/bin		
     export CLIB=$CCP4/lib	
 
-    export CCP4_BROWSER=safari             
+    export CCP4_BROWSER=open               
     export MANPATH=$CCP4/man:$MANPATH           # edit this if necessary
     export MCTYPE=unix 			# (only for Laue)
 #     ;;
@@ -110,8 +110,8 @@
 export CLASSPATH=$CBIN:$CLASSPATH                      # edit this if necessary
 
 ### PLOT_COMMAND PRINT_COMMAND for the XCCPJIFFY programs to compile ###
-export PLOT_COMMAND='lp -s'  
-export PRINT_COMMAND='lp -s'    
+export PLOT_COMMAND='lpr'  
+export PRINT_COMMAND='lpr'    
 
 # HARVESTHOME specifies location of harvesting files (defaults to $HOME)
 export HARVESTHOME=$HOME     
@@ -133,25 +133,11 @@
 #
 #  export BINSORT_MEM=8388608
 
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
+# do not export LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
 # at runtime
-if test "LD_LIBRARY_PATH"; then
-  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CLIB
-else
-  export LD_LIBRARY_PATH=$CLIB
-fi
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries
+# do not export DYLD_LIBRARY_PATH specifies where to find dynamic libraries
 # (e.g. libccp4.dylib) at runtime
-if test "DYLD_LIBRARY_PATH"; then
-  export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$CLIB
-else
-  export DYLD_LIBRARY_PATH=$CLIB
-fi
 
-### XAPPLRESDIR ###
-
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
 # application defaults directory since it requires reading by xrdb to sort out
 # the differences for monochrome displays.  At Daresbury a version of the file
 # assuming a monochrome display is kept in the directory
@@ -165,7 +151,6 @@
 # appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
 # instead of /usr; others may want /usr/local/lib or somw such):
 
-export XAPPLRESDIR=/sw/etc/app-defaults/
 
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
@@ -218,7 +203,8 @@
 #
 # This construct prevents the path getting longer each time ccp4.setup is
 # executed (A. Perrakis)
-ccp4pathlist="${CCP4}/etc ${CBIN} ${CCP4I_TOP}/bin "
+# Unfortunately it is aggregiously wrong and had to be corrected
+ccp4pathlist="${CCP4}/etc:${CBIN}:${CCP4I_TOP}/bin"
 #
 for dir in ${ccp4pathlist}
 do
@@ -252,7 +238,7 @@
   alias cexam='pushd $CEXAM>/dev/null'
   alias cdoc='pushd $CDOC>/dev/null'
   alias chtml='pushd $CHTML>/dev/null'
-  alias ccp4help='$CCP4_BROWSER $CHTML/INDEX.html'
+  alias ccp4help='open $CHTML/INDEX.html'
 
 ### laue, lget, linkimages ###
 # Essential aliases for the Laue software suite
diff -ruN ccp4-5.0.2-orig/lib/src/cmtzlib_f.c ccp4-5.0.2/lib/src/cmtzlib_f.c
--- ccp4-5.0.2-orig/lib/src/cmtzlib_f.c	2004-07-05 06:23:54.000000000 -0700
+++ ccp4-5.0.2/lib/src/cmtzlib_f.c	2004-08-11 22:57:33.000000000 -0700
@@ -98,7 +98,7 @@
 #include "csymlib.h"
 #include "ccp4_program.h"
 #include "ccp4_general.h"
-static char rcsid[] = "$Id: cmtzlib_f.c,v 1.62 2004/07/05 13:23:54 mdw Exp $";
+static char rcsid[] = "$Id: cmtzlib_f.c,v 1.63 2004/08/10 09:43:07 pjx Exp $";
 
 #define MFILES 4
 #define MAXSYM 192
@@ -1127,7 +1127,7 @@
  /* lrrefl / lrreff will increment this */
  irref[*mindx-1] = *nrefl - 1;
  if (!cmtz_in_memory) {
-   respos = *nrefl * MtzNumSourceCol(mtzdata[*mindx-1]) + SIZE1 + 1;
+   respos = (*nrefl - 1) * MtzNumSourceCol(mtzdata[*mindx-1]) + SIZE1;
    ccp4_file_seek(mtzdata[*mindx-1]->filein, respos, SEEK_SET); 
  }
 }
diff -ruN ccp4-5.0.2-orig/src/lsqkab.f ccp4-5.0.2/src/lsqkab.f
--- ccp4-5.0.2-orig/src/lsqkab.f	2004-01-23 09:15:33.000000000 -0800
+++ ccp4-5.0.2/src/lsqkab.f	2004-08-11 23:00:29.000000000 -0700
@@ -90,7 +90,7 @@
       CALL XYZINIT
       NATOMS = NATOM
       NOUT = 6
-      CALL CCPRCS(NOUT,'LSQKAB','$Date: 2004/01/23 17:15:33 $')
+      CALL CCPRCS(NOUT,'LSQKAB','$Date: 2004/08/09 15:28:53 $')
       CALL RCARDSLSQ
 C
 C     Initilaise TER info
@@ -548,6 +548,20 @@
         IF (THETA2.EQ.0) CHI = THETA3
         IF (THETA2.EQ.180.0) CHI = 180.0
 C
+C---- Special case: pure rotation around Z-axis
+C     In this case Beta (=Theta2) is either 0 or 180,
+C     Alpha (=Theta1) is zero, and Gamma is any value
+C     between 0 and 180deg.
+C     i.e. the rotation axis is parallel to the Z-axis
+        DC(1) = 0.0
+        DC(2) = 0.0
+        IF (THETA2.EQ.0.0) THEN
+          DC(3) = 1.0
+        ELSE
+          DC(3) = -1.0
+        ENDIF
+        GOTO 20
+C
 C---- IF CHI =180  COSCHI=-1,SINCHI=0
 C
    10   DC(1) = SQRT(ABS(TRMAT(1,1)*0.5+0.5))
@@ -568,7 +582,7 @@
         SOMEGA = SQRT(ABS(1.0-DC(3)*DC(3)))
         OMEGA = ATAN2(SOMEGA,DC(3))*CONV
         CHK = DC(2)*DC(2) + DC(1)*DC(1)
-        PHI = 999
+        PHI = 0.0
         IF (CHK.GT.0.0) PHI = CONV*ATAN2(DC(2),DC(1))
       END IF
       WRITE (6,FMT=6006) THETA1,THETA2,THETA3,OMEGA,PHI,CHI,
diff -ruN ccp4-5.0.2-orig/unsupported/src/Makefile.in ccp4-5.0.2/unsupported/src/Makefile.in
--- ccp4-5.0.2-orig/unsupported/src/Makefile.in	2003-12-01 03:02:44.000000000 -0800
+++ ccp4-5.0.2/unsupported/src/Makefile.in	2004-08-11 23:02:57.000000000 -0700
@@ -1,7 +1,7 @@
 
 # Makefile tail for CCP4 unsupported programs.  This will be modified by configure.
 
-# $Id: Makefile.in,v 1.23 2003/12/01 11:02:44 mdw Exp $
+# $Id: Makefile.in,v 1.24 2004/08/11 15:59:56 pjx Exp $
 
 # variables which should be set by configure: top_srcdir, CC, CFLAGS,
 # FC, FFLAGS, F, LNS, SETFLAGS, EVAL, LDFLAGS, INSTALL_PROGRAM
@@ -22,7 +22,7 @@
 # end if adding to this list)
 FTARGETS = \
 angles asc2p84 axissearch compar \
-difres havecs hbond helixang \
+difres extends havecs hbond helixang \
 mapexchange mapreplace p842asc postref \
 refindex reforigin rotaprep symfit \
 vecsum zeroed
