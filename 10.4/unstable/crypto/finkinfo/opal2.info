Package: opal2
Version: 2.2.4
Revision: 2
Maintainer: None <fink-devel@users.sourceforge.net>
GCC: 4.0
BuildDependsOnly: true
BuildDepends: cyrus-sasl2-dev, doxygen, expat1, openldap23-dev, openssl097-dev, pwlib1, sdl, sed, fink (>= 0.27.2)
# sed : because of the patchscript
Depends: %N-shlibs (= %v-%r)
Source: http://www.ekiga.org/admin/downloads/2.0.4/sources/sources/opal-%v.tar.gz
Source-MD5: 4660858fb386f73f7f49d745b64b0665
PatchScript: <<
 sed -ri -e '/MACOSX/i #include <ptbuildopts.h>' src/codec/speex/libspeex/kiss_fft.h
# implicit declaration of abs :
 sed -ri -e '/"g72x\.h"/i #include <stdlib.h>' src/codec/g726/g72x.c
# implicit declaration of memcpy :
  sed -ri.bak -e '/<stdlib\.h>/a #include <string.h>' src/codec/gsm/src/code.c
### All following lines are the same as in openh323-1.info:
## the configure script expects pwlib's version.h to be installed at the first level of PWLIBDIR (=%p),
## (ie, in parallel with bin, lib, and share...), while pwlib's own install target doesn't even install it...
  perl -pi -e 's,\{PWLIBDIR\}/version\.h,\{PWLIBDIR\}/include/ptlib.h,' configure
## same treatment for PWLIBDIR=%p as when =/usr or /usr/local :
  sed -ri -e '/test\ \"x\$PWLIBDIR\"\ =\ \"x\/usr\"/,/^fi$/c PWLIBDIR=`sed -e 's,/$,,' <<<"$PWLIBDIR"`' \
        -e 's,(\"x\$PWLIBDIR\" = \"x)/usr/local,\1%p\" -o &,' \
	-e 's,usr/",usr",' \
        -e 's,/usr/local/share/pwlib/,\$PWLIBDIR/share/pwlib,' configure
<<
NoSetLDFLAGS: true
SetLIBRARY_PATH: %p/lib
NoSetCPPFLAGS: true
SetCFLAGS: -O3 -fstrict-aliasing
ConfigureParams: --enable-sip --enable-h323 --enable-iax
#  --enable-h263avcodec=%p/include/ffmpeg doens't work
CompileScript: <<
#!/bin/sh -ev
  export CPATH=%p/include; export PWLIBDIR=%p
  if [ %m = i386 ] ; then abbr=x86 ; else abbr=ppc ; fi
  ./configure %c
  mv=`sed -r -e 's,\.[^.]*$,,' <<<"%v"`
  Mv=`sed -r -e 's,\.[^.]*$,,' <<<"$mv"`
  make 	LDSOOPTS="-dynamiclib -single_module -Wl,-x -dead_strip -compatibility_version $mv -current_version %v -install_name %p/lib/libopal_Darwin_${abbr}_r.${Mv}.dylib" \
	libso_target="lib/libopal_Darwin_${abbr}_r.%v.dylib" \
	optshared optnoshared docs test
<<
InstallScript: <<
#!/bin/sh -ev
  make install DESTDIR=%d
  cp -p lib/libopal*.a %i/lib
  cd %i/lib
  rm -f *.dylib.* *.so
  if [ %m = i386 ] ; then abbr=x86 ; else abbr=ppc ; fi
  f=libopal_Darwin_${abbr}_r
  g=$f.%v
  until test "$g" = "$f"
  do newg=`sed -r -e 's,\.[^.]*$,,' <<<"$g"`
     ln -fs $g.dylib $newg.dylib
     g=$newg
  done
  ln -fs $g.dylib libopal.dylib
  ranlib libopal*.a
  chmod a-x *
  cd -
  mkdir -p %i/share/doc/%n
  mv html %i/share/doc/%n
  ln -s ../%N-shlibs/mpl-1.0.htm %i/share/doc/%n
<<
SplitOff: <<
  Package: %N-shlibs
  Depends: pwlib1-shlibs
  Description: Shared libraries for %N
  Files: lib/libopal_Darwin_*.*.*dylib
  Shlibs: <<
	( %m = powerpc	) %p/lib/libopal_Darwin_ppc_r.2.dylib 2.2.0 %n (>= 2.2.2-1)
	( %m = i386	) %p/lib/libopal_Darwin_x86_r.2.dylib 2.2.0 %n (>= 2.2.2-1)
  <<
  DocFiles: mpl-1.0.htm
<<
Description: ???
DescPort: <<
Try to keep at latest version compatible _ according to http://www.ekiga.org/ _
with current version of ekiga, or else go first back for opal2 to the format
infofile_name = %N-%v.info, so older versions can stay in fink (versioning of those
pkgs seems completely erratic)
<<
License: OSI-Approved
Homepage: http://openh323.sourceforge.net/
