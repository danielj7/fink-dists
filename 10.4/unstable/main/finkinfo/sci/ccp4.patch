diff -ruN ccp4-6.0-orig/ccp4i/etc/configure.def.dist ccp4-6.0/ccp4i/etc/configure.def.dist
--- ccp4-6.0-orig/ccp4i/etc/configure.def.dist	2005-09-09 02:39:28.000000000 -0700
+++ ccp4-6.0/ccp4i/etc/configure.def.dist	2006-02-20 19:31:23.000000000 -0800
@@ -54,8 +54,8 @@
 MESSAGE                   _text				""
 BLT_LIBRARY               _text                     ""
 MENU_LENGTH               _positiveint              25
-HYPERTEXT_VIEWER          _text                     netscape
-START_NETSCAPE	          _text			    netscape
+HYPERTEXT_VIEWER          _text                     Safari  
+START_NETSCAPE	          _text			    open    
 O_MAPMAN                  _text                     mapman
 MAPMAN_MAXSIZE		  _positiveint		    4194304
 QUANTA_MBKALL             _text                     mbkall
diff -ruN ccp4-6.0-orig/ccp4i/etc/osx_ccp4_mail ccp4-6.0/ccp4i/etc/osx_ccp4_mail
--- ccp4-6.0-orig/ccp4i/etc/osx_ccp4_mail	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0/ccp4i/etc/osx_ccp4_mail	2006-02-20 19:31:57.000000000 -0800
@@ -0,0 +1,164 @@
+#!/usr/bin/perl
+# Drop-in replacement for /usr/bin/mail that uses Mail.app (via an
+# applescript) rather than sendmail to send mail.  Unlike /usr/bin/mail,
+# you can't use it for reading mail.
+#
+# usage: mail [<options>] <recipients>
+#     options:
+#         -v           be verbose
+#         -g           activate Mail.app to approve the message
+#         -F <from>    specify the From: address
+#         -b <bcc>     specify Bcc: recipients in a comma-separated list
+#         -c <cc>      specify Cc: recipients in a comma-separated list
+#         -s <subject> specify the message subject
+#
+# The body of the message is read from standard input.
+#
+# Author: Nathaniel Nystrom <nystrom@cs.cornell.edu>
+# This software is in the public domain.
+#
+# Version 1.0,   21 Aug 2003 -- initial version
+# Version 1.0.1, 22 Aug 2003 -- fixes some quoting problems
+# Version 1.0.2, 23 Aug 2003 -- removed -R <reply-to> option; |reply to|
+#                               is a property of _incoming_ messages
+# Version 1.0.3, 17 Sep 2003 -- fixed escaping of \ in message body;
+#                               escape the subject too
+
+use strict;
+$|++;
+
+my ($verbose, $gui);
+my ($from, @to, @cc, @bcc, $subject, $body);
+my $prog;
+($prog = $0) =~ s|.*/||;
+
+while (@ARGV) {
+    my $arg = shift @ARGV;
+
+    if ($arg eq '-v') {
+        $verbose++;
+    }
+    elsif ($arg eq '-g') {
+        $gui++;
+    }
+    elsif ($arg eq '-F') {
+        $from = shift @ARGV || &usage("missing sender");
+    }
+    elsif ($arg eq '-i' || $arg eq '-l' || $arg eq '-n') {
+        # ignore; for /usr/bin/mail compatibility
+    }
+    elsif ($arg eq '-N' || $arg eq '-f' || $arg eq '-u') {
+        &usage("invalid option $arg; $prog cannot be used for reading mail");
+    }
+    elsif ($arg eq '-s') {
+        $subject = shift @ARGV || &usage("missing subject");
+    }
+    elsif ($arg eq '-c') {
+        my $list = shift @ARGV || &usage("missing Cc list");
+        @cc = split /\s*,\s*/, $list;
+    }
+    elsif ($arg eq '-b') {
+        my $list = shift @ARGV || &usage("missing Bcc list");
+        @bcc = split /\s*,\s*/, $list;
+    }
+    elsif ($arg =~ /^-/) {
+        &usage("invalid option $arg");
+    }
+    else {
+        @to = ($arg, @ARGV);
+        last;
+    }
+}
+
+&usage("missing recipients") unless @to;
+
+unless (defined $subject) {
+    print "Subject: ";
+    $subject = <STDIN> || '';
+    chomp $subject;
+}
+
+$body = '';
+
+while (<STDIN>) {
+    $body .= $_;
+}
+
+$body = &escape($body);
+$subject = &escape($subject);
+
+my $script = <<"EOS";
+tell application "Mail"
+    set newMessage to make new outgoing message
+    tell newMessage
+        set subject to "$subject"
+        set content to "$body"
+EOS
+
+for (@to)  { $script .= &recipient('to', $_); }
+for (@cc)  { $script .= &recipient('cc', $_); }
+for (@bcc) { $script .= &recipient('bcc', $_); }
+
+my $visible = $gui ? "true" : "false";
+my $activate = $gui ? "activate" : "send newMessage";
+my $fromln = $from ? "set sender to \"$from\"" : "";
+
+$script .= <<"EOS";
+        $fromln
+        set visible to $visible
+    end tell
+    $activate
+end tell
+EOS
+
+if ($verbose >= 1) {
+    print "From: $from\n" if $from;
+    print "To: ", join(',', @to), "\n" if @to;
+    print "Cc: ", join(',', @cc), "\n" if @cc;
+    print "Bcc: ", join(',', @bcc), "\n" if @bcc;
+
+    if ($verbose >= 2) {
+        print "Script >>>\n";
+        print $script;
+        print "<<<\n";
+        print "\n";
+        print $body;
+    }
+}
+
+open(SCRIPT, "| osascript > /dev/null") || die "Couldn't fork osascript: $!\n";
+print SCRIPT $script;
+close SCRIPT;
+
+exit 0;
+
+sub escape {
+    my $x = shift;
+    $x =~ s/\\/\\\\/gm;
+    $x =~ s/"/\\"/gm;
+    $x =~ s/\n/\\n/gm;
+    $x;
+}
+
+sub recipient {
+    my ($type,$addr) = @_;
+    return <<"EOS"
+        make new $type recipient at end of $type recipients with properties {address: "$addr"}
+EOS
+}
+
+sub usage {
+    my $error = shift;
+    print STDERR "Error: $error\n" if $error;
+    print STDERR <<"EOS";
+usage: $prog [<options>] <recipients>
+    options:
+        -v           be verbose
+        -g           activate Mail.app to approve the message
+        -F <from>    specify the From: address
+        -b <bcc>     specify Bcc: recipients in a comma-separated list
+        -c <cc>      specify Cc: recipients in a comma-separated list
+        -s <subject> specify the message subject
+EOS
+    exit 1;
+}
diff -ruN ccp4-6.0-orig/ccp4i/src/local.tcl ccp4-6.0/ccp4i/src/local.tcl
--- ccp4-6.0-orig/ccp4i/src/local.tcl	2005-11-09 05:35:14.000000000 -0800
+++ ccp4-6.0/ccp4i/src/local.tcl	2006-02-20 19:32:31.000000000 -0800
@@ -34,7 +34,7 @@
 #d_arg mail_address Mail addressee
 
 return [expr {1 - [catch \
-   "exec Mail -s \"$subject\" $mail_address < $tmp_file"  ]}]
+   "exec osx_ccp4_mail  -s \"$subject\" $mail_address < $tmp_file"  ]}]
 }
 
 #d_index_title Interaction with Netscape
diff -ruN ccp4-6.0-orig/ccp4i/templates/molrep.com ccp4-6.0/ccp4i/templates/molrep.com
--- ccp4-6.0-orig/ccp4i/templates/molrep.com	2005-11-07 08:52:31.000000000 -0800
+++ ccp4-6.0/ccp4i/templates/molrep.com	2006-03-22 14:25:46.000000000 -0800
@@ -136,7 +136,7 @@
 {[IfSet $FUNCTION] && ![StringSame $FUNCTION A]} FUN $FUNCTION
 ENDIF
 
-{[IfSet $MODEL_CORRECTION] && ![StringSame $MODEL_CORRECTION N] } SURF $MODEL_CORRECTION
+1 SURF $MODEL_CORRECTION
 
 IF { $NMONOMERS > 0  }
 { [IfSet $NMONOMERS] } NMON $NMONOMERS
diff -ruN ccp4-6.0-orig/configure ccp4-6.0/configure
--- ccp4-6.0-orig/configure	2006-02-08 08:28:03.000000000 -0800
+++ ccp4-6.0/configure	2006-02-21 07:54:22.000000000 -0800
@@ -2090,7 +2090,7 @@
   XMKMF="IMAKECPP=/usr/bin/cpp xmkmf"
   if test "$shared_lib" = yes; then
     SHARED_LIB_CFLAGS=${SHARED_LIB_CFLAGS:-'-fPIC -fno-common'}
-    SHARE_LIB='${CXX} -dynamiclib -flat_namespace -undefined suppress ${SHARED_LIB_CFLAGS} -install_name libmmdb.dylib -all_load libmmdb.a -o libmmdb.dylib; ${CC} -dynamiclib -flat_namespace -undefined suppress ${SHARED_LIB_CFLAGS} -install_name libccp4c.dylib -all_load libccp4c.a  -o libccp4c.dylib'
+    SHARE_LIB='${CXX} -dynamiclib -flat_namespace -undefined suppress ${SHARED_LIB_CFLAGS} -install_name ${RPATH}/libmmdb.dylib -all_load libmmdb.a -o libmmdb.dylib; ${CC} -dynamiclib -flat_namespace -undefined suppress ${SHARED_LIB_CFLAGS} -install_name ${RPATH}/libccp4c.dylib -all_load libccp4c.a  -o libccp4c.dylib'
     SHARE_INST='${INSTALL_DATA} `pwd`/libmmdb.dylib ${libdir}/libmmdb.dylib; ${INSTALL_DATA} `pwd`/libccp4c.dylib ${libdir}/libccp4c.dylib'
   fi     
 #need -lcc_dynamic to get restFP and saveFP for g77 3.4 under darwin 7
@@ -4051,19 +4051,19 @@
  ;
 }
 _ACEOF
-     if test $FC = g77 && $FC -v conftest.f -o conftest 2>&1 | grep '3.1' >/dev/null ; then
+#     if test $FC = g77 && $FC -v conftest.f -o conftest 2>&1 | grep '3.1' >/dev/null ; then
     echo "configure --disable-shared --libdir=${libdir}"
     ( touch /tmp/$$.cache_file 2>/dev/null && \
       cat /dev/null > /tmp/$$.cache_file && \
       ./configure --disable-shared --libdir=${libdir} --cache-file=/tmp/$$.cache_file ) || \
       ./configure --disable-shared --libdir=${libdir}
-     else
-   echo "configure $xopts --libdir=${libdir}"
-    ( touch /tmp/$$.cache_file 2>/dev/null && \
-      cat /dev/null > /tmp/$$.cache_file && \
-      ./configure $xopts --libdir=${libdir} --cache-file=/tmp/$$.cache_file ) || \
-      ./configure $xopts --libdir=${libdir}
-     fi
+#     else
+#   echo "configure $xopts --libdir=${libdir}"
+#    ( touch /tmp/$$.cache_file 2>/dev/null && \
+#      cat /dev/null > /tmp/$$.cache_file && \
+#      ./configure $xopts --libdir=${libdir} --cache-file=/tmp/$$.cache_file ) || \
+#      ./configure $xopts --libdir=${libdir}
+ #    fi
     ;;
   Darwin_ibm_compilers )
     echo "configure --disable-shared --libdir=${libdir}"
diff -ruN ccp4-6.0-orig/etc/xloggraph ccp4-6.0/etc/xloggraph
--- ccp4-6.0-orig/etc/xloggraph	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0/etc/xloggraph	2006-02-20 19:30:27.000000000 -0800
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xloggraph.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-6.0-orig/etc/xplot84 ccp4-6.0/etc/xplot84
--- ccp4-6.0-orig/etc/xplot84	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0/etc/xplot84	2006-02-20 19:23:53.000000000 -0800
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-6.0-orig/etc/xplot84driver ccp4-6.0/etc/xplot84driver
--- ccp4-6.0-orig/etc/xplot84driver	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0/etc/xplot84driver	2006-02-20 19:23:53.000000000 -0800
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-6.0-orig/include/ccp4.setup-bash ccp4-6.0/include/ccp4.setup-bash
--- ccp4-6.0-orig/include/ccp4.setup-bash	2006-02-03 06:13:28.000000000 -0800
+++ ccp4-6.0/include/ccp4.setup-bash	2006-02-20 19:26:10.000000000 -0800
@@ -3,7 +3,7 @@
 # Actually, the aliases can't work asis in ksh.  Should use builtins instead
 # and not worry about ease of keeping in step with the csh one.
 
-# $Id: ccp4.setup-bash,v 1.72 2006/02/03 14:13:28 pjx Exp $
+# $Id: ccp4.setup-bash,v 1.67 2005/09/22 08:40:51 mdw Exp $
 
 # This file is site specific and may also contain machine-specifics.  The CCP4
 # administrator will have to edit this file and then have anyone who wants to
@@ -360,14 +360,3 @@
 
   unset alias  # clean up
 fi             # ksh test
-
-# Set-up cctbx environment
-test -r $CCP4/lib/cctbx/cctbx_build/setpaths.sh && . $CCP4/lib/cctbx/cctbx_build/setpaths.sh
-
-# Set-up phaser environment
-if ( test -d $CCP4/src/phaser) ; then
-  phaser_mtype=`$CCP4/src/phaser/bin/machine_type`
-  phaser_version=`grep PHASER_VERSION $CCP4/src/phaser/conf/version | awk '{print $3}'`
-  phaser_setup_file="${CCP4}/src/phaser/phaser-${phaser_version}/build/${phaser_mtype}/setpaths.sh"
-  test -r $phaser_setup_file && . $phaser_setup_file
-fi
diff -ruN ccp4-6.0-orig/include/ccp4.setup-dist ccp4-6.0/include/ccp4.setup-dist
--- ccp4-6.0-orig/include/ccp4.setup-dist	2006-02-03 06:13:28.000000000 -0800
+++ ccp4-6.0/include/ccp4.setup-dist	2006-02-20 19:26:10.000000000 -0800
@@ -1,7 +1,7 @@
 #!/bin/csh
 # CCP4 setup file for C-shell (or tcsh) users.  -*- shell-script -*-
 
-# $Id: ccp4.setup-dist,v 1.84 2006/02/03 14:13:28 pjx Exp $
+# $Id: ccp4.setup-dist,v 1.77 2005/09/22 08:40:52 mdw Exp $
 
 # This file is site specific and may also contain machine-specifics.  The CCP4
 # administrator will have to edit this file and then have anyone who wants to
@@ -107,7 +107,7 @@
     setenv CBIN      $CCP4/bin		
     setenv CLIB      $CCP4/lib	
 
-    setenv CCP4_BROWSER  netscape             
+    setenv CCP4_BROWSER  open            
 
     if (${?MANPATH}) then
       if ($ccp4_first_in_path) then
@@ -181,52 +181,6 @@
 #
 #  setenv BINSORT_MEM     8388608
 
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-# at runtime
-if (${?LD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv LD_LIBRARY_PATH ${CLIB}:${LD_LIBRARY_PATH}
-  else
-    setenv LD_LIBRARY_PATH ${LD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv LD_LIBRARY_PATH ${CLIB}
-endif
-
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.dylib)
-# at runtime (used on Mac OS X)
-if (${?DYLD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv DYLD_LIBRARY_PATH ${CLIB}:${DYLD_LIBRARY_PATH}
-  else
-    setenv DYLD_LIBRARY_PATH ${DYLD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv DYLD_LIBRARY_PATH ${CLIB}
-endif
-
-### XAPPLRESDIR ###
-
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
-# application defaults directory since it requires reading by xrdb to sort out
-# the differences for monochrome displays.  At Daresbury a version of the file
-# assuming a monochrome display is kept in the directory
-# $CCP4_LIB/X11/app-defaults and this is picked up through the
-# XUSERFILESEARCHPATH environment variable.  That means you only see black and
-# white on a colour display.  Alternatively you might make sure that it is
-# read by xrdb on startup of the X Windows system or delegate the
-# responsibility to users to run it.  There are disadvantages to putting an
-# invocation of xrdb in here, one being that the correct value of DISPLAY may
-# not be set at the time this file is read.  Thus edit this part as
-# appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-# instead of /usr; others may want /usr/local/lib or somw such):
-if ($?XUSERFILESEARCHPATH) then
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:$XUSERFILESEARCHPATH
-else
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:/usr/lib/X11/app-defaults
-endif
-
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
 # point exceptions under IRIX.  It shouldn't cause harm on other systems, but
@@ -348,14 +302,3 @@
   alias lgnoms 'pushd $CCP4_MASTER/laue/gnom/src>/dev/null'
   alias lbin   'pushd $CBIN>/dev/null'
 #
-
-# Set-up cctbx environment
-if (-e $CCP4/lib/cctbx/cctbx_build/setpaths.csh) source $CCP4/lib/cctbx/cctbx_build/setpaths.csh
-
-# Set-up phaser environment
-if (-d $CCP4/src/phaser) then
-  set phaser_mtype = `$CCP4/src/phaser/bin/machine_type`
-  set phaser_version = `grep PHASER_VERSION $CCP4/src/phaser/conf/version | awk '{print $3}'`
-  set phaser_setup_file = "${CCP4}/src/phaser/phaser-${phaser_version}/build/${phaser_mtype}/setpaths.csh"
-  if (-e $phaser_setup_file) source $phaser_setup_file
-endif
diff -ruN ccp4-6.0-orig/include/ccp4.setup-sh ccp4-6.0/include/ccp4.setup-sh
--- ccp4-6.0-orig/include/ccp4.setup-sh	2006-02-03 06:13:28.000000000 -0800
+++ ccp4-6.0/include/ccp4.setup-sh	2006-02-20 19:26:10.000000000 -0800
@@ -5,7 +5,7 @@
 # can't work asis in ksh.  Should use builtins instead and not worry about
 # ease of keeping in step with the csh one.
 
-# $Id: ccp4.setup-sh,v 1.12 2006/02/03 14:13:28 pjx Exp $
+# $Id: ccp4.setup-sh,v 1.7 2005/09/09 13:52:45 pjx Exp $
 
 # This file is site specific and may also contain machine-specifics.  The CCP4
 # administrator will have to edit this file and then have anyone who wants to
@@ -91,7 +91,8 @@
     export CBIN=$CCP4/bin		
     export CLIB=$CCP4/lib	
 
-    export CCP4_BROWSER=safari             
+    CCP4_BROWSER=""
+    export CCP4_BROWSER="open"            
     export MANPATH=$CCP4/man:$MANPATH           # edit this if necessary
     export MCTYPE=unix 			# (only for Laue)
 #     ;;
@@ -133,40 +134,6 @@
 #
 #  export BINSORT_MEM=8388608
 
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-# at runtime
-if test "LD_LIBRARY_PATH"; then
-  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CLIB
-else
-  export LD_LIBRARY_PATH=$CLIB
-fi
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries
-# (e.g. libccp4.dylib) at runtime
-if test "DYLD_LIBRARY_PATH"; then
-  export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$CLIB
-else
-  export DYLD_LIBRARY_PATH=$CLIB
-fi
-
-### XAPPLRESDIR ###
-
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
-# application defaults directory since it requires reading by xrdb to sort out
-# the differences for monochrome displays.  At Daresbury a version of the file
-# assuming a monochrome display is kept in the directory
-# $CCP4_LIB/X11/app-defaults and this is picked up through the
-# XUSERFILESEARCHPATH environment variable.  That means you only see black and
-# white on a colour display.  Alternatively you might make sure that it is
-# read by xrdb on startup of the X Windows system or delegate the
-# responsibility to users to run it.  There are disadvantages to putting an
-# invocation of xrdb in here, one being that the correct value of DISPLAY may
-# not be set at the time this file is read.  Thus edit this part as
-# appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-# instead of /usr; others may want /usr/local/lib or somw such):
-
-export XAPPLRESDIR=/sw/etc/app-defaults/
-
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
 # point exceptions under IRIX.  It shouldn't cause harm on other systems, but
@@ -280,14 +247,3 @@
   alias lgnom='pushd $CCP4_MASTER/laue/gnom>/dev/null'
   alias lgnoms='pushd $CCP4_MASTER/laue/gnom/src>/dev/null'
   alias lbin='pushd $CBIN>/dev/null'
-
-# Set-up cctbx environment
-test -r $CCP4/lib/cctbx/cctbx_build/setpaths.sh && . $CCP4/lib/cctbx/cctbx_build/setpaths.sh
-
-# Set-up phaser environment
-if ( test -d $CCP4/src/phaser) ; then
-  phaser_mtype=`$CCP4/src/phaser/bin/machine_type`
-  phaser_version=`grep PHASER_VERSION $CCP4/src/phaser/conf/version | awk '{print $3}'`
-  phaser_setup_file="${CCP4}/src/phaser/phaser-${phaser_version}/build/${phaser_mtype}/setpaths.sh"
-  test -r $phaser_setup_file && . $phaser_setup_file
-fi
diff -ruN ccp4-6.0-orig/include/ccp4.setup-zsh ccp4-6.0/include/ccp4.setup-zsh
--- ccp4-6.0-orig/include/ccp4.setup-zsh	2006-02-03 06:13:28.000000000 -0800
+++ ccp4-6.0/include/ccp4.setup-zsh	2006-02-20 19:26:10.000000000 -0800
@@ -18,7 +18,7 @@
 
 # Also contains a few zsh-specific functions and command-completions
 
-# $Id: ccp4.setup-zsh,v 1.12 2006/02/03 14:13:28 pjx Exp $
+# $Id: ccp4.setup-zsh,v 1.7 2005/09/22 08:40:52 mdw Exp $
 
 # This file is site specific and may also contain machine-specifics.  The CCP4
 # administrator will have to edit this file and then have anyone who wants to
@@ -122,6 +122,7 @@
 
     
     if [[ $(uname) = Darwin ]]; then
+        CCP4_BROWSER=""
         export CCP4_BROWSER=open            # open in OS X default browser
     elif [[ $(uname) = Linux ]];then
         export  CCP4_BROWSER=konqueror 
@@ -175,66 +176,6 @@
 #  export BINSORT_MEM=8388608
 
 
-# If installed via fink, skip this bit:
-
-if [[ -z $SWPREFIX ]];then
-  if [[ -d /sw/bin/fink-virtual-pkgs ]];then
-    SWPREFIX=$(dirname $(dirname $(which /sw/bin/fink-virtual-pkgs)))
-  fi
-fi
-
-if [[ -z $SWPREFIX || $CCP4_MASTER != $SWPREFIX/share/xtal ]];then 
-    
-    # LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-    # at runtime
-    
-    if test "$LD_LIBRARY_PATH"; then
-      if [[ $ccp4_first_in_path == 1 ]]; then
-        export LD_LIBRARY_PATH=$CLIB:$LD_LIBRARY_PATH
-      else
-        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CLIB
-      fi
-    else
-      export LD_LIBRARY_PATH=$CLIB
-    fi
-    # DYLD_LIBRARY_PATH specifies where to find dynamic libraries
-    # (e.g. libccp4.dylib) at runtime
-    if test "$DYLD_LIBRARY_PATH"; then
-      if [[ $ccp4_first_in_path == 1 ]]; then
-        export DYLD_LIBRARY_PATH=$CLIB:$DYLD_LIBRARY_PATH
-      else
-        export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$CLIB
-      fi
-    else
-      export DYLD_LIBRARY_PATH=$CLIB
-    fi
-    
-    ### XAPPLRESDIR ###
-    
-    # If you want to use xloggraph/xplot84driver, you need to get the application
-    # defaults picked up somehow.  As distributed, the file can't just live in an
-    # application defaults directory since it requires reading by xrdb to sort out
-    # the differences for monochrome displays.  At Daresbury a version of the file
-    # assuming a monochrome display is kept in the directory
-    # $CCP4_LIB/X11/app-defaults and this is picked up through the
-    # XUSERFILESEARCHPATH environment variable.  That means you only see black and
-    # white on a colour display.  Alternatively you might make sure that it is
-    # read by xrdb on startup of the X Windows system or delegate the
-    # responsibility to users to run it.  There are disadvantages to putting an
-    # invocation of xrdb in here, one being that the correct value of DISPLAY may
-    # not be set at the time this file is read.  Thus edit this part as
-    # appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-    # instead of /usr; others may want /usr/local/lib or somw such):
-
-    if [[ -n "$XUSERFILESEARCHPATH" ]]; then
-        XUSERFILESEARCHPATH=$CCP4_LIB/X11/app-defaults/%N:$XUSERFILESEARCHPATH
-    else
-        XUSERFILESEARCHPATH=$CCP4_LIB/X11/app-defaults/%N:/usr/lib/X11/app-defaults
-    fi
-
-    export XUSERFILESEARCHPATH
-    
-fi
 
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
@@ -383,16 +324,6 @@
     typeset -U manpath
     typeset -U classpath
      
-# Set-up cctbx environment
-test -r $CCP4/lib/cctbx/cctbx_build/setpaths.sh && . $CCP4/lib/cctbx/cctbx_build/setpaths.sh
  
-# Set-up phaser environment
-if ( test -d $CCP4/src/phaser) ; then
-  phaser_mtype=`$CCP4/src/phaser/bin/machine_type`
-  phaser_version=`grep PHASER_VERSION $CCP4/src/phaser/conf/version | awk '{print $3}'`
-  phaser_setup_file="${CCP4}/src/phaser/phaser-${phaser_version}/build/${phaser_mtype}/setpaths.sh"
-  test -r $phaser_setup_file && . $phaser_setup_file
-fi
-
 
 
diff -ruN ccp4-6.0-orig/lib/ccif/configure ccp4-6.0/lib/ccif/configure
--- ccp4-6.0-orig/lib/ccif/configure	2005-05-10 09:15:15.000000000 -0700
+++ ccp4-6.0/lib/ccif/configure	2006-02-20 22:08:03.000000000 -0800
@@ -1874,7 +1874,7 @@
            SHARED_LIB_PATH='DYLD_LIBRARY_PATH=`pwd`'
          fi
          SHARED_LIB_CMD=' $(LD) -dylib -dynamic -flat_namespace \\\
-                          -undefined suppress -dylib_install_name $(SHARED_LIB_NAME) \\\
+                          -undefined suppress -dylib_install_name ${RPATH}/$(SHARED_LIB_NAME) \\\
                           -all_load $L \\\
                           -o $(SHARED_LIB_NAME) -ldylib1.o'
          SHARED_LIB_EXPORTS_CMD=''
@@ -1892,7 +1892,7 @@
          fi
          SHARED_LIB_CMD='$(CC) $(SHARED_LIB_CFLAGS) -dynamiclib -flat_namespace \\\
                                -undefined suppress -install_name \\\
-                                $(SHARED_LIB_NAME) \\\
+                                ${RPATH}/$(SHARED_LIB_NAME) \\\
                                -all_load $L \\\
                                -o $(SHARED_LIB_NAME)'
          SHARED_LIB_EXPORTS_CMD=''
diff -ruN ccp4-6.0-orig/lib/cctbx/ccp4_build ccp4-6.0/lib/cctbx/ccp4_build
--- ccp4-6.0-orig/lib/cctbx/ccp4_build	2005-11-02 04:47:27.000000000 -0800
+++ ccp4-6.0/lib/cctbx/ccp4_build	2006-02-22 08:57:32.000000000 -0800
@@ -1,53 +1,5 @@
-#! /bin/sh
+#! /bin/sh -ef
 
-usage='echo "Usage: ccp4_build [--help] [--libdir=DIR]" '
-
-if ( eval test -d cctbx_build || eval mkdir cctbx_build ) ; then :
-else
-  eval echo "! No directory cctbx_build and can\'t create it."
-  exit 1
-fi
-
-cctbxopts="--command_version_suffix=ccp4-6.0 --build=release"
-for arg
-do
-
-    case $arg in
-
-    -help | --help | -h | help)
-      eval $usage; exit 0;;
-
-    -libdir=* | --libdir=* | --libdi=* | --libd=* | --lib=* | --li=* | --l=*)
-      libdir=`echo $arg | sed 's/[-a-z_]*=//'` ; break;;
-
-    # all other arguments passed to cctbx build
-    *)
-      cctbxopts="$cctbxopts $arg" ;;
-
-    esac
-
-done
-
-if ( eval test -z \"\$CCP4\" ) ; then
-  echo "! Please set CCP4 environment, e.g. source ccp4.setup "
-  exit 1
-else true; fi
-
-libdir=${libdir:-$CCP4_LIB}
-
-echo "Changing directory to cctbx_build"
-cd cctbx_build
-
-echo "Running libtbx/configure.py"
-python ../cctbx_sources/libtbx/configure.py $cctbxopts ccp4io=${CCP4} mmtbx
-
-echo "Running setpaths.sh"
-. ./setpaths.sh
-
-echo "Building cctbx"
-libtbx.scons .
-
-# sunos 32 vs 64
-# use of sunos compilers
-# installation ??
+echo "Skipping final build of cctbx"
+echo "Install fink's cctbx package if you need this"
 
diff -ruN ccp4-6.0-orig/lib/cctbx/ccp4_build-original ccp4-6.0/lib/cctbx/ccp4_build-original
--- ccp4-6.0-orig/lib/cctbx/ccp4_build-original	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0/lib/cctbx/ccp4_build-original	2006-02-22 08:55:41.000000000 -0800
@@ -0,0 +1,53 @@
+#! /bin/sh
+
+usage='echo "Usage: ccp4_build [--help] [--libdir=DIR]" '
+
+if ( eval test -d cctbx_build || eval mkdir cctbx_build ) ; then :
+else
+  eval echo "! No directory cctbx_build and can\'t create it."
+  exit 1
+fi
+
+cctbxopts="--command_version_suffix=ccp4-6.0 --build=release"
+for arg
+do
+
+    case $arg in
+
+    -help | --help | -h | help)
+      eval $usage; exit 0;;
+
+    -libdir=* | --libdir=* | --libdi=* | --libd=* | --lib=* | --li=* | --l=*)
+      libdir=`echo $arg | sed 's/[-a-z_]*=//'` ; break;;
+
+    # all other arguments passed to cctbx build
+    *)
+      cctbxopts="$cctbxopts $arg" ;;
+
+    esac
+
+done
+
+if ( eval test -z \"\$CCP4\" ) ; then
+  echo "! Please set CCP4 environment, e.g. source ccp4.setup "
+  exit 1
+else true; fi
+
+libdir=${libdir:-$CCP4_LIB}
+
+echo "Changing directory to cctbx_build"
+cd cctbx_build
+
+echo "Running libtbx/configure.py"
+python ../cctbx_sources/libtbx/configure.py $cctbxopts ccp4io=${CCP4} mmtbx
+
+echo "Running setpaths.sh"
+. ./setpaths.sh
+
+echo "Building cctbx"
+libtbx.scons .
+
+# sunos 32 vs 64
+# use of sunos compilers
+# installation ??
+
diff -ruN ccp4-6.0-orig/lib/cctbx/cctbx_install_script.csh ccp4-6.0/lib/cctbx/cctbx_install_script.csh
--- ccp4-6.0-orig/lib/cctbx/cctbx_install_script.csh	2005-11-08 09:06:57.000000000 -0800
+++ ccp4-6.0/lib/cctbx/cctbx_install_script.csh	2006-02-26 08:36:24.000000000 -0800
@@ -1,232 +1,5 @@
-#! /bin/csh -f
+#! /bin/sh -ef
 
-set install_root="$cwd"
-set bundle="cctbx"
-set sources="$cwd/${bundle}_sources"
-set build="$cwd/${bundle}_build"
-set prefer_usr_bin_python=0
+echo "Skipping final build of cctbx"
+echo "Install fink's cctbx package if you need this"
 
-unalias cat
-unalias cd
-unalias grep
-unalias ls
-unalias mkdir
-
-unsetenv PYTHONHOME
-
-if (-f "$sources/TAG") then
-  echo "Build tag:"
-  cat "$sources/TAG"
-endif
-
-if (-d "$sources/boost") then
-  set have_sources=1
-else
-  set have_sources=0
-endif
-
-set python_exe=None
-set build_mode=release
-
-if ("`uname`" == "Darwin") then
-  set python_exe="/Library/Frameworks/Python.framework/Versions/2.3/bin/python"
-  if (! -x "$python_exe") then
-    set python_exe="/System$python_exe"
-  endif
-  "$python_exe" -V
-  if ($status != 0) then
-    echo "Under Mac OS 10 Python 2.3 must be pre-installed."
-    echo "Please refer to the following web page for more information:"
-    echo "http://cci.lbl.gov/cctbx_build/mac_os_x_notes.html"
-    exit 1
-  endif
-endif
-
-if ($have_sources == 0) then
-
-  if (-d "$build/python") then
-    set python_exe="$build/python/bin/python"
-  endif
-  if ($prefer_usr_bin_python) then
-    if ("$python_exe" == None && -x /usr/bin/python) then
-      /usr/bin/python -V |& head -1
-      if ($status == 0) then
-        set python_exe=/usr/bin/python
-      endif
-    endif
-  endif
-  if ("$python_exe" == None) then
-    python -V |& head -1
-    if ($status == 0) then
-      set python_exe=python
-    endif
-  endif
-  if (! $prefer_usr_bin_python) then
-    if ("$python_exe" == None && -x /usr/bin/python) then
-      /usr/bin/python -V |& head -1
-      if ($status == 0) then
-        set python_exe=/usr/bin/python
-      endif
-    endif
-  endif
-
-else
-
-  if ($#argv == 0) then
-    echo -n "Please enter the number of available CPU's [1]: "
-    set n_cpu_s=(`echo "$<"`)
-    if ($#n_cpu_s > 1) then
-      echo "Not a number! Please try again."
-      exit 1
-    else if ($#n_cpu_s == 0) then
-      set n_cpu_s=1
-    else
-      set n_cpu_s="$n_cpu_s[1]"
-    endif
-  else if ($#argv == 1) then
-    set n_cpu_s="$1"
-  else
-    echo "usage: $0 number_of_cpu_s"
-    exit 1
-  endif
-  echo "Number of available CPU's: $n_cpu_s"
-  if ("$n_cpu_s" == "0") exit 0
-
-  if ("$python_exe" == None) then
-
-    set python_sources=(`ls | grep Python-`)
-    if ($#python_sources == 0) then
-      set python_sources=None
-    else if ($#python_sources == 1) then
-      set python_sources="$python_sources[1]"
-    else
-      echo "ERROR: Multiple Python source code directories."
-      echo "       Move or remove all but one directory."
-      exit 1
-    endif
-
-    if ("$python_sources" == None) then
-
-      echo "Trying to find a pre-installed Python:"
-      set python_exe=None
-      if (-x "$build/python/bin/python") then
-        "$build/python/bin/python" -V |& head -1
-        if ($status == 0) then
-          set python_exe="$build/python/bin/python"
-        endif
-      endif
-      if ("$python_exe" == None) then
-        python -V |& head -1
-        if ($status == 0) then
-          set python_exe=python
-        endif
-      endif
-      if ("$python_exe" == None) then
-        python2 -V |& head -1
-        if ($status == 0) then
-          set python_exe=python2
-        endif
-      endif
-      if ("$python_exe" == None && -x /usr/bin/python) then
-        /usr/bin/python -V |& head -1
-        if ($status == 0) then
-          set python_exe=/usr/bin/python
-        endif
-      endif
-      if ("$python_exe" != None) then
-        set python_version=(`"$python_exe" -V |& tr "." " "`)
-        if ("$python_version[2]") then
-          set minor=`echo "$python_version[3]" | cut -c-1`
-          if ($minor < 2 || ($minor == 2 && $#python_version == 3)) then
-            echo "A more recent Python version is required (2.2.1 or higher)."
-            set python_exe=None
-          endif
-        endif
-      endif
-      if ("$python_exe" == None) then
-        echo ""
-        echo "Cannot find a Python interpreter."
-        echo ""
-        echo "Please download an installer with Python included"
-        echo "or add a matching Python to the PATH environment variable."
-        echo ""
-        echo "Installation aborted."
-        exit 1
-      endif
-
-    else
-
-      echo "Installing $python_sources from sources"
-      mkdir -p "$build"
-      cd "$build"
-      cd ..
-      cd "$python_sources"
-      set py_install_log="../py_install_log"
-      echo "Configuring Python"
-      ./configure --prefix="$build/python" >& "$py_install_log"
-      echo "Compiling Python. This may take a while."
-      make >>& "$py_install_log"
-      echo "Installing Python"
-      make install >>& "$py_install_log"
-      echo "Done installing Python."
-      cd "$install_root"
-      set python_exe="$build/python/bin/python"
-      "$python_exe" -V
-      if ($status != 0) then
-        echo "ERROR: Python installation failed."
-        echo "Please check the log file for errors:"
-        echo "  $py_install_log"
-        exit 1
-      endif
-
-    endif
-
-  endif
-
-  mkdir -p "$build"
-
-endif
-
-echo ""
-echo "Precompiling all .py files. This may take a minute or two."
-"$python_exe" "$sources/libtbx/libtbx/command_line/py_compile_all.py"
-
-echo ""
-cd "$build"
-echo "Configuring $bundle build directory"
-"$python_exe" "$sources/libtbx/configure.py" --build="$build_mode" mmtbx clipper
-source setpaths_all.csh
-
-if ($have_sources != 0) then
-  echo ""
-  echo "Installing $bundle modules. This may take a while."
-  libtbx.scons -j "$n_cpu_s" .
-endif
-
-set test_py="$BOOST_ADAPTBX_DIST/tst_rational.py"
-if (-f "$test_py") then
-  echo ""
-  echo "Running a selected test"
-  set cmd='libtbx.python "'"$test_py"'"'
-  echo "$cmd"
-  eval $cmd
-endif
-
-cat << EOT
-
-***
-*** csh and tcsh users:
-***     To use this installation in a new shell or process run the command:
-***
-***         source "$LIBTBX_BUILD/setpaths.csh"
-***
-***     You may want to add this line to your .cshrc file.
-***
-*** sh and bash users:
-***     To use this installation in a new shell or process run the command:
-***
-***         . "$LIBTBX_BUILD/setpaths.sh"
-***
-***     You may want to add this line to your .profile or .bashrc file.
-***
-EOT
diff -ruN ccp4-6.0-orig/lib/cctbx/cctbx_install_script.csh-original ccp4-6.0/lib/cctbx/cctbx_install_script.csh-original
--- ccp4-6.0-orig/lib/cctbx/cctbx_install_script.csh-original	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0/lib/cctbx/cctbx_install_script.csh-original	2006-02-21 08:13:32.000000000 -0800
@@ -0,0 +1,232 @@
+#! /bin/csh -f
+
+set install_root="$cwd"
+set bundle="cctbx"
+set sources="$cwd/${bundle}_sources"
+set build="$cwd/${bundle}_build"
+set prefer_usr_bin_python=0
+
+unalias cat
+unalias cd
+unalias grep
+unalias ls
+unalias mkdir
+
+unsetenv PYTHONHOME
+
+if (-f "$sources/TAG") then
+  echo "Build tag:"
+  cat "$sources/TAG"
+endif
+
+if (-d "$sources/boost") then
+  set have_sources=1
+else
+  set have_sources=0
+endif
+
+set python_exe=None
+set build_mode=release
+
+if ("`uname`" == "Darwin") then
+  set python_exe="/System/Library/Frameworks/Python.framework/Versions/Current/bin/python"
+  if (! -x "$python_exe") then
+    set python_exe="/System$python_exe"
+  endif
+  "$python_exe" -V
+  if ($status != 0) then
+    echo "Under Mac OS 10 Python 2.3 must be pre-installed."
+    echo "Please refer to the following web page for more information:"
+    echo "http://cci.lbl.gov/cctbx_build/mac_os_x_notes.html"
+    exit 1
+  endif
+endif
+
+if ($have_sources == 0) then
+
+  if (-d "$build/python") then
+    set python_exe="$build/python/bin/python"
+  endif
+  if ($prefer_usr_bin_python) then
+    if ("$python_exe" == None && -x /usr/bin/python) then
+      /usr/bin/python -V |& head -1
+      if ($status == 0) then
+        set python_exe=/usr/bin/python
+      endif
+    endif
+  endif
+  if ("$python_exe" == None) then
+    python -V |& head -1
+    if ($status == 0) then
+      set python_exe=python
+    endif
+  endif
+  if (! $prefer_usr_bin_python) then
+    if ("$python_exe" == None && -x /usr/bin/python) then
+      /usr/bin/python -V |& head -1
+      if ($status == 0) then
+        set python_exe=/usr/bin/python
+      endif
+    endif
+  endif
+
+else
+
+  if ($#argv == 0) then
+    echo -n "Please enter the number of available CPU's [1]: "
+    set n_cpu_s=(`echo "$<"`)
+    if ($#n_cpu_s > 1) then
+      echo "Not a number! Please try again."
+      exit 1
+    else if ($#n_cpu_s == 0) then
+      set n_cpu_s=1
+    else
+      set n_cpu_s="$n_cpu_s[1]"
+    endif
+  else if ($#argv == 1) then
+    set n_cpu_s="$1"
+  else
+    echo "usage: $0 number_of_cpu_s"
+    exit 1
+  endif
+  echo "Number of available CPU's: $n_cpu_s"
+  if ("$n_cpu_s" == "0") exit 0
+
+  if ("$python_exe" == None) then
+
+    set python_sources=(`ls | grep Python-`)
+    if ($#python_sources == 0) then
+      set python_sources=None
+    else if ($#python_sources == 1) then
+      set python_sources="$python_sources[1]"
+    else
+      echo "ERROR: Multiple Python source code directories."
+      echo "       Move or remove all but one directory."
+      exit 1
+    endif
+
+    if ("$python_sources" == None) then
+
+      echo "Trying to find a pre-installed Python:"
+      set python_exe=None
+      if (-x "$build/python/bin/python") then
+        "$build/python/bin/python" -V |& head -1
+        if ($status == 0) then
+          set python_exe="$build/python/bin/python"
+        endif
+      endif
+      if ("$python_exe" == None) then
+        python -V |& head -1
+        if ($status == 0) then
+          set python_exe=python
+        endif
+      endif
+      if ("$python_exe" == None) then
+        python2 -V |& head -1
+        if ($status == 0) then
+          set python_exe=python2
+        endif
+      endif
+      if ("$python_exe" == None && -x /usr/bin/python) then
+        /usr/bin/python -V |& head -1
+        if ($status == 0) then
+          set python_exe=/usr/bin/python
+        endif
+      endif
+      if ("$python_exe" != None) then
+        set python_version=(`"$python_exe" -V |& tr "." " "`)
+        if ("$python_version[2]") then
+          set minor=`echo "$python_version[3]" | cut -c-1`
+          if ($minor < 2 || ($minor == 2 && $#python_version == 3)) then
+            echo "A more recent Python version is required (2.2.1 or higher)."
+            set python_exe=None
+          endif
+        endif
+      endif
+      if ("$python_exe" == None) then
+        echo ""
+        echo "Cannot find a Python interpreter."
+        echo ""
+        echo "Please download an installer with Python included"
+        echo "or add a matching Python to the PATH environment variable."
+        echo ""
+        echo "Installation aborted."
+        exit 1
+      endif
+
+    else
+
+      echo "Installing $python_sources from sources"
+      mkdir -p "$build"
+      cd "$build"
+      cd ..
+      cd "$python_sources"
+      set py_install_log="../py_install_log"
+      echo "Configuring Python"
+      ./configure --prefix="$build/python" >& "$py_install_log"
+      echo "Compiling Python. This may take a while."
+      make >>& "$py_install_log"
+      echo "Installing Python"
+      make install >>& "$py_install_log"
+      echo "Done installing Python."
+      cd "$install_root"
+      set python_exe="$build/python/bin/python"
+      "$python_exe" -V
+      if ($status != 0) then
+        echo "ERROR: Python installation failed."
+        echo "Please check the log file for errors:"
+        echo "  $py_install_log"
+        exit 1
+      endif
+
+    endif
+
+  endif
+
+  mkdir -p "$build"
+
+endif
+
+echo ""
+echo "Precompiling all .py files. This may take a minute or two."
+"$python_exe" "$sources/libtbx/libtbx/command_line/py_compile_all.py"
+
+echo ""
+cd "$build"
+echo "Configuring $bundle build directory"
+"$python_exe" "$sources/libtbx/configure.py" --build="$build_mode" mmtbx clipper
+source setpaths_all.csh
+
+if ($have_sources != 0) then
+  echo ""
+  echo "Installing $bundle modules. This may take a while."
+  libtbx.scons -j "$n_cpu_s" .
+endif
+
+set test_py="$BOOST_ADAPTBX_DIST/tst_rational.py"
+if (-f "$test_py") then
+  echo ""
+  echo "Running a selected test"
+  set cmd='libtbx.python "'"$test_py"'"'
+  echo "$cmd"
+  eval $cmd
+endif
+
+cat << EOT
+
+***
+*** csh and tcsh users:
+***     To use this installation in a new shell or process run the command:
+***
+***         source "$LIBTBX_BUILD/setpaths.csh"
+***
+***     You may want to add this line to your .cshrc file.
+***
+*** sh and bash users:
+***     To use this installation in a new shell or process run the command:
+***
+***         . "$LIBTBX_BUILD/setpaths.sh"
+***
+***     You may want to add this line to your .profile or .bashrc file.
+***
+EOT
diff -ruN ccp4-6.0-orig/lib/clipper/clipper/core/derivs.h ccp4-6.0/lib/clipper/clipper/core/derivs.h
--- ccp4-6.0-orig/lib/clipper/clipper/core/derivs.h	2005-09-08 13:07:42.000000000 -0700
+++ ccp4-6.0/lib/clipper/clipper/core/derivs.h	2006-03-22 14:23:46.000000000 -0800
@@ -169,7 +169,7 @@
   template<class T> Curv_orth<T> Curv_frac<T>::curv_orth( const Cell& cell ) const
   {
     Mat33<T> m( cell.matrix_frac() );
-    return Curv_frac<T>( m.transpose() * (*this) * m );
+    return Curv_orth<T>( m.transpose() * (*this) * m );
   }
 
   /*! \param g The grid concerned \return The transformed derivative. */
diff -ruN ccp4-6.0-orig/lib/clipper/clipper/core/derivs.h.orig ccp4-6.0/lib/clipper/clipper/core/derivs.h.orig
--- ccp4-6.0-orig/lib/clipper/clipper/core/derivs.h.orig	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0/lib/clipper/clipper/core/derivs.h.orig	2005-09-08 13:07:42.000000000 -0700
@@ -0,0 +1,211 @@
+/*! \file lib/derivs.h
+    Fundamental types for the clipper libraries
+*/
+//C Copyright (C) 2000-2004 Kevin Cowtan and University of York
+//C Copyright (C) 2000-2005 Kevin Cowtan and University of York
+
+//L   This code is distributed under the terms and conditions of the
+//L   CCP4 Program Suite Licence Agreement as a CCP4 Library.
+//L   A copy of the CCP4 licence can be obtained by writing to the
+//L   CCP4 Secretary, Daresbury Laboratory, Warrington WA4 4AD, UK.
+
+#ifndef CLIPPER_DERIVS
+#define CLIPPER_DERIVS
+
+
+#include "coords.h"
+
+
+namespace clipper
+{
+  template<class T> class Grad_orth;
+  template<class T> class Grad_frac;
+  template<class T> class Grad_map;
+  template<class T> class Curv_orth;
+  template<class T> class Curv_frac;
+  template<class T> class Curv_map;
+
+
+  //! orthogonal (Angstom) gradient, with respect to orthogonal x,y,z
+  template<class T> class Grad_orth : public Vec3<T>
+  {
+  public:
+    Grad_orth() {}                 //!< null constructor
+    explicit Grad_orth( const Vec3<T>& v ) :
+      Vec3<T>( v ) {}          //!< constructor: copy/convert
+    Grad_orth( const T& dx, const T& dy, const T& dz ) :
+      Vec3<T>( dx, dy, dz ) {} //!< constructor: from d/dx,d/dy,d/dz
+    const T& dx() const { return (*this)[0]; }  //!< get d/dx
+    const T& dy() const { return (*this)[1]; }  //!< get d/dy
+    const T& dz() const { return (*this)[2]; }  //!< get d/dz
+    //! orthogonal-fractional derivative conversion
+    Grad_frac<T> grad_frac( const Cell& cell ) const;
+    String format() const;  //!< return formatted String representation
+  };
+
+
+  //! fractional (cell) gradient, with respect to fractional u,v,w
+  template<class T> class Grad_frac : public Vec3<T>
+  {
+  public:
+    Grad_frac() {}                 //!< null constructor
+    explicit Grad_frac( const Vec3<T>& v ) :
+      Vec3<T>( v ) {}          //!< constructor: copy/convert
+    Grad_frac( const T& du, const T& dv, const T& dw ) :
+      Vec3<T>( du, dv, dw ) {} //!< constructor: from d/du,d/dv,d/dw
+    const T& du() const { return (*this)[0]; }  //!< get d/du
+    const T& dv() const { return (*this)[1]; }  //!< get d/dv
+    const T& dw() const { return (*this)[2]; }  //!< get d/dw
+    //! fractional-orthogonal derivative conversion
+    Grad_orth<T> grad_orth( const Cell& cell ) const;
+    //! fractional-grid derivative conversion
+    Grad_map<T> grad_map( const Grid& g ) const;
+    String format() const;  //!< return formatted String representation
+  };
+
+
+  //! map coordinate gradient, with respect to grid u,v,w
+  template<class T> class Grad_map : public Vec3<T>
+  {
+  public:
+    Grad_map() {}                 //!< null constructor
+    explicit Grad_map( const Vec3<T>& v ) :
+      Vec3<T>( v ) {}          //!< constructor: copy/convert
+    Grad_map( const T& du, const T& dv, const T& dw ) :
+      Vec3<T>( du, dv, dw ) {} //!< constructor: from d/du,d/dv,d/dw
+    const T& du() const { return (*this)[0]; }  //!< get d/du
+    const T& dv() const { return (*this)[1]; }  //!< get d/dv
+    const T& dw() const { return (*this)[2]; }  //!< get d/dw
+    //! grid-fractional derivative conversion
+    Grad_frac<T> grad_frac( const Grid& g ) const;
+    String format() const;  //!< return formatted String representation
+  };
+
+
+  //! orthogonal (Angstom) curvatures, with respect to orthogonal x,y,z
+  template<class T> class Curv_orth : public Mat33<T>
+  {
+  public:
+    Curv_orth() {}                 //!< null constructor
+    explicit Curv_orth( const Mat33<T>& m ) :
+      Mat33<T>( m ) {}         //!< constructor: copy/convert
+    //! orthogonal-fractional derivative conversion
+    Curv_frac<T> curv_frac( const Cell& cell ) const;
+  };
+
+
+  //! fractional (cell) curvatures, with respect to fractional u,v,w
+  template<class T> class Curv_frac : public Mat33<T>
+  {
+  public:
+    Curv_frac() {}                 //!< null constructor
+    explicit Curv_frac( const Mat33<T>& m ) :
+      Mat33<T>( m ) {}         //!< constructor: copy/convert
+    //! fractional-orthogonal derivative conversion
+    Curv_orth<T> curv_orth( const Cell& cell ) const;
+    //! fractional-grid derivative conversion
+    Curv_map<T> curv_map( const Grid& g ) const;
+  };
+
+
+  //! map coordinate curvatures, with respect to grid u,v,w
+  template<class T> class Curv_map : public Mat33<T>
+  {
+  public:
+    Curv_map() {}                 //!< null constructor
+    explicit Curv_map( const Mat33<T>& m ) :
+      Mat33<T>( m ) {}         //!< constructor: copy/convert
+    //! grid-fractional derivative conversion
+    Curv_frac<T> curv_frac( const Grid& g ) const;
+  };
+
+
+
+  // template implementations
+
+  /*! The result is an RT operator. This is a redudent representation,
+    but is handy for assembling compound operators.
+    \return The operator */
+  /*! \return The formatted text string */
+  template<class T> String Grad_orth<T>::format() const
+    { return "d/dx,d/dy,d/dz = ("+String(dx())+","+String(dy())+","+String(dz())+")"; }
+
+  /*! \param cell The cell concerned \return The transformed derivative. */
+  template<class T> inline Grad_frac<T> Grad_orth<T>::grad_frac( const Cell& cell ) const
+    { return Grad_frac<T>( (*this) * Mat33<T>( cell.matrix_orth() ) ); }
+
+
+  /*! \return The formatted text string */
+  template<class T> String Grad_frac<T>::format() const
+    { return "d/du,d/dv,d/dw = ("+String(du())+","+String(dv())+","+String(dw())+")"; }
+
+  /*! \param cell The cell concerned \return The transformed derivative. */
+  template<class T> inline Grad_orth<T> Grad_frac<T>::grad_orth( const Cell& cell ) const
+    { return Grad_orth<T>( (*this) * Mat33<T>( cell.matrix_frac() ) ); }
+
+  /*! \param g The grid concerned \return The transformed derivative. */
+  template<class T> inline Grad_map<T> Grad_frac<T>::grad_map( const Grid& g ) const
+    { return Grad_map<T>( du()/g.nu(), dv()/g.nv(), dw()/g.nw() ); }
+
+
+  /*! \return The formatted text string */
+  template<class T> String Grad_map<T>::format() const
+    { return "d/du,d/dv,d/dw = ("+String(du())+","+String(dv())+","+String(dw())+")"; }
+
+  /*! \param g The grid concerned \return The transformed derivative. */
+  template<class T> inline Grad_frac<T> Grad_map<T>::grad_frac( const Grid& g ) const
+    { return Grad_frac<T>( du()*g.nu(), dv()*g.nv(), dw()*g.nw() ); }
+
+
+  /*! \param cell The cell concerned \return The transformed derivative. */
+  template<class T> Curv_frac<T> Curv_orth<T>::curv_frac( const Cell& cell ) const
+  {
+    Mat33<T> m( cell.matrix_orth() );
+    return Curv_frac<T>( m.transpose() * (*this) * m );
+  }
+
+
+  /*! \param cell The cell concerned \return The transformed derivative. */
+  template<class T> Curv_orth<T> Curv_frac<T>::curv_orth( const Cell& cell ) const
+  {
+    Mat33<T> m( cell.matrix_frac() );
+    return Curv_frac<T>( m.transpose() * (*this) * m );
+  }
+
+  /*! \param g The grid concerned \return The transformed derivative. */
+  template<class T> Curv_map<T> Curv_frac<T>::curv_map( const Grid& g ) const
+  {
+    Curv_map<T> c;
+    c(0,0) = (*this)(0,0) / T(g.nu()*g.nu());
+    c(0,1) = (*this)(0,1) / T(g.nu()*g.nv());
+    c(0,2) = (*this)(0,2) / T(g.nu()*g.nw());
+    c(1,0) = (*this)(1,0) / T(g.nv()*g.nu());
+    c(1,1) = (*this)(1,1) / T(g.nv()*g.nv());
+    c(1,2) = (*this)(1,2) / T(g.nv()*g.nw());
+    c(2,0) = (*this)(2,0) / T(g.nw()*g.nu());
+    c(2,1) = (*this)(2,1) / T(g.nw()*g.nv());
+    c(2,2) = (*this)(2,2) / T(g.nw()*g.nw());
+    return c;
+  }
+
+
+  /*! \param g The grid concerned \return The transformed derivative. */
+  template<class T> Curv_frac<T> Curv_map<T>::curv_frac( const Grid& g ) const
+  {
+    Curv_frac<T> c;
+    c(0,0) = (*this)(0,0) * T(g.nu()*g.nu());
+    c(0,1) = (*this)(0,1) * T(g.nu()*g.nv());
+    c(0,2) = (*this)(0,2) * T(g.nu()*g.nw());
+    c(1,0) = (*this)(1,0) * T(g.nv()*g.nu());
+    c(1,1) = (*this)(1,1) * T(g.nv()*g.nv());
+    c(1,2) = (*this)(1,2) * T(g.nv()*g.nw());
+    c(2,0) = (*this)(2,0) * T(g.nw()*g.nu());
+    c(2,1) = (*this)(2,1) * T(g.nw()*g.nv());
+    c(2,2) = (*this)(2,2) * T(g.nw()*g.nw());
+    return c;
+  }
+
+
+} // namespace clipper
+
+#endif
diff -ruN ccp4-6.0-orig/lib/clipper/src/cphasecombine.cpp ccp4-6.0/lib/clipper/src/cphasecombine.cpp
--- ccp4-6.0-orig/lib/clipper/src/cphasecombine.cpp	2005-09-09 03:50:39.000000000 -0700
+++ ccp4-6.0/lib/clipper/src/cphasecombine.cpp	2006-03-22 14:23:16.000000000 -0800
@@ -37,9 +37,9 @@
     } else if ( args[arg] == "-colin-hl-2" ) {
       if ( ++arg < args.size() ) ipcolh2 = args[arg];
     } else if ( args[arg] == "-weight-hl-1" ) {
-      if ( ++arg < args.size() ) hlwt1 = clipper::String(args[arg]).i();
+      if ( ++arg < args.size() ) hlwt1 = clipper::String(args[arg]).f();
     } else if ( args[arg] == "-weight-hl-2" ) {
-      if ( ++arg < args.size() ) hlwt2 = clipper::String(args[arg]).i();
+      if ( ++arg < args.size() ) hlwt2 = clipper::String(args[arg]).f();
     } else if ( args[arg] == "-colout" ) {
       if ( ++arg < args.size() ) opcol = args[arg];
     } else {
diff -ruN ccp4-6.0-orig/lib/clipper/src/pirancslib.cpp ccp4-6.0/lib/clipper/src/pirancslib.cpp
--- ccp4-6.0-orig/lib/clipper/src/pirancslib.cpp	2005-10-14 02:37:23.000000000 -0700
+++ ccp4-6.0/lib/clipper/src/pirancslib.cpp	2006-03-22 14:26:18.000000000 -0800
@@ -1083,9 +1083,9 @@
     Local_rtop rtinv = ncsops[i].inverse();
     int j;
     for ( j = 0; j < ncsopsi.size(); j++ )
-      if ( rtinv.symm_match( ncsops[j], spgr, cell, tol_dst_, tol_ang_ ).first
+      if ( rtinv.symm_match( ncsopsi[j], spgr, cell, tol_dst_, tol_ang_ ).first
 	   < 2.0 ) break;
-    if ( j == ncsopsi.size() ) ncsopsi.push_back( ncsops[j] );
+    if ( j == ncsopsi.size() ) ncsopsi.push_back( ncsops[i] );
   }
   return ncsopsi;
 }
diff -ruN ccp4-6.0-orig/lib/fftw/configure ccp4-6.0/lib/fftw/configure
--- ccp4-6.0-orig/lib/fftw/configure	2006-01-11 04:52:05.000000000 -0800
+++ ccp4-6.0/lib/fftw/configure	2006-02-26 08:24:31.000000000 -0800
@@ -1907,7 +1907,8 @@
   enableval="$enable_shared"
   p=${PACKAGE-default}
     case $enableval in
-    yes) enable_shared=yes ;;
+    # brute force it not to build shared fftw libs
+    yes) enable_shared=no ;;
     no) enable_shared=no ;;
     *)
       enable_shared=no
@@ -1916,7 +1917,7 @@
       for pkg in $enableval; do
 	IFS="$lt_save_ifs"
 	if test "X$pkg" = "X$p"; then
-	  enable_shared=yes
+	  enable_shared=no
 	fi
       done
       IFS="$lt_save_ifs"
diff -ruN ccp4-6.0-orig/lib/src/ccplib.f ccp4-6.0/lib/src/ccplib.f
--- ccp4-6.0-orig/lib/src/ccplib.f	2005-09-08 08:17:41.000000000 -0700
+++ ccp4-6.0/lib/src/ccplib.f	2006-03-22 14:21:46.000000000 -0800
@@ -16,7 +16,7 @@
 C     amalgamate ccppsf and fdir/fext/froot.  also add tests of these
 C     routines to testlib.
 C
-C     $Id: ccplib.f,v 1.102 2005/09/08 15:17:41 mdw Exp $
+C     $Id: ccplib.f,v 1.103 2006/02/27 15:26:20 ccb Exp $
 C
 C      CCFILL    Set specified number of elements of byte array
 C      CCPALC    Call subroutine with allocated memory
@@ -1307,7 +1307,7 @@
       INTEGER GETPID,LENSTR
       LOGICAL VAXVMS, WINMVS
       CHARACTER FDIR* (ISTRLN),FEXTN* (ISTRLN),FROOT* (ISTRLN), RTNBKS
-      EXTERNAL GETPID,LENSTR,VAXVMS,FDIR,FEXTN,FROOT
+      EXTERNAL LENSTR,VAXVMS,FDIR,FEXTN,FROOT
 C     ..
 C     .. External Subroutines ..
       EXTERNAL CCPERR,UGTARG,QPRINT,UGTENV,USTENV
diff -ruN ccp4-6.0-orig/src/geomcalc.f ccp4-6.0/src/geomcalc.f
--- ccp4-6.0-orig/src/geomcalc.f	2005-09-06 04:25:14.000000000 -0700
+++ ccp4-6.0/src/geomcalc.f	2006-03-22 14:25:22.000000000 -0800
@@ -157,7 +157,7 @@
 c=============================================================
 c
       call ccpfyp
-      call ccprcs (6, 'GEOMCALC', '$Date: 2005/09/06 11:25:14 $')
+      call ccprcs (6, 'GEOMCALC', '$Date: 2006/02/28 15:46:26 $')
       call XYZINIT
       lunout = 6
 c
@@ -336,7 +336,7 @@
       write (6,'(/,a,i6,a,/)')
      $   ' Plane fitted to ', natpln(iplane),' atoms'
       write (6, '(a,/,a,/)')
-     $   ' "Thickness" is RMS deviation along principle axis, ',
+     $   ' "Thickness" is RMS deviation along principal axis, ',
      $   ' Radii are in plane perpendicular to axis'
       write (6, '(a)')
      $   ' Axis           Axes          Centre Thickness Radii'
@@ -405,7 +405,7 @@
 c
 c  TRANSFORM
 c    Apply transformation to put whole molecule into frame of plane
-c (principle axes along x,y,z, normal along z)
+c (principal axes along x,y,z, normal along z)
 c
  300  if (natpln(iplane) .le. 0) then
          call ccperr(2,' *** No plane fitted ***')
@@ -827,8 +827,11 @@
       common /cmolec/ atname_mol(maxat), restyp_mol(maxat),
      $   chain_mol(maxat)
       character atname_mol*4, restyp_mol*4, chain_mol*4
+      
+      common /dmolec/ segid_mol(maxat), id_mol(maxat)
+      character segid_mol*4, id_mol*4
 c
-      save /molec/, /cmolec/
+      save /molec/, /cmolec/, /dmolec/
 c
 c=========================================================================
       
@@ -903,6 +906,8 @@
       do 30 i=1,6
         b_mol(i,nat) = b(i)
   30  continue
+      segid_mol(nat) = segid
+      id_mol(nat) = id
 c
 c
 c Store chain as left-justified *4
@@ -951,7 +956,10 @@
      $   chain_mol(maxat)
       character atname_mol*4, restyp_mol*4, chain_mol*4
 c
-      save /molec/, /cmolec/
+      common /dmolec/ segid_mol(maxat), id_mol(maxat)
+      character segid_mol*4, id_mol*4
+c      
+      save /molec/, /cmolec/, /dmolec/
 c
 c=========================================================================
       
@@ -959,6 +967,8 @@
 c
       integer i, ixyzin, ixyzout, k
       real xx, yy, zz, occ, b(6)
+      character resno*4, inscod*1, altcod*1
+      integer iz
 c
       istat = +1
 
@@ -987,6 +997,9 @@
            b(i) = b_mol(i,k)
  20      continue
 
+         call XYZATOM(IXYZOUT,k,atname_mol(k),restyp_mol(k),
+     $    chain_mol(k),numres_mol(k),resno,inscod,altcod,segid_mol(k),
+     $    iz,id_mol(k))
          call XYZCOORD(IXYZOUT,'O','B',xx,yy,zz,occ,biso,b)
          call XYZADVANCE(IXYZOUT,0,0,*30,*30)
  10   continue
@@ -1236,7 +1249,7 @@
 c    spec*(*)     atom specification
 c
 c On exit:
-c    chain        chain ID, left-justfied, unchanged if absent
+c    chain        chain ID, left-justified, unchanged if absent
 c    iresidue     residue number, , unchanged if absent
 c    atname       atom name, left-justified
 c    istat        = 0 OK, = -1 illegal format
@@ -1291,7 +1304,7 @@
      $   plane_normal, cofg, rmat, thickness, radii, radius, istat)
 c     =============================================================
 c
-c  Fit atoms to plane, from principle axes of inertia matrix
+c  Fit atoms to plane, from principal axes of inertia matrix
 c
 c On entry:
 c   xyz(3,nat)     atom coordinates
@@ -1306,9 +1319,9 @@
 c   cofg(3)        centre of gravity of plane
 c   rmat(3,3)      rotation matrix to rotate into plane coordinates
 c                  (plane normal along z)
-c   thickness(3)   "thickness" = weighted rms deviation along principle axes
+c   thickness(3)   "thickness" = weighted rms deviation along principal axes
 c   radii(3)       "radii" = weighted rms deviation in plane perpendicular
-c                  to principle axes
+c                  to principal axes
 c   radius         rms radius
 c   istat          = 0 OK, = -1 failure (too few atoms)
 c
@@ -1365,7 +1378,7 @@
 c
       call eign3(a, vmat, resid)
 c resid      eigenvalues of residual matrix, in descending order
-c            = sums of weighted squared residuals along principle directions
+c            = sums of weighted squared residuals along principal directions
 c vmat(i,j)  eigenvector matrix
 c            column vmat(.,3) is the plane normal
 c
@@ -1699,7 +1712,7 @@
 C                       (Leading spaces ignored; further space terminates
 C                        the number string interpreted)
 C      FP       (W)     Returns the value as a floating point value (0.0 if
-C                       synatx error)
+C                       syntax error)
 C      IV       (W)     Returns the value as an integer (the nearest integer
 C                       if value contained a decimal point) (0 if syntax error)
 C
