--- scilab-2.6/imp/Slatexpr2.c	Fri Apr 16 09:03:50 1999
+++ scilab-2.6/imp/Slatexpr2.c	Tue Jul 24 09:54:53 2001
@@ -4,7 +4,9 @@
 #include <string.h>
 #include <ctype.h>
 #ifndef __STDC__
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif 
 #include <stdio.h>
 
--- scilab-2.6/imp/Slatexprs.c	Fri Apr 16 09:03:50 1999
+++ scilab-2.6/imp/Slatexprs.c	Tue Jul 24 09:54:54 2001
@@ -3,7 +3,9 @@
 #include <string.h>
 #include <ctype.h>
 #ifndef __STDC__
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif 
 #include <stdio.h>
 
--- scilab-2.6/imp/Slpr.c	Mon Feb  5 05:34:01 2001
+++ scilab-2.6/imp/Slpr.c	Tue Jul 24 09:54:54 2001
@@ -4,7 +4,9 @@
 #include <string.h>
 #include <ctype.h>
 #ifndef __STDC__
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif 
 #include <stdio.h>
 
--- scilab-2.6/intersci/intersci-n.h	Mon Feb  5 05:34:58 2001
+++ scilab-2.6/intersci/intersci-n.h	Tue Jul 24 09:54:54 2001
@@ -25,7 +25,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else 
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 /* FORTRAN variable types */ 
--- scilab-2.6/intersci/intersci.h	Mon Feb  5 05:34:58 2001
+++ scilab-2.6/intersci/intersci.h	Tue Jul 24 09:54:54 2001
@@ -25,7 +25,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else 
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 /* FORTRAN variable types */ 
--- scilab-2.6/routines/calelm/sci_tools.c	Mon Jul 10 02:12:40 2000
+++ scilab-2.6/routines/calelm/sci_tools.c	Tue Jul 24 10:01:50 2001
@@ -39,8 +39,13 @@
 
 ***/
 #include "../machine.h"
+#ifdef __APPLE__
+#include <sys/types.h>
+#endif
 #ifndef __ABSC__
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #else
 #include <stdlib.h>
 #endif
--- scilab-2.6/routines/comm/messages.c	Thu Jan 28 03:00:31 1999
+++ scilab-2.6/routines/comm/messages.c	Tue Jul 24 09:56:40 2001
@@ -3,7 +3,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 #include <stdio.h>
 #include <string.h>
--- scilab-2.6/routines/default/Funtab.c	Mon Feb  5 05:19:39 2001
+++ scilab-2.6/routines/default/Funtab.c	Tue Jul 24 09:56:20 2001
@@ -9,7 +9,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #include "../machine.h"
--- scilab-2.6/routines/default/scimem.c	Fri May  7 03:00:38 1999
+++ scilab-2.6/routines/default/scimem.c	Tue Jul 24 09:56:20 2001
@@ -4,7 +4,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #include "../machine.h"
--- scilab-2.6/routines/graphics/Math.h	Mon Feb  5 05:19:43 2001
+++ scilab-2.6/routines/graphics/Math.h	Tue Jul 24 09:56:21 2001
@@ -11,7 +11,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #ifdef WIN32 
--- scilab-2.6/routines/graphics/periFig.c	Mon Feb  5 05:19:37 2001
+++ scilab-2.6/routines/graphics/periFig.c	Tue Jul 24 09:56:21 2001
@@ -16,7 +16,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 
--- scilab-2.6/routines/graphics/periGif.c	Mon Feb  5 05:19:36 2001
+++ scilab-2.6/routines/graphics/periGif.c	Tue Jul 24 09:56:22 2001
@@ -38,7 +38,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 extern  char  *getenv();
 #endif
 
--- scilab-2.6/routines/graphics/periPos.c	Mon Feb  5 05:19:36 2001
+++ scilab-2.6/routines/graphics/periPos.c	Tue Jul 24 09:56:23 2001
@@ -16,7 +16,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 
--- scilab-2.6/routines/graphics/RecLoad.c	Mon Feb  5 08:16:26 2001
+++ scilab-2.6/routines/graphics/RecLoad.c	Tue Jul 24 09:56:21 2001
@@ -12,7 +12,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #ifdef macintosh
--- scilab-2.6/routines/libcomm/gest_memoire.c	Tue Apr 14 04:22:51 1998
+++ scilab-2.6/routines/libcomm/gest_memoire.c	Tue Jul 24 09:56:23 2001
@@ -8,7 +8,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #include "gestion_memoire.h"
--- scilab-2.6/routines/metanet/connex.c	Mon Jun 22 05:13:00 1998
+++ scilab-2.6/routines/metanet/connex.c	Tue Jul 24 09:56:23 2001
@@ -2,7 +2,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 extern void cerro();
--- scilab-2.6/routines/metanet/dmtree.c	Mon Jun 22 05:13:00 1998
+++ scilab-2.6/routines/metanet/dmtree.c	Tue Jul 24 09:56:23 2001
@@ -3,7 +3,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 extern void cerro();
--- scilab-2.6/routines/metanet/files.c	Tue Nov  9 06:25:56 1999
+++ scilab-2.6/routines/metanet/files.c	Tue Jul 24 09:56:23 2001
@@ -9,7 +9,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 
--- scilab-2.6/routines/metanet/loadg.c	Tue Nov  9 06:25:56 1999
+++ scilab-2.6/routines/metanet/loadg.c	Tue Jul 24 09:56:24 2001
@@ -9,7 +9,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #if (defined __MSC__) || (defined __ABSC__)
--- scilab-2.6/routines/metanet/metanet.c	Tue Nov  9 06:57:24 1999
+++ scilab-2.6/routines/metanet/metanet.c	Tue Jul 24 09:56:24 2001
@@ -13,7 +13,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #include "../libcomm/libCalCom.h"
--- scilab-2.6/routines/metanet/myhsearch.c	Mon Jun 22 05:13:01 1998
+++ scilab-2.6/routines/metanet/myhsearch.c	Tue Jul 24 09:56:24 2001
@@ -21,7 +21,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 
--- scilab-2.6/routines/metanet/paths.c	Mon Jun 22 05:13:00 1998
+++ scilab-2.6/routines/metanet/paths.c	Tue Jul 24 09:56:24 2001
@@ -4,7 +4,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 
--- scilab-2.6/routines/metanet/saveg.c	Tue Nov  9 06:25:56 1999
+++ scilab-2.6/routines/metanet/saveg.c	Tue Jul 24 09:56:24 2001
@@ -9,7 +9,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #if (defined __MSC__) || (defined __ABSC__) 
--- scilab-2.6/routines/metanet/show.c	Tue Nov  9 06:25:56 1999
+++ scilab-2.6/routines/metanet/show.c	Tue Jul 24 09:56:25 2001
@@ -4,7 +4,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #ifdef __ABSC__
--- scilab-2.6/routines/metanet/transc.c	Mon Jun 22 05:13:00 1998
+++ scilab-2.6/routines/metanet/transc.c	Tue Jul 24 09:56:25 2001
@@ -2,7 +2,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 
--- scilab-2.6/routines/pvm/sci_tools.c	Tue Nov  9 06:25:57 1999
+++ scilab-2.6/routines/pvm/sci_tools.c	Tue Jul 24 09:56:25 2001
@@ -40,7 +40,9 @@
 ***/
 #include "../machine.h"
 #ifndef __ABSC__
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #else
 #include <stdlib.h>
 #endif
--- scilab-2.6/routines/sound/fileio.c	Tue Feb 13 07:42:17 2001
+++ scilab-2.6/routines/sound/fileio.c	Tue Jul 24 09:56:26 2001
@@ -14,7 +14,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else 
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 #include <string.h>
 
--- scilab-2.6/routines/sparse/spDefs.h	Tue Nov  9 06:25:58 1999
+++ scilab-2.6/routines/sparse/spDefs.h	Tue Jul 24 09:56:26 2001
@@ -441,7 +441,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #define ALLOC(type,number)  ((type *)malloc((unsigned)(sizeof(type)*(number))))
--- scilab-2.6/routines/sun/addinter.c	Wed Feb 28 03:10:14 2001
+++ scilab-2.6/routines/sun/addinter.c	Tue Jul 24 09:56:26 2001
@@ -21,7 +21,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #define OK 1
--- scilab-2.6/routines/sun/h_help_data.c	Mon Feb  5 05:19:34 2001
+++ scilab-2.6/routines/sun/h_help_data.c	Tue Jul 24 09:56:26 2001
@@ -13,7 +13,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 extern  char  *getenv();
 #endif
 
--- scilab-2.6/routines/sun/link.c	Mon Feb  5 05:19:34 2001
+++ scilab-2.6/routines/sun/link.c	Tue Jul 24 09:56:27 2001
@@ -18,7 +18,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 static void Underscores __PARAMS((int isfor,char *ename,char *ename1));
--- scilab-2.6/routines/sun/men_Sutils.c	Mon Feb  5 05:19:33 2001
+++ scilab-2.6/routines/sun/men_Sutils.c	Tue Jul 24 09:56:27 2001
@@ -6,7 +6,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #define MALLOC(x) malloc(((unsigned) x))
--- scilab-2.6/routines/wsci/runscilab.c	Fri Mar  9 03:40:04 2001
+++ scilab-2.6/routines/wsci/runscilab.c	Tue Jul 24 09:56:27 2001
@@ -24,7 +24,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #ifdef __MSC__
--- scilab-2.6/routines/wsci/winmain.c	Mon Oct 23 03:16:30 2000
+++ scilab-2.6/routines/wsci/winmain.c	Tue Jul 24 09:56:27 2001
@@ -39,7 +39,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #ifdef __MSC__
--- scilab-2.6/routines/wsci/wmprint.c	Mon Feb  5 05:19:33 2001
+++ scilab-2.6/routines/wsci/wmprint.c	Tue Jul 24 09:56:28 2001
@@ -5,7 +5,9 @@
 #include <string.h>
 #include <ctype.h>
 #ifndef __STDC__
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 #include <stdio.h>
 
--- scilab-2.6/routines/wsci/wmtex.c	Mon Feb  5 05:19:33 2001
+++ scilab-2.6/routines/wsci/wmtex.c	Tue Jul 24 09:56:28 2001
@@ -3,7 +3,9 @@
 #include <string.h>
 #include <ctype.h>
 #ifndef __STDC__
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 #include <stdio.h>
 
--- scilab-2.6/routines/xsci/jpc_coloredit.c	Mon Feb  5 05:19:33 2001
+++ scilab-2.6/routines/xsci/jpc_coloredit.c	Tue Jul 24 09:56:29 2001
@@ -9,7 +9,9 @@
 #include "wf_w_setup.h"
 
 #include <string.h> /* in case of dmalloc */ 
+#ifndef __APPLE__
 #include <malloc.h>  /* in case of dmalloc */ 
+#endif
 
 #include "../machine.h"
 #include "All-extern.h"
--- scilab-2.6/routines/xsci/jpc_command.c	Mon Feb  5 05:19:32 2001
+++ scilab-2.6/routines/xsci/jpc_command.c	Tue Jul 24 09:56:29 2001
@@ -35,7 +35,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #include "jpc_global.h"
--- scilab-2.6/routines/xsci/jpc_SGraph.c.in	Mon Feb  5 05:29:03 2001
+++ scilab-2.6/routines/xsci/jpc_SGraph.c.in	Tue Jul 24 09:56:29 2001
@@ -23,7 +23,9 @@
 #include <X11/@XAW@/ViewportP.h>
 
 #include <string.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 /** getpid **/
 #ifdef __STDC__
 #include <stdlib.h>
--- scilab-2.6/routines/xsci/jpc_SGraph.c	Tue Apr 24 07:49:17 2001
+++ scilab-2.6/routines/xsci/jpc_SGraph.c	Tue Jul 24 09:56:28 2001
@@ -23,7 +23,9 @@
 #include <X11/Xaw/ViewportP.h>
 
 #include <string.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 /** getpid **/
 #ifdef __STDC__
 #include <stdlib.h>
--- scilab-2.6/routines/xsci/jpc_utils.c	Tue May  5 07:17:05 1998
+++ scilab-2.6/routines/xsci/jpc_utils.c	Tue Jul 24 09:56:29 2001
@@ -44,7 +44,9 @@
 
 #include "jpc_global.h"
 #include <string.h> /* in case of dmalloc */ 
+#ifndef __APPLE__
 #include <malloc.h>  /* in case of dmalloc */ 
+#endif
 
 void DisableWindowResize(w)
 Widget w;
--- scilab-2.6/routines/xsci/jpc_Xloop.c	Mon Feb  5 05:19:33 2001
+++ scilab-2.6/routines/xsci/jpc_Xloop.c	Tue Jul 24 09:56:29 2001
@@ -17,7 +17,9 @@
 #ifdef __STDC__
 #include <stdlib.h>
 #else
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #include "../graphics/Math.h"
--- scilab-2.6/routines/xsci/wf_e_edit.c	Tue May  5 07:17:54 1998
+++ scilab-2.6/routines/xsci/wf_e_edit.c	Tue Jul 24 09:56:30 2001
@@ -20,7 +20,9 @@
 #include "wf_w_util.h"
 
 #include <string.h> /* in case of dmalloc */ 
+#ifndef __APPLE__
 #include <malloc.h>  /* in case of dmalloc */ 
+#endif
 
 DeclareArgs(1);
 
--- scilab-2.6/routines/xsci/wf_w_dir.c	Mon Feb  5 05:19:32 2001
+++ scilab-2.6/routines/xsci/wf_w_dir.c	Tue Jul 24 09:56:30 2001
@@ -56,7 +56,9 @@
 #endif
 
 #if !defined(freebsd)
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #endif
 
 #include "../machine.h"
--- scilab-2.6/routines/xsci/wf_w_file.c	Mon Feb  5 05:19:32 2001
+++ scilab-2.6/routines/xsci/wf_w_file.c	Tue Jul 24 09:56:30 2001
@@ -24,7 +24,9 @@
 #include "wf_w_util.h"
 #include "wf_w_setup.h"
 
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 #include "../machine.h"
 #include "All-extern.h"
--- scilab-2.6/routines/xsci/x_button.c	Mon Feb  5 05:19:32 2001
+++ scilab-2.6/routines/xsci/x_button.c	Tue Jul 24 09:56:31 2001
@@ -44,7 +44,9 @@
 #include "All-extern-x.h"
 
 #include <string.h> /* in case of dbmalloc */
+#ifndef __APPLE__
 #include <malloc.h> 
+#endif
 
 
 #define KeyState(x) (((x) & (ShiftMask|ControlMask)) + (((x) & Mod1Mask) ? 2 : 0))
--- scilab-2.6/routines/xsci/x_charproc.c	Mon Feb  5 05:19:32 2001
+++ scilab-2.6/routines/xsci/x_charproc.c	Tue Jul 24 09:56:31 2001
@@ -59,7 +59,9 @@
 #endif
 
 #include <string.h> /* in case of dmalloc */ 
+#ifndef __APPLE__
 #include <malloc.h>  /* in case of dmalloc */ 
+#endif
 
 #ifdef WITH_TK
 #include "../tksci/tksci.h"
--- scilab-2.6/routines/xsci/x_screen.c	Tue Jul 24 09:58:14 2001
+++ scilab-2.6/routines/xsci/x_screen.c	Tue Jul 24 10:01:41 2001
@@ -27,7 +27,12 @@
 
 /* screen.c */
 
+#ifdef __APPLE__
+#include "sys/types.h"
+#endif
+#ifndef __APPLE__
 #include "malloc.h"
+#endif
 
 #include "x_ptyxP.h"
 #include "x_error.h"
--- scilab-2.6/routines/xsci/x_screen.nok.c	Tue May  5 07:23:45 1998
+++ scilab-2.6/routines/xsci/x_screen.nok.c	Tue Jul 24 09:56:31 2001
@@ -33,7 +33,9 @@
 
 #include <stdio.h>
 
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 /*
    allocates memory for a 2-dimensional array of chars and returns a pointer
--- scilab-2.6/routines/xsci/x_scrollbar.c	Tue May  5 07:23:57 1998
+++ scilab-2.6/routines/xsci/x_scrollbar.c	Tue Jul 24 09:56:32 2001
@@ -29,7 +29,9 @@
 
 #include <stdio.h>
 #include <ctype.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #ifdef __STDC__
 #include <stdlib.h>
 #endif
--- scilab-2.6/routines/xsci/x_test_loop.c	Mon Feb  5 05:19:31 2001
+++ scilab-2.6/routines/xsci/x_test_loop.c	Tue Jul 24 09:56:32 2001
@@ -39,7 +39,9 @@
 extern int demo_menu_activate;
 
 #include <string.h> /* in case of dmalloc */ 
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 
 int main(argc, argv)
--- scilab-2.6/xless/xless.h	Tue Apr 21 09:00:53 1998
+++ scilab-2.6/xless/xless.h	Tue Jul 24 09:54:55 2001
@@ -63,7 +63,9 @@
 #  include <X11/Xaw/Paned.h>
 #  include <X11/Xaw/Form.h>
 
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 /* Useful defines */
 
--- scilab-2.6/xmetanet/comm.c	Wed Aug 26 05:15:14 1998
+++ scilab-2.6/xmetanet/comm.c	Tue Jul 24 09:54:55 2001
@@ -2,7 +2,9 @@
 #include <X11/Intrinsic.h>
 #include <stdio.h>
 #include <string.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 #include "defs.h"
 #include "metaconst.h"
--- scilab-2.6/xmetanet/dialog.c	Mon May  4 09:51:58 1998
+++ scilab-2.6/xmetanet/dialog.c	Tue Jul 24 09:54:55 2001
@@ -8,7 +8,9 @@
 #include <X11/Xaw/Label.h>
 #include <X11/Xaw/Viewport.h>
 
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #include <stdio.h>
 
 #include "metaconst.h"
--- scilab-2.6/xmetanet/file.c	Mon May  4 09:52:03 1998
+++ scilab-2.6/xmetanet/file.c	Tue Jul 24 10:02:38 2001
@@ -1,6 +1,11 @@
 /* Copyright INRIA */
 #include <string.h>
+#ifdef __APPLE__
+#include <sys/types.h>
+#endif
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 char *StripGraph(name)
 char *name;
--- scilab-2.6/xmetanet/graph.c	Sun Mar 21 09:45:00 1999
+++ scilab-2.6/xmetanet/graph.c	Tue Jul 24 09:54:56 2001
@@ -1,7 +1,9 @@
 /* Copyright INRIA */
 #include <X11/Intrinsic.h>
 #include <string.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #include <stdio.h>
 
 #include "defs.h"
--- scilab-2.6/xmetanet/graphics.c	Sat Mar 20 11:03:15 1999
+++ scilab-2.6/xmetanet/graphics.c	Tue Jul 24 09:54:56 2001
@@ -1,7 +1,9 @@
 /* Copyright INRIA */
 #include <X11/Intrinsic.h>
 #include <math.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #include <string.h>
 #include <stdio.h>
 
--- scilab-2.6/xmetanet/list.c	Mon May  4 09:52:15 1998
+++ scilab-2.6/xmetanet/list.c	Tue Jul 24 10:03:19 2001
@@ -1,6 +1,11 @@
 /* Copyright INRIA */
 #include <string.h>
+#ifdef __APPLE__
+#include <sys/types.h>
+#endif
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 #include "list.h"
 #include "graph.h"
--- scilab-2.6/xmetanet/load.c	Sun Mar 21 09:43:07 1999
+++ scilab-2.6/xmetanet/load.c	Tue Jul 24 09:54:56 2001
@@ -3,7 +3,9 @@
 #include <dirent.h>
 #include <stdio.h>
 #include <string.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #include <math.h>
 
 #include "mysearch.h"
--- scilab-2.6/xmetanet/myhsearch.c	Mon May  4 09:52:24 1998
+++ scilab-2.6/xmetanet/myhsearch.c	Tue Jul 24 10:03:55 2001
@@ -19,7 +19,12 @@
 Cambridge, MA 02139, USA.  */
 
 #include <string.h>
+#ifdef __APPLE__
+#include <sys/types.h>
+#endif
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 #include "mysearch.h"
 
--- scilab-2.6/xmetanet/name.c	Sat Mar 20 10:36:12 1999
+++ scilab-2.6/xmetanet/name.c	Tue Jul 24 09:54:57 2001
@@ -1,6 +1,8 @@
 /* Copyright INRIA */
 #include <X11/Intrinsic.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 
 #include "metaconst.h"
 #include "list.h"
diff -r -u scilab-2.6/Makefile.incl.in scilab-2.6/Makefile.incl.in
--- scilab-2.6/Makefile.incl.in	Fri Aug 18 13:12:14 2000
+++ scilab-2.6/Makefile.incl.in	Wed Apr 18 23:41:00 2001
@@ -12,8 +12,9 @@
 
 RANLIB = @RANLIB@
 
-TERMCAPLIB = @TERMCAPLIB@
-
+# MacOSX
+# TERMCAPLIB = @TERMCAPLIB@
+TERMCAPLIB =
 ##################################################################
 # NOTE: the following schemes for compiling and linking are not  #
 #       exactly used for the main executable scilex; for it, see #
@@ -67,7 +68,9 @@
 XAW_LOCAL_LIB = @XAW_LOCAL_LIB@
 XFLAGS = @X_CFLAGS@ @XAW_LOCAL_INCLUDES@
 X_EXTRA_LIBS = @X_EXTRA_LIBS@
-XLIBS = @X_LIBS@ $(XAWLIB) $(XMULIB) -lXt -lXext @X_PRE_LIBS@ -lX11 $(X_EXTRA_LIBS)
+# MacOSX
+# XLIBS = @X_LIBS@ $(XAWLIB) $(XMULIB) -lXt -lXext @X_PRE_LIBS@ -lX11 $(X_EXTRA_LIBS)
+XLIBS = -force_flat_namespace @X_LIBS@ $(XAWLIB) $(XMULIB) -lXpm -lXt -lXext @X_PRE_LIBS@ -lX11 $(X_EXTRA_LIBS)
 
 #####################
 # TCL/TK
diff -r -u scilab-2.6/routines/sound/st.h scilab-2.6/routines/sound/st.h
--- scilab-2.6/routines/sound/st.h	Mon Feb  5 13:19:40 2001
+++ scilab-2.6/routines/sound/st.h	Wed Apr 18 23:41:01 2001
@@ -11,7 +11,7 @@
  * Lance Norskog And Sundry Contributors are not responsible for 
  * the consequences of using this software.
  */
-#if (defined(netbsd) || defined(freebsd)) && !defined(unix) 
+#if (defined(netbsd) || defined(freebsd) || defined(__APPLE__)) && !defined(unix) 
 #define unix
 #endif
 
diff -r -u scilab-2.6/routines/sparse/spConfig.h scilab-2.6/routines/sparse/spConfig.h
--- scilab-2.6/routines/sparse/spConfig.h	Thu Jan 28 10:59:11 1999
+++ scilab-2.6/routines/sparse/spConfig.h	Wed Apr 18 23:41:01 2001
@@ -413,8 +413,8 @@
  */
 
 /* Begin machine constants. */
-
-#ifdef notdef /* __STDC__ */
+/* MacOSX has working __STDC__ */
+#ifdef __APPLE__ /* notdef*/ /* __STDC__ */
 /*
  * This code is currently deleted because most ANSI standard C compilers
  * do not provide the standard header files yet.
diff -r -u scilab-2.6/routines/xsci/wf_fig.h scilab-2.6/routines/xsci/wf_fig.h
--- scilab-2.6/routines/xsci/wf_fig.h	Thu Jan 28 11:00:16 1999
+++ scilab-2.6/routines/xsci/wf_fig.h	Wed Apr 18 23:41:01 2001
@@ -51,7 +51,7 @@
 #if !defined(__bsdi__) && !defined(__NetBSD__)
 extern int	errno;
 extern int	sys_nerr;
-#if (! (defined(BSD) && (BSD >= 199306))) && !defined(freebsd)
+#if (! (defined(BSD) && (BSD >= 199306))) && !defined(freebsd) && !defined(__APPLE__)
 extern char    *sys_errlist[];
 #endif
 #endif
diff -r -u scilab-2.6/routines/xsci/x_misc.c scilab-2.6/routines/xsci/x_misc.c
--- scilab-2.6/routines/xsci/x_misc.c	Tue Aug 17 10:46:52 1999
+++ scilab-2.6/routines/xsci/x_misc.c	Wed Apr 18 23:41:01 2001
@@ -512,7 +512,7 @@
 #if !defined(__bsdi__) && !defined(__NetBSD__)
 extern int	errno;
 extern int	sys_nerr;
-#if (! (defined(BSD) && (BSD >= 199306))) && !defined(freebsd)
+#if (! (defined(BSD) && (BSD >= 199306))) && !defined(freebsd) && !defined(__APPLE__)
 extern char    *sys_errlist[];
 #endif
 #endif
--- scilab-2.6/configure	Mon Mar 26 05:10:37 2001
+++ scilab-2.6/configure	Wed Jul 18 07:22:17 2001
@@ -2525,6 +2525,35 @@
     WINXFLAGS='-I../xdr'
     MAKEFILE_TARGET=Makefile.gcwin32
     ;;
+
+# Darwin/MacOSX (Not supported by INRIA)
+  *-*-darwin*)
+     GCC=yes
+     CC=cc
+     CC_OPTIONS='-no-cpp-precomp -O2'
+     CC_LDFLAGS=
+     CC_PICFLAGS='-fPIC'
+     # script shell f77 have bugs, get ours
+     FC=g77
+     FC_OPTIONS='-O2'
+     FC_OPTIONS_O0=
+     FC_LDFLAGS=
+     FC_PICFLAGS='-fPIC'
+     LD=ld
+     LD_LDFLAGS=
+     if test "$enable_debug" = yes; then
+       CC_OPTIONS='-g '
+       FC_OPTIONS=-g
+     fi
+     if test "$G77" = yes; then
+       FC=g77
+     fi
+   # Dyn. loading - ????
+   # DLDLIB=
+   # DLD_SUBDIR= 
+    MAKEFILE_TARGET=Makefile.darwin
+    ;;
+
 # FreeBSD  systems (not supported by INRIA)
   *-*-freebsd*)
      GCC=yes
@@ -4817,7 +4846,7 @@
 TCL_LIB_OK=0
 
 dirs="$USER_TCL_LIB_PATH /lib /usr/lib /usr/lib/tcl /usr/lib/tcl8.* /shlib /shlib/tcl /shlib/tcl8.* /usr/shlib /shlib/tcl /usr//shlib/tcl8.* /usr/local/lib /usr/local/lib/tcl /usr/local/lib/tcl8.* /usr/local/shlib /usr/X11/lib/tcl /usr/X11/lib/tcl8.* /usr/lib/X11 /usr/lib/X11/tcl /usr/lib/X11/tcl8.* ../lib ../../lib  /usr/local/tcl /usr/tcl /usr/tcl/lib /usr/local/tcl/lib ."
-libexts="so so.1.0 sl a"
+libexts="dylib so so.1.0 sl a"
 libnames="tcl$CHK_TCL_MAJ.$CHK_TCL_MIN tcl.$CHK_TCL_MAJ.$CHK_TCL_MIN tcl$CHK_TCL_MAJ$CHK_TCL_MIN tcl.$CHK_TCL_MAJ$CHK_TCL_MIN"
 for e in $libexts; do
 for j in $dirs; do
@@ -5032,7 +5061,7 @@
 CHK_TK_MAJ=$tkmajor
 CHK_TK_MIN=$tkminor
 dirs="$USER_TK_LIB_PATH /lib /usr/lib /usr/lib/tk /usr/lib/tk8.* /shlib /shlib/tk /shlib/tk8.* /usr/shlib /shlib/tk /usr/shlib/tk8.* /usr/local/lib /usr/local/lib/tk /usr/local/lib/tk8.* /usr/local/shlib /usr/X11/lib/tk /usr/X11/lib/tk8.*  /usr/lib/X11 /usr/lib/X11/tk /usr/lib/X11/tk8.* ../lib ../../lib /usr/tk /usr/local/tk /usr/local/tk/lib /usr/tk/lib /usr/local/tcl /usr/tcl /usr/local/tcl/lib /usr/tcl/lib"
-libexts="so so.1.0 sl a"
+libexts="dylib so so.1.0 sl a"
 libnames="tk$CHK_TK_MAJ.$CHK_TK_MIN tk.$CHK_TK_MAJ.$CHK_TK_MIN tk$CHK_TK_MAJ$CHK_TK_MIN tk.$CHK_TK_MAJ$CHK_TK_MIN"
 for e in $libexts; do
 for j in $dirs ; do
--- scilab-2.6/Makefile.in	Tue Jul 24 10:58:26 2001
+++ scilab-2.6/Makefile.in	Tue Jul 24 11:00:31 2001
@@ -147,28 +147,14 @@
 	cd .. ; tar cvf $(SCIDIR)/$(SCIBASE)-bin.tar $(BINDISTFILES)
 	$(RM) .binary
 
-LIBPREFIX = @prefix@/lib
-
 install:
-	@if test `pwd` != ${LIBPREFIX}/$(SCIBASE); then \
+	@if test `pwd` != $(LIBPREFIX)/$(SCIBASE); then \
 		touch .binary; \
 		strip $(SCIDIR)/bin/scilex; \
 		(cd tests; make distclean); \
 		(cd examples; make distclean); \
-		(cd .. ; tar cf - $(BINDISTFILES) | (cd ${LIBPREFIX}; tar xf -)); \
-		(cd ${LIBPREFIX}/$(SCIBASE); make); \
+		(cd .. ; tar cf - $(BINDISTFILES) | (cd $(LIBPREFIX); tar xf -)); \
+		(cd $(LIBPREFIX)/$(SCIBASE); make); \
 		$(RM) .binary; \
 	fi
-	$(RM) /usr/bin/scilab
-	ln -fs ${LIBPREFIX}/$(SCIBASE)/bin/scilab /usr/bin/scilab
-	$(RM) /usr/bin/intersci
-	ln -fs ${LIBPREFIX}/$(SCIBASE)/bin/intersci /usr/bin/intersci
-	$(RM) /usr/bin/intersci-n
-	ln -fs ${LIBPREFIX}/$(SCIBASE)/bin/intersci-n /usr/bin/intersci-n
-
-uninstall:
-	$(RM) -r ${LIBPREFIX}/$(SCIBASE)
-	$(RM) /usr/bin/scilab
-	$(RM) /usr/bin/intersci
-	$(RM) /usr/bin/intersci-n
 
Index: Makefile.OBJ
===================================================================
RCS file: /site/cvsroot/scilab-2.6/Makefile.OBJ,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 Makefile.OBJ
--- scilab-2.6/Makefile.OBJ	2001/03/30 14:32:29	1.1.1.1
+++ scilab-2.6/Makefile.OBJ	2001/04/08 06:59:00
@@ -4,14 +4,14 @@
         $(SCIDIR)/libs/integ.a $(SCIDIR)/libs/control.a \
 	$(SCIDIR)/libs/scicos.a $(SCIDIR)/libs/signal.a \
         $(SCIDIR)/libs/poly.a $(SCIDIR)/libs/calelm.a \
-	$(SCIDIR)/libs/lapack.a $(SCIDIR)/libs/graphics.a \
+	$(LAPACK) $(SCIDIR)/libs/graphics.a \
         $(SCIDIR)/libs/sparse.a $(SCIDIR)/libs/metanet.a \
 	$(SCIDIR)/libs/sun.a $(SCIDIR)/libs/gd.a  \
         $(SCIDIR)/libs/intersci.a  $(SCIDIR)/libs/xsci.a \
 	$(SCIDIR)/libs/graphics.a $(SCIDIR)/libs/menusX.a \
         $(SCIDIR)/libs/libcomm.a $(SCIDIR)/libs/comm.a \
 	$(SCIDIR)/libs/sound.a $(SCIDIR)/libs/dcd.a $(SCIDIR)/libs/rand.a \
-        $(SCIDIR)/libs/blas.a  $(SCIDIR)/libs/int.a \
+        $(BLAS) $(SCIDIR)/libs/int.a \
 	$(SCIDIR)/libs/pvm.a  $(SCIDIR)/libs/tksci.a
 
 LIBR = $(XAW_LOCAL_LIB) $(LIBRSCI) $(DLDLIB) $(PVMGLIB) $(PVMLIB)
Index: Makefile.OBJ.in
===================================================================
RCS file: /site/cvsroot/scilab-2.6/Makefile.OBJ.in,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 Makefile.OBJ.in
--- scilab-2.6/Makefile.OBJ.in	2001/03/30 14:32:29	1.1.1.1
+++ scilab-2.6/Makefile.OBJ.in	2001/04/06 14:34:55
@@ -3,14 +3,14 @@
         $(SCIDIR)/libs/integ.a $(SCIDIR)/libs/control.a \
 	$(SCIDIR)/libs/scicos.a $(SCIDIR)/libs/signal.a \
         $(SCIDIR)/libs/poly.a $(SCIDIR)/libs/calelm.a \
-	$(SCIDIR)/libs/lapack.a $(SCIDIR)/libs/graphics.a \
+	$(LAPACK) $(SCIDIR)/libs/graphics.a \
         $(SCIDIR)/libs/sparse.a $(SCIDIR)/libs/metanet.a \
 	$(SCIDIR)/libs/sun.a $(SCIDIR)/libs/gd.a  \
         $(SCIDIR)/libs/intersci.a  $(SCIDIR)/libs/@GUILIB@.a \
 	$(SCIDIR)/libs/graphics.a $(SCIDIR)/libs/menusX.a \
         $(SCIDIR)/libs/libcomm.a $(SCIDIR)/libs/comm.a \
 	$(SCIDIR)/libs/sound.a $(SCIDIR)/libs/dcd.a $(SCIDIR)/libs/rand.a \
-        $(SCIDIR)/libs/blas.a  $(SCIDIR)/libs/int.a \
+        $(BLAS) $(SCIDIR)/libs/int.a \
 	@PVMSCILIB@ @XDRLIBNAME@ @TKSCILIB@
 
 LIBR = $(XAW_LOCAL_LIB) $(LIBRSCI) $(DLDLIB) $(PVMGLIB) $(PVMLIB)
Index: Makefile.incl
===================================================================
RCS file: /site/cvsroot/scilab-2.6/Makefile.incl,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 Makefile.incl
--- scilab-2.6/Makefile.incl	2001/03/30 14:32:29	1.1.1.1
+++ scilab-2.6/Makefile.incl	2001/04/08 06:59:00
@@ -94,3 +94,9 @@
 CVTRES= /SOFTS/gnuwin32/b18/H-i386-cygwin32/bin/cvtres.exe
 # link options 
 LINKEROPT=-Wl,-subsystem,console
+
+#####################
+# BLAS/Atlas
+#####################
+LAPACK=$(SCIDIR)/libs/lapack.a
+BLAS=$(SCIDIR)/libs/blas.a
Index: Makefile.incl.in
===================================================================
RCS file: /site/cvsroot/scilab-2.6/Makefile.incl.in,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 Makefile.incl.in
--- scilab-2.6/Makefile.incl.in	2001/03/30 14:32:29	1.1.1.1
+++ scilab-2.6/Makefile.incl.in	2001/04/06 14:36:47
@@ -93,3 +93,9 @@
 CVTRES= /SOFTS/gnuwin32/b18/H-i386-cygwin32/bin/cvtres.exe
 # link options 
 LINKEROPT=-Wl,-subsystem,console
+
+#####################
+# BLAS/Atlas
+#####################
+LAPACK=$(SCIDIR)/libs/lapack.a
+BLAS=$(SCIDIR)/libs/blas.a
Index: routines/calelm/dmmul.f
===================================================================
RCS file: /site/cvsroot/scilab-2.6/routines/calelm/dmmul.f,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 dmmul.f
--- scilab-2.6/routines/calelm/dmmul.f	2001/03/30 14:32:37	1.1.1.1
+++ scilab-2.6/routines/calelm/dmmul.f	2001/04/08 06:44:03
@@ -1,33 +1,44 @@
-      subroutine dmmul(a,na,b,nb,c,nc,l,m,n)
-c!
-c     
-c     c=a*b .
-c!
-c
-c     subroutine dmmul(a,na,b,nb,c,nc,l,m,n)
-c     double precision a(na,m),b(nb,n),c(nc,n)
-c     integer na,nb,nc,l,m,n
-c
-c     a            workspace of size na*m containing a
-c     na           number of rows of array a in calling program
-c     b,nb,c,nc    idem for b and c
-c     l            # of rows of matrix  a and c
-c     m            # of columns of a and rows of b
-c     n            # of columns of b and c
-c!
-c     Copyright INRIA
-      double precision a(*),b(*),c(*)
-      double precision ddot
-      integer na,nb,nc,l,m,n
-      integer i,j,ib,ic
-c
-      ib=1
-      ic=0
-      do 30 j=1,n
-         do 20 i=1,l
-   20    c(ic+i)=ddot(m,a(i),na,b(ib),1)
-      ic=ic+nc
-      ib=ib+nb
-   30 continue
-      return
+      subroutine dmmul(a, na, b, nb, c, nc, l, m, n)
+*
+*     name       : dmmul.f  --  multiply double precision
+*                               matrices;  c := a * b
+*     author     : Lydia E. van Dijk <lvandijk@hammersmith-consulting.com>
+*     last. rev. : Fri Apr  6 09:47:11 UTC 2001
+*     Scilab ver.: 2.6
+*     compiler   : g77 version 2.95.3 20010315 (release)
+
+
+*     Copyright (C) 2000, 2001  Lydia van Dijk, Hammersmith Consulting
+*
+*     This program is free software; you can redistribute it and/or
+*     modify it under the terms of the GNU General Public License as
+*     published by the Free Software Foundation; either version 2, or
+*     (at your option) any later version.
+* 
+*     This program is distributed in the hope that it will be useful,
+*     but WITHOUT ANY WARRANTY; without even the implied warranty of
+*     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*     GNU General Public License for more details.
+* 
+*     You should have received a copy of the GNU General Public
+*     License along with this program; if not write to the Free
+*     Software Foundation, Inc., 59 Temple Place - Suite 330,
+*     Boston, MA 02111-1307, USA.
+
+
+*     PARAMETERS
+*     a, b, c:      matrices
+*     na, nb, nc:   number of rows of respective matrix in calling
+*                   routine
+*     l:            number of rows in a and c
+*     m:            number of columns in a, and number of rows in b
+*     n:            number of columns in b and c
+      implicit none
+      double precision a(*), b(*), c(*)
+      integer na, nb, nc, l, m, n
+
+
+*     TEXT
+      call dgemm('n', 'n', l, n, m, 1.0d0, a, na, b, nb, 0.0d0, c, nc)
+
       end
Index: routines/calelm/wmmul.f
===================================================================
RCS file: /site/cvsroot/scilab-2.6/routines/calelm/wmmul.f,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 wmmul.f
--- scilab-2.6/routines/calelm/wmmul.f	2001/03/30 14:32:37	1.1.1.1
+++ scilab-2.6/routines/calelm/wmmul.f	2001/04/08 06:44:17
@@ -1,47 +1,112 @@
-C/MEMBR ADD NAME=WMMUL,SSI=0
-c     Copyright INRIA
-      subroutine wmmul(ar,ai,na,br,bi,nb,cr,ci,nc,l,m,n)
-c!but
-c     ce sous programme effectue le produit matriciel:
-c     c=a*b .
-c!liste d'appel
-c
-c      subroutine wmmul(ar,ai,na,br,bi,nb,cr,ci,nc,l,m,n)
-c      double precision ar(*),ai(*),br(*),bi(*),cr(*),ci(*)
-c      integer i,j,k,ia,ib,ic
-c
-c     a            tableau de taille na*m contenant la matrice a
-c     na           nombre de lignes du tableau a dans le programme appel
-c     b,nb,c,nc    definitions similaires a celles de a,na
-c     l            nombre de ligne des matrices a et c
-c     m            nombre de colonnes de a et de lignes de b
-c     n            nombre de colonnes de b et c
-c!sous programmes utilises
-c     neant
-c!
-      double precision ar(*),ai(*),br(*),bi(*),cr(*),ci(*)
-      double precision tr,ti
-      integer na,nb,nc,l,m,n
-      integer i,j,k,ia,ib,ic
-c
-      ib=0
-      ic=0
-      do 30 j=1,n
-         do 20 i=1,l
-         ia=i
-         tr=0.0d+0
-         ti=0.0d+0
-            do 10 k=1,m
-            ib=ib+1
-            tr=tr+ar(ia)*br(ib)-ai(ia)*bi(ib)
-            ti=ti+ar(ia)*bi(ib)+ai(ia)*br(ib)
-            ia=ia+na
-   10       continue
-         ib=ib-m
-         cr(ic+i)=tr
-   20    ci(ic+i)=ti
-      ic=ic+nc
-      ib=ib+nb
-   30 continue
-      return
+      subroutine wmmul(ar, ai, na, br, bi, nb, cr, ci, nc, k, m, n)
+*
+*     name       : wmmul.f  --  multiply two complex matrices;
+*                                c := a * b
+*     author     : Lydia E. van Dijk <lvandijk@hammersmith-consulting.com>
+*     last. rev. : Fri Apr  6 09:44:54 UTC 2001
+*     Scilab ver.: 2.6
+*     compiler   : g77 version 2.95.3 20010315 (release)
+
+
+*     Copyright (C) 2000, 2001  Lydia van Dijk, Hammersmith Consulting
+*
+*     This program is free software; you can redistribute it and/or
+*     modify it under the terms of the GNU General Public License as
+*     published by the Free Software Foundation; either version 2, or
+*     (at your option) any later version.
+* 
+*     This program is distributed in the hope that it will be useful,
+*     but WITHOUT ANY WARRANTY; without even the implied warranty of
+*     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*     GNU General Public License for more details.
+* 
+*     You should have received a copy of the GNU General Public
+*     License along with this program; if not write to the Free
+*     Software Foundation, Inc., 59 Temple Place - Suite 330,
+*     Boston, MA 02111-1307, USA.
+
+
+*     PARAMETERS
+*     ai, ar,
+*     bi, br, 
+*     ci, cr:       real and imaginary parts of the respective
+*                   matrices
+*     na, nb, nc:   number of rows of resp. matrix in calling routine
+*     k:            number of rows in a and c
+*     m:            number of columns in a, and number of rows in b
+*     n:            number of columns in b and c
+      implicit none
+      double precision ar(*), ai(*), br(*), bi(*), cr(*), ci(*)
+      integer na, nb, nc, k, m, n
+
+
+*     As Scilab stores real and imaginary part of a complex matrix
+*     separately, we use a Karatsuba multiplication scheme with only
+*     three multiplications instead of the four as the naive algorithm
+*     does.  Expressed in Scilab it looks like this:
+*
+*        function [cr, ci] = fastmul(ar, ai, br, bi)
+*        // fast multiplication of two complex numbers
+*        // z1 := ar + i*ai
+*        // z2 := br + i*bi
+*        // cr + i*ci =: z3 = z1 * z2
+*        //
+*        p1 = ar * br;
+*        p2 = ai * bi;
+*        cr = p1 - p2;
+*        
+*        s1 = ar + ai;
+*        s2 = br + bi;
+*        p3 = s1 * s2;
+*        ci = p3 - p1 - p2;
+*        endfunction
+*
+*     The actual implementaion is a more space saving version of the
+*     above:
+*        p1 = ar * br;
+*        p2 = ai * bi;
+*        
+*        s1 = ar + ai;
+*        s2 = br + bi;
+*        ci = s1 * s2;
+*        ci = ci - p1 - p2;
+*        cr = p1 - p2;
+
+
+*     LOCAL VARIABLES
+      integer i, j
+      integer ia, ib, ic
+      double precision p1(k, n), p2(k, n)
+      double precision s1(k, m), s2(m, n)
+
+*     TEXT     
+      call dgemm('n', 'n', k, n, m, 1.0d0, ar, na, br, nb, 
+     $        0.0d0, p1, k)
+      call dgemm('n', 'n', k, n, m, 1.0d0, ai, na, bi, nb, 
+     $        0.0d0, p2, k)
+      ia = 0
+      do 200, j = 1, m
+          do 100, i = 1, k
+              s1(i, j) = ar(ia + i) + ai(ia + i)
+ 100      continue
+          ia = ia + na
+ 200  continue
+      ib = 0
+      do 400, j = 1, n
+          do 300, i = 1, m
+              s2(i, j) = br(ib + i) + bi(ib + i)
+ 300      continue
+          ib = ib + nb
+ 400  continue
+      call dgemm('n', 'n', k, n, m, 1.0d0, s1, k, s2, m,
+     $        0.0d0, ci, nc)
+      ic = 0
+      do 600, j = 1, n
+          do 500, i = 1, k
+              ci(ic + i) = ci(ic + i) - p1(i, j) - p2(i, j)
+              cr(ic + i) = p1(i, j)   - p2(i, j)
+ 500      continue
+          ic = ic + nc
+ 600  continue
+
       end
Index: routines/default/Ex-odedc.f
===================================================================
RCS file: /site/cvsroot/scilab-2.6/routines/default/Ex-odedc.f,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 Ex-odedc.f
--- scilab-2.6/routines/default/Ex-odedc.f	2001/03/30 14:32:38	1.1.1.1
+++ scilab-2.6/routines/default/Ex-odedc.f	2001/04/06 17:05:58
@@ -86,8 +86,8 @@
       subroutine fd(xd,y,xp)
 c     Ad=[0.5,1;0,0.05] Bd=[1;1]
       double precision xd(*),y(*),xp(*)
-      xp(1)=0.5*xd(1)+xd(2)+y(1)
-      xp(2)=0*xd(1)+0.05*xd(2)+y(1)
+      xp(1)=0.5D0*xd(1)+xd(2)+y(1)
+      xp(2)=0*xd(1)+0.05D0*xd(2)+y(1)
       return
       end
 
@@ -135,7 +135,7 @@
       call matptr('A'//char(0),m,n,la)
 c      call dset(m,0.0d0,xdot,1)
 c      call dgemm('n','n',m,1,m,1.0d0,stk(la),m,xc,m,1.0d0,xdot,m)
-      call dmmul(stk(la),m,xc,m,xdot,m,m,m,1)
+      call brdmmul(stk(la),m,xc,m,xdot,m,m,m,1)
       call matptr('B'//char(0),m,nb,lb)
       call dgemm('n','n',m,1,nb,1.0d0,stk(lb),m,u,1,1.0d0,xdot,m)
       end
@@ -145,7 +145,7 @@
       include '../stack.h'
 c     y=C*x
       call matptr('C'//char(0),m,n,lc)      
-      call dmmul(stk(lc),m,x,m,y,m,m,n,1)
+      call brdmmul(stk(lc),m,x,m,y,m,m,n,1)
       end
 
       subroutine fd1(xd,y,xp)
@@ -153,7 +153,7 @@
       double precision xd(*),y(*),xp(*)
       include '../stack.h'
       call matptr('Ad'//char(0),m,n,la)
-      call dmmul(stk(la),m,xd,m,xp,m,m,m,1)
+      call brdmmul(stk(la),m,xd,m,xp,m,m,m,1)
       call matptr('Bd'//char(0),m,nb,lb)
       call dgemm('n','n',m,1,nb,1.0d0,stk(lb),m,y,1,1.0d0,xp,m)
       end
@@ -165,7 +165,7 @@
       include '../stack.h'
 c     y=C*x
       call matptr('Cd'//char(0),m,n,lc)      
-      call dmmul(stk(lc),m,xd,m,u,m,m,n,1)
+      call brdmmul(stk(lc),m,xd,m,u,m,m,n,1)
       end
 
       subroutine finput(t,v)
@@ -214,13 +214,25 @@
       double precision t,x(*),xdot(*)
       include '../stack.h'
       call matptr('A'//char(0),m,n,la)
-      call dmmul(stk(la),m,x,m,xdot,m,m,m,1)
+      call brdmmul(stk(la),m,x,m,xdot,m,m,m,1)
       call matptr('B'//char(0),m,nb,lb)
       call dgemm('n','n',m,1,nb,1.0d0,stk(lb),m,x(m+1),1,1.0d0,xdot,m)
       end
 
-
-
-
-
-
+      subroutine brdmmul(a,na,b,nb,c,nc,l,m,n)
+c     Copyright INRIA
+      double precision a(*),b(*),c(*)
+      double precision ddot
+      integer na,nb,nc,l,m,n
+      integer i,j,ib,ic
+c
+      ib=1
+      ic=0
+      do 30 j=1,n
+         do 20 i=1,l
+   20    c(ic+i)=ddot(m,a(i),na,b(ib),1)
+      ic=ic+nc
+      ib=ib+nb
+   30 continue
+      return
+      end
Index: tests/odedc.dia.ref
===================================================================
RCS file: /site/cvsroot/scilab-2.6/tests/odedc.dia.ref,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 odedc.dia.ref
--- scilab-2.6/tests/odedc.dia.ref       2001/03/30 14:32:40     1.1.1.1
+++ scilab-2.6/tests/odedc.dia.ref       2001/04/08 10:45:26
@@ -54,7 +54,7 @@
 xcd2=odedc([x0c;0],1,1,t0,t,'phis');
  
  
-if norm(xcd-xcd2,1) > 1.d-10 then bugmes();quit;end
+if norm(xcd-xcd2,1) > 3.d-8 then bugmes();quit;end
  
 deff('xd=ff(t,x)','xd=A*x+B*u')
  
Index: tests/odedc.tst
===================================================================
RCS file: /site/cvsroot/scilab-2.6/tests/odedc.tst,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 odedc.tst
--- scilab-2.6/tests/odedc.tst     2001/03/30 14:32:40     1.1.1.1
+++ scilab-2.6/tests/odedc.tst     2001/04/08 10:08:12
@@ -33,7 +33,7 @@
 //link('phis.o','phis')
 xcd2=odedc([x0c;0],1,1,t0,t,'phis');
 
-if norm(xcd-xcd2,1) > 1.d-10 then pause,end
+if norm(xcd-xcd2,1) > 3.d-8 then pause,end
 deff('xd=ff(t,x)','xd=A*x+B*u')
 
 u=1/2;xn=ode(x0c,t0,t,ff);
Index: routines/control/dclmat.f
===================================================================
RCS file: /site/cvsroot/scilab-2.6/routines/control/dclmat.f,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 dclmat.f
--- scilab-2.6/routines/control/dclmat.f   2001/03/30 14:32:37     1.1.1.1
+++ scilab-2.6/routines/control/dclmat.f   2001/04/06 10:07:52
@@ -47,7 +47,7 @@
    10    continue
          do 30 i1=1,ndng
             im1 = ndng1 - i1
-            call dmmul(a,ia,w,1,b(1,j),ib,n,n,1)
+            call dmmul(a,ia,w,n,b(1,j),ib,n,n,1)
             do 20 i=1,n
                w1 = two*b(i,j) - w(n+i)
                w(n+i) = w(i)
Index: routines/control/wclmat.f
===================================================================
RCS file: /site/cvsroot/scilab-2.6/routines/control/wclmat.f,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 wclmat.f
--- scilab-2.6/routines/control/wclmat.f   2001/03/30 14:32:37     1.1.1.1
+++ scilab-2.6/routines/control/wclmat.f   2001/04/06 12:20:13
@@ -53,7 +53,7 @@
    10    continue
          do 30 i1=1,ndng
             im1 = ndng1 - i1
-            call wmmul(ar,ai,ia,w(k1r),w(k1i),1,br(1,j),bi(1,j),
+            call wmmul(ar,ai,ia,w(k1r),w(k1i),n,br(1,j),bi(1,j),
      *                ib,n,n,1)
             do 20 i=1,n
                w1 = two*br(i,j) - w(k2r-1+i)
Index: routines/interf/matops.f
===================================================================
RCS file: /site/cvsroot/scilab-2.6/routines/interf/matops.f,v
retrieving revision 1.1.1.1
diff -u -r1.1.1.1 matops.f
--- scilab-2.6/routines/interf/matops.f	2001/03/30 14:32:38	1.1.1.1
+++ scilab-2.6/routines/interf/matops.f	2001/04/21 17:21:57
@@ -238,6 +238,11 @@
          go to 41
       elseif (mn2.eq.1) then
 c     .   vector+const
+         err=l1+mn1*(itr+1)-lstk(bot)
+         if(err.gt.0) then
+            call error(17)
+            return
+         endif 
          call dadd(mn1,stk(l2),0,stk(l1),1)
          if(it2+2*it1.eq.1) call unsfdcopy(mn1,stk(l2+mn2),0,
      $        stk(l1+mn1),1)
@@ -246,6 +251,11 @@
          istk(il1+3)=itr
       elseif (mn1.eq.1) then
 c     .  cst+vector
+         err=l1+mn2*(itr+1)-lstk(bot)
+         if(err.gt.0) then
+            call error(17)
+            return
+         endif
          cstr=stk(l1)
          csti=stk(l1+1)
          call unsfdcopy((it2+1)*mn2,stk(l2),1,stk(l1),1)
@@ -260,6 +270,11 @@
 c     .  vector+vector
          if (m1 .ne. m2.or.n1 .ne. n2) then
             call error(8)
+            return
+         endif
+         err=l1+mn1*(itr+1)-lstk(bot)
+         if(err.gt.0) then
+            call error(17)
             return
          endif
          call dadd(mn1,stk(l2),1,stk(l1),1)
--- scilab-2.6/routines/calelm/unsfdcopy.c	Sun Jul 29 13:45:25 2001
+++ scilab-2.6/routines/calelm/unsfdcopy.c	Sun Jul 29 13:45:35 2001
@@ -0,0 +1,81 @@
+/* 
+ * name:        usfdcopy.c  --  ultra-fast substitute for usfdcopy.f
+ * author:      Ch. L. Spiel <cspiel@hammersmith-consulting.com>
+ * last rev.:   Fri Apr  6 08:38:44 UTC 2001
+ * compiler:    gcc-2.95.3 in i386 GNU/Linux
+ * Scilab ver.: 2.6
+ */
+
+
+/*
+ *  Copyright (C) 2000, 2001 Christoph L. Spiel
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+ */
+
+
+#include <stdio.h>
+#include "../machine.h"
+
+
+#define UNSFDCOPY F2C(unsfdcopy)
+
+/*#define CHECK_FOR_OVERLAP*/
+#undef CHECK_FOR_OVERLAP
+
+
+void
+UNSFDCOPY(const int *n,
+          const double *x, const int *incx,
+          double *y, const int *incy)
+{
+    int i;
+    double *xp, *yp;
+    const int icx = *incx;
+    const int icy = *incy;
+
+    if (*n <= 0) return;
+
+#ifdef CHECK_FOR_OVERLAP
+    {
+        const double *x_hi = x + (*n - 1)*abs(icx);
+        const double *y_hi = y + (*n - 1)*abs(icy);
+        if (x <= y) {
+            if (x_hi >= y)
+                fprintf(stderr,
+			"WARNING: overlap in unsfdcopy! (x_hi >= y)\n");
+        } else {
+            if (y_hi > x)
+                fprintf(stderr,
+			"WARNING: overlap in unsfdcopy! (y_hi > x)\n");
+        }
+    }
+#endif /* CHECK_FOR_OVERLAP */
+
+    if (icx >= 0)
+        xp = (double*) x;
+    else
+        xp = (double*) x + icx * (1 - *n);
+    if (icy >= 0)
+        yp = y;
+    else
+        yp = y + icy * (1 - *n);
+
+    for (i = 1 - *n; i <= 0; i++) {
+        *yp = *xp;
+        xp += icx;
+        yp += icy;
+    }
+}
--- scilab-2.6/xmetanet/save.c	Mon Jul 30 05:45:13 2001
+++ scilab-2.6/xmetanet/save.c	Mon Jul 30 05:44:59 2001
@@ -1,6 +1,11 @@
 /* Copyright INRIA */
+#ifdef __APPLE__
+#include <sys/types.h>
+#endif
 #include <dirent.h>
+#ifndef __APPLE__
 #include <malloc.h>
+#endif
 #include <stdio.h>
 #include <string.h>
 
--- scilab-2.6/routines/calelm/wcopy.f	Mon Jul 30 13:16:22 2001
+++ scilab-2.6/routines/calelm/wcopy.f	Mon Jul 30 13:18:09 2001
@@ -1,42 +1,39 @@
-C/MEMBR ADD NAME=WCOPY,SSI=0
-c     Copyright INRIA
-      subroutine  wcopy(n,dxr,dxi,incx,dyr,dyi,incy)
-c!calling sequence
-c      subroutine  dcopy(n,dxr,dxi,incx,dyr,dyi,incy)
-c
-c!purpose
-c     copies a vector, x, to a vector, y.
-c     uses unrolled loops for increments equal to one.
-c!originator
-c     jack dongarra, linpack, 3/11/78.
-c!
-c
-       double precision dxr(*),dxi(*),dyr(*),dyi(*)
-      integer i,incx,incy,ix,iy,n
-c
-      if(n.le.0)return
-      if(incx.eq.1.and.incy.eq.1)go to 20
-c
-c code for unequal increments or equal increments not equal to 1
-c
-      ix = 1
-      iy = 1
-      if(incx.lt.0)ix = (-n+1)*incx + 1
-      if(incy.lt.0)iy = (-n+1)*incy + 1
-      do 10 i = 1,n
-        dyr(iy) = dxr(ix)
-        dyi(iy) = dxi(ix)
-        ix = ix + incx
-        iy = iy + incy
-   10 continue
-      return
-c
-c code for both increments equal to 1
-c
-   20 continue
-      do 30 i = 1,n
-        dyr(i) = dxr(i)
-        dyi(i) = dxi(i)
-   30 continue
-c
-      end
+      subroutine wcopy(n, xr, xi, incx, yr, yi, incy)
+*
+*     name       : wcopy.f  --  copy complex vector xr + %i*xi using
+*                               increments of incx into complex vector
+*                               yr + %i*yi using increments of incy
+*     author     : Christoph L. Spiel <cspiel@hammersmith-consulting.com>
+*     last. rev. : Sun Apr  8 06:51:47 UTC 2001
+*     Scilab ver.: 2.6
+*     compiler   : g77 version 2.95.3 20010315 (release)
+
+
+*     Copyright (C) 2001  Christoph Spiel, Hammersmith Consulting
+*
+*     This program is free software; you can redistribute it and/or
+*     modify it under the terms of the GNU General Public License as
+*     published by the Free Software Foundation; either version 2, or
+*     (at your option) any later version.
+* 
+*     This program is distributed in the hope that it will be useful,
+*     but WITHOUT ANY WARRANTY; without even the implied warranty of
+*     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+*     GNU General Public License for more details.
+* 
+*     You should have received a copy of the GNU General Public
+*     License along with this program; if not write to the Free
+*     Software Foundation, Inc., 59 Temple Place - Suite 330,
+*     Boston, MA 02111-1307, USA.
+
+      implicit none
+
+*     PARAMETERS
+      integer n, incx, incy
+      double precision xr, xi, yr, yi
+
+*     TEXT
+      call dcopy(n, xr, incx, yr, incy)
+      call dcopy(n, xi, incx, yi, incy)
+
+       end
--- scilab-2.6/routines/xsci/wf_fig.h.orig	Mon Sep  2 17:37:12 2002
+++ scilab-2.6/routines/xsci/wf_fig.h	Mon Sep  2 17:39:46 2002
@@ -48,7 +48,7 @@
 #include <errno.h>
 
 #ifndef linux 
-#if !defined(__bsdi__) && !defined(__NetBSD__)
+#if !defined(__bsdi__) && !defined(__NetBSD__) && !defined(__APPLE__)
 extern int	errno;
 extern int	sys_nerr;
 #if (! (defined(BSD) && (BSD >= 199306))) && !defined(freebsd) && !defined(__APPLE__)
--- scilab-2.6/routines/xsci/x_misc.c.orig	Mon Sep  2 17:43:38 2002
+++ scilab-2.6/routines/xsci/x_misc.c	Mon Sep  2 17:45:03 2002
@@ -509,7 +509,7 @@
 
 /* #include "wf_fig.h" */ /** for sys_errlist **/
 #ifndef linux 
-#if !defined(__bsdi__) && !defined(__NetBSD__)
+#if !defined(__bsdi__) && !defined(__NetBSD__) && !defined(__APPLE__)
 extern int	errno;
 extern int	sys_nerr;
 #if (! (defined(BSD) && (BSD >= 199306))) && !defined(freebsd) && !defined(__APPLE__)
@@ -523,7 +523,7 @@
 char *SysErrorMsg(n)
   int n;
 {
-  extern int sys_nerr;
+/* extern int sys_nerr; */
   return ((n >= 0 && n < sys_nerr) ? sys_errlist[n] : UE );
 }
 
