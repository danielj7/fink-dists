Package: system-xfree86
Version: 4.2
Revision: 6
Provides: x11, rman, libgl, libgl-shlibs
Conflicts: x11, system-libgl
Replaces: system-libgl
Type: bundle
Shlibs: <<
   /usr/X11R6/lib/libdps.1.dylib 1.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libdpstk.1.dylib 1.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libfreetype.6.dylib 6.2.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libICE.6.dylib 6.3.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/liboldX.6.dylib 6.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libpsres.1.dylib 1.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libSM.6.dylib 6.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libX11.6.dylib 6.2.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXaw.6.dylib 6.1.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXaw.7.dylib 7.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXext.6.dylib 6.4.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXfont.1.dylib 1.4.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXft.1.dylib 1.1.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXi.6.dylib 6.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXmu.6.dylib 6.2.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXmuu.1.dylib 1.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXp.6.dylib 6.2.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXpm.4.dylib 4.11.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXrandr.1.dylib 1.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXrender.1.dylib 1.1.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXt.6.dylib 6.0.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXTrap.6.dylib 6.4.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
   /usr/X11R6/lib/libXtst.6.dylib 6.1.0 xfree86-base-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
  /usr/X11R6/lib/libGL.1.dylib 1.2.0 xfree86-rootless-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
  /usr/X11R6/lib/libGLU.1.dylib 1.3.0 xfree86-rootless-shlibs (>= 4.2.1.1-1) | system-free86 (>= 4.2-1)
<<
Description: Placeholder package for manually installed XFree86
DescDetail: <<
Install this package if you have XFree86 4.2.x (or equivalent) installed
manually.  It will check whether the installation is okay and provide
the 'x11' virtual package.

For a compatible X11 package, try XonX (from the XFree86 Project) at
http://sourceforge.net/project/showfiles.php?group_id=18034 or Apple's
X11 at http://www.apple.com/macosx/x11/ .
<<
#
PreInstScript: <<

echo ""

##############################################################################
# Phase 1: Interrogate the system for X11-like thingies
##############################################################################

# Apple X11 -- http://www.apple.com/macosx/x11/

LIBAPPLE="false"
XPINC="false"
LIBTENON="false"

if [ -e /usr/X11R6/lib/libapplexp.1.dylib ]; then
  echo "- found apple library"
  LIBAPPLE="true"
fi
if [ -f /usr/X11R6/include/xp/x-plugin.h ]; then
  echo "- found X plugin includes"
  XPINC="true"
fi
if [ -d /usr/X11R6/lib/tenon ]; then
  echo "- found lib/tenon"
  LIBTENON="true"
fi
mcount=0
for file in bin/xterm bin/xrdb bin/rman \
	    lib/libX11.dylib lib/libXpm.dylib lib/libXaw.dylib \
	    include/X11/Xlib.h ; do
  if [ ! -f "/usr/X11R6/$file" ]; then
    mcount=$(($mcount+1))
    echo "- missing /usr/X11R6/$file"
  else
    echo "- found /usr/X11R6/$file"
  fi
done
if [ -x /usr/X11R6/bin/XDarwin ]; then
  XF_VERSION=`/usr/X11R6/bin/XDarwin -version 2>&1 | grep "XFree86 Version" | awk '{ print $3 }'`
  XF_MAJOR=`echo $XF_VERSION | cut -d. -f1`
  XF_MINOR=`echo $XF_VERSION | cut -d. -f2`
fi

##############################################################################
# Phase 2: 
##############################################################################

##############################################################################
# Phase 3: Profit!  Err... I mean, make sure this X11 is OK.   =)
##############################################################################

if [ "$LIBAPPLE" = "true" ] || [ "$XPINC" = "true" ]; then
  GOODAPPLE="true"
  if [ "$LIBAPPLE" = "false" ] || [ ! -e /usr/X11R6/bin/Xquartz ]; then
    echo "- Apple X11 userland is missing"
    GOODAPPLE="false"
  elif [ "$XPINC" = "false" ] || [ ! -e /usr/X11R6/include/X11/X.h ]; then
    echo "- Apple X11 SDK is missing"
    GOODAPPLE="false"
  fi
  if [ "$GOODAPPLE" = "false" ]; then
    cat <<END

** ERROR! **
It appears you have a partially-installed version of the Apple X11
release.  To use Apple's X11 with Fink, you must download both the
main X11 installer, as well as the SDK (there are actually 2 separate
downloads for the Apple X11 release).  Please go to
http://www.apple.com/macosx/x11/ and download and install the missing
files, and re-attempt your install of system-xfree86.

END
    exit 1
  fi

fi

# Tenon XTools
if [ "$LIBTENON" = "true" ]; then
  cat <<END

It looks like you have Xtools installed, not XFree86.  XTools was never
properly updated for MacOSX 10.2 and will likely have issues.  It is
suggested that you remove XTools XFree86 and download the XonX or
Apple X11 releases instead.

It is possible that you have installed an XonX or Apple X11 release over
your Xtools release.  If that is the case, delete the directory
"/usr/X11R6/lib/tenon" and try this install again.

Press a key to continue.
END
  read -n1 -s
  echo ""
  exit 1
fi

if [ "$mcount" -ge 1 ]; then
  cat <<END

Your XFree86 installation is missing or incomplete.  Please make sure you have
an XFree86 release installed and retry the installation of the system-xfree86
package.

The following XFree86 software is compatible with system-xfree86:

  XonX (from the XFree86 Project):
    http://sourceforge.net/project/showfiles.php?group_id=18034

  Apple X11:
    http://www.apple.com/macosx/x11/

Press a key to continue.
END
  read -n1 -s
  echo ""
  exit 1
fi

if [ "$GOODAPPLE" = "true" ]; then
  echo ""
  echo "Valid Apple X11 detected.  Thank you, have a nice day."
  echo ""
  exit 0
else
  if [ -z "$XF_VERSION" ] || [ -z "$XF_MAJOR" ] || [ -z "$XF_MINOR" ]; then
    cat <<END
An error occurred trying to find your XFree86 installation's
version.  This really shouldn't happen, so I'm bailing.  :(

Press a key to continue.
END
    read -n1 -s
    echo ""
    exit 1
  else
    if [ "$XF_MAJOR" != "4" ] || [ "$XF_MINOR" -lt 2 ]; then
      cat <<END
This package requires XFree86 version 4.2 or equivalent, but your have
version $XF_VERSION installed!  Please upgrade your XFree86 installation
and try again.

Press a key to continue.
END
      read -n1 -s
      echo ""
      exit 1
    fi
  fi
fi

echo "Valid XFree86 installation detected."
echo ""

# check imake config files for 10.1 flags
if grep 'undefined suppress' /usr/X11R6/lib/X11/config/darwinLib.rules >/dev/null 2>&1; then
  if ! grep 'flat_namespace' /usr/X11R6/lib/X11/config/darwinLib.rules >/dev/null 2>&1; then
    echo "Adding Mac OS X 10.1 compatibility option to imake configuration file"
    echo "/usr/X11R6/lib/X11/config/darwinLib.rules ..."
    sed 's/-undefined suppress/-flat_namespace -undefined suppress/g' </usr/X11R6/lib/X11/config/darwinLib.rules >/usr/X11R6/lib/X11/config/darwinLib.rules.tmp
    mv -f /usr/X11R6/lib/X11/config/darwinLib.rules.tmp /usr/X11R6/lib/X11/config/darwinLib.rules
    echo
  fi
fi

<<
Maintainer: Benjamin Reed <ranger@befunk.com>
