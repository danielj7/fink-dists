diff -Nurd -x'*~' libgtop-2.14.1.orig/configure.in libgtop-2.14.1/configure.in
--- libgtop-2.14.1.orig/configure.in	2006-04-09 06:50:54.000000000 -0400
+++ libgtop-2.14.1/configure.in	2006-05-25 00:24:14.000000000 -0400
@@ -394,6 +394,7 @@
 sysdeps/freebsd/Makefile
 sysdeps/solaris/Makefile
 sysdeps/aix/Makefile
+sysdeps/darwin/Makefile
 src/Makefile
 src/daemon/Makefile
 src/inodedb/Makefile
diff -Nurd -x'*~' libgtop-2.14.1.orig/include/glibtop/version.h libgtop-2.14.1/include/glibtop/version.h
--- libgtop-2.14.1.orig/include/glibtop/version.h	2004-11-12 19:53:20.000000000 -0500
+++ libgtop-2.14.1/include/glibtop/version.h	2006-05-25 02:38:15.000000000 -0400
@@ -24,7 +24,7 @@
 
 #include <glibtop.h>
 
-#define LIBGTOP_VERSION_STRING "Libgtop %s server version %s (%u,%u,%u,%u)."
+#define LIBGTOP_VERSION_STRING "Libgtop %s server version %s (%lu,%lu,%lu,%lu)."
 
 G_BEGIN_DECLS
 
diff -Nurd -x'*~' libgtop-2.14.1.orig/lib/open.c libgtop-2.14.1/lib/open.c
--- libgtop-2.14.1.orig/lib/open.c	2006-04-10 04:41:46.000000000 -0400
+++ libgtop-2.14.1/lib/open.c	2006-05-25 01:06:59.000000000 -0400
@@ -149,7 +149,7 @@
 
 		if (nbytes != size)
 			glibtop_error_r (server,
-					 "Requested %u bytes but got %u.",
+					 "Requested %lu bytes but got %lu.",
 					 size, nbytes);
 
 		glibtop_read_l (server, nbytes, buffer);
diff -Nurd -x'*~' libgtop-2.14.1.orig/libgtop-sysdeps.m4 libgtop-2.14.1/libgtop-sysdeps.m4
--- libgtop-2.14.1.orig/libgtop-sysdeps.m4	2006-04-09 06:23:03.000000000 -0400
+++ libgtop-2.14.1/libgtop-sysdeps.m4	2006-05-25 00:23:23.000000000 -0400
@@ -102,6 +102,12 @@
 	      libgtop_use_machine_h=yes
 	      libgtop_need_server=yes
 	      ;;
+	    darwin*)
+	      libgtop_sysdeps_dir=darwin
+	      libgtop_use_machine_h=yes
+	      libgtop_need_server=yes
+	      libgtop_postinstall='chgrp kmem $(DESTDIR)$(bindir)/libgtop_server2 && chmod 6755 $(DESTDIR)/$(bindir)/libgtop_server2'
+	      ;;
 	    *)
 	      libgtop_sysdeps_dir=stub
 	      libgtop_use_machine_h=no
diff -Nurd -x'*~' libgtop-2.14.1.orig/ltmain.sh libgtop-2.14.1/ltmain.sh
--- libgtop-2.14.1.orig/ltmain.sh	2006-03-11 14:40:23.000000000 -0500
+++ libgtop-2.14.1/ltmain.sh	2006-05-24 21:17:06.000000000 -0400
@@ -2545,7 +2545,7 @@
 	   { test "$use_static_libs" = no || test -z "$old_library"; }; then
 	  if test "$installed" = no; then
 	    notinst_deplibs="$notinst_deplibs $lib"
-	    need_relink=yes
+	    need_relink=no
 	  fi
 	  # This is a shared library
 
@@ -4023,8 +4023,24 @@
 	  eval test_cmds=\"$archive_expsym_cmds\"
 	  cmds=$archive_expsym_cmds
 	else
+         if test "x$verstring" = "x0.0"; then
+             tmp_verstring=
+           else
+             tmp_verstring="$verstring"
+           fi
+           save_deplibs="$deplibs"
+           for conv in $convenience; do
+             tmp_deplibs=
+             for test_deplib in $deplibs; do
+               if test "$test_deplib" != "$conv"; then
+                 tmp_deplibs="$tmp_deplibs $test_deplib"
+               fi
+             done
+             deplibs="$tmp_deplibs"
+           done
 	  eval test_cmds=\"$archive_cmds\"
 	  cmds=$archive_cmds
+	  deplibs="$save_deplibs"
 	  fi
 	fi
 
diff -Nurd -x'*~' libgtop-2.14.1.orig/src/daemon/Makefile.am libgtop-2.14.1/src/daemon/Makefile.am
--- libgtop-2.14.1.orig/src/daemon/Makefile.am	2004-03-04 10:29:12.000000000 -0500
+++ libgtop-2.14.1/src/daemon/Makefile.am	2006-05-25 03:52:41.000000000 -0400
@@ -50,5 +50,5 @@
 EXTRA_DIST			= server_config.h.in server_config.pl
 
 install-exec-hook:
-	-@libgtop_postinstall@
+	@libgtop_postinstall@
 
diff -Nurd -x'*~' libgtop-2.14.1.orig/src/daemon/main.c libgtop-2.14.1/src/daemon/main.c
--- libgtop-2.14.1.orig/src/daemon/main.c	2005-12-12 05:09:38.000000000 -0500
+++ libgtop-2.14.1/src/daemon/main.c	2006-05-25 01:04:50.000000000 -0400
@@ -54,7 +54,7 @@
 			glibtop_server_features);
 
     if (enable_debug)
-	syslog_message (LOG_DEBUG, "SIZEOF: %u - %u - %u - %u - %u - %u",
+	syslog_message (LOG_DEBUG, "SIZEOF: %lu - %lu - %lu - %lu - %lu - %lu",
 			sizeof (glibtop_command), sizeof (glibtop_response),
 			sizeof (glibtop_mountentry), sizeof (glibtop_union),
 			sizeof (glibtop_sysdeps),
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/Makefile.am libgtop-2.14.1/sysdeps/Makefile.am
--- libgtop-2.14.1.orig/sysdeps/Makefile.am	2004-12-06 09:44:11.000000000 -0500
+++ libgtop-2.14.1/sysdeps/Makefile.am	2006-05-25 01:15:30.000000000 -0400
@@ -2,4 +2,4 @@
 SUBDIRS			= common @sysdeps_dir@
 
 DIST_SUBDIRS		= common linux osf1 \
-			  stub stub_suid sun4 freebsd solaris aix
+			  stub stub_suid sun4 freebsd solaris aix darwin
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/Makefile.am libgtop-2.14.1/sysdeps/darwin/Makefile.am
--- libgtop-2.14.1.orig/sysdeps/darwin/Makefile.am	2005-08-10 21:28:14.000000000 -0400
+++ libgtop-2.14.1/sysdeps/darwin/Makefile.am	2006-05-25 02:23:23.000000000 -0400
@@ -1,23 +1,16 @@
-LINK				= $(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -o $@
-
-INCLUDES			= @INCLUDES@
+INCLUDES			= @INCLUDES@ @LIBGTOP_INCS@
 
 noinst_LTLIBRARIES			= libgtop_sysdeps-2.0.la libgtop_sysdeps_suid-2.0.la
 
-libgtop_sysdeps_2_0_la_SOURCES	= open.c close.c siglist.c cpu.c mem.c \
-                                  safeio.c swap.c uptime.c loadavg.c \
-                                  proclist.c procstate.c procuid.c \
-                                  proctime.c procmem.c procsignal.c \
-                                  prockernel.c procsegment.c procargs.c \
-                                  procmap.c netload.c ppp.c procdata.c
-
-libgtop_sysdeps_2_0_la_LDFLAGS	= $(LT_VERSION_INFO)
-
-libgtop_sysdeps_suid_2_0__la_SOURCES	= shm_limits.c msg_limits.c sem_limits.c
+libgtop_sysdeps_2_0_la_SOURCES	= nosuid.c siglist.c sysinfo.c
 
-libgtop_sysdeps_suid_la_LDFLAGS	= $(LT_VERSION_INFO)
+libgtop_sysdeps_suid_2_0_la_SOURCES = open.c close.c \
+cpu.c mem.c swap.c uptime.c loadavg.c shm_limits.c msg_limits.c \
+sem_limits.c proclist.c procstate.c procuid.c proctime.c \
+procmem.c procsignal.c prockernel.c procsegment.c procargs.c \
+procmap.c netload.c ppp.c netlist.c procopenfiles.c
 
 libgtopinclude_HEADERS		= glibtop_server.h glibtop_machine.h
-libgtopincludedir		= $(includedir)/libgtop-1.0
+libgtopincludedir		= $(includedir)/libgtop-2.0
 
 noinst_HEADERS			= glibtop_suid.h
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/cpu.c libgtop-2.14.1/sysdeps/darwin/cpu.c
--- libgtop-2.14.1.orig/sysdeps/darwin/cpu.c	2005-08-10 21:28:14.000000000 -0400
+++ libgtop-2.14.1/sysdeps/darwin/cpu.c	2006-05-25 02:49:59.000000000 -0400
@@ -31,7 +31,8 @@
 {
 	processor_cpu_load_info_data_t *pinfo;
 	mach_msg_type_number_t info_count;
-	natural_t i, processor_count;
+	natural_t processor_count;
+	int i;
 
 	glibtop_init_p (server, (1 << GLIBTOP_SYSDEPS_CPU), 0);
 
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/glibtop_machine.h libgtop-2.14.1/sysdeps/darwin/glibtop_machine.h
--- libgtop-2.14.1.orig/sysdeps/darwin/glibtop_machine.h	2005-08-10 21:28:14.000000000 -0400
+++ libgtop-2.14.1/sysdeps/darwin/glibtop_machine.h	2006-05-24 22:17:28.000000000 -0400
@@ -3,6 +3,9 @@
 
 G_BEGIN_DECLS
 
+#include <sys/types.h>
+#include <unistd.h>
+
 typedef struct _glibtop_machine		glibtop_machine;
 
 struct _glibtop_machine
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/glibtop_server.h libgtop-2.14.1/sysdeps/darwin/glibtop_server.h
--- libgtop-2.14.1.orig/sysdeps/darwin/glibtop_server.h	2005-08-10 21:28:14.000000000 -0400
+++ libgtop-2.14.1/sysdeps/darwin/glibtop_server.h	2006-05-24 22:52:09.000000000 -0400
@@ -45,6 +45,7 @@
 #define GLIBTOP_SUID_PROC_ARGS		(1 << GLIBTOP_SYSDEPS_PROC_ARGS)
 #define GLIBTOP_SUID_PROC_MAP		(1 << GLIBTOP_SYSDEPS_PROC_MAP)
 #define GLIBTOP_SUID_NETLOAD		(1 << GLIBTOP_SYSDEPS_NETLOAD)
+#define GLIBTOP_SUID_NETLIST		0
 #define GLIBTOP_SUID_PPP		(1 << GLIBTOP_SYSDEPS_PPP)
 
 G_END_DECLS
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/nosuid.c libgtop-2.14.1/sysdeps/darwin/nosuid.c
--- libgtop-2.14.1.orig/sysdeps/darwin/nosuid.c	2005-08-10 21:28:14.000000000 -0400
+++ libgtop-2.14.1/sysdeps/darwin/nosuid.c	2006-05-25 01:02:52.000000000 -0400
@@ -6,6 +6,8 @@
 #include <mach/mach_init.h>
 #include <mach/mach_interface.h>
 
+#include <glibtop/error.h>
+
 void
 glibtop_open_s (glibtop *server, const char *program_name,
 		const unsigned long features, const unsigned flags)
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/open.c libgtop-2.14.1/sysdeps/darwin/open.c
--- libgtop-2.14.1.orig/sysdeps/darwin/open.c	2005-08-10 21:28:14.000000000 -0400
+++ libgtop-2.14.1/sysdeps/darwin/open.c	2006-05-24 22:18:39.000000000 -0400
@@ -6,6 +6,9 @@
 #include <mach/mach_init.h>
 #include <mach/mach_interface.h>
 
+#include <glibtop/init_hooks.h>
+#include <glibtop/error.h>
+
 /* !!! THIS FUNCTION RUNS SUID ROOT - CHANGE WITH CAUTION !!! */
 
 void
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/procargs.c libgtop-2.14.1/sysdeps/darwin/procargs.c
--- libgtop-2.14.1.orig/sysdeps/darwin/procargs.c	2005-08-10 21:28:14.000000000 -0400
+++ libgtop-2.14.1/sysdeps/darwin/procargs.c	2006-05-24 22:26:47.000000000 -0400
@@ -28,7 +28,8 @@
 	char argbuf[4096];
 	char *start, *end, *str;
 	size_t bufsize = 4096;
-	int mib [3], length;
+	int mib [3];
+	unsigned length;
 	char *args;
 	int *ip;
 
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/proclist.c libgtop-2.14.1/sysdeps/darwin/proclist.c
--- libgtop-2.14.1.orig/sysdeps/darwin/proclist.c	2005-08-10 21:28:14.000000000 -0400
+++ libgtop-2.14.1/sysdeps/darwin/proclist.c	2006-05-24 22:25:34.000000000 -0400
@@ -23,9 +23,9 @@
 glibtop_get_proclist_p (glibtop *server, glibtop_proclist *buf,
 			int64_t which, int64_t arg)
 {
-	unsigned count, total;
+	unsigned count, total, i;
 	unsigned *pids_chain;
-	int i, mib[4];
+	int mib[4];
 	struct kinfo_proc *kp;
 	size_t length;
 
diff -Nurd -x'*~' libgtop-2.14.1.orig/sysdeps/darwin/sysinfo.c libgtop-2.14.1/sysdeps/darwin/sysinfo.c
--- libgtop-2.14.1.orig/sysdeps/darwin/sysinfo.c	1969-12-31 19:00:00.000000000 -0500
+++ libgtop-2.14.1/sysdeps/darwin/sysinfo.c	2006-05-25 00:17:49.000000000 -0400
@@ -0,0 +1,92 @@
+/* Copyright (C) 1998-99 Martin Baulig
+   This file is part of LibGTop 1.0.
+
+   Contributed by Martin Baulig <martin@home-of-linux.org>, April 1998.
+
+   LibGTop is free software; you can redistribute it and/or modify it
+   under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License,
+   or (at your option) any later version.
+
+   LibGTop is distributed in the hope that it will be useful, but WITHOUT
+   ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+   FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
+   for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with LibGTop; see the file COPYING. If not, write to the
+   Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+   Boston, MA 02111-1307, USA.
+*/
+
+#include <config.h>
+#include <sys/param.h>
+#include <sys/types.h>
+#include <sys/sysctl.h>
+#include <glibtop/error.h>
+#include <glibtop/cpu.h>
+#include <glibtop/sysinfo.h>
+
+static const unsigned long _glibtop_sysdeps_sysinfo =
+(1L << GLIBTOP_SYSINFO_CPUINFO);
+
+static glibtop_sysinfo sysinfo = { .flags = 0 };
+
+static void
+init_sysinfo (glibtop *server)
+{
+	char *model;
+	guint64 ncpus = 1;
+	int mhz = 0;
+	size_t len;
+
+	if (G_LIKELY (sysinfo.flags))
+		return;
+
+	glibtop_init_s (&server, GLIBTOP_SYSDEPS_CPU, 0);
+
+	len = sizeof (ncpus);
+	sysctlbyname ("hw.ncpu", &ncpus, &len, NULL, 0);
+	len = 0;
+	sysctlbyname ("hw.model", NULL, &len, NULL, 0);
+	model = g_malloc (len);
+	sysctlbyname ("hw.model", model, &len, NULL, 0);
+	len = sizeof (mhz);
+	sysctlbyname ("hw.cpufrequency", &mhz, &len, NULL, 0);
+	mhz = mhz / 1000000;
+
+	for (sysinfo.ncpu = 0;
+	     sysinfo.ncpu < GLIBTOP_NCPU && sysinfo.ncpu < ncpus;
+	     sysinfo.ncpu++) {
+		glibtop_entry * const cpuinfo = &sysinfo.cpuinfo[sysinfo.ncpu];
+
+		cpuinfo->labels = g_ptr_array_new ();
+
+		cpuinfo->values = g_hash_table_new_full(g_str_hash,
+							g_str_equal,
+							NULL, g_free);
+
+		g_ptr_array_add (cpuinfo->labels, "processor");
+		g_hash_table_insert (cpuinfo->values, "processor",
+				     g_strdup_printf("%u", (guint)sysinfo.ncpu));
+
+		g_ptr_array_add (cpuinfo->labels, "vendor_id");
+		g_hash_table_insert (cpuinfo->values, "vendor_id",
+				     g_strdup(model));
+
+		g_ptr_array_add (cpuinfo->labels, "cpu MHz");
+		g_hash_table_insert (cpuinfo->values, "cpu MHz",
+				     g_strdup_printf("%d", mhz));
+	}
+
+	g_free (model);
+
+	sysinfo.flags = _glibtop_sysdeps_sysinfo;
+}
+
+const glibtop_sysinfo *
+glibtop_get_sysinfo_s (glibtop *server)
+{
+	init_sysinfo (server);
+	return &sysinfo;
+}
