Package: ccp4
Version: 6.0.99e
Revision: 3
Distribution: 10.5
GCC: 1
Source: ftp://ftp.%n.ac.uk/%n/6.1/%n-%v-core-src.tar.gz
Source-MD5: f36be231a4c89f53eafc1c281d07ad47
SourceDirectory: %n-%v
Source2: http://chemistry.ucsc.edu/~wgscott/xtal/xtalfink/XCCPJiffy-custom.gz
Source2-MD5: 21568dd2475505929573a3fd452c538f
Source3: ftp://ftp.ccp4.ac.uk/ccp4/6.1/ccp4-6.0.99e-phaser-src.tar.gz
Source3-MD5: 10ea5d1115b19110fa5c0111de766f6d
#
DescPort: <<
    CCP4 is designed to compile with gfortran on OS X >= 10.4 by default. 
    Jack Howarth has provided multiple improvements in the patch file to
    address several bugs and to permit optimization with gfortran at -O3.
    
    Users typically install all of the ccp4 files into /xtal/ccp4-%v or
    into /usr/local/xtal/ccp4-%v.  In the present case, these files are
    installed into %p/share/xtal/ccp4-%v.  The library files are installed 
    into the directory %p/lib/ccp4-%v and this directory is symbolically 
    linked to %p/share/xtal/ccp4-%v/lib which is the canonical location.
    Dynamic libraries are provided in the ccp4-shlibs splitoff package, and
    static libraries are provided in the ccp4-dev splitoff package. The 
    configure files are patched so that the full path to the dynamic 
    libraries is hard-coded, per fink policy.  This obviates the need to
    set the DYLD_LIBRARY_PATH environment variable, which should remain
    unset. The appropriate shell startup files are automatically sourced
    when %p/bin/init.(c)sh is invoked upon shell startup; there is no 
    need to do so manually. The actual files are located in $CCP4/include.
    
    If needed, please install the phaser, pointless and cctbx fink packages.
    
    The ccp4i mail utility by default will only work on machines that run
    a mail server.  As a workaround, a public domain perl script called
    osx_ccp4_mail is installed that glues the ccp4i mail button to the
    Apple OS X Mail.app.
    
    Further adaptations are commented in place in the patch, configure and
    install scripts below. Relevant patches specific to this version that
    are issued by CCP4 are now downloaded and applied individually, helping
    to keep the ccp4.patch file from growing metastatically and also to
    permit the user to verify that the latest patches have been applied.
    These start with Source5 (above) and are applied individually at the
    end of the PatchScript field.
<<
Depends: <<
    x11, 
    fftw-shlibs | fftw-mpi-shlibs,
    tcltk,
    blt,
    gcc43-shlibs,
    %N-shlibs (= %v-%r)
<<
BuildDepends: <<
    gcc43, 
    fftw | fftw-mpi,
    f2c, 
    fort77, 
    tcltk-dev
<<
Replaces: phaser (<= 2.1.4-1), pointless (<= 1.2.18-1), mosflm (<= 7.0.3-3), mosflm-small (<= 7.0.3-3), refmac (<= 5.4-4), ccp4-shlibs (<= 6.0.2-9999), ccp4 (<= 6.0.2-9999), ccp4-dev (<= 6.0.2-9999), bundle-ccp4-intel, clipper-bin, ccp4-gfortran, ccp4-gfortran-dev, bundle-ccp4-powerpc
Conflicts: <<
	mosflm (<= 7.0.3-3), 
	mosflm-small (<= 7.0.3-3), 
	refmac (<= 5.4-4),
    ccp4-shlibs (<= 6.0.2-9999) , 
    ccp4 (<= 6.0.2-9999), 
    ccp4-dev (<= 6.0.2-9999), 
    bundle-ccp4-intel, 
    bundle-ccp4-powerpc, 
    ccp4-gfortran, 
    ccp4-gfortran-dev,
	phaser (<= 2.1.4-1),
	pointless (<= 1.2.18-1)
<<
NoSetCPPFLAGS: true
NoSetLDFLAGS: true
#
################################################################################
PatchScript: <<
    #!/bin/zsh -efv
    #
      umask 0022

    # Now apply the primary patch
      sed 's|@PREFIX@|%p|g' <%a/%n.patch | patch -p1
    # setup script for tcsh, zsh and bash users
      export TEMPXTAL=$PWD:h
    #
      perl -pi.bak -e 's|/xtal|\$TEMPXTAL|g' include/ccp4.setup*         # build prefix (changed in install)
      perl -pi.bak -e 's|/prefix|%p|g' include/ccp4.setup*               # location of tcktk, blt
      perl -pi.bak -e 's|/usr/local/bin|%p/bin|g' include/ccp4.setup*    # same
      perl -pi.bak -e 's|limit stacksize 65536|limit stacksize unlimited|g' include/ccp4.setup* # same
    #
      cp include/ccp4.setup-dist include/ccp4.setup
      rm -f include/ccp4.setup-sh   include/ccp4.setup*.bak
    #
    # Set up XCCPJiffy wrapper scripts in $CCP4/etc
    # These are small wrapper scripts for xplot84driver and xloggraph generated by the patch
      chmod a+x etc/x*
    # Fix the dylib install path in configure
      perl -pi.bak -e 's|\$rpath|%p/lib/ccp4-%v|g' **/configure
<<
################################################################################
CompileScript: <<
    #!/bin/zsh -efv
      umask 0022
    
    # The build will fail if Norton Auto-Protect is running.
    # Check to see if it is, and abort the installation with a
    # warning to the user.
    if  [[ $(ps axww | grep NortonAutoProtect | wc -l) -gt 1 ]];then
            print "\e[1m******************************************************************************************************"
            print "******************************************************************************************************"
            print "******************************************************************************************************"
            print ""
            print "Norton AutoProtect must be suspended during CCP4 installation. Please do so now and then try again."
            print ""
            print "******************************************************************************************************"
            print "******************************************************************************************************"
            print "******************************************************************************************************\e[0m"
            sleep 15
            return 1000
    fi
        
    
    # These are required for the build environment
      export TEMPXTAL=$PWD:h
      export CCP4_VERSION=""
      export CCP4_MASTER=""
      export BLTWISHPREFIX=""
      export CCP4=""
     
      source $PWD/include/ccp4.setup-zsh
      [[ -d $CCP4 ]] || exit 1
      export DYLD_LIBRARY_PATH=$CLIB
      export rpath=%p/lib/ccp4-%v
      export RPATH=%p/lib/ccp4-%v

# === CONFIGURE ===> 
FC="%p/lib/gcc4.3/bin/gfortran" F_LIBS="-L%p/lib/gcc4.3/lib" ./configure  --with-shared-libs  --with-x --with-fftw=%p  Darwin
# FC="%p/lib/gcc4.3/bin/gfortran" F_LIBS="-L%p/lib/gcc4.3/lib" ./configure --disable-pdb_extract --disable-cctbx --disable-phaser  --with-shared-libs  --with-x --with-fftw=%p  Darwin
 
    #  fix some post-configure bugs by getting rid of -lg2c
      perl -pi.bak -e 's|-lg2c||g' x-windows/**/*akefile*
    


#     if [[ $(uname -p) != powerpc ]];then 
#         perl -pi.bak -e 's|%p/lib/gcc4.3/bin/||g' lib/clipper/**/Makefile*
#       # Replace the ccp4 libtool file with one that works and compiles cpirate:
#         cp ../ccp4_i686-apple-darwin8.6.1_libtool.gz  lib/clipper/libtool.gz 
#         mv -f lib/clipper/libtool lib/clipper/libtool-dist
#         gunzip lib/clipper/libtool.gz
#         chmod a+x lib/clipper/libtool
#     fi

      ( cd x-windows/XCCPJIFFY; perl -pi.bak -e 's|-lgfortran|-lgfortran -L%p/lib/gcc4.3/lib |g' *akefile* ) || exit 1
if [[ $(sw_vers -productVersion) < 10.5 ]]; then
 :
else
      perl -pi.bak -e 's|-lcrt1.10.5.o||g' **/*akefile
      perl -pi.bak -e 's|-lcrt1.o||g' **/*akefile
fi
    
    #################
      make
      make install
    #################

    # xloggraph will fail, but we will link it with fort77 below
    #
    # Make wrappers for xplot84driver and xloggraph, so rename the executables
      cd  x-windows/XCCPJIFFY
      
      make msg_box.o ZDr2d.o EditString.o hardcopy_ctrl.o xloggraph.o log_file.o tom_fortran_interface.o bits_and_pieces.o graphics.o
      gcc -o xplot84driver xplot84driver.o plot84_file.o msg_box.o ZDr2d.o EditString.o hardcopy_ctrl.o -Os -I/usr/include/X11R6 -L/usr/X11/lib -lXaw -lXmu -lXt -lSM -lICE -lXpm -lXp -lXext -lX11 -lm -L/%p/lib/gcc4.3/lib -lgfortran  
      cp xplot84driver  $CBIN/xplot84driver.exe
      if [[ -x $CBIN/xplot84driver ]];then
          rm -f $CBIN/xplot84driver
      fi
      make xccpjiffy2idraw
      cp  xccpjiffy2idraw $CBIN/.
      cd ..
      make xdlmapman xdldataman
      cp  xdlmapman   $CBIN/.
      cp  xdldataman  $CBIN/.
    #
    # Manually link xloggraph with fort77 (fails in make)
      echo ""
      echo "**********************************************************************"
      echo "Re-linking xloggraph with fort77.  Ignore previous error messages."
      echo "**********************************************************************"
      echo ""
    #
      #perl -pi.bak -e 's|FC = g77 -fno-second-underscore||g' Makefile
      #make -i xloggraph  2>/dev/null
      cd  XCCPJIFFY
      fort77 -o xloggraph msg_box.o ZDr2d.o EditString.o hardcopy_ctrl.o xloggraph.o log_file.o tom_fortran_interface.o bits_and_pieces.o graphics.o -g -Os -I/usr/include/X11R6 -L/usr/X11R6/lib -lXaw -lXmu -lXt -lSM -lICE -lXpm -lXext -lX11 -lm -lgfortran -L%p/lib/gcc4.3/lib

    #
      sleep 10
    #
      cp xloggraph $CBIN/xloggraph.exe
      if [[ -x $CBIN/xloggraph ]];then
          rm -f $CBIN/xloggraph
      fi
      cd ../..
    #
   # Cleanup:
   #
   # make realclean
     /bin/rm -f **/*.o
     /bin/rm -f **/*.bak
     /bin/rm -Rf src 
     /bin/rm -Rf x-windows/libjwc/libjwc_c
     /bin/rm -Rf x-windows/libjwc/libjwc_f
     /bin/rm -Rf x-windows/xdl_view/src
    # remove redundant library junk
     /bin/rm -Rf lib/cctbx
     /bin/rm -Rf lib/**/.libs
     /bin/rm -f lib/ccif/libccif.dylib
     /bin/rm -f lib/src/libccp4c.dylib
     /bin/rm -f lib/src/libmmdb.dylib
   #/bin/rm -R unsupported
     /bin/rm -R testcomp* 
     /bin/rm -R BINARY*
     cd $CLIB
     /bin/rm -f **/*.c 
     /bin/rm -f **/*.f 
     /bin/rm -f **/*.cpp
#     echo "Compile Phase Completed!"
#     echo "There are $(command ls -1 $CBIN | wc -l) programs in $CBIN; "
#     echo "there should be 200"
<<
################################################################################
InstallScript: <<
    #!/bin/zsh -efv

      umask 0022
      export TEMPXTAL=$PWD:h
      source $PWD/include/ccp4.setup-zsh
      export DYLD_LIBRARY_PATH=$CLIB
      ORIGDIR=$(dirname $PWD)
    # Change environment scripts to match final installation
      perl -pi -e 's|\$TEMPXTAL|%p/share/xtal|g' include/ccp4.setup*      # install prefix
    #
    #
      cp ../XCCPJiffy-custom.gz  XCCPJiffy.gz ; gunzip XCCPJiffy.gz; chmod a+x XCCPJiffy
      perl -pi -e 's|5.0.1|%v|g' XCCPJiffy
      mv -f  XCCPJiffy lib/X11/app-defaults/XCCPJiffy
    #  
      perl -pi.bak -e 's|/src/fink.build/ccp4-%v-%r|/share/xtal|g' bin/clipper-config
      rm -f bin/clipper-config.bak
      perl -pi.bak -e 's|lclipper |lclipper-core |g' bin/clipper-config
      rm -f bin/clipper-config.bak                                
      perl -pi.bak -e 's|lib/lib -lrfftw -lfftw |lib/ccp4-%v -lsrfftw -lsfftw |g' bin/clipper-config
      rm -f bin/clipper-config.bak                                
    #
    # Fix path in libfoo.la libtool files:
    #  
      perl -pi.bak -e 's|/src/fink.build/ccp4-%v-%r/ccp4-%v/lib|/lib/ccp4-%v|g' lib/**/*.la
      perl -pi.bak -e 's|/src/fink.build/ccp4-%v-%r/ccp4-%v/src|/share/xtal/ccp4-%v/src|g' lib/python2.5/site-packages/libxml2mod.la
      rm -f lib/**/*.la.bak
    #
    # Now install:
    #
      mkdir -p %i/lib
      cp -R lib %i/lib/ccp4-%v
      mkdir -p %i/bin
    #
      mkdir -p %i/share/xtal/ccp4-%v/help
      mkdir -p %i/share/man/man1
    # set up man pages in a fink-compliant manner
      cd $PWD/doc
      mv rasmol.doc eightbit_rasmol.doc
      foreach docfilepage ( *.doc )
          cp ${docfilepage}  %i/share/man/man1/${docfilepage:r}.1
          cp ${docfilepage}  %i/share/xtal/ccp4-%v/help/${docfilepage:r}
      end
    # back to build directory
      cd ..
    #                                
      /bin/rm -rf lib 
      cp -R * %i/share/xtal/ccp4-%v/.
      ln -s   %p/lib/ccp4-%v      %i/share/xtal/ccp4-%v/lib
    #
    # making scripts for %p/etc/profile.d  
      mkdir -p %i/etc/profile.d
    #
      echo "source %p/share/xtal/ccp4-%v/include/ccp4.setup"                 > %i/etc/profile.d/ccp4.csh
      echo "setenv CLIB %p/lib/ccp4-%v "                                    >> %i/etc/profile.d/ccp4.csh
    #

      echo "if [ -z \$ZSH_NAME ];then                           "             > %i/etc/profile.d/ccp4.sh 
      echo "    source %p/share/xtal/ccp4-%v/include/ccp4.setup-bash "       >> %i/etc/profile.d/ccp4.sh    
      echo "else                                               "             >> %i/etc/profile.d/ccp4.sh
      echo "    source %p/share/xtal/ccp4-%v/include/ccp4.setup-zsh"         >> %i/etc/profile.d/ccp4.sh
      echo "fi                                                 "             >> %i/etc/profile.d/ccp4.sh
      echo "export CLIB=%p/lib/ccp4-%v "                                     >> %i/etc/profile.d/ccp4.sh
    #
      chmod a+x %i/etc/profile.d/ccp4.*
    #
      chmod a+x  %i/share/xtal/ccp4-%v/ccp4i/etc/osx_ccp4_mail
    #
    # chmod a+x %i/share/xtal/ccp4-%v/etc/ccp4help 
    #
      ranlib %i/lib/ccp4-%v/*.a
      ranlib %i/lib/ccp4-%v/**/*.a
    #
<<
################################################################################
PostInstScript: <<
    # Make the user read the license conditions
    more %p/share/xtal/ccp4-%v/conditions.txt
<<
################################################################################
################################################################################
SplitOff: <<
    Package: %N-shlibs
    Description: CCP4 dynamic libraries
    Files:<<
        lib/ccp4-%v/*.dylib  
    <<
    Shlibs: <<
        %p/lib/ccp4-%v/libDiffractionImage.0.0.0.dylib               1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libDiffractionImage.0.dylib                   1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libDiffractionImage.dylib                     1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libccif.dylib                                 0.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libccp4c.dylib                                0.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-ccp4.2.0.0.dylib                   3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-ccp4.2.dylib                       3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-ccp4.dylib                         3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-cif.2.0.0.dylib                    3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-cif.2.dylib                        3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-cif.dylib                          3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-cns.0.0.0.dylib                    1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-cns.0.dylib                        1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-cns.dylib                          1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-contrib.2.0.0.dylib                3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-contrib.2.dylib                    3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-contrib.dylib                      3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-core.2.0.0.dylib                   3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-core.2.dylib                       3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-core.dylib                         3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-minimol.2.0.0.dylib                3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-minimol.2.dylib                    3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-minimol.dylib                      3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-mmdb.2.0.0.dylib                   3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-mmdb.2.dylib                       3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-mmdb.dylib                         3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-phs.2.0.0.dylib                    3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-phs.2.dylib                        3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libclipper-phs.dylib                          3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libcord.1.0.3.dylib                           2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libcord.1.dylib                               2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libcord.dylib                                 2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libgc.1.0.3.dylib                             2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libgc.1.dylib                                 2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libgc.dylib                                   2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libjwc_c.0.1.1.dylib                          2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libjwc_c.0.dylib                              2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libjwc_c.dylib                                2.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libmmdb.dylib                                 0.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libssm.0.0.0.dylib                            1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libssm.0.dylib                                1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libssm.dylib                                  1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxdl_view.2.0.0.dylib                       3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxdl_view.2.dylib                           3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxdl_view.dylib                             3.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxdl_viewextra.0.0.0.dylib                  1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxdl_viewextra.0.dylib                      1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxdl_viewextra.dylib                        1.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxml2.2.6.26.dylib                          9.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxml2.2.dylib                               9.0.0  %n   (>= 6.0.99e-1)
        %p/lib/ccp4-%v/libxml2.dylib                                 9.0.0  %n   (>= 6.0.99e-1)
    <<
    DocFiles:  CHANGES COPYING INSTALL INSTALL.html INSTALL.ps README PROBLEMS academic_software_licence.pdf
<<
################################################################################
################################################################################
SplitOff2: <<
    Package: %N-dev
    BuildDependsOnly: true
    Description: CCP4 static libraries and libtool files
    Files:<<
        lib/ccp4-%v/*.a  
        lib/ccp4-%v/*.la
    <<
    DocFiles:  CHANGES COPYING INSTALL INSTALL.html INSTALL.ps README PROBLEMS academic_software_licence.pdf
<<
################################################################################
Description:  Macromolecular crystallography package
DescDetail: <<
    The CCP4 macromolecular crystallography suite has approximately
    200 programs and utilities. This version includes the Clipper
    libraries. Current phaser and cctbx programs are available as 
    separate fink packages.

    Type "ccp4help" for a summary listing of all ccp4 programs.
    Type "ccp4help foo" for a detailed description of program "foo."

    Invoke optional ccp4i gui for the first run using "sudo ccp4i"
    on 10.4, or "sudo -s" followed by "ccp4i" on 10.5 to permit
    global configuration. Thereafter, you can invoke ccp4i without sudo.

    This version compiles with the Apple Lapack/Blas framework.
    License agreement is part of configure file -- print out form and mail in,
    additional comments at http://sage.ucsc.edu/xtal/ccp4.html
    
    CCP4 files will be installed under /sw/share/xtal/ccp4-6.0.2
    This revision includes all available CCP4 patches as of June 28, 2007. 
    and new bash and zsh command completions specific to ccp4. 
    
    A new version of phaser (2.1.1) is available separately in fink as
    a package called, imaginatively, phaser. 
    
    A new version of cctbx is available in fink from the cctbx package.
    
    A new version of pointless is available as a separate fink package
    of that name.
    
    The ccp4-associated chooch package is available separately via fink.
    
    The latest version of mosflm is available in two forms from fink; the
    standard large form, and a special small display useful for 13 inch
    laptop displays.
    
    The ccp4-associated molecular graphics display program coot is also
    available as a fink package.
    
    Thanks to Jack Howarth for many helpful improvements.
<<
DocFiles: <<
    README CHANGES COPYING PROBLEMS INSTALL INSTALL.html INSTALL.ps 
    ccp4i_installation.html academic_software_licence.pdf  
    academic_software_licence.ps.gz  academic_software_licence.rtf
<<
Homepage: http://www.ccp4.ac.uk  
License: Commercial
Maintainer: W. G. Scott <wgscott@users.sourceforge.net>
