diff -uNr kdesdk-3.4.0/cervisia/Makefile.am kdesdk-3.4.0-new/cervisia/Makefile.am
--- kdesdk-3.4.0/cervisia/Makefile.am	2005-02-03 17:57:03.000000000 -0500
+++ kdesdk-3.4.0-new/cervisia/Makefile.am	2005-05-11 12:28:27.000000000 -0400
@@ -3,7 +3,9 @@
 
 SUBDIRS = cvsservice . pics
 
-bin_PROGRAMS = cervisia
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = cervisia.la
 kde_module_LTLIBRARIES = libcervisiapart.la
 noinst_LTLIBRARIES = libcervisia.la
 
@@ -27,10 +29,10 @@
 		   cvsservice/libcvsservice.la libcervisia.la
 libcervisiapart_la_COMPILE_FIRST = cvsservice/cvsservice_stub.h cervisiasettings.h
 
-cervisia_SOURCES = main.cpp cervisiashell.cpp
-cervisia_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-cervisia_LDADD = $(LIB_KPARTS) $(LIB_KUTILS) cvsservice/libcvsservice.la libcervisia.la
-cervisia_COMPILE_FIRST = cvsservice/cvsservice_stub.h cervisiasettings.h
+cervisia_la_SOURCES = main.cpp cervisiashell.cpp
+cervisia_la_LDFLAGS = $(all_libraries) $(KDE_RPATH) -module $(KDE_PLUGIN)
+cervisia_la_LIBADD = $(LIB_KPARTS) $(LIB_KUTILS) cvsservice/libcvsservice.la libcervisia.la
+cervisia_la_COMPILE_FIRST = cvsservice/cvsservice_stub.h cervisiasettings.h
 
 man_MANS = cervisia.1
 
diff -uNr kdesdk-3.4.0/cervisia/cvsservice/Makefile.am kdesdk-3.4.0-new/cervisia/cvsservice/Makefile.am
--- kdesdk-3.4.0/cervisia/cvsservice/Makefile.am	2004-08-27 11:24:38.000000000 -0400
+++ kdesdk-3.4.0-new/cervisia/cvsservice/Makefile.am	2005-05-11 12:28:27.000000000 -0400
@@ -8,18 +8,19 @@
 INCLUDES = $(all_includes)
 
 # cvs DCOP service
-bin_PROGRAMS = cvsservice cvsaskpass
+bin_PROGRAMS =
+kdeinit_LTLIBRARIES = cvsservice.la cvsaskpass.la
 
-cvsservice_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-cvsservice_LDADD = $(LIB_KIO)
-cvsservice_SOURCES = main.cpp cvsservice.cpp cvsjob.cpp \
+cvsservice_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+cvsservice_la_LIBADD = $(LIB_KIO)
+cvsservice_la_SOURCES = main.cpp cvsservice.cpp cvsjob.cpp \
 	cvsservice.skel cvsservice.stub cvsjob.skel cvsjob.stub \
 	repository.cpp repository.skel repository.stub sshagent.cpp \
 	cvsserviceutils.cpp cvsloginjob.cpp cvsloginjob.skel cvsloginjob.stub
 
-cvsaskpass_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-cvsaskpass_LDADD = $(LIB_KDEUI)
-cvsaskpass_SOURCES = cvsaskpass.cpp
+cvsaskpass_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+cvsaskpass_la_LIBADD = $(LIB_KDEUI)
+cvsaskpass_la_SOURCES = cvsaskpass.cpp
 
 include_HEADERS = cvsservice_stub.h cvsjob_stub.h repository_stub.h
 noinst_HEADERS = cvsservice.h cvsjob.h repository.h cvsserviceutils.h \
@@ -30,7 +31,12 @@
 
 libcvsservice_la_LDFLAGS = $(all_libraries) -no-undefined -version-info 0:1
 libcvsservice_la_LIBADD = $(LIB_KDECORE)
-libcvsservice_la_SOURCES = cvsservice.stub cvsjob.stub repository.stub
+libcvsservice_la_SOURCES = cvsservice.stub cvsjob.stub repository.stub dummy.cpp
+
+DISTCLEANFILES = dummy.cpp
+
+dummy.cpp:
+	echo > dummy.cpp
 
 # let automoc handle all of the meta source files (moc)
 METASOURCES = AUTO
diff -uNr kdesdk-3.4.0/cervisia/cvsservice/cvsaskpass.cpp kdesdk-3.4.0-new/cervisia/cvsservice/cvsaskpass.cpp
--- kdesdk-3.4.0/cervisia/cvsservice/cvsaskpass.cpp	2003-10-14 15:11:56.000000000 -0400
+++ kdesdk-3.4.0-new/cervisia/cvsservice/cvsaskpass.cpp	2005-05-11 12:28:27.000000000 -0400
@@ -35,7 +35,7 @@
 };
 
 
-int main(int argc, char** argv)
+extern "C" int kdemain(int argc, char** argv)
 {
     KAboutData about("cvsaskpass", I18N_NOOP("cvsaskpass"), "0.1",
                      I18N_NOOP("ssh-askpass for the CVS DCOP Service"),
diff -uNr kdesdk-3.4.0/cervisia/cvsservice/main.cpp kdesdk-3.4.0-new/cervisia/cvsservice/main.cpp
--- kdesdk-3.4.0/cervisia/cvsservice/main.cpp	2003-02-06 16:22:31.000000000 -0500
+++ kdesdk-3.4.0-new/cervisia/cvsservice/main.cpp	2005-05-11 12:28:27.000000000 -0400
@@ -25,7 +25,7 @@
 #include "cvsservice.h"
 
 
-int main(int argc, char** argv)
+extern "C" int kdemain(int argc, char** argv)
 {
     KAboutData about("cvsservice", I18N_NOOP("CVS DCOP service"), "0.1",
             I18N_NOOP("DCOP service for CVS"), KAboutData::License_LGPL,
diff -uNr kdesdk-3.4.0/cervisia/main.cpp kdesdk-3.4.0-new/cervisia/main.cpp
--- kdesdk-3.4.0/cervisia/main.cpp	2004-09-09 15:56:06.000000000 -0400
+++ kdesdk-3.4.0-new/cervisia/main.cpp	2005-05-11 12:28:27.000000000 -0400
@@ -131,7 +131,7 @@
 }
 
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     static KCmdLineOptions options[] = {
         { "+[directory]", I18N_NOOP("The sandbox to be loaded"), 0 },
diff -uNr kdesdk-3.4.0/kapptemplate/kapp/app-Makefile.am kdesdk-3.4.0-new/kapptemplate/kapp/app-Makefile.am
--- kdesdk-3.4.0/kapptemplate/kapp/app-Makefile.am	2004-02-11 07:27:02.000000000 -0500
+++ kdesdk-3.4.0-new/kapptemplate/kapp/app-Makefile.am	2005-05-11 12:28:27.000000000 -0400
@@ -8,28 +8,30 @@
 
 # this is the program that gets installed.  it's name is used for all
 # of the other Makefile.am variables
-bin_PROGRAMS = $APP_NAME_LC ${APP_NAME_LC}_client
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ${APP_NAME_LC}.la ${APP_NAME_LC}_client.la
 
 # set the include path for X, qt and KDE
 INCLUDES         = \$(all_includes)
 
 # the library search path. 
-${APP_NAME_LC}_LDFLAGS = \$(KDE_RPATH) \$(all_libraries)
+${APP_NAME_LC}_la_LDFLAGS = \$(KDE_PLUGIN) -module \$(all_libraries)
 
 # the libraries to link against.
-${APP_NAME_LC}_LDADD   = \$(LIB_KFILE) -lkdeprint
+${APP_NAME_LC}_la_LIBADD   = \$(LIB_KFILE) -lkdeprint
 
 # which sources should be compiled for $APP_NAME_LC
-${APP_NAME_LC}_SOURCES =	main.cpp ${APP_NAME_LC}.cpp ${APP_NAME_LC}view.cpp \\
+${APP_NAME_LC}_la_SOURCES =	main.cpp ${APP_NAME_LC}.cpp ${APP_NAME_LC}view.cpp \\
 					${APP_NAME_LC}pref.cpp ${APP_NAME_LC}iface.skel
 
 # these are the headers for your project
 noinst_HEADERS   = ${APP_NAME_LC}.h ${APP_NAME_LC}view.h ${APP_NAME_LC}pref.h
 
 # client stuff
-${APP_NAME_LC}_client_LDFLAGS = \$(KDE_RPATH) \$(all_libraries)
-${APP_NAME_LC}_client_LDADD   = \$(LIB_KDECORE)
-${APP_NAME_LC}_client_SOURCES = ${APP_NAME_LC}_client.cpp
+${APP_NAME_LC}_client_la_LDFLAGS = \$(KDE_PLUGIN) -module \$(all_libraries)
+${APP_NAME_LC}_client_la_LIBADD  = \$(LIB_KDECORE)
+${APP_NAME_LC}_client_la_SOURCES = ${APP_NAME_LC}_client.cpp
 
 # let automoc handle all of the meta source files (moc)
 METASOURCES = AUTO
diff -uNr kdesdk-3.4.0/kapptemplate/kapp/app_client.cpp kdesdk-3.4.0-new/kapptemplate/kapp/app_client.cpp
--- kdesdk-3.4.0/kapptemplate/kapp/app_client.cpp	2001-12-27 19:48:25.000000000 -0500
+++ kdesdk-3.4.0-new/kapptemplate/kapp/app_client.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -5,7 +5,7 @@
 #include <qdatastream.h>
 #include <qstring.h>
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KApplication app(argc, argv, "${APP_NAME_LC}_client", false);
 
diff -uNr kdesdk-3.4.0/kapptemplate/kapp/main.cpp kdesdk-3.4.0-new/kapptemplate/kapp/main.cpp
--- kdesdk-3.4.0/kapptemplate/kapp/main.cpp	2004-07-01 09:00:14.000000000 -0400
+++ kdesdk-3.4.0-new/kapptemplate/kapp/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -18,7 +18,7 @@
     KCmdLineLastOption
 };
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KAboutData about("${APP_NAME_LC}", I18N_NOOP("${APP_NAME}"), version, description, KAboutData::License_GPL, "(C) 2004 ${AUTHOR}", 0, 0, "${EMAIL}");
     about.addAuthor( "${AUTHOR}", 0, "${EMAIL}" );
diff -uNr kdesdk-3.4.0/kapptemplate/kpartapp/main.cpp kdesdk-3.4.0-new/kapptemplate/kpartapp/main.cpp
--- kdesdk-3.4.0/kapptemplate/kpartapp/main.cpp	2004-07-01 09:00:14.000000000 -0400
+++ kdesdk-3.4.0-new/kapptemplate/kpartapp/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -17,7 +17,7 @@
     KCmdLineLastOption
 };
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KAboutData about("${APP_NAME_LC}", I18N_NOOP("${APP_NAME}"), version, description, KAboutData::License_GPL, "(C) 2004 ${AUTHOR}", 0, 0, "${EMAIL}");
     about.addAuthor( "${AUTHOR}", 0, "${EMAIL}" );
diff -uNr kdesdk-3.4.0/kbabel/catalogmanager/Makefile.am kdesdk-3.4.0-new/kbabel/catalogmanager/Makefile.am
--- kdesdk-3.4.0/kbabel/catalogmanager/Makefile.am	2004-03-03 15:06:06.000000000 -0500
+++ kdesdk-3.4.0-new/kbabel/catalogmanager/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -7,7 +7,11 @@
 # this is the program that gets installed.  it's name is used for all
 # of the other Makefile.am variables
 noinst_LTLIBRARIES = libcatalogmanager.la
-bin_PROGRAMS = catalogmanager
+
+kdeinit_LTLIBRARIES = catalogmanager.la
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+
 
 # set the include path for X, qt and KDE. Let $(all_includes) be always last.
 INCLUDES         = -I$(srcdir)/../common -I../common -I$(srcdir)/../kbabeldict -I$(srcdir)/../commonui -I../commonui -I./libcvs -I$(srcdir)/libcvs $(all_includes)
@@ -26,11 +30,11 @@
 libcatalogmanager_la_LDFLAGS = $(all_libraries) -no-undefined
 
 
-catalogmanager_SOURCES = main.cpp
+catalogmanager_la_SOURCES = main.cpp
 
 # the libraries to link against.
-catalogmanager_LDADD   = libcatalogmanager.la
-catalogmanager_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+catalogmanager_la_LIBADD  = libcatalogmanager.la
+catalogmanager_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 # these are the headers for your project
 noinst_HEADERS   = catalogmanageriface.h catalogmanager.h \
diff -uNr kdesdk-3.4.0/kbabel/catalogmanager/main.cpp kdesdk-3.4.0-new/kbabel/catalogmanager/main.cpp
--- kdesdk-3.4.0/kbabel/catalogmanager/main.cpp	2005-02-23 05:40:26.000000000 -0500
+++ kdesdk-3.4.0-new/kbabel/catalogmanager/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -178,7 +178,7 @@
 };
 
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KLocale::setMainCatalogue("kbabel");
     KAboutData about("catalogmanager",I18N_NOOP("KBabel - Catalog Manager"),VERSION,
diff -uNr kdesdk-3.4.0/kbabel/commonui/Makefile.am kdesdk-3.4.0-new/kbabel/commonui/Makefile.am
--- kdesdk-3.4.0/kbabel/commonui/Makefile.am	2004-06-22 17:16:48.000000000 -0400
+++ kdesdk-3.4.0-new/kbabel/commonui/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -2,7 +2,7 @@
 
 # this is the program that gets installed.  it's name is used for all
 # of the other Makefile.am variables
-noinst_LTLIBRARIES = libkbabelcommonui.la
+lib_LTLIBRARIES = libkbabelcommonui.la
 
 # set the include path for X, qt and KDE. Put local paths before all_includes.
 INCLUDES         = -I$(srcdir)/../common -I../common -I$(srcdir)/../kbabeldict -I../kbabeldict $(all_includes)
diff -uNr kdesdk-3.4.0/kbabel/kbabel/Makefile.am kdesdk-3.4.0-new/kbabel/kbabel/Makefile.am
--- kdesdk-3.4.0/kbabel/kbabel/Makefile.am	2004-12-05 07:50:58.000000000 -0500
+++ kdesdk-3.4.0-new/kbabel/kbabel/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -10,7 +10,9 @@
 # this is the program that gets installed.  it's name is used for all
 # of the other Makefile.am variables
 noinst_LTLIBRARIES = libkbabel.la
-bin_PROGRAMS = kbabel
+kdeinit_LTLIBRARIES = kbabel.la
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
 
 # set the include path for X, qt and KDE
 INCLUDES         = -I$(srcdir)/../common -I../common -I$(srcdir)/../commonui -I../commonui -I$(srcdir)/../kbabeldict -I../kbabeldict $(all_includes)
@@ -45,11 +47,11 @@
 libkbabel_la_LDFLAGS = $(all_libraries)
 
 
-kbabel_SOURCES = main.cpp
+kbabel_la_SOURCES = main.cpp
 
 # the libraries to link against.
-kbabel_LDADD   = libkbabel.la
-kbabel_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kbabel_la_LIBADD  = libkbabel.la
+kbabel_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 # these are the headers for your project
 noinst_HEADERS   = kbabel.h kbabelview.h \
diff -uNr kdesdk-3.4.0/kbabel/kbabel/main.cpp kdesdk-3.4.0-new/kbabel/kbabel/main.cpp
--- kdesdk-3.4.0/kbabel/kbabel/main.cpp	2005-02-23 05:40:30.000000000 -0500
+++ kdesdk-3.4.0-new/kbabel/kbabel/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -503,7 +503,7 @@
 };
 
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KAboutData about("kbabel",I18N_NOOP("KBabel"),VERSION,
        I18N_NOOP("An advanced PO file editor"),KAboutData::License_GPL,
diff -uNr kdesdk-3.4.0/kbabel/kbabeldict/Makefile.am kdesdk-3.4.0-new/kbabel/kbabeldict/Makefile.am
--- kdesdk-3.4.0/kbabel/kbabeldict/Makefile.am	2003-09-05 07:25:42.000000000 -0400
+++ kdesdk-3.4.0-new/kbabel/kbabeldict/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -6,17 +6,15 @@
 
 pkgincludedir = $(includedir)/kbabel
 
-# this is the program that gets installed.  it's name is used for all
-# of the other Makefile.am variables
-noinst_LTLIBRARIES = libkbabeldict.la
-bin_PROGRAMS = kbabeldict
+bin_PROGRAMS = 
+kdeinit_LTLIBRARIES = kbabeldict.la
 
 # set the include path for X, qt and KDE
 INCLUDES         = -I$(srcdir)/../common -I$(top_builddir)/kbabel/common $(all_includes)
 
 
 # library for babeldict plugins
-lib_LTLIBRARIES = libkbabeldictplugin.la
+lib_LTLIBRARIES = libkbabeldictplugin.la libkbabeldict.la
 libkbabeldictplugin_la_SOURCES = searchengine.cpp 
 libkbabeldictplugin_la_LIBADD =  $(LIB_KDECORE)
 libkbabeldictplugin_la_LDFLAGS = -version-info 3:0:2 $(all_libraries)
@@ -28,11 +26,11 @@
 libkbabeldict_la_LDFLAGS = $(all_libraries) -no-undefined
 
 
-kbabeldict_SOURCES = main.cpp kbabeldictview.cpp kbabeldict.cpp kbabelsplash.cpp
+kbabeldict_la_SOURCES = main.cpp kbabeldictview.cpp kbabeldict.cpp kbabelsplash.cpp
 
 # the libraries to link against.
-kbabeldict_LDADD   = libkbabeldict.la
-kbabeldict_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kbabeldict_la_LIBADD  = libkbabeldict.la
+kbabeldict_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 # these are the headers for your project
 noinst_HEADERS   =  kbabeldict.h kbabeldictview.h kbabelsplash.h aboutmoduledlg.h
diff -uNr kdesdk-3.4.0/kbabel/kbabeldict/main.cpp kdesdk-3.4.0-new/kbabel/kbabeldict/main.cpp
--- kdesdk-3.4.0/kbabel/kbabeldict/main.cpp	2005-02-23 05:40:30.000000000 -0500
+++ kdesdk-3.4.0-new/kbabel/kbabeldict/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -107,7 +107,7 @@
 };
 
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KLocale::setMainCatalogue("kbabel");
     
diff -uNr kdesdk-3.4.0/kbugbuster/Makefile.am kdesdk-3.4.0-new/kbugbuster/Makefile.am
--- kdesdk-3.4.0/kbugbuster/Makefile.am	2004-07-16 04:00:41.000000000 -0400
+++ kdesdk-3.4.0-new/kbugbuster/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -6,12 +6,14 @@
 
 SUBDIRS = backend gui pics $(KRESOURCES_SUBDIR)
 
-bin_PROGRAMS = kbugbuster
+kdeinit_LTLIBRARIES = kbugbuster.la
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
 
-kbugbuster_SOURCES = main.cpp
-kbugbuster_LDADD   = -lkutils gui/libkbbmainwindow.la \
+kbugbuster_la_SOURCES = main.cpp
+kbugbuster_la_LIBADD  = -lkutils gui/libkbbmainwindow.la \
                      backend/libkbbbackend.la $(LIB_KHTML) $(LIB_KIO) 
-kbugbuster_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kbugbuster_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 xdg_apps_DATA = kbugbuster.desktop
 
diff -uNr kdesdk-3.4.0/kbugbuster/configure.in.in kdesdk-3.4.0-new/kbugbuster/configure.in.in
--- kdesdk-3.4.0/kbugbuster/configure.in.in	2004-05-03 04:16:57.000000000 -0400
+++ kdesdk-3.4.0-new/kbugbuster/configure.in.in	2005-05-11 12:28:28.000000000 -0400
@@ -2,6 +2,7 @@
 KDE_CHECK_HEADER(libkcal/resourcecalendar.h,HAVE_KCAL=1,
  AC_MSG_WARN([Unable to find libkcal. The Bugzilla todo list \
  resource for KOrganizer won't be compiled.]))
+HAVE_KCAL=0
 AM_CONDITIONAL(include_kcalresource, test "$HAVE_KCAL" = 1)
 ])
 
diff -uNr kdesdk-3.4.0/kbugbuster/main.cpp kdesdk-3.4.0-new/kbugbuster/main.cpp
--- kdesdk-3.4.0/kbugbuster/main.cpp	2004-06-21 14:57:56.000000000 -0400
+++ kdesdk-3.4.0-new/kbugbuster/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -42,7 +42,7 @@
   KCmdLineLastOption
 };
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
     KAboutData aboutData( "kbugbuster", I18N_NOOP( "KBugBuster" ),
         VERSION, description, KAboutData::License_GPL,
diff -uNr kdesdk-3.4.0/kcachegrind/kcachegrind/Makefile.am kdesdk-3.4.0-new/kcachegrind/kcachegrind/Makefile.am
--- kdesdk-3.4.0/kcachegrind/kcachegrind/Makefile.am	2005-02-03 17:57:04.000000000 -0500
+++ kdesdk-3.4.0-new/kcachegrind/kcachegrind/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -1,6 +1,8 @@
-bin_PROGRAMS = kcachegrind
+kdeinit_LTLIBRARIES = kcachegrind.la
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
 
-kcachegrind_SOURCES = \
+kcachegrind_la_SOURCES = \
  functionselectionbase.ui \
  stackselectionbase.ui \
  partselectionbase.ui \
@@ -19,9 +21,10 @@
  costlistitem.cpp partlistitem.cpp functionitem.cpp \
  instritem.cpp stackitem.cpp callgraphview.cpp
 
-kcachegrind_COMPILE_FIRST = ../version.h
+kcachegrind_la_COMPILE_FIRST = ../version.h
 
-kcachegrind_LDADD   =  $(LIB_KIO)
+kcachegrind_la_LIBADD  = $(LIB_KIO)
+kcachegrind_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 KDE_ICON = AUTO
 
@@ -43,9 +46,6 @@
 
 METASOURCES = AUTO
 
-# the library search path. 
-kcachegrind_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-
 rcdir = $(kde_datadir)/kcachegrind
 rc_DATA = kcachegrindui.rc
 
diff -uNr kdesdk-3.4.0/kcachegrind/kcachegrind/main.cpp kdesdk-3.4.0-new/kcachegrind/kcachegrind/main.cpp
--- kdesdk-3.4.0/kcachegrind/kcachegrind/main.cpp	2004-06-30 14:19:21.000000000 -0400
+++ kdesdk-3.4.0-new/kcachegrind/kcachegrind/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -40,7 +40,7 @@
   KCmdLineLastOption // End of options.
 };
 
-int main( int argc, char ** argv )
+extern "C" int kdemain( int argc, char ** argv )
 {
   KAboutData aboutData("kcachegrind",
                        I18N_NOOP("KCachegrind"),
diff -uNr kdesdk-3.4.0/kcachegrind/kcachegrind/sourceitem.h kdesdk-3.4.0-new/kcachegrind/kcachegrind/sourceitem.h
--- kdesdk-3.4.0/kcachegrind/kcachegrind/sourceitem.h	2004-04-02 08:00:42.000000000 -0500
+++ kdesdk-3.4.0-new/kcachegrind/kcachegrind/sourceitem.h	2005-05-11 12:28:28.000000000 -0400
@@ -25,6 +25,7 @@
 
 #include <qlistview.h>
 #include "tracedata.h"
+#undef fileno
 
 class SourceView;
 
diff -uNr kdesdk-3.4.0/kioslave/svn/configure.in.in kdesdk-3.4.0-new/kioslave/svn/configure.in.in
--- kdesdk-3.4.0/kioslave/svn/configure.in.in	2005-02-03 17:57:05.000000000 -0500
+++ kdesdk-3.4.0-new/kioslave/svn/configure.in.in	2005-05-11 12:29:15.000000000 -0400
@@ -142,3 +142,5 @@
 AC_SUBST(SVN_CPPFLAGS)
 AC_SUBST(SVNLD)
 AM_CONDITIONAL(include_kioslave_svn, test -n "$SVN_SUBDIR")
+
+export DO_NOT_COMPILE="$DO_NOT_COMPILE kioslave"
diff -uNr kdesdk-3.4.0/kmtrace/Makefile.am kdesdk-3.4.0-new/kmtrace/Makefile.am
--- kdesdk-3.4.0/kmtrace/Makefile.am	2005-02-03 17:57:05.000000000 -0500
+++ kdesdk-3.4.0-new/kmtrace/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -21,15 +21,16 @@
 LDADD = $(LIB_KDECORE) -liberty
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = kmtrace demangle kmmatch
-kmtrace_SOURCES = kmtrace.cpp
-kmtrace_LDFLAGS = $(all_libraries)
+kdeinit_LTLIBRARIES = kmtrace.la demangle.la kmmatch.la
+bin_PROGRAMS = 
+kmtrace_la_SOURCES = kmtrace.cpp
+kmtrace_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
-demangle_SOURCES = demangle.cpp
-demangle_LDFLAGS = $(all_libraries)
+demangle_la_SOURCES = demangle.cpp
+demangle_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
-kmmatch_SOURCES = match.cpp
-kmmatch_LDFLAGS = $(all_libraries)
+kmmatch_la_SOURCES = match.cpp
+kmmatch_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 bin_SCRIPTS = kminspector
 
diff -uNr kdesdk-3.4.0/kmtrace/demangle.cpp kdesdk-3.4.0-new/kmtrace/demangle.cpp
--- kdesdk-3.4.0/kmtrace/demangle.cpp	2002-05-18 07:54:37.000000000 -0400
+++ kdesdk-3.4.0-new/kmtrace/demangle.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -36,7 +36,7 @@
 }
 
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
    char buf[1024];
 
diff -uNr kdesdk-3.4.0/kmtrace/kmtrace.cpp kdesdk-3.4.0-new/kmtrace/kmtrace.cpp
--- kdesdk-3.4.0/kmtrace/kmtrace.cpp	2004-07-09 12:18:07.000000000 -0400
+++ kdesdk-3.4.0-new/kmtrace/kmtrace.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -576,7 +576,7 @@
   KCmdLineLastOption
 };
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
   KInstance instance("kmtrace");
 
diff -uNr kdesdk-3.4.0/kmtrace/match.cpp kdesdk-3.4.0-new/kmtrace/match.cpp
--- kdesdk-3.4.0/kmtrace/match.cpp	2003-02-26 00:09:41.000000000 -0500
+++ kdesdk-3.4.0-new/kmtrace/match.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -13,7 +13,7 @@
 #include <kstandarddirs.h>
 #include <kcmdlineargs.h>
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
    char buf[1024];
    if (argc != 3)
diff -uNr kdesdk-3.4.0/kompare/Makefile.am kdesdk-3.4.0-new/kompare/Makefile.am
--- kdesdk-3.4.0/kompare/Makefile.am	2005-02-03 17:57:05.000000000 -0500
+++ kdesdk-3.4.0-new/kompare/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -22,12 +22,14 @@
 #########################################################################
 # this is the program that gets installed.  it's name is used for all
 # of the other Makefile.am variables
-bin_PROGRAMS = kompare
+kdeinit_LTLIBRARIES = kompare.la
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
 
 # the application source, library search path, and link libraries
-kompare_SOURCES = main.cpp kompare_shell.cpp kompareurldialog.cpp
-kompare_LDFLAGS = $(all_libraries)
-kompare_LDADD   = $(LIB_KPARTS) \
+kompare_la_SOURCES = main.cpp kompare_shell.cpp kompareurldialog.cpp
+kompare_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kompare_la_LIBADD  = $(LIB_KPARTS) \
 	$(top_builddir)/kompare/interfaces/libkompareinterface.la \
 	$(top_builddir)/kompare/libdialogpages/libdialogpages.la \
 	-lktexteditor
diff -uNr kdesdk-3.4.0/kompare/main.cpp kdesdk-3.4.0-new/kompare/main.cpp
--- kdesdk-3.4.0/kompare/main.cpp	2005-02-23 05:40:34.000000000 -0500
+++ kdesdk-3.4.0-new/kompare/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -47,7 +47,7 @@
 	KCmdLineLastOption
 };
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
 	KAboutData aboutData( "kompare", I18N_NOOP("Kompare"), version, description,
 	                      KAboutData::License_GPL,
diff -uNr kdesdk-3.4.0/kspy/main.cpp kdesdk-3.4.0-new/kspy/main.cpp
--- kdesdk-3.4.0/kspy/main.cpp	2004-02-06 18:45:32.000000000 -0500
+++ kdesdk-3.4.0-new/kspy/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -32,7 +32,7 @@
   // INSERT YOUR COMMANDLINE OPTIONS HERE
 };
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
 
   KAboutData aboutData( "spy", I18N_NOOP("Spy"),
diff -uNr kdesdk-3.4.0/kstartperf/Makefile.am kdesdk-3.4.0-new/kstartperf/Makefile.am
--- kdesdk-3.4.0/kstartperf/Makefile.am	2002-03-08 11:07:31.000000000 -0500
+++ kdesdk-3.4.0-new/kstartperf/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -5,10 +5,11 @@
 # libkstartperf_la_LIBADD = ../libltdl/libltdlc.la
 libkstartperf_la_SOURCES = libkstartperf.c
 
-bin_PROGRAMS = kstartperf
-kstartperf_LDFLAGS = $(all_libraries)
-kstartperf_LDADD = $(LIB_KDECORE)
-kstartperf_SOURCES = kstartperf.cpp
+kdeinit_LTLIBRARIES = kstartperf.la
+bin_PROGRAMS = 
+kstartperf_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kstartperf_la_LIBADD = $(LIB_KDECORE)
+kstartperf_la_SOURCES = kstartperf.cpp
 
 messages:
 	$(XGETTEXT) $(kstartperf_SOURCES) -o $(podir)/kstartperf.pot
diff -uNr kdesdk-3.4.0/kstartperf/kstartperf.cpp kdesdk-3.4.0-new/kstartperf/kstartperf.cpp
--- kdesdk-3.4.0/kstartperf/kstartperf.cpp	2004-06-21 14:57:57.000000000 -0400
+++ kdesdk-3.4.0-new/kstartperf/kstartperf.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -69,7 +69,7 @@
 }
 
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KAboutData aboutData("kstartperf", I18N_NOOP("KStartPerf"),
 	    "1.0", I18N_NOOP("Measures start up time of a KDE application"),
diff -uNr kdesdk-3.4.0/kuiviewer/Makefile.am kdesdk-3.4.0-new/kuiviewer/Makefile.am
--- kdesdk-3.4.0/kuiviewer/Makefile.am	2004-10-30 03:05:55.000000000 -0400
+++ kdesdk-3.4.0-new/kuiviewer/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -21,12 +21,14 @@
 #########################################################################
 # this is the program that gets installed.  it's name is used for all
 # of the other Makefile.am variables
-bin_PROGRAMS = kuiviewer
+kdeinit_LTLIBRARIES = kuiviewer.la
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
 
 # the application source, library search path, and link libraries
-kuiviewer_SOURCES = main.cpp kuiviewer.cpp
-kuiviewer_LDFLAGS = $(KDE_RPATH) $(all_libraries)
-kuiviewer_LDADD   = $(LIB_KPARTS)
+kuiviewer_la_SOURCES = main.cpp kuiviewer.cpp
+kuiviewer_la_LDFLAGS = $(KDE_PLUGIN) $(all_libraries) -module
+kuiviewer_la_LIBADD  = $(LIB_KPARTS)
 
 xdg_apps_DATA =kuiviewer.desktop
 
diff -uNr kdesdk-3.4.0/kuiviewer/main.cpp kdesdk-3.4.0-new/kuiviewer/main.cpp
--- kdesdk-3.4.0/kuiviewer/main.cpp	2004-10-30 09:42:29.000000000 -0400
+++ kdesdk-3.4.0-new/kuiviewer/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -38,7 +38,7 @@
     KCmdLineLastOption
 };
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KAboutData about("kuiviewer", I18N_NOOP("KUIViewer"), "0.1",
 		     I18N_NOOP("Displays Designer's UI files"),
diff -uNr kdesdk-3.4.0/poxml/Makefile.am kdesdk-3.4.0-new/poxml/Makefile.am
--- kdesdk-3.4.0/poxml/Makefile.am	2003-10-13 09:01:39.000000000 -0400
+++ kdesdk-3.4.0-new/poxml/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -1,30 +1,31 @@
-
-bin_PROGRAMS = split2po xml2pot po2xml swappo transxx
+lib_LTLIBRARIES =
+bin_PROGRAMS =
+kdeinit_LTLIBRARIES = split2po.la xml2pot.la po2xml.la swappo.la transxx.la
 
 INCLUDES = -I$(srcdir)/antlr $(all_includes)
 KDE_CXXFLAGS = $(USE_EXCEPTIONS) 
 
 SUBDIRS = antlr
 
-split2po_SOURCES = split.cpp parser.cpp
-split2po_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-split2po_LDADD = $(LIB_QT)
-
-xml2pot_SOURCES = xml2pot.cpp parser.cpp
-xml2pot_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-xml2pot_LDADD = $(LIB_QT)
-
-po2xml_SOURCES = GettextLexer.cpp GettextParser.cpp po2xml.cpp parser.cpp
-po2xml_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-po2xml_LDADD = antlr/src/libantlr.la $(LIB_QT)
-
-swappo_SOURCES = GettextLexer.cpp GettextParser.cpp swappo.cpp parser.cpp
-swappo_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-swappo_LDADD = antlr/src/libantlr.la $(LIB_QT)
-
-transxx_SOURCES = GettextLexer.cpp GettextParser.cpp transxx.cpp parser.cpp
-transxx_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-transxx_LDADD = antlr/src/libantlr.la $(LIB_QT)
+split2po_la_SOURCES = split.cpp parser.cpp
+split2po_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+split2po_la_LIBADD = $(LIB_QT)
+
+xml2pot_la_SOURCES = xml2pot.cpp parser.cpp
+xml2pot_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+xml2pot_la_LIBADD = $(LIB_QT)
+
+po2xml_la_SOURCES = GettextLexer.cpp GettextParser.cpp po2xml.cpp parser.cpp
+po2xml_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+po2xml_la_LIBADD = antlr/src/libantlr.la $(LIB_QT)
+
+swappo_la_SOURCES = GettextLexer.cpp GettextParser.cpp swappo.cpp parser.cpp
+swappo_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+swappo_la_LIBADD = antlr/src/libantlr.la $(LIB_QT)
+
+transxx_la_SOURCES = GettextLexer.cpp GettextParser.cpp transxx.cpp parser.cpp
+transxx_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+transxx_la_LIBADD = antlr/src/libantlr.la $(LIB_QT)
 
 parser:
 	cd $(srcdir) &&	java antlr.Tool gettext.g
diff -uNr kdesdk-3.4.0/poxml/po2xml.cpp kdesdk-3.4.0-new/poxml/po2xml.cpp
--- kdesdk-3.4.0/poxml/po2xml.cpp	2003-10-16 04:25:56.000000000 -0400
+++ kdesdk-3.4.0-new/poxml/po2xml.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -38,7 +38,7 @@
     return prefix + xml;
 }
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
     if (argc != 3) {
         qWarning("usage: %s english-XML translated-PO", argv[0]);
diff -uNr kdesdk-3.4.0/poxml/split.cpp kdesdk-3.4.0-new/poxml/split.cpp
--- kdesdk-3.4.0/poxml/split.cpp	2004-10-18 16:19:21.000000000 -0400
+++ kdesdk-3.4.0-new/poxml/split.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -4,7 +4,7 @@
 
 using namespace std;
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
     bool report_mismatches = qstrcmp(getenv("REPORT_MISMATCHES"), "no");
 
diff -uNr kdesdk-3.4.0/poxml/swappo.cpp kdesdk-3.4.0-new/poxml/swappo.cpp
--- kdesdk-3.4.0/poxml/swappo.cpp	2002-02-07 17:42:56.000000000 -0500
+++ kdesdk-3.4.0-new/poxml/swappo.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -4,7 +4,7 @@
 #include <fstream>
 #include "GettextLexer.hpp"
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     if ( argc != 2 ) {
         qWarning( "usage: %s pofile", argv[0] );
diff -uNr kdesdk-3.4.0/poxml/transxx.cpp kdesdk-3.4.0-new/poxml/transxx.cpp
--- kdesdk-3.4.0/poxml/transxx.cpp	2003-10-15 11:23:18.000000000 -0400
+++ kdesdk-3.4.0-new/poxml/transxx.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -4,7 +4,7 @@
 #include <fstream>
 #include "GettextLexer.hpp"
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     if ( argc != 2 && argc != 4 ) {
         qWarning( "usage: %s [--text translation] potfile", argv[0] );
diff -uNr kdesdk-3.4.0/poxml/xml2pot.cpp kdesdk-3.4.0-new/poxml/xml2pot.cpp
--- kdesdk-3.4.0/poxml/xml2pot.cpp	2003-04-09 03:16:22.000000000 -0400
+++ kdesdk-3.4.0-new/poxml/xml2pot.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -5,7 +5,7 @@
 
 using namespace std;
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
     if (argc != 2) {
         qWarning("usage: %s english-XML", argv[0]);
diff -uNr kdesdk-3.4.0/umbrello/umbrello/Makefile.am kdesdk-3.4.0-new/umbrello/umbrello/Makefile.am
--- kdesdk-3.4.0/umbrello/umbrello/Makefile.am	2005-02-03 17:57:06.000000000 -0500
+++ kdesdk-3.4.0-new/umbrello/umbrello/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -1,7 +1,9 @@
-bin_PROGRAMS = umbrello
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = umbrello.la
 
-umbrello_COMPILE_FIRST = version.h
-umbrello_SOURCES = activitywidget.cpp \
+umbrello_la_COMPILE_FIRST = version.h
+umbrello_la_SOURCES = activitywidget.cpp \
 actor.cpp \
 actorwidget.cpp \
 aligntoolbar.cpp \
@@ -103,7 +105,7 @@
 widget_utils.cpp \
 worktoolbar.cpp
 
-umbrello_LDADD   = ./refactoring/librefactoring.la ./classparser/libclassparser.la ./clipboard/libclipboard.la ./dialogs/libdialogs.la ./codegenerators/libcodegenerator.la  $(LIB_KDEPRINT) $(LIB_KIO)
+umbrello_la_LIBADD   = ./refactoring/librefactoring.la ./classparser/libclassparser.la ./clipboard/libclipboard.la ./dialogs/libdialogs.la ./codegenerators/libcodegenerator.la  $(LIB_KDEPRINT) $(LIB_KIO)
 
 SUBDIRS = classparser dialogs clipboard pics codegenerators headings diagram refactoring plugins
 
@@ -121,7 +123,7 @@
 
 METASOURCES = AUTO
 
-umbrello_LDFLAGS = $(all_libraries) $(KDE_RPATH) -export-dynamic
+umbrello_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module -export-dynamic
 
 messages: rc.cpp
 	$(PREPARETIPS) > tips.cpp
diff -uNr kdesdk-3.4.0/umbrello/umbrello/classparser/Makefile.am kdesdk-3.4.0-new/umbrello/umbrello/classparser/Makefile.am
--- kdesdk-3.4.0/umbrello/umbrello/classparser/Makefile.am	2004-04-14 14:44:53.000000000 -0400
+++ kdesdk-3.4.0-new/umbrello/umbrello/classparser/Makefile.am	2005-05-11 12:28:28.000000000 -0400
@@ -1,4 +1,4 @@
-INCLUDES = -I../dialogs $(all_includes)
+INCLUDES = -I../dialogs -I@FINKPREFIX@/lib/flex/include $(all_includes)
 
 noinst_LTLIBRARIES = libclassparser.la
 libclassparser_la_SOURCES = ast.cpp driver.cpp errors.cpp lexer.cpp lookup.cpp parser.cpp tree_parser.cpp urlutil.cpp ast_utils.cpp cpptree2uml.cpp
diff -uNr kdesdk-3.4.0/umbrello/umbrello/main.cpp kdesdk-3.4.0-new/umbrello/umbrello/main.cpp
--- kdesdk-3.4.0/umbrello/umbrello/main.cpp	2005-01-05 07:25:24.000000000 -0500
+++ kdesdk-3.4.0-new/umbrello/umbrello/main.cpp	2005-05-11 12:28:28.000000000 -0400
@@ -37,7 +37,7 @@
         KCmdLineLastOption
     };
 
-int main(int argc, char *argv[]) {
+extern "C" int kdemain(int argc, char *argv[]) {
 	KAboutData aboutData( "umbrello", I18N_NOOP("Umbrello UML Modeller"),
 	                      UMBRELLO_VERSION, description, KAboutData::License_GPL,
 	                      I18N_NOOP("(c) 2001 Paul Hensgen, (c) 2002-2005 Umbrello UML Modeller Authors"), 0,
