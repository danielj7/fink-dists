http://www.openoffice.org/issues/show_bug.cgi?id=42778
gslpatches

Index: vcl/inc/svdata.hxx
===================================================================
RCS file: /cvs/gsl/vcl/inc/svdata.hxx,v
retrieving revision 1.51
retrieving revision 1.51.64.1
diff -u -r1.51 -r1.51.64.1
--- vcl/inc/svdata.hxx	3 Mar 2005 19:56:35 -0000	1.51
+++ vcl/inc/svdata.hxx	21 Apr 2005 17:07:28 -0000	1.51.64.1
@@ -394,7 +394,7 @@
 
 extern VCL_DLLPUBLIC ImplSVData* pImplSVData;
 inline VCL_DLLPUBLIC ImplSVData* ImplGetSVData() { return pImplSVData; }
-inline ImplSVData* ImplGetAppSVData() { return *((ImplSVData**)GetAppData( SHL_SV )); }
+inline ImplSVData* ImplGetAppSVData() { return ImplGetSVData(); }
 
 bool ImplInitAccessBridge( BOOL bAllowCancel, BOOL &rCancelled );
 
Index: vcl/source/app/svdata.cxx
===================================================================
RCS file: /cvs/gsl/vcl/source/app/svdata.cxx,v
retrieving revision 1.42
retrieving revision 1.42.30.1
diff -u -r1.42 -r1.42.30.1
--- vcl/source/app/svdata.cxx	29 Mar 2005 14:36:45 -0000	1.42
+++ vcl/source/app/svdata.cxx	21 Apr 2005 15:24:20 -0000	1.42.30.1
@@ -165,7 +165,7 @@
 }
 
 // static SV-Data
-ImplSVData* pImplSVData = &private_aImplSVData::get();
+ImplSVData* pImplSVData = NULL;
 
 SalSystem* ImplGetSalSystem()
 {
@@ -189,16 +189,11 @@
 
 void ImplInitSVData()
 {
-    ImplSVData* pSVData = pImplSVData;
-    ImplSVData** ppSVData = (ImplSVData**)GetAppData( SHL_SV );
-    *ppSVData = &private_aImplSVData::get();
-
-    // init global sharedlib data
-    // ...
+    pImplSVData = &private_aImplSVData::get();
 
     // init global instance data
-    memset( pSVData, 0, sizeof( ImplSVData ) );
-    pSVData->maHelpData.mbAutoHelpId = sal_True;
+    memset( pImplSVData, 0, sizeof( ImplSVData ) );
+    pImplSVData->maHelpData.mbAutoHelpId = sal_True;
 }
 
 // -----------------------------------------------------------------------
@@ -240,12 +235,6 @@
 
 void ImplDestroySVData()
 {
-    ImplSVData** ppSVData = (ImplSVData**)GetAppData( SHL_SV );
-
-    // delete global sharedlib data
-    // ...
-
-    *ppSVData = NULL;
     pImplSVData = NULL;
 }
 
Index: vcl/unx/source/app/i18n_cb.cxx
===================================================================
RCS file: /cvs/gsl/vcl/unx/source/app/i18n_cb.cxx,v
retrieving revision 1.22
retrieving revision 1.22.218.1
diff -u -r1.22 -r1.22.218.1
--- vcl/unx/source/app/i18n_cb.cxx	8 Sep 2004 15:37:43 -0000	1.22
+++ vcl/unx/source/app/i18n_cb.cxx	22 Apr 2005 15:09:16 -0000	1.22.218.1
@@ -528,7 +528,7 @@
   	point.y = mPosEvent.mnY + mPosEvent.mnHeight;
 
   	XVaNestedList preedit_attr;
-  	preedit_attr = XVaCreateNestedList(0, XNSpotLocation, &point, 0);
+  	preedit_attr = XVaCreateNestedList(0, XNSpotLocation, &point, NULL);
   	XSetICValues(ic, XNPreeditAttributes, preedit_attr, NULL);
   	XFree(preedit_attr);
 
Index: vcl/unx/source/app/i18n_ic.cxx
===================================================================
RCS file: /cvs/gsl/vcl/unx/source/app/i18n_ic.cxx,v
retrieving revision 1.31
retrieving revision 1.31.36.1
diff -u -r1.31 -r1.31.36.1
--- vcl/unx/source/app/i18n_ic.cxx	18 Mar 2005 17:54:40 -0000	1.31
+++ vcl/unx/source/app/i18n_ic.cxx	22 Apr 2005 15:09:18 -0000	1.31.36.1
@@ -150,7 +150,7 @@
         a_dstlist = XVaCreateNestedList(
                                         0,
                                         name,           value,
-                                        0 );
+                                        NULL );
     }
     else
     {
@@ -158,7 +158,7 @@
                                         0,
                                         XNVaNestedList, a_srclist,
                                         name,           value,
-                                        0 );
+                                        NULL );
     }
 
     return a_dstlist != NULL ? a_dstlist : a_srclist ;
@@ -271,7 +271,7 @@
                                                           XNStatusStartCallback, &aStatusStartCallback,
                                                           XNStatusDoneCallback,  &aStatusDoneCallback,
                                                           XNStatusDrawCallback,  &aStatusDrawCallback,
-                                                          0 );
+                                                          NULL );
 
                 break;
             }
@@ -310,7 +310,7 @@
                                                            XNPreeditDoneCallback,  &maPreeditDoneCallback,
                                                            XNPreeditDrawCallback,   &maPreeditDrawCallback,
                                                            XNPreeditCaretCallback, &maPreeditCaretCallback,
-                                                           0 );
+                                                           NULL );
 
                 break;
 
@@ -332,7 +332,7 @@
                 mpPreeditAttributes = XVaCreateNestedList (
                                                            0,
                                                            XNSpotLocation, &aSpot,
-                                                           0 );
+                                                           NULL );
 
                 // XCreateIC() fails on Redflag Linux 2.0 if there is no
                 // fontset though the data itself is not evaluated nor is
@@ -365,7 +365,7 @@
                                            XNFocusWindow,       aFocusWindow,
                                            XNClientWindow,      aClientWindow,
                                            XNInputStyle,        mnPreeditStyle | mnStatusStyle,
-                                           0 );
+                                           NULL );
 
         if ( mnPreeditStyle != XIMPreeditNone )
         {
@@ -697,7 +697,7 @@
     aSpot.x = aPosEvent.mnX + aPosEvent.mnWidth;
     aSpot.y = aPosEvent.mnY + aPosEvent.mnHeight;
 
-    XVaNestedList preedit_attr = XVaCreateNestedList(0, XNSpotLocation, &aSpot, 0);
+    XVaNestedList preedit_attr = XVaCreateNestedList(0, XNSpotLocation, &aSpot, NULL);
     XSetICValues(maContext, XNPreeditAttributes, preedit_attr, NULL);
     XFree(preedit_attr);
 
@@ -776,7 +776,7 @@
     preedit_attr = XVaCreateNestedList(
                                        0,
                                        XNPreeditState, &preedit_state,
-                                       0);
+                                       NULL);
     if (!XGetICValues(maContext, XNPreeditAttributes, preedit_attr, NULL))
     {
         XFree(preedit_attr);
@@ -785,7 +785,7 @@
         preedit_attr = XVaCreateNestedList(
                                            0,
                                            XNPreeditState, preedit_state,
-                                           0);
+                                           NULL);
         XSetICValues(maContext, XNPreeditAttributes, preedit_attr, NULL);
     }
 
@@ -815,7 +815,7 @@
         Bool is_preedit_state = False;
         preedit_attr = XVaCreateNestedList(0,
                                            XNPreeditState, &preedit_state,
-                                           0);
+                                           NULL);
         if (!XGetICValues(maContext,
                           XNPreeditAttributes, preedit_attr,
                           NULL)) {
@@ -830,7 +830,7 @@
 
         preedit_attr = XVaCreateNestedList(0,
                                            XNPreeditState, preedit_state,
-                                           0);
+                                           NULL);
         if (is_preedit_state) {
              XSetICValues(maContext,
                          XNPreeditAttributes, preedit_attr,
Index: vcl/unx/source/app/i18n_status.cxx
===================================================================
RCS file: /cvs/gsl/vcl/unx/source/app/i18n_status.cxx,v
retrieving revision 1.25
retrieving revision 1.25.306.1
diff -u -r1.25 -r1.25.306.1
--- vcl/unx/source/app/i18n_status.cxx	10 May 2004 15:55:48 -0000	1.25
+++ vcl/unx/source/app/i18n_status.cxx	22 Apr 2005 15:09:18 -0000	1.25.306.1
@@ -525,7 +525,7 @@
             XSetICValues( I18NStatus::get().getInputContext( bDummy )->GetContext(),
                           XNUnicodeCharacterSubset,
                           rChoices[nIndex].pData,
-                          0);
+                          NULL);
             // FIXME: get rid of X11SalFrame
             X11SalFrame* pParent = static_cast<X11SalFrame*>(I18NStatus::get().getParent());
             if( pParent && pParent->isMapped() )
Index: psprint/source/fontmanager/fontcache.cxx
===================================================================
RCS file: /cvs/gsl/psprint/source/fontmanager/fontcache.cxx,v
retrieving revision 1.12
retrieving revision 1.12.18.1
diff -u -r1.12 -r1.12.18.1
--- psprint/source/fontmanager/fontcache.cxx	31 Jan 2005 08:59:14 -0000	1.12
+++ psprint/source/fontmanager/fontcache.cxx	22 Apr 2005 08:13:34 -0000	1.12.18.1
@@ -348,7 +348,7 @@
             else
             {
                 nDir = rManager.getDirectoryAtom( aDir, true );
-                m_aCache[ nDir ].m_nTimestamp = nTimestamp;
+                m_aCache[ nDir ].m_nTimestamp = (sal_Int64)aStat.st_mtime;
                 m_aCache[ nDir ].m_bNoFiles = bEmpty;
                 pDir = bEmpty ? NULL : &m_aCache[ nDir ].m_aEntries;
                 bKeepOnlyUserOverridden = ((sal_Int64)aStat.st_mtime != nTimestamp);
Index: psprint/source/printer/cupsmgr.cxx
===================================================================
RCS file: /cvs/gsl/psprint/source/printer/cupsmgr.cxx,v
retrieving revision 1.11
retrieving revision 1.11.6.1
diff -u -r1.11 -r1.11.6.1
--- psprint/source/printer/cupsmgr.cxx	30 Mar 2005 08:53:00 -0000	1.11
+++ psprint/source/printer/cupsmgr.cxx	22 Apr 2005 08:19:23 -0000	1.11.6.1
@@ -84,6 +84,7 @@
 {
     oslModule		m_pLib;
     osl::Mutex		m_aGetPPDMutex;
+    bool            m_bPPDThreadRunning;
 
     int				(*m_pcupsPrintFile)(const char*, const char*, const char*, int, cups_option_t*);
     int				(*m_pcupsGetDests)(cups_dest_t**);
@@ -123,7 +124,7 @@
                    cups_option_t* pOptions )
     { return m_pcupsPrintFile( pPrinter, pFileName, pTitle, nOptions, pOptions ); }
 
-    const char* cupsGetPPD( const char* pPrinter );
+    rtl::OString cupsGetPPD( const char* pPrinter );
 
     int cupsMarkOptions(ppd_file_t* pPPD, int nOptions, cups_option_t* pOptions )
     { return m_pcupsMarkOptions(pPPD, nOptions, pOptions); }
@@ -174,7 +175,8 @@
 }
 
 CUPSWrapper::CUPSWrapper() 
-        : m_pLib( NULL )
+        : m_pLib( NULL ),
+          m_bPPDThreadRunning( false )
 {
 #ifdef ENABLE_CUPS
     OUString aLib( RTL_CONSTASCII_USTRINGPARAM( "libcups.so.2" ) );
@@ -256,68 +258,113 @@
     return m_pLib != NULL;
 }
 
-static struct GetPPDAttribs
+typedef const char*(*PPDFunction)(const char*);
+struct GetPPDAttribs
 {
-    const char* (*pFunction)(const char*);
+    PPDFunction         m_pFunction;
     osl::Condition		m_aCondition;
-    const char*			m_pParameter;
-    const char*			m_pResult;
+    OString			    m_aParameter;
+    OString			    m_aResult;
     oslThread			m_aThread;
-} *pAttribs = NULL;
-
-extern "C" {
-    static void getPPDWorker(void*)
+    int                 m_nRefs;
+    bool*               m_pResetRunning;
+    osl::Mutex*         m_pSyncMutex;
+    
+    GetPPDAttribs( PPDFunction pFn, const char * m_pParameter,
+                   bool* pResetRunning, osl::Mutex* pSyncMutex )
+            : m_pFunction( pFn ),
+              m_aParameter( m_pParameter ),
+              m_pResetRunning( pResetRunning ),
+              m_pSyncMutex( pSyncMutex )
+    {
+        m_nRefs = 2;
+        m_aCondition.reset();
+    }
+    
+    ~GetPPDAttribs()
+    {
+        if( m_aResult.getLength() )
+            unlink( m_aResult.getStr() );
+    }
+    
+    void unref()
     {
-        pAttribs->m_pResult = pAttribs->pFunction( pAttribs->m_pParameter );
-        if( pAttribs->m_aCondition.check() )
+        if( --m_nRefs == 0 )
         {
-            // timed out, unlink file
-            if( pAttribs->m_pResult )
-                unlink( pAttribs->m_pResult );
-            delete pAttribs;
-            pAttribs = NULL;
+            *m_pResetRunning = false;
+            delete this;
         }
-        else
-            pAttribs->m_aCondition.set();
+    }
+    
+    void executeCall()
+    {
+        // This CUPS method is not at all thread-safe we need
+        // to dup the pointer to a static buffer it returns ASAP
+        OString aResult = m_pFunction( m_aParameter );
+        MutexGuard aGuard( *m_pSyncMutex );
+        m_aResult = aResult;
+        m_aCondition.set();
+        unref();
+    }
+    
+    OString waitResult( TimeValue *pDelay )
+    {
+        m_pSyncMutex->release();
+        
+        if (m_aCondition.wait( pDelay ) != Condition::result_ok
+            )
+        {
+            #if OSL_DEBUG_LEVEL > 1
+            fprintf( stderr, "cupsGetPPD %s timed out\n",
+            (const sal_Char *) m_aParameter
+            );
+            #endif
+        }
+        m_pSyncMutex->acquire();
+        
+        OString aRetval = m_aResult;
+        m_aResult = OString();
+        unref();
+        
+        return aRetval;
+    }
+};
+
+extern "C" {
+    static void getPPDWorker(void* pData)
+    {
+        GetPPDAttribs* pAttribs = (GetPPDAttribs*)pData;
+        pAttribs->executeCall();
     }
 }
 
-const char* CUPSWrapper::cupsGetPPD( const char* pPrinter )
+OString CUPSWrapper::cupsGetPPD( const char* pPrinter )
 {
-    const char* pResult = NULL;
+    OString aResult;
 
+    m_aGetPPDMutex.acquire();
     // if one thread hangs in cupsGetPPD already, don't start another
-    if( ! pAttribs )
+    if( ! m_bPPDThreadRunning )
     {
-        pAttribs = new GetPPDAttribs();
-        pAttribs->pFunction			= m_pcupsGetPPD;
-        pAttribs->m_aCondition.reset();
-        pAttribs->m_pParameter		= pPrinter;
-        pAttribs->m_pResult			= NULL;
-        pAttribs->m_aThread			= osl_createThread( getPPDWorker, NULL );
+        m_bPPDThreadRunning = true;
+        GetPPDAttribs* pAttribs = new GetPPDAttribs( m_pcupsGetPPD,
+                                                     pPrinter,
+                                                     &m_bPPDThreadRunning,
+                                                     &m_aGetPPDMutex );
+        
+        oslThread aThread = osl_createThread( getPPDWorker, pAttribs );
 
         TimeValue aValue;
         aValue.Seconds = 5;
         aValue.Nanosec = 0;
-        if( pAttribs->m_aCondition.wait( &aValue ) == Condition::result_ok )
-        {
-            osl_destroyThread( pAttribs->m_aThread );
-            pResult = pAttribs->m_pResult;
-            delete pAttribs;
-            pAttribs = NULL;
-        }
-        else
-        {
-#if OSL_DEBUG_LEVEL > 1
-            fprintf( stderr, "cupsGetPPD %s timed out\n", pPrinter );
-#endif
-            // should the thread awake again notify it to clean up itself
-            pAttribs->m_aCondition.set();
-            osl_destroyThread( pAttribs->m_aThread );
-        }
+
+        // NOTE: waitResult release and acquires the GetPPD mutex
+        aResult = pAttribs->waitResult( &aValue );
+        osl_destroyThread( aThread );
     }
+    m_aGetPPDMutex.release();
 
-    return pResult;
+    return aResult;
 }
 
 static const char* setPasswordCallback( const char* pIn )
@@ -577,20 +624,20 @@
             if( dest_it != m_aCUPSDestMap.end() )
             {
                 cups_dest_t* pDest = ((cups_dest_t*)m_pDests) + dest_it->second;
-                const char* pPPDFile = m_pCUPSWrapper->cupsGetPPD( pDest->name );
+                OString aPPDFile = m_pCUPSWrapper->cupsGetPPD( pDest->name );
                 #if OSL_DEBUG_LEVEL > 1
-                fprintf( stderr, "PPD for %s is %s\n", OUStringToOString( aPrinter, osl_getThreadTextEncoding() ).getStr(), pPPDFile );
+                fprintf( stderr, "PPD for %s is %s\n", OUStringToOString( aPrinter, osl_getThreadTextEncoding() ).getStr(), aPPDFile.getStr() );
                 #endif
-                if( pPPDFile )
+                if( aPPDFile.getLength() )
                 {
                     rtl_TextEncoding aEncoding = osl_getThreadTextEncoding();
-                    OUString aFileName( OStringToOUString( pPPDFile, aEncoding ) );
+                    OUString aFileName( OStringToOUString( aPPDFile, aEncoding ) );
                     // update the printer info with context information
-                    ppd_file_t* pPPD = m_pCUPSWrapper->ppdOpenFile( pPPDFile );
+                    ppd_file_t* pPPD = m_pCUPSWrapper->ppdOpenFile( aPPDFile.getStr() );
                     if( pPPD )
                     {
                         // create the new parser
-                        PPDParser* pCUPSParser =  new PPDParser( aFileName );
+                        PPDParser* pCUPSParser = new PPDParser( aFileName );
                         pCUPSParser->m_aFile = rPrinter;
                         pNewParser = pCUPSParser;
                         
@@ -615,29 +662,33 @@
                         rInfo.m_aContext = rContext;
                         
                         // clean up the mess
-                        m_pCUPSWrapper->ppdClose( pPPD );
+                        m_pCUPSWrapper->ppdClose( pPPD );                        
                     }
                     #if OSL_DEBUG_LEVEL > 1
                     else
-                        fprintf( stderr, "ppdOpenFile failed, fallinmg back to generic driver\n" );
+                        fprintf( stderr, "ppdOpenFile failed, falling back to generic driver\n" );
                     #endif
                     
                     // remove temporary PPD file
-                    unlink( pPPDFile );
+                    unlink( aPPDFile.getStr() );
                 }
                 #if OSL_DEBUG_LEVEL > 1
                 else
-                    fprintf( stderr, "no dest found for printer %s\n", OUStringToOString( aPrinter, osl_getThreadTextEncoding() ).getStr() );
+                    fprintf( stderr, "cupsGetPPD failed, falling back to generic driver\n" );
                 #endif
             }
+            #if OSL_DEBUG_LEVEL > 1
+            else
+                fprintf( stderr, "no dest found for printer %s\n", OUStringToOString( aPrinter, osl_getThreadTextEncoding() ).getStr() );
+            #endif
         }
         m_aCUPSMutex.release();
     }
-#if OSL_DEBUG_LEVEL >1
+    #if OSL_DEBUG_LEVEL >1
     else
         fprintf( stderr, "could not acquire CUPS mutex !!!\n" );
-#endif
-#endif // ENABLE_CUPS
+    #endif
+    #endif // ENABLE_CUPS
 
     if( ! pNewParser )
     {
cws macosx06

Index: distributions/OpenOfficeorg/javavendors_macosx.xml
===================================================================
RCS file: /cvs/udk/jvmfwk/distributions/OpenOfficeorg/javavendors_macosx.xml,v
retrieving revision 1.4
retrieving revision 1.4.26.1
diff -u -r1.4 -r1.4.26.1
--- jvmfwk/distributions/OpenOfficeorg/javavendors_macosx.xml	9 Nov 2004 13:56:37 -0000	1.4
+++ jvmfwk/distributions/OpenOfficeorg/javavendors_macosx.xml	16 Apr 2005 16:19:29 -0000	1.4.26.1
@@ -8,7 +8,7 @@
  <vendorInfos> 
   <vendor name="Apple Computer, Inc.">
     <minVersion>1.3.1</minVersion>
-    <maxVersion>1.3.1</maxVersion>
+    <maxVersion>1.4.2</maxVersion>
   </vendor>
  </vendorInfos>
 
Index: plugins/sunmajor/pluginlib/otherjre.cxx
===================================================================
RCS file: /cvs/udk/jvmfwk/plugins/sunmajor/pluginlib/otherjre.cxx,v
retrieving revision 1.3
retrieving revision 1.3.16.1
diff -u -r1.3 -r1.3.16.1
--- jvmfwk/plugins/sunmajor/pluginlib/otherjre.cxx	31 Jan 2005 09:49:56 -0000	1.3
+++ jvmfwk/plugins/sunmajor/pluginlib/otherjre.cxx	16 Apr 2005 16:18:32 -0000	1.3.16.1
@@ -116,7 +116,7 @@
 
 #ifdef UNX        
     static char const * ar[] = {
-#ifdef MACOX
+#ifdef MACOSX
         "/../Libraries",
         "/lib"
 #else
Index: plugins/sunmajor/pluginlib/util.cxx
===================================================================
RCS file: /cvs/udk/jvmfwk/plugins/sunmajor/pluginlib/util.cxx,v
retrieving revision 1.7
retrieving revision 1.7.10.1
diff -u -r1.7 -r1.7.10.1
--- jvmfwk/plugins/sunmajor/pluginlib/util.cxx	4 Mar 2005 00:20:51 -0000	1.7
+++ jvmfwk/plugins/sunmajor/pluginlib/util.cxx	16 Apr 2005 16:19:04 -0000	1.7.10.1
@@ -122,7 +122,7 @@
 char const *g_arSearchPaths[] = {
 #ifdef MACOSX
     "",
-    "System/Library/Frameworks/JavaVM.framework/Versions/1.3.1/"
+    "System/Library/Frameworks/JavaVM.framework/Versions/1.4.2/"
 #else
     "",
     "usr/",
#i46963#

Index: sal/systools/macxp_extras/x11osx/osxlocale.c
===================================================================
RCS file: /cvs/porting/sal/systools/macxp_extras/x11osx/osxlocale.c,v
retrieving revision 1.3
diff -u -r1.3 osxlocale.c
--- sal/systools/macxp_extras/x11osx/osxlocale.c	2 Feb 2004 19:02:19 -0000	1.3
+++ sal/systools/macxp_extras/x11osx/osxlocale.c	10 Apr 2005 10:16:12 -0000
@@ -73,11 +73,14 @@
  */
 int macxp_getOSXLocale( char *locale, sal_uInt32 bufferLen )
 {
-	LocaleRef		lref;
+
+#if (BUILD_OS_MAJOR == 10) && (BUILD_OS_MINOR == 2)
+// Jaguar code
+	LocaleRef	lref;
 	CFArrayRef	aref;
 	CFStringRef	sref;
 	CFStringRef    locNameRef;
-     
+
 	aref = (CFArrayRef)CFPreferencesCopyAppValue( CFSTR( "AppleLanguages" ), kCFPreferencesCurrentApplication );
 	if ( aref != NULL )
 	{
@@ -86,29 +89,6 @@
 			sref = (CFStringRef)CFArrayGetValueAtIndex( aref, 0 );
 			if ( (sref != NULL) && (CFGetTypeID(sref) == CFStringGetTypeID()) )
 			{
-#if (BUILD_OS_MAJOR==10) && (BUILD_OS_MINOR==3)
-// Panther code
-				// This function only exists in Panther and above
-				locNameRef = CFLocaleCreateCanonicalLocaleIdentifierFromString( kCFAllocatorDefault,  sref );
-
-				if ( locNameRef != NULL )
-				{
-					CFStringGetCString( locNameRef, locale, bufferLen, kCFStringEncodingASCII );
-					CFRelease( locNameRef );
-
-					// If its just en, we want en_US.  Since all the locales are also
-					// UTF-8, we'll append UTF-8 to the end of all returned locales
-					if ( strcmp(locale, "en") == 0 )
-						strlcpy( locale, "en_US", bufferLen );
-//					else if ( strchr(locale, '.') == NULL )
-//						strlcat( locale, ".UTF-8", bufferLen );
-				}
-				else
-					fprintf( stderr, "Could not get Canonical Locale Identifier from AppleLanguages value!\n" );
-#endif
-
-#if (BUILD_OS_MAJOR == 10) && (BUILD_OS_MINOR == 2)
-// Jaguar code
 				if ( CFStringGetCString( sref, locale, bufferLen, CFStringGetSystemEncoding() ) )
 				{
 					LocaleRefFromLocaleString( locale, &lref );
@@ -119,8 +99,11 @@
 					*/
 					if ( (strlen(locale) == 2) && (strncmp(locale, "en", 2) == 0) )
 						strncat( locale, "_US", bufferLen - strlen(locale) - 1 );
+        				// For Japanese locale, just "ja" is not sufficient.
+					// Use "ja_JP.UTF-8" instead.
+					if ( (strlen(locale) == 2) && (strncmp(locale, "ja", 2) == 0) )
+						strlcpy( locale, "ja_JP.UTF-8", bufferLen );
 				}
-#endif
 			}
 			else
 				fprintf( stderr, "Could not get array index 0 value of CFPref AppleLanguages!\n" );
@@ -132,6 +115,28 @@
           fprintf( stderr, "Could not get value of CFPref AppleLanguages!  Please reset your locale in the International control panel.\n" );
 
 	return( noErr );
+
+#else 
+// Panther and later code
+
+        CFStringRef lstr;
+        CFLocaleRef lref;
+
+        lref = CFLocaleCopyCurrent();
+        lstr = CFLocaleGetIdentifier(lref);
+        CFStringGetCString(lstr, locale, bufferLen, kCFStringEncodingASCII);
+        CFRelease(lref);
+        CFRelease(lstr);
+
+        if ( strchr(locale, '.') == NULL )
+	  strlcat( locale, ".UTF-8", bufferLen );
+
+        // fprintf(stderr,"returned locale string is %s\n",locale);
+
+        return ( noErr );
+
+#endif
+
 }
 
 
cws macosx06

Index: source/ooo/shortcut_ooo.scp
===================================================================
RCS file: /cvs/installation/scp2/source/ooo/shortcut_ooo.scp,v
retrieving revision 1.16
retrieving revision 1.16.44.2
diff -u -r1.16 -r1.16.44.2
--- scp2/source/ooo/shortcut_ooo.scp	10 Mar 2005 18:23:43 -0000	1.16
+++ scp2/source/ooo/shortcut_ooo.scp	20 Apr 2005 12:37:03 -0000	1.16.44.2
@@ -482,3 +482,30 @@
 End
 #endif
 //i38417 -end-
+
+
+//i44154
+
+#ifdef MACOSX
+
+Shortcut gid_Shortcut_Lib_Java_Uno
+    FileID = gid_File_Lib_Java_Uno;
+    Dir = gid_Dir_Program;
+    Name = "libjava_uno.jnilib";
+    Styles = (NETWORK, RELATIVE);
+End
+
+#endif
+
+#ifdef MACOSX
+
+Shortcut gid_Shortcut_Lib_Hsqldb_2
+    FileID = gid_File_Lib_Hsqldb_2;
+    Dir = gid_Dir_Program;
+    Name = "libhsqldb2.jnilib";
+    Styles = (NETWORK, RELATIVE);
+End
+
+#endif
+
+//i44154 -end-
http://www.openoffice.org/issues/show_bug.cgi?id=47771
pj26

gcc33 parser bug issue

Index: work/sd/source/ui/animations/CustomAnimationList.cxx
===================================================================
RCS file: /cvs/graphics/sd/source/ui/animations/CustomAnimationList.cxx,v
retrieving revision 1.7
diff -u -r1.7 CustomAnimationList.cxx
--- sd/source/ui/animations/CustomAnimationList.cxx	13 Apr 2005 09:35:53 -0000	1.7
+++ sd/source/ui/animations/CustomAnimationList.cxx	23 Apr 2005 22:40:16 -0000
@@ -724,7 +724,7 @@
 			{
 				SvLBoxEntry* pLBoxEntry = new CustomAnimationListEntry;
 				pLBoxEntry->AddItem( new SvLBoxContextBmp( pLBoxEntry, 0, Image(), Image(), 0));
-				OUString aDescription( String( SdResId( STR_CUSTOMANIMATION_TRIGGER ) ) );
+				OUString aDescription = OUString ( String( SdResId( STR_CUSTOMANIMATION_TRIGGER ) ) );
 				aDescription += OUString( RTL_CONSTASCII_USTRINGPARAM(": ") );
 				aDescription += getShapeDescription( xShape, false );
 				pLBoxEntry->AddItem( new CustomAnimationTriggerEntryItem( pLBoxEntry, 0, aDescription, this ) );
http://www.openoffice.org/issues/show_bug.cgi?id=47620
pj26

Index: sfx2/source/doc/guisaveas.cxx
===================================================================
RCS file: /cvs/framework/sfx2/source/doc/guisaveas.cxx,v
retrieving revision 1.15
diff -u -r1.15 guisaveas.cxx
--- sfx2/source/doc/guisaveas.cxx	13 Apr 2005 12:40:30 -0000	1.15
+++ sfx2/source/doc/guisaveas.cxx	23 Apr 2005 01:36:29 -0000
@@ -793,7 +793,7 @@
 
 		if ( xControlAccess.is() )
 		{
-			::rtl::OUString aCtrlText( String( SfxResId( STR_EXPORTBUTTON ) ) );
+			::rtl::OUString aCtrlText = ::rtl::OUString ( String( SfxResId( STR_EXPORTBUTTON ) ) );
 			xControlAccess->setLabel( ui::dialogs::CommonFilePickerElementIds::PUSHBUTTON_OK, aCtrlText );
 
 			aCtrlText = ::rtl::OUString( String( SfxResId( STR_LABEL_FILEFORMAT ) ) );
http://www.openoffice.org/issues/show_bug.cgi?id=47698
pj26

Index: svx/source/dialog/cfg.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/dialog/cfg.cxx,v
retrieving revision 1.20
diff -u -r1.20 cfg.cxx
--- svx/source/dialog/cfg.cxx	18 Apr 2005 11:52:21 -0000	1.20
+++ svx/source/dialog/cfg.cxx	23 Apr 2005 01:33:31 -0000
@@ -5362,7 +5362,7 @@
 
 	if ( rejectedCount != 0 )
 	{
-		OUString message( String( ResId( RID_SVXSTR_IMPORT_ICON_ERROR, DIALOG_MGR() ) ) );
+		OUString message = OUString ( String( ResId( RID_SVXSTR_IMPORT_ICON_ERROR, DIALOG_MGR() ) ) );
 		if ( m_nExpectedSize != 16 )
 		{
 			message = replaceSixteen( message, m_nExpectedSize );
http://www.openoffice.org/issues/show_bug.cgi?id=47704
pj26

Index: svx/source/fmcomp/fmgridcl.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/fmcomp/fmgridcl.cxx,v
retrieving revision 1.48
diff -u -r1.48 fmgridcl.cxx
--- svx/source/fmcomp/fmgridcl.cxx	13 Apr 2005 08:27:50 -0000	1.48
+++ svx/source/fmcomp/fmgridcl.cxx	23 Apr 2005 08:12:45 -0000
@@ -1135,7 +1135,7 @@
 			else
 			{
 				// Standardlabel setzen
-				::rtl::OUString sLabelBase(String(SVX_RES(RID_STR_COLUMN)));
+				::rtl::OUString sLabelBase = ::rtl::OUString(String(SVX_RES(RID_STR_COLUMN)));
 				// disambiguate the name
 				Reference< XNameAccess > xColNames(xCols, UNO_QUERY);
 				::rtl::OUString sLabel;
http://www.openoffice.org/issues/show_bug.cgi?id=47705
pj26

Index: svx/source/form/fmpgeimp.cxx
===================================================================
RCS file: /cvs/graphics/svx/source/form/fmpgeimp.cxx,v
retrieving revision 1.27
diff -u -r1.27 fmpgeimp.cxx
--- svx/source/form/fmpgeimp.cxx	13 Apr 2005 08:29:22 -0000	1.27
+++ svx/source/form/fmpgeimp.cxx	23 Apr 2005 08:14:22 -0000
@@ -364,7 +364,7 @@
 			{
 			}
 
-			::rtl::OUString aName (String(SVX_RES(RID_STR_STDFORMNAME)));
+			::rtl::OUString aName = ::rtl::OUString(String(SVX_RES(RID_STR_STDFORMNAME)));
 			xSet->setPropertyValue(FM_PROP_NAME, makeAny(aName));
 
 
http://www.openoffice.org/issues/show_bug.cgi?id=47612
pj26

Index: xmloff/source/draw/xexptran.cxx
===================================================================
RCS file: /cvs/xml/xmloff/source/draw/xexptran.cxx,v
retrieving revision 1.17
diff -u -r1.17 xexptran.cxx
--- xmloff/source/draw/xexptran.cxx	13 Apr 2005 09:29:54 -0000	1.17
+++ xmloff/source/draw/xexptran.cxx	22 Apr 2005 23:44:57 -0000
@@ -448,8 +448,8 @@
 const OUString& SdXMLImExTransform2D::GetExportString(const SvXMLUnitConverter& rConv)
 {
 	OUString aNewString;
-	OUString aClosingBrace(String(sal_Unicode(')')));
-	OUString aEmptySpace(String(sal_Unicode(' ')));
+	OUString aClosingBrace=OUString(String(sal_Unicode(')')));
+	OUString aEmptySpace=OUString(String(sal_Unicode(' ')));
 	
 	for(sal_uInt32 a(0L); a < maList.Count(); a++)
 	{
@@ -861,8 +861,8 @@
 const OUString& SdXMLImExTransform3D::GetExportString(const SvXMLUnitConverter& rConv)
 {
 	OUString aNewString;
-	OUString aClosingBrace(String(sal_Unicode(')')));
-	OUString aEmptySpace(String(sal_Unicode(' ')));
+	OUString aClosingBrace=OUString(String(sal_Unicode(')')));
+	OUString aEmptySpace=OUString(String(sal_Unicode(' ')));
 	
 	for(sal_uInt32 a(0L); a < maList.Count(); a++)
 	{
@@ -1267,7 +1267,7 @@
 const OUString& SdXMLImExViewBox::GetExportString(const SvXMLUnitConverter& rConv)
 {
 	OUString aNewString;
-	OUString aEmptySpace(String(sal_Unicode(' ')));
+	OUString aEmptySpace=OUString(String(sal_Unicode(' ')));
 
 	Imp_PutNumberChar(aNewString, rConv, mnX);
 	aNewString += aEmptySpace;
