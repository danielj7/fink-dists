diff -Naur Gauche-0.8.9.orig/doc/gauche-ref.texi Gauche-0.8.9/doc/gauche-ref.texi
--- Gauche-0.8.9.orig/doc/gauche-ref.texi	2006-04-07 11:29:48.000000000 +0000
+++ Gauche-0.8.9/doc/gauche-ref.texi	2007-04-14 02:02:09.000000000 +0000
@@ -5,14 +5,14 @@
 @settitle Gauche Users' Reference
 @dircategory The Algorithmic Language Scheme
 @direntry
-* Gauche: (gauche-refe.info).	        An R5RS Scheme implementation.
+* Gauche: (gauche-refe).	        An R5RS Scheme implementation.
 @end direntry
 @c JP
 @setfilename gauche-refj.info
 @settitle Gauche ユーザリファレンス
 @dircategory The Algorithmic Language Scheme
 @direntry
-* Gauche (ja): (gauche-refj.info).	An R5RS Scheme implementation.
+* Gauche (ja): (gauche-refj).	An R5RS Scheme implementation.
 @end direntry
 @documentencoding euc-jp
 @c COMMON
diff -Naur Gauche-0.8.9.orig/doc/gauche-ref.texi.orig Gauche-0.8.9/doc/gauche-ref.texi.orig
--- Gauche-0.8.9.orig/doc/gauche-ref.texi.orig	1970-01-01 00:00:00.000000000 +0000
+++ Gauche-0.8.9/doc/gauche-ref.texi.orig	2006-04-07 11:29:48.000000000 +0000
@@ -0,0 +1,101 @@
+\input texinfo  @c -*-texinfo-*-
+@comment %**start of header
+@c EN
+@setfilename gauche-refe.info
+@settitle Gauche Users' Reference
+@dircategory The Algorithmic Language Scheme
+@direntry
+* Gauche: (gauche-refe.info).	        An R5RS Scheme implementation.
+@end direntry
+@c JP
+@setfilename gauche-refj.info
+@settitle Gauche ユーザリファレンス
+@dircategory The Algorithmic Language Scheme
+@direntry
+* Gauche (ja): (gauche-refj.info).	An R5RS Scheme implementation.
+@end direntry
+@documentencoding euc-jp
+@c COMMON
+@comment %**end of header
+
+@c $Id: gauche-ref.texi,v 1.432 2006/04/07 11:29:48 shirok Exp $
+
+@c module and class index
+@defcodeindex md
+@defcodeindex cl
+
+@iftex
+@finalout
+@parskip 4pt plus 1pt
+@end iftex
+
+@titlepage
+@c EN
+@title Gauche Users' Reference
+@subtitle version @VERSION@
+@author Shiro Kawai (shiro@@acm.org)
+@c JP
+@title Gauche ユーザリファレンス
+@subtitle version @VERSION@
+@author Shiro Kawai (shiro@@acm.org)
+@c COMMON
+
+@page
+@vskip 0pt plus 1filll
+Copyright @copyright{} 2001-2005 Shiro Kawai (shiro@@acm.org)
+
+@end titlepage
+
+@node Top, Introduction, (dir), (dir)
+
+@ifnottex
+@c EN
+This is a reference manual of Gauche, an R5RS Scheme implementation.
+This manual is for version @VERSION@.
+@c JP
+本書は、R5RS準拠のScheme処理系、Gaucheのリファレンスマニュアルです。
+Gaucheのバージョン@VERSION@に対応します。
+@c COMMON
+@end ifnottex
+
+@menu
+* Introduction::                
+* Concepts::                    
+* Programming in Gauche::       
+* Core syntax::                 
+* Macros::                      
+* Core library::                
+* Object system::               
+* Library modules - Overview::  
+* Library modules - Gauche extensions::  
+* Library modules - SRFIs::     
+* Library modules - Utilities::  
+* References::                  
+* C to Scheme mapping::         
+* Function and Syntax Index::   
+* Module Index::                
+* Class Index::                 
+* Variable Index::              
+@end menu
+
+@include intro.texi
+@include concepts.texi
+@include program.texi
+@include coresyn.texi
+@include macro.texi
+@include corelib.texi
+@include object.texi
+@include modintro.texi
+@include modgauche.texi
+@include modsrfi.texi
+@include modutil.texi
+@include references.texi
+@include mapping.texi
+@include indexfn.texi
+@include indexmd.texi
+@include indexcl.texi
+@include indexvr.texi
+
+@contents
+@bye
+
diff -Naur Gauche-0.8.9.orig/ext/Makefile.ext.in Gauche-0.8.9/ext/Makefile.ext.in
--- Gauche-0.8.9.orig/ext/Makefile.ext.in	2007-01-08 10:19:33.000000000 +0000
+++ Gauche-0.8.9/ext/Makefile.ext.in	2007-04-14 02:02:09.000000000 +0000
@@ -20,7 +20,7 @@
 LIBS     = $(XLIBS) @LIBS@ 
 CFLAGS   = @CFLAGS@ @SHLIB_SO_CFLAGS@ $(XCFLAGS)
 CPPFLAGS = @CPPFLAGS@ $(XCPPFLAGS)
-LDFLAGS  = @LOCAL_LIB@ $(XLDFLAGS) @SHLIB_SO_LDFLAGS@
+LDFLAGS  = @LDFLAGS@ @LOCAL_LIB@ $(XLDFLAGS) @SHLIB_SO_LDFLAGS@
 
 # These are set by configure
 DEFS     = @DEFS@
diff -Naur Gauche-0.8.9.orig/ext/Makefile.ext.in.orig Gauche-0.8.9/ext/Makefile.ext.in.orig
--- Gauche-0.8.9.orig/ext/Makefile.ext.in.orig	1970-01-01 00:00:00.000000000 +0000
+++ Gauche-0.8.9/ext/Makefile.ext.in.orig	2007-01-08 10:19:33.000000000 +0000
@@ -0,0 +1,108 @@
+## Common stuff used in Makefiles of extensions  -*-mode: Makefile-*-
+## $Id: Makefile.ext.in,v 1.26 2007/01/08 10:19:33 shirok Exp $
+## 
+
+SHELL       = @SHELL@
+prefix      = @prefix@
+exec_prefix = @exec_prefix@
+bindir      = @bindir@
+libdir      = @libdir@
+datadir     = @datadir@
+datarootdir = @datarootdir@
+VPATH       = $(srcdir)
+GAUCHE_VERSION = @GAUCHE_VERSION@
+HOST        = @host@
+
+# These may be overridden by make invocators
+DESTDIR  =
+CC       = @CC@
+AR       = @AR@
+LIBS     = $(XLIBS) @LIBS@ 
+CFLAGS   = @CFLAGS@ @SHLIB_SO_CFLAGS@ $(XCFLAGS)
+CPPFLAGS = @CPPFLAGS@ $(XCPPFLAGS)
+LDFLAGS  = @LOCAL_LIB@ $(XLDFLAGS) @SHLIB_SO_LDFLAGS@
+
+# These are set by configure
+DEFS     = @DEFS@
+OPTFLAGS = @OPTFLAGS@
+INCLUDES = -I$(srcdir) -I$(top_srcdir)/src -I$(top_srcdir)/gc/include @LOCAL_INC@ $(EXTRA_INCLUDES)
+OBJEXT   = @OBJEXT@
+EXEEXT   = @EXEEXT@
+SOEXT    = @SHLIB_SO_SUFFIX@
+
+# Main definition of compilation commands
+COMPILE   = $(CC) $(DEFS) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) $(OPTFLAGS)
+CCLD      = $(CC)
+LINK      = $(CCLD) $(CFLAGS) $(LDFLAGS)
+MODLINK   = $(CCLD) $(CFLAGS) $(LDFLAGS)
+
+GOSH           = $(top_builddir)/src/gosh -ftest
+GAUCHE_CONFIG  = $(top_builddir)/src/gauche-config
+GAUCHE_INSTALL = $(GOSH) $(top_srcdir)/src/gauche-install.in
+INSTALL_TYPE   = sys
+
+EXT_LIBGAUCHE  = -L$(top_builddir)/src @EXT_LIBGAUCHE@
+
+GAUCHE_INCDIR  = $(DESTDIR)$(libdir)/gauche/$(GAUCHE_VERSION)/include
+GAUCHE_LIBDIR  = $(DESTDIR)$(datadir)/gauche/$(GAUCHE_VERSION)/lib
+GAUCHE_ARCHDIR = $(DESTDIR)$(libdir)/gauche/$(GAUCHE_VERSION)/$(HOST)
+
+LIB_INSTALL_DIR  = @libdir@
+BIN_INSTALL_DIR  = @bindir@
+DATA_INSTALL_DIR = @datadir@
+
+CLEANFILES = core *~ test.log test.out $(XCLEANFILES)
+
+.SUFFIXES:
+.SUFFIXES: .S .c .o .obj .s .stub
+
+.PHONY: default all check install install-check clean distclean \
+        maintainer-clean install-std uninstall link unlink
+
+.c.obj:
+	$(COMPILE) -c `cygpath -w $<`
+
+.c.o:
+	$(COMPILE) -c $<
+
+.s.o:
+	$(COMPILE) -c $<
+
+.S.o:
+	$(COMPILE) -c $<
+
+.stub.c :
+	$(GOSH) genstub $<
+
+default : all link
+
+check : all
+	@rm -f test.log
+	$(GOSH) -I. test.scm > test.log
+
+install-check :
+	${bindir}/gosh ./test.scm
+
+clean : unlink
+	rm -rf $(CLEANFILES) *.$(OBJEXT) *.$(SOEXT)
+
+distclean : clean
+	rm -rf $(GENERATED)
+
+maintainer-clean : clean
+	rm -rf $(GENERATED)
+
+install-std : all
+	$(GAUCHE_INSTALL) -m 444 -T $(GAUCHE_INCDIR) $(HDRFILES)
+	$(GAUCHE_INSTALL) -m 444 -T $(GAUCHE_LIBDIR)/$(SCM_CATEGORY) $(SCMFILES)
+	$(GAUCHE_INSTALL) -m 555 -T $(GAUCHE_ARCHDIR) $(LIBFILES) 
+
+uninstall :
+
+link :
+	-@$(GOSH) ../xlink -l -g "$(SCM_CATEGORY)" \
+	  -b $(top_builddir) -s $(top_srcdir) $(LIBFILES) $(SCMFILES)
+
+unlink :
+	-@$(GOSH) ../xlink -u -g "$(SCM_CATEGORY)" \
+	  -b $(top_builddir) -s $(top_srcdir) $(LIBFILES) $(SCMFILES)
diff -Naur Gauche-0.8.9.orig/src/Makefile.in Gauche-0.8.9/src/Makefile.in
--- Gauche-0.8.9.orig/src/Makefile.in	2007-01-08 10:19:34.000000000 +0000
+++ Gauche-0.8.9/src/Makefile.in	2007-04-14 02:02:09.000000000 +0000
@@ -80,7 +80,7 @@
 #  doesn't need to call it).
 HOSTGOSH  = gosh -l./preload -I$(top_srcdir)/src -I$(top_srcdir)/lib
 
-LIB_INSTALL_DIR  = @libdir@
+LIB_INSTALL_DIR  = $(ARCH_INSTALL_DIR)
 BIN_INSTALL_DIR  = @bindir@
 DATA_INSTALL_DIR = $(datadir)
 
@@ -309,7 +309,6 @@
 	$(INSTALL) -m 444 $(INSTALL_HEADERS) $(DESTDIR)$(HEADER_INSTALL_DIR)
 	$(INSTALL) -m 444 $(INSTALL_SUBHEADERS) $(DESTDIR)$(HEADER_INSTALL_DIR)/gauche
 	$(INSTALL)        $(INSTALL_LIBS) $(DESTDIR)$(LIB_INSTALL_DIR)
-	$(INSTALL)        $(INSTALL_LIBS) $(DESTDIR)$(ARCH_INSTALL_DIR)
 	$(INSTALL) -m 555 $(INSTALL_BINS) $(DESTDIR)$(BIN_INSTALL_DIR)
 	$(INSTALL) -m 555 $(INSTALL_BINS) $(DESTDIR)$(ARCH_INSTALL_DIR)
 	$(INSTALL) -m 444 $(INSTALL_SCMS) $(DESTDIR)$(SCM_INSTALL_DIR)
diff -Naur Gauche-0.8.9.orig/src/Makefile.in.orig Gauche-0.8.9/src/Makefile.in.orig
--- Gauche-0.8.9.orig/src/Makefile.in.orig	1970-01-01 00:00:00.000000000 +0000
+++ Gauche-0.8.9/src/Makefile.in.orig	2007-01-08 10:19:34.000000000 +0000
@@ -0,0 +1,339 @@
+#
+# Makefile.in for Gauche/src
+#  $Id: Makefile.in,v 1.160 2007/01/08 10:19:34 shirok Exp $
+#
+
+# prelude ---------------------------------------------
+
+.PHONY: all test check pre-package install uninstall \
+	clean distclean maintainer-clean install-check
+
+.SUFFIXES:
+.SUFFIXES: .S .c .o .obj .s .stub .in .exe
+
+.c.obj:
+	$(COMPILE) -c `cygpath -w $<`
+
+.c.o:
+	$(COMPILE) -c $<
+
+.s.o:
+	$(COMPILE) -c $<
+
+.S.o:
+	$(COMPILE) -c $<
+
+.stub.c:
+	$(HOSTGOSH) ./genstub -D LIBGAUCHE_BODY $<
+
+SHELL       = @SHELL@
+prefix      = @prefix@
+exec_prefix = @exec_prefix@
+bindir      = @bindir@
+libdir      = @libdir@
+srcdir      = @srcdir@
+datadir     = @datadir@
+datarootdir = @datarootdir@
+VPATH       = $(srcdir)
+top_builddir = @top_builddir@
+top_srcdir   = @top_srcdir@
+
+# These may be overridden by make invocators
+DESTDIR  =
+CC       = @CC@
+AR       = @AR@
+LIBS     = @LIBS@
+CFLAGS   = @CFLAGS@ @SHLIB_SO_CFLAGS@
+CPPFLAGS = @CPPFLAGS@
+LDFLAGS  = @LDFLAGS@
+
+
+# These are set by configure
+DEFS     = @DEFS@
+OPTFLAGS = @OPTFLAGS@
+INCLUDES = -I$(srcdir) -I$(srcdir)/../gc/include @LOCAL_INC@
+RANLIB   = @RANLIB@
+OBJEXT   = @OBJEXT@
+EXEEXT   = @EXEEXT@
+SOEXT    = @SHLIB_DYLIB_SUFFIX@
+LINK_HELPER = @LINK_HELPER@
+RPATH_TMP  = @RPATH_TMP@
+RPATH_REAL = @RPATH_REAL@
+SONAME_FLAG = @SONAME_FLAG@
+MAKEVERSLINK = @MAKEVERSLINK@
+
+# Main definition of compilation commands
+COMPILE   = $(CC) $(DEFS) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) $(OPTFLAGS)
+MKINSTDIR = $(top_srcdir)/mkinstalldirs
+CCLD      = $(LINK_HELPER) $(CC)
+LINK      = TARGETLIB=`pwd` $(CCLD) $(CFLAGS) $(RPATH_TMP) -L. $(LDFLAGS)
+RELINK    = TARGETLIB=$(TARGETLIB) $(CCLD) $(CFLAGS) $(RPATH_REAL) -L. $(LDFLAGS)
+INSTALL   = @INSTALL@
+POSTBUILD = TARGETLIB=`pwd` $(MAKEVERSLINK) libgauche.$(SOEXT)
+POSTINSTALL = TARGETLIB="$(TARGETLIB)" DESTDIR="$(DESTDIR)" $(MAKEVERSLINK) libgauche.$(SOEXT)
+
+# HOSTGOSH is the gosh command used to generate some of the source files.
+# We need to 'preload' some libraries from the host's environment, for
+# they are compiled DSO as of 0.8.6 and the ones in the build tree can
+# be incompatible with the host gosh.
+# (NB: HOSTGOSH is used at creating tarball, so the builder from tarball
+#  doesn't need to call it).
+HOSTGOSH  = gosh -l./preload -I$(top_srcdir)/src -I$(top_srcdir)/lib
+
+LIB_INSTALL_DIR  = @libdir@
+BIN_INSTALL_DIR  = @bindir@
+DATA_INSTALL_DIR = $(datadir)
+
+GAUCHE_DATA_DIR = $(datadir)/gauche
+GAUCHE_ARCH_DIR = @libdir@/gauche
+
+HEADER_INSTALL_DIR    = $(GAUCHE_ARCH_DIR)/@GAUCHE_VERSION@/include
+SCM_INSTALL_DIR       = $(GAUCHE_DATA_DIR)/@GAUCHE_VERSION@/lib
+ARCH_INSTALL_DIR      = $(GAUCHE_ARCH_DIR)/@GAUCHE_VERSION@/@target@
+SITE_SCM_DIR          = $(GAUCHE_DATA_DIR)/site/lib
+SITE_ARCH_DIR         = $(GAUCHE_ARCH_DIR)/site/@GAUCHE_VERSION@/@target@
+ARCH = @target@
+
+# targetlib is given when we relink the final version of gosh to embed
+# the path to libgauche.  Usually it is LIB_INSTALL_DIR, but under
+# certain circumstances (e.g. MacOSX framework build) it may be overridden.
+TARGETLIB=$(LIB_INSTALL_DIR)
+
+INSTALL_HEADERS = gauche.h \
+	../gc/include/gc.h \
+	../gc/include/gc_config_macros.h \
+	../gc/include/gc_pthread_redirects.h
+INSTALL_SUBHEADERS = gauche/config.h                                  \
+	 	     gauche/vm.h gauche/code.h gauche/vminsn.h        \
+                     gauche/char_euc_jp.h gauche/char_utf_8.h         \
+                     gauche/char_sjis.h gauche/char_none.h            \
+                     gauche/extend.h gauche/int64.h gauche/scmconst.h \
+                     gauche/number.h gauche/bignum.h gauche/vector.h  \
+	             gauche/port.h gauche/system.h                    \
+                     gauche/class.h gauche/exception.h                \
+                     gauche/builtin-syms.h                            \
+                     gauche/pthread.h gauche/uthread.h gauche/arch.h  \
+	             gauche/mingw-compat.h
+INSTALL_LIBS = libgauche.$(SOEXT)
+INSTALL_BINS = gosh$(EXEEXT)           \
+	       gauche-config$(EXEEXT)  \
+               gauche-install$(EXEEXT) \
+	       gauche-package$(EXEEXT) \
+	       gauche-cesconv$(EXEEXT)
+INSTALL_SCMS = gauche-init.scm genstub cesconv
+
+GENERATED_SCRIPTS = gauche-install gauche-package gauche-cesconv
+
+PRIVATE_HEADERS = gauche/arith.h 
+
+# MinGW specific
+INSTALL_MINGWHEADERS = gauche/mingw-compat.h
+
+# build -----------------------------------------------
+
+GCLIB = ../gc/libgc.la
+
+gosh_SOURCES = main.c
+gosh_OBJECTS = main.$(OBJEXT)
+gosh_LDADD   = -lgauche
+gosh_LDFLAGS = @SHLIB_MAIN_LDFLAGS@
+
+libgauche_LIBRARY = libgauche.$(SOEXT)
+libgauche_OBJECTS = \
+        core.$(OBJEXT) vm.$(OBJEXT) compaux.$(OBJEXT) macro.$(OBJEXT) \
+	code.$(OBJEXT) error.$(OBJEXT) class.$(OBJEXT) prof.$(OBJEXT) \
+	boolean.$(OBJEXT) char.$(OBJEXT) string.$(OBJEXT) list.$(OBJEXT) \
+	port.$(OBJEXT) hash.$(OBJEXT) write.$(OBJEXT) read.$(OBJEXT) \
+	vector.$(OBJEXT) weak.$(OBJEXT) symbol.$(OBJEXT) keyword.$(OBJEXT) \
+	compare.$(OBJEXT) regexp.$(OBJEXT) signal.$(OBJEXT) \
+	parameter.$(OBJEXT) module.$(OBJEXT) proc.$(OBJEXT) \
+	number.$(OBJEXT) bignum.$(OBJEXT) load.$(OBJEXT) paths.$(OBJEXT) \
+	promise.$(OBJEXT) repl.$(OBJEXT) autoloads.$(OBJEXT) \
+	system.$(OBJEXT) stdlib.$(OBJEXT) extlib.$(OBJEXT) exclib.$(OBJEXT) \
+	syslib.$(OBJEXT) moplib.$(OBJEXT) intlib.$(OBJEXT) compile.$(OBJEXT) \
+	scmlib.$(OBJEXT) objlib.$(OBJEXT)
+libgauche_LDFLAGS = $(SONAME_FLAG) @SHLIB_DYLIB_LDFLAGS@
+
+HEADERS = gauche.h $(INSTALL_SUBHEADERS) $(PRIVATE_HEADERS)
+
+OBJECTS = $(libgauche_OBJECTS) $(gosh_OBJECTS)
+
+all : libgauche.$(SOEXT) $(INSTALL_BINS) $(GENERATED_SCRIPTS)
+
+gosh$(EXEEXT) : libgauche.$(SOEXT) $(gosh_OBJECTS) 
+	@rm -f gosh$(EXEEXT)
+	$(LINK) $(gosh_LDFLAGS) -o gosh$(EXEEXT) $(gosh_OBJECTS) $(gosh_LDADD) $(LIBS)
+
+relink :
+	$(RELINK) $(libgauche_LDFLAGS) libgauche.$(SOEXT) $(libgauche_OBJECTS) ../gc/*.lo $(LIBS)
+	$(RELINK) $(gosh_LDFLAGS) -o gosh$(EXEEXT)  $(gosh_OBJECTS) $(gosh_LDADD) $(LIBS)
+
+$(OBJECTS) : $(HEADERS)
+
+stdlib.c : stdlib.stub genstub 
+extlib.c : extlib.stub genstub
+exclib.c : exclib.stub genstub
+syslib.c : syslib.stub genstub
+moplib.c : moplib.stub genstub
+intlib.c : intlib.stub genstub
+
+autoloads.c : autoloads.scm
+	$(HOSTGOSH) ./autoloads.scm
+
+builtin-syms.c gauche/builtin-syms.h : builtin-syms.scm
+	$(HOSTGOSH) ./builtin-syms.scm
+
+vminsn.c gauche/vminsn.h ../lib/gauche/vm/insn.scm : vminsn.scm geninsn
+	$(HOSTGOSH) ./geninsn
+
+compile.c : compile.scm gencomp vminsn.scm
+	$(HOSTGOSH) ./gencomp compile.scm
+
+scmlib.c : scmlib.scm gencomp vminsn.scm
+	$(HOSTGOSH) ./gencomp scmlib.scm
+
+objlib.c : objlib.scm gencomp vminsn.scm
+	$(HOSTGOSH) ./gencomp objlib.scm
+
+symbol.$(OBJEXT) : builtin-syms.c
+
+port.$(OBJEXT) : port.c portapi.c
+
+vm.$(OBJEXT) : vminsn.c vmstat.c
+
+load.$(OBJEXT) : dl_dlopen.c dl_dummy.c dl_win.c dl_darwin.c
+
+paths.$(OBJEXT) : getdir_win.c getdir_dummy.c getdir_darwin.c
+
+libgauche.$(SOEXT) : $(libgauche_OBJECTS) $(GCLIB)
+	$(LINK) $(libgauche_LDFLAGS) libgauche.$(SOEXT) $(libgauche_OBJECTS) ../gc/*.lo $(LIBS)
+	$(POSTBUILD)
+
+gauche-config$(EXEEXT) : gauche-config.$(OBJEXT)
+	$(LINK) -o gauche-config$(EXEEXT) gauche-config.$(OBJEXT) $(LIBS)
+
+gauche-config.c gauche/arch.h : genconfig
+	$(SHELL) ./genconfig
+
+gauche-install : gauche-install.in
+	@rm -f gauche-install
+	echo "#!$(BIN_INSTALL_DIR)/gosh" > gauche-install && \
+	cat gauche-install.in >> gauche-install
+	@chmod -w gauche-install
+
+gauche-package : gauche-package.in
+	@rm -f gauche-package
+	echo "#!$(BIN_INSTALL_DIR)/gosh" > gauche-package && \
+	cat gauche-package.in >> gauche-package
+	@chmod -w gauche-package
+
+gauche-cesconv : gauche-cesconv.in
+	@rm -f gauche-cesconv
+	echo "#!$(BIN_INSTALL_DIR)/gosh" > gauche-cesconv && \
+	cat gauche-cesconv.in >> gauche-cesconv
+	@chmod -w gauche-cesconv
+
+# a special build sequence when VM instruction set has been changed
+newinsn : 
+	$(HOSTGOSH) -fno-inline-globals ./gencomp compile.scm
+	$(HOSTGOSH) -fno-inline-globals ./gencomp scmlib.scm
+	$(HOSTGOSH) -fno-inline-globals ./gencomp objlib.scm
+	$(MAKE) all
+	./gosh -ftest ./gencomp compile.scm
+	./gosh -ftest ./gencomp scmlib.scm
+	./gosh -ftest ./gencomp objlib.scm
+	$(MAKE) all
+
+# tests -----------------------------------------------
+TESTFILES = `cat ../test/TESTS`
+
+check : test
+
+test : gosh$(EXEEXT) test-vmstack$(EXEEXT) test-arith$(EXEEXT)
+	@rm -f test.log
+	./test-vmstack >> test.log
+	./test-arith >> test.log
+	@for testfile in $(TESTFILES); do \
+	  ./gosh -ftest -I../test $$testfile >> test.log; \
+	done
+	@./gosh -ftest -e "(define *case-fold* #f)" ../test/symcase.scm >> test.log
+	@./gosh -ftest -fcase-fold -e "(define *case-fold* #t)" ../test/symcase.scm >> test.log
+	@echo "See test.log for details."
+
+test-vmstack$(EXEEXT) : test-vmstack.$(OBJEXT) libgauche.$(SOEXT)
+	$(LINK)	-o test-vmstack$(EXEEXT) test-vmstack.$(OBJEXT) $(gosh_LDADD) $(LIBS)
+
+test-arith$(EXEEXT) : test-arith.$(OBJEXT) libgauche.$(SOEXT)
+	$(LINK)	-o test-arith$(EXEEXT) test-arith.$(OBJEXT) $(gosh_LDADD) $(LIBS)
+
+test-arith.$(OBJEXT) : gauche/arith.h
+
+install-check :
+	@rm -rf test.log
+	@for f in `cat ../test/TESTS`; do \
+	  ${bindir}/gosh ../test/$$f; \
+	done
+
+# clean ------------------------------------------------
+GENERATED = stdlib.c extlib.c exclib.c syslib.c moplib.c intlib.c scmlib.c \
+	    objlib.c compile.c autoloads.c builtin-syms.c \
+	    gauche/builtin-syms.h vminsn.c gauche/vminsn.h \
+            ../lib/gauche/vm/insn.scm
+CONFIG_GENERATED = Makefile genconfig gauche/config.h
+
+clean :
+	rm -rf core core.[0-9]* gosh$(EXEEXT) gauche-config$(EXEEXT) \
+	       test-vmstack$(EXEEXT) test-arith$(EXEEXT)   \
+	       $(GENERATED_SCRIPTS) gauche-config.c \
+	       libgauche.$(SOEXT)* *.$(OBJEXT) *~ *.a *.t *.def *.exp *.exe \
+	       test.log test.dir so_locations gauche/*~ gauche/arch.h
+
+distclean : clean
+	rm -f $(CONFIG_GENERATED)
+
+maintainer-clean : clean
+	rm -f $(CONFIG_GENERATED) $(GENERATED)
+
+# install ----------------------------------------------
+
+INSTALL_DIRS = $(DESTDIR)$(HEADER_INSTALL_DIR) \
+	       $(DESTDIR)$(HEADER_INSTALL_DIR)/gauche \
+	       $(DESTDIR)$(SCM_INSTALL_DIR) \
+	       $(DESTDIR)$(ARCH_INSTALL_DIR) \
+	       $(DESTDIR)$(BIN_INSTALL_DIR) \
+	       $(DESTDIR)$(SITE_SCM_DIR) \
+	       $(DESTDIR)$(SITE_ARCH_DIR)
+
+install : all relink
+	$(MKINSTDIR) $(INSTALL_DIRS)
+	$(INSTALL) -m 444 $(INSTALL_HEADERS) $(DESTDIR)$(HEADER_INSTALL_DIR)
+	$(INSTALL) -m 444 $(INSTALL_SUBHEADERS) $(DESTDIR)$(HEADER_INSTALL_DIR)/gauche
+	$(INSTALL)        $(INSTALL_LIBS) $(DESTDIR)$(LIB_INSTALL_DIR)
+	$(INSTALL)        $(INSTALL_LIBS) $(DESTDIR)$(ARCH_INSTALL_DIR)
+	$(INSTALL) -m 555 $(INSTALL_BINS) $(DESTDIR)$(BIN_INSTALL_DIR)
+	$(INSTALL) -m 555 $(INSTALL_BINS) $(DESTDIR)$(ARCH_INSTALL_DIR)
+	$(INSTALL) -m 444 $(INSTALL_SCMS) $(DESTDIR)$(SCM_INSTALL_DIR)
+	@case `./gauche-config --arch` in *-cygwin*|*-mingw*) \
+	  $(INSTALL) $(INSTALL_LIBS) $(DESTDIR)$(BIN_INSTALL_DIR);;\
+	esac
+	$(POSTINSTALL)
+
+uninstall :
+	for f in $(INSTALL_BINS); do rm -f $(BIN_INSTALL_DIR)/$$f; done
+	for f in $(INSTALL_LIBS); do rm -f $(LIB_INSTALL_DIR)/$$f; done
+	rm -rf $(GAUCHE_ARCH_DIR)/@GAUCHE_VERSION@ $(GAUCHE_DATA_DIR)/@GAUCHE_VERSION@ $(GAUCHE_ARCH_DIR)/site/@GAUCHE_VERSION@
+
+pre-package : $(GENERATED)
+
+# MinGW specific stuff --------------------------------
+
+# we don't use $(EXEEXT), for we know it is .exe on MinGW.
+# using it explicitly prevent make from being confused if $(EXEEXT) is empty.
+.in.exe:
+	$(SHELL) mingw-exify $< > $<.c
+	$(COMPILE) -c -o $<.o $<.c
+	$(LINK) $(gosh_LDFLAGS) -o $@ $<.o $(gosh_LDADD) $(LIBS)
+
+install-mingw:
+	$(INSTALL) -m 444 $(INSTALL_MINGWHEADERS) $(DESTDIR)$(HEADER_INSTALL_DIR)/gauche
+
