Package: fuse
Version: 0.4.0
Revision: 3
Source: http://dev.kublai.com/macfuse-%v.tar.gz
Source-MD5: 56277d6521eec883767f01310b4d9dc6
Source2: mirror:sourceforge:%n/%n-2.6.5.tar.gz
Source2-MD5: 66bd30503df55a87b9868835ca5a45bc

# Broken with xcode 2.2, reported working with 2.4.0
BuildDepends: gcc4.0 (>= 4.0.1-5363)

PatchScript: <<
sed -i.bak -e 's,/System/Library/Filesystems/,%p/lib/%n/,' \
  fusefs/common/fuse_param.h libfuse/fuse-2.6.5-macosx.patch
cd ../fuse-2.6.5 && patch -p1 < ../macfuse-%v/libfuse/fuse-2.6.5-macosx.patch
<<
CompileScript: <<
#!/bin/sh -ev
if test "%m" = "powerpc"; then ARCHS=ppc; else ARCHS=i386; fi
cd fusefs
for target in fusefs mount_fusefs load_fusefs fusefs.fs
do
  xcodebuild -target $target SDKROOT= ARCHS=$ARCHS
done
cd ../../fuse-2.6.5
CFLAGS="-D__FreeBSD__=10 -O -g" LDFLAGS="-framework CoreFoundation" ./configure --prefix=%p --disable-dependency-tracking
make
<<
InstallScript: <<
# TODO: figure out how to install this in /System/Library/Filesystems
mkdir -p %i/lib/%n
cp -R fusefs/build/Release/fusefs.fs %i/lib/%n
mkdir %i/lib/%n/fusefs.fs/Support
cp -R fusefs/build/Release/fusefs.kext %i/lib/%n/fusefs.fs/Support
cp fusefs/build/Release/*_fusefs %i/lib/%n/fusefs.fs/Support
cd ../fuse-2.6.5 && make install DESTDIR=%d
<<
PreRmScript: /sbin/kextunload %p/lib/fuse/fusefs.kext || true
PostInstScript: <<
chown -R root:wheel %p/lib/%n/fusefs.fs/Support/fusefs.kext
#chown -R root:wheel /System/Library/Filesystems/fusefs.fs
chmod u+s %p/lib/%n/fusefs.fs/Support/load_fusefs
<<
DocFiles: COPYING.txt CHANGELOG.txt HOWTO.txt README.txt

SplitOff: <<
  Package: fuse-dev
  Depends: fuse-shlibs (= %v-%r), pkgconfig
  BuildDependsOnly: True
  DocFiles: COPYING.txt
  Files: <<
    include 
    lib/libfuse.dylib lib/libfuse.a lib/libfuse.la
    lib/libulockmgr.dylib lib/libulockmgr.a lib/libulockmgr.la
    lib/pkgconfig
  <<
  Description: Filesystem in Userspace (development resources)
  DescDetail: <<
    These are the header and library files required for building FUSE filesystems.
  <<
<<

SplitOff2: <<
  Package: fuse-shlibs
  Depends: fuse (= %v-%r)
  DocFiles: COPYING.txt
  Files: <<
    lib/libfuse.0.dylib
    lib/libulockmgr.1.dylib
  <<
  Shlibs: <<
    %p/lib/libfuse.0.dylib 1.0.0 fuse (>= 0.1.0b006-1)
    %p/lib/libulockmgr.1.dylib 2.0.0 fuse (>= 0.1.0b006-1)
  <<
<<

Description: File System in User Space (MacFUSE)
DescDetail: <<
This is MacFUSE, a port of FUSE (filesystem in userspace) for OS X.
FUSE makes it possible to add new file systems just by running a regular,
unprivileged program. For example, the sshfs FUSE client allows you to
mount a remote server's filesystem without any requirement other than
SSH access (sshfs is packaged separately).
<<
License: BSD
Homepage: http://code.google.com/p/macfuse/
Maintainer: Brendan Cully <bcully@users.sourceforge.net>
