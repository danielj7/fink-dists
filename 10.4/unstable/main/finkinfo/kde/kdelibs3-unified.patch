
--- kdelibs-3.5.2/configure.in.in	2005-10-10 11:06:43.000000000 -0400
+++ kdelibs-3.5.2-new/configure.in.in	2006-04-14 15:43:19.000000000 -0400
@@ -226,6 +226,17 @@
 fi
 AC_SUBST(QNAMESPACE_H)
 
+AC_LANG_SAVE
+AC_LANG_CPLUSPLUS
+AC_MSG_CHECKING([if getmntinfo() uses struct statvfs])
+AC_TRY_LINK([#include <sys/types.h>
+#include <sys/statvfs.h>
+],[int flags = 0; struct statvfs *mntbufp; return getmntinfo(&mntbufp, flags);],
+[AC_MSG_RESULT(yes)
+AC_DEFINE(GETMNTINFO_USES_STATVFS,,[getmntinfo() uses struct statvfs])],
+AC_MSG_RESULT(no))
+AC_LANG_RESTORE
+
 dnl output files
 AC_SUBST(x_includes)
 AC_SUBST(x_libraries)
@@ -306,7 +317,10 @@
    CXXFLAGS="$CXXFLAGS $USE_RTTI"
 fi
 
-rgb_file="$x_libraries/X11/rgb.txt"
+AC_ARG_WITH([rgbfile],
+  AC_HELP_STRING([--with-rgbfile=path], [Define custom path for rgb.txt. (default: \$(x11libdir)/X11/rgb.txt)]),
+  [rgb_file=$withval], [rgb_file="$x_libraries/X11/rgb.txt"])
+
 AC_DEFINE_UNQUOTED(X11_RGBFILE, "$rgb_file", [where rgb.txt is in])
 
 AC_MSG_CHECKING([for Compiler version])
--- kdelibs-3.5.2/darwin/kcmartsrc	1969-12-31 19:00:00.000000000 -0500
+++ kdelibs-3.5.2-new/darwin/kcmartsrc	2006-04-14 15:42:58.000000000 -0400
@@ -0,0 +1,9 @@
+[Arts]
+Arguments=\s-F 10 -S 4096 -a esd -d -b 16 -s 60 -m artsmessage -c drkonqi -l 3 -f
+Bits=16
+FullDuplex=true
+AudioIO=esd
+NetworkTransparent=true
+StartRealtime=false
+StartServer=false
+SuspendTime=60
--- kdelibs-3.5.2/darwin/kdeglobals	1969-12-31 19:00:00.000000000 -0500
+++ kdelibs-3.5.2-new/darwin/kdeglobals	2006-04-14 15:42:58.000000000 -0400
@@ -0,0 +1,129 @@
+[$Version]
+update_info=kaccel.upd:kde3.3/r1,kded.upd:kde3.0,klippershortcuts.upd:04112002,kwin.upd:kde3.2Xinerama,socks.upd:kde3.0/r1
+
+[General]
+XftHintStyle=hintmedium
+XftSubPixel=
+fixed=Monaco CY,11,-1,5,50,0,0,0,0,0
+font=Baghdad,12,-1,5,50,0,0,0,0,0
+menuFont=Baghdad,12,-1,5,50,0,0,0,0,0
+taskbarFont=Baghdad,11,-1,5,50,0,0,0,0,0
+toolBarFont=Baghdad,10,-1,5,50,0,0,0,0,0
+
+[Global Shortcuts]
+Activate Window Demanding Attention=default(Alt+Ctrl+A)
+Defaults timestamp=Mar  1 200514:10:32
+Desktop Screenshot=default(Ctrl+Print)
+Enable/Disable Clipboard Actions=default(Alt+Ctrl+X)
+Halt without Confirmation=default(Alt+Ctrl+Shift+PageDown)
+Kill Window=default(Alt+Ctrl+Escape)
+Lock Session=default(Alt+Ctrl+L)
+Log Out=default(Alt+Ctrl+Delete)
+Log Out Without Confirmation=default(Alt+Ctrl+Shift+Delete)
+Manually Invoke Action on Current Clipboard=default(Alt+Ctrl+R)
+Mouse Emulation=default(Alt+F12)
+Next Taskbar Entry=none
+Popup Launch Menu=default(Alt+F1)
+Previous Taskbar Entry=none
+Reboot without Confirmation=default(Alt+Ctrl+Shift+PageUp)
+Run Command=default(Alt+F2)
+Setup Window Shortcut=none
+Show Klipper Popup-Menu=default(Alt+Ctrl+V)
+Show Taskmanager=default(Ctrl+Escape)
+Show Window List=default(Alt+F5)
+Switch One Desktop Down=none
+Switch One Desktop Up=none
+Switch One Desktop to the Left=none
+Switch One Desktop to the Right=none
+Switch User=default(Alt+Ctrl+Insert)
+Switch to Desktop 1=default(Ctrl+F1)
+Switch to Desktop 10=default(Ctrl+F10)
+Switch to Desktop 11=default(Ctrl+F11)
+Switch to Desktop 12=default(Ctrl+F12)
+Switch to Desktop 13=default(Ctrl+Shift+F1)
+Switch to Desktop 14=default(Ctrl+Shift+F2)
+Switch to Desktop 15=default(Ctrl+Shift+F3)
+Switch to Desktop 16=default(Ctrl+Shift+F4)
+Switch to Desktop 17=default(Ctrl+Shift+F5)
+Switch to Desktop 18=default(Ctrl+Shift+F6)
+Switch to Desktop 19=default(Ctrl+Shift+F7)
+Switch to Desktop 2=default(Ctrl+F2)
+Switch to Desktop 20=default(Ctrl+Shift+F8)
+Switch to Desktop 3=default(Ctrl+F3)
+Switch to Desktop 4=default(Ctrl+F4)
+Switch to Desktop 5=default(Ctrl+F5)
+Switch to Desktop 6=default(Ctrl+F6)
+Switch to Desktop 7=default(Ctrl+F7)
+Switch to Desktop 8=default(Ctrl+F8)
+Switch to Desktop 9=default(Ctrl+F9)
+Switch to Next Desktop=none
+Switch to Next Keyboard Layout=default(Alt+Ctrl+K)
+Switch to Previous Desktop=none
+Toggle Showing Desktop=default(Alt+Ctrl+D)
+Toggle Window Raise/Lower=none
+Walk Through Desktop List=default(Ctrl+Tab)
+Walk Through Desktop List (Reverse)=default(Ctrl+Shift+Tab)
+Walk Through Desktops=none
+Walk Through Desktops (Reverse)=none
+Walk Through Windows=default(Alt+Tab)
+Walk Through Windows (Reverse)=default(Alt+Shift+Tab)
+Window Above Other Windows=none
+Window Below Other Windows=none
+Window Close=default(Alt+F4)
+Window Fullscreen=none
+Window Grow Horizontal=none
+Window Grow Vertical=none
+Window Lower=none
+Window Maximize=none
+Window Maximize Horizontal=none
+Window Maximize Vertical=none
+Window Minimize=none
+Window Move=none
+Window No Border=none
+Window On All Desktops=none
+Window One Desktop Down=none
+Window One Desktop Up=none
+Window One Desktop to the Left=none
+Window One Desktop to the Right=none
+Window Operations Menu=default(Alt+F3)
+Window Pack Down=none
+Window Pack Left=none
+Window Pack Right=none
+Window Pack Up=none
+Window Raise=none
+Window Resize=none
+Window Screenshot=default(Alt+Print)
+Window Shade=none
+Window Shrink Horizontal=none
+Window Shrink Vertical=none
+Window to Desktop 1=none
+Window to Desktop 10=none
+Window to Desktop 11=none
+Window to Desktop 12=none
+Window to Desktop 13=none
+Window to Desktop 14=none
+Window to Desktop 15=none
+Window to Desktop 16=none
+Window to Desktop 17=none
+Window to Desktop 18=none
+Window to Desktop 19=none
+Window to Desktop 2=none
+Window to Desktop 20=none
+Window to Desktop 3=none
+Window to Desktop 4=none
+Window to Desktop 5=none
+Window to Desktop 6=none
+Window to Desktop 7=none
+Window to Desktop 8=none
+Window to Desktop 9=none
+Window to Next Desktop=none
+Window to Previous Desktop=none
+
+[KDE]
+ShowDeleteCommand=false
+
+[Paths]
+Trash=$HOME/Desktop/.Trash/
+
+[WM]
+activeFont=Baghdad,12,-1,5,50,0,0,0,0,0
--- kdelibs-3.5.2/darwin/knotifyrc	1969-12-31 19:00:00.000000000 -0500
+++ kdelibs-3.5.2-new/darwin/knotifyrc	2006-04-14 15:42:58.000000000 -0400
@@ -0,0 +1,5 @@
+[Misc]
+External player=@FINKPREFIX@/bin/mplayer
+LastConfiguredApp=knotify
+Use external player=false
+Volume=100
--- kdelibs-3.5.2/darwin/konsolerc	1969-12-31 19:00:00.000000000 -0500
+++ kdelibs-3.5.2-new/darwin/konsolerc	2006-04-14 15:42:58.000000000 -0400
@@ -0,0 +1,19 @@
+[Desktop Entry]
+ActiveSession=0
+AutoResizeTabs=false
+DefaultSession=shell.desktop
+DynamicTabHide=false
+Fullscreen=false
+Height 832=510
+TabViewMode=0
+Width 1280=927
+bellmode=0
+class=konsole-mainwindow#1
+defaultfont=Monaco CY,12,-1,5,50,0,0,0,0,0
+font=8
+history=1000
+historyenabled=true
+keytab=default
+schema=Linux.schema
+scrollbar=2
+tabbar=2
--- kdelibs-3.5.2/kabc/Makefile.am	2005-09-10 04:27:01.000000000 -0400
+++ kdelibs-3.5.2-new/kabc/Makefile.am	2006-04-14 15:42:56.000000000 -0400
@@ -2,7 +2,7 @@
 
 # Make sure $(all_includes) remains last!
 INCLUDES = -I$(top_builddir)/kabc -I$(top_srcdir)/kabc -I$(top_srcdir)/kab \
-           -I$(srcdir)/vcardparser/ -I$(srcdir)/vcard/include \
+           -I$(srcdir)/vcard/include -I$(srcdir)/vcardparser/ \
            -I$(srcdir)/vcard/include/generated \
            -I$(srcdir)/vcardparser $(all_includes)
 
--- kdelibs-3.5.2/kabc/plugins/file/resourcefile.cpp	2006-03-17 05:19:10.000000000 -0500
+++ kdelibs-3.5.2-new/kabc/plugins/file/resourcefile.cpp	2006-04-14 15:43:10.000000000 -0400
@@ -2,6 +2,7 @@
     This file is part of libkabc.
 
     Copyright (c) 2001,2003 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2006 Tom Abers <tomalbers@kde.nl>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -37,6 +38,9 @@
 #include <ksavefile.h>
 #include <kstandarddirs.h>
 #include <ktempfile.h>
+#include <kurl.h>
+#include <jobclasses.h>
+#include <kio/netaccess.h>
 
 #include "formatfactory.h"
 #include "resourcefileconfig.h"
@@ -189,9 +193,31 @@
 
     if ( file.size() == 0 ) {
       file.close();
+      kdDebug() << "File size is zero. Evaluating backups" << endl;
+      for (int i=0; i!=20; i++)
+      {
+        QFile backup( mFileName + "__" + QString::number(i) );
+        kdDebug() << "Evaluating" << backup.name() << " size: " << backup.size() << endl;
+        if ( backup.size() != 0 )
+        {
+          kdDebug() << "Restoring backup " << i << endl;
+          KURL src, dest;
+          src.setPath( mFileName + "__" + QString::number(i) );
+          dest.setPath( mFileName );
+          
+          KIO::DeleteJob* job = KIO::del( dest, false, false ); 
+          KIO::NetAccess::synchronousRun( job, 0);
+          
+          KIO::CopyJob* job2 = KIO::copy( src, dest, false ); 
+          KIO::NetAccess::synchronousRun( job2, 0);
+
+          backup.close();
+          return true; 
+        }
+        backup.close();
+      }
       return true;
     }
-
     bool ok = mFormat->checkFormat( &file );
     file.close();
 
@@ -307,8 +333,28 @@
     return false;
   }
 
-  // create backup file
-  QString extension = "_" + QString::number( QDate::currentDate().dayOfWeek() );
+  // Only do the logrotate dance when the __0 file is not 0 bytes.
+  QFile file( mFileName + "__0" );
+  if ( file.size() != 0 ) {
+    KURL last;
+    last.setPath( mFileName + "__20" );
+    kdDebug() << "deleting " << last << endl;
+    KIO::DeleteJob* job = KIO::del( last, false, false ); 
+    KIO::NetAccess::synchronousRun( job, 0);
+
+    for (int i=19; i>=0; i--)
+    {
+      KURL src, dest;
+      src.setPath( mFileName + "__" + QString::number(i) );
+      dest.setPath( mFileName + "__" + QString::number(i+1) );
+      kdDebug() << "moving " << src << " -> " << dest << endl;
+      KIO::SimpleJob* job = KIO::rename( src, dest, false ); 
+      KIO::NetAccess::synchronousRun( job, 0);
+    }
+  } else
+    kdDebug() << "Not starting logrotate __0 is 0 bytes." << endl;
+  
+  QString extension = "__0";
   (void) KSaveFile::backupFile( mFileName, QString::null /*directory*/,
                                 extension );
 
--- kdelibs-3.5.2/kate/data/ada.xml	2005-09-10 04:26:35.000000000 -0400
+++ kdelibs-3.5.2-new/kate/data/ada.xml	2006-04-14 15:43:08.000000000 -0400
@@ -73,14 +73,16 @@
       <context attribute="Normal Text" lineEndContext="#stay" name="Default">
         <RegExpr attribute="Keyword" context="#stay" String="if " insensitive="TRUE" beginRegion="Region1" firstNonSpace="true"/>
         <StringDetect attribute="Keyword" context="#stay" String="end if" insensitive="TRUE" endRegion="Region1"/>
-        <RegExpr attribute="Keyword" context="#stay" String="case " insensitive="TRUE" beginRegion="Region2" firstNonSpace="true"/>
-        <StringDetect attribute="Keyword" context="#stay" String="end case" insensitive="TRUE" endRegion="Region2"/>
         <RegExpr attribute="Keyword" context="#stay" String="\sloop\s+" insensitive="TRUE" beginRegion="Region3"/>
         <RegExpr attribute="Keyword" context="#stay" String="\sloop$" insensitive="TRUE" beginRegion="Region3"/>
         <StringDetect attribute="Keyword" context="#stay" String="end loop;" insensitive="TRUE" endRegion="Region3"/>
         <RegExpr attribute="Keyword" context="#stay" String="\sselect\s+" insensitive="TRUE" beginRegion="Region4"/>
         <RegExpr attribute="Keyword" context="#stay" String="\sselect$" insensitive="TRUE" beginRegion="Region4"/>
         <StringDetect attribute="Keyword" context="#stay" String="end select;" insensitive="TRUE" endRegion="Region4"/>
+        <RegExpr attribute="Keyword" context="#stay" String="\b(begin|case|record)\b" insensitive="true" beginRegion="Region5"/>
+        <RegExpr attribute="Keyword" context="#stay" String="\bend(?=((\{[^}]*(\}|$)|\(\*.*(\*\)|$))*)([.;\s]|$)|//|$)" insensitive="true" endRegion="Region5"/>
+        <StringDetect attribute="Region Marker" context="Region Marker" String="--  BEGIN" beginRegion="RegionMarker" firstNonSpace="true" />
+        <StringDetect attribute="Region Marker" context="Region Marker" String="--  END" endRegion="RegionMarker" firstNonSpace="true" />
         <keyword attribute="Keyword" context="#stay" String="keywords"/>
         <Float attribute="Float" context="#stay"/>
         <Int attribute="Decimal" context="#stay"/>
@@ -88,6 +90,7 @@
         <DetectChar attribute="String" context="String" char="&quot;"/>
         <Detect2Chars attribute="Comment" context="Comment" char="-" char1="-"/>
       </context>
+      <context attribute="Region Marker" lineEndContext="#pop" name="Region Marker"/>
       <context attribute="String" lineEndContext="#pop" name="String">
         <DetectChar attribute="String" context="#pop" char="&quot;"/>
       </context>
@@ -102,6 +105,7 @@
       <itemData name="Char"        defStyleNum="dsChar" />
       <itemData name="String"      defStyleNum="dsString" />
       <itemData name="Comment"     defStyleNum="dsComment" />
+      <itemData name="Region Marker" defStyleNum="dsRegionMarker" />
     </itemDatas>
   </highlighting>
   <general>
--- kdelibs-3.5.2/kate/data/cpp.xml	2006-01-19 12:06:23.000000000 -0500
+++ kdelibs-3.5.2-new/kate/data/cpp.xml	2006-04-14 15:43:08.000000000 -0400
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="C++" version="1.34" kateversion="2.4" section="Sources" extensions="*.cxx;*.cpp;*.cc;*.C;*.h;*.hh;*.H;*.hxx;*.hpp;*.hcc;*.moc" mimetype="text/x-c++src;text/x-c++hdr;text/x-chdr" priority="9">
+<language name="C++" version="1.36" kateversion="2.4" section="Sources" extensions="*.c++;*.cxx;*.cpp;*.cc;*.C;*.h;*.H;*.h++;*.hxx;*.hpp;*.hcc;*.moc" mimetype="text/x-c++src;text/x-c++hdr;text/x-chdr" priority="9">
   <highlighting>
     <list name="keywords">
       <item> asm </item>
@@ -31,6 +31,7 @@
       <item> private </item>
       <item> protected </item>
       <item> public </item>
+      <item> qobject_cast </item>
       <item> reinterpret_cast </item>
       <item> return </item>
       <item> sizeof </item>
@@ -79,6 +80,33 @@
       <item> Q_OVERRIDE </item>
       <item> Q_PROPERTY </item>
       <item> Q_SETS </item>
+      <item> Q_SIGNALS </item>
+      <item> Q_SLOTS </item>
+      <item> Q_FOREACH </item>
+      <item> Q_DECLARE_FLAGS </item>
+      <item> Q_INIT_RESOURCE </item>
+      <item> Q_CLEANUP_RESOURCE </item>
+      <item> Q_GLOBAL_STATIC </item>
+      <item> Q_GLOBAL_STATIC_WITH_ARGS </item>
+      <item> Q_DECLARE_TYPEINFO </item>
+      <item> Q_DECLARE_SHARED </item>
+      <item> Q_DECLARE_FLAGS </item>
+      <item> Q_DECLARE_OPERATORS_FOR_FLAGS </item>
+      <item> Q_FOREVER </item>
+      <item> Q_DECLARE_PRIVATE </item>
+      <item> Q_DECLARE_PUBLIC </item>
+      <item> Q_D </item>
+      <item> Q_Q </item>
+      <item> Q_DISABLE_COPY </item>
+      <item> Q_INTERFACES </item>
+      <item> Q_FLAGS </item>
+      <item> Q_SCRIPTABLE </item>
+      <item> Q_INVOKABLE </item>
+      <item> Q_GADGET </item>
+      <item> Q_ARG </item>
+      <item> Q_RETURN_ARG </item>
+      <item> Q_ASSERT </item>
+      <item> Q_ASSERT_X </item>
       <item> TRUE </item>
       <item> FALSE </item>
       <item> connect </item>
@@ -87,6 +115,7 @@
       <item> signals </item>
       <item> slots </item>
       <item> foreach </item>
+      <item> forever </item>
     </list>
     <list name="types">
       <item> auto </item>
--- kdelibs-3.5.2/kate/data/logtalk.xml	2005-09-10 04:26:35.000000000 -0400
+++ kdelibs-3.5.2-new/kate/data/logtalk.xml	2006-04-14 15:43:08.000000000 -0400
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
 
-<language name="Logtalk" version="1.40" kateversion="2.4" section="Sources" extensions="*.lgt;*.config" mimetype="text/x-logtalk" author="Paulo Moura (pmoura@logtalk.org)" license="Artistic License 2.0">
+<language name="Logtalk" version="1.51" kateversion="2.4" section="Sources" extensions="*.lgt;*.config" mimetype="text/x-logtalk" author="Paulo Moura (pmoura@logtalk.org)" license="Artistic License 2.0">
 
 	<highlighting>
 
@@ -17,11 +17,11 @@
 				<!-- Reflection -->
 				<RegExpr String = "\b(current_predicate|predicate_property)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<!-- DCGs -->
-				<RegExpr String = "\b(expand_term|phrase)(?=[(])" attribute = "Built-in" context = "#stay" />
+				<RegExpr String = "\b(expand_term|term_expansion|phrase)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<!-- Entity -->
 				<RegExpr String = "\b(abolish|c(reate|urrent))_(object|protocol|category)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\b(object|protocol|category)_property(?=[(])" attribute = "Built-in" context = "#stay" />
-				<!-- Event handlers -->
+				<!-- Entity relations -->
 				<RegExpr String = "\bextends_(object|protocol)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\bimplements_protocol(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\b(instantiates|specializes)_class(?=[(])" attribute = "Built-in" context = "#stay" />
@@ -48,7 +48,7 @@
 				<RegExpr String = "\b(rem|mod|abs|sign)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\bfloat(_(integer|fractional)_part)?(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\b(floor|truncate|round|ceiling)(?=[(])" attribute = "Built-in" context = "#stay" />
-				<!-- Other arithemtic functors -->
+				<!-- Other arithmetic functors -->
 				<RegExpr String = "\b(cos|atan|exp|log|s(in|qrt))(?=[(])" attribute = "Built-in" context = "#stay" />
 				<!-- Term testing -->
 				<RegExpr String = "\b(var|atom(ic)?|integer|float|compound|n(onvar|umber))(?=[(])" attribute = "Built-in" context = "#stay" />
@@ -149,15 +149,16 @@
 				<!-- Entity directives -->
 				<RegExpr String = "\b(category|object|protocol)(?=[(])" attribute = "Directive" context = "entityrelations" beginRegion = "Entity"/>
 				<RegExpr String = "\bend_(category|object|protocol)[.]" attribute = "Directive" context = "#pop" endRegion = "Entity" />
+				<RegExpr String = "\bmodule(?=[(])" attribute = "Directive" context = "#pop"/>
  				<!-- Predicate scope directives -->
 				<RegExpr String = "\bp(ublic|r(otected|ivate))(?=[(])" attribute = "Directive" context = "#pop" />
 				<!-- Other directives -->
-				<RegExpr String = "\bencoding(?=[(])" attribute = "Directive" context = "#pop" />
+				<RegExpr String = "\be(ncoding|xport)(?=[(])" attribute = "Directive" context = "#pop" />
 			   	<RegExpr String = "\bin(fo|itialization)(?=[(])" attribute = "Directive" context = "#pop" />
 				<RegExpr String = "\bdynamic[.]" attribute = "Directive" context = "#pop" />
-				<RegExpr String = "\b(alias|d(ynamic|iscontiguous)|m(etapredicate|ode|ultifile))(?=[(])" attribute = "Directive" context = "#pop" />
+				<RegExpr String = "\b(alias|d(ynamic|iscontiguous)|meta_predicate|m(etapredicate|ode|ultifile))(?=[(])" attribute = "Directive" context = "#pop" />
 				<RegExpr String = "\bop(?=[(])" attribute = "Directive" context = "#pop" />
-				<RegExpr String = "\b(calls|uses)(?=[(])" attribute = "Directive" context = "#pop" />
+				<RegExpr String = "\b(calls|use(s|_module))(?=[(])" attribute = "Directive" context = "#pop" />
 			</context>
 
 			<context name = "entityrelations" attribute = "Normal" lineEndContext = "#stay" >
--- kdelibs-3.5.2/kate/data/lua.xml	2005-09-10 04:26:35.000000000 -0400
+++ kdelibs-3.5.2-new/kate/data/lua.xml	2006-04-14 15:43:08.000000000 -0400
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="Lua" version="0.22" kateversion="2.3" section="Scripts" extensions="*.lua" mimetype="text/x-lua">
+<language name="Lua" version="0.23" kateversion="2.3" section="Scripts" extensions="*.lua" mimetype="text/x-lua">
   <highlighting>
     <list name="keywords">
       <item> and </item>
@@ -19,7 +19,7 @@
       <item> else </item>
       <item> or </item>
       <item> while </item>
-      <item> elsif </item>
+      <item> elseif </item>
       <item> in </item>
       <item> repeat </item>
     </list>
--- kdelibs-3.5.2/kate/data/php.xml	2005-10-10 11:05:27.000000000 -0400
+++ kdelibs-3.5.2-new/kate/data/php.xml	2006-04-14 15:43:08.000000000 -0400
@@ -1,6 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
+<!--
+	Changes: version 1.25 -> 1.26
+	Date: 26/01/2006
+	Change author: Nicola Gigante
+		Added alternative syntax control structures and named logical operators (and or xor)
+-->
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="PHP/PHP" version="1.25" kateversion="2.4" section="Scripts" extensions="" priority="5" mimetype="" hidden="true">
+<language name="PHP/PHP" version="1.26" kateversion="2.4" section="Scripts" extensions="" priority="5" mimetype="" hidden="true">
   <highlighting>
     <list name="control structures">
       <item>as</item>
@@ -21,6 +27,11 @@
       <item>include</item>
       <item>require_once</item>
       <item>include_once</item>
+      <item>endif</item>
+      <item>endwhile</item>
+      <item>endfor</item>
+      <item>endforeach</item>
+      <item>endswitch</item>
     </list>
     <list name="keywords">
       <item> abstract </item>
@@ -42,6 +53,9 @@
       <item> public </item>
       <item> throw </item>
       <item> try </item>
+      <item> and </item>
+      <item> or </item>
+      <item> xor </item>
 	<item> var </item>
 	<item> __FILE__ </item>
 	<item> __LINE__ </item>
--- kdelibs-3.5.2/kate/data/progress.xml	2005-09-10 04:26:35.000000000 -0400
+++ kdelibs-3.5.2-new/kate/data/progress.xml	2006-04-14 15:43:08.000000000 -0400
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="progress" version="1.08" kateversion="2.4" section="Database" extensions="*.p;*.w;*.i" author="Rares Stanciulescu (rstanciu@operamail.com)" license="GPL">
+<language name="progress" version="1.09" kateversion="2.4" section="Database" extensions="*.p;*.w;*.i;*.cls" author="Rares Stanciulescu (rstanciu@operamail.com)" license="GPL">
   
 <highlighting>
     
@@ -31,20 +31,11 @@
   <item> TEMP-TABLE </item>
   <item> BUFFER </item>
   <item> STREAM </item>
+  <item> SAX-WRITER </item>
   <item> MEMPTR </item>
 </list>
     
   <list  name="operators">
-    <item> + </item>
-    <item> - </item>
-    <item> * </item>
-    <item> / </item>
-    <item> = </item>
-    <item> &lt; </item>
-    <item> &gt; </item>
-    <item> &lt;= </item>
-    <item> &gt;= </item>
-    <item> &lt;&gt; </item>
     <item> AND </item>
     <item> OR </item>
     <item> NOT </item>
@@ -82,6 +73,8 @@
           
 <list name="phrases">
   <item> AS </item>
+  <item> WORD-INDEX </item>
+  <item> LIKE </item>
   <item> ALERT-BOX </item>
   <item> AT </item>
   <item> COLOR </item>
@@ -148,9 +141,17 @@
   <item> NO-ECHO </item>
   <item> NO-MAP </item>
   <item> PRIVATE </item>
+  <item> PUBLIC </item>
+  <item> PROTECTED </item>
 </list>
           
 <list name="functions">
+  <item> output-content-type </item>
+  <item> get-value </item>
+  <item> get-cgi </item>
+  <item> get-field </item>
+  <item> html-encode </item>
+  <item> url-encode </item>  
   <item> ABSOLUTE </item>
   <item> ACCUM </item>
   <item> ADD-INTERVAL </item>
@@ -577,6 +578,7 @@
   <item> DEFAULT-WINDOW </item>
   <item> ERROR-STATUS </item>
   <item> FILE-INFO </item>
+  <item> FIELD </item>
   <item> FOCUS </item>
   <item> FONT-TABLE </item>
   <item> LAST-EVENT </item>
@@ -611,7 +613,6 @@
   <item> HONORPROKEYS </item>
   <item> HONORRETURNKEY </item>
   <item> LEFT </item>
-  <item> NAME </item>
   <item> TOP </item>
   <item> WIDTH </item>
   <item> TAG </item>
@@ -934,7 +935,6 @@
   <item> MULTIPLE </item>
   <item> MULTITASKING-INTERVAL </item>
   <item> MUST-UNDERSTAND </item>
-  <item> NAME </item>
   <item> NAMESPACE-PREFIX </item>
   <item> NAMESPACE-URI </item>
   <item> NEEDS-APPSERVER-PROMPT </item>
@@ -1163,6 +1163,22 @@
   <item> XML-SUPPRESS-NAMESPACE-PROCESSING </item>
   <item> Y </item>
   <item> YEAR-OFFSET </item>
+  <item> WRITE-XMLSCHEMA </item>
+  <item> WRITE-XML </item>
+  <item> READ-XML </item>
+  <item> NESTED </item>
+  <item> XML-DATA-TYPE </item>
+  <item> XML-NODE-TYPE </item>
+  <item> FORMATTED </item>
+  <item> SET-OUTPUT-DESTINATION </item>
+  <item> START-DOCUMENT </item>
+  <item> START-ELEMENT </item>
+  <item> WRITE-CHARACTERS </item>
+  <item> END-ELEMENT </item>
+  <item> END-DOCUMENT </item>
+  <item> WRITE-DATA-ELEMENT </item>
+  <item> INSERT-ATTRIBUTE </item>
+  
 </list>
 
 <list name="methods">
@@ -1489,7 +1505,7 @@
     <DetectChar attribute="Comment" context="Identifier" char='"'/>
     <DetectChar attribute="String" context="#stay" char='"'/>
     <DetectChar attribute="String" context="#stay" char="'"/>
-    <AnyChar attribute="Symbol" context="#stay" String="{}[]()~:"/>
+    <AnyChar attribute="Symbol" context="#stay" String="+-*=/\?~{}[]():."/>
     
     <StringDetect attribute="Region Marker" context="#stay"
                   String="PROCEDURE" insensitive="TRUE"
@@ -1504,6 +1520,26 @@
     <StringDetect attribute="Region Marker" context="#stay"
                   String="END FUNCTION" insensitive="TRUE"
                   endRegion="F1" firstNonSpace="TRUE"/>
+
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="CLASS" insensitive="TRUE"
+                  beginRegion="C1" firstNonSpace="TRUE"/>
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="END CLASS" insensitive="TRUE"
+                  endRegion="C1" firstNonSpace="TRUE"/>
+    
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="METHOD" insensitive="TRUE"
+                  beginRegion="M1" firstNonSpace="TRUE"/>
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="END METHOD" insensitive="TRUE"
+                  endRegion="M1" firstNonSpace="TRUE"/>    
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="CONSTRUCTOR" insensitive="TRUE"
+                  beginRegion="CN1" firstNonSpace="TRUE"/>
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="END CONSTRUCTOR" insensitive="TRUE"
+                  endRegion="CN1" firstNonSpace="TRUE"/>    
     
     <StringDetect attribute="Function" context="#stay"
                   String="DO:" insensitive="TRUE"
@@ -1521,6 +1557,7 @@
                   String="END" insensitive="TRUE"
                   endRegion="L1" firstNonSpace="TRUE"/>
     
+    
   </context>
   <context name="String" attribute="String" lineEndContext="#stay">
     <LineContinue attribute="String" context="#pop"/>
--- kdelibs-3.5.2/kate/data/ruby.xml	2006-03-17 05:19:05.000000000 -0500
+++ kdelibs-3.5.2-new/kate/data/ruby.xml	2006-04-14 15:43:08.000000000 -0400
@@ -34,7 +34,7 @@
 -->
 
 <!-- Hold the "language" opening tag on a single line, as mentioned in "language.dtd". -->
-<language name="Ruby" version="1.17" kateversion="2.4" section="Scripts" extensions="*.rb;*.rxml" mimetype="application/x-ruby" author="Stefan Lang (langstefan@gmx.at), Sebastian Vuorinen (sebastian.vuorinen@helsinki.fi)" license="LGPL">
+<language name="Ruby" version="1.17" kateversion="2.4" section="Scripts" extensions="*.rb;*.rjs;*.rxml" mimetype="application/x-ruby" author="Stefan Lang (langstefan@gmx.at), Sebastian Vuorinen (sebastian.vuorinen@helsinki.fi)" license="LGPL">
 	
 	<highlighting>
 	
--- kdelibs-3.5.2/kate/part/katedialogs.cpp	2006-01-19 12:06:22.000000000 -0500
+++ kdelibs-3.5.2-new/kate/part/katedialogs.cpp	2006-04-14 15:43:07.000000000 -0400
@@ -1634,7 +1634,7 @@
   // Start a KProcess that creates a diff
   KProcIO *p = new KProcIO();
   p->setComm( KProcess::All );
-  *p << "diff" << "-ub" << "-" <<  m_doc->url().path();
+  *p << "diff" << "-u" << "-" <<  m_doc->url().path();
   connect( p, SIGNAL(processExited(KProcess*)), this, SLOT(slotPDone(KProcess*)) );
   connect( p, SIGNAL(readReady(KProcIO*)), this, SLOT(slotPRead(KProcIO*)) );
 
@@ -1644,7 +1644,7 @@
 
   uint lastln =  m_doc->numLines();
   for ( uint l = 0; l <  lastln; l++ )
-    p->writeStdin(  m_doc->textLine( l ), l < lastln );
+    p->writeStdin( m_doc->textLine( l ) );
 
   p->closeWhenDone();
 }
@@ -1656,15 +1656,32 @@
     m_tmpfile = new KTempFile();
   // put all the data we have in it
   QString stmp;
+  bool dataRead = false;
   while ( p->readln( stmp, false ) > -1 )
+  {
     *m_tmpfile->textStream() << stmp << endl;
+    dataRead = true;
+  }
 
-  p->ackRead();
+  // dominik: only ackRead(), when we *really* read data, otherwise, this slot
+  // is called initity times, which leads to a crash
+  if( dataRead )
+    p->ackRead();
 }
 
 void KateModOnHdPrompt::slotPDone( KProcess *p )
 {
   setCursor( ArrowCursor );
+  if( ! m_tmpfile )
+  {
+    // dominik: there were only whitespace changes, so that the diff returned by
+    // diff(1) has 0 bytes. So slotPRead() is never called, as there is
+    // no data, so that m_tmpfile was never created and thus is NULL.
+    // NOTE: would be nice, if we could produce a fake-diff, so that kompare
+    //       tells us "The files are identical". Right now, we get an ugly
+    //       "Could not parse diff output".
+    m_tmpfile = new KTempFile();
+  }
   m_tmpfile->close();
 
   if ( ! p->normalExit() /*|| p->exitStatus()*/ )
--- kdelibs-3.5.2/kate/part/katedocument.cpp	2006-01-19 12:06:22.000000000 -0500
+++ kdelibs-3.5.2-new/kate/part/katedocument.cpp	2006-04-14 15:43:07.000000000 -0400
@@ -699,6 +699,10 @@
 
   bool replacetabs = ( config()->configFlags() & KateDocumentConfig::cfReplaceTabsDyn && ! m_isInUndo );
   uint tw = config()->tabWidth();
+  uint insertPosExpanded = insertPos;
+  KateTextLine::Ptr l = m_buffer->line( line );
+  if (l != 0)
+    insertPosExpanded = l->cursorX( insertPos, tw );
 
   for (uint pos = 0; pos < len; pos++)
   {
@@ -706,28 +710,30 @@
 
     if (ch == '\n')
     {
+      editInsertText (line, insertPos, buf);
+
       if ( !blockwise )
       {
-        editInsertText (line, insertPos, buf);
         editWrapLine (line, insertPos + buf.length());
+        insertPos = insertPosExpanded = 0;
       }
       else
       {
-        editInsertText (line, col, buf);
-
         if ( line == lastLine() )
-          editWrapLine (line, col + buf.length());
+          editWrapLine (line, insertPos + buf.length());
       }
 
       line++;
-      insertPos = 0;
       buf.truncate(0);
+      l = m_buffer->line( line );
+      if (l)
+        insertPosExpanded = l->cursorX( insertPos, tw );
     }
     else
     {
       if ( replacetabs && ch == '\t' )
       {
-        uint tr = tw - ( ((blockwise?col:insertPos)+buf.length())%tw ); //###
+        uint tr = tw - ( insertPosExpanded+buf.length() )%tw;
         for ( uint i=0; i < tr; i++ )
           buf += ' ';
       }
@@ -736,10 +742,7 @@
     }
   }
 
-  if ( !blockwise )
-    editInsertText (line, insertPos, buf);
-  else
-    editInsertText (line, col, buf);
+  editInsertText (line, insertPos, buf);
 
   editEnd ();
   emit textInserted(line,insertPos);
@@ -3097,29 +3100,7 @@
       if (pos < 0 || pos >= (int)colX)
       {
         // only spaces on left side of cursor
-        // search a line with less spaces
-        int y = line;
-        while (--y >= 0)
-        {
-          // this is save, y <= line, and line was already success
-          textLine = m_buffer->plainLine(y);
-
-          pos = textLine->firstChar();
-
-          if (pos >= 0)
-          {
-            pos = textLine->cursorX(pos, config()->tabWidth());
-            if (pos < (int)colX)
-            {
-              replaceWithOptimizedSpace(line, col, pos, config()->configFlags());
-              break;
-            }
-          }
-        }
-        if (y < 0) {
-          // FIXME: what shoud we do in this case?
-          removeText(line, 0, line, col+complement);
-        }
+        indent( view, line, -1);
       }
       else
         removeText(line, col-1, line, col+complement);
--- kdelibs-3.5.2/kdecore/Makefile.am	2005-10-10 11:06:02.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/Makefile.am	2006-04-14 15:42:56.000000000 -0400
@@ -24,7 +24,7 @@
 
 if include_SVGICONS
 SVGICONS=svgicons
-SVGICON_LIB=svgicons/libkdesvgicons.la
+SVGICON_LIB=svgicons/libkdesvgicons.la $(LIBZ)
 endif
 
 SUBDIRS = malloc network $(SVGICONS) . kconfig_compiler tests
@@ -116,7 +116,7 @@
 	kqiodevicegzip_p.cpp ktimezones.cpp
 
 libkdecore_la_LDFLAGS = $(QT_LDFLAGS) $(KDE_RPATH) $(KDE_MT_LDFLAGS) $(X_LDFLAGS) $(USER_LDFLAGS) -version-info 6:0:2 -no-undefined
-libkdecore_la_LIBADD = malloc/libklmalloc.la network/libkdecorenetwork.la $(SVGICON_LIB) ../dcop/libDCOP.la ../libltdl/libltdlc.la $(LIB_XEXT) $(LIBRESOLV) $(LIBUTIL) $(LIBART_LIBS) $(LIB_IDN) ../kdefx/libkdefx.la
+libkdecore_la_LIBADD = malloc/libklmalloc.la network/libkdecorenetwork.la $(SVGICON_LIB) ../dcop/libDCOP.la ../libltdl/libltdlc.la $(LIB_XEXT) $(LIBRESOLV) $(LIBUTIL) $(LIBART_LIBS) $(LIB_IDN) ../kdefx/libkdefx.la $(LIBZ)
 libkdecore_la_NMCHECK = $(srcdir)/libkdecore.nmcheck
 libkdecore_la_NMCHECKWEAK = $(srcdir)/libkdecore_weak.nmcheck $(srcdir)/libqt-mt_weak.nmcheck \
 	$(top_srcdir)/dcop/libDCOP_weak.nmcheck $(top_srcdir)/kdecore/standard_weak.nmcheck
--- kdelibs-3.5.2/kdecore/kapplication.cpp	2006-03-17 05:19:05.000000000 -0500
+++ kdelibs-3.5.2-new/kdecore/kapplication.cpp	2006-04-14 15:43:14.000000000 -0400
@@ -960,14 +960,13 @@
 static int my_system (const char *command) {
    int pid, status;
 
-   QApplication::flushX();
    pid = fork();
    if (pid == -1)
       return -1;
    if (pid == 0) {
       const char* shell = "/bin/sh";
       execl(shell, shell, "-c", command, (void *)0);
-      ::exit(127);
+      ::_exit(127);
    }
    do {
       if (waitpid(pid, &status, 0) == -1) {
@@ -1684,7 +1683,7 @@
                     && _event->xclient.data.l[ 3 ] != 0 )
                     {
                     if( qt_x_user_time == 0
-                        || ( _event->xclient.data.l[ 3 ] - qt_x_user_time ) < 100000U )
+                        || NET::timestampCompare( _event->xclient.data.l[ 3 ], qt_x_user_time ) > 0 )
                         { // and the timestamp looks reasonable
                         qt_x_user_time = _event->xclient.data.l[ 3 ]; // update our qt_x_user_time from it
                         }
@@ -1692,7 +1691,7 @@
                 else // normal DND, only needed until Qt updates qt_x_user_time from XdndDrop
                     {
                     if( qt_x_user_time == 0
-                        || ( _event->xclient.data.l[ 2 ] - qt_x_user_time ) < 100000U )
+                        || NET::timestampCompare( _event->xclient.data.l[ 2 ], qt_x_user_time ) > 0 )
                         { // the timestamp looks reasonable
                         qt_x_user_time = _event->xclient.data.l[ 2 ]; // update our qt_x_user_time from it
                         }
@@ -1812,7 +1811,7 @@
         XDestroyWindow( qt_xdisplay(), w );
     }
     if( qt_x_user_time == 0
-        || time - qt_x_user_time < 1000000000U ) // check time > qt_x_user_time, handle wrapping
+        || NET::timestampCompare( time, qt_x_user_time ) > 0 ) // check time > qt_x_user_time
         qt_x_user_time = time;
 #endif
 }
--- kdelibs-3.5.2/kdecore/kcrash.cpp	2006-01-19 12:06:18.000000000 -0500
+++ kdelibs-3.5.2-new/kdecore/kcrash.cpp	2006-04-14 15:43:14.000000000 -0400
@@ -479,6 +479,7 @@
   if (strlen(sock_file)+strlen(display)+strlen("/kdeinit_")+2 > MAX_SOCK_FILE)
   {
      fprintf(stderr, "Warning: Socket name will be too long.\n");
+     free(display);
      return -1;
   }
   strcat(sock_file, "/kdeinit_");
--- kdelibs-3.5.2/kdecore/kglobalaccel_x11.cpp	2005-10-10 11:06:03.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/kglobalaccel_x11.cpp	2006-04-14 15:43:13.000000000 -0400
@@ -212,7 +212,7 @@
 		if( failed ) {
 			kdDebug(125) << "grab failed!\n";
 			for( uint m = 0; m <= 0xff; m++ ) {
-				if( m & keyModMaskX == 0 )
+				if(( m & keyModMaskX ) == 0 )
 					XUngrabKey( qt_xdisplay(), keyCodeX, keyModX | m, qt_xrootwin() );
 				}
                 }
--- kdelibs-3.5.2/kdecore/kglobalsettings.cpp	2005-10-10 11:06:03.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/kglobalsettings.cpp	2006-04-14 15:42:56.000000000 -0400
@@ -491,7 +491,7 @@
       s_desktopPath->append('/');
 
     // Trash Path - TODO remove in KDE4 (kio_trash can't use it for interoperability reasons)
-    *s_trashPath = *s_desktopPath + i18n("Trash") + "/";
+    *s_trashPath = *s_desktopPath + "." + i18n("Trash") + "/";
     *s_trashPath = g.readPathEntry( "Trash" , *s_trashPath);
     *s_trashPath = QDir::cleanDirPath( *s_trashPath );
     if ( !s_trashPath->endsWith("/") )
--- kdelibs-3.5.2/kdecore/kmountpoint.cpp	2005-10-10 11:06:02.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/kmountpoint.cpp	2006-04-14 15:43:13.000000000 -0400
@@ -226,7 +226,11 @@
 
 #ifdef HAVE_GETMNTINFO
 
+#ifdef GETMNTINFO_USES_STATVFS
+    struct statvfs *mounted;
+#else
     struct statfs *mounted;
+#endif
 
     int num_fs = getmntinfo(&mounted, MNT_NOWAIT);
 
--- kdelibs-3.5.2/kdecore/kprocess.cpp	2006-03-17 05:19:04.000000000 -0500
+++ kdelibs-3.5.2-new/kdecore/kprocess.cpp	2006-04-14 15:43:13.000000000 -0400
@@ -355,8 +355,6 @@
   if (pipe(fd))
      fd[0] = fd[1] = -1; // Pipe failed.. continue
 
-  QApplication::flushX();
-
   // we don't use vfork() because
   // - it has unclear semantics and is not standardized
   // - we do way too much magic in the child
@@ -768,7 +766,7 @@
     d->shell = shell;
   else
 // #ifdef NON_FREE // ... as they ship non-POSIX /bin/sh
-#if !defined(__linux__) && !defined(__FreeBSD__) && !defined(__NetBSD__) && !defined(__OpenBSD__) && !defined(__GNU__)
+#if !defined(__linux__) && !defined(__FreeBSD__) && !defined(__NetBSD__) && !defined(__OpenBSD__) && !defined(__GNU__) && !defined(__DragonFly__)
   // Solaris POSIX ...
   if (!access( "/usr/xpg4/bin/sh", X_OK ))
     d->shell = "/usr/xpg4/bin/sh";
--- kdelibs-3.5.2/kdecore/ksocks.cpp	2005-10-10 11:06:03.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/ksocks.cpp	2006-04-14 15:42:56.000000000 -0400
@@ -480,7 +480,7 @@
                                                    ksocklen_t addrlen) {
    if (_useSocks && F_connect)
       return (*F_connect)(sockfd, serv_addr, addrlen);
-   else return ::connect(sockfd, (sockaddr*) serv_addr, (socklen_t)addrlen);
+   else return ::connect(sockfd, (sockaddr*) serv_addr, (ksocklen_t)addrlen);
 }
 
 
@@ -503,7 +503,7 @@
    if (_useSocks && F_recvfrom) {
       return (*F_recvfrom)(s, buf, len, flags, from, fromlen);
    } else {
-      socklen_t casted_len = (socklen_t) *fromlen;
+      kde_socklen_t casted_len = (kde_socklen_t) *fromlen;
       int rc = ::recvfrom(s, (char*) buf, len, flags, from, &casted_len);
       *fromlen = casted_len;
       return rc;
@@ -515,7 +515,7 @@
                              const sockaddr *to, ksocklen_t tolen) {
    if (_useSocks && F_sendto)
       return (*F_sendto)(s, msg, len, flags, to, tolen);
-   else return ::sendto(s, (char*) msg, len, flags, to, (socklen_t)tolen);
+   else return ::sendto(s, (char*) msg, len, flags, to, (ksocklen_t)tolen);
 }
 
 
@@ -537,7 +537,7 @@
    if (_useSocks && F_getsockname) {
       return (*F_getsockname)(s, name, namelen);
    } else {
-     socklen_t casted_len = *namelen;
+     kde_socklen_t casted_len = *namelen;
      int rc = ::getsockname(s, name, &casted_len);
      *namelen = casted_len;
      return rc;
@@ -549,7 +549,7 @@
    if (_useSocks && F_getpeername) {
       return (*F_getpeername)(s, name, namelen);
    } else {
-      socklen_t casted_len = *namelen;
+      kde_socklen_t casted_len = *namelen;
       int rc = ::getpeername(s, name, &casted_len);
       *namelen = casted_len;
       return rc;
@@ -561,7 +561,7 @@
    if (_useSocks && F_accept) {
      return (*F_accept)(s, addr, addrlen);
    } else {
-      socklen_t casted_len = *addrlen;
+      kde_socklen_t casted_len = *addrlen;
       int rc = ::accept(s, addr, &casted_len);
       *addrlen = casted_len;
       return rc;
@@ -587,13 +587,13 @@
 int KSocks::bind (int sockfd, const sockaddr *my_addr, ksocklen_t addrlen) {
    if (_useSocks && F_bind)
       return (*F_bind)(sockfd, my_addr, addrlen);
-   else return ::bind(sockfd, my_addr, (socklen_t)addrlen);
+   else return ::bind(sockfd, my_addr, (ksocklen_t)addrlen);
 }
 
 int KSocks::bind (int sockfd, sockaddr *my_addr, ksocklen_t addrlen) {
    if (_useSocks && F_bind)
       return (*F_bind)(sockfd, my_addr, addrlen);
-   else return ::bind(sockfd, my_addr, (socklen_t)addrlen);
+   else return ::bind(sockfd, my_addr, (ksocklen_t)addrlen);
 }
 
 
--- kdelibs-3.5.2/kdecore/kstandarddirs.cpp	2005-10-10 11:06:02.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/kstandarddirs.cpp	2006-04-14 15:42:56.000000000 -0400
@@ -1020,7 +1020,7 @@
     if (!strcmp(type, "data"))
 	return "share/apps/";
     if (!strcmp(type, "html"))
-	return "share/doc/HTML/";
+	return "share/doc/kde/";
     if (!strcmp(type, "icon"))
 	return "share/icons/";
     if (!strcmp(type, "config"))
--- kdelibs-3.5.2/kdecore/ktempdir.cpp	2006-03-17 05:19:05.000000000 -0500
+++ kdelibs-3.5.2-new/kdecore/ktempdir.cpp	2006-04-14 15:43:13.000000000 -0400
@@ -107,6 +107,8 @@
 {
    if (bAutoDelete)
       unlink();
+
+   delete d;
 }
 
 int
--- kdelibs-3.5.2/kdecore/kwinmodule.cpp	2005-10-10 11:06:03.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/kwinmodule.cpp	2006-04-14 15:43:13.000000000 -0400
@@ -224,7 +224,7 @@
         }
 	if ( (dirty[ NETWinInfo::PROTOCOLS ] & NET::WMStrut) != 0 ) {
             removeStrutWindow( ev->xany.window );
-            if ( !possibleStrutWindows.findIndex( ev->xany.window ) != -1  )
+            if ( possibleStrutWindows.findIndex( ev->xany.window ) == -1 )
         	possibleStrutWindows.append( ev->xany.window );
 	}
 	if ( dirty[ NETWinInfo::PROTOCOLS ] || dirty[ NETWinInfo::PROTOCOLS2 ] ) {
--- kdelibs-3.5.2/kdecore/kxerrorhandler.cpp	2005-09-10 04:27:12.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/kxerrorhandler.cpp	2006-04-14 15:43:14.000000000 -0400
@@ -28,6 +28,7 @@
 #include "kxerrorhandler.h"
 #include <assert.h>
 #include <stdlib.h>
+#include <netwm_def.h>
 
 KXErrorHandler** KXErrorHandler::handlers = NULL;
 int KXErrorHandler::pos = 0;
@@ -101,13 +102,14 @@
 int KXErrorHandler::handle( Display* dpy, XErrorEvent* e )
     {
     if( dpy == display
-        && e->serial - first_request < 1000000000 ) // e->serial > first_request, with wrapping
+        // e->serial >= first_request , compare like X timestamps to handle wrapping
+        && NET::timestampCompare( e->serial, first_request ) >= 0 )
         { // it's for us
         //qDebug( "Handling: %p", static_cast< void* >( this ));
-        if( user_handler1 != NULL )
-            was_error |= user_handler1( e->request_code, e->error_code, e->resourceid );
-        else if( user_handler2 != NULL )
-            was_error |= ( user_handler2( dpy, e ) != 0 );
+        if( user_handler1 != NULL && user_handler1( e->request_code, e->error_code, e->resourceid ))
+            was_error = true;
+        if( user_handler2 != NULL && user_handler2( dpy, e ) != 0 )
+            was_error = true;
         else // no handler set, simply set that there was an error
             was_error = true;
         return 0;
--- kdelibs-3.5.2/kdecore/netsupp.cpp	2005-10-10 11:06:02.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/netsupp.cpp	2006-04-14 15:43:13.000000000 -0400
@@ -352,15 +352,9 @@
   return 0;
 
  out:
-  // Normal exit of the function
-  if (err == 0)
-    *result = res;
-  else
-    {
-      if (res->data != NULL)
-	freeaddrinfo(res->data);
-      free(res);
-    }
+  if (res->data != NULL)
+      freeaddrinfo(res->data);
+  free(res);
   return err;
 }
 
--- kdelibs-3.5.2/kdecore/netwm.cpp	2005-09-10 04:27:12.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/netwm.cpp	2006-04-14 15:43:15.000000000 -0400
@@ -4401,4 +4401,38 @@
 void NETWinInfo::virtual_hook( int, void* )
 { /*BASE::virtual_hook( id, data );*/ }
 
+// Functions for X timestamp comparing. For Time being 32bit they're fairly simple
+// (the #if 0 part), but on 64bit architectures Time is 64bit unsigned long,
+// so there special care needs to be taken to always use only the lower 32bits.
+#if 0
+int NET::timestampCompare( Time time1, Time time2 ) // like strcmp()
+    {
+    if( time1 == time2 )
+        return 0;
+    return ( time1 - time2 ) < 0x7fffffffU ? 1 : -1; // time1 > time2 -> 1, handle wrapping
+    }
+
+Time NET::timestampDiff( Time time1, Time time2 ) // returns time2 - time1
+    { // no need to handle wrapping?
+    return time2 - time1;
+    }
+#else
+int NET::timestampCompare( unsigned long time1_, unsigned long time2_ ) // like strcmp()
+    {
+    Q_UINT32 time1 = time1_;
+    Q_UINT32 time2 = time2_;
+    if( time1 == time2 )
+        return 0;
+    return Q_UINT32( time1 - time2 ) < 0x7fffffffU ? 1 : -1; // time1 > time2 -> 1, handle wrapping
+    }
+
+int NET::timestampDiff( unsigned long time1_, unsigned long time2_ ) // returns time2 - time1
+    { // no need to handle wrapping?
+    Q_UINT32 time1 = time1_;
+    Q_UINT32 time2 = time2_;
+    return Q_UINT32( time2 - time1 );
+    }
+#endif
+
+
 #endif
--- kdelibs-3.5.2/kdecore/netwm_def.h	2006-01-19 12:06:18.000000000 -0500
+++ kdelibs-3.5.2-new/kdecore/netwm_def.h	2006-04-14 15:43:14.000000000 -0400
@@ -606,6 +606,20 @@
         FromApplication,
         FromTool
     };
+    
+    /**
+     Compares two X timestamps, taking into account wrapping and 64bit architectures.
+     Return value is like with strcmp(), 0 for equal, -1 for time1 < time2, 1 for time1 > time2.
+     @since 3.5.3
+    */
+    static int timestampCompare( unsigned long time1, unsigned long time2 );
+    /**
+     Returns a difference of two X timestamps, time2 - time1, where time2 must be later than time1,
+     as returned by timestampCompare().
+     @since 3.5.3
+    */
+    static int timestampDiff( unsigned long time1_, unsigned long time2_ );
+
 };
 
 
--- kdelibs-3.5.2/kdecore/network/kresolver.cpp	2006-03-17 05:19:04.000000000 -0500
+++ kdelibs-3.5.2-new/kdecore/network/kresolver.cpp	2006-04-14 15:43:14.000000000 -0400
@@ -609,7 +609,7 @@
 
 QStrList KResolver::protocolName(int protonum)
 {
-  struct protoent *pe;
+  struct protoent *pe = 0L;
 #ifndef HAVE_GETPROTOBYNAME_R
   QMutexLocker locker(&getXXbyYYmutex);
 
@@ -628,6 +628,7 @@
       if (getprotobynumber_r(protonum, &protobuf, buf, buflen, &pe) == ERANGE)
 # endif
 	{
+          pe = 0L;
 	  buflen += 1024;
 	  delete [] buf;
 	}
@@ -655,7 +656,7 @@
 
 QStrList KResolver::protocolName(const char *protoname)
 {
-  struct protoent *pe;
+  struct protoent *pe = 0L;
 #ifndef HAVE_GETPROTOBYNAME_R
   QMutexLocker locker(&getXXbyYYmutex);
 
@@ -674,6 +675,7 @@
       if (getprotobyname_r(protoname, &protobuf, buf, buflen, &pe) == ERANGE)
 # endif
 	{
+          pe = 0L;
 	  buflen += 1024;
 	  delete [] buf;
 	}
@@ -701,7 +703,7 @@
 
 int KResolver::protocolNumber(const char *protoname)
 {
-  struct protoent *pe;
+  struct protoent *pe = 0L;
 #ifndef HAVE_GETPROTOBYNAME_R
   QMutexLocker locker(&getXXbyYYmutex);
 
@@ -720,6 +722,7 @@
       if (getprotobyname_r(protoname, &protobuf, buf, buflen, &pe) == ERANGE)
 # endif
 	{
+          pe = 0L;
 	  buflen += 1024;
 	  delete [] buf;
 	}
@@ -743,7 +746,7 @@
 
 int KResolver::servicePort(const char *servname, const char *protoname)
 {
-  struct servent *se;
+  struct servent *se = 0L;
 #ifndef HAVE_GETSERVBYNAME_R
   QMutexLocker locker(&getXXbyYYmutex);
 
@@ -762,6 +765,7 @@
       if (getservbyname_r(servname, protoname, &servbuf, buf, buflen, &se) == ERANGE)
 # endif
 	{
+          se = 0L;
 	  buflen += 1024;
 	  delete [] buf;
 	}
@@ -785,7 +789,7 @@
 
 QStrList KResolver::serviceName(const char* servname, const char *protoname)
 {
-  struct servent *se;
+  struct servent *se = 0L;
 #ifndef HAVE_GETSERVBYNAME_R
   QMutexLocker locker(&getXXbyYYmutex);
 
@@ -804,6 +808,7 @@
       if (getservbyname_r(servname, protoname, &servbuf, buf, buflen, &se) == ERANGE)
 # endif
 	{
+          se = 0L;
 	  buflen += 1024;
 	  delete [] buf;
 	}
@@ -831,7 +836,7 @@
 
 QStrList KResolver::serviceName(int port, const char *protoname)
 {
-  struct servent *se;
+  struct servent *se = 0L;
 #ifndef HAVE_GETSERVBYPORT_R
   QMutexLocker locker(&getXXbyYYmutex);
 
@@ -850,6 +855,7 @@
       if (getservbyport_r(port, protoname, &servbuf, buf, buflen, &se) == ERANGE)
 # endif
 	{
+          se = 0L;
 	  buflen += 1024;
 	  delete [] buf;
 	}
--- kdelibs-3.5.2/kdecore/network/kresolvermanager.cpp	2005-09-10 04:27:10.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/network/kresolvermanager.cpp	2006-04-14 15:42:56.000000000 -0400
@@ -31,6 +31,7 @@
 
 #ifdef HAVE_RES_INIT
 # include <sys/stat.h>
+# include <nameser.h>
 extern "C" {
 #   include <arpa/nameser.h>
 }
--- kdelibs-3.5.2/kdecore/network/ksocketdevice.cpp	2006-01-19 12:06:14.000000000 -0500
+++ kdelibs-3.5.2-new/kdecore/network/ksocketdevice.cpp	2006-04-14 15:42:56.000000000 -0400
@@ -316,7 +316,7 @@
     }
 
   struct sockaddr sa;
-  socklen_t len = sizeof(sa);
+  kde_socklen_t len = sizeof(sa);
   int newfd = kde_accept(m_sockfd, &sa, &len);
   if (newfd == -1)
     {
@@ -390,7 +390,7 @@
 
 static int do_read_common(int sockfd, char *data, Q_ULONG maxlen, KSocketAddress* from, ssize_t &retval, bool peek = false)
 {
-  socklen_t len;
+  kde_socklen_t len;
   if (from)
     {
       from->setLength(len = 128); // arbitrary length
@@ -535,7 +535,7 @@
   if (d->local.family() != AF_UNSPEC)
     return d->local;
 
-  socklen_t len;
+  kde_socklen_t len;
   KSocketAddress localAddress;
   localAddress.setLength(len = 32);	// arbitrary value
   if (kde_getsockname(m_sockfd, localAddress.address(), &len) == -1)
@@ -567,7 +567,7 @@
   if (d->peer.family() != AF_UNSPEC)
     return d->peer;
 
-  socklen_t len;
+  kde_socklen_t len;
   KSocketAddress peerAddress;
   peerAddress.setLength(len = 32);	// arbitrary value
   if (kde_getpeername(m_sockfd, peerAddress.address(), &len) == -1)
--- kdelibs-3.5.2/kdecore/network/syssocket.h	2005-09-10 04:27:10.000000000 -0400
+++ kdelibs-3.5.2-new/kdecore/network/syssocket.h	2006-04-14 15:42:56.000000000 -0400
@@ -53,7 +53,7 @@
   }
 
   // bind
-  inline int kde_bind(int fd, const struct sockaddr* sa, socklen_t len)
+  inline int kde_bind(int fd, const struct sockaddr* sa, kde_socklen_t len)
   {
     return ::bind(fd, sa, len);
   }
@@ -65,25 +65,25 @@
   }
 
   // connect
-  inline int kde_connect(int fd, const struct sockaddr* sa, socklen_t len)
+  inline int kde_connect(int fd, const struct sockaddr* sa, kde_socklen_t len)
   {
     return ::connect(fd, (struct sockaddr*)sa, len);
   }
 
   // accept
-  inline int kde_accept(int fd, struct sockaddr* sa, socklen_t* len)
+  inline int kde_accept(int fd, struct sockaddr* sa, kde_socklen_t* len)
   {
     return ::accept(fd, sa, len);
   }
 
   // getpeername
-  inline int kde_getpeername(int fd, struct sockaddr* sa, socklen_t* len)
+  inline int kde_getpeername(int fd, struct sockaddr* sa, kde_socklen_t* len)
   {
     return ::getpeername(fd, sa, len);
   }
 
   // getsockname
-  inline int kde_getsockname(int fd, struct sockaddr* sa, socklen_t* len)
+  inline int kde_getsockname(int fd, struct sockaddr* sa, kde_socklen_t* len)
   {
     return ::getsockname(fd, sa, len);
   }
--- kdelibs-3.5.2/kded/Makefile.am	2005-10-10 11:06:29.000000000 -0400
+++ kdelibs-3.5.2-new/kded/Makefile.am	2006-04-14 15:42:56.000000000 -0400
@@ -58,7 +58,10 @@
 servicetype_DATA = kdedmodule.desktop
 servicetypedir = $(kde_servicetypesdir)
 
-xdg_menu_DATA = applications.menu
+kde-applications.menu: applications.menu
+	cat applications.menu > kde-applications.menu
+
+xdg_menu_DATA = kde-applications.menu
 
 update_DATA = kded.upd
 updatedir = $(kde_datadir)/kconf_update
--- kdelibs-3.5.2/kded/kbuildsycoca.cpp	2005-11-08 17:39:36.000000000 -0500
+++ kdelibs-3.5.2-new/kded/kbuildsycoca.cpp	2006-04-14 15:42:57.000000000 -0400
@@ -379,7 +379,11 @@
      connect(g_vfolder, SIGNAL(newService(const QString &, KService **)),
              this, SLOT(slotCreateEntry(const QString &, KService **)));
              
-     VFolderMenu::SubMenu *kdeMenu = g_vfolder->parseMenu("applications.menu", true);
+     VFolderMenu::SubMenu *kdeMenu;
+     if ( QFile::exists( "@FINKPREFIX@/etc/xdg/menus/kde-applications.menu" ) )
+       kdeMenu = g_vfolder->parseMenu("kde-applications.menu", true);
+     else
+       kdeMenu = g_vfolder->parseMenu("applications.menu", true);
 
      KServiceGroup *entry = g_bsgf->addNew("/", kdeMenu->directoryFile, 0, false);
      entry->setLayoutInfo(kdeMenu->layoutList);
--- kdelibs-3.5.2/kded/khostname.cpp	2006-03-17 05:19:19.000000000 -0500
+++ kdelibs-3.5.2-new/kded/khostname.cpp	2006-04-14 15:43:19.000000000 -0400
@@ -155,6 +155,10 @@
          continue;
 
       QCString newNetId = newName+netId.mid(i);
+      QCString oldNetId = netId.left(i);
+
+      if(oldNetId != oldName)
+         continue;
 
       cmd = "xauth remove "+KProcess::quote(netId);
       system(QFile::encodeName(cmd));
--- kdelibs-3.5.2/kdefx/kimageeffect.cpp	2006-01-19 12:06:23.000000000 -0500
+++ kdelibs-3.5.2-new/kdefx/kimageeffect.cpp	2006-04-14 15:43:08.000000000 -0400
@@ -3666,7 +3666,8 @@
                     }
                 }
             }
-            *q++ = (*s);
+            if (s)
+                *q++ = (*s);
         }
     }
     /* liberateMemory((histogram); */
--- kdelibs-3.5.2/kdefx/kpixmap.cpp	2005-10-10 11:05:27.000000000 -0400
+++ kdelibs-3.5.2-new/kdefx/kpixmap.cpp	2006-04-14 15:43:08.000000000 -0400
@@ -43,33 +43,7 @@
 	return false;
     }
 
-    int ncols = 256;
-
-    static uint bm[16][16];
-    static int init=0;
-    if (!init) {
-
-	// Build a Bayer Matrix for dithering
-	init = 1;
-	int n, i, j;
-
-	bm[0][0]=0;
-
-	for (n=1; n<16; n*=2)
-	    for (i=0; i<n; i++)
-		for (j=0; j<n; j++) {
-		    bm[i][j]*=4;
-		    bm[i+n][j]=bm[i][j]+2;
-		    bm[i][j+n]=bm[i][j]+3;
-		    bm[i+n][j+n]=bm[i][j]+1;
-		}
-
-	for (i=0; i<16; i++)
-	    for (j=0; j<16; j++)
-		bm[i][j]<<=8;
-    }
-
-    dst->setNumColors( ncols );
+    dst->setNumColors( 256 );
 
 #define MAX_R 2
 #define MAX_G 2
--- kdelibs-3.5.2/kdeprint/configure.in.in	2005-09-10 04:27:43.000000000 -0400
+++ kdelibs-3.5.2-new/kdeprint/configure.in.in	2006-04-14 15:42:57.000000000 -0400
@@ -80,7 +80,7 @@
 
       dnl check if CUPS is at least 1.1.20
       ac_have_new_cups="no"
-      AC_CHECK_CUPS_VERSION(1.0120)
+      AC_CHECK_CUPS_VERSION(1.0121)
       if test "$ac_have_new_cups" = "yes"; then
  	AC_DEFINE(HAVE_CUPS_NO_PWD_CACHE, 1, CUPS doesn't have password caching)
       fi
--- kdelibs-3.5.2/kdeprint/cups/ipprequest.cpp	2005-10-10 11:06:30.000000000 -0400
+++ kdelibs-3.5.2-new/kdeprint/cups/ipprequest.cpp	2006-04-14 15:43:19.000000000 -0400
@@ -510,17 +510,8 @@
 		cupsEncodeOptions(request_, n, options);
 	cupsFreeOptions(n, options);
 
-	// find an remove that annoying "document-format" attribute
-	ipp_attribute_t	*attr = request_->attrs;
-	while (attr)
-	{
-		if (attr->next && strcmp(attr->next->name, "document-format") == 0)
-		{
-			ipp_attribute_t	*attr2 = attr->next;
-			attr->next = attr2->next;
-			_ipp_free_attr(attr2);
-			break;
-		}
-		attr = attr->next;
-	}
+	// find and remove that annoying "document-format" attribute
+        ipp_attribute_t *attr = ippFindAttribute(request_, "document-format", IPP_TAG_NAME);
+        ippDeleteAttribute(request_, attr);
+
 }
--- kdelibs-3.5.2/kdeprint/kfilelist.cpp	2005-10-10 11:06:34.000000000 -0400
+++ kdelibs-3.5.2-new/kdeprint/kfilelist.cpp	2006-04-14 15:43:19.000000000 -0400
@@ -243,9 +243,9 @@
 
 void KFileList::slotAddFile()
 {
-	KURL	fname = KFileDialog::getOpenURL(QString::null, QString::null, this);
-	if (!fname.isEmpty())
-		addFiles(KURL::List(fname));
+	KURL::List fnames = KFileDialog::getOpenURLs(QString::null, QString::null, this);
+	if (!fnames.empty())
+		addFiles(fnames);
 }
 
 void KFileList::slotRemoveFile()
--- kdelibs-3.5.2/kdesu/kdesu_stub.c	2005-11-08 17:39:20.000000000 -0500
+++ kdelibs-3.5.2-new/kdesu/kdesu_stub.c	2006-04-14 15:43:13.000000000 -0400
@@ -192,6 +192,7 @@
     pid_t pid;
     FILE *fout;
     struct passwd *pw;
+    const char* kdesu_lc_all;
 
     /* Get startup parameters. */
 
@@ -236,6 +237,12 @@
     xsetenv("PATH", params[P_PATH].value);
     xsetenv("DESKTOP_STARTUP_ID", params[P_APP_STARTUP_ID].value);
 
+    kdesu_lc_all = getenv( "KDESU_LC_ALL" );
+    if( kdesu_lc_all != NULL )
+        xsetenv("LC_ALL",kdesu_lc_all);
+    else
+        xsetenv("LC_ALL","");
+
     /* Do we need to change uid? */
 
     pw = getpwnam(params[P_USER].value);
--- kdelibs-3.5.2/kdesu/process.cpp	2005-09-10 04:27:02.000000000 -0400
+++ kdelibs-3.5.2-new/kdesu/process.cpp	2006-04-14 15:43:13.000000000 -0400
@@ -296,6 +296,14 @@
         putenv((*it).data());
     }
     unsetenv("KDE_FULL_SESSION");
+    
+    // set temporarily LC_ALL to C, for su (to be able to parse "Password:")
+    const char* old_lc_all = getenv( "LC_ALL" );
+    if( old_lc_all != NULL )
+        setenv( "KDESU_LC_ALL", old_lc_all, 1 );
+    else
+        unsetenv( "KDESU_LC_ALL" );
+    setenv("LC_ALL", "C", 1);
 
     // From now on, terminal output goes through the tty.
 
--- kdelibs-3.5.2/kdesu/su.cpp	2005-09-10 04:27:02.000000000 -0400
+++ kdelibs-3.5.2-new/kdesu/su.cpp	2006-04-14 15:42:57.000000000 -0400
@@ -75,6 +75,8 @@
 
     QCStringList args;
 
+    args += "-c";
+    args += "staff";
     if ((m_Scheduler != SchedNormal) || (m_Priority > 50))
         args += "root";
     else
@@ -82,7 +84,6 @@
     
     args += "-c";
     args += QCString(__KDE_BINDIR) + "/kdesu_stub";
-    args += "-";
 
     QCString command = __PATH_SU;
     if (::access(__PATH_SU, X_OK) != 0)
--- kdelibs-3.5.2/kdeui/Makefile.am	2005-10-10 11:06:38.000000000 -0400
+++ kdelibs-3.5.2-new/kdeui/Makefile.am	2006-04-14 15:42:57.000000000 -0400
@@ -27,10 +27,10 @@
 AM_LDFLAGS = $(LDFLAGS_AS_NEEDED) $(LDFLAGS_NEW_DTAGS)
 
 lib_LTLIBRARIES = libkdeui.la libkspell.la
-libkdeui_la_LDFLAGS = $(KDE_MT_LDFLAGS) -no-undefined -version-info 6:0:2
+libkdeui_la_LDFLAGS = $(KDE_MT_LDFLAGS) $(all_libraries) -no-undefined -version-info 6:0:2
 libkdeui_la_LIBADD = ../kdecore/libkdecore.la
 
-libkspell_la_LDFLAGS = $(KDE_MT_LDFLAGS) -version-info 6:0:2 -no-undefined
+libkspell_la_LDFLAGS = $(KDE_MT_LDFLAGS) $(all_libraries) -version-info 6:0:2 -no-undefined
 libkspell_la_LIBADD = libkdeui.la
 libkspell_la_SOURCES = dummy.cpp
 
--- kdelibs-3.5.2/kdeui/kcmodule.cpp	2005-10-10 11:06:38.000000000 -0400
+++ kdelibs-3.5.2-new/kdeui/kcmodule.cpp	2006-04-14 15:43:20.000000000 -0400
@@ -79,7 +79,12 @@
 {
     init();
     d->_instance = instance;
-    KGlobal::locale()->insertCatalogue(instance->instanceName());
+
+    if (instance)
+    {
+        KGlobal::locale()->insertCatalogue(instance->instanceName());
+    }
+
     d->_hasOwnInstance = false;
     KGlobal::setActiveInstance(this->instance());
 }
--- kdelibs-3.5.2/kdeui/kcolordialog.cpp	2006-03-17 05:19:20.000000000 -0500
+++ kdelibs-3.5.2-new/kdeui/kcolordialog.cpp	2006-04-14 15:43:20.000000000 -0400
@@ -242,7 +242,7 @@
 		p = (uint *) image.scanLine( ySize - s - 1 );
 		for( h = 0; h < xSize; h++ )
 		{
-			col.setHsv( 359*h/(xSize-1), 255*s/(ySize-1), 192 );
+			col.setHsv( 359*h/(xSize-1), 255*s/((ySize == 1) ? 1 : ySize-1), 192 );
 			*p = col.rgb();
 			p++;
 		}
@@ -305,7 +305,7 @@
 
 			for( int x = 0; x < xSize; x++ )
 			{
-				col.setHsv( _hue, _sat, 255*x/(xSize-1) );
+				col.setHsv( _hue, _sat, 255*x/((xSize == 1) ? 1 : xSize-1) );
 				rgb = col.rgb();
 				*p++ = rgb;
 			}
@@ -317,7 +317,7 @@
 		for ( int v = 0; v < ySize; v++ )
 		{
 			p = (uint *) image.scanLine( ySize - v - 1 );
-			col.setHsv( _hue, _sat, 255*v/(ySize-1) );
+			col.setHsv( _hue, _sat, 255*v/((ySize == 1) ? 1 : ySize-1) );
 			rgb = col.rgb();
 			for ( int i = 0; i < xSize; i++ )
 				*p++ = rgb;
@@ -426,7 +426,7 @@
 
 void KColorCells::mouseMoveEvent( QMouseEvent *e )
 {
-    if( !(e->state() && LeftButton)) return;
+    if( !(e->state() & LeftButton)) return;
 
     if(inMouse) {
         int delay = KGlobalSettings::dndEventDelay();
@@ -530,7 +530,7 @@
 void KColorPatch::mouseMoveEvent( QMouseEvent *e )
 {
         // Drag color object
-        if( !(e->state() && LeftButton)) return;
+        if( !(e->state() & LeftButton)) return;
 	KColorDrag *d = new KColorDrag( color, this);
 	d->dragCopy();
 }
@@ -1253,30 +1253,26 @@
 void
 KColorDialog::readSettings()
 {
-  KConfig* config = KGlobal::config();
+  KConfigGroup group( KGlobal::config(), "Colors" );
 
-  QString oldgroup = config->group();
-
-  config->setGroup("Colors");
-  QString palette = config->readEntry("CurrentPalette");
+  QString palette = group.readEntry("CurrentPalette");
   d->table->setPalette(palette);
-  config->setGroup( oldgroup );
 }
 
 void
 KColorDialog::slotWriteSettings()
 {
-  KConfig* config = KGlobal::config();
-  config->setGroup("Colors");
+  KConfigGroup group( KGlobal::config(), "Colors" );
+
   QString palette = d->table->palette();
-  if (!config->hasDefault("CurrentPalette") &&
+  if (!group.hasDefault("CurrentPalette") &&
       (d->table->palette() == d->originalPalette))
   {
-     config->revertToDefault("CurrentPalette");
+     group.revertToDefault("CurrentPalette");
   }
   else
   {
-     config->writeEntry("CurrentPalette", d->table->palette());
+     group.writeEntry("CurrentPalette", d->table->palette());
   }
 }
 
--- kdelibs-3.5.2/kdeui/kdialogbase.cpp	2005-10-10 11:06:38.000000000 -0400
+++ kdelibs-3.5.2-new/kdeui/kdialogbase.cpp	2006-04-14 15:43:20.000000000 -0400
@@ -668,7 +668,7 @@
     return;
   }
 
-  if( style < 0 || style > ActionStyleMAX ) { style = ActionStyle0; }
+  if( style < 0 || style >= ActionStyleMAX ) { style = ActionStyle0; }
   d->mButton.style = style;
 
   const int *layout;
--- kdelibs-3.5.2/kdeui/kdockwidget.cpp	2005-10-10 11:06:38.000000000 -0400
+++ kdelibs-3.5.2-new/kdeui/kdockwidget.cpp	2006-04-14 15:43:21.000000000 -0400
@@ -762,9 +762,11 @@
 void KDockWidget::setEnableDocking( int pos )
 {
   eDocking = pos;
-  if( header && header->inherits( "KDockWidgetHeader" ) )
-     ( ( KDockWidgetHeader* ) header )->showUndockButton( pos & DockDesktop );
-  updateHeader();
+  if( header ) {
+     if (header->inherits( "KDockWidgetHeader" ) )
+         ( ( KDockWidgetHeader* ) header )->showUndockButton( pos & DockDesktop );
+    updateHeader();
+  }
 }
 
 void KDockWidget::updateHeader()
--- kdelibs-3.5.2/kdeui/klistviewsearchline.h	2005-10-10 11:06:38.000000000 -0400
+++ kdelibs-3.5.2-new/kdeui/klistviewsearchline.h	2006-04-14 15:43:21.000000000 -0400
@@ -33,6 +33,11 @@
  * No changes to the application other than instantiating this class with an
  * appropriate KListView should be needed.
  *
+ * @note { When iterating over items in the KListView, make sure that
+ * the iterator only includes visible items (for example, by adding
+ * QListViewItemIterator::Visible to the iterator flags). Otherwise,
+ * actions (such as deletion) may be taken on items that have been
+ * hidden by the search function. } 
  * @since 3.3
  */
 
--- kdelibs-3.5.2/kdeui/kmessagebox.cpp	2005-10-10 11:06:38.000000000 -0400
+++ kdelibs-3.5.2-new/kdeui/kmessagebox.cpp	2006-04-14 15:43:21.000000000 -0400
@@ -82,7 +82,7 @@
         break;
     }
 
-   QPixmap ret = KApplication::kApplication()->iconLoader()->loadIcon(icon_name, KIcon::NoGroup, KIcon::SizeMedium, KIcon::DefaultState, 0, true);
+   QPixmap ret = KGlobal::iconLoader()->loadIcon(icon_name, KIcon::NoGroup, KIcon::SizeMedium, KIcon::DefaultState, 0, true);
 
    if (ret.isNull())
        return QMessageBox::standardIcon(icon);
--- kdelibs-3.5.2/kdeui/kprogress.cpp	2005-10-10 11:06:38.000000000 -0400
+++ kdelibs-3.5.2-new/kdeui/kprogress.cpp	2006-04-14 15:43:21.000000000 -0400
@@ -216,7 +216,6 @@
 
     show();
     kapp->processEvents();
-    mShown = true;
 }
 
 void KProgressDialog::slotCancel()
@@ -394,6 +393,13 @@
     }
 }
 
+void KProgressDialog::show()
+{
+    KDialogBase::show();
+    mShown = true;
+}
+
+
 void KProgress::virtual_hook( int, void* )
 { /*BASE::virtual_hook( id, data );*/ }
 
--- kdelibs-3.5.2/kdeui/kprogress.h	2005-10-10 11:06:39.000000000 -0400
+++ kdelibs-3.5.2-new/kdeui/kprogress.h	2006-04-14 15:43:21.000000000 -0400
@@ -361,6 +361,11 @@
          */
         int  minimumDuration() const;
 
+ 	/**
+	 * Reimplemented for internal reasons, the API is not affected.
+	 */
+        virtual void show();
+
     protected slots:
         void slotAutoShow();
         void slotAutoActions(int percentage);
--- kdelibs-3.5.2/khtml/css/css_stylesheetimpl.cpp	2005-10-10 11:06:13.000000000 -0400
+++ kdelibs-3.5.2-new/khtml/css/css_stylesheetimpl.cpp	2006-04-14 15:43:17.000000000 -0400
@@ -216,10 +216,13 @@
 
     m_namespaces = new CSSNamespace(prefix, uri, m_namespaces);
 
-    if (prefix.isEmpty())
+    if (prefix.isEmpty()) {
+        Q_ASSERT(m_doc != 0);
+
         // Set the default namespace on the parser so that selectors that omit namespace info will
         // be able to pick it up easily.
         p->defaultNamespace = m_doc->getId(NodeImpl::NamespaceId, uri.implementation(), false, false, &exceptioncode);
+    }
 }
 
 void CSSStyleSheetImpl::determineNamespace(Q_UINT32& id, const DOM::DOMString& prefix)
@@ -230,15 +233,18 @@
         return;
 
     if (prefix.isEmpty())
-         id = makeId(noNamespace, localNamePart(id)); // No namespace. If an element/attribute has a namespace, e won't match it.
+         id = makeId(emptyNamespace, localNamePart(id)); // No namespace. If an element/attribute has a namespace, we won't match it.
     else if (prefix == "*")
         id = makeId(anyNamespace, localNamePart(id)); // We'll match any namespace.
     else {
         int exceptioncode = 0;
         CSSNamespace* ns = m_namespaces->namespaceForPrefix(prefix);
-        if (ns)
+        if (ns) {
+            Q_ASSERT(m_doc != 0);
+
             // Look up the id for this namespace URI.
             id = makeId(m_doc->getId(NodeImpl::NamespaceId, ns->uri().implementation(), false, false, &exceptioncode), localNamePart(id));
+        }
     }
 }
 
--- kdelibs-3.5.2/khtml/css/cssparser.cpp	2006-01-19 12:06:54.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/css/cssparser.cpp	2006-04-14 15:43:17.000000000 -0400
@@ -490,7 +490,8 @@
             }
             if (is_valid)
                 parsedValue = quotes;
-            //valueList->next();
+            else
+                delete quotes;
         }
         break;
 
@@ -2094,6 +2095,8 @@
             blur = val;
             allowBlur = false;
         }
+	else
+	    delete val;
     }
 
     void commitColor(CSSPrimitiveValueImpl* val) {
@@ -2147,19 +2150,18 @@
             CSSPrimitiveValueImpl* parsedColor = 0;
             bool isColor = (val->id >= CSS_VAL_AQUA && val->id <= CSS_VAL_WINDOWTEXT || val->id == CSS_VAL_MENU ||
                            (val->id >= CSS_VAL_GREY && val->id <= CSS_VAL__KHTML_TEXT && !strict));
-            if (isColor) {
-                if (!context.allowColor)
-                    return context.failed();
-                parsedColor = new CSSPrimitiveValueImpl(val->id);
-            }
+	    if (!context.allowColor)
+                return context.failed();
+ 
+            if (isColor)
+               parsedColor = new CSSPrimitiveValueImpl(val->id);
 
             if (!parsedColor)
                 // It's not built-in. Try to parse it as a color.
                 parsedColor = parseColorFromValue(val);
 
-            if (!parsedColor || !context.allowColor)
-                return context.failed(); // This value is not a color or length and is invalid or
-                                         // it is a color, but a color isn't allowed at this point.
+            if (!parsedColor)
+                return context.failed();
 
             context.commitColor(parsedColor);
         }
--- kdelibs-3.5.2/khtml/css/cssstyleselector.cpp	2006-03-17 05:19:15.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/css/cssstyleselector.cpp	2006-04-14 15:43:17.000000000 -0400
@@ -3,7 +3,7 @@
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 2003-2004 Apple Computer, Inc.
- *           (C) 2004-2005 Allan Sandfeld Jensen (kde@carewolf.com)
+ *           (C) 2004-2006 Allan Sandfeld Jensen (kde@carewolf.com)
  *           (C) 2004 Germain Garand (germain@ebooksfrance.org)
  *
  * This library is free software; you can redistribute it and/or
@@ -191,7 +191,7 @@
 {
     KHTMLView* view = doc->view();
 
-    init(view ? view->part()->settings() : 0);
+    init(view ? view->part()->settings() : 0, doc);
 
     strictParsing = _strictParsing;
     m_medium = view ? view->mediaType() : QString("all");
@@ -249,7 +249,7 @@
 
 CSSStyleSelector::CSSStyleSelector( CSSStyleSheetImpl *sheet )
 {
-    init(0L);
+    init(0L, 0L);
 
     KHTMLView *view = sheet->doc()->view();
     m_medium = view ? view->mediaType() : "screen";
@@ -258,7 +258,7 @@
     authorStyle->append( sheet, m_medium );
 }
 
-void CSSStyleSelector::init(const KHTMLSettings* _settings)
+void CSSStyleSelector::init(const KHTMLSettings* _settings, DocumentImpl* doc)
 {
     element = 0;
     settings = _settings;
@@ -267,7 +267,7 @@
     pseudoProps = (CSSOrderedProperty **)malloc(128*sizeof(CSSOrderedProperty *));
     propsToApplySize = 128;
     pseudoPropsSize = 128;
-    if(!s_defaultStyle) loadDefaultStyle(settings);
+    if(!s_defaultStyle) loadDefaultStyle(settings, doc);
 
     defaultStyle = s_defaultStyle;
     defaultPrintStyle = s_defaultPrintStyle;
@@ -291,7 +291,7 @@
     authorStyle->append( sheet, m_medium );
 }
 
-void CSSStyleSelector::loadDefaultStyle(const KHTMLSettings *s)
+void CSSStyleSelector::loadDefaultStyle(const KHTMLSettings *s, DocumentImpl *doc)
 {
     if(s_defaultStyle) return;
 
@@ -310,7 +310,7 @@
 	    style += s->settingsToCSS();
 	DOMString str(style);
 
-	s_defaultSheet = new DOM::CSSStyleSheetImpl((DOM::CSSStyleSheetImpl * ) 0);
+	s_defaultSheet = new DOM::CSSStyleSheetImpl(doc);
 	s_defaultSheet->parseString( str );
 
 	// Collect only strict-mode rules.
@@ -333,7 +333,7 @@
 	QString style = QString::fromLatin1( file.data() );
 	DOMString str(style);
 
-	s_quirksSheet = new DOM::CSSStyleSheetImpl((DOM::CSSStyleSheetImpl * ) 0);
+	s_quirksSheet = new DOM::CSSStyleSheetImpl(doc);
 	s_quirksSheet->parseString( str );
 
 	// Collect only quirks-mode rules.
@@ -773,8 +773,6 @@
     return numProps;
 }
 
-static bool subject;
-
 // modified version of the one in kurl.cpp
 static void cleanpath(QString &path)
 {
@@ -843,7 +841,7 @@
 }
 
 // a helper function for parsing nth-arguments
-static inline bool matchNth(int count, const QString& nth)
+static bool matchNth(int count, const QString& nth)
 {
     if (nth.isEmpty()) return false;
     int a = 0;
@@ -898,18 +896,106 @@
     return false;
 }
 
-void CSSStyleSelector::checkSelector(int selIndex, DOM::ElementImpl *e)
+// Recursive check of combinators to support nondeterministic matching
+DOM::NodeImpl* CSSStyleSelector::checkSubSelectors(DOM::CSSSelector *sel, DOM::ElementImpl * e, DOM::NodeImpl * n, bool &onlyHoverActive, bool isAncestor)
 {
-    dynamicPseudo = RenderStyle::NOPSEUDO;
+    if(!n->isElementNode()) return 0;
+
+    CSSSelector::Relation relation = sel->relation;
+    sel = sel->tagHistory;
+    if (!sel) return n;
+
+    switch(relation)
+    {
+    case CSSSelector::Descendant:
+    {
+        ElementImpl *elem = 0;
+        while(true)
+        {
+            n = n->parentNode();
+            if(!n || !n->isElementNode()) return 0;
+            elem = static_cast<ElementImpl *>(n);
+            // Found one matching element
+            if(checkOneSelector(sel, elem, e, true)) {
+                // Check the rest of the combinators
+                bool t_onlyHoverActive = onlyHoverActive;
+                if (checkSubSelectors(sel, e, n, t_onlyHoverActive, true)) {
+                    onlyHoverActive = t_onlyHoverActive;
+                    return n;
+                }
+            }
+        }
+        return 0;
+    }
+    case CSSSelector::Child:
+    {
+        n = n->parentNode();
+        if (!strictParsing)
+            while (n && n->implicitNode()) n = n->parentNode();
+        if(!n || !n->isElementNode()) return 0;
+        ElementImpl *elem = static_cast<ElementImpl *>(n);
+        if(!checkOneSelector(sel, elem, e, true)) return 0;
+        break;
+    }
+    case CSSSelector::IndirectAdjacent:
+    {
+        ElementImpl *elem = 0;
+        while(true)
+        {
+            n = n->previousSibling();
+            while( n && !n->isElementNode() )
+                n = n->previousSibling();
+            if( !n ) return 0;
+            elem = static_cast<ElementImpl *>(n);
+            if (checkOneSelector(sel, elem, e, false)) {
+                // Check the rest of the combinators
+                bool t_onlyHoverActive = onlyHoverActive;
+                if (checkSubSelectors(sel, e, n, t_onlyHoverActive, false)) {
+                    onlyHoverActive = t_onlyHoverActive;
+                    return n;
+                }
+            }
+        };
+        return 0;
+    }
+    case CSSSelector::DirectAdjacent:
+    {
+        n = n->previousSibling();
+        while( n && !n->isElementNode() )
+            n = n->previousSibling();
+        if( !n ) return 0;
+        ElementImpl *elem = static_cast<ElementImpl *>(n);
+        if(!checkOneSelector(sel, elem, e, false)) return 0;
+        break;
+    }
+    case CSSSelector::SubSelector:
+    {
+        if (onlyHoverActive)
+            onlyHoverActive = (sel->match == CSSSelector::PseudoClass &&
+                            (sel->pseudoType() == CSSSelector::PseudoHover ||
+                                sel->pseudoType() == CSSSelector::PseudoActive));
+
+        //kdDebug() << "CSSOrderedRule::checkSelector" << endl;
+        ElementImpl *elem = static_cast<ElementImpl *>(n);
+        // a selector is invalid if something follows :first-xxx
+        if ( dynamicPseudo != RenderStyle::NOPSEUDO ) {
+            return 0;
+        }
+        if(!checkOneSelector(sel, elem, e, isAncestor)) return 0;
+        //kdDebug() << "CSSOrderedRule::checkSelector: passed" << endl;
+        break;
+    }
+    }
+    return checkSubSelectors(sel, e, n, onlyHoverActive, isAncestor);
+}
 
-    NodeImpl *n = e;
+void CSSStyleSelector::checkSelector(int selIndex, DOM::ElementImpl * e)
+{
+    dynamicPseudo = RenderStyle::NOPSEUDO;
 
     selectorCache[ selIndex ].state = Invalid;
     CSSSelector *sel = selectors[ selIndex ];
 
-    // we have the subject part of the selector
-    subject = true;
-
     // We track whether or not the rule contains only :hover and :active in a simple selector. If
     // so, we can't allow that to apply to every element on the page.  We assume the author intended
     // to apply the rules only to links.
@@ -921,86 +1007,15 @@
     bool affectedByActive = style->affectedByActiveRules();
 
     // first selector has to match
-    if(!checkOneSelector(sel, e)) return;
+    if(!checkOneSelector(sel, e, e, true)) return;
 
     // check the subselectors
-    CSSSelector::Relation relation = sel->relation;
-    while((sel = sel->tagHistory))
-    {
-        if(!n->isElementNode()) return;
-        switch(relation)
-        {
-        case CSSSelector::Descendant:
-        {
-            bool found = false;
-            while(!found)
-            {
-		subject = false;
-                n = n->parentNode();
-                if(!n || !n->isElementNode()) return;
-                ElementImpl *elem = static_cast<ElementImpl *>(n);
-                if(checkOneSelector(sel, elem)) found = true;
-            }
-            break;
-        }
-        case CSSSelector::Child:
-        {
-	    subject = false;
-            n = n->parentNode();
-            if (!strictParsing)
-                while (n && n->implicitNode()) n = n->parentNode();
-            if(!n || !n->isElementNode()) return;
-            ElementImpl *elem = static_cast<ElementImpl *>(n);
-            if(!checkOneSelector(sel, elem)) return;
-            break;
-        }
-        case CSSSelector::DirectAdjacent:
-        {
-            subject = false;
-            n = n->previousSibling();
-            while( n && !n->isElementNode() )
-                n = n->previousSibling();
-            if( !n ) return;
-            ElementImpl *elem = static_cast<ElementImpl *>(n);
-            if(!checkOneSelector(sel, elem)) return;
-            break;
-        }
-        case CSSSelector::IndirectAdjacent:
-        {
-            subject = false;
-            ElementImpl *elem = 0;
-            do {
-                n = n->previousSibling();
-                while( n && !n->isElementNode() )
-                    n = n->previousSibling();
-                if( !n ) return;
-                elem = static_cast<ElementImpl *>(n);
-            } while (!checkOneSelector(sel, elem));
-            break;
-        }
-        case CSSSelector::SubSelector:
-	{
-            if (onlyHoverActive)
-                onlyHoverActive = (sel->match == CSSSelector::PseudoClass &&
-                                   (sel->pseudoType() == CSSSelector::PseudoHover ||
-                                    sel->pseudoType() == CSSSelector::PseudoActive));
-
-	    //kdDebug() << "CSSOrderedRule::checkSelector" << endl;
-	    ElementImpl *elem = static_cast<ElementImpl *>(n);
-	    // a selector is invalid if something follows :first-xxx
-	    if ( dynamicPseudo != RenderStyle::NOPSEUDO ) {
-		return;
-	    }
-	    if(!checkOneSelector(sel, elem, true)) return;
-	    //kdDebug() << "CSSOrderedRule::checkSelector: passed" << endl;
-	    break;
-	}
-        }
-        relation = sel->relation;
-    }
+    NodeImpl *n = checkSubSelectors(sel, e, e, onlyHoverActive, true);
+    if (!n) return;
 
+    bool isSubject = (n == e);
     // disallow *:hover, *:active, and *:hover:active except for links
-    if (onlyHoverActive && subject) {
+    if (onlyHoverActive && isSubject) {
         if (pseudoState == PseudoUnknown)
             checkPseudoState( encodedurl, e );
 
@@ -1023,7 +1038,7 @@
     return;
 }
 
-bool CSSStyleSelector::checkOneSelector(DOM::CSSSelector *sel, DOM::ElementImpl *e, bool isSubSelector)
+bool CSSStyleSelector::checkOneSelector(DOM::CSSSelector *sel, DOM::ElementImpl *e, DOM::ElementImpl *subject, bool isAncestor )
 {
     if(!e)
         return false;
@@ -1035,15 +1050,19 @@
         Q_UINT16 selLocalName = localNamePart(sel->tag);
         Q_UINT16 selNS = namespacePart(sel->tag);
 
-        if (localName <= ID_LAST_TAG && e->isHTMLElement())
-            ns = xhtmlNamespace; // FIXME: Really want to move away from this complicated hackery and just
-                                 // switch tags and attr names over to AtomicStrings.
+        if (localName <= ID_LAST_TAG && ns == defaultNamespace) {
+            assert(e->isHTMLElement());
+            ns = xhtmlNamespace;
+        }
 
-        if ((selLocalName != anyLocalName && localName != selLocalName) ||
-            (selNS != anyNamespace && ns != selNS))
-            return false;
+        // match on local
+        if (selLocalName != anyLocalName && localName != selLocalName) return false;
+        // match on namespace
+        if (selNS != anyNamespace && ns != selNS) return false;
     }
 
+    DOM::DocumentImpl* doc = e->getDocument();
+
     if(sel->attr)
     {
         DOMString value = e->getAttribute(sel->attr);
@@ -1052,9 +1071,9 @@
         switch(sel->match)
         {
         case CSSSelector::Exact:
-            /* attribut values are case insensitive in all HTML modes,
+            /* attribute values are case insensitive in all HTML modes,
                even in the strict ones */
-            if ( e->getDocument()->htmlMode() != DocumentImpl::XHtml ) {
+            if ( doc->htmlMode() != DocumentImpl::XHtml ) {
                 if ( strcasecmp(sel->value, value) )
                     return false;
             } else {
@@ -1076,7 +1095,7 @@
                     return false;
                return true;
             }
-            // no break    
+            // no break
         case CSSSelector::List:
         {
             if (sel->match != CSSSelector::Class) {
@@ -1178,6 +1197,17 @@
             }
             if (!e->firstChild())
                 return true;
+            else {
+                // check for empty text nodes
+                NodeImpl *t = e->firstChild();
+
+                while (t && t->isTextNode() && static_cast<TextImpl*>(t)->length() == 0) t = t->nextSibling();
+
+                if (t == 0)
+                    return true;
+                else
+                    return false;
+            }
             break;
 	case CSSSelector::PseudoFirstChild: {
 	    // first-child matches the first child that is an element!
@@ -1193,6 +1223,7 @@
         case CSSSelector::PseudoLastChild: {
             // last-child matches the last child that is an element!
             if (e->parentNode() && e->parentNode()->isElementNode()) {
+                // Handle unfinished parsing
                 if (!e->parentNode()->closed()) {
                     e->setRestyleLate();
                     static_cast<ElementImpl*>(e->parentNode())->setRestyleChildrenLate();
@@ -1236,7 +1267,7 @@
                     if (n->isElementNode()) count++;
                     n = n->previousSibling();
                 }
-                kdDebug(6080) << "NthChild " << count << "=" << sel->string_arg << endl;
+//                 kdDebug(6080) << "NthChild " << count << "=" << sel->string_arg << endl;
                 if (matchNth(count,sel->string_arg.string()))
                     return true;
             }
@@ -1355,7 +1386,7 @@
             break;
         }
         case CSSSelector::PseudoTarget:
-            if (e == e->getDocument()->getCSSTarget())
+            if (e == doc->getCSSTarget())
                 return true;
             break;
 	case CSSSelector::PseudoLink:
@@ -1373,7 +1404,7 @@
         case CSSSelector::PseudoHover: {
 	    // If we're in quirks mode, then hover should never match anchors with no
 	    // href and *:hover should not match anything. This is important for sites like wsj.com.
-	    if (strictParsing || isSubSelector || sel->relation == CSSSelector::SubSelector || (sel->tag != anyQName && e->id() != ID_A) || e->hasAnchor()) {
+	    if (strictParsing || sel->relation == CSSSelector::SubSelector || (sel->tag != anyQName && e->id() != ID_A) || e->hasAnchor()) {
 		if (element == e)
 		    style->setAffectedByHoverRules(true);
 		if (e->renderer()) {
@@ -1393,7 +1424,7 @@
 	case CSSSelector::PseudoActive:
 	    // If we're in quirks mode, then :active should never match anchors with no
 	    // href.
-	    if (strictParsing || isSubSelector || sel->relation == CSSSelector::SubSelector || (sel->tag != anyQName && e->id() != ID_A) || e->hasAnchor()) {
+	    if (strictParsing || sel->relation == CSSSelector::SubSelector || (sel->tag != anyQName && e->id() != ID_A) || e->hasAnchor()) {
 		if (element == e)
 		    style->setAffectedByActiveRules(true);
 		else if (e->renderer())
@@ -1403,12 +1434,25 @@
 	    }
 	    break;
         case CSSSelector::PseudoRoot:
-            if (e == e->getDocument()->documentElement())
+            if (e == doc->documentElement())
                 return true;
             break;
         case CSSSelector::PseudoLang: {
+            // ### check xml:lang attribute in XML and XHTML documents
             DOMString value = e->getAttribute(ATTR_LANG);
-            if (value.isNull()) return false;
+            // The LANG attribute is inherited like a property
+            NodeImpl *n = e->parent();;
+            while (n && value.isEmpty()) {
+                if (n->isElementNode()) {
+                    value = static_cast<ElementImpl*>(n)->getAttribute(ATTR_LANG);
+                } else
+                if (n->isDocumentNode()) {
+                    value = static_cast<DocumentImpl*>(n)->contentLanguage();
+                }
+                n = n->parent();
+            }
+            if (value.isEmpty()) return false;
+
             QString langAttr = value.string();
             QString langSel = sel->string_arg.string();
 
@@ -1429,7 +1473,7 @@
                 // but it is, so let's honor it.
                 if (subSel->simpleSelector)
                     break;
-                if (!checkOneSelector(subSel, e))
+                if (!checkOneSelector(subSel, e, subject, isAncestor))
                     return true;
             }
             break;
@@ -1454,7 +1498,7 @@
             if (e->isHTMLElement()) {
                 if (!e->closed()) {
                     e->setRestyleSelfLate();
-                    return false;
+                   return false;
                 }
                 HTMLElementImpl *elem;
                 elem = static_cast<HTMLElementImpl*>(e);
@@ -1473,13 +1517,13 @@
 
 	// Pseudo-elements:
 	case CSSSelector::PseudoFirstLine:
-	    if ( subject ) {
+	    if ( e == subject ) {
 		dynamicPseudo=RenderStyle::FIRST_LINE;
 		return true;
 	    }
 	    break;
 	case CSSSelector::PseudoFirstLetter:
-	    if ( subject ) {
+	    if ( e == subject ) {
 		dynamicPseudo=RenderStyle::FIRST_LETTER;
 		return true;
 	    }
--- kdelibs-3.5.2/khtml/css/cssstyleselector.h	2006-03-17 05:19:15.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/css/cssstyleselector.h	2006-04-14 15:43:17.000000000 -0400
@@ -126,7 +126,7 @@
         KDE_EXPORT static void clear();
         static void reparseConfiguration();
 
-	static void loadDefaultStyle(const KHTMLSettings *s = 0);
+	static void loadDefaultStyle(const KHTMLSettings *s, DOM::DocumentImpl *doc);
 
 	RenderStyle *styleForElement(DOM::ElementImpl *e);
 
@@ -145,11 +145,13 @@
 
     protected:
 
+	DOM::NodeImpl* checkSubSelectors(DOM::CSSSelector *sel, DOM::ElementImpl *e,  DOM::NodeImpl *n, bool &onlyHoverActive, bool isAncestor);
+
 	/* checks if the complete selector (which can be build up from a few CSSSelector's
 	    with given relationships matches the given Element */
 	void checkSelector(int selector, DOM::ElementImpl *e);
 	/* checks if the selector matches the given Element */
-	bool checkOneSelector(DOM::CSSSelector *selector, DOM::ElementImpl *e, bool isSubSelector = false);
+	bool checkOneSelector(DOM::CSSSelector *selector, DOM::ElementImpl *e, DOM::ElementImpl *subject, bool isAncestor);
 
 #ifdef APPLE_CHANGES
 	/* This function fixes up the default font size if it detects that the
@@ -184,7 +186,7 @@
 public:
 
     private:
-        void init(const KHTMLSettings* settings);
+        void init(const KHTMLSettings* settings, DOM::DocumentImpl* doc);
 
         void mapBackgroundAttachment(BackgroundLayer* layer, DOM::CSSValueImpl* value);
         void mapBackgroundImage(BackgroundLayer* layer, DOM::CSSValueImpl* value);
--- kdelibs-3.5.2/khtml/css/html4.css	2006-03-17 05:19:15.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/css/html4.css	2006-04-14 15:43:17.000000000 -0400
@@ -84,25 +84,25 @@
         margin: 1__qem 40px 1em 40px;
 }
 
-Q        {
+q        {
          display: inline;
 }
 
-Q:before {
+q:before {
         content: open-quote;
 }
 
-Q:after  {
+q:after  {
         content: close-quote;
 }
 
-CENTER {
+center {
 	display: block;
 	/* special centering to be able to emulate the html4/netscape behavior */
 	text-align: -khtml-center;
 }
 
-HR  {
+hr  {
         display: block;
         margin: 12px auto;
         border-style: inset;
@@ -110,53 +110,53 @@
         -khtml-flow-mode: -khtml-around-floats
 }
 
-MAP {
+map {
 	display: inline;
 }
 
 /*
  * heading elements
- * margin values rely on font-sizes ratio defined in CSS-2.1 15.7
- * (cf. CSSStyleSelector for absolute font-sizes computation)
- * We have an 1.1/font-ratio margin
+ * margin values rely on font-sizes ratio defined in css-2.1 15.7
+ * (cf. cssstyleselector for absolute font-sizes computation)
+ * we have an 1.1/font-ratio margin
  */
 
-H1 {
+h1 {
 	display: block;
 	font-size: xx-large;
 	margin: .55__qem 0 .55em 0;
 	font-weight: bolder;
 }
 
-H2 {
+h2 {
 	display: block;
 	font-size: x-large;
 	margin: .73__qem 0 .73em 0;
 	font-weight: bolder;
 }
 
-H3 {
+h3 {
 	display: block;
 	font-size: large;
 	margin: 0.92__qem 0 0.92em 0;
 	font-weight: bolder;
 }
 
-H4 {
+h4 {
 	display: block;
         font-size: medium;
 	margin: 1.1__qem 0 1.1em 0;
 	font-weight: bolder;
 }
 
-H5 {
+h5 {
 	display: block;
 	font-size: small;
 	margin: 1.24__qem 0 1.24em 0;
 	font-weight: bolder;
 }
 
-H6 {
+h6 {
 	display: block;
 	font-size: xx-small;
 	margin: 1.83__qem 0 1.83em 0;
@@ -167,7 +167,7 @@
  * tables
  */
 
-TABLE {
+table {
 	display: table;
 	border-collapse: separate;
 	text-align: -khtml-auto;
@@ -176,142 +176,131 @@
         box-sizing: border-box;
 }
 
-TABLE[align="center"] {
+table[align="center"] {
 	margin-left: auto;
 	margin-right: auto;
 }
 
-TABLE[align="left"] {
+table[align="left"] {
 	float: -khtml-left;
 }
 
-TABLE[align="right"] {
+table[align="right"] {
 	float: -khtml-right;
 }
 
-THEAD {
+thead {
 	display: table-header-group;
         border-color: inherit;
 	vertical-align: middle;
 }
 
-TBODY {
+tbody {
 	display: table-row-group;
         border-color: inherit;
 	vertical-align: middle;
 }
 
-TFOOT {
+tfoot {
 	display: table-footer-group;
         border-color: inherit;
 	vertical-align: middle;
 }
 
-COL {
+col {
 	display: table-column;
 }
 
-COLGROUP {
+colgroup {
 	display: table-column-group;
 }
 
-TR {
+tr {
 	display: table-row;
 	vertical-align: inherit;
         border-color: inherit;
 }
 
 
-TD, TH {
+td, th {
 	display: table-cell;
 	vertical-align: inherit;
 }
 
-TH {
+th {
 	font-weight: bolder;
 }
 
-CAPTION {
+caption {
 	display: table-caption;
 	text-align: -khtml-center;
 }
 
 /*
- * Lists
+ * lists
  */
 
-UL, MENU, DIR {
+ul, menu, dir {
         display: block;
         list-style-type: disc;
         margin: 1__qem 0 1em 0;
         -khtml-padding-start: 40px
 }
 
-OL {
+ol {
         display: block;
         list-style-type: decimal;
         margin: 1__qem 0 1em 0;
         -khtml-padding-start: 40px
 }
 
-LI {
+li {
         display: list-item;
         -khtml-flow-mode: -khtml-around-floats;
 }
 
 
-UL UL, OL UL {
+ul ul, ol ul {
 	list-style-type: circle;
 }
 
-OL OL UL, OL UL UL, UL OL UL, UL UL UL {
+ol ol ul, ol ul ul, ul ol ul, ul ul ul {
 	list-style-type: square;
 }
 
 
-DD {
+dd {
 	display: block;
 	-khtml-margin-start: 40px;
 }
 
-DL {
+dl {
 	display: block;
         margin: 1__qem 0 1em 0;
 }
 
-DT {
+dt {
 	display: block;
 }
 
-DL[compact] > DT {
+dl[compact] > dt {
 	display: compact;
 }
 
-/* for right to left */
-
-*[dir="rtl"] UL,
-*[dir="rtl"] OL,
-*[dir="rtl"] DIR,
-*[dir="rtl"] MENU,
-*[dir="rtl"] DD {
-	margin-right:40px;
-	margin-left: auto;
-}
-
-OL UL,
-UL OL,
-UL UL,
-OL OL {
+ol ul,
+ul ol,
+ul ul,
+ol ol {
 	margin-top: auto;
 	margin-bottom: auto;
 }
 
-LI > P {
+li > p {
 	margin-top: auto;
 /*	margin-bottom: auto;*/
 }
 
-LI > DIV {
+li > div {
 	margin-top: auto;
 /*	margin-bottom: auto;*/
 }
@@ -320,12 +309,12 @@
  * form elements
  */
 
-FORM {
+form {
 	display: block;
         margin: 0__qem 0 1em 0;
 }
 
-LEGEND {
+legend {
         display: block;
         padding-left: 2px;
         padding-right: 2px;
@@ -333,76 +322,76 @@
         margin: 0;
 }
 
-FIELDSET {
+fieldset {
 	display: block;
         padding: 0.75em 0.625em;
 	margin: 1.0em 0;
-        border: 2px groove ThreeDFace;
+        border: 2px groove threedface;
         -khtml-flow-mode: -khtml-around-floats
 }
 
-BUTTON {
+button {
         display: inline-block;
-        border: 2px outset ButtonFace;
-        background-color: ButtonFace;
-        color: ButtonText;
+        border: 2px outset buttonface;
+        background-color: buttonface;
+        color: buttontext;
         padding: 2px 2px 2px 2px;
         cursor: default;
 }
 
-BUTTON:active {
+button:active {
         border-style: inset;
 }
 
-INPUT, TEXTAREA {
+input, textarea {
         text-align: -khtml-auto;
 }
 
-INPUT, TEXTAREA, SELECT, BUTTON {
+input, textarea, select, button {
         font-weight: normal;
         margin: 0__qem;
 }
 
-INPUT { color: windowtext;
+input { color: windowtext;
         font-family: sans-serif;
         font-size: small;
         border: 2px -khtml-native;
 }
 
-INPUT[type="hidden"] {
+input[type="hidden"] {
 	display: none;
 }
 
-INPUT[type="radio"], INPUT[type="checkbox"] {
+input[type="radio"], input[type="checkbox"] {
         margin: 0 0.5ex;
         color: buttontext;
 }
 
-INPUT[type="text"], INPUT[type="password"] {
+input[type="text"], input[type="password"] {
 	cursor: text;
 }
 
-INPUT[type="submit"], INPUT[type="reset"], INPUT[type="button"] {
+input[type="submit"], input[type="reset"], input[type="button"] {
         color: buttontext;
 }
 
-ISINDEX { color: windowtext; font-size: small; }
+isindex { color: windowtext; font-size: small; }
 
 
-OPTION,
-OPTGROUP,
-AREA,
-PARAM  {
+option,
+optgroup,
+area,
+param  {
 	display: none;
 }
 
-SELECT {
+select {
         font-family: sans-serif;
         font-size: small;
         color: windowtext;
 }
 
-TEXTAREA {
+textarea {
         color: windowtext;
         font-family: monospace;
         border: 2px -khtml-native;
@@ -412,64 +401,64 @@
  * inline elements
  */
 
-U,
-INS {
+u,
+ins {
 	text-decoration: underline;
 }
 
-STRONG,
-B {
+strong,
+b {
 	font-weight: bolder;
 }
 
-I,
-CITE,
-EM,
-VAR,
-ADDRESS {
+i,
+cite,
+em,
+var,
+address {
 	font-style: italic;
 }
 
-TT,
-CODE,
-KBD,
-SAMP {
+tt,
+code,
+kbd,
+samp {
 	font-family: monospace;
 }
 
-PRE,
-XMP,
-PLAINTEXT {
+pre,
+xmp,
+plaintext {
 	display: block;
 	font-family: monospace;
 	white-space: pre;
 	margin: 1__qem 0;
 }
 
-BIG {
+big {
 	font-size: larger;
 }
 
-SMALL {
+small {
 	font-size: smaller;
 }
 
-S,
-STRIKE,
-DEL  {
+s,
+strike,
+del  {
 	text-decoration: line-through;
 }
 
-SUB {
+sub {
 	vertical-align: sub;
 	font-size: smaller;
 }
-SUP {
+sup {
 	vertical-align: super;
 	font-size: smaller;
 }
 
-ABBR, ACRONYM {
+abbr, acronym {
 	font-variant: small-caps;
 	letter-spacing: 0.1em
 }
@@ -482,43 +471,43 @@
 a:link:active          { color: red; outline: 1px dotted invert; }
 a:visited:active          { color: red; outline: 1px dotted invert; }
 
-/* With the current design it is too expensive to set this default via CSS
+/* with the current design it is too expensive to set this default via css
 :before,:after  { white-space: pre-line }
 */
 
-/* ### use this to replace renderBR
-      BR:before       { content: "\n" }
+/* ### use this to replace renderbr
+      br:before       { content: "\n" }
 */
 
 
-/* Bidirectionality settings (do not change) */
+/* bidirectionality settings (do not change) */
 
-BDO[DIR="ltr"]  {
+bdo[dir="ltr"]  {
 	direction: ltr;
 	unicode-bidi: bidi-override;
 }
 
-BDO[DIR="rtl"]  {
+bdo[dir="rtl"]  {
 	direction: rtl;
 	unicode-bidi: bidi-override;
 }
 
 /* ### this selector seems to be still broken ...
-      *[DIR="ltr"]    { direction: ltr; unicode-bidi: embed }
-      *[DIR="rtl"]    { direction: rtl; unicode-bidi: embed }
+      *[dir="ltr"]    { direction: ltr; unicode-bidi: embed }
+      *[dir="rtl"]    { direction: rtl; unicode-bidi: embed }
 */
 
-/* Elements that are block-level in HTML4 */
+/* elements that are block-level in html4 */
 /* ### don't support unicode-bidi at the moment
-      ADDRESS, BLOCKQUOTE, BODY, DD, DIV, DL, DT, FIELDSET,
-      FORM, FRAME, FRAMESET, H1, H2, H3, H4, H5, H6, IFRAME,
-      NOSCRIPT, NOFRAMES, OBJECT, OL, P, UL, APPLET, CENTER,
-      DIR, HR, MENU, PRE, LI, TABLE, TR, THEAD, TBODY, TFOOT,
-      COL, COLGROUP, TD, TH, CAPTION
+      address, blockquote, body, dd, div, dl, dt, fieldset,
+      form, frame, frameset, h1, h2, h3, h4, h5, h6, iframe,
+      noscript, noframes, object, ol, p, ul, applet, center,
+      dir, hr, menu, pre, li, table, tr, thead, tbody, tfoot,
+      col, colgroup, td, th, caption
                       { unicode-bidi: embed }
 */
 
-/* End bidi settings */
+/* end bidi settings */
 
 /*
  * other elements
--- kdelibs-3.5.2/khtml/css/parser.cpp	2006-03-17 05:19:15.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/css/parser.cpp	2006-04-14 15:43:17.000000000 -0400
@@ -1,7 +1,7 @@
-/* A Bison parser, made by GNU Bison 1.875a.  */
+/* A Bison parser, made by GNU Bison 1.875d.  */
 
 /* Skeleton parser for Yacc-like parsing with Bison,
-   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003 Free Software Foundation, Inc.
+   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.
 
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
@@ -15,8 +15,8 @@
 
    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
-   Foundation, Inc., 51 Franklin Street, Fifth Floor,
-   Boston, MA 02110-1301, USA.  */
+   Foundation, Inc., 59 Temple Place - Suite 330,
+   Boston, MA 02111-1307, USA.  */
 
 /* As a special exception, when this file is copied by Bison into a
    Bison output file, you may use that output file without restriction.
@@ -314,18 +314,25 @@
 
 #if ! defined (yyoverflow) || YYERROR_VERBOSE
 
+# ifndef YYFREE
+#  define YYFREE free
+# endif
+# ifndef YYMALLOC
+#  define YYMALLOC malloc
+# endif
+
 /* The parser invokes alloca or malloc; define the necessary symbols.  */
 
-# if YYSTACK_USE_ALLOCA
-#  define YYSTACK_ALLOC alloca
+# ifdef YYSTACK_USE_ALLOCA
+#  if YYSTACK_USE_ALLOCA
+#   define YYSTACK_ALLOC alloca
+#  endif
 # else
-#  ifndef YYSTACK_USE_ALLOCA
-#   if defined (alloca) || defined (_ALLOCA_H)
-#    define YYSTACK_ALLOC alloca
-#   else
-#    ifdef __GNUC__
-#     define YYSTACK_ALLOC __builtin_alloca
-#    endif
+#  if defined (alloca) || defined (_ALLOCA_H)
+#   define YYSTACK_ALLOC alloca
+#  else
+#   ifdef __GNUC__
+#    define YYSTACK_ALLOC __builtin_alloca
 #   endif
 #  endif
 # endif
@@ -338,20 +345,20 @@
 #   include <stdlib.h> /* INFRINGES ON USER NAME SPACE */
 #   define YYSIZE_T size_t
 #  endif
-#  define YYSTACK_ALLOC malloc
-#  define YYSTACK_FREE free
+#  define YYSTACK_ALLOC YYMALLOC
+#  define YYSTACK_FREE YYFREE
 # endif
 #endif /* ! defined (yyoverflow) || YYERROR_VERBOSE */
 
 
 #if (! defined (yyoverflow) \
      && (! defined (__cplusplus) \
-	 || (YYSTYPE_IS_TRIVIAL)))
+	 || (defined (YYSTYPE_IS_TRIVIAL) && YYSTYPE_IS_TRIVIAL)))
 
 /* A type that is properly aligned for any stack member.  */
 union yyalloc
 {
-  short yyss;
+  short int yyss;
   YYSTYPE yyvs;
   };
 
@@ -361,13 +368,13 @@
 /* The size of an array large to enough to hold all stacks, each with
    N elements.  */
 # define YYSTACK_BYTES(N) \
-     ((N) * (sizeof (short) + sizeof (YYSTYPE))				\
+     ((N) * (sizeof (short int) + sizeof (YYSTYPE))			\
       + YYSTACK_GAP_MAXIMUM)
 
 /* Copy COUNT objects from FROM to TO.  The source and destination do
    not overlap.  */
 # ifndef YYCOPY
-#  if 1 < __GNUC__
+#  if defined (__GNUC__) && 1 < __GNUC__
 #   define YYCOPY(To, From, Count) \
       __builtin_memcpy (To, From, (Count) * sizeof (*(From)))
 #  else
@@ -403,13 +410,13 @@
 #if defined (__STDC__) || defined (__cplusplus)
    typedef signed char yysigned_char;
 #else
-   typedef short yysigned_char;
+   typedef short int yysigned_char;
 #endif
 
 /* YYFINAL -- State number of the termination state. */
 #define YYFINAL  16
 /* YYLAST -- Last index in YYTABLE.  */
-#define YYLAST   447
+#define YYLAST   446
 
 /* YYNTOKENS -- Number of terminals. */
 #define YYNTOKENS  66
@@ -466,25 +473,25 @@
 #if YYDEBUG
 /* YYPRHS[YYN] -- Index of the first RHS symbol of rule number YYN in
    YYRHS.  */
-static const unsigned short yyprhs[] =
+static const unsigned short int yyprhs[] =
 {
        0,     0,     3,     9,    12,    15,    18,    25,    28,    34,
       35,    38,    39,    42,    45,    46,    52,    56,    60,    61,
-      65,    72,    76,    80,    81,    84,    91,    95,    99,   100,
-     103,   104,   108,   110,   112,   114,   116,   118,   120,   123,
-     125,   127,   128,   130,   132,   137,   140,   148,   149,   153,
-     156,   160,   164,   168,   172,   175,   178,   181,   182,   184,
-     186,   189,   191,   196,   199,   201,   205,   208,   210,   213,
-     216,   219,   223,   226,   230,   235,   239,   241,   243,   245,
-     248,   251,   253,   255,   257,   259,   262,   265,   270,   279,
-     286,   297,   299,   301,   303,   305,   307,   309,   311,   313,
-     316,   320,   325,   330,   335,   340,   346,   351,   356,   361,
-     367,   373,   377,   381,   386,   391,   397,   400,   403,   406,
-     407,   409,   413,   416,   419,   420,   422,   425,   428,   431,
-     434,   437,   440,   442,   444,   447,   450,   453,   456,   459,
-     462,   465,   468,   471,   474,   477,   480,   483,   486,   489,
-     492,   495,   498,   504,   508,   511,   515,   519,   522,   528,
-     532,   534
+      65,    72,    76,    80,    81,    85,    92,    96,   100,   101,
+     104,   105,   109,   111,   113,   115,   117,   119,   121,   124,
+     126,   128,   129,   131,   133,   138,   141,   149,   150,   154,
+     157,   161,   165,   169,   173,   176,   179,   182,   183,   185,
+     187,   190,   192,   197,   200,   202,   206,   209,   211,   214,
+     217,   220,   224,   227,   231,   236,   240,   242,   244,   246,
+     249,   252,   254,   256,   258,   260,   263,   266,   271,   280,
+     287,   298,   300,   302,   304,   306,   308,   310,   312,   314,
+     317,   321,   326,   331,   336,   341,   347,   352,   357,   362,
+     368,   374,   378,   382,   387,   392,   398,   401,   404,   407,
+     408,   410,   414,   417,   420,   421,   423,   426,   429,   432,
+     435,   438,   441,   443,   445,   448,   451,   454,   457,   460,
+     463,   466,   469,   472,   475,   478,   481,   484,   487,   490,
+     493,   496,   499,   505,   509,   512,   516,   520,   523,   529,
+     533,   535
 };
 
 /* YYRHS -- A `-1'-separated list of the rules' RHS. */
@@ -498,56 +505,56 @@
       55,    -1,    24,     1,   118,    -1,    24,     1,    55,    -1,
       -1,    74,    75,    72,    -1,    20,    71,    81,    71,    82,
       55,    -1,    20,     1,   118,    -1,    20,     1,    55,    -1,
-      -1,    77,    72,    -1,    25,    71,    78,    81,    71,    55,
-      -1,    25,     1,   118,    -1,    25,     1,    55,    -1,    -1,
-      12,     4,    -1,    -1,    79,    80,    72,    -1,    91,    -1,
-      84,    -1,    87,    -1,    88,    -1,   117,    -1,   116,    -1,
-      75,     1,    -1,    11,    -1,    49,    -1,    -1,    83,    -1,
-      86,    -1,    83,    56,    71,    86,    -1,    83,     1,    -1,
-      22,    71,    83,    53,    71,    85,    54,    -1,    -1,    85,
-      91,    71,    -1,    12,    71,    -1,    21,     1,   118,    -1,
-      21,     1,    55,    -1,    23,     1,   118,    -1,    23,     1,
-      55,    -1,    57,    71,    -1,    58,    71,    -1,    59,    71,
-      -1,    -1,    60,    -1,    57,    -1,    92,   105,    -1,    93,
-      -1,    92,    56,    71,    93,    -1,    92,     1,    -1,    95,
-      -1,    93,    89,    95,    -1,    93,     1,    -1,    19,    -1,
-      18,    19,    -1,    12,    19,    -1,    96,    71,    -1,    96,
-      97,    71,    -1,    97,    71,    -1,    94,    96,    71,    -1,
-      94,    96,    97,    71,    -1,    94,    97,    71,    -1,    12,
-      -1,    18,    -1,    98,    -1,    97,    98,    -1,    97,     1,
-      -1,    14,    -1,    99,    -1,   101,    -1,   104,    -1,    16,
-      12,    -1,    12,    71,    -1,    17,    71,   100,    61,    -1,
-      17,    71,   100,   102,    71,   103,    71,    61,    -1,    17,
-      71,    94,    19,   100,    61,    -1,    17,    71,    94,    19,
-     100,   102,    71,   103,    71,    61,    -1,    62,    -1,     6,
-      -1,     7,    -1,     8,    -1,     9,    -1,    10,    -1,    12,
-      -1,    11,    -1,    15,    12,    -1,    15,    15,    12,    -1,
-      15,    50,    13,    63,    -1,    15,    50,    48,    63,    -1,
-      15,    50,    12,    63,    -1,    15,    50,    11,    63,    -1,
-      15,    51,    71,    95,    63,    -1,    53,    71,   107,    54,
-      -1,    53,    71,     1,    54,    -1,    53,    71,   106,    54,
-      -1,    53,    71,   106,   107,    54,    -1,    53,    71,   106,
-       1,    54,    -1,   107,    55,    71,    -1,     1,    55,    71,
-      -1,   106,   107,    55,    71,    -1,   106,     1,    55,    71,
-      -1,   108,    15,    71,   110,   109,    -1,     1,   118,    -1,
-      12,    71,    -1,    29,    71,    -1,    -1,   112,    -1,   110,
-     111,   112,    -1,    64,    71,    -1,    56,    71,    -1,    -1,
-     113,    -1,    90,   113,    -1,    46,    71,    -1,    11,    71,
-      -1,    12,    71,    -1,    49,    71,    -1,    52,    71,    -1,
-     115,    -1,   114,    -1,    48,    71,    -1,    47,    71,    -1,
-      33,    71,    -1,    34,    71,    -1,    35,    71,    -1,    36,
-      71,    -1,    37,    71,    -1,    38,    71,    -1,    39,    71,
-      -1,    40,    71,    -1,    41,    71,    -1,    42,    71,    -1,
-      43,    71,    -1,    44,    71,    -1,    45,    71,    -1,    31,
-      71,    -1,    30,    71,    -1,    32,    71,    -1,    50,    71,
-     110,    63,    71,    -1,    50,    71,     1,    -1,    14,    71,
-      -1,    65,     1,   118,    -1,    65,     1,    55,    -1,     1,
-     118,    -1,    53,     1,   119,     1,    54,    -1,    53,     1,
-      54,    -1,   118,    -1,   119,     1,   118,    -1
+      -1,    76,    77,    72,    -1,    25,    71,    78,    81,    71,
+      55,    -1,    25,     1,   118,    -1,    25,     1,    55,    -1,
+      -1,    12,     4,    -1,    -1,    79,    80,    72,    -1,    91,
+      -1,    84,    -1,    87,    -1,    88,    -1,   117,    -1,   116,
+      -1,    75,     1,    -1,    11,    -1,    49,    -1,    -1,    83,
+      -1,    86,    -1,    83,    56,    71,    86,    -1,    83,     1,
+      -1,    22,    71,    83,    53,    71,    85,    54,    -1,    -1,
+      85,    91,    71,    -1,    12,    71,    -1,    21,     1,   118,
+      -1,    21,     1,    55,    -1,    23,     1,   118,    -1,    23,
+       1,    55,    -1,    57,    71,    -1,    58,    71,    -1,    59,
+      71,    -1,    -1,    60,    -1,    57,    -1,    92,   105,    -1,
+      93,    -1,    92,    56,    71,    93,    -1,    92,     1,    -1,
+      95,    -1,    93,    89,    95,    -1,    93,     1,    -1,    19,
+      -1,    18,    19,    -1,    12,    19,    -1,    96,    71,    -1,
+      96,    97,    71,    -1,    97,    71,    -1,    94,    96,    71,
+      -1,    94,    96,    97,    71,    -1,    94,    97,    71,    -1,
+      12,    -1,    18,    -1,    98,    -1,    97,    98,    -1,    97,
+       1,    -1,    14,    -1,    99,    -1,   101,    -1,   104,    -1,
+      16,    12,    -1,    12,    71,    -1,    17,    71,   100,    61,
+      -1,    17,    71,   100,   102,    71,   103,    71,    61,    -1,
+      17,    71,    94,    19,   100,    61,    -1,    17,    71,    94,
+      19,   100,   102,    71,   103,    71,    61,    -1,    62,    -1,
+       6,    -1,     7,    -1,     8,    -1,     9,    -1,    10,    -1,
+      12,    -1,    11,    -1,    15,    12,    -1,    15,    15,    12,
+      -1,    15,    50,    13,    63,    -1,    15,    50,    48,    63,
+      -1,    15,    50,    12,    63,    -1,    15,    50,    11,    63,
+      -1,    15,    51,    71,    95,    63,    -1,    53,    71,   107,
+      54,    -1,    53,    71,     1,    54,    -1,    53,    71,   106,
+      54,    -1,    53,    71,   106,   107,    54,    -1,    53,    71,
+     106,     1,    54,    -1,   107,    55,    71,    -1,     1,    55,
+      71,    -1,   106,   107,    55,    71,    -1,   106,     1,    55,
+      71,    -1,   108,    15,    71,   110,   109,    -1,     1,   118,
+      -1,    12,    71,    -1,    29,    71,    -1,    -1,   112,    -1,
+     110,   111,   112,    -1,    64,    71,    -1,    56,    71,    -1,
+      -1,   113,    -1,    90,   113,    -1,    46,    71,    -1,    11,
+      71,    -1,    12,    71,    -1,    49,    71,    -1,    52,    71,
+      -1,   115,    -1,   114,    -1,    48,    71,    -1,    47,    71,
+      -1,    33,    71,    -1,    34,    71,    -1,    35,    71,    -1,
+      36,    71,    -1,    37,    71,    -1,    38,    71,    -1,    39,
+      71,    -1,    40,    71,    -1,    41,    71,    -1,    42,    71,
+      -1,    43,    71,    -1,    44,    71,    -1,    45,    71,    -1,
+      31,    71,    -1,    30,    71,    -1,    32,    71,    -1,    50,
+      71,   110,    63,    71,    -1,    50,    71,     1,    -1,    14,
+      71,    -1,    65,     1,   118,    -1,    65,     1,    55,    -1,
+       1,   118,    -1,    53,     1,   119,     1,    54,    -1,    53,
+       1,    54,    -1,   118,    -1,   119,     1,   118,    -1
 };
 
 /* YYRLINE[YYN] -- source line where rule number YYN was defined.  */
-static const unsigned short yyrline[] =
+static const unsigned short int yyrline[] =
 {
        0,   255,   255,   256,   257,   258,   262,   269,   275,   300,
      301,   304,   306,   307,   310,   312,   317,   318,   321,   323,
@@ -574,26 +581,26 @@
    First, the terminals, then, starting at YYNTOKENS, nonterminals. */
 static const char *const yytname[] =
 {
-  "$end", "error", "$undefined", "UNIMPORTANT_TOK", "S", "SGML_CD", 
-  "INCLUDES", "DASHMATCH", "BEGINSWITH", "ENDSWITH", "CONTAINS", "STRING", 
-  "IDENT", "NTH", "HASH", "':'", "'.'", "'['", "'*'", "'|'", "IMPORT_SYM", 
-  "PAGE_SYM", "MEDIA_SYM", "FONT_FACE_SYM", "CHARSET_SYM", 
-  "NAMESPACE_SYM", "KHTML_RULE_SYM", "KHTML_DECLS_SYM", "KHTML_VALUE_SYM", 
-  "IMPORTANT_SYM", "QEMS", "EMS", "EXS", "PXS", "CMS", "MMS", "INS", 
-  "PTS", "PCS", "DEGS", "RADS", "GRADS", "MSECS", "SECS", "HERZ", "KHERZ", 
-  "DIMEN", "PERCENTAGE", "NUMBER", "URI", "FUNCTION", "NOTFUNCTION", 
-  "UNICODERANGE", "'{'", "'}'", "';'", "','", "'+'", "'~'", "'>'", "'-'", 
-  "']'", "'='", "')'", "'/'", "'@'", "$accept", "stylesheet", 
-  "khtml_rule", "khtml_decls", "khtml_value", "maybe_space", "maybe_sgml", 
-  "maybe_charset", "import_list", "import", "maybe_namespace", 
-  "namespace", "maybe_ns_prefix", "rule_list", "rule", "string_or_uri", 
-  "maybe_media_list", "media_list", "media", "ruleset_list", "medium", 
-  "page", "font_face", "combinator", "unary_operator", "ruleset", 
-  "selector_list", "selector", "namespace_selector", "simple_selector", 
-  "element_name", "specifier_list", "specifier", "class", "attrib_id", 
-  "attrib", "match", "ident_or_string", "pseudo", "declaration_block", 
-  "declaration_list", "declaration", "property", "prio", "expr", 
-  "operator", "term", "unary_term", "function", "hexcolor", "invalid_at", 
+  "$end", "error", "$undefined", "UNIMPORTANT_TOK", "S", "SGML_CD",
+  "INCLUDES", "DASHMATCH", "BEGINSWITH", "ENDSWITH", "CONTAINS", "STRING",
+  "IDENT", "NTH", "HASH", "':'", "'.'", "'['", "'*'", "'|'", "IMPORT_SYM",
+  "PAGE_SYM", "MEDIA_SYM", "FONT_FACE_SYM", "CHARSET_SYM", "NAMESPACE_SYM",
+  "KHTML_RULE_SYM", "KHTML_DECLS_SYM", "KHTML_VALUE_SYM", "IMPORTANT_SYM",
+  "QEMS", "EMS", "EXS", "PXS", "CMS", "MMS", "INS", "PTS", "PCS", "DEGS",
+  "RADS", "GRADS", "MSECS", "SECS", "HERZ", "KHERZ", "DIMEN", "PERCENTAGE",
+  "NUMBER", "URI", "FUNCTION", "NOTFUNCTION", "UNICODERANGE", "'{'", "'}'",
+  "';'", "','", "'+'", "'~'", "'>'", "'-'", "']'", "'='", "')'", "'/'",
+  "'@'", "$accept", "stylesheet", "khtml_rule", "khtml_decls",
+  "khtml_value", "maybe_space", "maybe_sgml", "maybe_charset",
+  "import_list", "import", "namespace_list", "namespace",
+  "maybe_ns_prefix", "rule_list", "rule", "string_or_uri",
+  "maybe_media_list", "media_list", "media", "ruleset_list", "medium",
+  "page", "font_face", "combinator", "unary_operator", "ruleset",
+  "selector_list", "selector", "namespace_selector", "simple_selector",
+  "element_name", "specifier_list", "specifier", "class", "attrib_id",
+  "attrib", "match", "ident_or_string", "pseudo", "declaration_block",
+  "declaration_list", "declaration", "property", "prio", "expr",
+  "operator", "term", "unary_term", "function", "hexcolor", "invalid_at",
   "invalid_rule", "invalid_block", "invalid_block_list", 0
 };
 #endif
@@ -601,7 +608,7 @@
 # ifdef YYPRINT
 /* YYTOKNUM[YYLEX-NUM] -- Internal token number corresponding to
    token YYLEX-NUM.  */
-static const unsigned short yytoknum[] =
+static const unsigned short int yytoknum[] =
 {
        0,   256,   257,   258,   259,   260,   261,   262,   263,   264,
      265,   266,   267,   268,   269,    58,    46,    91,    42,   124,
@@ -640,7 +647,7 @@
 {
        0,     2,     5,     2,     2,     2,     6,     2,     5,     0,
        2,     0,     2,     2,     0,     5,     3,     3,     0,     3,
-       6,     3,     3,     0,     2,     6,     3,     3,     0,     2,
+       6,     3,     3,     0,     3,     6,     3,     3,     0,     2,
        0,     3,     1,     1,     1,     1,     1,     1,     2,     1,
        1,     0,     1,     1,     4,     2,     7,     0,     3,     2,
        3,     3,     3,     3,     2,     2,     2,     0,     1,     1,
@@ -671,88 +678,88 @@
        9,     9,     9,     9,     9,     9,     9,     9,     9,     9,
        9,     9,     9,     9,     9,     9,     9,     9,     9,     9,
        9,     9,    59,    58,     0,   124,   120,   125,   133,   132,
-       0,     0,    11,    30,    11,   159,   160,     0,    15,    69,
-      99,     0,     0,     9,    85,     0,    68,     0,    63,     9,
-      60,    66,     9,     9,     9,     0,    76,    77,     9,     0,
-      70,     0,    80,    72,    79,   107,     9,   116,   117,     0,
-     108,     0,   106,     9,     9,   128,   129,   154,   150,   149,
-     151,   136,   137,   138,   139,   140,   141,   142,   143,   144,
-     145,   146,   147,   148,   127,   135,   134,   130,     0,   131,
-     126,     8,     9,     9,     0,     0,     0,     0,    28,    19,
-       0,    24,     0,   100,     0,     0,     0,     0,     0,     9,
-       0,     0,     0,     6,     0,    54,    55,    56,    65,    73,
-       0,    75,    71,   112,   110,     9,   109,     9,   111,     0,
-     153,   124,   123,   122,   121,    22,    21,    39,    40,     9,
-      27,    26,     0,     0,     0,     0,     9,     0,     0,     0,
-      11,    33,    34,    35,    32,    37,    36,   158,   161,   104,
-     103,   101,   102,     0,    86,     0,    92,    93,    94,    95,
-      96,    87,    91,     9,     0,    74,   114,   113,   124,     9,
-      41,    29,     9,   157,     0,     0,     0,     0,    38,    31,
-     105,     9,     0,     0,     9,   115,   152,     9,     0,     0,
-      43,     0,    51,    50,     0,    53,    52,   156,   155,    89,
-       9,    98,    97,     9,   118,    49,    20,    45,     9,    25,
-       9,     0,     0,     0,    47,     9,    88,    44,     0,     0,
+       0,    11,    30,   159,   160,     0,    15,    69,    99,     0,
+       0,     9,    85,     0,    68,     0,    63,     9,    60,    66,
+       9,     9,     9,     0,    76,    77,     9,     0,    70,     0,
+      80,    72,    79,   107,     9,   116,   117,     0,   108,     0,
+     106,     9,     9,   128,   129,   154,   150,   149,   151,   136,
+     137,   138,   139,   140,   141,   142,   143,   144,   145,   146,
+     147,   148,   127,   135,   134,   130,     0,   131,   126,     8,
+       9,     9,     0,     0,     0,    19,     0,    11,     0,     0,
+     100,     0,     0,     0,     0,     0,     9,     0,     0,     0,
+       6,     0,    54,    55,    56,    65,    73,     0,    75,    71,
+     112,   110,     9,   109,     9,   111,     0,   153,   124,   123,
+     122,   121,    22,    21,    39,    40,     9,     0,    28,    24,
+       0,     0,     9,     0,     0,     0,    11,    33,    34,    35,
+      32,    37,    36,   158,   161,   104,   103,   101,   102,     0,
+      86,     0,    92,    93,    94,    95,    96,    87,    91,     9,
+       0,    74,   114,   113,   124,     9,    41,    27,    26,     0,
+       0,   157,     0,     0,     0,     0,    38,    31,   105,     9,
+       0,     0,     9,   115,   152,     9,     0,     0,    43,    29,
+       9,    51,    50,     0,    53,    52,   156,   155,    89,     9,
+      98,    97,     9,   118,    49,    20,    45,     9,     0,     9,
+       0,     0,     0,    25,    47,     9,    88,    44,     0,     0,
       46,     9,    90,    48
 };
 
 /* YYDEFGOTO[NTERM-NUM]. */
-static const short yydefgoto[] =
+static const short int yydefgoto[] =
 {
-      -1,     5,     6,     7,     8,   234,    20,     9,    31,    92,
-      93,    94,   213,   170,   220,   209,   268,   269,   221,   298,
-     270,   222,   223,   115,    84,    41,    42,    43,    44,    45,
-      46,    47,    48,    49,   182,    50,   243,   283,    51,    14,
-      54,    55,    56,   265,    85,   164,    86,    87,    88,    89,
-     225,   226,   127,    97
+      -1,     5,     6,     7,     8,   230,    20,     9,    31,    91,
+      92,   167,   250,   168,   216,   206,   266,   267,   217,   298,
+     268,   218,   219,   113,    84,    41,    42,    43,    44,    45,
+      46,    47,    48,    49,   179,    50,   239,   282,    51,    14,
+      54,    55,    56,   263,    85,   162,    86,    87,    88,    89,
+     221,   222,   125,    95
 };
 
 /* YYPACT[STATE-NUM] -- Index in YYTABLE of the portion describing
    STATE-NUM.  */
-#define YYPACT_NINF -170
-static const short yypact[] =
+#define YYPACT_NINF -167
+static const short int yypact[] =
 {
-     186,   226,   -27,   -11,    57,   114,  -170,  -170,  -170,  -170,
-      -2,   124,  -170,  -170,  -170,  -170,  -170,   151,   151,   151,
-     213,   158,  -170,  -170,  -170,  -170,   322,    37,   319,  -170,
-    -170,     2,   211,    46,   173,  -170,   178,   185,  -170,   176,
-    -170,  -170,    43,   187,   330,  -170,   372,   163,  -170,  -170,
-    -170,  -170,   117,  -170,   103,   236,   194,  -170,  -170,  -170,
-    -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,
-    -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,
-    -170,  -170,  -170,  -170,   392,   206,  -170,  -170,  -170,  -170,
-     120,   162,  -170,  -170,  -170,  -170,  -170,   199,  -170,  -170,
-    -170,   223,   138,  -170,  -170,   249,  -170,   102,  -170,  -170,
-    -170,  -170,  -170,  -170,  -170,   366,  -170,  -170,   372,   163,
-     151,   163,  -170,   151,  -170,  -170,  -170,  -170,   151,   130,
-    -170,   273,  -170,  -170,  -170,   151,   151,   151,   151,   151,
+     215,   193,   -43,   -19,    -9,   135,  -167,  -167,  -167,  -167,
+     137,     5,  -167,  -167,  -167,  -167,  -167,   151,   151,   151,
+      94,   163,  -167,  -167,  -167,  -167,   323,    26,   318,  -167,
+    -167,   167,    97,     0,   183,  -167,   186,   200,  -167,   190,
+    -167,  -167,    52,   165,   428,  -167,   329,   157,  -167,  -167,
+    -167,  -167,   -32,  -167,   100,   180,   211,  -167,  -167,  -167,
+    -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,
+    -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,
+    -167,  -167,  -167,  -167,   391,   114,  -167,  -167,  -167,  -167,
+     118,  -167,   221,  -167,  -167,   248,  -167,  -167,  -167,   247,
+     115,  -167,  -167,    14,  -167,    50,  -167,  -167,  -167,  -167,
+    -167,  -167,  -167,   365,  -167,  -167,   329,   157,   151,   157,
+    -167,   151,  -167,  -167,  -167,  -167,   151,   236,  -167,   216,
+    -167,  -167,  -167,   151,   151,   151,   151,   151,   151,   151,
      151,   151,   151,   151,   151,   151,   151,   151,   151,   151,
-     151,   151,   151,   151,   151,   151,   151,   151,   272,   151,
-    -170,  -170,  -170,  -170,   361,   179,   105,   183,    35,   213,
-     122,   213,   227,  -170,   168,   215,   225,   229,   322,   173,
-     176,   220,    26,  -170,   322,   151,   151,   151,  -170,   151,
-     163,   151,   151,   151,  -170,  -170,  -170,  -170,   151,   319,
-    -170,   -33,   151,   151,  -170,  -170,  -170,  -170,  -170,  -170,
-    -170,  -170,   281,   142,   242,   300,  -170,   324,   334,   342,
-    -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,  -170,
-    -170,  -170,  -170,   307,   151,   362,  -170,  -170,  -170,  -170,
-    -170,  -170,  -170,  -170,   240,   151,   151,   151,   169,  -170,
-     164,  -170,  -170,  -170,   216,   164,   219,   222,  -170,   213,
-    -170,  -170,    85,   115,  -170,  -170,   151,  -170,   335,    42,
-    -170,    50,  -170,  -170,    47,  -170,  -170,  -170,  -170,  -170,
-    -170,  -170,  -170,  -170,   151,   151,  -170,  -170,  -170,  -170,
-    -170,   115,    24,   164,   151,  -170,  -170,  -170,     1,    25,
-    -170,  -170,  -170,   151
+     151,   151,   151,   151,   151,   151,   271,   151,  -167,  -167,
+    -167,  -167,   360,   153,   103,    94,   184,  -167,   124,   220,
+    -167,   203,   205,   214,   217,   323,   183,   190,   257,    41,
+    -167,   323,   151,   151,   151,  -167,   151,   157,   151,   151,
+     151,  -167,  -167,  -167,  -167,   151,   318,  -167,   -21,   151,
+     151,  -167,  -167,  -167,  -167,  -167,  -167,   164,    16,    94,
+     226,   283,  -167,   286,   292,   332,  -167,  -167,  -167,  -167,
+    -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,   273,
+     151,   335,  -167,  -167,  -167,  -167,  -167,  -167,  -167,  -167,
+     239,   151,   151,   151,   270,  -167,   195,  -167,  -167,   369,
+     -10,  -167,   197,   195,   207,   210,  -167,    94,  -167,  -167,
+      87,   109,  -167,  -167,   151,  -167,   314,    35,  -167,  -167,
+    -167,  -167,  -167,    81,  -167,  -167,  -167,  -167,  -167,  -167,
+    -167,  -167,  -167,   151,   151,  -167,  -167,  -167,    37,  -167,
+     109,    25,   195,  -167,   151,  -167,  -167,  -167,   213,    27,
+    -167,  -167,  -167,   151
 };
 
 /* YYPGOTO[NTERM-NUM].  */
-static const short yypgoto[] =
+static const short int yypgoto[] =
 {
-    -170,  -170,  -170,  -170,  -170,    -1,   -90,  -170,  -170,   207,
-    -170,  -170,  -170,  -170,  -170,   201,  -170,   157,  -170,  -170,
-     123,  -170,  -170,  -170,  -170,  -169,  -170,   231,   312,   -94,
-     375,   -36,   -38,  -170,   203,  -170,   180,   129,  -170,   399,
-    -170,   389,  -170,  -170,   -51,  -170,   280,   363,  -170,  -170,
-    -170,  -170,    -7,  -170
+    -167,  -167,  -167,  -167,  -167,    -1,   -83,  -167,  -167,   208,
+    -167,  -167,  -167,  -167,  -167,   136,  -167,   132,  -167,  -167,
+      95,  -167,  -167,  -167,  -167,  -166,  -167,   230,   285,   -94,
+     345,   -29,   -34,  -167,   182,  -167,   154,   125,  -167,   374,
+    -167,   364,  -167,  -167,   -39,  -167,   275,   357,  -167,  -167,
+    -167,  -167,    -7,  -167
 };
 
 /* YYTABLE[YYPACT[STATE-NUM]].  What to do in state STATE-NUM.  If
@@ -760,102 +767,102 @@
    number is the opposite.  If zero, do what YYDEFACT says.
    If YYTABLE_NINF, syntax error.  */
 #define YYTABLE_NINF -120
-static const short yytable[] =
+static const short int yytable[] =
 {
-      11,   224,   169,    23,   171,    17,    18,    19,   119,   124,
-     121,    26,    27,    34,    28,    35,    36,    37,    38,    39,
-      40,   188,    90,   162,    33,    96,    12,    91,    24,    24,
-     249,   163,   236,   237,   238,   239,   240,   105,    52,    24,
-     107,    24,    13,   287,   108,   120,   123,   212,   287,    53,
-      24,    21,   128,    22,    24,   300,   135,   136,   137,   138,
-     139,   140,   141,   142,   143,   144,   145,   146,   147,   148,
-     149,   150,   151,   152,   153,   154,   155,   156,   157,   158,
-     159,   124,   190,   124,   233,   296,   302,   241,   242,   166,
-     168,   236,   237,   238,   239,   240,    13,   -42,   288,   109,
-     290,    98,   178,   288,   129,   289,    24,   201,   184,    24,
-      15,   185,   186,   187,    16,    53,   207,   189,   191,    24,
-     192,   165,    -2,   214,    -9,   193,   281,   282,    24,   301,
-     259,    -9,   198,   199,    34,    25,    35,    36,    37,    38,
-      39,    40,    90,   215,   216,   217,   279,   242,   248,   174,
-     175,   176,   124,   207,   208,    24,   183,   130,   206,    32,
-     211,   202,   203,   167,   122,   228,    -9,    -9,    24,    -9,
-      21,   125,   126,    -9,    -9,    -9,   267,    35,    36,    37,
-      38,    -9,    -9,    21,   194,   195,   177,   218,   111,   245,
-     100,   208,    99,   101,   246,   106,   247,   104,   264,   -57,
-     172,   -57,   -57,   -57,   -57,   -57,   -57,   253,   250,   134,
-       1,    -9,     2,     3,     4,   255,    -9,    29,    30,    -9,
-      -9,    -9,    -9,  -119,  -119,   162,    -9,    10,   102,   103,
-      -9,   229,    21,   163,   205,   173,    21,    -9,   210,   235,
-     -61,   111,   263,   -61,   112,   113,   114,   273,   266,   276,
-     278,   271,   -57,    24,   -57,   -57,   -57,   -57,   -57,   -57,
-     161,   179,   162,   284,    21,    95,   285,   180,    40,    21,
-     163,   272,    21,   200,   275,    21,    24,   277,   230,   291,
-      21,   227,   292,    57,    58,   251,    59,   293,   231,   294,
-     132,   133,   232,   -62,   299,    21,   -62,   112,   113,   114,
-     303,   254,    60,    61,    62,    63,    64,    65,    66,    67,
-      68,    69,    70,    71,    72,    73,    74,    75,    76,    77,
-      78,    79,    80,    24,    81,   256,    24,   196,   197,    82,
-      57,    58,    83,    59,    34,   257,    35,    36,    37,    38,
-      39,    40,   116,   258,    35,    36,    37,    38,   117,    60,
-      61,    62,    63,    64,    65,    66,    67,    68,    69,    70,
-      71,    72,    73,    74,    75,    76,    77,    78,    79,    80,
-     260,    81,    57,    58,   261,    59,    82,   219,    34,    83,
-      35,    36,    37,    38,    39,    40,    35,    36,    37,    38,
-     286,    60,    61,    62,    63,    64,    65,    66,    67,    68,
+      11,   204,   220,    23,    24,    17,    18,    19,   165,    24,
+      12,    26,    27,   122,    28,   117,    25,   119,    24,   185,
+      24,    21,   123,   124,    33,    94,   176,    52,   249,    24,
+      24,    24,   177,    40,    13,   160,   286,   103,    53,   205,
+     105,    24,   245,   161,    15,   118,   121,   232,   233,   234,
+     235,   236,   126,   106,    24,    96,   133,   134,   135,   136,
+     137,   138,   139,   140,   141,   142,   143,   144,   145,   146,
+     147,   148,   149,   150,   151,   152,   153,   154,   155,   156,
+     157,   229,   286,   122,   209,   122,   296,   187,   302,   164,
+     -42,   287,   293,   232,   233,   234,   235,   236,    29,    30,
+     175,   127,   237,   238,   180,    13,   181,    24,   107,   182,
+     183,   184,    53,    24,   204,   186,   188,   198,   189,   163,
+     280,   281,    -9,   190,    -2,   210,   171,   172,   173,    -9,
+     195,   196,   301,   257,   289,    16,    34,   287,    35,    36,
+      37,    38,    39,    40,    90,   211,   212,   213,   278,   238,
+      21,    93,   205,   122,   128,    24,   203,   244,   120,   199,
+     200,    -9,   224,   174,    32,   208,   109,    -9,   159,    -9,
+     160,    35,    36,    37,    38,    -9,    -9,   -57,   161,   -57,
+     -57,   -57,   -57,   -57,   -57,   207,   241,    90,    -9,   214,
+      21,   242,    22,   243,    10,    -9,    -9,    -9,    98,    24,
+     248,    99,    97,   251,    -9,   246,    21,   265,   202,   104,
+      -9,   253,   102,    -9,    -9,    -9,    -9,    21,   -61,   247,
+      -9,   -61,   110,   111,   112,    34,   132,    35,    36,    37,
+      38,    39,    40,    -9,   130,   131,   100,   101,   261,     1,
+     109,     2,     3,     4,   264,   272,   166,   275,   277,   169,
+      21,   -57,   271,   -57,   -57,   -57,   -57,   -57,   -57,   170,
+      21,   283,   274,    21,   284,   276,   225,   300,   226,   288,
+     193,   194,   197,    21,   223,    24,   231,   227,   290,    21,
+     228,   291,    57,    58,   252,    59,   292,   254,   294,    21,
+     191,   192,   -62,   255,   299,   -62,   110,   111,   112,   262,
+     303,    60,    61,    62,    63,    64,    65,    66,    67,    68,
       69,    70,    71,    72,    73,    74,    75,    76,    77,    78,
-      79,    80,   274,    81,   252,   244,   297,   181,    82,   118,
-     295,    83,    60,    61,    62,    63,    64,    65,    66,    67,
-      68,    69,    70,    71,    72,    73,    74,    75,   262,    77,
-      78,   110,   280,   131,   204,     0,     0,   160
+      79,    80,    24,    81,  -119,  -119,   160,    24,    82,    57,
+      58,    83,    59,   256,   161,    34,   258,    35,    36,    37,
+      38,    39,    40,    35,    36,    37,    38,   259,    60,    61,
+      62,    63,    64,    65,    66,    67,    68,    69,    70,    71,
+      72,    73,    74,    75,    76,    77,    78,    79,    80,   285,
+      81,    57,    58,   269,    59,    82,   215,    34,    83,    35,
+      36,    37,    38,    39,    40,   273,   270,   297,   178,   116,
+      60,    61,    62,    63,    64,    65,    66,    67,    68,    69,
+      70,    71,    72,    73,    74,    75,    76,    77,    78,    79,
+      80,   240,    81,   260,   279,   295,   108,    82,   129,     0,
+      83,    60,    61,    62,    63,    64,    65,    66,    67,    68,
+      69,    70,    71,    72,    73,    74,    75,   201,    77,    78,
+     114,   158,    35,    36,    37,    38,   115
 };
 
-static const short yycheck[] =
+static const short int yycheck[] =
 {
-       1,   170,    92,    10,    94,     6,     7,     8,    44,    47,
-      46,    12,    13,    12,    15,    14,    15,    16,    17,    18,
-      19,   115,    20,    56,    25,    32,    53,    25,     4,     4,
-      63,    64,     6,     7,     8,     9,    10,    38,     1,     4,
-      41,     4,    53,     1,     1,    46,    47,    12,     1,    12,
-       4,    53,    53,    55,     4,    54,    57,    58,    59,    60,
+       1,    11,   168,    10,     4,     6,     7,     8,    91,     4,
+      53,    12,    13,    47,    15,    44,    11,    46,     4,   113,
+       4,    53,    54,    55,    25,    32,    12,     1,    12,     4,
+       4,     4,    18,    19,    53,    56,     1,    38,    12,    49,
+      41,     4,    63,    64,    53,    46,    47,     6,     7,     8,
+       9,    10,    53,     1,     4,    55,    57,    58,    59,    60,
       61,    62,    63,    64,    65,    66,    67,    68,    69,    70,
       71,    72,    73,    74,    75,    76,    77,    78,    79,    80,
-      81,   119,   118,   121,   178,    61,    61,    61,    62,    90,
-      91,     6,     7,     8,     9,    10,    53,    55,    56,    56,
-      53,    55,   103,    56,     1,    55,     4,   158,   109,     4,
-      53,   112,   113,   114,     0,    12,    11,   118,   119,     4,
-     121,     1,     0,     1,     4,   126,    11,    12,     4,   298,
-     220,    11,   133,   134,    12,    11,    14,    15,    16,    17,
-      18,    19,    20,    21,    22,    23,    61,    62,   199,    11,
-      12,    13,   190,    11,    49,     4,    54,    54,   165,     1,
-     167,   162,   163,     1,     1,   172,     4,     4,     4,    49,
-      53,    54,    55,    11,    12,    12,    12,    14,    15,    16,
-      17,    18,    19,    53,    54,    55,    48,    65,     1,   190,
-      12,    49,    19,    15,   195,    19,   197,    12,    29,    12,
-       1,    14,    15,    16,    17,    18,    19,   214,   209,    15,
-      24,    49,    26,    27,    28,   216,    53,     4,     5,    56,
-      57,    58,    59,    54,    55,    56,    63,     1,    50,    51,
-       4,    63,    53,    64,    55,    12,    53,    11,    55,    19,
-      53,     1,   243,    56,    57,    58,    59,   254,   249,   256,
-     257,   252,    12,     4,    14,    15,    16,    17,    18,    19,
-      54,    12,    56,   264,    53,    54,   267,    18,    19,    53,
-      64,    55,    53,     1,    55,    53,     4,    55,    63,   280,
-      53,    54,   283,    11,    12,     4,    14,   288,    63,   290,
-      54,    55,    63,    53,   295,    53,    56,    57,    58,    59,
-     301,     1,    30,    31,    32,    33,    34,    35,    36,    37,
-      38,    39,    40,    41,    42,    43,    44,    45,    46,    47,
-      48,    49,    50,     4,    52,     1,     4,    54,    55,    57,
-      11,    12,    60,    14,    12,     1,    14,    15,    16,    17,
-      18,    19,    12,     1,    14,    15,    16,    17,    18,    30,
-      31,    32,    33,    34,    35,    36,    37,    38,    39,    40,
-      41,    42,    43,    44,    45,    46,    47,    48,    49,    50,
-      63,    52,    11,    12,    12,    14,    57,   170,    12,    60,
-      14,    15,    16,    17,    18,    19,    14,    15,    16,    17,
-      55,    30,    31,    32,    33,    34,    35,    36,    37,    38,
+      81,   175,     1,   117,   167,   119,    61,   116,    61,    90,
+      55,    56,    55,     6,     7,     8,     9,    10,     4,     5,
+     101,     1,    61,    62,    54,    53,   107,     4,    56,   110,
+     111,   112,    12,     4,    11,   116,   117,   156,   119,     1,
+      11,    12,     4,   124,     0,     1,    11,    12,    13,    11,
+     131,   132,   298,   216,    53,     0,    12,    56,    14,    15,
+      16,    17,    18,    19,    20,    21,    22,    23,    61,    62,
+      53,    54,    49,   187,    54,     4,   163,   196,     1,   160,
+     161,     4,   169,    48,     1,   166,     1,    49,    54,    12,
+      56,    14,    15,    16,    17,    18,    19,    12,    64,    14,
+      15,    16,    17,    18,    19,     1,   187,    20,     4,    65,
+      53,   192,    55,   194,     1,    11,    12,     4,    12,     4,
+     207,    15,    19,   210,    11,   206,    53,    12,    55,    19,
+      53,   212,    12,    56,    57,    58,    59,    53,    53,    55,
+      63,    56,    57,    58,    59,    12,    15,    14,    15,    16,
+      17,    18,    19,    49,    54,    55,    50,    51,   239,    24,
+       1,    26,    27,    28,   245,   252,    25,   254,   255,     1,
+      53,    12,    55,    14,    15,    16,    17,    18,    19,    12,
+      53,   262,    55,    53,   265,    55,    63,    54,    63,   270,
+      54,    55,     1,    53,    54,     4,    19,    63,   279,    53,
+      63,   282,    11,    12,     1,    14,   287,     1,   289,    53,
+      54,    55,    53,     1,   295,    56,    57,    58,    59,    29,
+     301,    30,    31,    32,    33,    34,    35,    36,    37,    38,
       39,    40,    41,    42,    43,    44,    45,    46,    47,    48,
-      49,    50,   255,    52,   213,   184,   293,   105,    57,    44,
-     291,    60,    30,    31,    32,    33,    34,    35,    36,    37,
-      38,    39,    40,    41,    42,    43,    44,    45,   235,    47,
-      48,    42,   262,    54,   164,    -1,    -1,    84
+      49,    50,     4,    52,    54,    55,    56,     4,    57,    11,
+      12,    60,    14,     1,    64,    12,    63,    14,    15,    16,
+      17,    18,    19,    14,    15,    16,    17,    12,    30,    31,
+      32,    33,    34,    35,    36,    37,    38,    39,    40,    41,
+      42,    43,    44,    45,    46,    47,    48,    49,    50,    55,
+      52,    11,    12,     4,    14,    57,   168,    12,    60,    14,
+      15,    16,    17,    18,    19,   253,   250,   292,   103,    44,
+      30,    31,    32,    33,    34,    35,    36,    37,    38,    39,
+      40,    41,    42,    43,    44,    45,    46,    47,    48,    49,
+      50,   181,    52,   231,   260,   290,    42,    57,    54,    -1,
+      60,    30,    31,    32,    33,    34,    35,    36,    37,    38,
+      39,    40,    41,    42,    43,    44,    45,   162,    47,    48,
+      12,    84,    14,    15,    16,    17,    18
 };
 
 /* YYSTOS[STATE-NUM] -- The (internal number of the) accessing
@@ -871,27 +878,27 @@
       30,    31,    32,    33,    34,    35,    36,    37,    38,    39,
       40,    41,    42,    43,    44,    45,    46,    47,    48,    49,
       50,    52,    57,    60,    90,   110,   112,   113,   114,   115,
-      20,    25,    75,    76,    77,    54,   118,   119,    55,    19,
-      12,    15,    50,    51,    12,    71,    19,    71,     1,    56,
-     105,     1,    57,    58,    59,    89,    12,    18,    96,    97,
-      71,    97,     1,    71,    98,    54,    55,   118,    71,     1,
-      54,   107,    54,    55,    15,    71,    71,    71,    71,    71,
-      71,    71,    71,    71,    71,    71,    71,    71,    71,    71,
+      20,    75,    76,    54,   118,   119,    55,    19,    12,    15,
+      50,    51,    12,    71,    19,    71,     1,    56,   105,     1,
+      57,    58,    59,    89,    12,    18,    96,    97,    71,    97,
+       1,    71,    98,    54,    55,   118,    71,     1,    54,   107,
+      54,    55,    15,    71,    71,    71,    71,    71,    71,    71,
       71,    71,    71,    71,    71,    71,    71,    71,    71,    71,
-     113,    54,    56,    64,   111,     1,    71,     1,    71,    72,
-      79,    72,     1,    12,    11,    12,    13,    48,    71,    12,
-      18,    94,   100,    54,    71,    71,    71,    71,    95,    71,
-      97,    71,    71,    71,    54,    55,    54,    55,    71,    71,
-       1,   110,    71,    71,   112,    55,   118,    11,    49,    81,
-      55,   118,    12,    78,     1,    21,    22,    23,    65,    75,
-      80,    84,    87,    88,    91,   116,   117,    54,   118,    63,
-      63,    63,    63,    95,    71,    19,     6,     7,     8,     9,
-      10,    61,    62,   102,    93,    71,    71,    71,   110,    63,
-      71,     4,    81,   118,     1,    71,     1,     1,     1,    72,
-      63,    12,   100,    71,    29,   109,    71,    12,    82,    83,
-      86,    71,    55,   118,    83,    55,   118,    55,   118,    61,
-     102,    11,    12,   103,    71,    71,    55,     1,    56,    55,
-      53,    71,    71,    71,    71,   103,    61,    86,    85,    71,
+      71,    71,    71,    71,    71,    71,    71,    71,   113,    54,
+      56,    64,   111,     1,    71,    72,    25,    77,    79,     1,
+      12,    11,    12,    13,    48,    71,    12,    18,    94,   100,
+      54,    71,    71,    71,    71,    95,    71,    97,    71,    71,
+      71,    54,    55,    54,    55,    71,    71,     1,   110,    71,
+      71,   112,    55,   118,    11,    49,    81,     1,    71,    72,
+       1,    21,    22,    23,    65,    75,    80,    84,    87,    88,
+      91,   116,   117,    54,   118,    63,    63,    63,    63,    95,
+      71,    19,     6,     7,     8,     9,    10,    61,    62,   102,
+      93,    71,    71,    71,   110,    63,    71,    55,   118,    12,
+      78,   118,     1,    71,     1,     1,     1,    72,    63,    12,
+     100,    71,    29,   109,    71,    12,    82,    83,    86,     4,
+      81,    55,   118,    83,    55,   118,    55,   118,    61,   102,
+      11,    12,   103,    71,    71,    55,     1,    56,    71,    53,
+      71,    71,    71,    55,    71,   103,    61,    86,    85,    71,
       54,    91,    61,    71
 };
 
@@ -918,7 +925,7 @@
 
 #define YYACCEPT	goto yyacceptlab
 #define YYABORT		goto yyabortlab
-#define YYERROR		goto yyerrlab1
+#define YYERROR		goto yyerrorlab
 
 
 /* Like YYERROR except do call yyerror.  This remains here temporarily
@@ -953,11 +960,11 @@
    are run).  */
 
 #ifndef YYLLOC_DEFAULT
-# define YYLLOC_DEFAULT(Current, Rhs, N)         \
-  Current.first_line   = Rhs[1].first_line;      \
-  Current.first_column = Rhs[1].first_column;    \
-  Current.last_line    = Rhs[N].last_line;       \
-  Current.last_column  = Rhs[N].last_column;
+# define YYLLOC_DEFAULT(Current, Rhs, N)		\
+   ((Current).first_line   = (Rhs)[1].first_line,	\
+    (Current).first_column = (Rhs)[1].first_column,	\
+    (Current).last_line    = (Rhs)[N].last_line,	\
+    (Current).last_column  = (Rhs)[N].last_column)
 #endif
 
 /* YYLEX -- calling `yylex' with the right arguments.  */
@@ -1001,17 +1008,17 @@
 
 /*------------------------------------------------------------------.
 | yy_stack_print -- Print the state stack from its BOTTOM up to its |
-| TOP (cinluded).                                                   |
+| TOP (included).                                                   |
 `------------------------------------------------------------------*/
 
 #if defined (__STDC__) || defined (__cplusplus)
 static void
-yy_stack_print (short *bottom, short *top)
+yy_stack_print (short int *bottom, short int *top)
 #else
 static void
 yy_stack_print (bottom, top)
-    short *bottom;
-    short *top;
+    short int *bottom;
+    short int *top;
 #endif
 {
   YYFPRINTF (stderr, "Stack now");
@@ -1041,9 +1048,9 @@
 #endif
 {
   int yyi;
-  unsigned int yylineno = yyrline[yyrule];
+  unsigned int yylno = yyrline[yyrule];
   YYFPRINTF (stderr, "Reducing stack by rule %d (line %u), ",
-             yyrule - 1, yylineno);
+             yyrule - 1, yylno);
   /* Print the symbols being reduced, and their result.  */
   for (yyi = yyprhs[yyrule]; 0 <= yyrhs[yyi]; yyi++)
     YYFPRINTF (stderr, "%s ", yytname [yyrhs[yyi]]);
@@ -1080,7 +1087,7 @@
    SIZE_MAX < YYSTACK_BYTES (YYMAXDEPTH)
    evaluated with infinite-precision integer arithmetic.  */
 
-#if YYMAXDEPTH == 0
+#if defined (YYMAXDEPTH) && YYMAXDEPTH == 0
 # undef YYMAXDEPTH
 #endif
 
@@ -1338,9 +1345,9 @@
      to reallocate them elsewhere.  */
 
   /* The state stack.  */
-  short	yyssa[YYINITDEPTH];
-  short *yyss = yyssa;
-  register short *yyssp;
+  short int yyssa[YYINITDEPTH];
+  short int *yyss = yyssa;
+  register short int *yyssp;
 
   /* The semantic value stack.  */
   YYSTYPE yyvsa[YYINITDEPTH];
@@ -1377,6 +1384,7 @@
   yyssp = yyss;
   yyvsp = yyvs;
 
+
   goto yysetstate;
 
 /*------------------------------------------------------------.
@@ -1402,7 +1410,7 @@
 	   these so that the &'s don't force the real ones into
 	   memory.  */
 	YYSTYPE *yyvs1 = yyvs;
-	short *yyss1 = yyss;
+	short int *yyss1 = yyss;
 
 
 	/* Each stack pointer address is followed by the size of the
@@ -1430,7 +1438,7 @@
 	yystacksize = YYMAXDEPTH;
 
       {
-	short *yyss1 = yyss;
+	short int *yyss1 = yyss;
 	union yyalloc *yyptr =
 	  (union yyalloc *) YYSTACK_ALLOC (YYSTACK_BYTES (yystacksize));
 	if (! yyptr)
@@ -2625,7 +2633,7 @@
 
     }
 
-/* Line 999 of yacc.c.  */
+/* Line 1010 of yacc.c.  */
 
 
   yyvsp -= yylen;
@@ -2667,18 +2675,33 @@
 	{
 	  YYSIZE_T yysize = 0;
 	  int yytype = YYTRANSLATE (yychar);
+	  const char* yyprefix;
 	  char *yymsg;
-	  int yyx, yycount;
+	  int yyx;
 
-	  yycount = 0;
 	  /* Start YYX at -YYN if negative to avoid negative indexes in
 	     YYCHECK.  */
-	  for (yyx = yyn < 0 ? -yyn : 0;
-	       yyx < (int) (sizeof (yytname) / sizeof (char *)); yyx++)
+	  int yyxbegin = yyn < 0 ? -yyn : 0;
+
+	  /* Stay within bounds of both yycheck and yytname.  */
+	  int yychecklim = YYLAST - yyn;
+	  int yyxend = yychecklim < YYNTOKENS ? yychecklim : YYNTOKENS;
+	  int yycount = 0;
+
+	  yyprefix = ", expecting ";
+	  for (yyx = yyxbegin; yyx < yyxend; ++yyx)
 	    if (yycheck[yyx + yyn] == yyx && yyx != YYTERROR)
-	      yysize += yystrlen (yytname[yyx]) + 15, yycount++;
-	  yysize += yystrlen ("syntax error, unexpected ") + 1;
-	  yysize += yystrlen (yytname[yytype]);
+	      {
+		yysize += yystrlen (yyprefix) + yystrlen (yytname [yyx]);
+		yycount += 1;
+		if (yycount == 5)
+		  {
+		    yysize = 0;
+		    break;
+		  }
+	      }
+	  yysize += (sizeof ("syntax error, unexpected ")
+		     + yystrlen (yytname[yytype]));
 	  yymsg = (char *) YYSTACK_ALLOC (yysize);
 	  if (yymsg != 0)
 	    {
@@ -2687,16 +2710,13 @@
 
 	      if (yycount < 5)
 		{
-		  yycount = 0;
-		  for (yyx = yyn < 0 ? -yyn : 0;
-		       yyx < (int) (sizeof (yytname) / sizeof (char *));
-		       yyx++)
+		  yyprefix = ", expecting ";
+		  for (yyx = yyxbegin; yyx < yyxend; ++yyx)
 		    if (yycheck[yyx + yyn] == yyx && yyx != YYTERROR)
 		      {
-			const char *yyq = ! yycount ? ", expecting " : " or ";
-			yyp = yystpcpy (yyp, yyq);
+			yyp = yystpcpy (yyp, yyprefix);
 			yyp = yystpcpy (yyp, yytname[yyx]);
-			yycount++;
+			yyprefix = " or ";
 		      }
 		}
 	      yyerror (yymsg);
@@ -2717,25 +2737,27 @@
       /* If just tried and failed to reuse lookahead token after an
 	 error, discard it.  */
 
-      /* Return failure if at end of input.  */
-      if (yychar == YYEOF)
+      if (yychar <= YYEOF)
         {
-	  /* Pop the error token.  */
-          YYPOPSTACK;
-	  /* Pop the rest of the stack.  */
-	  while (yyss < yyssp)
-	    {
-	      YYDSYMPRINTF ("Error: popping", yystos[*yyssp], yyvsp, yylsp);
-	      yydestruct (yystos[*yyssp], yyvsp);
-	      YYPOPSTACK;
-	    }
-	  YYABORT;
+          /* If at end of input, pop the error token,
+	     then the rest of the stack, then return failure.  */
+	  if (yychar == YYEOF)
+	     for (;;)
+	       {
+		 YYPOPSTACK;
+		 if (yyssp == yyss)
+		   YYABORT;
+		 YYDSYMPRINTF ("Error: popping", yystos[*yyssp], yyvsp, yylsp);
+		 yydestruct (yystos[*yyssp], yyvsp);
+	       }
         }
+      else
+	{
+	  YYDSYMPRINTF ("Error: discarding", yytoken, &yylval, &yylloc);
+	  yydestruct (yytoken, &yylval);
+	  yychar = YYEMPTY;
 
-      YYDSYMPRINTF ("Error: discarding", yytoken, &yylval, &yylloc);
-      yydestruct (yytoken, &yylval);
-      yychar = YYEMPTY;
-
+	}
     }
 
   /* Else will try to reuse lookahead token after shifting the error
@@ -2743,9 +2765,27 @@
   goto yyerrlab1;
 
 
-/*----------------------------------------------------.
-| yyerrlab1 -- error raised explicitly by an action.  |
-`----------------------------------------------------*/
+/*---------------------------------------------------.
+| yyerrorlab -- error raised explicitly by YYERROR.  |
+`---------------------------------------------------*/
+yyerrorlab:
+
+#ifdef __GNUC__
+  /* Pacify GCC when the user code never invokes YYERROR and the label
+     yyerrorlab therefore never appears in user code.  */
+  if (0)
+     goto yyerrorlab;
+#endif
+
+  yyvsp -= yylen;
+  yyssp -= yylen;
+  yystate = *yyssp;
+  goto yyerrlab1;
+
+
+/*-------------------------------------------------------------.
+| yyerrlab1 -- common code for both syntax error and YYERROR.  |
+`-------------------------------------------------------------*/
 yyerrlab1:
   yyerrstatus = 3;	/* Each real token shifted decrements this.  */
 
@@ -2769,9 +2809,8 @@
 
       YYDSYMPRINTF ("Error: popping", yystos[*yyssp], yyvsp, yylsp);
       yydestruct (yystos[yystate], yyvsp);
-      yyvsp--;
-      yystate = *--yyssp;
-
+      YYPOPSTACK;
+      yystate = *yyssp;
       YY_STACK_PRINT (yyss, yyssp);
     }
 
--- kdelibs-3.5.2/khtml/css/parser.h	2005-10-10 11:06:13.000000000 -0400
+++ kdelibs-3.5.2-new/khtml/css/parser.h	2006-04-14 15:43:17.000000000 -0400
@@ -1,7 +1,7 @@
-/* A Bison parser, made by GNU Bison 1.875a.  */
+/* A Bison parser, made by GNU Bison 1.875d.  */
 
 /* Skeleton parser for Yacc-like parsing with Bison,
-   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003 Free Software Foundation, Inc.
+   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.
 
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
@@ -15,8 +15,8 @@
 
    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
-   Foundation, Inc., 51 Franklin Street, Fifth Floor,
-   Boston, MA 02110-1301, USA.  */
+   Foundation, Inc., 59 Temple Place - Suite 330,
+   Boston, MA 02111-1307, USA.  */
 
 /* As a special exception, when this file is copied by Bison into a
    Bison output file, you may use that output file without restriction.
@@ -148,7 +148,7 @@
     Value value;
     ValueList *valueList;
 } YYSTYPE;
-/* Line 1240 of yacc.c.  */
+/* Line 1285 of yacc.c.  */
 
 # define yystype YYSTYPE /* obsolescent; will be withdrawn */
 # define YYSTYPE_IS_DECLARED 1
--- kdelibs-3.5.2/khtml/css/parser.y	2006-03-17 05:19:15.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/css/parser.y	2006-04-14 15:43:17.000000000 -0400
@@ -252,7 +252,7 @@
 %%
 
 stylesheet:
-    maybe_charset maybe_sgml import_list maybe_namespace rule_list
+    maybe_charset maybe_sgml import_list namespace_list rule_list
   | khtml_rule maybe_space
   | khtml_decls maybe_space
   | khtml_value maybe_space
@@ -349,9 +349,9 @@
     }
   ;
 
-maybe_namespace
-  : /* empty */ %prec UNIMPORTANT_TOK
-  | namespace maybe_sgml
+namespace_list:
+    /* empty */ %prec UNIMPORTANT_TOK
+  | namespace_list namespace maybe_sgml
 ;
 
 namespace:
--- kdelibs-3.5.2/khtml/ecma/kjs_proxy.cpp	2006-03-17 05:19:13.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/ecma/kjs_proxy.cpp	2006-04-14 15:43:16.000000000 -0400
@@ -20,6 +20,16 @@
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
  */
 
+#include <config.h>
+
+#if defined(HAVE_VALGRIND_MEMCHECK_H) && !defined(NDEBUG)
+
+#include <valgrind/memcheck.h>
+#define VALGRIND_SUPPORT
+
+#endif
+
+
 #include "kjs_proxy.h"
 
 #include "kjs_window.h"
@@ -369,6 +379,13 @@
 
 void KJSCPUGuard::start(unsigned int ms, unsigned int i_ms)
 {
+#ifdef VALGRIND_SUPPORT
+    if (RUNNING_ON_VALGRIND) {
+        ms   *= 50;
+        i_ms *= 50;
+    }
+#endif
+
   oldAlarmHandler = signal(SIGVTALRM, alarmHandler);
   itimerval tv = {
       { i_ms / 1000, (i_ms % 1000) * 1000 },
--- kdelibs-3.5.2/khtml/ecma/kjs_window.cpp	2006-03-17 05:19:13.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/ecma/kjs_window.cpp	2006-04-14 15:43:16.000000000 -0400
@@ -106,6 +106,8 @@
     FrameArray(ExecState *exec, KHTMLPart *p)
       : ObjectImp(exec->interpreter()->builtinObjectPrototype()), part(p) { }
     virtual Value get(ExecState *exec, const Identifier &propertyName) const;
+    virtual Value call(ExecState *exec, Object &thisObj, const List &args);
+    virtual bool implementsCall() const { return true; }
   private:
     QGuardedPtr<KHTMLPart> part;
   };
@@ -2231,6 +2233,19 @@
   return ObjectImp::get(exec, p);
 }
 
+Value FrameArray::call(ExecState *exec, Object &/*thisObj*/, const List &args)
+{
+    //IE supports a subset of the get functionality as call...
+    //... basically, when the return is a window, it supports that, otherwise it 
+    //errors out. We do a cheap-and-easy emulation of that, and just do the same
+    //thing as get does.
+    if (args.size() == 1)
+        return get(exec, Identifier(args[0].toString(exec)));
+
+    return Undefined();
+}
+
+
 ////////////////////// Location Object ////////////////////////
 
 const ClassInfo Location::info = { "Location", 0, &LocationTable, 0 };
--- kdelibs-3.5.2/khtml/html/html_elementimpl.cpp	2006-03-17 05:19:11.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/html/html_elementimpl.cpp	2006-04-14 15:43:15.000000000 -0400
@@ -182,11 +182,15 @@
           while( l && !s->isSpace() )
             l--,s++;
           setHasClassList(l);
-        } else
+          setHasClass(true);
+        } else {
           setHasClassList(false);                 
-    // no break                                         
+          setHasClass(false);
+        }
+        setChanged(); // in case of a CSS selector on class
+        break;
     case ATTR_NAME:
-        setChanged(); // in case of a CSS selector on class/name
+        setChanged(); // in case of a CSS selector on name
         getDocument()->incDOMTreeVersion();
         break;
     case ATTR_STYLE:
--- kdelibs-3.5.2/khtml/html/html_formimpl.cpp	2006-03-17 05:19:11.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/html/html_formimpl.cpp	2006-04-14 15:43:15.000000000 -0400
@@ -630,7 +630,9 @@
                     // otherwise we might have a potential security problem
                     // by saving passwords under wrong lookup key.
 
-                    getDocument()->view()->part()->saveToWallet(key, m_walletMap);
+                    if (view->part()) {
+                        view->part()->saveToWallet(key, m_walletMap);
+                    }
                 } else if ( savePassword == KDialogBase::No ) {
                     view->addNonPasswordStorableSite(formUrl.host());
                 }
--- kdelibs-3.5.2/khtml/html/htmltokenizer.cpp	2006-01-19 12:06:49.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/html/htmltokenizer.cpp	2006-04-14 15:43:15.000000000 -0400
@@ -7,7 +7,8 @@
               (C) 1999 Lars Knoll (knoll@kde.org)
               (C) 1999 Antti Koivisto (koivisto@kde.org)
               (C) 2001-2003 Dirk Mueller (mueller@kde.org)
-              (C) 2002 Apple Computer, Inc.
+              (C) 2004 Apple Computer, Inc.
+              (C) 2006 Germain Garand (germain@ebooksfrance.org)
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -90,38 +91,36 @@
 #define fixUpChar(x) \
             switch ((x).unicode()) \
             { \
-            /* ALL of these should be changed to Unicode SOON */ \
             case 0x80: (x) = 0x20ac; break; \
-            case 0x82: (x) = ',';    break; \
+            case 0x82: (x) = 0x201a;    break; \
             case 0x83: (x) = 0x0192; break; \
-            case 0x84: (x) = '"';    break; \
+            case 0x84: (x) = 0x201e;    break; \
             case 0x85: (x) = 0x2026; break; \
             case 0x86: (x) = 0x2020; break; \
             case 0x87: (x) = 0x2021; break; \
             case 0x88: (x) = 0x02C6; break; \
             case 0x89: (x) = 0x2030; break; \
             case 0x8A: (x) = 0x0160; break; \
-            case 0x8b: (x) = '<';    break; \
+            case 0x8b: (x) = 0x2039;    break; \
             case 0x8C: (x) = 0x0152; break; \
             case 0x8E: (x) = 0x017D; break; \
-            case 0x91: (x) = '\'';   break; \
-            case 0x92: (x) = '\'';   break; \
-            case 0x93: (x) = '"';    break; \
-            case 0x94: (x) = '"';    break; \
-            case 0x95: (x) = '*';    break; \
-            case 0x96: (x) = '-';    break; \
-            case 0x97: (x) = '-';    break; \
-            case 0x98: (x) = '~';    break; \
+            case 0x91: (x) = 0x2018;   break; \
+            case 0x92: (x) = 0x2019;   break; \
+            case 0x93: (x) = 0x201C;    break; \
+            case 0x94: (x) = 0X201D;    break; \
+            case 0x95: (x) = 0x2022;    break; \
+            case 0x96: (x) = 0x2013;    break; \
+            case 0x97: (x) = 0x2014;    break; \
+            case 0x98: (x) = 0x02DC;    break; \
             case 0x99: (x) = 0x2122; break; \
             case 0x9A: (x) = 0x0161; break; \
-            case 0x9b: (x) = '>';    break; \
+            case 0x9b: (x) = 0x203A;    break; \
             case 0x9C: (x) = 0x0153; break; \
             case 0x9E: (x) = 0x017E; break; \
             case 0x9F: (x) = 0x0178; break; \
             default: break; \
             }
 #endif
-
 // ----------------------------------------------------------------------------
 
 HTMLTokenizer::HTMLTokenizer(DOM::DocumentPtr *_doc, KHTMLView *_view)
@@ -387,27 +386,30 @@
     currToken.tid = ID_SCRIPT + ID_CLOSE_TAG;
     processToken();
 
-    TokenizerString prependingSrc;
+    // Scripts following a frameset element should not be executed or even loaded in the case of extern scripts.
+    bool followingFrameset = (parser->doc()->body() && parser->doc()->body()->id() == ID_FRAMESET);
+    bool deferredScript = false;
 
-    if ( !parser->skipMode() ) {
+    if ( !parser->skipMode() && !followingFrameset) {
         CachedScript* cs = 0;
 
         // forget what we just got, load from src url instead
         if ( !currentScriptSrc.isEmpty() &&
-             (cs = parser->doc()->docLoader()->requestScript(currentScriptSrc, scriptSrcCharset) ))
+             (cs = parser->doc()->docLoader()->requestScript(currentScriptSrc, scriptSrcCharset) )) {
             cachedScript.enqueue(cs);
+        }
 
         if (cs) {
-            pendingSrc.prepend(src);
+            pendingQueue.push(src);
+            uint scriptCount = cachedScript.count();
             setSrc(TokenizerString());
             scriptCodeSize = scriptCodeResync = 0;
             cs->ref(this);
+            if (cachedScript.count() == scriptCount)
+                deferredScript = true;
         }
         else if (currentScriptSrc.isEmpty() && view && javascript ) {
-            if ( !m_executingScript )
-                pendingSrc.prepend(src);
-            else
-                prependingSrc = src;
+            pendingQueue.push(src);
             setSrc(TokenizerString());
             scriptCodeSize = scriptCodeResync = 0;
             scriptExecution( exScript, QString::null, tagStartLineno /*scriptStartLineno*/ );
@@ -417,12 +419,17 @@
     script = false;
     scriptCodeSize = scriptCodeResync = 0;
 
+    if (parser->skipMode() || followingFrameset)
+        return;
+
     if ( !m_executingScript && cachedScript.isEmpty() ) {
-        // kdDebug( 6036 ) << "adding pending Output to parsed string" << endl;
-        src.append(pendingSrc);
-        pendingSrc.clear();
-    } else if ( !prependingSrc.isEmpty() )
-        write( prependingSrc, false );
+        src.append(pendingQueue.pop());
+    } else if ( cachedScript.isEmpty() ) {
+        write( pendingQueue.pop(), false );
+    } else if ( !deferredScript && pendingQueue.count() > 1) {
+       TokenizerString t = pendingQueue.pop();
+       pendingQueue.top().prepend( t );
+    }
 }
 
 void HTMLTokenizer::scriptExecution( const QString& str, const QString& scriptURL,
@@ -1294,10 +1301,14 @@
     if ( !buffer )
         return;
 
-    if ( ( m_executingScript && appendData ) ||
-         ( !m_executingScript && cachedScript.count() ) ) {
+    if ( ( m_executingScript && appendData ) || cachedScript.count() ) {
         // don't parse; we will do this later
-        pendingSrc.append(str);
+        if (pendingQueue.isEmpty())
+            pendingQueue.push(str);
+        else if (appendData)
+            pendingQueue.bottom().append(str);
+        else
+            pendingQueue.top().append(str);
         return;
     }
 
@@ -1705,9 +1716,9 @@
     assert(!cachedScript.isEmpty());
     bool done = false;
     while (!done && cachedScript.head()->isLoaded()) {
-#ifdef TOKEN_DEBUG
+
         kdDebug( 6036 ) << "Finished loading an external script" << endl;
-#endif
+
         CachedScript* cs = cachedScript.dequeue();
         DOMString scriptSource = cs->script();
 #ifdef TOKEN_DEBUG
@@ -1725,12 +1736,16 @@
         done = cachedScript.isEmpty();
 
         // 'script' is true when we are called synchronously from
-        // parseScript(). In that case parseScript() will take care
+        // scriptHandler(). In that case scriptHandler() will take care
         // of 'scriptOutput'.
         if ( !script ) {
-            TokenizerString rest = pendingSrc;
-            pendingSrc.clear();
-            write(rest, false);
+            if (pendingQueue.count() > 1) {
+               TokenizerString t = pendingQueue.pop();
+               pendingQueue.top().prepend( t );
+            }
+            if (done) {
+                write(pendingQueue.pop(), false);
+            }
             // we might be deleted at this point, do not
             // access any members.
         }
--- kdelibs-3.5.2/khtml/html/htmltokenizer.h	2006-03-17 05:19:11.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/html/htmltokenizer.h	2006-04-14 15:43:15.000000000 -0400
@@ -317,7 +317,7 @@
     QString scriptSrcCharset;
     bool javascript;
     // the HTML code we will parse after the external script we are waiting for has loaded
-    TokenizerString pendingSrc;
+    TokenizerQueue pendingQueue;
     // true if we are executing a script while parsing a document. This causes the parsing of
     // the output of the script to be postponed until after the script has finished executing
     int m_executingScript;
--- kdelibs-3.5.2/khtml/khtml_part.cpp	2006-03-17 05:19:16.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/khtml_part.cpp	2006-04-14 15:43:15.000000000 -0400
@@ -1595,7 +1595,6 @@
 
     d->m_pageServices = d->m_job->queryMetaData("PageServices");
     d->m_pageReferrer = d->m_job->queryMetaData("referrer");
-
     d->m_bSecurityInQuestion = false;
     d->m_ssl_in_use = (d->m_job->queryMetaData("ssl_in_use") == "TRUE");
 
@@ -1638,6 +1637,7 @@
     if ( !qData.isEmpty() && !d->m_haveEncoding ) // only use information if the user didn't override the settings
        d->m_encoding = qData;
 
+
     // Support for http-refresh
     qData = d->m_job->queryMetaData("http-refresh");
     if( !qData.isEmpty())
@@ -1651,6 +1651,11 @@
       d->m_doc->setBaseURL(KURL( d->m_doc->completeURL(baseURL) ));
     */
 
+    // Support for Content-Language
+    QString language = d->m_job->queryMetaData("content-language");
+    if (!language.isEmpty())
+        d->m_doc->setContentLanguage(language);
+
     if ( !m_url.isLocalFile() ) {
         // Support for http last-modified
         d->m_lastModified = d->m_job->queryMetaData("modified");
@@ -3966,10 +3971,10 @@
     return true;
   }
 
-  //If we're asked to open up an anchor in the current URL, in current window, 
-  //merely gotoanchor, and do not reload the new page. Note that this does 
+  //If we're asked to open up an anchor in the current URL, in current window,
+  //merely gotoanchor, and do not reload the new page. Note that this does
   //not apply if the URL is the same page, but without a ref
-  if (cURL.hasRef() && (!hasTarget || target == "_self")) 
+  if (cURL.hasRef() && (!hasTarget || target == "_self"))
   {
     KURL curUrl = this->url();
     if (urlcmp(cURL.url(), curUrl.url(),
@@ -3977,7 +3982,7 @@
               true))  // don't care if the ref changes!
     {
       m_url = cURL;
-      emit d->m_extension->openURLNotify();      
+      emit d->m_extension->openURLNotify();
       if ( !gotoAnchor( m_url.encodedHtmlRef()) )
         gotoAnchor( m_url.htmlRef() );
       emit d->m_extension->setLocationBarURL( m_url.prettyURL() );
@@ -5956,9 +5961,9 @@
         if (n->isText()) {
             khtml::RenderText* const textRenderer = static_cast<khtml::RenderText *>(n);
             const khtml::InlineTextBoxArray &runs = textRenderer->inlineTextBoxes();
-	    const unsigned lim = runs.count();
+            const unsigned lim = runs.count();
             for (unsigned i = 0; i != lim; ++i) {
-                if (runs[i]->m_y == y) {
+                if (runs[i]->m_y == y && textRenderer->element()) {
                     startNode = textRenderer->element();
                     startOffset = runs[i]->m_start;
                     return true;
@@ -5999,7 +6004,7 @@
             khtml::RenderText* const textRenderer =  static_cast<khtml::RenderText *>(n);
             const khtml::InlineTextBoxArray &runs = textRenderer->inlineTextBoxes();
             for (int i = (int)runs.count()-1; i >= 0; --i) {
-                if (runs[i]->m_y == y) {
+                if (runs[i]->m_y == y && textRenderer->element()) {
                     endNode = textRenderer->element();
                     endOffset = runs[i]->m_start + runs[i]->m_len;
                     return true;
--- kdelibs-3.5.2/khtml/khtmlview.h	2005-11-08 17:39:32.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/khtmlview.h	2006-04-14 15:43:18.000000000 -0400
@@ -171,6 +171,10 @@
 
 
 signals:
+    /**
+     * This signal is used for internal layouting. Don't use it to check if rendering finished.
+     * Use @ref KHTMLPart completed() signal instead.
+     */
     void finishedLayout();
     void cleared();
     void zoomView( int );
--- kdelibs-3.5.2/khtml/kjserrordlg.ui	2005-09-10 04:27:21.000000000 -0400
+++ kdelibs-3.5.2-new/khtml/kjserrordlg.ui	2006-04-14 15:43:15.000000000 -0400
@@ -86,7 +86,7 @@
                 <enum>RichText</enum>
             </property>
         </widget>
-        <widget class="KActiveLabel" row="0" column="0" rowspan="1" colspan="3">
+        <widget class="KSqueezedTextLabel" row="0" column="0" rowspan="1" colspan="3">
             <property name="name">
                 <cstring>_url</cstring>
             </property>
@@ -117,7 +117,7 @@
 </tabstops>
 <includes>
     <include location="global" impldecl="in declaration">kdialog.h</include>
-    <include location="global" impldecl="in declaration">kactivelabel.h</include>
+    <include location="global" impldecl="in declaration">ksqueezedtextlabel.h</include>
 </includes>
 <slots>
     <slot>init()</slot>
--- kdelibs-3.5.2/khtml/misc/stringit.h	2005-10-10 11:06:13.000000000 -0400
+++ kdelibs-3.5.2-new/khtml/misc/stringit.h	2006-04-14 15:43:18.000000000 -0400
@@ -113,6 +113,11 @@
     TokenizerString() : m_currentChar(0), m_lines(0), m_composite(false) {}
     TokenizerString(const QChar *str, int length) : m_currentString(str, length), m_currentChar(m_currentString.m_current), m_lines(0), m_composite(false) {}
     TokenizerString(const QString &str) : m_currentString(str), m_currentChar(m_currentString.m_current), m_lines(0), m_composite(false) {}
+    TokenizerString(const TokenizerString &o) : m_pushedChar1(o.m_pushedChar1), m_pushedChar2(o.m_pushedChar2),
+                                                m_currentString(o.m_currentString), m_substrings(o.m_substrings),
+                                                m_lines(o.m_lines), m_composite(o.m_composite) { 
+        m_currentChar = m_pushedChar1.isNull() ? m_currentString.m_current : &m_pushedChar1; 
+    } 
 
     void clear();
 
@@ -173,6 +178,25 @@
 
 };
 
+
+class TokenizerQueue : public QValueList<TokenizerString>
+{
+
+public:
+    TokenizerQueue() {}
+    ~TokenizerQueue() {}
+    void  push( const TokenizerString &t ) { prepend(t); }
+    TokenizerString pop() {
+        if (isEmpty()) 
+            return TokenizerString();
+        TokenizerString t(first());
+        remove( begin() );
+        return t;
+    }
+    TokenizerString& top() { return first(); }
+    TokenizerString& bottom() { return last(); }
+};
+
 }
 
 #endif
--- kdelibs-3.5.2/khtml/rendering/bidi.cpp	2006-03-17 05:19:14.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/rendering/bidi.cpp	2006-04-14 15:43:16.000000000 -0400
@@ -792,12 +792,18 @@
     if (bottomOfLine > m_height && bottomOfLine > m_overflowHeight)
         m_overflowHeight = bottomOfLine;
 
+    bool beforeContent = true;
+
     // Now make sure we place replaced render objects correctly.
     for (BidiRun* r = sFirstBidiRun; r; r = r->nextRun) {
-        // Align positioned boxes with the top of the line box.  This is
-        // a reasonable approximation of an appropriate y position.
+
+        // For positioned placeholders, cache the static Y position an object with non-inline display would have.
+        // Either it is unchanged if it comes before any real linebox, or it must clear the current line (already accounted in m_height).
+        // This value will be picked up by position() if relevant.
         if (r->obj->isPositioned())
-            r->box->setYPos(m_height);
+            r->box->setYPos( beforeContent && r->obj->isBox() ? static_cast<RenderBox*>(r->obj)->staticY() : m_height );
+        else if (beforeContent)
+           beforeContent = false;
 
         // Position is used to properly position both replaced elements and
         // to update the static normal flow x/y of positioned elements.
--- kdelibs-3.5.2/khtml/rendering/font.cpp	2005-10-10 11:06:07.000000000 -0400
+++ kdelibs-3.5.2-new/khtml/rendering/font.cpp	2006-04-14 15:43:16.000000000 -0400
@@ -338,6 +338,65 @@
     return w;
 }
 
+/** Querying QFontDB whether something is scalable is expensive, so we cache. */
+struct Font::ScalKey 
+{
+    QString family;
+    int     weight;
+    int     italic;
+
+    ScalKey(const QFont& font) : 
+            family(font.family()), weight(font.weight()), italic(font.italic())
+    {}
+
+    ScalKey() {}
+
+    bool operator<(const ScalKey& other) const {
+        if (weight < other.weight)
+            return true;
+        if (weight > other.weight)
+            return false;
+
+        if (italic < other.italic)
+            return true;
+        if (italic > other.italic)
+            return false;
+
+        return family < other.family;
+    }
+
+    bool operator==(const ScalKey& other) const {
+        return (weight == other.weight &&
+                italic == other.italic && 
+                family == other.family);
+    }
+};
+
+QMap<Font::ScalKey, Font::ScalInfo>*   Font::scalCache;
+QMap<Font::ScalKey, QValueList<int> >* Font::scalSizesCache;
+
+bool Font::isFontScalable(QFontDatabase& db, const QFont& font) 
+{
+    if (!scalCache)
+        scalCache = new QMap<ScalKey, ScalInfo>;
+
+    ScalKey key(font);
+
+    ScalInfo &s = (*scalCache)[key];
+    if (s == Unknown) {
+        s = db.isSmoothlyScalable(font.family(), db.styleString(font)) ? Yes : No;
+
+        if (s == No) {
+            /* Cache size info */
+            if (!scalSizesCache)
+                scalSizesCache = new QMap<ScalKey, QValueList<int> >;
+            (*scalSizesCache)[key] = db.smoothSizes(font.family(), db.styleString(font));
+        }
+    }
+
+    return (s == Yes);
+}
+
 
 void Font::update( QPaintDeviceMetrics* devMetrics ) const
 {
@@ -352,9 +411,9 @@
 
     // ok, now some magic to get a nice unscaled font
     // all other font properties should be set before this one!!!!
-    if( !db.isSmoothlyScalable(f.family(), db.styleString(f)) )
+    if( !isFontScalable(db, f) )
     {
-        const QValueList<int> pointSizes = db.smoothSizes(f.family(), db.styleString(f));
+        const QValueList<int>& pointSizes = (*scalSizesCache)[ScalKey(f)];
         // lets see if we find a nice looking font, which is not too far away
         // from the requested one.
         // kdDebug(6080) << "khtml::setFontSize family = " << f.family() << " size requested=" << size << endl;
@@ -392,7 +451,6 @@
     f.setPixelSize( size );
 
     fm = QFontMetrics( f );
-    fontDef.hasNbsp = fm.inFont( 0xa0 );
 
     // small caps
     delete scFont;
--- kdelibs-3.5.2/khtml/rendering/font.h	2005-10-10 11:06:06.000000000 -0400
+++ kdelibs-3.5.2-new/khtml/rendering/font.h	2006-04-14 15:43:16.000000000 -0400
@@ -27,11 +27,12 @@
 
 #include <qfont.h>
 #include <qfontmetrics.h>
+#include <qmap.h>
 #include <qpainter.h>
 
+class QFontDatabase;
 class QPaintDeviceMetrics;
 
-
 namespace khtml
 {
 class RenderStyle;
@@ -41,7 +42,7 @@
 {
 public:
     FontDef()
-        : size( 0 ), italic( false ), smallCaps( false ), weight( 50 ), hasNbsp( true ) {}
+        : size( 0 ), italic( false ), smallCaps( false ), weight( 50 ) {}
     bool operator == ( const FontDef &other ) const {
         return ( family == other.family &&
                  size == other.size &&
@@ -55,7 +56,6 @@
     bool italic 		: 1;
     bool smallCaps 		: 1;
     unsigned int weight 		: 8;
-    mutable bool hasNbsp : 1;
 };
 
 
@@ -163,6 +163,17 @@
     mutable QFont *scFont;
     short letterSpacing;
     short wordSpacing;
+
+    struct ScalKey;
+    enum   ScalInfo {
+        Unknown,
+        No,
+        Yes
+    };
+
+    static QMap<ScalKey, ScalInfo>* scalCache;
+    static QMap<ScalKey, QValueList<int> >* scalSizesCache;
+    static bool isFontScalable(QFontDatabase& db, const QFont& font);
 };
 
 } // namespace
--- kdelibs-3.5.2/khtml/rendering/render_block.cpp	2006-03-17 05:19:14.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/rendering/render_block.cpp	2006-04-14 15:43:17.000000000 -0400
@@ -176,6 +176,11 @@
         firstLetter->setIsAnonymous( true );
         firstLetterContainer->addChild(firstLetter, firstLetterContainer->firstChild());
 
+        // if this object is the result of a :begin, then the text may have not been
+        // generated yet if it is a counter
+        if (textObj->recalcMinMax())
+            textObj->recalcMinMaxWidths();
+
         // The original string is going to be either a generated content string or a DOM node's
         // string.  We want the original string before it got transformed in case first-letter has
         // no text-transform or a different text-transform applied to it.
@@ -187,11 +192,13 @@
             oldText->ref();
             unsigned int length = 0;
             while ( length < oldText->l &&
-                    ( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct() ) )
+                    ( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct()) )
                 length++;
             if ( length < oldText->l && 
                     !( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct() ))
                 length++;
+            while ( length < oldText->l && (oldText->s+length)->isMark() )
+                length++;
             RenderTextFragment* remainingText =
                 new (renderArena()) RenderTextFragment(textObj->node(), oldText, length, oldText->l-length);
             remainingText->setIsAnonymous( textObj->isAnonymous() );
@@ -2244,8 +2251,10 @@
 
     int offset = m_y;
     if (parentHasFloats)
+    {
         addOverHangingFloats( static_cast<RenderBlock *>( parent() ),
                               parent()->borderLeft() + parent()->paddingLeft(), offset, false );
+    }
 
     int xoffset = 0;
     if (prev) {
@@ -2275,10 +2284,24 @@
     // Prevent floats from being added to the canvas by the root element, e.g., <html>.
     if ( !flow->m_floatingObjects || (child && flow->isRoot()) )
         return;
+        
+    // if I am clear of my floats, don't add them
+    // the CSS spec also mentions that child floats
+    // are not cleared.
+    if (!child && style()->clear() == CBOTH)
+    {
+        return;
+    }
 
     QPtrListIterator<FloatingObject> it(*flow->m_floatingObjects);
     FloatingObject *r;
     for ( ; (r = it.current()); ++it ) {
+    
+        if (!child && r->type == FloatingObject::FloatLeft && style()->clear() == CLEFT )
+            continue;
+        if (!child && r->type == FloatingObject::FloatRight && style()->clear() == CRIGHT )
+            continue;
+            
         if ( ( !child && r->endY > offset ) ||
              ( child && flow->yPos() + r->endY > height() ) ) {
             if (child && !r->crossedLayer) {
--- kdelibs-3.5.2/khtml/rendering/render_box.cpp	2006-03-17 05:19:14.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/rendering/render_box.cpp	2006-04-14 15:43:17.000000000 -0400
@@ -687,16 +687,12 @@
         Q_ASSERT(p);
         while( p->isInline() && !p->isReplaced() )
             p = p->parent();
-        int off = 0;
-        if (!p->hasOverflowClip());
-            off = p->negativeOverflowWidth();
+        int off = p->hasOverflowClip() ? 0 : p->negativeOverflowWidth();
         p->repaintRectangle( -ow - off, -ow, p->effectiveWidth()+ow*2, p->effectiveHeight()+ow*2, immediate);
     }
     else
     {
-        int off = 0;
-        if (!hasOverflowClip());
-            off = negativeOverflowWidth();
+        int off = hasOverflowClip() ? 0 : negativeOverflowWidth();
         repaintRectangle( -ow - off, -ow, effectiveWidth()+ow*2, effectiveHeight()+ow*2, immediate);
     }
 }
--- kdelibs-3.5.2/khtml/rendering/render_object.cpp	2006-03-18 08:37:41.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/rendering/render_object.cpp	2006-04-14 15:43:16.000000000 -0400
@@ -2109,19 +2109,21 @@
                 n = n->previousSibling();
             }
             if (sibling->isReset())
+            {
                 if (last != sibling)
                     sibling->insertAfter(i, last);
                 else
                     sibling->insertAfter(i, 0);
-            else
+            }
+            else if (last->parent())
                 last->parent()->insertAfter(i, last);
         }
-        else {
+        else if (parent()) {
             // Nothing found among siblings, let our parent search
             last = parent()->getCounter(counter, false);
             if (last->isReset())
                 last->insertAfter(i, 0);
-            else
+            else if (last->parent())
                 last->parent()->insertAfter(i, last);
         }
     }
--- kdelibs-3.5.2/khtml/rendering/render_text.cpp	2006-03-17 05:19:14.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/rendering/render_text.cpp	2006-04-14 15:43:17.000000000 -0400
@@ -307,12 +307,12 @@
     }
     if ( _x > _tx + m_x + m_width ) {
 	// to the right
-	return m_reversed ? SelectionPointBeforeInLine : SelectionPointAfterInLine;
+	return  SelectionPointAfterInLine;
     }
 
     // The Y matches, check if we're on the left
     if ( _x < _tx + m_x ) {
-        return m_reversed ? SelectionPointAfterInLine : SelectionPointBeforeInLine;
+        return SelectionPointBeforeInLine;
     }
 
     // consider spacing for justified text
--- kdelibs-3.5.2/khtml/test_regression.cpp	2006-01-19 12:06:58.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/test_regression.cpp	2006-04-14 15:43:18.000000000 -0400
@@ -132,7 +132,7 @@
 void PartMonitor::waitForCompletion()
 {
     if (!m_completed) {
-         
+
         if (sm_highestMonitor)
 		return;
 
@@ -1318,9 +1318,7 @@
 
         if ( m_known_failures & PaintFailure )
             m_known_failures = AllFailure;
-        CheckResult dumped = checkPaintdump(filename);
-        reportResult( dumped, "PAINT");
-        if (dumped == Failure)
+        if (!reportResult( checkPaintdump(filename), "PAINT") )
             failures |= PaintFailure;
 
         doFailureReport(filename, failures );
@@ -1420,6 +1418,15 @@
     if ( !imageEqual( baseline, output ) ) {
         QString outputFilename = m_outputDir + "/" + againstFilename;
         createMissingDirs(outputFilename );
+
+        bool kf = false;
+        if ( m_known_failures & AllFailure )
+            kf = true;
+        else if ( m_known_failures & PaintFailure )
+            kf = true;
+        if ( kf )
+            outputFilename += "-KF";
+
         output.save(outputFilename, "PNG", 60);
     }
     else {
--- kdelibs-3.5.2/khtml/testkhtml.h	2005-09-10 04:27:21.000000000 -0400
+++ kdelibs-3.5.2-new/khtml/testkhtml.h	2006-04-14 15:43:19.000000000 -0400
@@ -2,6 +2,8 @@
 #define TESTKHTML_H
 
 #include <kdebug.h>
+#include <qvaluelist.h>
+#include <qdatetime.h>
 
 /**
  * @internal
@@ -36,8 +38,18 @@
       m_part->setEditable(s);
   }
 
+  void doBenchmark();
+
+  void handleDone();
+
 private:
   KHTMLPart *m_part;
+  QValueList<QString> filesToBenchmark;
+  QMap<QString, QValueList<int> > results;
+  int                 benchmarkRun;
+  QTime               loadTimer;
+
+  void nextRun();
 };
 
 #endif
--- kdelibs-3.5.2/khtml/xml/dom2_eventsimpl.cpp	2006-03-17 05:19:16.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/xml/dom2_eventsimpl.cpp	2006-04-14 15:43:18.000000000 -0400
@@ -499,14 +499,14 @@
     }
 
     L toLeft(R r) {
-        typename QMap<R,L>::iterator i = m_rToL.find(r);
+        QMapIterator<R,L> i( m_rToL.find(r) );
         if (i != m_rToL.end())
             return *i;
         return L();
     }
 
     R toRight(L l) {
-        typename QMap<L,R>::iterator i = m_lToR.find(l);
+        QMapIterator<L,R> i = m_lToR.find(l);
         if (i != m_lToR.end())
             return *i;
         return R();
@@ -775,7 +775,7 @@
     if (keyIdentifierArg.length() == 1) {
         //Likely to be normal unicode id, unless it's one of the few
         //special values.
-        unsigned short code = keyIdentifierArg.unicode()[0].unicode();
+        unsigned short code = keyIdentifierArg.unicode()[0];
         if (code > 0x20 && code != 0x7F)
             keyVal = code;
     }
@@ -789,7 +789,7 @@
             modifiersList.string().stripWhiteSpace().simplifyWhiteSpace());
 
     unsigned modifiers = 0;
-    for (QStringList::iterator i = mods.begin(); i != mods.end(); ++i)
+    for (QStringList::Iterator i = mods.begin(); i != mods.end(); ++i)
         if (unsigned mask = keyModifiersToCode()->toRight((*i).latin1()))
             modifiers |= mask;
 
--- kdelibs-3.5.2/khtml/xml/dom_docimpl.cpp	2006-03-17 05:19:16.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/xml/dom_docimpl.cpp	2006-04-14 15:43:18.000000000 -0400
@@ -173,7 +173,7 @@
     if (doc->doctype() && dtype)
         doc->doctype()->copyFrom(*dtype);
 
-    // the document must be created empty if all parameters are null 
+    // the document must be created empty if all parameters are null
     // (or empty for qName/nsURI as a tolerance) - see DOM 3 Core.
     if (dtype || !qualifiedName.isEmpty() || !namespaceURI.isEmpty()) {
         ElementImpl *element = doc->createElementNS(namespaceURI,qualifiedName);
@@ -330,9 +330,9 @@
     m_elementMap = new IdNameMapping(ID_LAST_TAG+1);
     m_namespaceMap = new IdNameMapping(2);
     QString xhtml(XHTML_NAMESPACE);
-    m_namespaceMap->names.insert(noNamespace, new DOMStringImpl(""));
+    m_namespaceMap->names.insert(emptyNamespace, new DOMStringImpl(""));
     m_namespaceMap->names.insert(xhtmlNamespace, new DOMStringImpl(xhtml.unicode(), xhtml.length()));
-    m_namespaceMap->names[noNamespace]->ref();
+    m_namespaceMap->names[emptyNamespace]->ref();
     m_namespaceMap->names[xhtmlNamespace]->ref();
     m_namespaceMap->count+=2;
     m_focusNode = 0;
@@ -388,6 +388,8 @@
     m_styleSheets->deref();
     if (m_addedStyleSheets)
         m_addedStyleSheets->deref();
+    if (m_cssTarget)
+        m_cssTarget->deref();
     if (m_focusNode)
         m_focusNode->deref();
     if ( m_hoverNode )
@@ -562,7 +564,7 @@
     splitPrefixLocalName(_qualifiedName.implementation(), prefix, localName, colonPos);
 
     if ((isHTMLDocument() && _namespaceURI.isNull()) ||
-        (_namespaceURI == XHTML_NAMESPACE && localName == localName.lower())) {
+        (strcasecmp(_namespaceURI, XHTML_NAMESPACE) == 0 && localName == localName.lower())) {
         e = createHTMLElement(localName);
         if (e) {
             int _exceptioncode = 0;
@@ -610,7 +612,7 @@
 
     ElementMappingCache::ItemInfo* info = m_getElementByIdCache.get(stringKey);
 
-    if (!info) 
+    if (!info)
         return 0;
 
     //See if cache has an unambiguous answer.
@@ -1656,6 +1658,9 @@
         m_preferredStylesheetSet = content;
         updateStyleSelector();
     }
+    else if (strcasecmp(equiv, "content-language") == 0) {
+        m_contentLanguage = content.string();
+    }
 }
 
 bool DocumentImpl::prepareMouseEvent( bool readonly, int _x, int _y, MouseEvent *ev )
@@ -1752,7 +1757,7 @@
               << ", exceptions: " << (pExceptioncode ? "yes" : "no")
               << " )" << endl;*/
 
-    if(!_name || !_name->l) return 0;
+    if(!_name) return 0;
     IdNameMapping *map;
     IdLookupFunction lookup;
 
@@ -1766,16 +1771,18 @@
         lookup = getAttrID;
         break;
     case NodeImpl::NamespaceId:
-        if( !strcasecmp(_name, XHTML_NAMESPACE) )
+        if( strcasecmp(_name, XHTML_NAMESPACE) == 0)
             return xhtmlNamespace; //### Id == 0 can't be used with (void*)int based QDicts...
         if( _name->l == 0)
-            return noNamespace;
+            return emptyNamespace;
         map = m_namespaceMap;
         lookup= 0;
         break;
     default:
         return 0;
     }
+    // Names and attributes with ""
+    if (_name->l == 0) return 0;
 
     NodeImpl::Id id, nsid = 0;
     QConstString n(_name->s, _name->l);
@@ -1854,7 +1861,7 @@
 {
     IdNameMapping *map;
     NameLookupFunction lookup;
-    bool hasNS = (_id & NodeImpl_IdNSMask);
+    bool hasNS = (namespacePart(_id) != defaultNamespace);
     switch (_type) {
     case NodeImpl::ElementId:
         map = m_elementMap;
@@ -1867,7 +1874,7 @@
     case NodeImpl::NamespaceId:
         if( _id == xhtmlNamespace )
             return XHTML_NAMESPACE;
-        if( _id == noNamespace )
+        if( _id == emptyNamespace )
             return "";
         map = m_namespaceMap;
         lookup = 0;
@@ -1875,7 +1882,7 @@
     default:
         return DOMString();;
     }
-    _id = _id & NodeImpl_IdLocalMask;
+    _id = localNamePart(_id) ;
     if (_id >= map->idStart) {
         return map->names[_id];
     }
@@ -2193,11 +2200,18 @@
 
 void DocumentImpl::setCSSTarget(NodeImpl* n)
 {
-    if (m_cssTarget)
+    if (n == m_cssTarget)
+        return;
+
+    if (m_cssTarget) {
         m_cssTarget->setChanged();
+        m_cssTarget->deref();
+    }
     m_cssTarget = n;
-    if (n)
+    if (n) {
         n->setChanged();
+        n->ref();
+    }
 }
 
 void DocumentImpl::attachNodeIterator(NodeIteratorImpl *ni)
--- kdelibs-3.5.2/khtml/xml/dom_docimpl.h	2006-03-17 05:19:16.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/xml/dom_docimpl.h	2006-04-14 15:43:19.000000000 -0400
@@ -530,6 +530,9 @@
         return m_getElementByIdCache;
     }
 
+    QString contentLanguage() const { return m_contentLanguage; }
+    void setContentLanguage(const QString& cl) { m_contentLanguage = cl; }
+
 signals:
     void finishedParsing();
 
@@ -551,6 +554,8 @@
     QString m_printSheet;
     QStringList m_availableSheets;
 
+    QString m_contentLanguage;
+
     // Track the number of currently loading top-level stylesheets.  Sheets
     // loaded using the @import directive are not included in this count.
     // We use this count of pending sheets to detect when we can begin attaching
--- kdelibs-3.5.2/khtml/xml/dom_elementimpl.cpp	2006-03-17 05:19:16.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/xml/dom_elementimpl.cpp	2006-04-14 15:43:18.000000000 -0400
@@ -521,7 +521,7 @@
 
     if (!getDocument()->renderer())
         return; // the document is about to be destroyed
-    
+
     if (m_restyleChildrenLate) {
         NodeImpl *e = firstChild();
         while(e) {
@@ -682,7 +682,6 @@
     if (!inDocument())
         return;
 
-    DocumentImpl* doc = getDocument();
     if (oldId && oldId->l)
         removeId(DOMString(oldId).string());
 
@@ -918,7 +917,7 @@
     for (unsigned long i = 0; i < m_attrCount; i++) {
 	if ((m_attrs[i].id() & mask) == id) {
             // if we are called with a qualified name, filter out NS-aware elements with non-matching name.
-            if (qName && (m_attrs[i].id() & NodeImpl_IdNSMask) &&
+            if (qName && (namespacePart(m_attrs[i].id()) != defaultNamespace) &&
                 strcasecmp(m_attrs[i].name(), DOMString(qName)))
                 continue;
 	    return m_attrs[i].createAttr(m_element,m_element->docPtr());
@@ -946,7 +945,7 @@
     for (unsigned long i = 0; i < m_attrCount; i++) {
 	if ((m_attrs[i].id() & mask) == id) {
             // if we are called with a qualified name, filter out NS-aware elements with non-matching name.
-            if (qName && (m_attrs[i].id() & NodeImpl_IdNSMask) &&
+            if (qName && (namespacePart(m_attrs[i].id()) != defaultNamespace) &&
                 strcasecmp(m_attrs[i].name(), DOMString(qName)))
                 continue;
 	    id = m_attrs[i].id();
@@ -1012,13 +1011,13 @@
     for (unsigned long i = 0; i < m_attrCount; i++) {
 	if ((m_attrs[i].id() & mask) == id) {
             // if we are called with a qualified name, filter out NS-aware elements with non-matching name.
-            if (qName && (m_attrs[i].id() & NodeImpl_IdNSMask) &&
+            if (qName && (namespacePart(m_attrs[i].id()) != defaultNamespace) &&
                 strcasecmp(m_attrs[i].name(), DOMString(qName)))
                 continue;
 	    // Attribute exists; replace it
 	    if (id == ATTR_ID)
 	       m_element->updateId(m_attrs[i].val(), attr->val());
-	    
+
 	    Node replaced = m_attrs[i].createAttr(m_element,m_element->docPtr());
 	    m_attrs[i].free();
 	    m_attrs[i].m_attrId = 0; /* "has implementation" flag */
@@ -1084,7 +1083,7 @@
     for (unsigned long i = 0; i < m_attrCount; i++)
         if ((m_attrs[i].id() & mask) == id) {
             // if we are called with a qualified name, filter out NS-aware elements with non-matching name.
-            if (qName && (m_attrs[i].id() & NodeImpl_IdNSMask) &&
+            if (qName && (namespacePart(m_attrs[i].id()) != defaultNamespace) &&
                 strcasecmp(m_attrs[i].name(), DOMString(qName)))
                 continue;
             return m_attrs[i].val();
@@ -1111,7 +1110,7 @@
     for (unsigned long i = 0; i < m_attrCount; i++) {
 	if ((m_attrs[i].id() & mask) == mid) {
             // if we are called with a qualified name, filter out NS-aware elements with non-matching name.
-            if (qName && (m_attrs[i].id() & NodeImpl_IdNSMask) &&
+            if (qName && (namespacePart(m_attrs[i].id()) != defaultNamespace) &&
                 strcasecmp(m_attrs[i].name(), DOMString(qName)))
                 continue;
 	    if (prefix)
--- kdelibs-3.5.2/khtml/xml/dom_nodeimpl.cpp	2006-03-17 05:19:16.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/xml/dom_nodeimpl.cpp	2006-04-14 15:43:18.000000000 -0400
@@ -70,7 +70,8 @@
       m_active( false ),
       m_implicit( false ),
       m_rendererNeedsClose( false ),
-      m_htmlCompat( false )
+      m_htmlCompat( false ),
+      m_hasClass( false )
 {
     if (document)
         document->ref();
@@ -689,7 +690,7 @@
     // - if this node is an attribute and the specified prefix is "xmlns" and
     //   the namespaceURI of this node is different from "http://www.w3.org/2000/xmlns/",
     // - or if this node is an attribute and the qualifiedName of this node is "xmlns" [Namespaces].
-    if (Element::khtmlMalformedPrefix(_prefix) || (!(id() & NodeImpl_IdNSMask) && id() > ID_LAST_TAG) ||
+    if (Element::khtmlMalformedPrefix(_prefix) || (namespacePart(id()) == defaultNamespace && id() > ID_LAST_TAG) ||
         (_prefix == "xml" && namespaceURI() != "http://www.w3.org/XML/1998/namespace")) {
         exceptioncode = DOMException::NAMESPACE_ERR;
         return;
@@ -1765,8 +1766,7 @@
     else {
         NodeImpl::Id testId = testNode->id();
         //we have to strip the namespaces if we compare in a namespace unaware fashion
-        if ( !m_namespaceAware )
-            testId &= ~NodeImpl_IdNSMask;
+        if ( !m_namespaceAware ) testId = localNamePart(testId);
 	return (m_id == 0 || m_id == testId);
     }
 }
--- kdelibs-3.5.2/khtml/xml/dom_nodeimpl.h	2006-03-17 05:19:16.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/xml/dom_nodeimpl.h	2006-04-14 15:43:18.000000000 -0400
@@ -98,9 +98,10 @@
 #define NodeImpl_IdNSMask    0xffff0000
 #define NodeImpl_IdLocalMask 0x0000ffff
 
-const Q_UINT16 noNamespace = 0;
-const Q_UINT16 anyNamespace = 0xffff;
+const Q_UINT16 defaultNamespace = 0;
 const Q_UINT16 xhtmlNamespace = 1;
+const Q_UINT16 emptyNamespace = 2;
+const Q_UINT16 anyNamespace = 0xffff;
 const Q_UINT16 anyLocalName = 0xffff;
 
 inline Q_UINT16 localNamePart(Q_UINT32 id) { return id & NodeImpl_IdLocalMask; }
@@ -219,6 +220,7 @@
     virtual void sheetLoaded() {}
 
     bool hasID() const      { return m_hasId; }
+    bool hasClass() const   { return m_hasClass; }
     bool active() const     { return m_active; }
     bool focused() const { return m_focused; }
     bool attached() const   { return m_attached; }
@@ -230,6 +232,7 @@
     bool implicitNode() const { return m_implicit; }
     bool htmlCompat() const { return m_htmlCompat; }
     void setHasID(bool b=true) { m_hasId = b; }
+    void setHasClass(bool b=true) { m_hasClass = b; }
     void setHasChangedChild( bool b = true ) { m_hasChangedChild = b; }
     void setInDocument(bool b=true) { m_inDocument = b; }
     void setHTMLCompat(bool b) { m_htmlCompat = b; }
@@ -450,15 +453,15 @@
     bool m_inDocument : 1;
     bool m_hasAnchor : 1;
     bool m_specified : 1; // used in AttrImpl. Accessor functions there
-    
+
     bool m_focused : 1;
     bool m_active : 1;
     bool m_implicit : 1; // implicitely generated by the parser
     bool m_rendererNeedsClose : 1;
     bool m_htmlCompat : 1; // true if element was created in HTML compat mode
+    bool m_hasClass : 1;   // true if element has a class property, as relevant to CSS
     bool m_unused : 1;
     bool m_unused2 : 1;
-    bool m_unused3 : 1;    
 };
 
 // this is the full Node Implementation with parents and children.
@@ -556,7 +559,7 @@
     struct Cache: public khtml::Shared<Cache>
     {
         static Cache* make() { return new Cache; }
-    
+
         CacheKey key;//### We must store this in here due to QCache in Qt3 sucking
 
         unsigned int version;
@@ -568,7 +571,7 @@
         unsigned int position;
         unsigned int length;
         bool         hasLength;
-        
+
         void updateNodeListInfo(DocumentImpl* doc);
 
         virtual void clear(DocumentImpl* doc);
@@ -593,7 +596,7 @@
     NodeImpl *recursiveItem    ( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const;
     NodeImpl *recursiveItemBack( NodeImpl* absStart, NodeImpl *start, unsigned long &offset ) const;
 
-    // Override this to determine what nodes to return. Set doRecurse to 
+    // Override this to determine what nodes to return. Set doRecurse to
     // false if the children of this node do not need to be entered.
     virtual bool nodeMatches( NodeImpl *testNode, bool& doRecurse ) const = 0;
 
@@ -604,9 +607,9 @@
 class ChildNodeListImpl : public NodeListImpl
 {
 public:
- 
+
     ChildNodeListImpl( NodeImpl *n);
-    
+
 protected:
     virtual bool nodeMatches( NodeImpl *testNode, bool& doRecurse ) const;
 };
--- kdelibs-3.5.2/khtml/xml/dom_stringimpl.cpp	2005-10-10 11:06:13.000000000 -0400
+++ kdelibs-3.5.2-new/khtml/xml/dom_stringimpl.cpp	2006-04-14 15:43:19.000000000 -0400
@@ -139,9 +139,6 @@
   if( pos >=l ) return new DOMStringImpl();
 
   uint newLen = l-pos;
-  QChar *c = QT_ALLOC_QCHAR_VEC(newLen);
-  memcpy(c, s+pos, newLen*sizeof(QChar));
-
   DOMStringImpl *str = new DOMStringImpl(s + pos, newLen);
   truncate(pos);
   return str;
@@ -170,7 +167,14 @@
     bool changedLF = false;
     for(unsigned int i=0; i<l; i++) {
         QChar ch = s[i];
-        if (!preserveLF && (ch == '\n' || ch == '\r')) {
+
+        // We act on \r as we would on \n because CSS uses it to indicate new-line
+        if (ch == '\r') ch = '\n';
+        else
+        // ### The XML parser lets \t through, for now treat them as spaces
+        if (ch == '\t') ch = ' ';
+
+        if (!preserveLF && ch == '\n') {
             // ### Not strictly correct according to CSS3 text-module.
             // - In ideographic languages linefeed should be ignored
             // - and in Thai and Khmer it should be treated as a zero-width space
@@ -181,8 +185,7 @@
         if (collapsing) {
             if (ch == ' ')
                 continue;
-            // We act on \r as we would on \n because CSS uses it to indicate new-line
-            if (ch == '\n' || ch == '\r') {
+            if (ch == '\n') {
                 collapsingLF = true;
                 continue;
             }
@@ -197,7 +200,7 @@
             continue;
         }
         else
-        if (!preserveWS && (ch == '\n' || ch == '\r')) {
+        if (!preserveWS && ch == '\n') {
             collapsing = true;
             collapsingLF = true;
             continue;
@@ -255,15 +258,15 @@
             if (*next == '%')
                 return Length(r, Percent);
 
-            if (*next == '*') 
+            if (*next == '*')
                 return Length(r, Relative);
         }
         return Length(r, Fixed);
     } else {
         if (i < l) {
             const QChar* next = s+i;
-            
-            if (*next == '*') 
+
+            if (*next == '*')
                 return Length(1, Relative);
 
             if (*next == '%')
@@ -367,7 +370,7 @@
     bool canCapitalize=true;
     DOMStringImpl *c = new DOMStringImpl;
     if(!l) return c;
-    
+
     c->s = QT_ALLOC_QCHAR_VEC(l);
     c->l = l;
 
@@ -385,7 +388,7 @@
                 canCapitalize=true;
         }
     }
-    
+
     return c;
 }
 
--- kdelibs-3.5.2/khtml/xml/xml_tokenizer.cpp	2006-03-17 05:19:16.000000000 -0500
+++ kdelibs-3.5.2-new/khtml/xml/xml_tokenizer.cpp	2006-04-14 15:43:19.000000000 -0400
@@ -142,7 +142,13 @@
     if (currentNode()->nodeType() == Node::TEXT_NODE)
         exitText();
 
-    ElementImpl *newElement = m_doc->document()->createElementNS(namespaceURI,qName);
+    DOMString nsURI;
+    if (!namespaceURI.isNull())
+        nsURI = DOMString(namespaceURI);
+    else
+        // No namespace declared, default to the no namespace
+        nsURI = DOMString("");
+    ElementImpl *newElement = m_doc->document()->createElementNS(nsURI,qName);
     if (!newElement)
         return false;
 
@@ -157,7 +163,7 @@
             return false;
     }
 
-    if (newElement->id() == ID_SCRIPT)
+    if (newElement->id() == ID_SCRIPT || newElement->id() == makeId(xhtmlNamespace, ID_SCRIPT))
         static_cast<HTMLScriptElementImpl *>(newElement)->setCreatedByParser(true);
 
     //this is tricky. in general the node doesn't have to attach to the one it's in. as far
@@ -241,8 +247,12 @@
             return false;
         return true;
     }
-    else
+    else {
+        // Don't worry about white-space violating DTD
+        if (ch.stripWhiteSpace().isEmpty()) return true;
+
         return false;
+    }
 
 }
 
@@ -270,6 +280,7 @@
 
 QString XMLHandler::errorString()
 {
+    // ### Make better error-messages
     return i18n("the document is not in the correct file format");
 }
 
@@ -491,7 +502,7 @@
     // Recursively go through the entire document tree, looking for html <script> tags. For each of these
     // that is found, add it to the m_scripts list from which they will be executed
 
-    if (n->id() == ID_SCRIPT) {
+    if (n->id() == ID_SCRIPT || n->id() == makeId(xhtmlNamespace, ID_SCRIPT)) {
         m_scripts.append(static_cast<HTMLScriptElementImpl*>(n));
     }
 
--- kdelibs-3.5.2/kimgio/Makefile.am	2005-09-10 04:26:42.000000000 -0400
+++ kdelibs-3.5.2-new/kimgio/Makefile.am	2006-04-14 15:42:57.000000000 -0400
@@ -21,7 +21,7 @@
              kimg_pcx.la kimg_tga.la kimg_rgb.la kimg_xcf.la kimg_dds.la $(KIMGIO_EXR_MODULES) \
 			 kimg_psd.la kimg_hdr.la
 
-KIMGIO_PLUGIN = -avoid-version -export-symbols-regex 'kimgio_.*_(read|write)'
+KIMGIO_PLUGIN = -avoid-version
 
 kimg_tiff_la_SOURCES = tiffr.cpp
 kimg_tiff_la_LDFLAGS = -module $(KIMGIO_PLUGIN) -no-undefined $(all_libraries)
--- kdelibs-3.5.2/kimgio/tga.cpp	2005-09-10 04:26:42.000000000 -0400
+++ kdelibs-3.5.2-new/kimgio/tga.cpp	2006-04-14 15:43:08.000000000 -0400
@@ -168,8 +168,6 @@
 			}
 		}
 	};
-	
-
 
 	static bool LoadTGA( QDataStream & s, const TgaHeader & tga, QImage &img )
 	{
@@ -195,6 +193,12 @@
 		uint pixel_size = (tga.pixel_size/8);
 		uint size = tga.width * tga.height * pixel_size;
 
+		if (size < 1)
+		{
+			kdDebug(399) << "This TGA file is broken with size " << size << endl;
+			return false;
+		}
+
 		
 		// Read palette.
 		char palette[768];
--- kdelibs-3.5.2/kinit/Makefile.am	2005-10-10 11:05:37.000000000 -0400
+++ kdelibs-3.5.2-new/kinit/Makefile.am	2006-04-14 15:42:57.000000000 -0400
@@ -15,7 +15,7 @@
 #    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 #    Boston, MA 02110-1301, USA.
 
-INCLUDES = -I$(srcdir)/../libltdl/ $(all_includes) $(KDEINIT_XFT_INCLUDES)
+INCLUDES = -I$(srcdir)/../libltdl/ $(KDEINIT_XFT_INCLUDES) $(all_includes)
 
 SUBDIRS = . tests
 
--- kdelibs-3.5.2/kinit/kinit.cpp	2006-03-17 05:19:08.000000000 -0500
+++ kdelibs-3.5.2-new/kinit/kinit.cpp	2006-04-14 15:43:08.000000000 -0400
@@ -1099,11 +1099,12 @@
    {
       d.launcher_ok = true;
    }
-   else if ((request_header.cmd == LAUNCHER_EXEC) ||
+   else if (request_header.arg_length && 
+      ((request_header.cmd == LAUNCHER_EXEC) ||
        (request_header.cmd == LAUNCHER_EXT_EXEC) ||
        (request_header.cmd == LAUNCHER_SHELL ) ||
        (request_header.cmd == LAUNCHER_KWRAPPER) ||
-       (request_header.cmd == LAUNCHER_EXEC_NEW))
+       (request_header.cmd == LAUNCHER_EXEC_NEW)))
    {
       pid_t pid;
       klauncher_header response_header;
@@ -1229,7 +1230,7 @@
       }
       d.debug_wait = false;
    }
-   else if (request_header.cmd == LAUNCHER_SETENV)
+   else if (request_header.arg_length && request_header.cmd == LAUNCHER_SETENV)
    {
       const char *env_name;
       const char *env_value;
@@ -1367,7 +1368,7 @@
          if (sock >= 0)
          {
 #if defined(KDEINIT_USE_XFT) && defined(KDEINIT_USE_FONTCONFIG)
-            if( !FcConfigUptoDate(NULL))
+            if( FcGetVersion() < 20390 && !FcConfigUptoDate(NULL))
                FcInitReinitialize();
 #endif
             if (fork() == 0)
@@ -1387,7 +1388,7 @@
          if (sock >= 0)
          {
 #if defined(KDEINIT_USE_XFT) && defined(KDEINIT_USE_FONTCONFIG)
-            if( !FcConfigUptoDate(NULL))
+            if( FcGetVersion() < 20390 && !FcConfigUptoDate(NULL))
                FcInitReinitialize();
 #endif
             if (fork() == 0)
@@ -1782,8 +1783,11 @@
 
    {
 #if defined(KDEINIT_USE_XFT) && defined(KDEINIT_USE_FONTCONFIG)
-      XftInit(0);
-      XftInitFtLibrary();
+      if( FcGetVersion() < 20390 )
+      {
+        XftInit(0);
+        XftInitFtLibrary();
+      }
 #endif
       QFont::initialize();
       setlocale (LC_ALL, "");
--- kdelibs-3.5.2/kinit/wrapper.c	2005-10-10 11:05:37.000000000 -0400
+++ kdelibs-3.5.2-new/kinit/wrapper.c	2006-04-14 15:43:08.000000000 -0400
@@ -182,6 +182,7 @@
   if (strlen(sock_file)+strlen(display)+strlen("/kdeinit_")+2 > MAX_SOCK_FILE)
   {
      fprintf(stderr, "Warning: Socket name will be too long.\n");
+     free (display);
      return -1;
   }
   strcat(sock_file, "/kdeinit_");
--- kdelibs-3.5.2/kio/bookmarks/kbookmarkbar.cc	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/bookmarks/kbookmarkbar.cc	2006-04-14 15:43:10.000000000 -0400
@@ -310,7 +310,7 @@
     p->m_sepToolBar = tb;
     p->m_sepToolBar->removeItemDelayed(const_sepId);
 
-    int index;
+    int index = 0;
     KToolBarButton* b;
 
     b = dynamic_cast<KToolBarButton*>(tb->childAt(pos));
--- kdelibs-3.5.2/kio/kfile/kfiledialog.cpp	2006-03-17 05:19:09.000000000 -0500
+++ kdelibs-3.5.2-new/kio/kfile/kfiledialog.cpp	2006-04-14 15:43:10.000000000 -0400
@@ -402,8 +402,9 @@
             }
         }
 
+        KURL url = KIO::NetAccess::mostLocalURL(d->url,topLevelWidget());
         if ( (mode() & KFile::LocalOnly) == KFile::LocalOnly &&
-             !d->url.isLocalFile() ) {
+             !url.isLocalFile() ) {
 // ### after message freeze, add message for directories!
             KMessageBox::sorry( d->mainWidget,
                                 i18n("You can only select local files."),
@@ -411,6 +412,7 @@
             return;
         }
 
+        d->url = url;
         accept();
         return;
     }
@@ -444,15 +446,16 @@
        return;
     }
 
+    KURL url = KIO::NetAccess::mostLocalURL(selectedURL,topLevelWidget());
     if ( (mode() & KFile::LocalOnly) == KFile::LocalOnly &&
-         !selectedURL.isLocalFile() ) {
+         !url.isLocalFile() ) {
         KMessageBox::sorry( d->mainWidget,
                             i18n("You can only select local files."),
                             i18n("Remote Files Not Accepted") );
         return;
     }
 
-    d->url = selectedURL;
+    d->url = url;
 
     // d->url is a correct URL now
 
@@ -1536,8 +1539,9 @@
 {
     if ( result() == QDialog::Accepted )
     {
-       if (d->url.isLocalFile())
-           return d->url.path();
+      KURL url = KIO::NetAccess::mostLocalURL(d->url,topLevelWidget());
+       if (url.isLocalFile())
+           return url.path();
        else {
            KMessageBox::sorry( d->mainWidget,
                                i18n("You can only select local files."),
@@ -1550,14 +1554,16 @@
 QStringList KFileDialog::selectedFiles() const
 {
     QStringList list;
+    KURL url;
 
     if ( result() == QDialog::Accepted ) {
         if ( (ops->mode() & KFile::Files) == KFile::Files ) {
             KURL::List urls = parseSelectedURLs();
             QValueListConstIterator<KURL> it = urls.begin();
             while ( it != urls.end() ) {
-                if ( (*it).isLocalFile() )
-                    list.append( (*it).path() );
+              url = KIO::NetAccess::mostLocalURL(*it,topLevelWidget());
+                if ( url.isLocalFile() )
+                    list.append( url.path() );
                 ++it;
             }
         }
--- kdelibs-3.5.2/kio/kio/authinfo.cpp	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/authinfo.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -326,6 +326,7 @@
   }
 
   delete [] buf;
+  fclose (fstream);
   close (fd);
   return true;
 }
--- kdelibs-3.5.2/kio/kio/forwardingslavebase.cpp	2006-03-17 05:19:09.000000000 -0500
+++ kdelibs-3.5.2-new/kio/kio/forwardingslavebase.cpp	2006-04-14 15:43:10.000000000 -0400
@@ -69,10 +69,8 @@
     kdDebug() << "ForwardingSlaveBase::prepareUDSEntry: listing=="
               << listing << endl;
 
-    bool mimetype_found = false;
-    bool name_found = false;
     bool url_found = false;
-    QString name, mimetype;
+    QString name;
     KURL url;
 
     KIO::UDSEntry::iterator it = entry.begin();
@@ -85,7 +83,6 @@
         switch( (*it).m_uds )
         {
         case KIO::UDS_NAME:
-            name_found = true;
             name = (*it).m_str;
             kdDebug() << "Name = " << name << endl;
 	    break;
@@ -100,36 +97,7 @@
             kdDebug() << "URL = " << url << endl;
             kdDebug() << "New URL = " << (*it).m_str << endl;
             break;
-        case KIO::UDS_MIME_TYPE:
-            mimetype_found = true;
-            mimetype = (*it).m_str;
-            kdDebug() << "Mimetype = " << (*it).m_str << endl;
-            break;
-        }
-    }
-
-    if (!mimetype_found)
-    {
-        KURL new_url = m_processedURL;
-        if (url_found && listing)
-        {
-            new_url.addPath( url.fileName() );
-        }
-        else if (name_found && listing)
-        {
-            new_url.addPath( name );
         }
-
-        KMimeType::Ptr mime = KMimeType::findByURL(new_url);
-        mimetype = mime->name();
-
-        KIO::UDSAtom atom;
-        atom.m_uds = KIO::UDS_MIME_TYPE;
-        atom.m_long = 0;
-        atom.m_str = mimetype;
-        entry.append(atom);
-
-        kdDebug() << "New Mimetype = " << mime->name() << endl;
     }
 
     if ( m_processedURL.isLocalFile() )
--- kdelibs-3.5.2/kio/kio/global.cpp	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/global.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -1438,7 +1438,11 @@
 
 #ifdef HAVE_GETMNTINFO
 
+#ifdef GETMNTINFO_USES_STATVFS
+    struct statvfs *mounted;
+#else
     struct statfs *mounted;
+#endif
 
     int num_fs = getmntinfo(&mounted, MNT_NOWAIT);
 
@@ -1704,7 +1708,12 @@
 
 #ifdef HAVE_GETMNTINFO
 
+#ifdef GETMNTINFO_USES_STATVFS
+    struct statvfs *mounted;
+#else
     struct statfs *mounted;
+#endif
+
     char    realpath_buffer[MAXPATHLEN];
 
     int num_fs = getmntinfo(&mounted, MNT_NOWAIT);
--- kdelibs-3.5.2/kio/kio/job.cpp	2006-03-17 05:19:09.000000000 -0500
+++ kdelibs-3.5.2-new/kio/kio/job.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -2786,7 +2786,7 @@
     {
         m_conflictError = job->error();
         if ( (m_conflictError == ERR_DIR_ALREADY_EXIST)
-             || (m_conflictError == ERR_FILE_ALREADY_EXIST) )
+             || (m_conflictError == ERR_FILE_ALREADY_EXIST) ) // can't happen?
         {
             KURL oldURL = ((SimpleJob*)job)->url();
             // Should we skip automatically ?
@@ -3050,7 +3050,8 @@
             m_conflictError = job->error(); // save for later
             // Existing dest ?
             if ( ( m_conflictError == ERR_FILE_ALREADY_EXIST )
-                 || ( m_conflictError == ERR_DIR_ALREADY_EXIST ) )
+                 || ( m_conflictError == ERR_DIR_ALREADY_EXIST )
+                 || ( m_conflictError == ERR_IDENTICAL_FILES ) )
             {
                 subjobs.remove( job );
                 assert ( subjobs.isEmpty() );
@@ -3132,7 +3133,8 @@
         m_reportTimer->stop();
 
     if ( ( m_conflictError == ERR_FILE_ALREADY_EXIST )
-      || ( m_conflictError == ERR_DIR_ALREADY_EXIST ) )
+         || ( m_conflictError == ERR_DIR_ALREADY_EXIST )
+         || ( m_conflictError == ERR_IDENTICAL_FILES ) )
     {
         // Its modification time:
         time_t destmtime = (time_t)-1;
@@ -3161,6 +3163,7 @@
         // Offer overwrite only if the existing thing is a file
         // If src==dest, use "overwrite-itself"
         RenameDlg_Mode mode;
+        bool isDir = true;
 
         if( m_conflictError == ERR_DIR_ALREADY_EXIST )
             mode = (RenameDlg_Mode) 0;
@@ -3172,6 +3175,7 @@
                 mode = M_OVERWRITE_ITSELF;
             else
                 mode = M_OVERWRITE;
+            isDir = false;
         }
 
 	if ( m_bSingleFileCopy )
@@ -3179,7 +3183,7 @@
 	else
             mode = (RenameDlg_Mode) ( mode | M_MULTI | M_SKIP );
 
-        res = Observer::self()->open_RenameDlg( this, m_conflictError == ERR_FILE_ALREADY_EXIST ?
+        res = Observer::self()->open_RenameDlg( this, !isDir ?
                                 i18n("File Already Exists") : i18n("Already Exists as Folder"),
                                 (*it).uSource.url(),
                                 (*it).uDest.url(),
@@ -3602,7 +3606,9 @@
         // In that case it's the _same_ dir, we don't want to copy+del (data loss!)
         if ( m_currentSrcURL.isLocalFile() && m_currentSrcURL.url(-1) != dest.url(-1) &&
              m_currentSrcURL.url(-1).lower() == dest.url(-1).lower() &&
-             ( err == ERR_FILE_ALREADY_EXIST || err == ERR_DIR_ALREADY_EXIST ) )
+             ( err == ERR_FILE_ALREADY_EXIST ||
+               err == ERR_DIR_ALREADY_EXIST ||
+               err == ERR_IDENTICAL_FILES ) )
         {
             kdDebug(7007) << "Couldn't rename directly, dest already exists. Detected special case of lower/uppercase renaming in same dir, try with 2 rename calls" << endl;
             QCString _src( QFile::encodeName(m_currentSrcURL.path()) );
@@ -3643,7 +3649,9 @@
         Q_ASSERT( m_currentSrcURL == *m_currentStatSrc );
 
         // Existing dest?
-        if ( ( err == ERR_DIR_ALREADY_EXIST || err == ERR_FILE_ALREADY_EXIST )
+        if ( ( err == ERR_DIR_ALREADY_EXIST ||
+               err == ERR_FILE_ALREADY_EXIST ||
+               err == ERR_IDENTICAL_FILES )
              && isInteractive() )
         {
             if (m_reportTimer)
@@ -3693,7 +3701,7 @@
 
                 RenameDlg_Result r = Observer::self()->open_RenameDlg(
                     this,
-                    err == ERR_FILE_ALREADY_EXIST ? i18n("File Already Exists") : i18n("Already Exists as Folder"),
+                    err != ERR_DIR_ALREADY_EXIST ? i18n("File Already Exists") : i18n("Already Exists as Folder"),
                     m_currentSrcURL.url(),
                     dest.url(),
                     mode, newPath,
--- kdelibs-3.5.2/kio/kio/kdirlister.cpp	2006-03-17 05:19:09.000000000 -0500
+++ kdelibs-3.5.2-new/kio/kio/kdirlister.cpp	2006-04-14 15:43:10.000000000 -0400
@@ -944,7 +944,7 @@
   // check if anyone wants the mimetypes immediately
   bool delayedMimeTypes = true;
   for ( KDirLister *kdl = listers->first(); kdl; kdl = listers->next() )
-    delayedMimeTypes &= kdl->d->delayedMimeTypes;
+    delayedMimeTypes = delayedMimeTypes && kdl->d->delayedMimeTypes;
 
   // avoid creating these QStrings again and again
   static const QString& dot = KGlobal::staticQString(".");
@@ -1521,7 +1521,7 @@
   // check if anyone wants the mimetypes immediately
   bool delayedMimeTypes = true;
   for ( kdl = listers->first(); kdl; kdl = listers->next() )
-    delayedMimeTypes &= kdl->d->delayedMimeTypes;
+    delayedMimeTypes = delayedMimeTypes && kdl->d->delayedMimeTypes;
 
   // should be enough to get reasonable speed in most cases
   QDict<KFileItem> fileItems( 9973 );
--- kdelibs-3.5.2/kio/kio/kdirwatch.cpp	2006-03-17 05:19:08.000000000 -0500
+++ kdelibs-3.5.2-new/kio/kio/kdirwatch.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -273,6 +273,7 @@
   }
 
   if ( supports_inotify ) {
+    available += ", Inotify";
     fcntl(m_inotify_fd, F_SETFD, FD_CLOEXEC);
 
     mSn = new QSocketNotifier( m_inotify_fd, QSocketNotifier::Read, this );
@@ -430,8 +431,8 @@
               //(void) inotify_rm_watch( m_inotify_fd, e->wd );
               addEntry(0, QDir::cleanDirPath(e->path+"/.."), e, true);
             }
-            if ( event->mask & IN_CREATE ) {
-              kdDebug(7001) << "-->got create subfile signal for " << e->path << endl;
+            if ( event->mask & (IN_CREATE|IN_MOVED_TO) ) {
+              kdDebug(7001) << "-->got new subfile " << path << " in " << e->path << endl;
 
               Entry *sub_entry = e->m_entries.first();
               for(;sub_entry; sub_entry = e->m_entries.next())
@@ -876,6 +877,7 @@
 void KDirWatchPrivate::removeEntry( KDirWatch* instance,
 				    const QString& _path, Entry* sub_entry )
 {
+  kdDebug(7001) << "KDirWatchPrivate::removeEntry for '" << _path << "' sub_entry: " << sub_entry << endl;
   Entry* e = entry(_path);
   if (!e) {
     kdDebug(7001) << "KDirWatchPrivate::removeEntry can't handle '" << _path << "'" << endl;
@@ -1046,7 +1048,7 @@
   if (newWatching == 0)
     return false;
 
-  kdDebug(7001) << instance->name() << " restarted scanning " << e->path
+  kdDebug(7001) << (instance ? instance->name() : "all") << " restarted scanning " << e->path
 		<< " (now " << wasWatching+newWatching << " watchers)" << endl;
 
   // restart watching and emit pending events
@@ -1589,7 +1591,7 @@
 
 KDirWatch::~KDirWatch()
 {
-  if (d) d->removeEntries(this);
+  d->removeEntries(this);
   if ( d->deref() )
   {
     // delete it if it's the last one
--- kdelibs-3.5.2/kio/kio/krun.cpp	2006-03-17 05:19:08.000000000 -0500
+++ kdelibs-3.5.2-new/kio/kio/krun.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -660,8 +660,17 @@
   if ( mx1.expandMacrosShellQuote( exec ) && !mx1.hasUrls ) {
     Q_ASSERT( supportedProtocols.isEmpty() ); // huh? If you support protocols you need %u or %U...
   } else {
-    if ( supportedProtocols.isEmpty() ) // compat: assume KIO if not set
-      supportedProtocols.append( "KIO" );
+    if ( supportedProtocols.isEmpty() )
+    {
+      // compat mode: assume KIO if not set and it's a KDE app
+      QStringList categories = _service.property("Categories").toStringList();
+      if ( categories.find("KDE") != categories.end() )
+         supportedProtocols.append( "KIO" );
+      else { // if no KDE app, be a bit over-generic
+         supportedProtocols.append( "http");
+         supportedProtocols.append( "ftp");
+      }
+    }
   }
   kdDebug(7010) << "supportedProtocols:" << supportedProtocols << endl;
 
--- kdelibs-3.5.2/kio/kio/kservicetypefactory.cpp	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/kservicetypefactory.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -283,7 +283,7 @@
         kdError(7011) << QString("KServiceTypeFactory: unexpected object entry in KSycoca database (type = %1)").arg((int)type) << endl;
         break;
    }
-   if (!newEntry->isValid())
+   if (newEntry && !newEntry->isValid())
    {
       kdError(7011) << "KServiceTypeFactory: corrupt object in KSycoca database!\n" << endl;
       delete newEntry;
--- kdelibs-3.5.2/kio/kio/ktar.cpp	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/ktar.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -301,10 +301,10 @@
             delete filterDev;
             return false;
         }
-        Q_LONG len;
-        while ( !filterDev->atEnd() ) {
+        Q_LONG len = -1;
+        while ( !filterDev->atEnd() && len != 0) {
             len = filterDev->readBlock(buffer.data(),buffer.size());
-            if ( len <= 0 ) { // corrupted archive
+            if ( len < 0 ) { // corrupted archive
                 delete filterDev;
                 return false;
             }
--- kdelibs-3.5.2/kio/kio/ktraderparse.cpp	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/ktraderparse.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -25,26 +25,32 @@
 extern "C"
 {
 #include "ktraderparse.h"
-
-void KTraderParse_mainParse( const char *_code );
 }
 
 #include "ktraderparsetree.h"
+#include <kdebug.h>
 
 using namespace KIO;
 
 static ParseTreeBase::Ptr *pTree = 0;
+static const char* sCode = 0;
 
 ParseTreeBase::Ptr KIO::parseConstraints( const QString& _constr )
 {
-  KTraderParse_mainParse( _constr.ascii() );
+  QCString str = _constr.utf8();
+  sCode = str.data();
+  KTraderParse_mainParse( sCode );
+  sCode = 0;
   assert( pTree );
   return *pTree;
 }
 
 ParseTreeBase::Ptr KIO::parsePreferences( const QString& _prefs )
 {
-  KTraderParse_mainParse( _prefs.ascii() );
+  QCString str = _prefs.utf8();
+  sCode = str.data();
+  KTraderParse_mainParse( sCode );
+  sCode = 0;
   assert( pTree );
   return *pTree;
 }
@@ -52,10 +58,16 @@
 void KTraderParse_setParseTree( void *_ptr1 )
 {
   if ( !pTree )
-    pTree = new ParseTreeBase::Ptr; // ### leak
+    pTree = new ParseTreeBase::Ptr; // ### leak; should use KStaticDeleter
   *pTree = static_cast<ParseTreeBase*>( _ptr1 );
 }
 
+
+void KTraderParse_error( const char* err )
+{
+  kdWarning(7014) << "Parsing '" << sCode << "' gave " << err << endl;
+}
+
 void* KTraderParse_newOR( void *_ptr1, void *_ptr2 )
 {
   return new ParseTreeOR( (ParseTreeBase*)_ptr1, (ParseTreeBase*)_ptr2 );
--- kdelibs-3.5.2/kio/kio/ktraderparse.h	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/ktraderparse.h	2006-04-14 15:43:09.000000000 -0400
@@ -1,21 +1,21 @@
 /* This file is part of the KDE project
    Copyright (C) 1998, 1999 Torben Weis <weis@kde.org>
- 
+
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
    License as published by the Free Software Foundation; either
    version 2 of the License, or (at your option) any later version.
- 
+
    This library is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    Library General Public License for more details.
- 
+
    You should have received a copy of the GNU Library General Public License
    along with this library; see the file COPYING.LIB.  If not, write to
    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
    Boston, MA 02110-1301, USA.
-*/     
+*/
 
 #ifndef __parse_h__
 #define __parse_h__
@@ -23,7 +23,9 @@
 /*
  * Functions definition for yacc
  */
+void KTraderParse_mainParse( const char *_code );
 void KTraderParse_setParseTree( void *_ptr1 );
+void KTraderParse_error( const char* err );
 void* KTraderParse_newOR( void *_ptr1, void *_ptr2 );
 void* KTraderParse_newAND( void *_ptr1, void *_ptr2 );
 void* KTraderParse_newCMP( void *_ptr1, void *_ptr2, int _i );
--- kdelibs-3.5.2/kio/kio/tcpslavebase.cpp	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/tcpslavebase.cpp	2006-04-14 15:43:09.000000000 -0400
@@ -622,6 +622,7 @@
           !pkcs->getCertificate()->x509V3Extensions().certTypeSSLClient())) {
         certs.remove(*it);
       }
+      delete pkcs;
     }
 
     if (certs.isEmpty()) return;  // we had nothing else, and prompt failed
--- kdelibs-3.5.2/kio/kio/yacc.c	2005-10-10 11:05:42.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/yacc.c	2006-04-14 15:43:10.000000000 -0400
@@ -1,7 +1,7 @@
-/* A Bison parser, made by GNU Bison 1.875.  */
+/* A Bison parser, made by GNU Bison 2.0.  */
 
 /* Skeleton parser for Yacc-like parsing with Bison,
-   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002 Free Software Foundation, Inc.
+   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.
 
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
@@ -15,8 +15,8 @@
 
    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
-   Foundation, Inc., 51 Franklin Street, Fifth Floor,
-   Boston, MA 02110-1301, USA.  */
+   Foundation, Inc., 59 Temple Place - Suite 330,
+   Boston, MA 02111-1307, USA.  */
 
 /* As a special exception, when this file is copied by Bison into a
    Bison output file, you may use that output file without restriction.
@@ -45,8 +45,7 @@
 /* Using locations.  */
 #define YYLSP_NEEDED 0
 
-/* If NAME_PREFIX is specified substitute the variables and functions
-   names.  */
+/* Substitute the variable and function names.  */
 #define yyparse kiotraderparse
 #define yylex   kiotraderlex
 #define yyerror kiotradererror
@@ -139,7 +138,7 @@
      char *name;
      void *ptr;
 } YYSTYPE;
-/* Line 191 of yacc.c.  */
+/* Line 190 of yacc.c.  */
 #line 143 "yacc.tab.c"
 # define yystype YYSTYPE /* obsolescent; will be withdrawn */
 # define YYSTYPE_IS_DECLARED 1
@@ -151,23 +150,26 @@
 /* Copy the second part of user declarations.  */
 
 
-/* Line 214 of yacc.c.  */
+/* Line 213 of yacc.c.  */
 #line 155 "yacc.tab.c"
 
 #if ! defined (yyoverflow) || YYERROR_VERBOSE
 
+# ifndef YYFREE
+#  define YYFREE free
+# endif
+# ifndef YYMALLOC
+#  define YYMALLOC malloc
+# endif
+
 /* The parser invokes alloca or malloc; define the necessary symbols.  */
 
-# if YYSTACK_USE_ALLOCA
-#  define YYSTACK_ALLOC alloca
-# else
-#  ifndef YYSTACK_USE_ALLOCA
-#   if defined (alloca) || defined (_ALLOCA_H)
-#    define YYSTACK_ALLOC alloca
+# ifdef YYSTACK_USE_ALLOCA
+#  if YYSTACK_USE_ALLOCA
+#   ifdef __GNUC__
+#    define YYSTACK_ALLOC __builtin_alloca
 #   else
-#    ifdef __GNUC__
-#     define YYSTACK_ALLOC __builtin_alloca
-#    endif
+#    define YYSTACK_ALLOC alloca
 #   endif
 #  endif
 # endif
@@ -180,20 +182,20 @@
 #   include <stdlib.h> /* INFRINGES ON USER NAME SPACE */
 #   define YYSIZE_T size_t
 #  endif
-#  define YYSTACK_ALLOC malloc
-#  define YYSTACK_FREE free
+#  define YYSTACK_ALLOC YYMALLOC
+#  define YYSTACK_FREE YYFREE
 # endif
 #endif /* ! defined (yyoverflow) || YYERROR_VERBOSE */
 
 
 #if (! defined (yyoverflow) \
      && (! defined (__cplusplus) \
-	 || (YYSTYPE_IS_TRIVIAL)))
+	 || (defined (YYSTYPE_IS_TRIVIAL) && YYSTYPE_IS_TRIVIAL)))
 
 /* A type that is properly aligned for any stack member.  */
 union yyalloc
 {
-  short yyss;
+  short int yyss;
   YYSTYPE yyvs;
   };
 
@@ -203,13 +205,13 @@
 /* The size of an array large to enough to hold all stacks, each with
    N elements.  */
 # define YYSTACK_BYTES(N) \
-     ((N) * (sizeof (short) + sizeof (YYSTYPE))				\
+     ((N) * (sizeof (short int) + sizeof (YYSTYPE))			\
       + YYSTACK_GAP_MAXIMUM)
 
 /* Copy COUNT objects from FROM to TO.  The source and destination do
    not overlap.  */
 # ifndef YYCOPY
-#  if 1 < __GNUC__
+#  if defined (__GNUC__) && 1 < __GNUC__
 #   define YYCOPY(To, From, Count) \
       __builtin_memcpy (To, From, (Count) * sizeof (*(From)))
 #  else
@@ -245,7 +247,7 @@
 #if defined (__STDC__) || defined (__cplusplus)
    typedef signed char yysigned_char;
 #else
-   typedef short yysigned_char;
+   typedef short int yysigned_char;
 #endif
 
 /* YYFINAL -- State number of the termination state. */
@@ -344,11 +346,11 @@
    First, the terminals, then, starting at YYNTOKENS, nonterminals. */
 static const char *const yytname[] =
 {
-  "$end", "error", "$undefined", "NOT", "EQ", "NEQ", "LEQ", "GEQ", "LE", 
-  "GR", "OR", "AND", "TOKEN_IN", "EXIST", "MAX", "MIN", "VAL_BOOL", 
-  "VAL_STRING", "VAL_ID", "VAL_NUM", "VAL_FLOAT", "'~'", "'+'", "'-'", 
-  "'*'", "'/'", "'('", "')'", "$accept", "constraint", "bool", "bool_or", 
-  "bool_and", "bool_compare", "expr_in", "expr_twiddle", "expr", "term", 
+  "$end", "error", "$undefined", "NOT", "EQ", "NEQ", "LEQ", "GEQ", "LE",
+  "GR", "OR", "AND", "TOKEN_IN", "EXIST", "MAX", "MIN", "VAL_BOOL",
+  "VAL_STRING", "VAL_ID", "VAL_NUM", "VAL_FLOAT", "'~'", "'+'", "'-'",
+  "'*'", "'/'", "'('", "')'", "$accept", "constraint", "bool", "bool_or",
+  "bool_and", "bool_compare", "expr_in", "expr_twiddle", "expr", "term",
   "factor_non", "factor", 0
 };
 #endif
@@ -356,7 +358,7 @@
 # ifdef YYPRINT
 /* YYTOKNUM[YYLEX-NUM] -- Internal token number corresponding to
    token YYLEX-NUM.  */
-static const unsigned short yytoknum[] =
+static const unsigned short int yytoknum[] =
 {
        0,   256,   257,   258,   259,   260,   261,   262,   263,   264,
      265,   266,   267,   268,   269,   270,   271,   272,   273,   274,
@@ -482,7 +484,7 @@
 
 #define YYACCEPT	goto yyacceptlab
 #define YYABORT		goto yyabortlab
-#define YYERROR		goto yyerrlab1
+#define YYERROR		goto yyerrorlab
 
 
 /* Like YYERROR except do call yyerror.  This remains here temporarily
@@ -510,20 +512,53 @@
     }								\
 while (0)
 
+
 #define YYTERROR	1
 #define YYERRCODE	256
 
-/* YYLLOC_DEFAULT -- Compute the default location (before the actions
-   are run).  */
 
+/* YYLLOC_DEFAULT -- Set CURRENT to span from RHS[1] to RHS[N].
+   If N is 0, then set CURRENT to the empty location which ends
+   the previous symbol: RHS[0] (always defined).  */
+
+#define YYRHSLOC(Rhs, K) ((Rhs)[K])
 #ifndef YYLLOC_DEFAULT
-# define YYLLOC_DEFAULT(Current, Rhs, N)         \
-  Current.first_line   = Rhs[1].first_line;      \
-  Current.first_column = Rhs[1].first_column;    \
-  Current.last_line    = Rhs[N].last_line;       \
-  Current.last_column  = Rhs[N].last_column;
+# define YYLLOC_DEFAULT(Current, Rhs, N)				\
+    do									\
+      if (N)								\
+	{								\
+	  (Current).first_line   = YYRHSLOC (Rhs, 1).first_line;	\
+	  (Current).first_column = YYRHSLOC (Rhs, 1).first_column;	\
+	  (Current).last_line    = YYRHSLOC (Rhs, N).last_line;		\
+	  (Current).last_column  = YYRHSLOC (Rhs, N).last_column;	\
+	}								\
+      else								\
+	{								\
+	  (Current).first_line   = (Current).last_line   =		\
+	    YYRHSLOC (Rhs, 0).last_line;				\
+	  (Current).first_column = (Current).last_column =		\
+	    YYRHSLOC (Rhs, 0).last_column;				\
+	}								\
+    while (0)
+#endif
+
+
+/* YY_LOCATION_PRINT -- Print the location on the stream.
+   This macro was not mandated originally: define only if we know
+   we won't break user code: when these are the locations we know.  */
+
+#ifndef YY_LOCATION_PRINT
+# if YYLTYPE_IS_TRIVIAL
+#  define YY_LOCATION_PRINT(File, Loc)			\
+     fprintf (File, "%d.%d-%d.%d",			\
+              (Loc).first_line, (Loc).first_column,	\
+              (Loc).last_line,  (Loc).last_column)
+# else
+#  define YY_LOCATION_PRINT(File, Loc) ((void) 0)
+# endif
 #endif
 
+
 /* YYLEX -- calling `yylex' with the right arguments.  */
 
 #ifdef YYLEX_PARAM
@@ -546,36 +581,30 @@
     YYFPRINTF Args;				\
 } while (0)
 
-# define YYDSYMPRINT(Args)			\
-do {						\
-  if (yydebug)					\
-    yysymprint Args;				\
-} while (0)
-
-# define YYDSYMPRINTF(Title, Token, Value, Location)		\
+# define YY_SYMBOL_PRINT(Title, Type, Value, Location)		\
 do {								\
   if (yydebug)							\
     {								\
       YYFPRINTF (stderr, "%s ", Title);				\
       yysymprint (stderr, 					\
-                  Token, Value);	\
+                  Type, Value);	\
       YYFPRINTF (stderr, "\n");					\
     }								\
 } while (0)
 
 /*------------------------------------------------------------------.
 | yy_stack_print -- Print the state stack from its BOTTOM up to its |
-| TOP (cinluded).                                                   |
+| TOP (included).                                                   |
 `------------------------------------------------------------------*/
 
 #if defined (__STDC__) || defined (__cplusplus)
 static void
-yy_stack_print (short *bottom, short *top)
+yy_stack_print (short int *bottom, short int *top)
 #else
 static void
 yy_stack_print (bottom, top)
-    short *bottom;
-    short *top;
+    short int *bottom;
+    short int *top;
 #endif
 {
   YYFPRINTF (stderr, "Stack now");
@@ -605,9 +634,9 @@
 #endif
 {
   int yyi;
-  unsigned int yylineno = yyrline[yyrule];
+  unsigned int yylno = yyrline[yyrule];
   YYFPRINTF (stderr, "Reducing stack by rule %d (line %u), ",
-             yyrule - 1, yylineno);
+             yyrule - 1, yylno);
   /* Print the symbols being reduced, and their result.  */
   for (yyi = yyprhs[yyrule]; 0 <= yyrhs[yyi]; yyi++)
     YYFPRINTF (stderr, "%s ", yytname [yyrhs[yyi]]);
@@ -625,8 +654,7 @@
 int yydebug;
 #else /* !YYDEBUG */
 # define YYDPRINTF(Args)
-# define YYDSYMPRINT(Args)
-# define YYDSYMPRINTF(Title, Token, Value, Location)
+# define YY_SYMBOL_PRINT(Title, Type, Value, Location)
 # define YY_STACK_PRINT(Bottom, Top)
 # define YY_REDUCE_PRINT(Rule)
 #endif /* !YYDEBUG */
@@ -644,10 +672,6 @@
    SIZE_MAX < YYSTACK_BYTES (YYMAXDEPTH)
    evaluated with infinite-precision integer arithmetic.  */
 
-#if YYMAXDEPTH == 0
-# undef YYMAXDEPTH
-#endif
-
 #ifndef YYMAXDEPTH
 # define YYMAXDEPTH 10000
 #endif
@@ -729,15 +753,15 @@
   (void) yyvaluep;
 
   if (yytype < YYNTOKENS)
-    {
-      YYFPRINTF (yyoutput, "token %s (", yytname[yytype]);
-# ifdef YYPRINT
-      YYPRINT (yyoutput, yytoknum[yytype], *yyvaluep);
-# endif
-    }
+    YYFPRINTF (yyoutput, "token %s (", yytname[yytype]);
   else
     YYFPRINTF (yyoutput, "nterm %s (", yytname[yytype]);
 
+
+# ifdef YYPRINT
+  if (yytype < YYNTOKENS)
+    YYPRINT (yyoutput, yytoknum[yytype], *yyvaluep);
+# endif
   switch (yytype)
     {
       default:
@@ -753,10 +777,11 @@
 
 #if defined (__STDC__) || defined (__cplusplus)
 static void
-yydestruct (int yytype, YYSTYPE *yyvaluep)
+yydestruct (const char *yymsg, int yytype, YYSTYPE *yyvaluep)
 #else
 static void
-yydestruct (yytype, yyvaluep)
+yydestruct (yymsg, yytype, yyvaluep)
+    const char *yymsg;
     int yytype;
     YYSTYPE *yyvaluep;
 #endif
@@ -764,6 +789,10 @@
   /* Pacify ``unused variable'' warnings.  */
   (void) yyvaluep;
 
+  if (!yymsg)
+    yymsg = "Deleting";
+  YY_SYMBOL_PRINT (yymsg, yytype, yyvaluep, yylocationp);
+
   switch (yytype)
     {
 
@@ -791,10 +820,10 @@
 
 
 
-/* The lookahead symbol.  */
+/* The look-ahead symbol.  */
 int yychar;
 
-/* The semantic value of the lookahead symbol.  */
+/* The semantic value of the look-ahead symbol.  */
 YYSTYPE yylval;
 
 /* Number of syntax errors so far.  */
@@ -830,7 +859,7 @@
   int yyresult;
   /* Number of tokens to shift before error messages enabled.  */
   int yyerrstatus;
-  /* Lookahead token as an internal (translated) token number.  */
+  /* Look-ahead token as an internal (translated) token number.  */
   int yytoken = 0;
 
   /* Three stacks and their tools:
@@ -842,9 +871,9 @@
      to reallocate them elsewhere.  */
 
   /* The state stack.  */
-  short	yyssa[YYINITDEPTH];
-  short *yyss = yyssa;
-  register short *yyssp;
+  short int yyssa[YYINITDEPTH];
+  short int *yyss = yyssa;
+  register short int *yyssp;
 
   /* The semantic value stack.  */
   YYSTYPE yyvsa[YYINITDEPTH];
@@ -881,6 +910,9 @@
   yyssp = yyss;
   yyvsp = yyvs;
 
+
+  yyvsp[0] = yylval;
+
   goto yysetstate;
 
 /*------------------------------------------------------------.
@@ -906,7 +938,7 @@
 	   these so that the &'s don't force the real ones into
 	   memory.  */
 	YYSTYPE *yyvs1 = yyvs;
-	short *yyss1 = yyss;
+	short int *yyss1 = yyss;
 
 
 	/* Each stack pointer address is followed by the size of the
@@ -934,7 +966,7 @@
 	yystacksize = YYMAXDEPTH;
 
       {
-	short *yyss1 = yyss;
+	short int *yyss1 = yyss;
 	union yyalloc *yyptr =
 	  (union yyalloc *) YYSTACK_ALLOC (YYSTACK_BYTES (yystacksize));
 	if (! yyptr)
@@ -970,18 +1002,18 @@
 yybackup:
 
 /* Do appropriate processing given the current state.  */
-/* Read a lookahead token if we need one and don't already have one.  */
+/* Read a look-ahead token if we need one and don't already have one.  */
 /* yyresume: */
 
-  /* First try to decide what to do without reference to lookahead token.  */
+  /* First try to decide what to do without reference to look-ahead token.  */
 
   yyn = yypact[yystate];
   if (yyn == YYPACT_NINF)
     goto yydefault;
 
-  /* Not known => get a lookahead token if don't already have one.  */
+  /* Not known => get a look-ahead token if don't already have one.  */
 
-  /* YYCHAR is either YYEMPTY or YYEOF or a valid lookahead symbol.  */
+  /* YYCHAR is either YYEMPTY or YYEOF or a valid look-ahead symbol.  */
   if (yychar == YYEMPTY)
     {
       YYDPRINTF ((stderr, "Reading a token: "));
@@ -996,7 +1028,7 @@
   else
     {
       yytoken = YYTRANSLATE (yychar);
-      YYDSYMPRINTF ("Next token is", yytoken, &yylval, &yylloc);
+      YY_SYMBOL_PRINT ("Next token is", yytoken, &yylval, &yylloc);
     }
 
   /* If the proper action on seeing token YYTOKEN is to reduce or to
@@ -1016,8 +1048,8 @@
   if (yyn == YYFINAL)
     YYACCEPT;
 
-  /* Shift the lookahead token.  */
-  YYDPRINTF ((stderr, "Shifting token %s, ", yytname[yytoken]));
+  /* Shift the look-ahead token.  */
+  YY_SYMBOL_PRINT ("Shifting", yytoken, &yylval, &yylloc);
 
   /* Discard the token being shifted unless it is eof.  */
   if (yychar != YYEOF)
@@ -1073,179 +1105,179 @@
 
   case 3:
 #line 57 "yacc.y"
-    { KTraderParse_setParseTree( yyvsp[0].ptr ); ;}
+    { KTraderParse_setParseTree( (yyvsp[0].ptr) ); ;}
     break;
 
   case 4:
 #line 60 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 5:
 #line 63 "yacc.y"
-    { yyval.ptr = KTraderParse_newOR( yyvsp[-2].ptr, yyvsp[0].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newOR( (yyvsp[-2].ptr), (yyvsp[0].ptr) ); ;}
     break;
 
   case 6:
 #line 64 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 7:
 #line 67 "yacc.y"
-    { yyval.ptr = KTraderParse_newAND( yyvsp[-2].ptr, yyvsp[0].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newAND( (yyvsp[-2].ptr), (yyvsp[0].ptr) ); ;}
     break;
 
   case 8:
 #line 68 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 9:
 #line 71 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 1 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 1 ); ;}
     break;
 
   case 10:
 #line 72 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 2 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 2 ); ;}
     break;
 
   case 11:
 #line 73 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 3 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 3 ); ;}
     break;
 
   case 12:
 #line 74 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 4 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 4 ); ;}
     break;
 
   case 13:
 #line 75 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 5 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 5 ); ;}
     break;
 
   case 14:
 #line 76 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 6 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 6 ); ;}
     break;
 
   case 15:
 #line 77 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 16:
 #line 80 "yacc.y"
-    { yyval.ptr = KTraderParse_newIN( yyvsp[-2].ptr, KTraderParse_newID( yyvsp[0].name ) ); ;}
+    { (yyval.ptr) = KTraderParse_newIN( (yyvsp[-2].ptr), KTraderParse_newID( (yyvsp[0].name) ) ); ;}
     break;
 
   case 17:
 #line 81 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 18:
 #line 84 "yacc.y"
-    { yyval.ptr = KTraderParse_newMATCH( yyvsp[-2].ptr, yyvsp[0].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newMATCH( (yyvsp[-2].ptr), (yyvsp[0].ptr) ); ;}
     break;
 
   case 19:
 #line 85 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 20:
 #line 88 "yacc.y"
-    { yyval.ptr = KTraderParse_newCALC( yyvsp[-2].ptr, yyvsp[0].ptr, 1 ); ;}
+    { (yyval.ptr) = KTraderParse_newCALC( (yyvsp[-2].ptr), (yyvsp[0].ptr), 1 ); ;}
     break;
 
   case 21:
 #line 89 "yacc.y"
-    { yyval.ptr = KTraderParse_newCALC( yyvsp[-2].ptr, yyvsp[0].ptr, 2 ); ;}
+    { (yyval.ptr) = KTraderParse_newCALC( (yyvsp[-2].ptr), (yyvsp[0].ptr), 2 ); ;}
     break;
 
   case 22:
 #line 90 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 23:
 #line 93 "yacc.y"
-    { yyval.ptr = KTraderParse_newCALC( yyvsp[-2].ptr, yyvsp[0].ptr, 3 ); ;}
+    { (yyval.ptr) = KTraderParse_newCALC( (yyvsp[-2].ptr), (yyvsp[0].ptr), 3 ); ;}
     break;
 
   case 24:
 #line 94 "yacc.y"
-    { yyval.ptr = KTraderParse_newCALC( yyvsp[-2].ptr, yyvsp[0].ptr, 4 ); ;}
+    { (yyval.ptr) = KTraderParse_newCALC( (yyvsp[-2].ptr), (yyvsp[0].ptr), 4 ); ;}
     break;
 
   case 25:
 #line 95 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 26:
 #line 98 "yacc.y"
-    { yyval.ptr = KTraderParse_newNOT( yyvsp[0].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newNOT( (yyvsp[0].ptr) ); ;}
     break;
 
   case 27:
 #line 99 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 28:
 #line 102 "yacc.y"
-    { yyval.ptr = KTraderParse_newBRACKETS( yyvsp[-1].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newBRACKETS( (yyvsp[-1].ptr) ); ;}
     break;
 
   case 29:
 #line 103 "yacc.y"
-    { yyval.ptr = KTraderParse_newEXIST( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newEXIST( (yyvsp[0].name) ); ;}
     break;
 
   case 30:
 #line 104 "yacc.y"
-    { yyval.ptr = KTraderParse_newID( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newID( (yyvsp[0].name) ); ;}
     break;
 
   case 31:
 #line 105 "yacc.y"
-    { yyval.ptr = KTraderParse_newNUM( yyvsp[0].vali ); ;}
+    { (yyval.ptr) = KTraderParse_newNUM( (yyvsp[0].vali) ); ;}
     break;
 
   case 32:
 #line 106 "yacc.y"
-    { yyval.ptr = KTraderParse_newFLOAT( yyvsp[0].vald ); ;}
+    { (yyval.ptr) = KTraderParse_newFLOAT( (yyvsp[0].vald) ); ;}
     break;
 
   case 33:
 #line 107 "yacc.y"
-    { yyval.ptr = KTraderParse_newSTRING( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newSTRING( (yyvsp[0].name) ); ;}
     break;
 
   case 34:
 #line 108 "yacc.y"
-    { yyval.ptr = KTraderParse_newBOOL( yyvsp[0].valb ); ;}
+    { (yyval.ptr) = KTraderParse_newBOOL( (yyvsp[0].valb) ); ;}
     break;
 
   case 35:
 #line 109 "yacc.y"
-    { yyval.ptr = KTraderParse_newMAX2( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newMAX2( (yyvsp[0].name) ); ;}
     break;
 
   case 36:
 #line 110 "yacc.y"
-    { yyval.ptr = KTraderParse_newMIN2( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newMIN2( (yyvsp[0].name) ); ;}
     break;
 
 
     }
 
-/* Line 999 of yacc.c.  */
-#line 1248 "yacc.tab.c"
+/* Line 1037 of yacc.c.  */
+#line 1281 "yacc.tab.c"
 
   yyvsp -= yylen;
   yyssp -= yylen;
@@ -1286,18 +1318,33 @@
 	{
 	  YYSIZE_T yysize = 0;
 	  int yytype = YYTRANSLATE (yychar);
+	  const char* yyprefix;
 	  char *yymsg;
-	  int yyx, yycount;
+	  int yyx;
 
-	  yycount = 0;
 	  /* Start YYX at -YYN if negative to avoid negative indexes in
 	     YYCHECK.  */
-	  for (yyx = yyn < 0 ? -yyn : 0;
-	       yyx < (int) (sizeof (yytname) / sizeof (char *)); yyx++)
+	  int yyxbegin = yyn < 0 ? -yyn : 0;
+
+	  /* Stay within bounds of both yycheck and yytname.  */
+	  int yychecklim = YYLAST - yyn;
+	  int yyxend = yychecklim < YYNTOKENS ? yychecklim : YYNTOKENS;
+	  int yycount = 0;
+
+	  yyprefix = ", expecting ";
+	  for (yyx = yyxbegin; yyx < yyxend; ++yyx)
 	    if (yycheck[yyx + yyn] == yyx && yyx != YYTERROR)
-	      yysize += yystrlen (yytname[yyx]) + 15, yycount++;
-	  yysize += yystrlen ("syntax error, unexpected ") + 1;
-	  yysize += yystrlen (yytname[yytype]);
+	      {
+		yysize += yystrlen (yyprefix) + yystrlen (yytname [yyx]);
+		yycount += 1;
+		if (yycount == 5)
+		  {
+		    yysize = 0;
+		    break;
+		  }
+	      }
+	  yysize += (sizeof ("syntax error, unexpected ")
+		     + yystrlen (yytname[yytype]));
 	  yymsg = (char *) YYSTACK_ALLOC (yysize);
 	  if (yymsg != 0)
 	    {
@@ -1306,16 +1353,13 @@
 
 	      if (yycount < 5)
 		{
-		  yycount = 0;
-		  for (yyx = yyn < 0 ? -yyn : 0;
-		       yyx < (int) (sizeof (yytname) / sizeof (char *));
-		       yyx++)
+		  yyprefix = ", expecting ";
+		  for (yyx = yyxbegin; yyx < yyxend; ++yyx)
 		    if (yycheck[yyx + yyn] == yyx && yyx != YYTERROR)
 		      {
-			const char *yyq = ! yycount ? ", expecting " : " or ";
-			yyp = yystpcpy (yyp, yyq);
+			yyp = yystpcpy (yyp, yyprefix);
 			yyp = yystpcpy (yyp, yytname[yyx]);
-			yycount++;
+			yyprefix = " or ";
 		      }
 		}
 	      yyerror (yymsg);
@@ -1333,38 +1377,57 @@
 
   if (yyerrstatus == 3)
     {
-      /* If just tried and failed to reuse lookahead token after an
+      /* If just tried and failed to reuse look-ahead token after an
 	 error, discard it.  */
 
-      /* Return failure if at end of input.  */
-      if (yychar == YYEOF)
+      if (yychar <= YYEOF)
         {
-	  /* Pop the error token.  */
-          YYPOPSTACK;
-	  /* Pop the rest of the stack.  */
-	  while (yyss < yyssp)
-	    {
-	      YYDSYMPRINTF ("Error: popping", yystos[*yyssp], yyvsp, yylsp);
-	      yydestruct (yystos[*yyssp], yyvsp);
-	      YYPOPSTACK;
-	    }
-	  YYABORT;
+          /* If at end of input, pop the error token,
+	     then the rest of the stack, then return failure.  */
+	  if (yychar == YYEOF)
+	     for (;;)
+	       {
+
+		 YYPOPSTACK;
+		 if (yyssp == yyss)
+		   YYABORT;
+		 yydestruct ("Error: popping",
+                             yystos[*yyssp], yyvsp);
+	       }
         }
-
-      YYDSYMPRINTF ("Error: discarding", yytoken, &yylval, &yylloc);
-      yydestruct (yytoken, &yylval);
-      yychar = YYEMPTY;
-
+      else
+	{
+	  yydestruct ("Error: discarding", yytoken, &yylval);
+	  yychar = YYEMPTY;
+	}
     }
 
-  /* Else will try to reuse lookahead token after shifting the error
+  /* Else will try to reuse look-ahead token after shifting the error
      token.  */
   goto yyerrlab1;
 
 
-/*----------------------------------------------------.
-| yyerrlab1 -- error raised explicitly by an action.  |
-`----------------------------------------------------*/
+/*---------------------------------------------------.
+| yyerrorlab -- error raised explicitly by YYERROR.  |
+`---------------------------------------------------*/
+yyerrorlab:
+
+#ifdef __GNUC__
+  /* Pacify GCC when the user code never invokes YYERROR and the label
+     yyerrorlab therefore never appears in user code.  */
+  if (0)
+     goto yyerrorlab;
+#endif
+
+yyvsp -= yylen;
+  yyssp -= yylen;
+  yystate = *yyssp;
+  goto yyerrlab1;
+
+
+/*-------------------------------------------------------------.
+| yyerrlab1 -- common code for both syntax error and YYERROR.  |
+`-------------------------------------------------------------*/
 yyerrlab1:
   yyerrstatus = 3;	/* Each real token shifted decrements this.  */
 
@@ -1386,22 +1449,22 @@
       if (yyssp == yyss)
 	YYABORT;
 
-      YYDSYMPRINTF ("Error: popping", yystos[*yyssp], yyvsp, yylsp);
-      yydestruct (yystos[yystate], yyvsp);
-      yyvsp--;
-      yystate = *--yyssp;
 
+      yydestruct ("Error: popping", yystos[yystate], yyvsp);
+      YYPOPSTACK;
+      yystate = *yyssp;
       YY_STACK_PRINT (yyss, yyssp);
     }
 
   if (yyn == YYFINAL)
     YYACCEPT;
 
-  YYDPRINTF ((stderr, "Shifting error token, "));
-
   *++yyvsp = yylval;
 
 
+  /* Shift the error token. */
+  YY_SYMBOL_PRINT ("Shifting", yystos[yyn], yyvsp, yylsp);
+
   yystate = yyn;
   goto yynewstate;
 
@@ -1417,6 +1480,9 @@
 | yyabortlab -- YYABORT comes here.  |
 `-----------------------------------*/
 yyabortlab:
+  yydestruct ("Error: discarding lookahead",
+              yytoken, &yylval);
+  yychar = YYEMPTY;
   yyresult = 1;
   goto yyreturn;
 
@@ -1439,12 +1505,12 @@
 }
 
 
-#line 56 "yacc.y"
+#line 115 "yacc.y"
 
 
 void yyerror ( const char *s )  /* Called by yyparse on error */
 {
-    printf ("ERROR: %s\n", s);
+    KTraderParse_error( s );
 }
 
 void KTraderParse_mainParse( const char *_code )
--- kdelibs-3.5.2/kio/kio/yacc.y	2005-09-10 04:26:44.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kio/yacc.y	2006-04-14 15:43:09.000000000 -0400
@@ -116,7 +116,7 @@
 
 void yyerror ( const char *s )  /* Called by yyparse on error */
 {
-    printf ("ERROR: %s\n", s);
+    KTraderParse_error( s );
 }
 
 void KTraderParse_mainParse( const char *_code )
--- kdelibs-3.5.2/kio/kssl/kopenssl.cc	2006-03-17 05:19:09.000000000 -0500
+++ kdelibs-3.5.2-new/kio/kssl/kopenssl.cc	2006-04-14 15:42:58.000000000 -0400
@@ -322,6 +322,7 @@
              #elif defined(_AIX)
              << "libssl.a(libssl.so.0)"
 	     #elif defined(__APPLE__)
+	     << "libssl.0.9.7.dylib"
 	     << "libssl.dylib"
 	     << "libssl.0.9.dylib"
              #else
@@ -339,6 +340,7 @@
              #elif defined(_AIX)
              << "libcrypto.a(libcrypto.so.0)"
 	     #elif defined(__APPLE__)
+	     << "libcrypto.0.9.7.dylib"
 	     << "libcrypto.dylib"
 	     << "libcrypto.0.9.dylib"
 	     #else
--- kdelibs-3.5.2/kio/kssl/ksslinfodlg.cc	2005-10-10 11:05:44.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kssl/ksslinfodlg.cc	2006-04-14 15:43:10.000000000 -0400
@@ -433,7 +433,7 @@
             KURLLabel *mail = new KURLLabel(tmp, tmp, _frame);
             connect(mail, SIGNAL(leftClickedURL(const QString &)), mailCatcher, SLOT(mailClicked(const QString &)));
         } else {
-            new QLabel(tmp, _frame);
+            label = new QLabel(tmp, _frame);
         }
     }
     if (label && viewport()) {
--- kdelibs-3.5.2/kio/kssl/ksslpkcs12.cc	2005-10-10 11:05:44.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kssl/ksslpkcs12.cc	2006-04-14 15:43:10.000000000 -0400
@@ -200,14 +200,16 @@
 int len;
 
    len = kossl->i2d_PKCS12(_pkcs, NULL);
-   char *buf = new char[len];
-   p = (unsigned char *)buf;
-   kossl->i2d_PKCS12(_pkcs, &p);
-   QByteArray qba;
-   qba.setRawData(buf, len);
-   base64 = KCodecs::base64Encode(qba);
-   qba.resetRawData(buf, len);
-   delete[] buf;
+   if (len >= 0) {
+       char *buf = new char[len];
+       p = (unsigned char *)buf;
+       kossl->i2d_PKCS12(_pkcs, &p);
+       QByteArray qba;
+       qba.setRawData(buf, len);
+       base64 = KCodecs::base64Encode(qba);
+       qba.resetRawData(buf, len);
+       delete[] buf;
+   }
 #endif
 return base64;
 }
--- kdelibs-3.5.2/kio/kssl/ksslpkcs7.cc	2005-10-10 11:05:44.000000000 -0400
+++ kdelibs-3.5.2-new/kio/kssl/ksslpkcs7.cc	2006-04-14 15:43:10.000000000 -0400
@@ -129,14 +129,16 @@
 int len;
 
    len = kossl->i2d_PKCS7(_pkcs, NULL);
-   char *buf = new char[len];
-   p = (unsigned char *)buf;
-   kossl->i2d_PKCS7(_pkcs, &p);
-   QByteArray qba;
-   qba.setRawData(buf, len);
-   base64 = KCodecs::base64Encode(qba);
-   qba.resetRawData(buf, len);
-   delete[] buf;
+   if (len >= 0) {
+       char *buf = new char[len];
+       p = (unsigned char *)buf;
+       kossl->i2d_PKCS7(_pkcs, &p);
+       QByteArray qba;
+       qba.setRawData(buf, len);
+       base64 = KCodecs::base64Encode(qba);
+       qba.resetRawData(buf, len);
+       delete[] buf;
+    }
 #endif
 return base64;
 }
--- kdelibs-3.5.2/kio/misc/kpac/Makefile.am	2005-09-10 04:26:47.000000000 -0400
+++ kdelibs-3.5.2-new/kio/misc/kpac/Makefile.am	2006-04-14 15:42:58.000000000 -0400
@@ -10,7 +10,7 @@
 kded_proxyscout_la_SOURCES = proxyscout.skel proxyscout.cpp script.cpp \
                              downloader.cpp discovery.cpp
 kded_proxyscout_la_LDFLAGS = $(all_libraries) -module -avoid-version
-kded_proxyscout_la_LIBADD = $(LIB_KIO) $(top_builddir)/kjs/libkjs.la $(LIB_KDED)
+kded_proxyscout_la_LIBADD = $(LIB_KIO) $(top_builddir)/kjs/libkjs.la $(LIB_KDED) $(LIBRESOLV)
 
 kpac_dhcp_helper_SOURCES = kpac_dhcp_helper.c
 kpac_dhcp_helper_CFLAGS = $(KDE_USE_FPIE)
--- kdelibs-3.5.2/kio/misc/kpac/kpac_dhcp_helper.c	2006-01-19 12:06:12.000000000 -0500
+++ kdelibs-3.5.2-new/kio/misc/kpac/kpac_dhcp_helper.c	2006-04-14 15:43:10.000000000 -0400
@@ -94,6 +94,7 @@
 		exit(1);
 
 	if (setsockopt(sock, SOL_SOCKET, SO_BROADCAST, &bcast, sizeof(bcast)) == -1 ||
+		setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &bcast, sizeof(bcast)) == -1 ||
 		bind(sock, (struct sockaddr *)&addr, sizeof(addr)) == -1)
 		exit(1);
 
--- kdelibs-3.5.2/kio/misc/kwalletd/kwalletd.cpp	2005-10-10 11:05:43.000000000 -0400
+++ kdelibs-3.5.2-new/kio/misc/kwalletd/kwalletd.cpp	2006-04-14 15:43:10.000000000 -0400
@@ -418,6 +418,7 @@
 
 		const char *p = 0L;
 		while (!b->isOpen()) {
+			assert(kpd); // kpd can't be null if isOpen() is false
 #ifdef Q_WS_X11
 			XSetTransientForHint(qt_xdisplay(), kpd->winId(), w);
 #endif
--- kdelibs-3.5.2/kparts/factory.cpp	2005-10-10 11:06:27.000000000 -0400
+++ kdelibs-3.5.2-new/kparts/factory.cpp	2006-04-14 15:43:19.000000000 -0400
@@ -64,7 +64,7 @@
     if ( !factory )
         return 0;
     KParts::Factory *pfactory = dynamic_cast<KParts::Factory *>( factory );
-    if ( !factory )
+    if ( !pfactory )
         return 0;
     return pfactory->partInstance();
 }
--- kdelibs-3.5.2/kwallet/backend/sha1.cc	2005-11-08 17:39:19.000000000 -0500
+++ kdelibs-3.5.2-new/kwallet/backend/sha1.cc	2006-04-14 15:42:58.000000000 -0400
@@ -23,6 +23,9 @@
 #ifdef HAVE_SYS_TYPES_H
 #include <sys/types.h>
 #endif
+#ifdef HAVE_STDINT_H
+#include <stdint.h> /* For uintXX_t on OSX */
+#endif
 #ifdef HAVE_SYS_BITYPES_H
 #include <sys/bitypes.h> /* For uintXX_t on Tru64 */
 #endif
--- kdelibs-3.5.2/libkmid/sndcard.h	2005-10-10 11:06:40.000000000 -0400
+++ kdelibs-3.5.2-new/libkmid/sndcard.h	2006-04-14 15:43:21.000000000 -0400
@@ -31,9 +31,12 @@
  
 #ifdef HAVE_SYS_SOUNDCARD_H
  #include <sys/soundcard.h>
- #define HAVE_OSS_SUPPORT
 #elif defined(HAVE_MACHINE_SOUNDCARD_H)
  #include <machine/soundcard.h>
+#endif
+
+/* Check for OSS MIDI API */
+#if defined(SNDCTL_SEQ_NRSYNTHS) && defined(CTL_MAIN_VOLUME)
  #define HAVE_OSS_SUPPORT
 #else
  #undef HAVE_OSS_SUPPORT
--- kdelibs-3.5.2/libkscreensaver/kscreensaver.cpp	2005-10-10 11:05:22.000000000 -0400
+++ kdelibs-3.5.2-new/libkscreensaver/kscreensaver.cpp	2006-04-14 15:43:07.000000000 -0400
@@ -221,7 +221,7 @@
     kapp->flushX();
 
     if ( d->effectProgress >= bx*by ) {
-        delete block;
+        delete[] block;
         finished();
     }
 }
