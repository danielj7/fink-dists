Info2: <<
Package: qepcad%type_pkg[-gcc4.4]
Version: 1.53
Revision: 2
Source: http://www.usna.edu/Users/cs/qepcad/INSTALL/%{Ni}-B.%v.tar.gz
Source-MD5: 3cd351daa91a1fe9c37b8d78be4e0eab
Source2: http://www.usna.edu/Users/cs/qepcad/SLFQ/simplify-1.10.tar.gz
Source2-MD5: 418c7e8cb5c35a3900a4206611393abd
SourceDirectory: qesource
Type: -gcc4.4 (boolean)
BuildDepends: freeglut, readline5, saclib%type_pkg[-gcc4.4], sed, flex-devel, (%type_pkg[-gcc4.4]) gcc44
Depends: freeglut-shlibs, readline5-shlibs, singular, (%type_pkg[-gcc4.4]) gcc44-shlibs
Recommends: saclib%type_pkg[-gcc4.4]
# Strictly speaking, the recommends would be a "depends" when using qepcapd under gdb 
Conflicts: %{Ni}, %{Ni}-gcc44
Replaces: %{Ni}, %{Ni}-gcc44

PatchScript: <<
  #!/bin/sh -ev
  find . -name '*.o' -exec rm -f \{\} \;
  chmod -R a+rX	.	# else gdb can't find files when not working as root
  ## CFLAGS and LDFLAGS and the like :
  if [ "%type_raw[-gcc4.4]" == "-gcc4.4" ] ; then nopic=''; else nopic="-mdynamic-no-pic"; fi
  cflags="$nopic -Wall -Wextra -Wstrict-aliasing=2"
  # to strip binaries ( using "-s" would lead at launch to dyld error "lazy pointer not found" ):
  echo '__mh_execute_header' > symlst
  sed -i'' -e 's;(EXE)\|(LIBS);& -Wl,-x -exported_symbols_list %b/symlst -dead_strip;' \
	   -e "s,O4,O3 -fstrict-aliasing $cflags," \
	   -e "s,= *-g,&gdb3 -gfull $cflags -DNO_SACLIB_MACROS," \
	   {.,cad2d,plot2d,source}/Makefile extensions/adj2d/new_make
  sed -i'' -e "s;O4;O3 -fstrict-aliasing $cflags -Wl,-x -exported_symbols_list %b/symlst -dead_strip;" ../simplify/Makefile
  sed -i'' -e 's,gmake,make,' Makefile
#  sed -i'' -e 's,-lreadline,-L%p/lib &,' {../simplify,cad2d,source}/Makefile
  sed -i'' -e '/^GLBASE/s,/usr,&/X11R6,' -e '/^GLUTBASE/s,/usr,%p,' plot2d/Makefile
  ## using standard dirs, and no env vars :
  sed -i'' -e 's,qepath [+],string("%p/etc") +,' -e 's,default.qepcadrc,qepcadrc,' {cad2d/src,source/main}/MAIN.c
  sed -i'' -e 's,qepcad.help,%p/share/%{Ni}/&,' -e 's,/bin/%p,,' source/userint/HELPFRD.c
  sed -i'' -e 's,getenv("qe"),"%p",' {cad2d/src,source/main}/MAIN.c extensions/rend/PLOT_2D_CAD.cc source/userint/HELPFRD.c
  sed      -e 's,^#S,S,' -e 's,/usr,%p,' < default.qepcadrc > qepcadrc
  sed -i'' -e 's,default\.,%p/etc/,' README
  # no symbols taken fron libcurses
  sed -i'' -e 's, -lcurses,,' ../simplify/Makefile
  ## gcc43 (and higher I guess) requires the following (first for srtcpy, second and third for memmove):
  sed -i'' -e 's,#include <string>,#include <cstring>\n&,' extensions/rend/PLOT_2D_CAD.cc source/db/convenientstreams.h
  sed -i'' -e 's,#include <cstdlib>,#include <cstring>\n&,' source/db/unnamedpipe.h
<<
# We set ourselves the CPPFLAGS, else -I%p/include comes before -I.  (FIXME ! have to adapt def of INCLUDES in all Makefiles))
NoSetCPPFLAGS: true
NoSetLDFLAGS: true
SetLIBRARY_PATH: %p/lib
CompileScript: <<
  #!/bin/sh -ev
  export CC=gcc CXX=g++ PATH=%p/lib/flex/bin:$PATH
  if [ "%type_raw[-gcc4.4]" == "-gcc4.4" ] ; then export PATH=%p/lib/gcc4.4/bin:$PATH; fi
  export CPATH=%p/include
  export saclib=%p
  export qe=`pwd`
  make both
  cd cad2d; make both; cd -
  cd plot2d; make; cd -
  cd ../simplify ; make opt parse; cd -
<<
InstallScript: <<
  mkdir -p %i/include/%{Ni}/simplify %i/lib/%{Ni} %i/bin %i/share/%{Ni} %i/share/doc/%{Ni}/simplify %i/etc
  cp -p --parents `find . -name '*.h'` %i/include/%{Ni}
  rm -fR %i/include/%{Ni}/extensions/sfext/{espcad,extlang}
  cp -p `find . -name '*.a'` %i/lib/%{Ni}
  ranlib %i/lib/%{Ni}/*.a
  cp -p source/%{Ni}{,d} cad2d/cad2d{,d} plot2d/ADJ2D_plot %i/bin
  cp -p source/qepcad.help %i/share/%{Ni}
  cp -p qepcadrc %i/etc
  cp -p ../simplify/{slfq,parself} %i/bin
  cp -pPR ../simplify/{README,examples} %i/share/doc/%{Ni}/simplify
  cp -p ../simplify/*.h %i/include/%{Ni}/simplify
  chmod -R a+rX %i
<<
ConfFiles: %p/etc/qepcadrc
DocFiles: LICENSE LOG README TODO
Description: Tarski's Quantifier Elimination
DescUsage: <<
  http://www.usna.edu/Users/cs/qepcad/B/user/UsingQEPCAD.html
  Can be spectacular as a simplifier.
  For QE , still limited ..
<<
DescPackaging: <<
  Install by hand; there is no install target.
  Patch srcs so files can be installed in standard directories
  (and so as to avoid having to set additional env vars).
<<
License: OSI-Approved
Homepage: http://www.usna.edu/Users/cs/qepcad/B/QEPCAD.html
Maintainer: JF Mertens <jfmertens@users.sourceforge.net>
<<
