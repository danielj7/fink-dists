--- screen-4.0.3/Makefile.in.orig	2003-12-05 05:59:39.000000000 -0800
+++ screen-4.0.3/Makefile.in	2004-08-14 16:16:02.000000000 -0700
@@ -79,7 +79,7 @@
 	-if [ -f $(DESTDIR)$(bindir)/screen ] && [ ! -f $(DESTDIR)$(bindir)/screen.old ]; then mv $(DESTDIR)$(bindir)/screen $(DESTDIR)$(bindir)/screen.old; fi
 	rm -f $(DESTDIR)$(bindir)/screen
 	(cd $(DESTDIR)$(bindir) && ln -sf $(SCREEN) screen)
-	cp $(srcdir)/utf8encodings/?? $(DESTDIR)$(SCREENENCODINGS)
+	cp $(srcdir)/utf8encodings/?? $(DSTROOT)$(SCREENENCODINGS)
 
 ###############################################################################
 install: installdirs install_bin
@@ -95,7 +95,7 @@
 
 installdirs:
 # Path leading to ETCSCREENRC and Socketdirectory not checked.
-	$(srcdir)/etc/mkinstalldirs $(DESTDIR)$(bindir) $(DESTDIR)$(SCREENENCODINGS)
+	$(srcdir)/etc/mkinstalldirs $(DESTDIR)$(bindir) $(DSTROOT)$(SCREENENCODINGS)
 	cd doc ; $(MAKE) installdirs
 
 uninstall: .version
@@ -122,7 +122,7 @@
 	sh $(srcdir)/tty.sh tty.c
 
 comm.h: comm.c comm.sh config.h
-	AWK=$(AWK) CC="$(CC) $(CFLAGS)" srcdir=${srcdir} sh $(srcdir)/comm.sh
+	AWK=$(AWK) srcdir=${srcdir} sh $(srcdir)/comm.sh
 
 osdef.h: osdef.sh config.h osdef.h.in
 	CPP="$(CPP) $(CPPFLAGS)" srcdir=${srcdir} sh $(srcdir)/osdef.sh
--- screen-4.0.3/config.h.in.orig	2006-01-27 21:28:55.000000000 -0800
+++ screen-4.0.3/config.h.in	2006-01-27 21:30:48.000000000 -0800
@@ -208,14 +208,14 @@
  * If screen is installed with permissions to update /etc/utmp (such
  * as if it is installed set-uid root), define UTMPOK.
  */
-#define UTMPOK
+#undef UTMPOK
 
 /* Set LOGINDEFAULT to one (1)
  * if you want entries added to /etc/utmp by default, else set it to
  * zero (0).
  * LOGINDEFAULT will be one (1) whenever LOGOUTOK is undefined!
  */
-#define LOGINDEFAULT	1
+#undef LOGINDEFAULT
 
 /* Set LOGOUTOK to one (1)
  * if you want the user to be able to log her/his windows out.
@@ -231,7 +231,7 @@
  * Set CAREFULUTMP to one (1) if you want that users have at least one
  * window per screen session logged in.
  */
-#define LOGOUTOK 1
+#undef LOGOUTOK
 #undef CAREFULUTMP
 
 
--- screen-4.0.3/configure.orig	2005-09-19 18:44:14.000000000 -0700
+++ screen-4.0.3/configure	2005-09-19 19:20:43.000000000 -0700
@@ -5572,7 +5572,7 @@
 
 #include <time.h> /* to get time_t on SCO */
 #include <sys/types.h>
-#if defined(SVR4) && !defined(DGUX)
+#if (defined(SVR4) || defined(__APPLE__)) && !defined(DGUX)
 #include <utmpx.h>
 #define utmp utmpx
 #else
@@ -5581,6 +5581,10 @@
 #ifdef __hpux
 #define pututline _pututline
 #endif
+#ifdef __APPLE__
+#define pututline pututxline
+#define getutent getutxent
+#endif
 
 int
 main ()
--- screen-4.0.3/pty.c.orig	2005-09-19 18:22:02.000000000 -0700
+++ screen-4.0.3/pty.c	2005-09-19 19:08:02.000000000 -0700
@@ -34,7 +34,7 @@
 #endif
 
 /* for solaris 2.1, Unixware (SVR4.2) and possibly others */
-#ifdef HAVE_SVR4_PTYS
+#if defined(HAVE_SVR4_PTYS) && !defined(__APPLE__)
 # include <sys/stropts.h>
 #endif
 
--- screen-4.0.2/screen.csh.orig	Thu Jun 27 05:51:29 2002
+++ screen-4.0.2/screen.csh	Thu Jun 27 05:51:22 2002
@@ -0,0 +1,6 @@
+# screen.csh
+if ($?version) then
+   if ("$version" =~ tcsh*) then
+      complete screen n@-r@F:/tmp/uscreens/S-$USER@
+   endif
+endif

--- screen-4.0.3/window.c.orig	2006-09-05 17:08:57.000000000 -0700
+++ screen-4.0.3/window.c	2006-09-05 17:15:33.000000000 -0700
@@ -25,6 +25,7 @@
 #include <sys/stat.h>
 #include <signal.h>
 #include <fcntl.h>
+#include <unistd.h>
 #ifndef sun
 # include <sys/ioctl.h>
 #endif
@@ -1387,6 +1388,38 @@
   return pid;
 }
 
+#ifdef RUN_LOGIN
+/*
+ * All of the logic to maintain utmpx is now built into /usr/bin/login, so
+ * all we need to do is call it, and pass the shell command to it.
+ */
+extern char *LoginName;
+
+static int
+run_login(const char *path, char *const argv[], char *const envp[])
+{
+  const char *shargs[MAXARGS + 1 + 3];
+  const char **fp, **tp;
+
+  if (access(path, X_OK) < 0)
+    return -1;
+  shargs[0] = "login";
+  shargs[1] = (*argv[0] == '-') ? "-pfq" : "-pflq";
+  shargs[2] = LoginName;
+  shargs[3] = path;
+  fp = (const char **)argv + 1;
+  tp = shargs + 4;
+  /* argv has already been check for length */
+  while ((*tp++ = *fp++) != NULL) {}
+  /* shouldn't return unless there was an error */
+  return (execve("/usr/bin/login", (char *const*)shargs, envp));
+}
+
+/* replace the following occurrences of execve() with run_login() */
+#define execve run_login
+
+#endif /* RUN_LOGIN */
+
 void
 execvpe(prog, args, env)
 char *prog, **args, **env;
diff -ruN screen-4.0.3/etc/etcscreenrc screen-4.0.3-patched/etc/etcscreenrc
--- screen-4.0.3/etc/etcscreenrc	2003-12-05 05:46:13.000000000 -0800
+++ screen-4.0.3-patched/etc/etcscreenrc	2007-08-19 20:17:37.000000000 -0700
@@ -10,7 +10,7 @@
 
 #defflow on # will force screen to process ^S/^Q
 
-deflogin on
+#deflogin on
 #autodetach off
 
 vbell on
@@ -88,7 +88,7 @@
 #make them better
 bind \\ quit
 bind K kill
-bind I login on
-bind O login off
+#bind I login on
+#bind O login off
 bind } history
 
