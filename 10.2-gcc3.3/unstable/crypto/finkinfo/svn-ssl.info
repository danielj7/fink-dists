Package: svn-ssl
Version: 1.0.1
Revision: 1
Description: Compelling replacement for CVS - svnserve, tools (with SSL)
License: BSD
Maintainer: Christian Schaffner <chris01@users.sourceforge.net>

# Dependencies:
Depends: %N-shlibs (= %v-%r)
BuildDepends: apr-ssl (>= 0.9.5-3), db42-ssl, gdbm3, expat (>= 1.95.6-2), libxml2 (>= 2.5.10-12), python23 (>= 1:2.3.3-14) | python23-nox (>= 1:2.3.3-14), fink (>= 0.16.0-1), neon24-ssl (>= 0.24.4-1), openldap-ssl-dev (>= 2.1.22-14), cyrus-sasl2-dev (>= 2.1.15-13), openssl097-dev, texinfo (>= 4.2-22), libiconv-dev (>= 1.9.1-11), apache2-ssl-dev (>= 2.0.48-5), system-java13-dev, dlcompat-dev
Conflicts: svn-client, svn-client-ssl (<= 0.26.0-2), apache2 (<< 2.0.47-1)
Replaces: svn-client, svn-client-ssl (<= 0.26.0-2)

# Unpack Phase:
Source: http://svn.collab.net/tarballs/subversion-%v.tar.gz
Source-MD5: 80c5980c3402c160b9d62c7b4a288599

# Patch Phase:
Patch: %n.patch

# Compile Phase:
ConfigureParams: --libexecdir='${prefix}/lib/svn' --mandir='${prefix}/share/man' --infodir='${prefix}/share/info' --with-neon=%p --with-apr=%p --with-apr-util=%p --enable-shared --with-apxs=%p/sbin/apxs --without-apache --disable-mod-activation --with-jdk=/System/Library/Frameworks/JavaVM.framework/Versions/CurrentJDK/Home --without-swig --with-python=%p/bin/python2.3 --without-perl
SetCPPFLAGS: -I%p/include/db4 -no-cpp-precomp
GCC: 3.3
CompileScript: <<

 ### Remove packages that are installed by fink
 rm -rf neon
 rm -rf apr
 rm -rf apr-util
 
 ### Configure shared
 perl -pi.bak -e "s/hardcode_direct=yes/hardcode_direct=no/" configure
 ./configure %c
 perl -pi -e 's/^fast_install=yes/fast_install=needless/g' libtool
 
 ### make everything shared
 make
 make check
<<

# Install Phase:
DocFiles: BUGS CHANGES COMMITTERS COPYING HACKING INSTALL README
InstallScript: <<
 make install DESTDIR=%d
 
 ### Install docu
 /usr/bin/install -d %i/share
 /usr/bin/install -d %i/share/doc
 /usr/bin/install -d %i/share/doc/%n
 cp -r www %i/share/doc/%n
 
 ### Configure and install examples, tools and notes
 sed -i -e 's;#!/usr/bin/env python2;#!/usr/bin/env %p/bin/python2.3;' tools/backup/*.py
 sed -i -e 's;#!/usr/bin/env python2;#!/usr/bin/env %p/bin/python2.3;' tools/client-side/*.py
 sed -i -e 's;#!/usr/bin/env python2;#!/usr/bin/env %p/bin/python2.3;' tools/dev/*.py
 sed -i -e 's;#!/usr/bin/env python2;#!/usr/bin/env %p/bin/python2.3;' tools/examples/*.py
 sed -i -e 's;#!/usr/bin/env python2;#!/usr/bin/env %p/bin/python2.3;' tools/hook-scripts/mailer/*.py
 sed -i -e 's;#!/usr/bin/env python2;#!/usr/bin/env %p/bin/python2.3;' tools/hook-scripts/mailer/tests/*.py
 sed -i -e 's;#!/usr/bin/env python2;#!/usr/bin/env %p/bin/python2.3;' tools/hook-scripts/*.py
 
 /usr/bin/install -d %i/share/%n
 cp -r tools/backup %i/share/%n/tools
 cp -r tools/client-side %i/share/%n/tools
 cp -r tools/dev %i/share/%n/tools
 cp -r tools/examples %i/share/%n/tools
 cp -r tools/hook-scripts %i/share/%n/tools
 cp -r tools/test-scripts %i/share/%n/tools
 
 cp -r notes %i/share/%n
 cp -r contrib %i/share/%n
 
 ### Install binaries
 /usr/bin/install -d %i/bin
 /usr/bin/install -m 755 svn-config %i/bin
 /usr/bin/install -d %i/var
 /usr/bin/install -m 770 -d %i/var/svn
 chown www:admin %i/var/svn
<<
SplitOff: <<
  Description: Compelling replacement for CVS - Development headers and libraries (with SSL)
  Package: %N-dev
  Depends: %N-shlibs (= %v-%r)
  BuildDependsOnly: True
  Conflicts: svn-client-ssl (<= 0.26.0-2)
  Replaces: svn-client-ssl (<= 0.26.0-2)
  Files: <<
    bin/svn-config
    include
    lib/*.a
    lib/*.la
    lib/libsvn_client-1.dylib
    lib/libsvn_delta-1.dylib
    lib/libsvn_diff-1.dylib
    lib/libsvn_fs-1.dylib
    lib/libsvn_ra-1.dylib
    lib/libsvn_ra_dav-1.dylib
    lib/libsvn_ra_local-1.dylib
    lib/libsvn_ra_svn-1.dylib
    lib/libsvn_repos-1.dylib
    lib/libsvn_subr-1.dylib
    lib/libsvn_wc-1.dylib
  <<
  DocFiles: COPYING HACKING
<<
SplitOff2: <<
  Description: Compelling replacement for CVS - Shared libraries (with SSL)
  Package: %N-shlibs
  Conflicts: svn-client-ssl (<= 0.26.0-2)
  Replaces: svn-client-ssl (<= 0.26.0-2)
  Depends: apr-ssl-shlibs (>= 0.9.5-2), db42-ssl-shlibs, gdbm3-shlibs, expat-shlibs (>= 1.95.6-2), libxml2-shlibs (>= 2.5.10-12), neon24-ssl-shlibs (>= 0.24.4-1), openldap-ssl-shlibs (>= 2.1.22-14), cyrus-sasl2-shlibs (>= 2.1.15-13), openssl097-shlibs, system-java13, dlcompat-shlibs
  Files: <<
    lib/libsvn_client-1.0.0.0.dylib
    lib/libsvn_delta-1.0.0.0.dylib
    lib/libsvn_diff-1.0.0.0.dylib
    lib/libsvn_fs-1.0.0.0.dylib
    lib/libsvn_ra-1.0.0.0.dylib
    lib/libsvn_ra_dav-1.0.0.0.dylib
    lib/libsvn_ra_local-1.0.0.0.dylib
    lib/libsvn_ra_svn-1.0.0.0.dylib
    lib/libsvn_repos-1.0.0.0.dylib
    lib/libsvn_subr-1.0.0.0.dylib
    lib/libsvn_wc-1.0.0.0.dylib
    lib/libsvn_client-1.0.dylib
    lib/libsvn_delta-1.0.dylib
    lib/libsvn_diff-1.0.dylib
    lib/libsvn_fs-1.0.dylib
    lib/libsvn_ra-1.0.dylib
    lib/libsvn_ra_dav-1.0.dylib
    lib/libsvn_ra_local-1.0.dylib
    lib/libsvn_ra_svn-1.0.dylib
    lib/libsvn_repos-1.0.dylib
    lib/libsvn_subr-1.0.dylib
    lib/libsvn_wc-1.0.dylib
  <<
  Shlibs: <<
    %p/lib/libsvn_client-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_delta-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_diff-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_fs-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_ra-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_ra_dav-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_ra_local-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_ra_svn-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_repos-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_subr-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
    %p/lib/libsvn_wc-1.0.dylib 1.0.0 %n (>= 0.30.0-11)
  <<
  DocFiles: BUGS CHANGES COMMITTERS COPYING HACKING INSTALL README
<<
SplitOff3: <<
  Description: Compelling replacement for CVS - Client (with SSL)
  Package: svn-client-ssl
  Depends: %N-shlibs (= %v-%r)
  Conflicts: svn-client-ssl (<= 0.26.0-2)
  Replaces: svn-client-ssl (<= 0.26.0-2)
  Files: <<
    bin/svn
    bin/svnlook
    bin/svnversion
    share/man/man1/svn.1
    share/man/man1/svnlook.1
  <<
  DocFiles: BUGS CHANGES COMMITTERS COPYING HACKING INSTALL README
  DescUsage: <<
    This installs the subversion client.
    Type 'svn help' for usage.
    
    WARNING:
    This client may be incompatible with ra_dav servers <= 0.35
  <<
<<
SplitOff4: <<
  Package: libapache2-ssl-mod-svn
  Depends: %N-shlibs (= %v-%r), apache2-ssl (>= 2.0.48-5)
  Files: <<
    lib/apache2
    var/svn
  <<
  DocFiles: COPYING HACKING INSTALL
  Description: Compelling replacement for CVS - mod_svn (with SSL)
  DescUsage: <<
    This installs the subversion network server for apache2.
    Please read section III C in the file 
    /sw/share/doc/libapache2-ssl-mod-svn/INSTALL
    for informations on how to run a subversion server via apache2.
    
    You could install the repositories under the preconfigured directory
    /sw/var/svn
    which should have the correct permissions. Make sure that all files
    in the new repository have the correct permissions for apache to read 
    and write. E.g. run 'chown -R www /sw/var/svn/yourrepos' and 
    'chmod -R go-rwx /sw/var/svn/yourrepos'.
    
    You then need to add the following lines to your /sw/etc/apache2/httpd.conf
    file:
    <Location /svn/yourrepos>
      DAV svn
      SVNPath /sw/var/svn/yourrepos
    </Location>
    
    Your repository should show up at <http://localhost/svn/yourrepos>. If it 
    does not check your apache2 logs at /sw/var/apache2/logs/error_log
    
    If you need the examples or the tools (e.g. svnadmin) install the 
    'svn-ssl' package.
  <<
  PostInstScript: <<
    APXS=%p/sbin/apxs
    MOD_PREFIX=`$APXS -q LIBEXECDIR`

    # Enable svn modules
    MODULENAME=dav_svn
    MODULE=$MOD_PREFIX/mod_$MODULENAME.so
    echo "Enabling mod_$MODULENAME module..."
    $APXS -e -a -n $MODULENAME $MODULE

    MODULENAME=authz_svn
    MODULE=$MOD_PREFIX/mod_$MODULENAME.so
    echo "Enabling mod_$MODULENAME module..."
    $APXS -e -a -n $MODULENAME $MODULE

    echo "Restarting apache2..."
    %p/sbin/apachectl graceful
  <<
  PreRmScript: <<
    if [ "$1" != "remove" -a "$1" != "purge" ]; then
      exit 0
    fi

    # Disable svn modules
    APXS=%p/sbin/apxs
    MOD_PREFIX=`$APXS -q LIBEXECDIR`

    MODULENAME=dav_svn
    MODULE=$MOD_PREFIX/mod_$MODULENAME.so
    echo "Disabling mod_$MODULENAME module..."
    $APXS -e -A -n $MODULENAME $MODULE

    MODULENAME=authz_svn
    MODULE=$MOD_PREFIX/mod_$MODULENAME.so
    echo "Disabling mod_$MODULENAME module..."
    $APXS -e -A -n $MODULENAME $MODULE

    echo "#####################################################################"
    echo "The subversion apache modules are now disabled in the"
    echo "%p/etc/apache2/httpd.conf file and will be removed. Please make sure"
    echo "that you haven't any svn repositories still enabled in your"
    echo "%p/etc/apache2/httpd.conf file. You then should restart apache by"
    echo "typing '%p/sbin/apachectl graceful'."
    echo "#####################################################################"
  <<
<<

PostInstScript: <<
 echo ""
 echo "PLEAE NOTE:"
 echo "As of release 0.35.0, Subversion once again does deltification"
 echo "automatically.  This means that the deltification step most"
 echo "repositories introduced into their post-commit hooks as of"
 echo "release 0.33.0 should now be reverted.  Look for a line with"
 echo "'svnadmin deltify' in hooks/post-commit, and remove it."
 echo ""
 echo "NOTICE:"
 echo "#####################################################################"
 echo "##  WARNING: Incompatible change in database in 0.34 release       ##"
 echo "#####################################################################"
 echo "##                                                                 ##"
 echo "## The 0.34 release made an incompatible change to the Subversion  ##"
 echo "## database. Repositories created with versions of Subversion      ##"
 echo "## prior to 0.34 will not work with Subversion 0.34 and later.     ##"
 echo "## To  upgrade, first use 'svnadmin dump' with  your existing      ##"
 echo "## Subversion binaries. Then upgrade your binaries to 0.34, and    ##"
 echo "## use 'svnadmin load' to create a new repository from your        ##"
 echo "## dumpfile.                                                       ##"
 echo "## Don't  forget  to  copy any custom configuration/hooks from the ##"
 echo "## old to the new repository.                                      ##"
 echo "##                                                                 ##"
 echo "#####################################################################"
 echo ""
 echo "Please see the notes/repository_upgrade_HOWTO document for"
 echo "documentation on how to update an old repos."
 echo ""
 echo "Also located here:"
 echo " <http://svn.collab.net/repos/svn/trunk/notes/repos_upgrade_HOWTO>"
<<

DescDetail: <<
The goal of the Subversion project is to build a version control system that is
a compelling replacement for CVS in the open source community. 
	
Why should I switch to Subversion, after all CVS is the standard?  Some
advantages of Subversion include: 
- Commits are atomic
- Moving and renaming are versioned.
- Working with directories are easy. E.g. adding a directory adds all
  sub-files and folders to the repository.
- It is fast: branching and tagging are cheap (constant time) operations,
  client/server protocol sends diffs in both directions, and in general time
  are proportional to change size, not project size.
- Meta-data is versioned per file, e.g. store the `execute' permission flag on
  files in the repository.
- Efficient handling of binary files - it uses a binary diffing algorithm to
  transmit and store successive revisions.

Is Subversion stable enough for me to use for my own projects?  The Developers
think so! Read the full FAQ answer on the website:
<http://subversion.tigris.org/project_faq.html#stable>

Subversion is broken into these packages in fink:
(The -ssl variants enable ssl encryption.)

- The "svn-client-ssl" package installs a comman-line client program for using
  subversion. Type 'fink describe svn-client-ssl' to get usage help.
  
- The "svn-ssl" package installs a stand-alone server 'svnserve'.
  Install this package if you want to maintain a stand-alone server.
  
- The "libapache2-ssl-mod-svn" package contains an apache2 module to enable
  serving a repository via web-dav. Type 'fink describe libapache2-ssl-mod-svn'
  to get usage help.

- The "svn-ssl-shlibs" package contains the shared libraries for the other
  packages. It is installed automatically by fink when needed.

- The "svn-ssl-dev" package contains the development headers and libraries.
  It is installed automatically by fink when needed.
  
For More Information, check the main Subversion website below and read the book
at <http://svnbook.red-bean.com/>. Also look in /sw/share/svn-ssl/notes and
/sw/share/svn-ssl/contrib
<<
DescUsage: <<
 Type 'svnserve --help', 'man svnserve', 'svnadmin help', or 'man svnadmin'
 for usage.
 Some tools (e.g. hook and back scripts) and examples are stored in 
 /sw/share/svn-ssl/tools

 PLEAE NOTE:
 As of release 0.35.0, Subversion once again does deltification
 automatically.  This means that the deltification step most
 repositories introduced into their post-commit hooks as of
 release 0.33.0 should now be reverted.  Look for a line with
 "svnadmin deltify" in hooks/post-commit, and remove it.

 NOTICE:
#####################################################################
##  WARNING: Incompatible change in database in 0.34 release       ##
#####################################################################
##                                                                 ##
## The 0.34 release made an incompatible change to the Subversion  ##
## database. Repositories created with versions of Subversion      ##
## prior to 0.34 will not work with Subversion 0.34 and later.     ##
## To  upgrade, first use 'svnadmin dump' with  your existing      ##
## Subversion binaries. Then upgrade your binaries to 0.34, and    ##
## use 'svnadmin load' to create a new repository from your        ##
## dumpfile.                                                       ##
## Don't  forget  to  copy any custom configuration/hooks from the ##
## old to the new repository.                                      ##
##                                                                 ##
#####################################################################

 Please see the /sw/share/svn-ssl/notes/repos_upgrade_HOWTO 
 document for documentation on how to update an old repos.
 Also located here:
  <http://svn.collab.net/repos/svn/trunk/notes/repos_upgrade_HOWTO>
<<
DescPort: <<
Patch needed to stop relinking a .dylib in the install path, 
but hardcoding the %p/lib path in the link command (i.e. %p) instead 
of using %i

The patch also fixes problem with dependency_libs in other packages 
having -ldb-4.1 ot libdb-4.1.la in there, so that libtool ignores 
these.

Many thanks to Peter O'Gorman for the help with the libtool patch.

Prebinding cannot be enabled at this time since apr is not built 
prebound.
Once this is fixed, one could try to enable building two_level by doing:
perl -pi -e 's,-flat_namespace -undefined suppress,,g' configure
If that fails, maybe try to add '-lfoo' to Makefile.in
Or, if that fails too,  change '-undefined suppress -flat_namespace' 
to '-undefined dynamic_lookup'
<<
Homepage: http://subversion.tigris.org/
