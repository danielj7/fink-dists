diff -ruN ccp4-5.0.2-orig/ccp4i/etc/configure.def.dist ccp4-5.0.2/ccp4i/etc/configure.def.dist
--- ccp4-5.0.2-orig/ccp4i/etc/configure.def.dist	2004-01-26 03:13:25.000000000 -0800
+++ ccp4-5.0.2/ccp4i/etc/configure.def.dist	2004-08-08 14:56:41.000000000 -0700
@@ -53,8 +53,8 @@
 MESSAGE                   _text				""
 BLT_LIBRARY               _text                     ""
 MENU_LENGTH               _positiveint              25
-HYPERTEXT_VIEWER          _text                     netscape
-START_NETSCAPE	          _text			    netscape
+HYPERTEXT_VIEWER          _text                     Safari  
+START_NETSCAPE	          _text			    open    
 O_MAPMAN                  _text                     mapman
 MAPMAN_MAXSIZE		  _positiveint		    4194304
 QUANTA_MBKALL             _text                     mbkall
diff -ruN ccp4-5.0.2-orig/ccp4i/src/CCP4_utils.tcl ccp4-5.0.2/ccp4i/src/CCP4_utils.tcl
--- ccp4-5.0.2-orig/ccp4i/src/CCP4_utils.tcl	2004-05-26 07:43:11.000000000 -0700
+++ ccp4-5.0.2/ccp4i/src/CCP4_utils.tcl	2004-09-14 13:53:40.000000000 -0700
@@ -1257,7 +1257,10 @@
     return $status
   }
 
-  set data $MTZ_file_data($param)
+  if { [ catch { set data $MTZ_file_data($param) } result ] } {
+    return 0
+  }
+
   return 1
 
 }
@@ -1359,6 +1362,11 @@
     WarningMessage "ERROR extracting data from $file"
     return {}
   }
+  # Return failure if there are no datasets
+  set ndatasets $MTZ_file_data(NDATASETS)
+  if { $ndatasets < 1 } {
+    return {}
+  }
   # Sort the XNAMES list and return only the unique items i.e.
   # no duplicates 
   return [lsort -unique $MTZ_file_data(XNAMES)]
@@ -1379,6 +1387,11 @@
     WarningMessage "ERROR extracting data from $file"
     return {}
   }
+  # Return failure if there are no datasets
+  set ndatasets $MTZ_file_data(NDATASETS)
+  if { $ndatasets < 1 } {
+    return {}
+  }
   # Get a list of dataset names belonging to this crystal
   set i -1; set datasets {}
   foreach xname $MTZ_file_data(XNAMES) {
@@ -1543,7 +1556,6 @@
         return -2
       }
    }
-
    set MTZ_file_data(LOADED) 0
    set MTZ_file_data(FILE) $file
    set MTZ_file_data(CHANGED) $changed
diff -ruN ccp4-5.0.2-orig/ccp4i/tasks/refmac5.tcl ccp4-5.0.2/ccp4i/tasks/refmac5.tcl
--- ccp4-5.0.2-orig/ccp4i/tasks/refmac5.tcl	2004-06-10 03:33:39.000000000 -0700
+++ ccp4-5.0.2/ccp4i/tasks/refmac5.tcl	2004-08-16 22:40:53.000000000 -0700
@@ -185,14 +185,18 @@
 	  # parameters are set such that keywords will be generated
 	  # in the keyworded script for this domain
 	  if { $array(NGROUPS,$i) > 0 } {
+	      set ngroups 0
 	      for { set j 1 } { $j <= $array(NGROUPS,$i) } { incr j } {
 		  if { $array(RES1,[subst $i]_[subst $j]) != "" && \
 			   $array(RES2,[subst $i]_[subst $j]) != "" && \
 			   $array(CHAIN1,[subst $i]_[subst $j]) != "" } {
-		      # Domain is defined
-		      incr ndomains
+		      # This group is defined
+		      incr ngroups
 		  }
 	      }
+	      # If all the groups in the domain are defined, then
+	      # the domain is also defined
+	      if { $array(NGROUPS,$i) == $ngroups } { incr ndomains }
 	  }
       }
       # Check that all domains are defined
diff -ruN ccp4-5.0.2-orig/ccp4i/utils/pdb_utils.tcl ccp4-5.0.2/ccp4i/utils/pdb_utils.tcl
--- ccp4-5.0.2-orig/ccp4i/utils/pdb_utils.tcl	2004-01-26 03:33:53.000000000 -0800
+++ ccp4-5.0.2/ccp4i/utils/pdb_utils.tcl	2004-09-19 14:35:40.000000000 -0700
@@ -14,7 +14,7 @@
 #
 #=========================================================================
 
-#CCP4i_cvs_Id $Id: pdb_utils.tcl,v 1.18 2004/01/26 11:33:53 mdw Exp $
+#CCP4i_cvs_Id $Id: pdb_utils.tcl,v 1.19 2004/09/17 10:16:54 mdw Exp $
 
 #d_index_title Coordinate Handling Utilities (utils/pdb_utils.tcl)
 #-------------------------------------------------------------------------
@@ -1294,7 +1294,7 @@
     } else {
       if { $Mol(linkDistance,$n) == "" } { set dist "" } else { \
 		set dist [format %10.5f $Mol(linkDistance,$n)] }
-      append text [format "LINK        %-4s%1s%3s %1s%4i%1s   %10s   %-4s%1s%3s %1s%4i%1s  %6s %6s%8s\n"  \
+      append text [format "LINK        %-4s%1s%3s %1s%4i%1s  %10s   %-4s%1s%3s %1s%4i%1s  %6s %6s%8s\n"  \
 	$Mol(linkAtom1,$n) \
 	$Mol(linkAlt1,$n) \
 	$Mol(linkRes1,$n) \
diff -ruN ccp4-5.0.2-orig/ccp4i/utils/start_netscape.csh ccp4-5.0.2/ccp4i/utils/start_netscape.csh
--- ccp4-5.0.2-orig/ccp4i/utils/start_netscape.csh	2002-02-22 05:50:38.000000000 -0800
+++ ccp4-5.0.2/ccp4i/utils/start_netscape.csh	2004-08-06 21:07:50.000000000 -0700
@@ -1,7 +1,5 @@
 #!/bin/csh
-setenv MOZILLA_HOME /usr/local/netscape
+setenv MOZILLA_HOME open                       
 # Its advisable to undo what was done in ccp4.setup
-setenv XUSERFILESEARCHPATH " "
-setenv XFILESEARCHPATH " "
-netscape file:$CCP4I_HELP/index.html >& /dev/null &
+open $CCP4I_HELP/index.html >& /dev/null &
 #netscape30 file:$CCP4I_HELP/start.html >& /dev/null &
diff -ruN ccp4-5.0.2-orig/etc/uniqueify ccp4-5.0.2/etc/uniqueify
--- ccp4-5.0.2-orig/etc/uniqueify	2004-06-17 03:19:45.000000000 -0700
+++ ccp4-5.0.2/etc/uniqueify	2004-08-08 15:00:50.000000000 -0700
@@ -124,10 +124,10 @@
 temp3=$CCP4_SCR/uniq3$$.mtz
 
 # find awk executable
-for myawk in nawk gawk awk
-do
-    test -f $myawk && break
-done
+
+myawk=/usr/bin/awk
+
+# fink's awk is gawk creating problems, system's awk works fine 
 
 # extract first crystal name from the input file
 xname=`mtzdmp $1 -n 0 | $myawk '                  
diff -ruN ccp4-5.0.2-orig/etc/xloggraph ccp4-5.0.2/etc/xloggraph
--- ccp4-5.0.2-orig/etc/xloggraph	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.2/etc/xloggraph	2004-09-15 07:45:17.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xloggraph.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.2-orig/etc/xplot84 ccp4-5.0.2/etc/xplot84
--- ccp4-5.0.2-orig/etc/xplot84	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.2/etc/xplot84	2004-09-15 07:42:59.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.2-orig/etc/xplot84driver ccp4-5.0.2/etc/xplot84driver
--- ccp4-5.0.2-orig/etc/xplot84driver	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-5.0.2/etc/xplot84driver	2004-09-15 07:43:34.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-5.0.2-orig/include/ccp4.setup-dist ccp4-5.0.2/include/ccp4.setup-dist
--- ccp4-5.0.2-orig/include/ccp4.setup-dist	2004-08-05 04:47:45.000000000 -0700
+++ ccp4-5.0.2/include/ccp4.setup-dist	2004-08-06 20:54:50.000000000 -0700
@@ -57,7 +57,7 @@
 #               For 'standard' installations this is /usr/local/bin
 #               but note the SGI distributed version of Tcl/Tk is not 
 #               appropriate version
-setenv CCP4I_TCLTK /usr/local/bin        
+setenv CCP4I_TCLTK /swprefix/bin        
 # CCP4I_HELP - directory contain ccp4i help - default is $CCP4I_TOP/help
 setenv CCP4I_HELP ${CCP4I_TOP}/help
 
@@ -107,7 +107,7 @@
     setenv CBIN      $CCP4/bin		
     setenv CLIB      $CCP4/lib	
 
-    setenv CCP4_BROWSER  netscape             
+    setenv CCP4_BROWSER  open        
 
     if (${?MANPATH}) then
       if ($ccp4_first_in_path) then
@@ -158,8 +158,8 @@
 endif
 
 ### PLOT_COMMAND PRINT_COMMAND for the XCCPJIFFY programs to compile ###
-setenv PLOT_COMMAND   'lp -s -dmicrolaser'  
-setenv PRINT_COMMAND  'lp -s -denscript'    
+setenv PLOT_COMMAND   'lpr'  
+setenv PRINT_COMMAND  'lpr'    
 
 # HARVESTHOME specifies location of harvesting files (defaults to $HOME)
 #setenv HARVESTHOME     
@@ -181,29 +181,11 @@
 #
 #  setenv BINSORT_MEM     8388608
 
+# Don't set these -- fink won't permit it
 # LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
 # at runtime
-if (${?LD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv LD_LIBRARY_PATH ${CLIB}:${LD_LIBRARY_PATH}
-  else
-    setenv LD_LIBRARY_PATH ${LD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv LD_LIBRARY_PATH ${CLIB}
-endif
-
 # DYLD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.dylib)
 # at runtime (used on Mac OS X)
-if (${?DYLD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv DYLD_LIBRARY_PATH ${CLIB}:${DYLD_LIBRARY_PATH}
-  else
-    setenv DYLD_LIBRARY_PATH ${DYLD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv DYLD_LIBRARY_PATH ${CLIB}
-endif
 
 ### XAPPLRESDIR ###
 
@@ -221,11 +203,6 @@
 # not be set at the time this file is read.  Thus edit this part as
 # appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
 # instead of /usr; others may want /usr/local/lib or somw such):
-if ($?XUSERFILESEARCHPATH) then
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:$XUSERFILESEARCHPATH
-else
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:/usr/lib/X11/app-defaults
-endif
 
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
@@ -277,8 +254,8 @@
 # confusion with `.' or whatever in the path:
 #
 # This construct prevents the path getting longer each time ccp4.setup is
-# executed (A. Perrakis)
-set ccp4pathlist = "${CCP4}/etc ${CBIN} ${CCP4I_TOP}/bin "
+# executed (A. Perrakis).  I've corrected the erronious syntax.
+set ccp4pathlist = "${CCP4}/etc:${CBIN}:${CCP4I_TOP}/bin"
 #
 foreach dir ( ${ccp4pathlist} )
   if ( ${?PATH} ) then
diff -ruN ccp4-5.0.2-orig/include/ccp4.setup-sh ccp4-5.0.2/include/ccp4.setup-sh
--- ccp4-5.0.2-orig/include/ccp4.setup-sh	2004-08-06 20:28:18.000000000 -0700
+++ ccp4-5.0.2/include/ccp4.setup-sh	2004-09-19 14:15:36.000000000 -0700
@@ -1,9 +1,16 @@
 #! /bin/sh
 # [The above is just for emacs -- this file should not be executed.]
 
-# CCP4 setup file for bash or ksh (untested) users.  Actually, the aliases 
-# can't work asis in ksh.  Should use builtins instead and not worry about
-# ease of keeping in step with the csh one.
+# NOTE:  If you have installed ccp4 on OS X with fink, you should not need to
+# change this file or to source it (fink takes care of sourcing it for you).
+
+# CCP4 setup file for bash or zsh users.  zsh is similar to ksh so should work
+# with ksh.
+
+# Contains some hacks by W G Scott to facilitate OS X fink installation, but
+# should work with any zsh or bash system with appropriate prefixes
+
+# Also contains a few bash and zsh-specific functions and command-completions
 
 # $Id: ccp4.setup-sh,v 1.3.4.1 2004/08/05 11:47:45 pjx Exp $
 
@@ -18,7 +25,7 @@
 # shareable files (such as this one) via shared file systems with NFS, RFS
 # etc.  Non-shareable files reside in $CBIN and $CLIB (see below).
 
-# Copy this file to ccp4.setup and customise it for your needs. There are
+# Copy this file to ccp4.setup-sh and customise it for your needs. There are
 # three sections. You MUST check the first section. You may want to check
 # the second. You don't need to look at the third.
 
@@ -49,7 +56,7 @@
 #               For 'standard' installations this is /usr/local/bin
 #               but note the SGI distributed version of Tcl/Tk is not 
 #               appropriate version
-export CCP4I_TCLTK=/sw/bin        
+export CCP4I_TCLTK=/swprefix/bin        
 # CCP4I_HELP - directory contain ccp4i help - default is $CCP4I_TOP/help
 export CCP4I_HELP=$CCP4I_TOP/help
 
@@ -91,8 +98,17 @@
     export CBIN=$CCP4/bin		
     export CLIB=$CCP4/lib	
 
-    export CCP4_BROWSER=safari             
-    export MANPATH=$CCP4/man:$MANPATH           # edit this if necessary
+    
+    if [ $(uname) = Darwin ]; then
+        export CCP4_BROWSER=open
+    else
+        export CCP4_BROWSER=netscape
+    fi 
+    
+    
+                 
+           MANPATH=$CCP4/man:$MANPATH           # edit this if necessary
+    export MANPATH
     export MCTYPE=unix 			# (only for Laue)
 #     ;;
 #   *)
@@ -107,11 +123,12 @@
 export CCP4_BIN=$CBIN
 
 # CLASSPATH for Java
-export CLASSPATH=$CBIN:$CLASSPATH                      # edit this if necessary
+       CLASSPATH=$CBIN:$CLASSPATH               # edit this if necessary
+export CLASSPATH
 
 ### PLOT_COMMAND PRINT_COMMAND for the XCCPJIFFY programs to compile ###
-export PLOT_COMMAND='lp -s'  
-export PRINT_COMMAND='lp -s'    
+export PLOT_COMMAND='lpr'  
+export PRINT_COMMAND='lpr'    
 
 # HARVESTHOME specifies location of harvesting files (defaults to $HOME)
 export HARVESTHOME=$HOME     
@@ -133,39 +150,43 @@
 #
 #  export BINSORT_MEM=8388608
 
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-# at runtime
-if test "LD_LIBRARY_PATH"; then
-  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CLIB
-else
-  export LD_LIBRARY_PATH=$CLIB
-fi
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries
-# (e.g. libccp4.dylib) at runtime
-if test "DYLD_LIBRARY_PATH"; then
-  export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$CLIB
-else
-  export DYLD_LIBRARY_PATH=$CLIB
-fi
-
-### XAPPLRESDIR ###
-
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
-# application defaults directory since it requires reading by xrdb to sort out
-# the differences for monochrome displays.  At Daresbury a version of the file
-# assuming a monochrome display is kept in the directory
-# $CCP4_LIB/X11/app-defaults and this is picked up through the
-# XUSERFILESEARCHPATH environment variable.  That means you only see black and
-# white on a colour display.  Alternatively you might make sure that it is
-# read by xrdb on startup of the X Windows system or delegate the
-# responsibility to users to run it.  There are disadvantages to putting an
-# invocation of xrdb in here, one being that the correct value of DISPLAY may
-# not be set at the time this file is read.  Thus edit this part as
-# appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-# instead of /usr; others may want /usr/local/lib or somw such):
+if [ $CCP4_MASTER != /swprefix/share/xtal ]; then  
+    
+    # LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
+    # at runtime 
+    if test "LD_LIBRARY_PATH"; then
+      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CLIB
+    else
+      export LD_LIBRARY_PATH=$CLIB
+    fi
+    # DYLD_LIBRARY_PATH specifies where to find dynamic libraries
+    # (e.g. libccp4.dylib) at runtime
+    if test "DYLD_LIBRARY_PATH"; then
+      export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$CLIB 
+    else
+      export DYLD_LIBRARY_PATH=$CLIB
+    fi
+    
+    ### XAPPLRESDIR ###
+    
+    # If you want to use xloggraph/xplot84driver, you need to get the application
+    # defaults picked up somehow.  As distributed, the file can't just live in an
+    # application defaults directory since it requires reading by xrdb to sort out
+    # the differences for monochrome displays.  At Daresbury a version of the file
+    # assuming a monochrome display is kept in the directory
+    # $CCP4_LIB/X11/app-defaults and this is picked up through the
+    # XUSERFILESEARCHPATH environment variable.  That means you only see black and
+    # white on a colour display.  Alternatively you might make sure that it is
+    # read by xrdb on startup of the X Windows system or delegate the
+    # responsibility to users to run it.  There are disadvantages to putting an
+    # invocation of xrdb in here, one being that the correct value of DISPLAY may
+    # not be set at the time this file is read.  Thus edit this part as
+    # appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
+    # instead of /usr; others may want /usr/local/lib or somw such):
+    
+    export XAPPLRESDIR=/etc/app-defaults/
 
-export XAPPLRESDIR=/sw/etc/app-defaults/
+fi
 
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
@@ -217,15 +238,23 @@
 # confusion with `.' or whatever in the path:
 #
 # This construct prevents the path getting longer each time ccp4.setup is
-# executed (A. Perrakis)
-ccp4pathlist="${CCP4}/etc ${CBIN} ${CCP4I_TOP}/bin "
-#
-for dir in ${ccp4pathlist}
-do
-  if [ `expr ":${PATH}:" : ".*:${dir}:"` -eq 0 ]; then
-    PATH=${PATH}:${dir}
-  fi
-done
+# executed in bash (WG Scott corrected version).  zsh has a better mechanism.
+
+ccp4pathlist="${CCP4}/etc:${CBIN}:${CCP4I_TOP}/bin"
+
+if test x$ZSH_VERSION = x; then  
+    for dir in ${ccp4pathlist}
+    do
+      if [ `expr ":${PATH}:" : ".*:${dir}:"` -eq 0 ]; then
+        PATH=${PATH}:${dir}
+      fi
+    done
+else
+    PATH=$ccp4pathlist:$PATH
+    typeset -U path
+fi
+
+export PATH
 
 # Optional (useful) additional environment variables
   export CCP4=$CCP4
@@ -276,3 +305,74 @@
   alias lgnom='pushd $CCP4_MASTER/laue/gnom>/dev/null'
   alias lgnoms='pushd $CCP4_MASTER/laue/gnom/src>/dev/null'
   alias lbin='pushd $CBIN>/dev/null'
+  
+# Get rid of the ccp4help alias and make a more useful function
+
+    alias ccp4help="" ; unalias ccp4help
+    function ccp4help {
+        if [[ $# = 0 ]]; then
+            $CCP4_BROWSER $CHTML/INDEX.html
+        else
+            $CCP4_BROWSER $CHTML/$1.html
+        fi 
+        }  
+
+# Test if we are using bash, and if so, define some completions
+
+if test x$BASH_VERSION != x; then
+
+getccp4progs () {
+        for progpage in $CHTML/*.html
+        do
+                progpage_t=${progpage#$CHTML/}
+                progpage_t_r=${progpage_t%.*}       
+                echo $progpage_t_r
+        done
+        }
+
+        
+  complete -f  -W '$(getccp4progs)' ccp4help 
+
+  complete -f  -X '!*.mtz' mtzdmp
+
+  complete -f  -X '!*.plt' xplot84
+  complete -f  -X '!*.plt' xplot84driver
+
+fi        
+        
+# Stop reading the file here unless we are using zsh
+
+if test x$ZSH_VERSION = x; then  
+ return 0
+fi
+
+
+
+# zsh specific stuff
+  
+if [[ -n $ZSH_VERSION ]]; then
+
+     # ZSH_VERSION is only defined within zsh.  
+        
+  function getccp4progs { 
+        foreach progpage ($CHTML/*.html) 
+            print $progpage:t:r
+        end 
+        }
+        
+  compctl -g "$(getccp4progs)" ccp4help 
+
+  compctl -g '*.mtz' mtzdmp
+
+  compctl -g '*.plt' xplot84
+  compctl -g '*.plt' xplot84driver
+  
+    # Avoid repeats in the path
+ 
+    typeset -U path
+    typeset -U manpath
+    typeset -U classpath
+     
+fi   # End of zsh specific functions and completions
+
+
diff -ruN ccp4-5.0.2-orig/lib/src/ccp4_parser.c ccp4-5.0.2/lib/src/ccp4_parser.c
--- ccp4-5.0.2-orig/lib/src/ccp4_parser.c	2004-04-06 07:16:52.000000000 -0700
+++ ccp4-5.0.2/lib/src/ccp4_parser.c	2004-08-28 18:57:47.000000000 -0700
@@ -1298,14 +1298,18 @@
 	is_frc = 1;
 
       } else if (toupper(this_char) == 'E') {
+        char next_char = (ichar+1 < lstr ) ? str[ichar+1] : '\0';
+        if ( next_char == '+' || next_char == '-')
+           next_char = (ichar+2 < lstr ) ? str[ichar+2] : '\0';
+        /* require the next active character after E to be a digit */
+        if ( !isdigit(next_char) )  return 0;
 	/* Exponent? i.e. e or E
 	   There can only be one exponent */
-	if (exponent > -1) return 0;
-	exponent = ichar;
-	is_int = 0;
-	is_frc = 0;
-	is_exp = 1;
-
+        if (exponent > -1) return 0;
+        exponent = ichar;
+        is_int = 0;
+        is_frc = 0;
+        is_exp = 1;
       } else {
 	/* Not a permissible character
 	   This is not a number so get out now */
diff -ruN ccp4-5.0.2-orig/lib/src/cmtzlib_f.c ccp4-5.0.2/lib/src/cmtzlib_f.c
--- ccp4-5.0.2-orig/lib/src/cmtzlib_f.c	2004-07-05 06:23:54.000000000 -0700
+++ ccp4-5.0.2/lib/src/cmtzlib_f.c	2004-08-11 22:57:33.000000000 -0700
@@ -98,7 +98,7 @@
 #include "csymlib.h"
 #include "ccp4_program.h"
 #include "ccp4_general.h"
-static char rcsid[] = "$Id: cmtzlib_f.c,v 1.62 2004/07/05 13:23:54 mdw Exp $";
+static char rcsid[] = "$Id: cmtzlib_f.c,v 1.63 2004/08/10 09:43:07 pjx Exp $";
 
 #define MFILES 4
 #define MAXSYM 192
@@ -1127,7 +1127,7 @@
  /* lrrefl / lrreff will increment this */
  irref[*mindx-1] = *nrefl - 1;
  if (!cmtz_in_memory) {
-   respos = *nrefl * MtzNumSourceCol(mtzdata[*mindx-1]) + SIZE1 + 1;
+   respos = (*nrefl - 1) * MtzNumSourceCol(mtzdata[*mindx-1]) + SIZE1;
    ccp4_file_seek(mtzdata[*mindx-1]->filein, respos, SEEK_SET); 
  }
 }
diff -ruN ccp4-5.0.2-orig/src/abs.f ccp4-5.0.2/src/abs.f
--- ccp4-5.0.2-orig/src/abs.f	2004-01-26 02:08:16.000000000 -0800
+++ ccp4-5.0.2/src/abs.f	2004-08-19 17:51:14.000000000 -0700
@@ -20,10 +20,12 @@
 	PROGRAM ABSC
 	PARAMETER(MAXREF=90000)
 	PARAMETER(MAXDATA=4194304)
+        PARAMETER(MCOLS=500)
 	COMPLEX FF(MAXREF),DATA(MAXDATA)
 	INTEGER*2 IH(MAXREF),IK(MAXREF),IL(MAXREF)
 	LOGICAL EOF, LVALMS
-	CHARACTER*4 KEY, CCVAL(20),KEYWORD(4)
+        LOGICAL LOGMSS(MCOLS)
+	CHARACTER*4 KEY, CCVAL(20),KEYWORD(5)
 	CHARACTER*400 LINE
 	CHARACTER*80 TITLE
 	INTEGER NTOK, IBEG(20), IEND(20), ITYP(20), IDEC(20)
@@ -34,14 +36,14 @@
 	CHARACTER*1 CTYP1(7)
         REAL RSYM(4,4,64),HKL(3)
 	DATA LAB1/'H','K','L','F','SIGF','DANO','SIGDANO'/
-	DATA KEYWORD/'TITL','ATOM','LABI','RESO'/
+	DATA KEYWORD/'TITL','ATOM','LABI','RESO','END'/
 	DATA CTYP1/'H','H','H','F','Q','D','Q'/
 	DATA IPOINT1/3*-1,4*0/
 	DATA OCU/480*1.0/
-        CALL CCPRCS (6, 'ABS', '$Date: 2004/01/26 10:08:16 $')
+        CALL CCPRCS (6, 'ABS', '$Date: 2004/08/18 10:52:59 $')
 	CALL CCPFYP
 C   Set default - currently NAN
-             CALL QNAN (VAL_MAGIC)
+C            CALL QNAN (VAL_MAGIC)
 	WRITE(6,*)  
         WRITE(6,*)' Program:  ABS   ' 
         WRITE(6,*)' Last update: 10/2/2001'
@@ -55,9 +57,9 @@
      +                         IDEC,NTOK,EOF,.FALSE.)
 	IF (EOF) GOTO 10 
 	CALL CCPUPC(KEY)
-	DO I = 1 , 4
+	DO I = 1 , 5
 	   IF (KEY.EQ.KEYWORD(I)) THEN
-	      GOTO (3,4,5,6) I
+	      GOTO (3,4,5,6,10) I
 	   END IF
 	END DO
 	CALL CCPERR(1,'----------- illegal keyword ------------')
@@ -103,11 +105,14 @@
    	cen = 0.
  20	CALL LRREFF(1,RESOL,ADATA1,EOF)
         IF (EOF) GOTO 50
-        CALL IS_MAGIC (VAL_MAGIC,adata1(4),LVALMS)
-	IF (lvalms) goto 20
+        CALL LRREFM(1,LOGMSS)
+C       CALL IS_MAGIC (VAL_MAGIC,adata1(4),LVALMS)
+C       IF (lvalms) goto 20
+	IF (LOGMSS(4)) goto 20
 	if (adata1(4).lt.0.) GOTO 20
-        CALL IS_MAGIC (VAL_MAGIC,adata1(6),LVALMS)
-	IF (lvalms) adata1(6) = 0.0 
+C       CALL IS_MAGIC (VAL_MAGIC,adata1(6),LVALMS)
+C       IF (lvalms) adata1(6) = 0.0 
+        IF (LOGMSS(6)) adata1(6) = 0.0
 	if(1./sqrt(resol).lt.resolim) goto 20
 	NREF = NREF + 1
         SUM_R = 0.0
diff -ruN ccp4-5.0.2-orig/src/dmmulti_/dmmulti.f ccp4-5.0.2/src/dmmulti_/dmmulti.f
--- ccp4-5.0.2-orig/src/dmmulti_/dmmulti.f	2004-01-22 08:58:58.000000000 -0800
+++ ccp4-5.0.2/src/dmmulti_/dmmulti.f	2004-08-12 21:11:24.000000000 -0700
@@ -973,14 +973,14 @@
       character colnam(nhklc)*6
 c
       integer in(3),nfile,nhires,nsysab,notasu,nunobs,ncen,ncenerr
-      integer ih,ik,il,inasu,i
+      integer ih,ik,il,inasuold,i
       integer ifo,isfo,iphio,ifomo,ihla,ihlb,ihlc,ihld
       integer ifdm,iphidm,ifomdm,ifree
       real s,eps,phicen,fo,sfo,phio,fomo,fdm,phidm,fomdm,fpc,phipc
       real rrand,flag,hla,hlb,hlc,hld,x,atanh,siminv
       logical assigned(nhklc)
 c
-      external inasu,rrand,atanh,siminv
+      external inasuold,rrand,atanh,siminv
 c
       data colnam/'H','K','L','S','EPS','FO','PHIO','FOMO',
      +            'HL-A','HL-B','HL-C','HL-D',2*'x',
@@ -1054,7 +1054,7 @@
           nsysab=nsysab+1
           goto 100
         endif
-        if (inasu(in,nlaue).ne.1) then
+        if (inasuold(in,nlaue).ne.1) then
           notasu=notasu+1
           goto 100
         endif
diff -ruN ccp4-5.0.2-orig/src/dmmulti_/dmmulti_dmlib.f ccp4-5.0.2/src/dmmulti_/dmmulti_dmlib.f
--- ccp4-5.0.2-orig/src/dmmulti_/dmmulti_dmlib.f	2004-03-31 05:39:53.000000000 -0800
+++ ccp4-5.0.2/src/dmmulti_/dmmulti_dmlib.f	2004-08-12 21:10:42.000000000 -0700
@@ -254,10 +254,10 @@
 c
       real reso
 c
-      integer in(3),ih,ik,il,n,inasu
+      integer in(3),ih,ik,il,n,inasuold
       real s12,s13,s23,s2,s3,s,slim,eps,phicen
       logical centre,sysabs
-      external inasu
+      external inasuold
       equivalence (in(1),ih)
       equivalence (in(2),ik)
       equivalence (in(3),il)
@@ -275,7 +275,7 @@
       do 100 ih=-hmax,hmax
       s  = ih*(ih*rcm11 + s12) + s2
       if (s.gt.0.0.and.s.le.slim) then
-       if (inasu(in,nlaue).eq.1) then
+       if (inasuold(in,nlaue).eq.1) then
         call epscen(ih,ik,il,centre,sysabs,eps,phicen,nsym,rsym)
         if (.not.sysabs) n=n+1
        endif
@@ -1131,4 +1131,283 @@
 c
 c ----------------------------------------------------------------------
 c
-
+C
+      INTEGER FUNCTION INASUold(IH, NLAUE)
+C     =================================
+C
+C   This used to be FUNCTION XRY173(NLAUE,IH,ISGN)
+C***********************************************************************
+C***********************************************************************
+C*****                         *****************************************
+C***** ROUTINE ( XRY173        *****************************************
+C*****                         *****************************************
+C*****     From XRAY77 or something like it ****************************
+C***********************************************************************
+C***********************************************************************
+C
+C  Arguments:
+C   NLAUE - code number for this pointgroup
+C   IH(3) - indices
+C
+C Returns:
+C   INASU = +1  if  h k l chosen
+C   INASU = -1  if -h-k-l chosen
+C   INASU =  0   if reflection is out-of-bounds
+C
+C  Reciprocal space zones: please check spacegroup numbers.
+C
+Code:3 pg1     1bar      hkl:l>=0  hk0:h>=0  0k0:k>=0
+C           Space group numbers :   1,2
+Code:4 pg2    2/m        hkl:k>=0, l>=0  hk0:h>=0       3/b,4/b....
+C           Space group numbers :   3 -15 B axis unique.
+Code:5 pg2    2/m        hkl:k>=0, l>=0  h0l:>=0        1003,1004
+C           Space group numbers :   3 -15 C axis unique.
+Code:6 pg222  mmm        hkl:h>=0, k>=0, l>=0            16 ...
+C           Space group numbers :   16-74
+Code:7 pg4    4/m        hkl:h>=0, l>=0 with k>=0 if  h=0  and
+C                                           k> 0 if  h>0.
+C           Space group numbers :   75-88
+Code:8 pg422 4/mmm       hkl:h>=0, k>=0, l>=0 and h>=k
+C           Space group numbers :   89-142
+Code:9  pg3     3bar      hkl:h>=0, k>0  00l:l>0
+C           Space group numbers :   143-148
+Code:  10 pg312  3/m        hkl:h>=0, k>=0 with k<=h for all l.
+C                           if k = 0  l>=0
+C           Space group numbers :   149-151-153
+Code:  11 pg321  3/m        hkl:h>=0, k>=0 with k<=h for all l.
+C                           if h = k  l>=0
+C           Space group numbers :   150-152-154
+Code:12 pg6    6/m        hkl:h>=0, k>=0, l>=0 with k>=0 if  h=0
+C                                            and  k> 0 if  h>0.
+C           Space group numbers :   168-176
+Code:13 pg622 6/mmm       hkl:h>=0, k>=0, l>=0 with h>=k
+C           Space group numbers :   177-194
+Code:14 pg23   m3         hkl:h>=0, k>=0, l>=0 with l>=h,
+C                                                 k>=h if l=h
+C                                                 k> h if l>h.
+C           Space group numbers :   195-206
+Code:15 pg432  m3m        hkl:h>=0, k>=0, l>=0 with k>=l, and l>=h.
+C           Space group numbers :   207-232
+C
+C -- TEST FOR HKL IN ASYMMETRIC UNIT
+C     INCORPORATED INTO DATCO5 JUNE 70
+C
+C Arguments
+      INTEGER IH(3), NLAUE
+C Locals
+      INTEGER J,K,L,ISGN
+C
+C----MOVE INDICES INTO J,K, AND L
+      J = IH(1)
+      K = IH(2)
+      L = IH(3)
+      ISGN=1
+C----GO TO TEST IF INDICES ARE IN DESIRED UNIT
+1     GO TO (100,150,200,250,300,350,400,450,550,570,600,650,700,750,
+     1  800),NLAUE
+ 100  CONTINUE
+C----1 BAR (ALTERNATE 1)
+C     HKL --    H.GE.0
+C     0KL --    K.GE.0
+C     00L --    L.GE.0
+      IF (J) 7,105,5
+ 105  IF (K) 7,110,5
+ 110  IF (L) 7,5,5
+C
+ 150  CONTINUE
+C----1 BAR (ALTERNATE I)
+C     HKL --    K.GE.0
+C     H0L --    L.GE.0
+C     H00 --    H.GE.0
+      IF (K) 7,155,5
+ 155  IF (L) 7,160,5
+ 160  IF (J) 7,5,5
+C
+C  Corresponds to Data reduction unique set for  pg1
+C   3 pg1     1bar      hkl:l>=0  hk0:h>=0  0k0:k>=0   1,2
+ 200  CONTINUE
+C----1 BAR (ALTERNATE 3)
+C     HKL --    L.GE.0
+C     HK0 --    H.GE.0
+C     0K0 --    K.GE.0
+      IF (L) 7,205,5
+ 205  IF (J) 7,210,5
+ 210  IF (K) 7,5,5
+C
+C  Corresponds to Data reduction unique set for  pg2
+C   4 pg2    2/m        hkl:k>=0, l>=0  hk0:h>=0       3/b,4/b....
+ 250  CONTINUE
+C----2/M (ALTERNATE 1)
+C     HKL --    K.GE.0 AND L.GE.0
+C     HK0 --    H.GE.0
+      IF (K) 7,255,255
+ 255  IF (L) 7,260,5
+ 260  IF (J) 7,5,5
+C
+C  Corresponds to Data reduction unique set for  pg2
+C   5 pg2    2/m        hkl:k>=0, l>=0  h0l:h>=0       1003,1004
+ 300  CONTINUE
+C----2/M (ALTERNATE 2)
+C     HKL --    L.GE.0 AND H.GE.0
+C     H0L --    H.GE.0
+      IF (L) 7,305,305
+ 305  IF (K) 7,310,5
+ 310  IF (J) 7,5,5
+C
+C  Corresponds to Data reduction unique set for  pg222
+C   6 pg222  mmm        hkl:h>=0, k>=0, l>=0            16 ...
+ 350  CONTINUE
+C----MMM
+C     HKL --    H.GE.0, K.GE.0, AND L.GE.0
+      IF (J) 7,355,355
+ 355  IF (K) 7,361,361
+C****NO 3-SICKLIES PLEASE
+ 361  IF (L) 7,5,5
+C
+C  Corresponds to Data reduction unique set for  pg4
+C   7 pg4    4/m        hkl:h>=0, l>=0 with k>=0 if  h=0  and
+C                                           k> 0 if  h>0.
+ 400  CONTINUE
+C----4/M
+C     HKL --    H.GE.0, L.GE.0, WITH K.GE.0 IF H.EQ.0 OR
+C               K.GE.1 IF H.GT.0
+      IF (L) 7,405,405
+ 405  IF (J) 7,410,415
+ 410  IF (K) 7,5,5
+ 415  IF (K) 7,7,5
+C
+C  Corresponds to Data reduction unique set for  pg422
+C   8 pg422 4/mmm       hkl:h>=0, k>=0, l>=0 and h>=k   89..
+ 450  CONTINUE
+C----4/MMM
+C     HKL --    H.GE.0, K.GE.0, AND L.GE.0 WITH H.GE.K
+      IF (J) 7,455,455
+ 455  IF (K) 7,460,460
+ 460  IF (L) 7,465,465
+ 465  IF (J-K) 7,5,5
+C
+C 500  CONTINUE
+C----3 BAR
+C      HKL ---   H.LE.0, L.GE.0, WITH K.GE.0 IF H.LE.0 OR
+C               K.GE.1 IF H.LT.0
+C      HK0  --  K.GT.-H
+CC
+C  1978 CHANGED TO FIT N.ISAACS
+C  INCLUDE 0 0 L,  HK0 K.LT.0 H.GE.-K     HKL H.GE.0 K.LT.0
+CC
+CCC      IF(J)7,505,505
+CCC505   IF(K)510,510,7
+CCC510   IF(L)7,515,520
+CCC515   IF(K)516,7,7
+CCC516   IF(J+K)7,5,5
+CCC520   IF(J-K)521,5,521
+CCC521   IF(K)5,7,7
+C
+C  Corresponds to Data reduction unique set for  pg3
+C  9 pg3     3bar      hkl:h>=0, k>0  00l:l>0         143..
+550   CONTINUE
+C   ALTERNATIVE FOR R3
+C  H.GE.0 K.GT.0    ALL L
+C  H=0 K=0 L.GT.0
+      IF(J)7,555,556
+555   IF(K)7,557,5
+556   IF(K)7,7,5
+557   IF(L)7,7,5
+C
+C  Corresponds to Data reduction unique set for  pg312 
+C  10 pg312        hkl:h>=0, k>=0 with k<=h for all l.
+C                           if k = 0  l>=0
+ 570  CONTINUE
+C----3 BAR M
+C  H.GE.0 K.GE.0 K.LE.H   ALL L
+C  H=K  L.GE.0
+      IF(J)7,575,575
+575   IF(K)7,577,576
+576   IF(J-K)7,5,5
+577   IF(L)7,5,5
+C
+C  Corresponds to Data reduction unique set for  pg321
+C  11 pg321        hkl:h>=0, k>=0 with k<=h for all l.
+C                           if h = k  l>=0
+ 600  CONTINUE
+C----3 BAR M
+C  H.GE.0 K.GE.0 K.LE.H   ALL L
+C  H=K  L.GE.0
+      IF(J)7,605,605
+605   IF(K)7,606,606
+606   IF(J-K)7,607,5
+607   IF(L)7,5,5
+C
+C  Corresponds to Data reduction unique set for  pg6
+C  12 pg6    6/m        hkl:h>=0, k>=0, l>=0 with k>=0 if  h=0
+C                                            and  k> 0 if  h>0.
+ 650  CONTINUE
+C----6/M
+C     HKL --    H.GE.0, L.GE.0, WITH K.GE.0 IF H.EQ.0 OR
+C               K.GE.1 IF H.GT.0
+      IF (L) 7,655,655
+ 655  IF (J) 7,660,665
+ 660  IF (K) 7,5,5
+ 665  IF (K) 7,7,5
+C
+C  Corresponds to Data reduction unique set for  pg622
+C  13 pg622 6/mmm       hkl:h>=0, k>=0, l>=0 with h>=k 177..
+  700 CONTINUE
+C----6/MMM
+C     HKL --    H.GE.0, K.GE.0, AND L.GE.0 WITH H.GE.K
+      IF (J) 7,705,705
+ 705  IF (K) 7,710,710
+710   IF(J-K)7,715,715
+715   IF(L)7,5,5
+C
+C  Corresponds to Data reduction unique set for  pg23
+C  14 pg23   m3         hkl:h>=0, k>=0, l>=0 with l>=h,
+C                                                 k>=h if l=h
+C                                                 k> h if l>h.
+ 750  CONTINUE
+C----M3
+C     HKL --    H.GE.0, K.GE.0, AND L.GE.0 WITH L.GE.H AND WITH
+C               K.GE.H IF L.EQ.H OR K.GT.H IF L.GT.H
+      IF (J) 7,755,755
+ 755  IF (K) 7,760,760
+ 760  IF (L) 7,765,765
+ 765  IF (L-J) 7,770,775
+ 770  IF (K-J) 7,5,5
+ 775  IF (K-J) 7,7,5
+C
+C  Corresponds to Data reduction unique set for  pg432
+C  15 pg432  m3m        hkl:h>=0, k>=0, l>=0 with k>=l, and l>=h.
+ 800  CONTINUE
+C----M3M
+C     HKL --    H.GE.0, K.GE.0, AND L.GE.0 WITH
+C              K.GE.L AND L.GE.H
+      IF (J) 7,805,805
+ 805  IF (K) 7,810,810
+ 810  IF (L) 7,815,815
+ 815  IF (K-L) 7,820,820
+ 820  IF (L-J) 7,5,5
+C
+C----REFLECTION IS IN BOUNDS
+ 5    INASUold = ISGN
+      RETURN
+C     ======
+C
+C----REFLECTION IS OUT OF BOUNDS
+ 7    IF (ISGN .EQ. +1) THEN
+C     TRY -H -K -L
+        ISGN=-1
+        J=-J
+        K=-K
+        L=-L
+        GO TO 1
+      ENDIF
+C Index failed, exit
+      INASUold = 0
+      RETURN
+C     ======
+C
+      END
+C
+c
+c ----------------------------------------------------------------------
+c
diff -ruN ccp4-5.0.2-orig/src/lsqkab.f ccp4-5.0.2/src/lsqkab.f
--- ccp4-5.0.2-orig/src/lsqkab.f	2004-01-23 09:15:33.000000000 -0800
+++ ccp4-5.0.2/src/lsqkab.f	2004-08-11 23:00:29.000000000 -0700
@@ -90,7 +90,7 @@
       CALL XYZINIT
       NATOMS = NATOM
       NOUT = 6
-      CALL CCPRCS(NOUT,'LSQKAB','$Date: 2004/01/23 17:15:33 $')
+      CALL CCPRCS(NOUT,'LSQKAB','$Date: 2004/08/09 15:28:53 $')
       CALL RCARDSLSQ
 C
 C     Initilaise TER info
@@ -548,6 +548,20 @@
         IF (THETA2.EQ.0) CHI = THETA3
         IF (THETA2.EQ.180.0) CHI = 180.0
 C
+C---- Special case: pure rotation around Z-axis
+C     In this case Beta (=Theta2) is either 0 or 180,
+C     Alpha (=Theta1) is zero, and Gamma is any value
+C     between 0 and 180deg.
+C     i.e. the rotation axis is parallel to the Z-axis
+        DC(1) = 0.0
+        DC(2) = 0.0
+        IF (THETA2.EQ.0.0) THEN
+          DC(3) = 1.0
+        ELSE
+          DC(3) = -1.0
+        ENDIF
+        GOTO 20
+C
 C---- IF CHI =180  COSCHI=-1,SINCHI=0
 C
    10   DC(1) = SQRT(ABS(TRMAT(1,1)*0.5+0.5))
@@ -568,7 +582,7 @@
         SOMEGA = SQRT(ABS(1.0-DC(3)*DC(3)))
         OMEGA = ATAN2(SOMEGA,DC(3))*CONV
         CHK = DC(2)*DC(2) + DC(1)*DC(1)
-        PHI = 999
+        PHI = 0.0
         IF (CHK.GT.0.0) PHI = CONV*ATAN2(DC(2),DC(1))
       END IF
       WRITE (6,FMT=6006) THETA1,THETA2,THETA3,OMEGA,PHI,CHI,
diff -ruN ccp4-5.0.2-orig/unsupported/src/Makefile.in ccp4-5.0.2/unsupported/src/Makefile.in
--- ccp4-5.0.2-orig/unsupported/src/Makefile.in	2003-12-01 03:02:44.000000000 -0800
+++ ccp4-5.0.2/unsupported/src/Makefile.in	2004-08-11 23:02:57.000000000 -0700
@@ -1,7 +1,7 @@
 
 # Makefile tail for CCP4 unsupported programs.  This will be modified by configure.
 
-# $Id: Makefile.in,v 1.23 2003/12/01 11:02:44 mdw Exp $
+# $Id: Makefile.in,v 1.24 2004/08/11 15:59:56 pjx Exp $
 
 # variables which should be set by configure: top_srcdir, CC, CFLAGS,
 # FC, FFLAGS, F, LNS, SETFLAGS, EVAL, LDFLAGS, INSTALL_PROGRAM
@@ -22,7 +22,7 @@
 # end if adding to this list)
 FTARGETS = \
 angles asc2p84 axissearch compar \
-difres havecs hbond helixang \
+difres extends havecs hbond helixang \
 mapexchange mapreplace p842asc postref \
 refindex reforigin rotaprep symfit \
 vecsum zeroed
