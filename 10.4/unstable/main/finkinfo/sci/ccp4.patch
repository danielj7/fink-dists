--- ccp4-6.0.1.org/lib/clipper/clipper/mmdb/Makefile.in	2006-11-18 18:42:03.000000000 -0500
+++ ccp4-6.0.1/lib/clipper/clipper/mmdb/Makefile.in	2006-11-18 18:42:35.000000000 -0500
@@ -149,7 +149,7 @@
 LTLIBRARIES = $(lib_LTLIBRARIES)
 
 libclipper_mmdb_la_LDFLAGS =
-libclipper_mmdb_la_LIBADD =
+libclipper_mmdb_la_LIBADD = $(MMDB_LIBS)
 am_libclipper_mmdb_la_OBJECTS = clipper_mmdb.lo
 libclipper_mmdb_la_OBJECTS = $(am_libclipper_mmdb_la_OBJECTS)
 
--- ccp4-6.0.1.org/src/refmac5_/make_unix_ccp4.f	2006-11-16 10:59:01.000000000 -0500
+++ ccp4-6.0.1/src/refmac5_/make_unix_ccp4.f	2006-11-16 11:17:23.000000000 -0500
@@ -82,10 +82,11 @@
 C
       INTEGER*4 IH(7)
 C ******
-      CHARACTER CID*10
+      CHARACTER CID*10,CID2*8
 c --------------------------------
 
       CALL UTIME(CID)
+      CALL DATE_AND_TIME(DATE=CID2)
 
 c          UTIME - Get current time hh:mm:ss          
 c Input:     none
@@ -96,13 +97,15 @@
 cpjx  the date as hh:mm:ss
 
       READ(CID,'(I2,1X,I2,1X,I2,2X)') IH(4),IH(3),IH(2)
+      READ(CID2,'(I4,I2,I2)') IYR,IMON,IDAY
 
-      CALL IDATE(IMON,IDAY,IYR)
-      IF(IYR.GE.99) THEN
-        IYR=IYR+1900
-      ELSE
-        IYR=IYR+2000
-      ENDIF
+#      CALL IDATE(IMON,IDAY,IYR)
+
+#      IF(IYR.GE.99) THEN
+#        IYR=IYR+1900
+#      ELSE
+#        IYR=IYR+2000
+#      ENDIF
       IH(5)=IDAY
       IH(6)=IMON
       IH(7)=IYR
--- ccp4-6.0.1.org/configure	2006-11-14 18:40:17.000000000 -0500
+++ ccp4-6.0.1/configure	2006-11-14 18:42:05.000000000 -0500
@@ -2190,17 +2190,17 @@
 fi # CXX_LIBS
 
 #defaults
-  FOPTIM=${FOPTIM:-"-O2"}
-  COPTIM=${COPTIM:-"-O2"}
-  CXXOPTIM=${CXXOPTIM:-"-O2"}
+  FOPTIM=${FOPTIM:-"-O3"}
+  COPTIM=${COPTIM:-"-O3 -ffast-math"}
+  CXXOPTIM=${CXXOPTIM:-"-O3 -ffast-math"}
   INSTALL_DATA=${INSTALL_DATA:-"cp"}
   INSTALL_PROGRAM=${INSTALL_PROGRAM:-"cp"}
   SETFLAGS=${SETFLAGS:-"sftools_FLAGS='$XFFLAGS $FOPTIM' \
-                      refmac5_FLAGS='$XFFLAGS -O1' \
+                      refmac5_FLAGS='$XFFLAGS -O3' \
                       arp_waters_FLAGS='$XFFLAGS $FOPTIM -fforce-mem' \
-                      mplot_FLAGS='$XFFLAGS -O1' \
-                      molrep_FLAGS='$XFFLAGS -O1' \
-                      xdlmapman_FLAGS='$XFFLAGS -O1'"}
+                      mplot_FLAGS='$XFFLAGS -O3' \
+                      molrep_FLAGS='$XFFLAGS -O3' \
+                      xdlmapman_FLAGS='$XFFLAGS -O3'"}
   XDL_LIB=${XDL_LIB:-"-L${CCP4_LIB} -lxdl_view"}
   XWIN_LIB=${XWIN_LIB:-"-L/usr/X11R6/lib -lXt -lSM -lX11 -lICE"}
   XTYPE=${XTYPE:-"LINUX"}
--- ccp4-6.0.1/lib/ccif/configure.org	2006-11-18 15:14:37.000000000 -0500
+++ ccp4-6.0.1/lib/ccif/configure	2006-11-18 15:17:14.000000000 -0500
@@ -1873,8 +1873,8 @@
          else
            SHARED_LIB_PATH='DYLD_LIBRARY_PATH=`pwd`'
          fi
-         SHARED_LIB_CMD=' $(LD) -dylib -dynamic -flat_namespace \\\
-                          -undefined suppress -dylib_install_name $(SHARED_LIB_NAME) \\\
+         SHARED_LIB_CMD=' $(LD) -dylib -dynamic -single_module \\\
+                          -undefined dynamic_lookup -dylib_install_name ${RPATH}/$(SHARED_LIB_NAME) \\\
                           -all_load $L \\\
                           -o $(SHARED_LIB_NAME) -ldylib1.o'
          SHARED_LIB_EXPORTS_CMD=''
@@ -1890,9 +1890,9 @@
          else
            SHARED_LIB_PATH='DYLD_LIBRARY_PATH=`pwd`'
          fi
-         SHARED_LIB_CMD='$(CC) $(SHARED_LIB_CFLAGS) -dynamiclib -flat_namespace \\\
-                               -undefined suppress -install_name \\\
-                                $(SHARED_LIB_NAME) \\\
+         SHARED_LIB_CMD='$(CC) $(SHARED_LIB_CFLAGS) -dynamiclib -single_module \\\
+                               -undefined dynamic_lookup -install_name \\\
+                                ${RPATH}/$(SHARED_LIB_NAME) \\\
                                -all_load $L \\\
                                -o $(SHARED_LIB_NAME)'
          SHARED_LIB_EXPORTS_CMD=''
diff -ruN ccp4-6.0.1-orig/ccp4i/etc/configure.def.dist ccp4-6.0.1/ccp4i/etc/configure.def.dist
--- ccp4-6.0.1-orig/ccp4i/etc/configure.def.dist	2006-05-25 08:29:47.000000000 -0700
+++ ccp4-6.0.1/ccp4i/etc/configure.def.dist	2006-05-25 14:18:27.000000000 -0700
@@ -54,8 +54,8 @@
 MESSAGE                   _text				""
 BLT_LIBRARY               _text                     ""
 MENU_LENGTH               _positiveint              25
-HYPERTEXT_VIEWER          _text                     netscape
-START_NETSCAPE	          _text			    netscape
+HYPERTEXT_VIEWER          _text                     Safari  
+START_NETSCAPE	          _text			    Safari 
 O_MAPMAN                  _text                     mapman
 MAPMAN_MAXSIZE		  _positiveint		    4194304
 QUANTA_MBKALL             _text                     mbkall
diff -ruN ccp4-6.0.1-orig/ccp4i/etc/osx_ccp4_mail ccp4-6.0.1/ccp4i/etc/osx_ccp4_mail
--- ccp4-6.0.1-orig/ccp4i/etc/osx_ccp4_mail	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0.1/ccp4i/etc/osx_ccp4_mail	2006-05-25 13:44:49.000000000 -0700
@@ -0,0 +1,164 @@
+#!/usr/bin/perl
+# Drop-in replacement for /usr/bin/mail that uses Mail.app (via an
+# applescript) rather than sendmail to send mail.  Unlike /usr/bin/mail,
+# you can't use it for reading mail.
+#
+# usage: mail [<options>] <recipients>
+#     options:
+#         -v           be verbose
+#         -g           activate Mail.app to approve the message
+#         -F <from>    specify the From: address
+#         -b <bcc>     specify Bcc: recipients in a comma-separated list
+#         -c <cc>      specify Cc: recipients in a comma-separated list
+#         -s <subject> specify the message subject
+#
+# The body of the message is read from standard input.
+#
+# Author: Nathaniel Nystrom <nystrom@cs.cornell.edu>
+# This software is in the public domain.
+#
+# Version 1.0,   21 Aug 2003 -- initial version
+# Version 1.0.1, 22 Aug 2003 -- fixes some quoting problems
+# Version 1.0.2, 23 Aug 2003 -- removed -R <reply-to> option; |reply to|
+#                               is a property of _incoming_ messages
+# Version 1.0.3, 17 Sep 2003 -- fixed escaping of \ in message body;
+#                               escape the subject too
+
+use strict;
+$|++;
+
+my ($verbose, $gui);
+my ($from, @to, @cc, @bcc, $subject, $body);
+my $prog;
+($prog = $0) =~ s|.*/||;
+
+while (@ARGV) {
+    my $arg = shift @ARGV;
+
+    if ($arg eq '-v') {
+        $verbose++;
+    }
+    elsif ($arg eq '-g') {
+        $gui++;
+    }
+    elsif ($arg eq '-F') {
+        $from = shift @ARGV || &usage("missing sender");
+    }
+    elsif ($arg eq '-i' || $arg eq '-l' || $arg eq '-n') {
+        # ignore; for /usr/bin/mail compatibility
+    }
+    elsif ($arg eq '-N' || $arg eq '-f' || $arg eq '-u') {
+        &usage("invalid option $arg; $prog cannot be used for reading mail");
+    }
+    elsif ($arg eq '-s') {
+        $subject = shift @ARGV || &usage("missing subject");
+    }
+    elsif ($arg eq '-c') {
+        my $list = shift @ARGV || &usage("missing Cc list");
+        @cc = split /\s*,\s*/, $list;
+    }
+    elsif ($arg eq '-b') {
+        my $list = shift @ARGV || &usage("missing Bcc list");
+        @bcc = split /\s*,\s*/, $list;
+    }
+    elsif ($arg =~ /^-/) {
+        &usage("invalid option $arg");
+    }
+    else {
+        @to = ($arg, @ARGV);
+        last;
+    }
+}
+
+&usage("missing recipients") unless @to;
+
+unless (defined $subject) {
+    print "Subject: ";
+    $subject = <STDIN> || '';
+    chomp $subject;
+}
+
+$body = '';
+
+while (<STDIN>) {
+    $body .= $_;
+}
+
+$body = &escape($body);
+$subject = &escape($subject);
+
+my $script = <<"EOS";
+tell application "Mail"
+    set newMessage to make new outgoing message
+    tell newMessage
+        set subject to "$subject"
+        set content to "$body"
+EOS
+
+for (@to)  { $script .= &recipient('to', $_); }
+for (@cc)  { $script .= &recipient('cc', $_); }
+for (@bcc) { $script .= &recipient('bcc', $_); }
+
+my $visible = $gui ? "true" : "false";
+my $activate = $gui ? "activate" : "send newMessage";
+my $fromln = $from ? "set sender to \"$from\"" : "";
+
+$script .= <<"EOS";
+        $fromln
+        set visible to $visible
+    end tell
+    $activate
+end tell
+EOS
+
+if ($verbose >= 1) {
+    print "From: $from\n" if $from;
+    print "To: ", join(',', @to), "\n" if @to;
+    print "Cc: ", join(',', @cc), "\n" if @cc;
+    print "Bcc: ", join(',', @bcc), "\n" if @bcc;
+
+    if ($verbose >= 2) {
+        print "Script >>>\n";
+        print $script;
+        print "<<<\n";
+        print "\n";
+        print $body;
+    }
+}
+
+open(SCRIPT, "| osascript > /dev/null") || die "Couldn't fork osascript: $!\n";
+print SCRIPT $script;
+close SCRIPT;
+
+exit 0;
+
+sub escape {
+    my $x = shift;
+    $x =~ s/\\/\\\\/gm;
+    $x =~ s/"/\\"/gm;
+    $x =~ s/\n/\\n/gm;
+    $x;
+}
+
+sub recipient {
+    my ($type,$addr) = @_;
+    return <<"EOS"
+        make new $type recipient at end of $type recipients with properties {address: "$addr"}
+EOS
+}
+
+sub usage {
+    my $error = shift;
+    print STDERR "Error: $error\n" if $error;
+    print STDERR <<"EOS";
+usage: $prog [<options>] <recipients>
+    options:
+        -v           be verbose
+        -g           activate Mail.app to approve the message
+        -F <from>    specify the From: address
+        -b <bcc>     specify Bcc: recipients in a comma-separated list
+        -c <cc>      specify Cc: recipients in a comma-separated list
+        -s <subject> specify the message subject
+EOS
+    exit 1;
+}
Binary files ccp4-6.0.1-orig/ccp4i/help/images/.DS_Store and ccp4-6.0.1/ccp4i/help/images/.DS_Store differ
Binary files ccp4-6.0.1-orig/ccp4i/help/roadmaps/images/.DS_Store and ccp4-6.0.1/ccp4i/help/roadmaps/images/.DS_Store differ
diff -ruN ccp4-6.0.1-orig/ccp4i/src/local.tcl ccp4-6.0.1/ccp4i/src/local.tcl
--- ccp4-6.0.1-orig/ccp4i/src/local.tcl	2006-05-25 08:29:47.000000000 -0700
+++ ccp4-6.0.1/ccp4i/src/local.tcl	2006-05-25 13:45:33.000000000 -0700
@@ -34,7 +34,7 @@
 #d_arg mail_address Mail addressee
 
 return [expr {1 - [catch \
-   "exec Mail -s \"$subject\" $mail_address < $tmp_file"  ]}]
+   "exec osx_ccp4_mail  -s \"$subject\" $mail_address < $tmp_file"  ]}]
 }
 
 #d_index_title Interaction with Netscape
diff -ruN ccp4-6.0.1-orig/ccp4i/tasks/refmac5.tcl ccp4-6.0.1/ccp4i/tasks/refmac5.tcl
--- ccp4-6.0.1-orig/ccp4i/tasks/refmac5.tcl	2006-05-25 08:29:48.000000000 -0700
+++ ccp4-6.0.1/ccp4i/tasks/refmac5.tcl	2006-08-12 22:04:16.000000000 -0700
@@ -6,7 +6,7 @@
 #     A copy of the CCP4 licence can be obtained by writing to the
 #     CCP4 Secretary, Daresbury Laboratory, Warrington WA4 4AD, UK.
 #
-#CCP4i_cvs_Id $Id: refmac5.tcl,v 1.39.2.3 2006/05/03 12:09:17 djr78 Exp $
+#CCP4i_cvs_Id $Id: refmac5.tcl,v 1.42 2006-07-04 16:28:59 rmk65 Exp $
 # ======================================================================
 # refmac.tcl --
 #
@@ -37,7 +37,8 @@
     append array(INPUT_FILES) " TLSIN"
   }
 
-  if { $array(IF_MAPOUT) } {
+  # Add the MAPOUT files to the OUTPUT_FILES list if required
+  if { $array(IFMAPNAME) } {
     append array(OUTPUT_FILES) " MAPOUT1"
     append array(OUTPUT_FILES) " MAPOUT2"
   }
@@ -1507,6 +1508,16 @@
 	format template TOP
 
   CreateLine line \
+	label " " \
+	label " " \
+	label "bonded" -italic \
+	label "non-bond" -italic \
+	label "planar" -italic \
+	label "H-atom" -italic \
+	label "special" -italic \
+	format template SIGMA6
+
+  CreateLine line \
 	message "Enter Overall weight(WDSKAL) for distance restraints" \
         widget IFDIST -toggleon \
 	label "Distance" \
@@ -1523,24 +1534,6 @@
         format template SIGMA6
 
   CreateLine line \
-	label " " \
-	label " " \
-	label "main chain" -italic \
-	label "main chain" -italic \
-	label "side chain" -italic \
-	label "side chain" -italic \
-	format template SIGMA6
-
-  CreateLine line \
-	label " " \
-	label " " \
-	label "bond" -italic \
-	label "angle" -italic \
-	label "bond" -italic \
-	label "angle" -italic \
-	format template SIGMA6
-
-  CreateLine line \
         message "Enter overall weight (WBSKAL) for Bfactor restraints" \
         widget IFTMP -toggleon \
 	label "Bfactor" \
diff -ruN ccp4-6.0.1-orig/configure ccp4-6.0.1/configure
--- ccp4-6.0.1-orig/configure	2006-05-25 08:30:44.000000000 -0700
+++ ccp4-6.0.1/configure	2006-05-25 14:01:01.000000000 -0700
@@ -2212,7 +2212,7 @@
   XMKMF="IMAKECPP=/usr/bin/cpp xmkmf"
   if test "$shared_lib" = yes; then
     SHARED_LIB_CFLAGS=${SHARED_LIB_CFLAGS:-'-fPIC -fno-common'}
-    SHARE_LIB='${CC} -dynamiclib -flat_namespace -undefined suppress ${SHARED_LIB_CFLAGS} -install_name libmmdb.dylib -all_load libmmdb.a -o libmmdb.dylib -lstdc++; ${CC} -dynamiclib -flat_namespace -undefined suppress ${SHARED_LIB_CFLAGS} -install_name libccp4c.dylib -all_load libccp4c.a  -o libccp4c.dylib'
+    SHARE_LIB='${CC} -dynamiclib -single_module -undefined dynamic_lookup ${SHARED_LIB_CFLAGS} -install_name ${RPATH}/libmmdb.dylib -all_load libmmdb.a -o libmmdb.dylib -lstdc++; ${CC} -dynamiclib -single_module -undefined dynamic_lookup ${SHARED_LIB_CFLAGS} -install_name ${RPATH}/libccp4c.dylib -all_load libccp4c.a  -o libccp4c.dylib'
     SHARE_INST='${INSTALL_DATA} `pwd`/libmmdb.dylib ${libdir}/libmmdb.dylib; ${INSTALL_DATA} `pwd`/libccp4c.dylib ${libdir}/libccp4c.dylib'
   fi     
 #need -lcc_dynamic to get restFP and saveFP for g77 3.4 under darwin 7
diff -ruN ccp4-6.0.1-orig/etc/xloggraph ccp4-6.0.1/etc/xloggraph
--- ccp4-6.0.1-orig/etc/xloggraph	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0.1/etc/xloggraph	2006-05-25 14:11:51.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xloggraph.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-6.0.1-orig/etc/xplot84 ccp4-6.0.1/etc/xplot84
--- ccp4-6.0.1-orig/etc/xplot84	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0.1/etc/xplot84	2006-05-25 14:12:12.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
diff -ruN ccp4-6.0.1-orig/etc/xplot84driver ccp4-6.0.1/etc/xplot84driver
--- ccp4-6.0.1-orig/etc/xplot84driver	1969-12-31 16:00:00.000000000 -0800
+++ ccp4-6.0.1/etc/xplot84driver	2006-05-25 14:12:12.000000000 -0700
@@ -0,0 +1,6 @@
+#!/bin/zsh
+export XUSERFILESEARCHPATH=$CLIB/X11/app-defaults/XCCPJiffy
+xplot84driver.exe "$@" &
+export XUSERFILESEARCHPATH=""
+print "Plot button sends pdf to Preview.  Print or save pdf in Preview window."
+exit 0
Binary files ccp4-6.0.1-orig/examples/tutorial/html/images/.DS_Store and ccp4-6.0.1/examples/tutorial/html/images/.DS_Store differ
diff -ruN ccp4-6.0.1-orig/include/ccp4.setup-bash ccp4-6.0.1/include/ccp4.setup-bash
--- ccp4-6.0.1-orig/include/ccp4.setup-bash	2006-05-25 08:30:36.000000000 -0700
+++ ccp4-6.0.1/include/ccp4.setup-bash	2006-05-25 13:39:15.000000000 -0700
@@ -361,13 +361,3 @@
   unset alias  # clean up
 fi             # ksh test
 
-# Set-up cctbx environment
-test -r $CCP4/lib/cctbx/cctbx_build/setpaths.sh && . $CCP4/lib/cctbx/cctbx_build/setpaths.sh
-
-# Set-up phaser environment
-if ( test -d $CCP4/src/phaser) ; then
-  phaser_mtype=`$CCP4/src/phaser/bin/machine_type`
-  phaser_version=`grep PHASER_VERSION $CCP4/src/phaser/conf/version | awk '{print $3}'`
-  phaser_setup_file="${CCP4}/src/phaser/phaser-${phaser_version}/build/${phaser_mtype}/setpaths.sh"
-  test -r $phaser_setup_file && . $phaser_setup_file
-fi
diff -ruN ccp4-6.0.1-orig/include/ccp4.setup-dist ccp4-6.0.1/include/ccp4.setup-dist
--- ccp4-6.0.1-orig/include/ccp4.setup-dist	2006-05-25 08:30:36.000000000 -0700
+++ ccp4-6.0.1/include/ccp4.setup-dist	2006-05-25 13:39:15.000000000 -0700
@@ -107,7 +107,7 @@
     setenv CBIN      $CCP4/bin		
     setenv CLIB      $CCP4/lib	
 
-    setenv CCP4_BROWSER  netscape             
+    setenv CCP4_BROWSER  open              
 
     if (${?MANPATH}) then
       if ($ccp4_first_in_path) then
@@ -181,52 +181,6 @@
 #
 #  setenv BINSORT_MEM     8388608
 
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-# at runtime
-if (${?LD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv LD_LIBRARY_PATH ${CLIB}:${LD_LIBRARY_PATH}
-  else
-    setenv LD_LIBRARY_PATH ${LD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv LD_LIBRARY_PATH ${CLIB}
-endif
-
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.dylib)
-# at runtime (used on Mac OS X)
-if (${?DYLD_LIBRARY_PATH}) then
-  if ($ccp4_first_in_path) then
-    setenv DYLD_LIBRARY_PATH ${CLIB}:${DYLD_LIBRARY_PATH}
-  else
-    setenv DYLD_LIBRARY_PATH ${DYLD_LIBRARY_PATH}:${CLIB}
-  endif
-else
-  setenv DYLD_LIBRARY_PATH ${CLIB}
-endif
-
-### XAPPLRESDIR ###
-
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
-# application defaults directory since it requires reading by xrdb to sort out
-# the differences for monochrome displays.  At Daresbury a version of the file
-# assuming a monochrome display is kept in the directory
-# $CCP4_LIB/X11/app-defaults and this is picked up through the
-# XUSERFILESEARCHPATH environment variable.  That means you only see black and
-# white on a colour display.  Alternatively you might make sure that it is
-# read by xrdb on startup of the X Windows system or delegate the
-# responsibility to users to run it.  There are disadvantages to putting an
-# invocation of xrdb in here, one being that the correct value of DISPLAY may
-# not be set at the time this file is read.  Thus edit this part as
-# appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-# instead of /usr; others may want /usr/local/lib or somw such):
-if ($?XUSERFILESEARCHPATH) then
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:$XUSERFILESEARCHPATH
-else
-  setenv XUSERFILESEARCHPATH $CCP4_LIB/X11/app-defaults/%N:/usr/lib/X11/app-defaults
-endif
-
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
 # point exceptions under IRIX.  It shouldn't cause harm on other systems, but
@@ -348,14 +302,3 @@
   alias lgnoms 'pushd $CCP4_MASTER/laue/gnom/src>/dev/null'
   alias lbin   'pushd $CBIN>/dev/null'
 #
-
-# Set-up cctbx environment
-if (-e $CCP4/lib/cctbx/cctbx_build/setpaths.csh) source $CCP4/lib/cctbx/cctbx_build/setpaths.csh
-
-# Set-up phaser environment
-if (-d $CCP4/src/phaser) then
-  set phaser_mtype = `$CCP4/src/phaser/bin/machine_type`
-  set phaser_version = `grep PHASER_VERSION $CCP4/src/phaser/conf/version | awk '{print $3}'`
-  set phaser_setup_file = "${CCP4}/src/phaser/phaser-${phaser_version}/build/${phaser_mtype}/setpaths.csh"
-  if (-e $phaser_setup_file) source $phaser_setup_file
-endif
diff -ruN ccp4-6.0.1-orig/include/ccp4.setup-sh ccp4-6.0.1/include/ccp4.setup-sh
--- ccp4-6.0.1-orig/include/ccp4.setup-sh	2006-05-25 08:30:36.000000000 -0700
+++ ccp4-6.0.1/include/ccp4.setup-sh	2006-07-05 18:25:29.000000000 -0700
@@ -91,7 +91,7 @@
     export CBIN=$CCP4/bin		
     export CLIB=$CCP4/lib	
 
-    export CCP4_BROWSER=safari             
+    CCP4_BROWSER="" ; export CCP4_BROWSER=open           
     export MANPATH=$CCP4/man:$MANPATH           # edit this if necessary
     export MCTYPE=unix 			# (only for Laue)
 #     ;;
@@ -110,8 +110,8 @@
 export CLASSPATH=$CBIN:$CLASSPATH                      # edit this if necessary
 
 ### PLOT_COMMAND PRINT_COMMAND for the XCCPJIFFY programs to compile ###
-export PLOT_COMMAND='lp -s'  
-export PRINT_COMMAND='lp -s'    
+export PLOT_COMMAND='lpr'  
+export PRINT_COMMAND='lpr'    
 
 # HARVESTHOME specifies location of harvesting files (defaults to $HOME)
 export HARVESTHOME=$HOME     
@@ -133,39 +133,7 @@
 #
 #  export BINSORT_MEM=8388608
 
-# LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-# at runtime
-if test "LD_LIBRARY_PATH"; then
-  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CLIB
-else
-  export LD_LIBRARY_PATH=$CLIB
-fi
-# DYLD_LIBRARY_PATH specifies where to find dynamic libraries
-# (e.g. libccp4.dylib) at runtime
-if test "DYLD_LIBRARY_PATH"; then
-  export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$CLIB
-else
-  export DYLD_LIBRARY_PATH=$CLIB
-fi
-
-### XAPPLRESDIR ###
-
-# If you want to use xloggraph/xplot84driver, you need to get the application
-# defaults picked up somehow.  As distributed, the file can't just live in an
-# application defaults directory since it requires reading by xrdb to sort out
-# the differences for monochrome displays.  At Daresbury a version of the file
-# assuming a monochrome display is kept in the directory
-# $CCP4_LIB/X11/app-defaults and this is picked up through the
-# XUSERFILESEARCHPATH environment variable.  That means you only see black and
-# white on a colour display.  Alternatively you might make sure that it is
-# read by xrdb on startup of the X Windows system or delegate the
-# responsibility to users to run it.  There are disadvantages to putting an
-# invocation of xrdb in here, one being that the correct value of DISPLAY may
-# not be set at the time this file is read.  Thus edit this part as
-# appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-# instead of /usr; others may want /usr/local/lib or somw such):
 
-export XAPPLRESDIR=/sw/etc/app-defaults/
 
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
@@ -281,13 +249,3 @@
   alias lgnoms='pushd $CCP4_MASTER/laue/gnom/src>/dev/null'
   alias lbin='pushd $CBIN>/dev/null'
 
-# Set-up cctbx environment
-test -r $CCP4/lib/cctbx/cctbx_build/setpaths.sh && . $CCP4/lib/cctbx/cctbx_build/setpaths.sh
-
-# Set-up phaser environment
-if ( test -d $CCP4/src/phaser) ; then
-  phaser_mtype=`$CCP4/src/phaser/bin/machine_type`
-  phaser_version=`grep PHASER_VERSION $CCP4/src/phaser/conf/version | awk '{print $3}'`
-  phaser_setup_file="${CCP4}/src/phaser/phaser-${phaser_version}/build/${phaser_mtype}/setpaths.sh"
-  test -r $phaser_setup_file && . $phaser_setup_file
-fi
diff -ruN ccp4-6.0.1-orig/include/ccp4.setup-zsh ccp4-6.0.1/include/ccp4.setup-zsh
--- ccp4-6.0.1-orig/include/ccp4.setup-zsh	2006-05-25 08:30:36.000000000 -0700
+++ ccp4-6.0.1/include/ccp4.setup-zsh	2006-05-25 13:39:15.000000000 -0700
@@ -122,6 +122,7 @@
 
     
     if [[ $(uname) = Darwin ]]; then
+        CCP4_BROWSER=""
         export CCP4_BROWSER=open            # open in OS X default browser
     elif [[ $(uname) = Linux ]];then
         export  CCP4_BROWSER=konqueror 
@@ -175,67 +176,6 @@
 #  export BINSORT_MEM=8388608
 
 
-# If installed via fink, skip this bit:
-
-if [[ -z $SWPREFIX ]];then
-  if [[ -d /sw/bin/fink-virtual-pkgs ]];then
-    SWPREFIX=$(dirname $(dirname $(which /sw/bin/fink-virtual-pkgs)))
-  fi
-fi
-
-if [[ -z $SWPREFIX || $CCP4_MASTER != $SWPREFIX/share/xtal ]];then 
-    
-    # LD_LIBRARY_PATH specifies where to find dynamic libraries (e.g. libccp4.so)
-    # at runtime
-    
-    if test "$LD_LIBRARY_PATH"; then
-      if [[ $ccp4_first_in_path == 1 ]]; then
-        export LD_LIBRARY_PATH=$CLIB:$LD_LIBRARY_PATH
-      else
-        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CLIB
-      fi
-    else
-      export LD_LIBRARY_PATH=$CLIB
-    fi
-    # DYLD_LIBRARY_PATH specifies where to find dynamic libraries
-    # (e.g. libccp4.dylib) at runtime
-    if test "$DYLD_LIBRARY_PATH"; then
-      if [[ $ccp4_first_in_path == 1 ]]; then
-        export DYLD_LIBRARY_PATH=$CLIB:$DYLD_LIBRARY_PATH
-      else
-        export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:$CLIB
-      fi
-    else
-      export DYLD_LIBRARY_PATH=$CLIB
-    fi
-    
-    ### XAPPLRESDIR ###
-    
-    # If you want to use xloggraph/xplot84driver, you need to get the application
-    # defaults picked up somehow.  As distributed, the file can't just live in an
-    # application defaults directory since it requires reading by xrdb to sort out
-    # the differences for monochrome displays.  At Daresbury a version of the file
-    # assuming a monochrome display is kept in the directory
-    # $CCP4_LIB/X11/app-defaults and this is picked up through the
-    # XUSERFILESEARCHPATH environment variable.  That means you only see black and
-    # white on a colour display.  Alternatively you might make sure that it is
-    # read by xrdb on startup of the X Windows system or delegate the
-    # responsibility to users to run it.  There are disadvantages to putting an
-    # invocation of xrdb in here, one being that the correct value of DISPLAY may
-    # not be set at the time this file is read.  Thus edit this part as
-    # appropriate.  (SunOS will normally want to use /usr/openwin or $OPENWINHOME
-    # instead of /usr; others may want /usr/local/lib or somw such):
-
-    if [[ -n "$XUSERFILESEARCHPATH" ]]; then
-        XUSERFILESEARCHPATH=$CCP4_LIB/X11/app-defaults/%N:$XUSERFILESEARCHPATH
-    else
-        XUSERFILESEARCHPATH=$CCP4_LIB/X11/app-defaults/%N:/usr/lib/X11/app-defaults
-    fi
-
-    export XUSERFILESEARCHPATH
-    
-fi
-
 ### TRAPPFE ###
 # TRAPFPE is set to ensure (in collaboration with -lfpe) an abort on floating
 # point exceptions under IRIX.  It shouldn't cause harm on other systems, but
@@ -383,16 +323,3 @@
     typeset -U manpath
     typeset -U classpath
      
-# Set-up cctbx environment
-test -r $CCP4/lib/cctbx/cctbx_build/setpaths.sh && . $CCP4/lib/cctbx/cctbx_build/setpaths.sh
- 
-# Set-up phaser environment
-if ( test -d $CCP4/src/phaser) ; then
-  phaser_mtype=`$CCP4/src/phaser/bin/machine_type`
-  phaser_version=`grep PHASER_VERSION $CCP4/src/phaser/conf/version | awk '{print $3}'`
-  phaser_setup_file="${CCP4}/src/phaser/phaser-${phaser_version}/build/${phaser_mtype}/setpaths.sh"
-  test -r $phaser_setup_file && . $phaser_setup_file
-fi
-
-
-
diff -ruN ccp4-6.0.1-orig/lib/cctbx/ccp4_build ccp4-6.0.1/lib/cctbx/ccp4_build
--- ccp4-6.0.1-orig/lib/cctbx/ccp4_build	2006-05-25 08:30:28.000000000 -0700
+++ ccp4-6.0.1/lib/cctbx/ccp4_build	2006-05-25 14:21:00.000000000 -0700
@@ -1,53 +1,5 @@
-#! /bin/sh
+#! /bin/sh -ef
 
-usage='echo "Usage: ccp4_build [--help] [--libdir=DIR]" '
-
-if ( eval test -d cctbx_build || eval mkdir cctbx_build ) ; then :
-else
-  eval echo "! No directory cctbx_build and can\'t create it."
-  exit 1
-fi
-
-cctbxopts="--command_version_suffix=ccp4-6.0 --build=release"
-for arg
-do
-
-    case $arg in
-
-    -help | --help | -h | help)
-      eval $usage; exit 0;;
-
-    -libdir=* | --libdir=* | --libdi=* | --libd=* | --lib=* | --li=* | --l=*)
-      libdir=`echo $arg | sed 's/[-a-z_]*=//'` ; break;;
-
-    # all other arguments passed to cctbx build
-    *)
-      cctbxopts="$cctbxopts $arg" ;;
-
-    esac
-
-done
-
-if ( eval test -z \"\$CCP4\" ) ; then
-  echo "! Please set CCP4 environment, e.g. source ccp4.setup "
-  exit 1
-else true; fi
-
-libdir=${libdir:-$CCP4_LIB}
-
-echo "Changing directory to cctbx_build"
-cd cctbx_build
-
-echo "Running libtbx/configure.py"
-python ../cctbx_sources/libtbx/configure.py $cctbxopts ccp4io=${CCP4} mmtbx
-
-echo "Running setpaths.sh"
-. ./setpaths.sh
-
-echo "Building cctbx"
-libtbx.scons .
-
-# sunos 32 vs 64
-# use of sunos compilers
-# installation ??
+echo "Skipping final build of cctbx"
+echo "Install fink's cctbx package if you need this"
 
diff -ruN ccp4-6.0.1-orig/lib/cctbx/cctbx_install_script.csh ccp4-6.0.1/lib/cctbx/cctbx_install_script.csh
--- ccp4-6.0.1-orig/lib/cctbx/cctbx_install_script.csh	2006-05-25 08:30:28.000000000 -0700
+++ ccp4-6.0.1/lib/cctbx/cctbx_install_script.csh	2006-05-25 14:21:43.000000000 -0700
@@ -1,232 +1,5 @@
-#! /bin/csh -f
+#! /bin/sh -ef
 
-set install_root="$cwd"
-set bundle="cctbx"
-set sources="$cwd/${bundle}_sources"
-set build="$cwd/${bundle}_build"
-set prefer_usr_bin_python=0
+echo "Skipping final build of cctbx"
+echo "Install fink's cctbx package if you need this"
 
-unalias cat
-unalias cd
-unalias grep
-unalias ls
-unalias mkdir
-
-unsetenv PYTHONHOME
-
-if (-f "$sources/TAG") then
-  echo "Build tag:"
-  cat "$sources/TAG"
-endif
-
-if (-d "$sources/boost") then
-  set have_sources=1
-else
-  set have_sources=0
-endif
-
-set python_exe=None
-set build_mode=release
-
-if ("`uname`" == "Darwin") then
-  set python_exe="/Library/Frameworks/Python.framework/Versions/2.3/bin/python"
-  if (! -x "$python_exe") then
-    set python_exe="/System$python_exe"
-  endif
-  "$python_exe" -V
-  if ($status != 0) then
-    echo "Under Mac OS 10 Python 2.3 must be pre-installed."
-    echo "Please refer to the following web page for more information:"
-    echo "http://cci.lbl.gov/cctbx_build/mac_os_x_notes.html"
-    exit 1
-  endif
-endif
-
-if ($have_sources == 0) then
-
-  if (-d "$build/python") then
-    set python_exe="$build/python/bin/python"
-  endif
-  if ($prefer_usr_bin_python) then
-    if ("$python_exe" == None && -x /usr/bin/python) then
-      /usr/bin/python -V |& head -1
-      if ($status == 0) then
-        set python_exe=/usr/bin/python
-      endif
-    endif
-  endif
-  if ("$python_exe" == None) then
-    python -V |& head -1
-    if ($status == 0) then
-      set python_exe=python
-    endif
-  endif
-  if (! $prefer_usr_bin_python) then
-    if ("$python_exe" == None && -x /usr/bin/python) then
-      /usr/bin/python -V |& head -1
-      if ($status == 0) then
-        set python_exe=/usr/bin/python
-      endif
-    endif
-  endif
-
-else
-
-  if ($#argv == 0) then
-    echo -n "Please enter the number of available CPU's [1]: "
-    set n_cpu_s=(`echo "$<"`)
-    if ($#n_cpu_s > 1) then
-      echo "Not a number! Please try again."
-      exit 1
-    else if ($#n_cpu_s == 0) then
-      set n_cpu_s=1
-    else
-      set n_cpu_s="$n_cpu_s[1]"
-    endif
-  else if ($#argv == 1) then
-    set n_cpu_s="$1"
-  else
-    echo "usage: $0 number_of_cpu_s"
-    exit 1
-  endif
-  echo "Number of available CPU's: $n_cpu_s"
-  if ("$n_cpu_s" == "0") exit 0
-
-  if ("$python_exe" == None) then
-
-    set python_sources=(`ls | grep Python-`)
-    if ($#python_sources == 0) then
-      set python_sources=None
-    else if ($#python_sources == 1) then
-      set python_sources="$python_sources[1]"
-    else
-      echo "ERROR: Multiple Python source code directories."
-      echo "       Move or remove all but one directory."
-      exit 1
-    endif
-
-    if ("$python_sources" == None) then
-
-      echo "Trying to find a pre-installed Python:"
-      set python_exe=None
-      if (-x "$build/python/bin/python") then
-        "$build/python/bin/python" -V |& head -1
-        if ($status == 0) then
-          set python_exe="$build/python/bin/python"
-        endif
-      endif
-      if ("$python_exe" == None) then
-        python -V |& head -1
-        if ($status == 0) then
-          set python_exe=python
-        endif
-      endif
-      if ("$python_exe" == None) then
-        python2 -V |& head -1
-        if ($status == 0) then
-          set python_exe=python2
-        endif
-      endif
-      if ("$python_exe" == None && -x /usr/bin/python) then
-        /usr/bin/python -V |& head -1
-        if ($status == 0) then
-          set python_exe=/usr/bin/python
-        endif
-      endif
-      if ("$python_exe" != None) then
-        set python_version=(`"$python_exe" -V |& tr "." " "`)
-        if ("$python_version[2]") then
-          set minor=`echo "$python_version[3]" | cut -c-1`
-          if ($minor < 2 || ($minor == 2 && $#python_version == 3)) then
-            echo "A more recent Python version is required (2.2.1 or higher)."
-            set python_exe=None
-          endif
-        endif
-      endif
-      if ("$python_exe" == None) then
-        echo ""
-        echo "Cannot find a Python interpreter."
-        echo ""
-        echo "Please download an installer with Python included"
-        echo "or add a matching Python to the PATH environment variable."
-        echo ""
-        echo "Installation aborted."
-        exit 1
-      endif
-
-    else
-
-      echo "Installing $python_sources from sources"
-      mkdir -p "$build"
-      cd "$build"
-      cd ..
-      cd "$python_sources"
-      set py_install_log="../py_install_log"
-      echo "Configuring Python"
-      ./configure --prefix="$build/python" >& "$py_install_log"
-      echo "Compiling Python. This may take a while."
-      make >>& "$py_install_log"
-      echo "Installing Python"
-      make install >>& "$py_install_log"
-      echo "Done installing Python."
-      cd "$install_root"
-      set python_exe="$build/python/bin/python"
-      "$python_exe" -V
-      if ($status != 0) then
-        echo "ERROR: Python installation failed."
-        echo "Please check the log file for errors:"
-        echo "  $py_install_log"
-        exit 1
-      endif
-
-    endif
-
-  endif
-
-  mkdir -p "$build"
-
-endif
-
-echo ""
-echo "Precompiling all .py files. This may take a minute or two."
-"$python_exe" "$sources/libtbx/libtbx/command_line/py_compile_all.py"
-
-echo ""
-cd "$build"
-echo "Configuring $bundle build directory"
-"$python_exe" "$sources/libtbx/configure.py" --build="$build_mode" mmtbx clipper
-source setpaths_all.csh
-
-if ($have_sources != 0) then
-  echo ""
-  echo "Installing $bundle modules. This may take a while."
-  libtbx.scons -j "$n_cpu_s" .
-endif
-
-set test_py="$BOOST_ADAPTBX_DIST/tst_rational.py"
-if (-f "$test_py") then
-  echo ""
-  echo "Running a selected test"
-  set cmd='libtbx.python "'"$test_py"'"'
-  echo "$cmd"
-  eval $cmd
-endif
-
-cat << EOT
-
-***
-*** csh and tcsh users:
-***     To use this installation in a new shell or process run the command:
-***
-***         source "$LIBTBX_BUILD/setpaths.csh"
-***
-***     You may want to add this line to your .cshrc file.
-***
-*** sh and bash users:
-***     To use this installation in a new shell or process run the command:
-***
-***         . "$LIBTBX_BUILD/setpaths.sh"
-***
-***     You may want to add this line to your .profile or .bashrc file.
-***
-EOT
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/doc/html/images/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/doc/html/images/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/libs/date_time/doc/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/libs/date_time/doc/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/libs/iterator/doc/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/libs/iterator/doc/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/libs/math/special_functions/graphics/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/libs/math/special_functions/graphics/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/libs/multi_index/doc/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/libs/multi_index/doc/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/libs/python/doc/PyConDC_2003/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/libs/python/doc/PyConDC_2003/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/libs/python/doc/tutorial/doc/theme/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/libs/python/doc/tutorial/doc/theme/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/libs/spirit/doc/theme/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/libs/spirit/doc/theme/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/boost/more/logo_images/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/boost/more/logo_images/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/cctbx/cctbx_sources/cctbx/dox/rst/.DS_Store and ccp4-6.0.1/lib/cctbx/cctbx_sources/cctbx/dox/rst/.DS_Store differ
Binary files ccp4-6.0.1-orig/lib/clipper/dox/.DS_Store and ccp4-6.0.1/lib/clipper/dox/.DS_Store differ
diff -ruN ccp4-6.0.1-orig/lib/fftw/configure ccp4-6.0.1/lib/fftw/configure
--- ccp4-6.0.1-orig/lib/fftw/configure	2006-05-25 08:30:34.000000000 -0700
+++ ccp4-6.0.1/lib/fftw/configure	2006-05-25 14:27:59.000000000 -0700
@@ -1907,7 +1907,8 @@
   enableval="$enable_shared"
   p=${PACKAGE-default}
     case $enableval in
-    yes) enable_shared=yes ;;
+    # brute force it not to build shared fftw libs
+    yes) enable_shared=no ;;
     no) enable_shared=no ;;
     *)
       enable_shared=no
@@ -1916,7 +1917,7 @@
       for pkg in $enableval; do
 	IFS="$lt_save_ifs"
 	if test "X$pkg" = "X$p"; then
-	  enable_shared=yes
+	  enable_shared=no
 	fi
       done
       IFS="$lt_save_ifs"
diff -ruN ccp4-6.0.1-orig/src/act.f ccp4-6.0.1/src/act.f
--- ccp4-6.0.1-orig/src/act.f	2006-05-25 08:29:54.000000000 -0700
+++ ccp4-6.0.1/src/act.f	2006-07-07 18:33:30.000000000 -0700
@@ -116,7 +116,7 @@
 C--------------------------------------------------------------------------------
       PROGRAM ACT
 C
-      PARAMETER (MXATOM=20000,MAXBAD=500,MAXCH=30,MAXRES=2000)
+      PARAMETER (MXATOM=99999,MAXBAD=20000,MAXCH=30,MAXRES=9999) 
 C
 C This is the maximum possible number of equivalent positions
 C for a biological substance (F432), quite unlikely to occur in practice.
@@ -125,7 +125,7 @@
       REAL XYZ(3,MXATOM),OCC(MXATOM),BF(MXATOM),BPLOT(2,MAXRES)
       INTEGER NRES(MXATOM),CHPTR(MAXCH),RESCTR(2,MAXRES),RESLST(MAXRES)
       INTEGER IXYZIN,F000,NCH,RESPTR,NRESID(MAXCH),NATOMS
-      CHARACTER*8000 RESIDS
+      CHARACTER*40000 RESIDS
       CHARACTER*80 FULNAM
       CHARACTER*4 ANAME(MXATOM),RNAME(MXATOM)
       CHARACTER*1 CH(MXATOM),IDCH(MAXCH)
@@ -155,7 +155,7 @@
       IFAIL = 0
 C
 C     ****************************************************
-      CALL CCPRCS(IUOT,'ACT','$Date: 2005/09/06 11:25:07 $')
+      CALL CCPRCS(IUOT,'ACT','$Date: 2006/07/04 12:57:00 $')
 C     ****************************************************
 C Read input cards
 C
@@ -173,6 +173,7 @@
 C
       CALL GETXYZ(IXYZIN,XYZ,ANAME,RNAME,NRES,OCC,BF,IDCH,NATOMS,
      +            CH,NCH,CHPTR,RF,RO)
+      print *, 'natoms = ',natoms
 C
 C Get the B-factor statistics and F000 for main/side chain.
 C
@@ -626,7 +627,7 @@
 C--------------------------------------------------------------
 C Read in coordinates from Brookhaven file.
 C
-      PARAMETER (MXATOM=20000,MAXCH=30)
+      PARAMETER (MXATOM=99999,MAXCH=30)
 C
       REAL BISO,XYZ(3,MXATOM),OCC(MXATOM),BF(MXATOM),B(6)
       REAL RFRAC(4,4),RORTH(4,4)
@@ -700,8 +701,8 @@
 C---------------------------------------------------------------------
 C Temperature factor analysis.
 C
-      PARAMETER (MAXBAD=500,MAXCH=30,MAXMET=11,MXATOM=20000,MAXRES=2000,
-     +           MAXUNK=500)
+      PARAMETER(MAXBAD=20000,MAXCH=30,MAXMET=11,MXATOM=99999,
+     +           MAXRES=9999,MAXUNK=500)
 C
       INTEGER IBADR(MAXBAD),ICHN(MAXBAD),
      +        NO(MAXCH),NWO(MAXCH),NPO(MAXCH),NMAIN(MAXCH),
@@ -723,7 +724,7 @@
      +     AVEM(MAXCH),ADEVM(MAXCH),SDEVM(MAXCH),
      +     AVES(MAXCH),ADEVS(MAXCH),SDEVS(MAXCH),
      +     MBADLIST(MAXBAD),SBADLIST(MAXBAD),BMONI,TOTH
-      CHARACTER*8000 RESIDS
+      CHARACTER*40000 RESIDS
       CHARACTER*1 CH(MXATOM),IDCH(MAXCH),SHORT(20)
       CHARACTER*4 MCHAIN(5),SOLV(4),METAL(MAXMET),AACID(20),
      +            BADRES(MAXBAD),BADAT(MAXBAD),ANAME(MXATOM),
@@ -735,7 +736,7 @@
       CHARACTER*80 LINE
 C
 C..Pointers to Ox1 and Nx2 atoms of ASN and GLN
-      PARAMETER(MXASN = 300)
+      PARAMETER(MXASN = 3000)
       INTEGER ASNGLN(2,MXASN)
 C..Flags for ASN and GLN
       LOGICAL GLN,ASN
@@ -868,9 +869,9 @@
                 RESLST(RESPTR) = NRES(IATOM)
                 RESIDS(LPTR:LPTR+3)=RNAME(IATOM)
                 LPTR=LPTR+4
-                IF (LPTR.GT.8000) THEN
+                IF (LPTR.GT.40000) THEN
                   CALL CCPERR(1,
-     +  'INCREASE LENGTH OF CHARACTER STRING RESIDS (CURRENTLY 8000)')
+     +  'INCREASE LENGTH OF CHARACTER STRING RESIDS (CURRENTLY 40000)')
                 ENDIF
                 WRITE(RLABEL,1753)NRES(IATOM),IDCH(ICH),RNAME(IATOM)
 1753            FORMAT(1X,I4,A,2X,A4)
@@ -962,7 +963,9 @@
 C
 C  Allow both long and short residue names
             IF (RNAME(IATOM).EQ.AACID(J) .OR.
-     +          RNAME(IATOM)(3:3).EQ.SHORT(J)) THEN
+     +          (RNAME(IATOM)(1:1).EQ.SHORT(J)
+     +          .and. ichar(rname(iatom)(2:2)) .eq. 32 
+     +          .and. ichar(rname(iatom)(3:3)) .eq. 32 )) then     
 C
               DO 500 I = 1,5
                 IF (ANAME(IATOM).EQ.MCHAIN(I)) THEN
@@ -1036,7 +1039,7 @@
           INK  =  INK +1
           IF (INK.GT.MAXUNK) THEN
             WRITE(6,*)
-     +      'Paramter MAXUNK (currently ',MAXUNK,
+     +      'Parameter MAXUNK (currently ',MAXUNK,
      +      ') exceeded in s/r FILSHEL'
             CALL CCPERR(1,'IN BSTATS: too many unknown atoms')
           END IF
@@ -1317,7 +1320,7 @@
 6045    FORMAT(1X,'Maximum B',5X,F6.2,7X,F6.2,16X,F6.2)
 6050    FORMAT(1X,'on residue',6X,I4,9X,I4,18X,I4)
 C
-        IF(NRESID(I).GT.0) THEN
+        IF(NRESID(I).GT.1) THEN 
         WRITE(IUOT,6051)SDEVM(I),SDEVS(I)
 6051    FORMAT(1X,'Sigma',9X,F6.2,7X,F6.2)
         WRITE(IUOT,6052)ADEVM(I),ADEVS(I)
@@ -1468,7 +1471,7 @@
       SUBROUTINE PLBYRS(IUOT,RESCTR,BPLOT,RESPTR,RESLST,BYRES,CHFILE)
 C--------------------------------------------------------------------
 C
-      PARAMETER (MAXRES=2000,MXDIM=2,MXBIN=50)
+      PARAMETER (MAXRES=9999,MXDIM=2,MXBIN=50)
 C
       INTEGER RESCTR(MXDIM,MAXRES),RESLST(MAXRES)
       INTEGER RESPTR
@@ -1526,7 +1529,7 @@
       SUBROUTINE DUMP(IUOT,FNAME,VALUES,LABEL,RESPTR,RESLST,CH)
 C--------------------------------------------------------------
 C
-      PARAMETER (MAXRES=2000,MXDIM=2)
+      PARAMETER (MAXRES=9999,MXDIM=2)
 C
       INTEGER RESPTR,RESLST(MAXRES)
 C
@@ -1559,7 +1562,7 @@
 C-----------------------------------------------
 C Calculate number of electrons
 C
-      PARAMETER (MXATOM=20000)
+      PARAMETER (MXATOM=99999)
 C
       INTEGER NATOMS,F000,ATNUM(6)
 C
@@ -1590,7 +1593,13 @@
 C AVErage Deviation, Standard DEViation.
 C
       DIMENSION DATA(N)
-      IF(N.LE.1) CALL CCPERR(1, 'MOMENT: n must be at least 2')
+      IF(N.LE.0) CALL CCPERR(1, 'MOMENT: n must be at least 1')
+      if (n.eq.1) then
+        ave = data(1)
+        adev = 0.0
+        sdev = 0.0
+        return
+      endif      
       S=0.
       DO 11 J=1,N
         S=S+DATA(J)
@@ -1617,13 +1626,13 @@
 C-----------------------------------------------------------------------
 C Calculate contacts between atoms
 C
-      PARAMETER(MXBOX=10000,MXATSYM=100000)
+      PARAMETER(MXBOX=100000,MXATSYM=400000)
 C
-      INTEGER NET(31*MXBOX),NRES(NATOMS),NRESID(NCH),CHPTR(NCH)
+      INTEGER NET(81*MXBOX),NRES(NATOMS),NRESID(NCH),CHPTR(NCH)
 C
-C..Arrays for coordinates ot the primary atoms 
+C..Arrays for coordinates of the primary atoms 
 C  and in the symmetry related shell around the model
-C  N.B. MXATSYM=40000 should be enough exept for unusually large molecules,
+C  N.B. MXATSYM=40000 should be enough except for unusually large molecules,
 C  then it can be increased.
 C  PJX: 17/03/00 indeed MXATSYM increased to 100000!
       REAL XYZ(3,NATOMS),XYZS(3,MXATSYM),OCC(NATOMS)
@@ -1653,7 +1662,7 @@
 C
 C..(re)initialise - this routine can be called several times
       NATOMSYM=0
-      NARRAY=31*MXBOX
+      NARRAY=81*MXBOX
       DO 100 I=1,NARRAY
          NET(I)=0
   100 CONTINUE
@@ -1743,8 +1752,8 @@
 C
 C..The box may extend over more than one unit cell (but not more than three)
         DO 50 I=1,3
-           IF(ABS(XYZFMAX(I)-XYZFMIN(I)).GT.3.) THEN
-              CALL CCPERR(1,'CONTACT: BOX WIDER THAN 3 UNIT CELLS')
+           IF(ABS(XYZFMAX(I)-XYZFMIN(I)).GT.4.) THEN
+              CALL CCPERR(1,'CONTACT: BOX WIDER THAN 4 UNIT CELLS')
            ENDIF
    50   CONTINUE
 C
@@ -1758,7 +1767,7 @@
         CALL SETNET(IUOT,NET,NX,NY,NZ,XYZS,NATOMSYM,XYZSMIN,
      +              SYMATOM,HBOND,ANAME,OCC)
 C
-C..End of intemolecular contacts
+C..End of intermolecular contacts
       ENDIF
 C
 C..Find contacts
@@ -1775,7 +1784,7 @@
      +                  SYMATOM,HBOND,ANAME,OCC)
 C--------------------------------------------------------------------
 C Set up a grid.
-      INTEGER NET(31,NX,NY,NZ),INMAX
+      INTEGER NET(81,NX,NY,NZ),INMAX
       REAL XYZ(3,NATOMS),XYZSMIN(3),OCC(NATOMS)
       CHARACTER*4 ANAME(NATOMS)
       LOGICAL SYMATOM,HBOND
@@ -1818,8 +1827,8 @@
 C
 10    CONTINUE
 C
-      IF(INMAX.GT.30) THEN
-        CALL CCPERR(1,'SETNET: There are more than 30 atoms in one box')
+      IF(INMAX.GT.80) THEN
+        CALL CCPERR(1,'SETNET: There are more than 80 atoms in one box')
       ENDIF
 C
       RETURN
@@ -1835,7 +1844,7 @@
 C
       PARAMETER(NUNPAIR=2000)
 C
-      INTEGER NET(31,NX,NY,NZ),NRES(NATOMS),NRESID(NCH),CHPTR(NCH)
+      INTEGER NET(81,NX,NY,NZ),NRES(NATOMS),NRESID(NCH),CHPTR(NCH)
       REAL XYZ(3,NATOMS),XYZS(3,NATOMSYM)
       REAL XYZMIN(3)
       CHARACTER*4 ANAME(NATOMS),RNAME(NATOMS)
@@ -2086,7 +2095,7 @@
 C----------------------------------------------------------------------
 C Generate symmetry related atoms and select those that can be translated
 c to the box around the primary molecule.
-      PARAMETER(MXATSYM=100000)
+      PARAMETER(MXATSYM=400000)
 C
       REAL XYZ(3,NATOMS),OCC(NATOMS),XYZS(3,MXATSYM)
       REAL XYZSMAX(3),XYZSMIN(3)
@@ -2121,7 +2130,7 @@
 C..Ignore atoms with zero occupancy
          IF(OCC(I).EQ.0.0) GOTO 10
 C
-C..Convert atom to fractional cordinates (more convenient to manipulate)
+C..Convert atom to fractional coordinates (more convenient to manipulate)
          CALL XYZMAT(XYZ(1,I),FRXYZ,RF)
 C
 C..First test translations of -+1 cell from the original position
@@ -2148,7 +2157,7 @@
                   NATOMSYM=NATOMSYM+1
                   IF (NATOMSYM.GT.MXATSYM) THEN
                     WRITE(6,FMT='(X,A,I8,A)')
-     +              'Paramter MXATSYM (currently ',MXATSYM,
+     +              'Parameter MXATSYM (currently ',MXATSYM,
      +              ') exceeded in s/r FILSHEL'
                     CALL CCPERR(1,
      +              'IN FILSHEL: too many symmetry generated atoms')
@@ -2303,7 +2312,7 @@
       CHARACTER*1 SHORT(MAXAA)
       CHARACTER HGM*52
       CHARACTER*3000 SLINE
-      CHARACTER*8000 RESIDS
+      CHARACTER*40000 RESIDS
       CHARACTER*80 FULNAM
       COMMON /NAME/ FULNAM
       LOGICAL FOUND
@@ -2546,3 +2555,4 @@
 CCCC
 CCC      RETURN 
 CCC      END
+
diff -ruN ccp4-6.0.1-orig/src/anisoanl.f ccp4-6.0.1/src/anisoanl.f
--- ccp4-6.0.1-orig/src/anisoanl.f	2006-05-25 08:29:54.000000000 -0700
+++ ccp4-6.0.1/src/anisoanl.f	2006-07-04 08:09:24.000000000 -0700
@@ -20,7 +20,7 @@
 C----Initialize ccp4 like file organization
       CALL CCP4_PROG_VERSION('0.1',0)
       CALL CCPFYP
-      CALL CCPRCS(6,'ANISOANL','$Date: 2005/11/17 10:55:20 $')
+      CALL CCPRCS(6,'ANISOANL','$Date: 2006/05/11 08:28:38 $')
 
       CALL XYZINIT
 
@@ -259,7 +259,7 @@
      +          INSCOD,ALTCOD,SEGID,IZZ,ID)
       CALL XYZCOORD(INXYZ,'O','O',XQ,YQ,ZQ,OCCQ,BISO,BQ)
 
-C  Dont count atoms with OCC = 0.0
+C  Don't count atoms with OCC = 0.0
       IF (OCCQ.EQ.0.0) THEN
         NBROOK = NBROOK + 1
         NOMIT = NOMIT + 1
@@ -423,16 +423,17 @@
       IATM = 0
 C---Loop over atoms in XYZIN
    10 CONTINUE
-C
+
+C---Note that input is NOT connected to output via second argument
+C   of XYZADVANCE. Thus XYZOUT has no header information. This is 
+C   deliberate, since XYZOUT is a bit of a dud PDB file.
       CALL XYZADVANCE(INXYZ,0,0,*20,*20)
+      CALL XYZATOM(INXYZ,ISERQ,ATNAM,RESNAM,CHNNAM,IRES,RESNO,
+     +       INSCOD,ALTCOD,SEGID,IZZ,ID)
       CALL XYZCOORD(INXYZ,'O','O',XQ,YQ,ZQ,OCCQ,BISO,BQ)
-C
-C---Skip ANISOU lines
-      IF (BQ(2).NE.0.0 .OR. BQ(3).NE.0.0) GOTO 10
 
 C---If OCCQ = 0.0 output it without any changes, and no ANISOU line.
       IF (OCCQ.EQ.0.0 ) THEN
-        CALL XYZADVANCE(IOUTX,0,0,*20,*20)
         GO TO 10
       END IF
 
@@ -457,6 +458,8 @@
         ENDDO
       ENDIF
 
+      CALL XYZATOM(IOUTX,IATM,ATNAM,RESNAM,CHNNAM,IRES,RESNO,
+     +       INSCOD,ALTCOD,SEGID,IZZ,ID)
       CALL XYZCOORD(IOUTX,'O','O',XYZ1(IATM),XYZ2(IATM),XYZ3(IATM),
      +                                              QOCC(IATM),BISO,BQ)
       CALL XYZADVANCE(IOUTX,0,0,*20,*20)
@@ -483,6 +486,7 @@
       CHARACTER IALTCOD*1,JALTCOD*1
       INTEGER NDELBIN1(MAXTLSGRP,MAXBIN),NDELBIN2(MAXBIN)
       INTEGER NTOTBIN1(MAXTLSGRP),NTOTBIN2,NTOTMISS,NTOTPAIR
+      REAL RIOCC,RJOCC,OCCWEIGHT
       REAL XYBINS(MAXBIN,MAXBIN),RXYBINS(MAXBIN,MAXBIN)
       REAL XYMIN,XYMAX,DELBIN1(MAXTLSGRP),DELBIN2
       REAL UOBS1(6),UOBS2(6),RDIFF(3)
@@ -558,7 +562,7 @@
 
 C  Variables for scoring choice of rigid groups
       SCORE = 0.0
-      RNSCORE = 0
+      RNSCORE = 0.0
 
       IF (VERBOSE) THEN
         WRITE(6,'(/,A,/)') 
@@ -578,7 +582,7 @@
           UOBS1(I) = U_OBS(IA,I)
         ENDDO
         IALTCOD = ALTID(IA)
-        IOCC = QOCC(IA)
+        RIOCC = QOCC(IA)
 
 C  x-bin for shading
         READ(ATOM(IA),'(1X,I4)') IRES1
@@ -599,7 +603,7 @@
             UOBS2(I) = U_OBS(JA,I)
           ENDDO
           JALTCOD = ALTID(JA)
-          JOCC = QOCC(JA)
+          RJOCC = QOCC(JA)
 
 C  y-bin for shading
           READ(ATOM(JA),'(1X,I4)') JRES1
@@ -615,11 +619,11 @@
 C Deal with multiple conformations
           IF (IALTCOD.NE.' ' .AND. JALTCOD.NE.' ') THEN
             IF (IALTCOD.NE.JALTCOD) GOTO 200
-            OCCWEIGHT = IOCC
+            OCCWEIGHT = RIOCC
           ELSEIF (IALTCOD.NE.' ') THEN
-            OCCWEIGHT = IOCC
+            OCCWEIGHT = RIOCC
           ELSEIF (JALTCOD.NE.' ') THEN
-            OCCWEIGHT = JOCC
+            OCCWEIGHT = RJOCC
           ELSE
             OCCWEIGHT = 1.0
           ENDIF
@@ -673,7 +677,7 @@
 
       SCORE = SCORE / RNSCORE
       WRITE(6,'(/,'' Score for rigid-body criterion = '',F8.2)') SCORE
-      WRITE(6,'('' Based on '',F8.1,'' comparisons '')') RNSCORE
+      WRITE(6,'('' Based on '',F12.1,'' comparisons '')') RNSCORE
       WRITE(6,'('' You should vary the TLS groups to'',
      +          '' lower this score. '',/)') 
 
@@ -1295,9 +1299,9 @@
 C---Local variables
       REAL SHIFTWGT, CVM(MAXTLSGRP20,MAXTLSGRP20)
 
-C---Calcalate A matrices for particular set of orthogonal coordinates
+C---Calculate A matrices for particular set of orthogonal coordinates
 C   obtained from XORT0(3,QQA). Elements of A are orthogonal coordinates
-C   w.r.t. TLS orgins, and are placed back in XORT0(3,QQA).
+C   w.r.t. TLS origins, and are placed back in XORT0(3,QQA).
       CALL CALC_AMAT
 C
       NTLSGRP20 = NTLSGRP*20
@@ -1883,7 +1887,7 @@
 
 C---Calculates A matrices for particular set of orthogonal coordinates
 C   obtained from XORT0(3,QQA). Elements of A are orthogonal coordinates
-C   w.r.t. TLS orgins, and are placed back in XORT0(3,QQA).
+C   w.r.t. TLS origins, and are placed back in XORT0(3,QQA).
 
 C   Changing origin or equivalently XORT0 shouldn't affect converged values
 C   of U, but does change corresponding values of T and S.
@@ -2124,7 +2128,7 @@
 C   uses definition of Trueblood, assuming sigU = 0.001
       GOF = SQRT(RESL2_FIT/REAL(6*NTLSATOMS - 20*NTLSGRP))*1000.0
 C---R values
-C   Note that these equal 1 for T/L/S = 0 so the intial values
+C   Note that these equal 1 for T/L/S = 0 so the initial values
 C   reflect initial TLS values chosen by program. Currently, T is
 C   set to average U's and this accounts for most of drop in R.
       R_FIT = SQRT(RESL2_FIT / SUMOBS_FIT)
@@ -2270,7 +2274,7 @@
 C   uses definition of Trueblood, assuming sigU = 0.001
       GOF = SQRT(RESL2_FIT/REAL(6*NTLSATOMS - 20*NTLSGRP))*1000.0
 C---R values
-C   Note that these equal 1 for T/L/S = 0 so the intial values
+C   Note that these equal 1 for T/L/S = 0 so the initial values
 C   reflect initial TLS values chosen by program. Currently, T is
 C   set to average U's and this accounts for most of drop in R.
       R_FIT = SQRT(RESL2_FIT / SUMOBS_FIT)
@@ -2709,7 +2713,7 @@
 
 C----This subroutine makes singular value decomposition
 C----as   A = U.W.VT
-C----See Press, Flannery, Teukolsky, Vettering  Numerical recipes
+C----See Press, Flannery, Teukolsky, Vetterling  Numerical recipes
 C----M and N are physical sizes of matrix MP and NP are logical
 C---sizes. M >= N. Otherwise routine will fail
 C---Note: Output is VT but not V
diff -ruN ccp4-6.0.1-orig/src/cad.f ccp4-6.0.1/src/cad.f
--- ccp4-6.0.1-orig/src/cad.f	2006-05-25 08:29:54.000000000 -0700
+++ ccp4-6.0.1/src/cad.f	2006-08-12 22:07:15.000000000 -0700
@@ -458,7 +458,7 @@
       CALL MTZINI
       CALL CCPDPN(LUNIN,'DATA','READONLY','F',LDUMM,LFAIL)
       CALL CCPDPN(LUNOUT,'PRINTER','PRINTER','F',LDUMM,LFAIL)
-      CALL CCPRCS(6,'CAD','$Date: 2005/11/18 15:49:06 $')
+      CALL CCPRCS(6,'CAD','$Date: 2006/08/01 07:50:42 $')
       CALL CADINI
       CALL CCPDAT(MTZDATE)
 C          ****************************************
@@ -1003,7 +1003,7 @@
      +      II=1,NUM_STORE_WRITE)
 6661     FORMAT(//,' After Processing File_Number: ',I2,/,
      +             ' Number of columns so far    : ',I3,/,
-     +             ' Accummulated Out_Put_MTZ_labels are:',/,
+     +             ' Accumulated Out_Put_MTZ_labels are:',/,
      +           99(' ',A,' ',A,' ',A,' ',A,/))
 6662     FORMAT(//,' MTZOUT_LABELS are H K L and -',/,
      +           99(' ',A,' ',A,' ',A,' ',A,/))
@@ -1661,6 +1661,8 @@
 C
 C            *******************************************
         CALL LRTITL(MTZIN,TITIN(NFILE),LENTIT)
+c Must set NHISIN to max allowed number of listory lines
+        NHISIN(NFILE) = MAXHIS
         CALL LRHIST(MTZIN,HISTIN(1,NFILE),NHISIN(NFILE))
 C            *******************************************
 C
@@ -3016,7 +3018,7 @@
 C
         WRITE (LUNOUT,FMT='(A,A,/,A,A,A,/,A)')
      +    ' Key_Word Error, Wrong type of input for  RESOLUTIO',
-     +    'N line:-','  Second Arguement  MUST be a Character ',
+     +    'N line:-','  Second Argument  MUST be a Character ',
      +    'string, either OVER_ALL  or FILE_NUMBER, Ignoring th',
      +    'is line -',LINE(1:LENSTR(LINE))
         GO TO 10
@@ -3029,7 +3031,7 @@
       CALL CCPUPC(CWORK)
 C          *************
 C
-C---- see whether second arguement = 'O' or 'F'
+C---- see whether second argument = 'O' or 'F'
 C
       IF (CWORK(1:1).EQ.'O') THEN
 C
@@ -3048,14 +3050,14 @@
 C
       IF (CWORK(1:1).EQ.'F') THEN
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
         IF (ITYP(3).NE.2) THEN
           WRITE (LUNOUT,FMT='(A,A,/,A,A,A,/,A)')
      +      ' Key_Word Error, Wrong type of input for  RESOLUT',
      +      'ION line:-',' If Sub_KeyWord = FILE_NUMBER  then ',
-     +      'third  Arguement MUST be an Integer  Ignoring this',
+     +      'third  Argument MUST be an Integer  Ignoring this',
      +      ' line -',LINE(1:LENSTR(LINE))
           GO TO 10
         END IF
@@ -3114,7 +3116,7 @@
 C
         WRITE (LUNOUT,FMT='(A,A,/,A,A,A,/,A)')
      +    ' Key_Word Error, Wrong type of input for  OUTLIM',
-     +    ' line:-','  Second Arguement  MUST be a Character ',
+     +    ' line:-','  Second Argument  MUST be a Character ',
      +    'string, either SPACEGROUP  or HKL, Ignoring th',
      +    'is line -',LINE(1:LENSTR(LINE))
         GO TO 10
@@ -3127,7 +3129,7 @@
       CALL CCPUPC(CWORK)
 C          *************
 C
-C---- see whether second arguement = 'S' or 'H'
+C---- see whether second argument = 'S' or 'H'
         ITOK = 3
 C
       IF (CWORK(1:1).EQ.'S') THEN
@@ -3193,14 +3195,14 @@
 C
       IF (CWORK(1:1).EQ.'F') THEN
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
         IF (ITYP(3).NE.2) THEN
           WRITE (LUNOUT,FMT='(A,A,/,A,A,A,/,A)')
      +      ' Key_Word Error, Wrong type of input for  LABIN',' line:-',
      +      ' If Sub_KeyWord = FILE_NUMBER  then ',
-     +      'third  Arguement MUST be an Integer  Ignoring this',
+     +      'third  Argument MUST be an Integer  Ignoring this',
      +      ' line -',LINE(1:LENSTR(LINE))
           GO TO 10
         END IF
@@ -3291,14 +3293,14 @@
 C
       IF (CWORK(1:1).EQ.'F') THEN
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
         IF (ITYP(3).NE.2) THEN
           WRITE (LUNOUT,FMT='(A,A,/,A,A,A,/,A)')
      +      ' Key_Word Error, Wrong type of input for  LABOUT',
      +      ' line:-',' If Sub_KeyWord = FILE_NUMBER  then ',
-     +      'third  Arguement MUST be an Integer  Ignoring this',
+     +      'third  Argument MUST be an Integer  Ignoring this',
      +      ' line -',LINE(1:LENSTR(LINE))
           GO TO 10
         END IF
@@ -3358,14 +3360,14 @@
 C
       IF (CWORK(1:1).EQ.'F') THEN
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
         IF (ITYP(3).NE.2) THEN
           WRITE (LUNOUT,FMT='(a,a,/,a,a,a,/,a)')
      +      ' Key_Word Error, Wrong type of input for  CTYPIN',
      +      ' line:-',' If Sub_KeyWord = FILE_NUMBER  then ',
-     +      'third  Arguement MUST be an Integer  Ignoring this',
+     +      'third  Argument MUST be an Integer  Ignoring this',
      +      ' line -',LINE(1:LENSTR(LINE))
           GO TO 10
         END IF
@@ -3430,7 +3432,7 @@
             WRITE (LUNOUT,FMT='(/,a,a,/,a,a)')
      +  '  FCpart PHICpart input - Symmetry is that of POINT GROUP ',
      +  ' only: NO phase changes applied.',
-     +  ' It is assumed that  all translation program will deal',
+     +  ' It is assumed that all translation program will deal',
      +  ' with screw axes etc themselves.'
 C
           PROCESSING_CODE(NFILE) = 3
@@ -3559,14 +3561,14 @@
 C
       IF (CWORK(1:1).EQ.'F') THEN
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
         IF (ITYP(3).NE.2) THEN
           WRITE (LUNOUT,FMT='(a,a,/,a,a,a,/,a)')
      +      ' Key_Word Error, Wrong type of input for  CTYPIN',
      +      ' line:-',' If Sub_KeyWord = FILE_NUMBER  then ',
-     +      'third  Arguement MUST be an Integer  Ignoring this',
+     +      'third  Argument MUST be an Integer  Ignoring this',
      +      ' line -',LINE(1:LENSTR(LINE))
           GO TO 10
         END IF
@@ -3656,7 +3658,7 @@
 C FULL sets MTZPRT = 3
 C     full header o/p from mtz reads
 C
-      MTZPRT = 1
+      MTZPRT = 0
 C
 C
       IF (NTOK.LE.1) THEN
@@ -3722,7 +3724,7 @@
           GO TO 10
       END IF
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
       IF (ITYP(3).NE.2) THEN
@@ -3778,7 +3780,7 @@
           GO TO 10
       END IF
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
       IF (ITYP(3).NE.2) THEN
@@ -3832,7 +3834,7 @@
           GO TO 10
       END IF
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
       IF (ITYP(3).NE.2) THEN
@@ -3900,7 +3902,7 @@
           GO TO 10
       END IF
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
       IF (ITYP(3).NE.2) THEN
@@ -3968,7 +3970,7 @@
           GO TO 10
       END IF
 C
-C---- second arguement = 'FILE_NUMBER'
+C---- second argument = 'FILE_NUMBER'
 C     test if third argument is integer
 C
       IF (ITYP(3).NE.2) THEN
diff -ruN ccp4-6.0.1-orig/src/contact.f ccp4-6.0.1/src/contact.f
--- ccp4-6.0.1-orig/src/contact.f	2006-05-25 08:29:54.000000000 -0700
+++ ccp4-6.0.1/src/contact.f	2006-07-04 08:10:13.000000000 -0700
@@ -369,15 +369,15 @@
 C  Command ANGLE (ANGLE angh ango dmin maxnb bmax) may be used to
 C  compute hydrogen-bond angles and water hydrogen-bond statistics.
 C
-C  Maximum Residue number is 6000. Maximum number of atoms is 48000.
+C  Maximum Residue number is 6000. Maximum number of atoms is 96000.
 C  You may use up to 48 symmetry operations in IMOL and AUTO mode.
 C
-C      PARAMETER (MXATOM=48000,MAXRES=9000,MXSYMM=96)
+C      PARAMETER (MXATOM=96000,MAXRES=9000,MXSYMM=96)
 C  MXSYMM is: no. of symmetry operations + 125
 C
 C  When using the ANGLE option, the program calculates the hydrogen
 C  position for those target nitrogen atoms where the hydrogen position
-C  is unambigous (ie excluding NZ on Lys and N terminus). The
+C  is unambiguous (ie excluding NZ on Lys and N terminus). The
 C  angle O...H...N is calculated and printed. For source...oxygen
 C  hydrogen bonds, the angle source...O__Bonded carbon is
 C  calculated. Limits on both these angles (ANGH and ANGO) must be
@@ -387,7 +387,7 @@
 C  The ANGLE option can be used to search for hydrogen bonds within
 C  the protein, and the bond angles will be calculated as described
 C  above. Note that mainchain-mainchain and sidechain-sidechain
-C  contacts within one Residue or to an immediatley adjacent Residue
+C  contacts within one Residue or to an immediately adjacent Residue
 C  are suppressed in this mode.
 C The minimum bondlength (DMIN) for bonds to be included and the maximum
 C  number of bonds (MAXNB) are read from the same card, in free format,
@@ -436,7 +436,7 @@
 C       TARGET 337 1000
 C       eof
 C
-C 4)Bonds lenghts in NAD molecule (Residue number 336):
+C 4)Bond lengths in NAD molecule (Residue number 336):
 C
 C       contact xyzin holo9c4.brk << eof
 C       TITLE NAD BONDS
@@ -446,7 +446,7 @@
 C       TARGET  336
 C       eof
 C
-C 5)Intersubunit contacts .Subunits must have different chain names.
+C 5)Intersubunit contacts. Subunits must have different chain names.
 c
 C       contact xyzin holo9c4.brk<< eof
 C       title  INTERSUBUNIT CONTACTS
@@ -476,7 +476,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30)
 C     ..
 C     .. Scalars in Common ..
@@ -489,8 +489,8 @@
 C     .. Arrays in Common ..
       REAL Batom,FRclose,RFin,Rsymm,S,TR,XYZ,XYZS
       INTEGER NumMetalAngles,IsitAtom,IsitResidue,IsitChains
-      INTEGER*2 InumAtmSymm,IresidNums,Nsymop,NUM,NUS,TranslationCode
-      INTEGER*2 FromAtmSelected,ToAtomSelected
+      INTEGER InumAtmSymm,IresidNums,Nsymop,NUM,NUS,TranslationCode
+      INTEGER FromAtmSelected,ToAtomSelected
       LOGICAL SourceResFlag,TargetResFlag,DoChains,Hexclude
       CHARACTER ChainNames*1,AtomNames*4,ResidNames*4,
      +          TranslationTitles*9,Metals*80,SymmTitles*80
@@ -507,7 +507,7 @@
 C     ..
 C     .. Local Arrays ..
       REAL Bfactors(6),cell(6),Recipcell(6),ROin(4,4)
-      INTEGER*2 NET(MaxSize)
+      INTEGER NET(MaxSize)
 C     ..
 C     .. External Subroutines ..
       EXTERNAL CCPERR,CCPFYP,CCPRCS,CONTACT,FRCLIM,GETRecipcell,
@@ -527,7 +527,7 @@
      +       KtoResidSelect(MaxSelectedResidues),
      +       KFromResidSelect(MaxSelectedResidues),
      +       KSelectAtmType(MaxSelectedResidues)
-      COMMON /AutoCom/AutoFlag,TranslationCode(2*MaxAtoms),
+      COMMON /AutoCom/AutoFlag,TranslationCode(3*MaxAtoms),
      +       TR(4,4,MaxSymmetry),BigSearch,List
       COMMON /BoundsCom/Xmin,Xmax,Ymin,Ymax,Zmin,Zmax
       COMMON /CardsCom/SourceResFlag(MaxResidues),
@@ -544,9 +544,9 @@
       COMMON /ResNumCom/IresidNums(MaxAtoms),
      +                  FromAtmSelected(MaxAtoms),
      +                  ToAtomSelected(MaxAtoms)
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,3*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
       COMMON /WatCom/AngleHY,AngleOx,DistMin,maxNB,Bmax
       COMMON /Xcards/ModeAtomFlag,ModeFlag,Title
@@ -601,7 +601,7 @@
 C
 C          *********************************************
       CALL CCPFYP
-      CALL CCPRCS(6,'CONTACT','$Date: 2005/09/06 11:25:10 $')
+      CALL CCPRCS(6,'CONTACT','$Date: 2006/06/09 12:46:59 $')
       CALL XYZINIT
 C          **********************************************
 C
@@ -858,9 +858,9 @@
       GO TO 10
 C     *****
 C     at this point, the following arrays are loaded by selected atoms
-C     XYZ([dimension <=3],[atom number <MaxAtoms=48000]) -> coordinates
-C     [AtomNames,ResidNames,ChainNames,IresidNums,Batom]([atom number <MaxAtoms=48000])
-C     NUM([atom number <MaxAtoms=48000]) -> pointer to atom number initialized with
+C     XYZ([dimension <=3],[atom number <MaxAtoms=96000]) -> coordinates
+C     [AtomNames,ResidNames,ChainNames,IresidNums,Batom]([atom number <MaxAtoms=96000])
+C     NUM([atom number <MaxAtoms=96000]) -> pointer to atom number initialized with
 C       atom number
 C     *****
 C     bricking:
@@ -908,7 +908,7 @@
         IF (ModeFlag .ne. 'IM') 
      +     CALL SETNET(Xmin,Ymin,Zmin,NX,NY,NZ,NUM,
      +                             XYZ,Icount,NET)
-C     NUS([atom number <MaxAtoms=48000]): numbers of symmetry related atoms 
+C     NUS([atom number <MaxAtoms=96000]): numbers of symmetry related atoms 
         IF (ModeFlag .eq. 'IM') 
      +     CALL SETNET(Xmin,Ymin,Zmin,NX,NY,NZ,NUS,
      +                             XYZS,Icounts,NET)
@@ -943,7 +943,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains,MaxParams,Mkeys
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30,
      +           MaxParams=200,Mkeys=20)
 C     ..
@@ -958,7 +958,7 @@
       REAL FRclose,RFin,Rsymm,S,TR,XYZS
       INTEGER NumMetalAngles,IsitAtom,IsitResidue,IsitChains,
      +        Kend,IRSC,J1,J2
-      INTEGER*2 InumAtmSymm,Nsymop,NUS,TranslationCode
+      INTEGER InumAtmSymm,Nsymop,NUS,TranslationCode
       LOGICAL SourceResFlag,TargetResFlag,DoChains
       CHARACTER TranslationTitles*9,Metals*80,SymmTitles*80
 C     ..
@@ -981,7 +981,7 @@
       REAL cell(6),Fvalue(MaxParams),T2(4,4,MaxSymmetry)
       INTEGER Ibeg(MaxParams),Idec(MaxParams),
      +        Iend(MaxParams),Ityp(MaxParams)
-      INTEGER*2 SourceWork(MaxResidues),TargetWork(MaxResidues)
+      INTEGER SourceWork(MaxResidues),TargetWork(MaxResidues)
       CHARACTER Cvalue(MaxParams)*4,KEYS(Mkeys)*8,New2Old(3,2)*11,
      +          Rhomb(2,2)*11
       INTEGER KtoAtmBegin,KtoAtmEnd,KFromAtmBegin,KFromAtmEnd,
@@ -1002,7 +1002,7 @@
      +       KtoResidSelect(MaxSelectedResidues),
      +       KFromResidSelect(MaxSelectedResidues),
      +       KSelectAtmType(MaxSelectedResidues)
-      COMMON /AutoCom/AutoFlag,TranslationCode(2*MaxAtoms),
+      COMMON /AutoCom/AutoFlag,TranslationCode(3*MaxAtoms),
      +       TR(4,4,MaxSymmetry),BigSearch,List
       COMMON /CardsCom/SourceResFlag(MaxResidues),
      +       TargetResFlag(MaxResidues),Dlimit,Dclose,Hexclude
@@ -1011,9 +1011,9 @@
       COMMON /CharTT/TranslationTitles(125)
       COMMON /DatMetals/MetalCounter,DistMetalLigands,LookForMetal,
      +       NumMetalAngles(MaxMetals)
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,3*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
       COMMON /WatCom/AngleHY,AngleOx,DistMin,maxNB,Bmax
       COMMON /Xcards/ModeAtomFlag,ModeFlag,Title
@@ -1355,7 +1355,7 @@
   220   CONTINUE
         CALL SIDENT(TR(1,1,LLx),Iflag)
 C
-C--- shouldnt ever get here with Iflag = 1
+C--- shouldn't ever get here with Iflag = 1
 C
         IF (Iflag .eq. 1) THEN
           IF (Idents .ne. 0) CALL CCPERR(1,' identity error ')
@@ -1385,7 +1385,7 @@
  221    CONTINUE
         NSYM = 1
 
-C For P1 contruct label "1: X, Y, Z"
+C For P1 construct label "1: X, Y, Z"
         KsymmTit = 1
         CALL SYMTRN2(1,Rsymm,SymmTitles)
         write (Cwork,fmt=6008) 1
@@ -1748,7 +1748,7 @@
               Iflag = -99
               CALL SIDENT(TR(1,1,LLx),Iflag)
 C
-C--- shouldnt ever get here with Iflag = 1
+C--- shouldn't ever get here with Iflag = 1
 C
               IF (Iflag .eq. 1) THEN
                 IF (Idents .ne. 0) CALL CCPERR(1,' identity error ')
@@ -2010,7 +2010,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains,MaxAngles
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30,
      +           MaxAngles=20)
 C     ..
@@ -2019,7 +2019,7 @@
       INTEGER NX,NY,NZ
 C     ..
 C     .. Array Arguments ..
-      INTEGER*2 NET(198,NX,NY,NZ)
+      INTEGER NET(198,NX,NY,NZ)
 C     ..
 C     .. Scalars in Common ..
       REAL AngleHY,AngleOx,Bmax,Dclose,DistMetalLigands,DistMin,Dlimit,
@@ -2031,8 +2031,8 @@
 C     .. Arrays in Common ..
       REAL Batom,FRclose,RFin,Rsymm,S,TR,XYZ,XYZS
       INTEGER NumMetalAngles,IsitAtom,IsitResidue,IsitChains
-      INTEGER*2 InumAtmSymm,IresidNums,Nsymop,NUM,NUS,TranslationCode
-      INTEGER*2 FromAtmSelected,ToAtomSelected
+      INTEGER InumAtmSymm,IresidNums,Nsymop,NUM,NUS,TranslationCode
+      INTEGER FromAtmSelected,ToAtomSelected
       LOGICAL SourceResFlag,TargetResFlag,DoChains
       CHARACTER ChainNames*1,AtomNames*4,ResidNames*4,
      +          TranslationTitles*9,Metals*80,SymmTitles*80
@@ -2063,6 +2063,8 @@
      +        NsymmCounter(MaxSymmetry,125)
 C>>   modified HP990407 for 5 translations
       CHARACTER ortsym(125)*3,SaveNames(MaxAngles,MaxMetals)*25
+      CHARACTER copytitle*9
+      
 C     ..
 C     .. External Subroutines ..
       EXTERNAL CCPERR,CCPLWC,TRANSFRM,GETANGL,GETH,GETO,getspecial,
@@ -2073,7 +2075,7 @@
 C     ..
 C     .. Common blocks ..
       COMMON /ATMCHR/ChainSelected(MaxSelectedChains,2)
-      COMMON /AutoCom/AutoFlag,TranslationCode(2*MaxAtoms),
+      COMMON /AutoCom/AutoFlag,TranslationCode(3*MaxAtoms),
      +       TR(4,4,MaxSymmetry),BigSearch,List
       COMMON /CardsCom/SourceResFlag(MaxResidues),
      +       TargetResFlag(MaxResidues),Dlimit,Dclose,Hexclude
@@ -2098,9 +2100,9 @@
      +       KFromResidSelect(MaxSelectedResidues),
      +       KSelectAtmType(MaxSelectedResidues)
 
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,3*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
       COMMON /WatCom/AngleHY,AngleOx,DistMin,maxNB,Bmax
       COMMON /Xcards/ModeAtomFlag,ModeFlag,Title
@@ -2423,7 +2425,7 @@
            IF (H1 .eq. 'O' .or. 
      +         H1 .eq. 'N' ) THEN
 C
-C---- this didnt mark Al---F bonds
+C---- this didn't mark Al---F bonds
 C 
                IF (H2 .eq. 'O' .or. 
      +             H2 .eq. 'N') THEN
@@ -2434,7 +2436,7 @@
 C
 C--- so do metal Dmark here
 C  so what bonds can a metal have ???? O,N,S,Cl,Br,I,F
-C howabout NOT carbon -- no good for some case ?
+C how about NOT carbon -- no good for some case ?
 C
            IF (LookForMetal .and. 
      +         H1 .eq. ElementMetal(1:1)   .and.
@@ -2450,7 +2452,8 @@
            IF (ResidNames(MsourceAtom) .ne. 'WAT ' .and. 
      +         ResidNames(MsourceAtom) .ne. 'HOH ' .and.
      +         ResidNames(Ktarget) .ne. 'WAT ' .and.
-     +         ResidNames(Ktarget) .ne. 'HOH ') 
+     +         ResidNames(Ktarget) .ne. 'HOH '.and. 
+     +         KsymmTarget .gt. 0 .and. KTransTarget .gt. 0)
      +       NsymmCounter(KsymmTarget,KtransTarget) = 
      +           NsymmCounter(KsymmTarget,KtransTarget) + 1
 C
@@ -2510,13 +2513,16 @@
           IF (Twork .eq. 'Hoh') Twork = 'Wat '
 C
 C  if 1009
+          copytitle = '         '
+          if (KTransTarget .gt. 0) 
+     +      copytitle = TranslationTitles(KtransTarget)
           IF (IPR .eq. 1) THEN
             IF (ModeAtomFlag .eq. 'HO') THEN
               IF (List) THEN
                write (6,fmt=6008) Swork,ResSource,
      +    AtomNames(MsourceAtom),Twork,ResTarget,
      +    AtomNames(Ktarget),D,mark,ANGL,
-     +    TranslationTitles(KtransTarget),
+     +    copytitle,
      +    SymmTitles(KsymmTarget) (1:lenstr(SymmTitles(KsymmTarget))),
      +    TargetSpecial(1:lenstr(TargetSpecial))
               END IF
@@ -2525,7 +2531,7 @@
                 write (6,fmt=6010) Swork,ResSource,
      +    AtomNames(MsourceAtom),Twork,ResTarget,
      +    AtomNames(Ktarget),D,mark,
-     +    TranslationTitles(KtransTarget),
+     +    copytitle,
      +    SymmTitles(KsymmTarget) (1:lenstr(SymmTitles(KsymmTarget))),
      +    TargetSpecial(1:lenstr(TargetSpecial))
  6008     FORMAT (1X,A,1X,A,1X,A,A,1X,A,1X,A,' ... ',f5.2,1X,A,F6.1,
@@ -2554,14 +2560,14 @@
        ELSE IF (ModeAtomFlag .eq. 'HO') THEN
          IF (List) THEN
            write (6,fmt=6012) Twork,ResTarget,AtomNames(Ktarget),D,
-     +     mark,ANGL,TranslationTitles(KtransTarget),
+     +     mark,ANGL,copytitle,
      +     SymmTitles(KsymmTarget) (1:lenstr(SymmTitles(KsymmTarget))),
      +     TargetSpecial(1:lenstr(TargetSpecial))
          END IF
        ELSE
          IF (List) THEN
            write (6,fmt=6014) Twork,ResTarget,AtomNames(Ktarget),D,
-     +     mark,TranslationTitles(KtransTarget),
+     +     mark,copytitle, 
      +     SymmTitles(KsymmTarget) (1:lenstr(SymmTitles(KsymmTarget))),
      +     TargetSpecial(1:lenstr(TargetSpecial))
  6012  FORMAT (16X,A,1X,A,1X,A,' ... ',f5.2,1X,1A,F6.1,'[',A,']',A,
@@ -2971,7 +2977,7 @@
          
       DO 220 Jdo = 1,MaxSymmetry
 C>>        DO 210 Kdo = 1,27
-         DO 210 Kdo = 1,125
+         DO 210 Kdo = 1,NTRANS
 C<<   modified HP990407 for 5 translations
           IF (NsymmCounter(Jdo,Kdo) .gt. 0) THEN
             Isymmetry = Jdo
@@ -3124,7 +3130,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30)
 C     ..
 C     .. Scalar Arguments ..
@@ -3146,8 +3152,8 @@
       INTEGER KtoAtmBegin,KtoAtmEnd,KFromAtmBegin,KFromAtmEnd,
      +        KtoResidSelect,KFromResidSelect,KSelectAtmType
       REAL Batom,FRclose,RFin,Rsymm,S,XYZ,XYZS
-      INTEGER*2 InumAtmSymm,IresidNums,Nsymop,NUM,NUS
-      INTEGER*2 FromAtmSelected,ToAtomSelected
+      INTEGER InumAtmSymm,IresidNums,Nsymop,NUM,NUS
+      INTEGER FromAtmSelected,ToAtomSelected
       LOGICAL SourceResFlag,TargetResFlag
       CHARACTER ChainNames*1,AtomNames*4,ResidNames*4,SymmTitles*80
 C     ..
@@ -3174,9 +3180,9 @@
      +       KtoResidSelect(MaxSelectedResidues),
      +       KFromResidSelect(MaxSelectedResidues),
      +       KSelectAtmType(MaxSelectedResidues)
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,3*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
       COMMON /Xcards/ModeAtomFlag,ModeFlag,Title
 C     ..
@@ -3283,7 +3289,7 @@
 C
       IF (SATOM .eq. 'N   ') THEN
 C
-C----   find coords of carbonyl carbon of preceeding Residue and
+C----   find coords of carbonyl carbon of preceding Residue and
 C       alpha carbon of this Residue
 C
         IR = -1
@@ -3470,7 +3476,7 @@
         CALL GETATOM(ATOM,NCH,MsourceResid,IA,IR,ISYM,XYZ1,IERR)
         IF (IERR .eq. -1) RETURN
 C
-C----  test for sIdechain type
+C----  test for sidechain type
 C      asp,asn get CG
 C
       ELSE IF (RES .eq. 'ASP ' .or. RES .eq. 'ASN ') THEN
@@ -3557,11 +3563,11 @@
 C     =======================================================
 C
       INTEGER MaxAtoms
-      PARAMETER (MaxAtoms=48000)
+      PARAMETER (MaxAtoms=96000)
       REAL Xmin,Ymin,Zmin
       INTEGER IC,NX,NY,NZ
       REAL XY(3,*)
-      INTEGER*2 NET(198,NX,NY,NZ),NU(*)
+      INTEGER NET(198,NX,NY,NZ),NU(*)
       REAL X,Y,Z
       INTEGER I,IN,INMAX,IX,IY,IZ,J,K,Error_counter
       INTRINSIC INT
@@ -3630,7 +3636,7 @@
      +' - this is unrealistic - check your matrices',/)
       CALL CCPERR(1,'Bad matrices')
       END IF
-cpjx This line is redundant now - it is unreachable if error_couter is
+cpjx This line is redundant now - it is unreachable if error_counter is
 cpjx greater than zero.
 cpjx        if (error_counter.gt.50) call ' BRICK EXCEEDED over 50 times'
 C
@@ -3796,7 +3802,7 @@
       SUBROUTINE SYMGEN
 C     =================
 C     Generate symmetry related atoms
-C     NUS([atom index < MaxAtoms=48000]) internal number of symmetry generated atoms
+C     NUS([atom index < MaxAtoms=96000]) internal number of symmetry generated atoms
 C     InumAtmSymm([atom index]) -> internal atom number NUM([atom index]) of the
 C       original atom from which it was generated
 C     XYZS([dimension <=3],[atom index]) coordinates of generated atom
@@ -3806,7 +3812,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30)
 C     ..
 C     .. Scalars in Common ..
@@ -3819,7 +3825,7 @@
 
       REAL Batom,FRclose,RFin,Rsymm,S,TR,XYZ,XYZbounds,XYZS
       INTEGER NumMetalAngles
-      INTEGER*2 InumAtmSymm,Nsymop,NUM,NUS,TranslationCode
+      INTEGER InumAtmSymm,Nsymop,NUM,NUS,TranslationCode
       LOGICAL SourceResFlag,TargetResFlag
       CHARACTER TranslationTitles*9,SymmTitles*80
 C     ..
@@ -3833,7 +3839,7 @@
       CHARACTER ChainNames*1,AtomNames*4,ResidNames*4
       COMMON /InputNames/AtomNames(MaxAtoms),ResidNames(MaxAtoms),
      +       ChainNames(MaxAtoms)
-      COMMON /AutoCom/AutoFlag,TranslationCode(2*MaxAtoms),
+      COMMON /AutoCom/AutoFlag,TranslationCode(3*MaxAtoms),
      +       TR(4,4,MaxSymmetry),BigSearch,List
 ccx      COMMON /BoundsCom/ Xmin,Xmax,Ymin,Ymax,Zmin,Zmax
       COMMON /BoundsCom/XYZbounds(2,3)
@@ -3845,9 +3851,9 @@
      +       NumMetalAngles(MaxMetals)
       COMMON /Params/NUM(MaxAtoms),XYZ(3,MaxAtoms),Icount,
      +       Batom(MaxAtoms)
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,3*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
       COMMON /Xcards/ModeAtomFlag,ModeFlag,Title
 C     ..
@@ -4000,7 +4006,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30)
 C     ..
 C     .. Scalars in Common ..
@@ -4011,7 +4017,7 @@
 C     ..
 C     .. Arrays in Common ..
       REAL FRclose,RFin,Rsymm,S,TR,XYZS
-      INTEGER*2 InumAtmSymm,Nsymop,NUS,TranslationCode
+      INTEGER InumAtmSymm,Nsymop,NUS,TranslationCode
       LOGICAL SourceResFlag,TargetResFlag
       CHARACTER TranslationTitles*9,SymmTitles*80
 C     ..
@@ -4027,15 +4033,15 @@
       EXTERNAL MATMUL4,RBcell,RBRORF
 C     ..
 C     .. Common blocks ..
-      COMMON /AutoCom/AutoFlag,TranslationCode(2*MaxAtoms),
+      COMMON /AutoCom/AutoFlag,TranslationCode(3*MaxAtoms),
      +       TR(4,4,MaxSymmetry),BigSearch,List
       COMMON /CardsCom/SourceResFlag(MaxResidues),
      +       TargetResFlag(MaxResidues),Dlimit,Dclose,Hexclude
       COMMON /CharSymm/SymmTitles(MaxSymmetry)
       COMMON /CharTT/TranslationTitles(125)
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,2*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
       COMMON /Xcards/ModeAtomFlag,ModeFlag,Title
 C     ..
@@ -4182,7 +4188,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30)
 C     ..
 C     .. Scalar Arguments ..
@@ -4201,7 +4207,7 @@
 C     .. Arrays in Common ..
       REAL Batom,FRclose,RFin,Rsymm,S,XYZ,XYZS
       INTEGER BadWaters,HistogramAngles
-      INTEGER*2 InumAtmSymm,Nsymop,NUM,NUS
+      INTEGER InumAtmSymm,Nsymop,NUM,NUS
       LOGICAL SourceResFlag,TargetResFlag
       CHARACTER SymmTitles*80
 C     ..
@@ -4226,9 +4232,9 @@
       COMMON /CharSymm/SymmTitles(MaxSymmetry)
       COMMON /Params/NUM(MaxAtoms),XYZ(3,MaxAtoms),Icount,
      +       Batom(MaxAtoms)
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,3*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
       COMMON /Xcards/ModeAtomFlag,ModeFlag,Title
 C     ..
@@ -4811,7 +4817,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains,MaxSpecial
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30,
      +           MaxSpecial=2000)
 C     ..
@@ -4832,7 +4838,7 @@
 C     ..
 C     .. Arrays in Common ..
       REAL FRclose,RFin,Rsymm,S,XYZS
-      INTEGER*2 InumAtmSymm,Nsymop,NUS
+      INTEGER InumAtmSymm,Nsymop,NUS
 C     ..
 C     .. Local Arrays ..
       REAL delta(3),XYZspecial(3,MaxSpecial),Rdiff
@@ -4841,9 +4847,9 @@
       EXTERNAL CCPERR
 C     ..
 C     .. Common blocks ..
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,3*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
 C     ..
 C     .. Save statement ..
@@ -4939,7 +4945,7 @@
      +        MaxSelectedAtoms,MaxSelectedResidues,
      +        MaxSelectedChains
       PARAMETER (MaxSelectedAtoms=25,MaxSelectedResidues=1998,
-     +           MaxAtoms=48000,MaxResidues=9000,MaxSymmetry=230,
+     +           MaxAtoms=96000,MaxResidues=9000,MaxSymmetry=230,
      +           MaxSize=8000000,MaxMetals=20,MaxSelectedChains=30)
 C     ..
 C     .. Scalar Arguments ..
@@ -4954,16 +4960,16 @@
 C     ..
 C     .. Arrays in Common ..
       REAL FRclose,RFin,Rsymm,S,XYZS
-      INTEGER*2 InumAtmSymm,Nsymop,NUS
+      INTEGER InumAtmSymm,Nsymop,NUS
 C     ..
 C     .. Local Scalars ..
       REAL Rdiff,XXF,YYF,ZZF
       INTEGER J,Nclose
 C     ..
 C     .. Common blocks ..
-      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(2*MaxAtoms),
-     +       InumAtmSymm(2*MaxAtoms),XYZS(3,2*MaxAtoms),
-     +       Nsymop(2*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
+      COMMON /SymmCom/NumSymm,Idents,S(4,4,MaxSymmetry),NUS(3*MaxAtoms),
+     +       InumAtmSymm(3*MaxAtoms),XYZS(3,3*MaxAtoms),
+     +       Nsymop(3*MaxAtoms),Icounts,Rsymm(4,4,MaxSymmetry),
      +       RFin(4,4),FRclose(3),FRdist
 C     ..
       SAVE
@@ -5136,3 +5142,4 @@
       END
 C
 C
+
diff -ruN ccp4-6.0.1-orig/src/mmdb_app_/chainsaw.cpp ccp4-6.0.1/src/mmdb_app_/chainsaw.cpp
--- ccp4-6.0.1-orig/src/mmdb_app_/chainsaw.cpp	2006-05-25 08:29:53.000000000 -0700
+++ ccp4-6.0.1/src/mmdb_app_/chainsaw.cpp	2006-07-04 08:09:55.000000000 -0700
@@ -95,8 +95,6 @@
   natoms = residue->GetNumberOfAtoms();
   //printf("natoms = %d\n",natoms);
 
-
-
   if (!strcmp(template_res3name,"GLY")) {
 	  //printf("GLYCINE IN TEMPLATE\n");
 	  glycine = true;
@@ -118,6 +116,9 @@
 			  //printf("found C\n");
 			  foundC = true;
 		  }
+		  if (!strcmp(name, " OT1")) atomi->SetAtomName(" O  ");
+          // Model C terminal will not in general be target C terminal, so delete
+		  if (!strcmp(name, " OXT") || !strcmp(name, " OT2") || atomi->Ter) residue->DeleteAtom(i);
 	  }
 
 	  if (foundN && foundCA && foundC) {
@@ -193,6 +194,8 @@
   for (i=0;i<imax;i++) {
       atomi = residue->GetAtom(i);
 	  name = atomi->GetAtomName();
+	  // Mmdb doesn't like atom name OT1 from Moleman2 - fudge by renaming
+	  if (!strcmp(name, " OT1")) atomi->SetAtomName(" O  ");
 	  //printf("atom %s\n",name);
 	  //printf("excess atoms\n");
 	  //printf("%d %s\n",strlen(name), name);
@@ -201,7 +204,7 @@
 		  (strncmp(name, " OG", 3) || deleteG == true) && (strncmp(name, " CG", 3) || deleteG == true) ) {
 
 	      natoms -= residue->DeleteAtom(i);
-		  //printf("deleting %s\n",name);
+		  //printf("deleting atom\n");
 	  }
 	  if (!strcmp(name, " CB ")) deleteB = true;
 	  if (!strcmp(name, " SG ") || !strncmp(name, " OG", 3) || !strncmp(name, " CG", 3)) deleteG = true;
@@ -211,7 +214,7 @@
   // Deleting and adding back in ensures any conformation label is removed
 
   if (target_type != 'A' && target_type != 'G' && mode == 0) {
-      for (i=0;i<natoms;i++) {
+      for (i=0;i<natoms;i++) {	
           atomi = residue->GetAtom(i);
 	      name = atomi->GetAtomName();
 	      if (!strcmp(name, " SG ") || !strncmp(name, " OG", 3) || !strncmp(name, " CG", 3)) {
@@ -298,7 +301,7 @@
       break;
     }
   }
-  printf("itarget = %d, imodel = %d\n",itarget,imodel);
+  //printf("itarget = %d, imodel = %d\n",itarget,imodel);
 
   if (!strcmp(template_res3name,"GLY")) {
 	  //printf("GLYCINE IN TEMPLATE\n");
@@ -318,6 +321,8 @@
 			  Catom = residue->GetAtom(i);
 			  foundC = true;
 		  }
+		  if (!strcmp(name, " OT1")) atomi->SetAtomName(" O  ");
+		  if (!strcmp(name, " OXT") || !strcmp(name, " OT2") || atomi->Ter) residue->DeleteAtom(i);
 	  }
 
 	  if (foundN && foundCA && foundC) {
@@ -357,8 +362,8 @@
   // THIS IS THE IMPORTANT BIT
 
   if (glycine) {
-	residue->SetResName(target_res3name);
-	return(0);
+      residue->SetResName(target_res3name);
+      return(0);
   }
 
   for (i=0;i<natoms;i++) {
@@ -389,6 +394,7 @@
 	      }
 	      if (!retain) residue->DeleteAtom(i);
 	  }
+	  if (!strcmp(name, " OT1")) atomi->SetAtomName(" O  ");
   }
   
   // rename residue
@@ -440,7 +446,7 @@
   //  1.  General CCP4 initializations
   ccp4fyp         ( argc,argv );
   ccp4ProgramName ( "CHAINSAW"   );
-  ccp4RCSDate     ( "$Date: 2006/02/06 10:47:06 $" );
+  ccp4RCSDate     ( "$Date: 2006/05/10 12:46:53 $" ); 
   ccp4_banner();
 
   //  2.  Make routine initializations, which must always be done
diff -ruN ccp4-6.0.1-orig/src/molrep_/molrep.f ccp4-6.0.1/src/molrep_/molrep.f
--- ccp4-6.0.1-orig/src/molrep_/molrep.f	2006-05-25 08:29:53.000000000 -0700
+++ ccp4-6.0.1/src/molrep_/molrep.f	2006-08-12 22:06:18.000000000 -0700
@@ -15032,7 +15032,6 @@
       A1 = (ALPHA*PI)/180.0
       A2 = (BETA *PI)/180.0
       A3 = (GAMMA*PI)/180.0
-      DANGLE = (2.0*PI)/FLOAT(NCS)
 
       IF(IDZNCS.LE.0) IDZNCS = 1
       IF(IDZNCS.GT.IPRNCS) THEN
@@ -15042,6 +15041,8 @@
 
       NCS = IDZNCS
 
+      DANGLE = (2.0*PI)/FLOAT(NCS)
+
       DO I=1,NCS
         AA3 = A3 + DANGLE*FLOAT(I-1)
         CALL EULERM(A1,A2,AA3,ROT)
diff -ruN ccp4-6.0.1-orig/src/mtztona4.f ccp4-6.0.1/src/mtztona4.f
--- ccp4-6.0.1-orig/src/mtztona4.f	2006-05-25 08:29:53.000000000 -0700
+++ ccp4-6.0.1/src/mtztona4.f	2006-08-12 22:05:43.000000000 -0700
@@ -71,7 +71,7 @@
       LUNOUT = 6
       CALL CCPFYP
       CALL MTZINI
-      CALL CCPRCS(6,'MTZTONA4','$Date: 2005/09/06 11:25:18 $')
+      CALL CCPRCS(6,'MTZTONA4','$Date: 2006/07/31 16:00:16 $')
 C
 C
 C TRANSLATE FROM 'MTZ' TO 'NA4' FORMAT
@@ -226,6 +226,8 @@
 C
 C History headers
 C
+c Need to set NHIST to max allowed number of history lines on entry to LRHIST
+       nhist = mhistl
        CALL LRHIST (INDEX,HSCR,NHIST)
        IF (NHIST.GT.0) THEN
              WRITE (IUNOUT,2100)'MTZHIST',NHIST
diff -ruN ccp4-6.0.1-orig/src/omit.f ccp4-6.0.1/src/omit.f
--- ccp4-6.0.1-orig/src/omit.f	2006-05-25 08:29:53.000000000 -0700
+++ ccp4-6.0.1/src/omit.f	2006-08-12 22:05:21.000000000 -0700
@@ -2940,6 +2940,8 @@
 
 C READ TITLE AND HISTORY CARDS
       CALL LRTITL(1,MTZTIT(1),IDUM)
+      idum = 19
+c Need to set idum to max number of history lines on entry to LRHIST      
       CALL LRHIST(1,MTZTIT(2),IDUM)
 
       IF(MTZTIT(21)(1:10).NE.'          ')THEN
@@ -3062,11 +3064,11 @@
         CTYPOUT(L)=CTYPIN(L)
   250 CONTINUE
 
-C CHECK THAT THE INDICES INDEED OCCUPPY THE FIRST THREE COLUMNS
+C CHECK THAT THE INDICES INDEED OCCUPY THE FIRST THREE COLUMNS
 C UNFORTUNATELY IT CAN NOT BE CHECKED IF THE INDICES ARE ALSO STORED IN
 C THE RIGHT ORDER, E.G. H,K,L. JUST HOPE PEOPLE HAVE SOME LOGIC.
       IF(CTYPIN(1).NE.'H'.OR.CTYPIN(2).NE.'H'.OR.CTYPIN(3).NE.'H')THEN
-        WRITE(*,*)' H, K & L ARE NOT STORED IN COLUMS 1, 2 AND 3'
+        WRITE(*,*)' H, K & L ARE NOT STORED IN COLUMNS 1, 2 AND 3'
         WRITE(*,*)' OR COLUMN TYPES ARE ABSENT/INCORRECT IN YOUR MTZ'
         STOP
       ENDIF
@@ -3353,7 +3355,7 @@
                 WRITE(*,*)' COLUMN TYPES ARE:'
                 WRITE(*,*)(CTYPIN(J),J=4,MAXIB+3)
                 WRITE(*,*)
-                WRITE(*,*)' FOR THIS INPUT ABSENT FALGS ARE CONVERTED',
+                WRITE(*,*)' FOR THIS INPUT ABSENT FLAGS ARE CONVERTED',
      $                    ' TO BIOMOL CONVENTION'
                 WRITE(*,*)
                 WRITE(*,*)' NO SUBSEQUENT WARNINGS OF THIS FACT ARE',
diff -ruN ccp4-6.0.1-orig/src/polarrfn.f ccp4-6.0.1/src/polarrfn.f
--- ccp4-6.0.1-orig/src/polarrfn.f	2006-05-25 08:29:53.000000000 -0700
+++ ccp4-6.0.1/src/polarrfn.f	2006-08-12 22:05:00.000000000 -0700
@@ -146,7 +146,7 @@
 C
       CHARACTER CTPRGI(NLPRGI),LSPRGI(NLPRGI,2)*30
       LOGICAL LOGMSS(NLPRGI)
-      REAL ADATA(NLPRGI),COLRNG(2,NLPRGI)
+      REAL ADATA(NLPRGI),COLRNG(2,MCOLS)
       INTEGER LOOKUP(NLPRGI)
       INTEGER LSPGRP,NSM,IPRINT
       REAL RR(3,3,6),RO(4,4),RF(4,4)
diff -ruN ccp4-6.0.1-orig/src/rotmat.f ccp4-6.0.1/src/rotmat.f
--- ccp4-6.0.1-orig/src/rotmat.f	2006-05-25 08:29:53.000000000 -0700
+++ ccp4-6.0.1/src/rotmat.f	2006-08-12 22:02:57.000000000 -0700
@@ -19,7 +19,7 @@
 C
 C          ******
       CALL CCPFYP
-      CALL CCPRCS(6,'ROTMAT','$Date: 2005/09/06 11:25:23 $')
+      CALL CCPRCS(6,'ROTMAT','$Date: 2006/07/13 13:57:15 $')
       CALL MTZINI
 C          ******
 C
@@ -278,7 +278,7 @@
 C
 C----   Only need primitive symmetry operators
 C
-        JSYM(IXTL) = NSYM
+        JSYM(IXTL) = NSYMP
         LSPGRP(IXTL) = NSPGRP
         NAMSGS(IXTL) = NAMSGP
 C
diff -ruN ccp4-6.0.1-orig/src/sc_/sc.f ccp4-6.0.1/src/sc_/sc.f
--- ccp4-6.0.1-orig/src/sc_/sc.f	2006-05-25 08:29:48.000000000 -0700
+++ ccp4-6.0.1/src/sc_/sc.f	2006-07-04 08:10:38.000000000 -0700
@@ -47,7 +47,7 @@
 c
 c  CCP4 initialisations
       call ccpfyp
-      call ccprcs(6, 'SC', '$Date: 2005/09/06 11:30:20 $')
+      call ccprcs(6, 'SC', '$Date: 2006/05/15 12:23:37 $')
 c
       write(6,1)
  1    format(' Sc (Version 2.0): A program for determing Shape ',
@@ -108,12 +108,15 @@
 c Read in atomic radii
       call sc_radii
 c
-c Read in pdb file and assign radii to the protein atoms
+c Read in pdb file
       call readpdb
 c 
 c Read in atom selection and parameter changes
       call commands(grasp)
 c
+c Assign radii to included atoms only
+      call assign_r
+c
 c Write out selection to temporary file
       call writepdb
 c
@@ -204,8 +207,7 @@
       integer i,ifail,ixyzin,iresn,iser,iz,iun
       integer ichar,jchar,lenstr
       real occ,biso,u(6)
-      logical found,match
-      external match,xyzinit,xyzopen,xyzadvance,xyzatom,xyzcoord
+      external xyzinit,xyzopen,xyzadvance,xyzatom,xyzcoord
       external xyzclose,ccperr,lenstr
 
       common /tempfile/iun
@@ -236,17 +238,17 @@
          included(n_atoms) = 0
          res_type(n_atoms) = resnam
          chain(n_atoms) = chnam
-cpjx Mike points out that the res_name read from the file is right
+cpjx Mike points out that the resseqno read from the file is right
 cpjx justified but the comparisions in the ZONE keyword assume left
 cpjx justification.
 cpjx Fix is to left-justify the name when storing it
 cpjx The following construct actually removes _all_ spaces from the
 cpjx string, but should be sufficient for these purposes
-         res_name(n_atoms) = ' '
+         resseqno(n_atoms) = ' '
          ichar = 1
          do jchar = 1,lenstr(resno)
            if (resno(jchar:jchar).ne.' ') then
-             res_name(n_atoms)(ichar:ichar) = resno(jchar:jchar)
+             resseqno(n_atoms)(ichar:ichar) = resno(jchar:jchar)
              ichar = ichar + 1
            end if
          end do
@@ -257,28 +259,53 @@
          call xyzcoord(ixyzin,'O','U',x(n_atoms),y(n_atoms),z(n_atoms),
      .                 occ,biso,u)
 c     
-c     Assign radius
+      go to 100
+ 101  write(*,102)n_atoms
+ 102  format(/,' Number of atoms read from PDB file:   ',I7)
+      write(*,*) '  '
+      call xyzclose(ixyzin)
+      return
+      end
+
+c
+c-----------------------------------------------------------------------------
+c
+c This subroutine assigns the radii for included atoms
+c
+      subroutine assign_r
+c
+      implicit none
+c
+      include 'setup.fh'
+c
+      integer iatom, i
+      logical found,match
+      external match,ccperr
+c
+      do iatom = 1, n_atoms
+
+c        Assign radius
          found =.false.
          do i = 1, nrad
-            if(match(res_type(n_atoms),rad_res_type(i)).and.
-     .           match(atom_name(n_atoms),rad_atom_name(i))) then
-               rad_atom(n_atoms) = rad(i)
+            if(match(res_type(iatom),rad_res_type(i)).and.
+     .           match(atom_name(iatom),rad_atom_name(i))) then
+               rad_atom(iatom) = rad(i)
                found = .true.
             end if
          end do
-         if(.not.found) then
+         if(.not.found.and.included(iatom).ne.0) then
             write(*,*) 'No radius found for'
-            write(*,*) 'Residue ',res_type(n_atoms),' Atom ',
-     .                  atom_name(n_atoms)
-            call ccperr(1,' S/r READPDB: no radius for residue/atom')
+            write(*,*) 'Residue ',res_type(iatom),' Atom ',
+     .                  atom_name(iatom)
+            call ccperr(1,' S/r assign_r: no radius for residue/atom')
          end if
-      go to 100
- 101  write(*,102)n_atoms
- 102  format(/,' Number of atoms read from PDB file:   ',I7)
-      write(*,*) '  '
-      call xyzclose(ixyzin)
+
+      enddo
+
       return
+
       end
+
 c
 c-----------------------------------------------------------------------------
 c
@@ -461,7 +488,7 @@
 c     Find first atom
          i1 = 0
          do i= 1 ,n_atoms - 1
-            if(match(res_name(i),r1) .and. chain(i) .eq. ch1) then
+            if(match(resseqno(i),r1) .and. chain(i) .eq. ch1) then
                i1 = i
                go to 50
             end if
@@ -474,7 +501,7 @@
 c     Finds second atom
          i2 = 0
          do i = i1, n_atoms
-            if(match(res_name(i),r2) .and. chain(i) .eq. ch2) then
+            if(match(resseqno(i),r2) .and. chain(i) .eq. ch2) then
                i2 = i
                go to 51
             end if
@@ -507,7 +534,7 @@
          end if
          i1 = 0
          do i = 1, n_atoms
-            if(match(res_name(i),r) .and. match(atom_name(i),a) .and.
+            if(match(resseqno(i),r) .and. match(atom_name(i),a) .and.
      .           chain(i) .eq. ch) then
                i1 = i
                included(i) = mol
@@ -540,7 +567,7 @@
          end if
          i1 = 0
          do i = 1, n_atoms
-            if(match(res_name(i),r) .and. match(atom_name(i),a) .and.
+            if(match(resseqno(i),r) .and. match(atom_name(i),a) .and.
      .           chain(i) .eq. ch) then
                i1 = i
                included(i) = 0
@@ -756,7 +783,7 @@
                write(*,fmt='(/,a,a3,a,a4,2(a,a1),a,a4,/)')
      .                 '  * Residue ',res_type(i),'  Atom ',
      .                 atom_name(i),'  Altcode ',alt(i),'  Chain ',
-     .                 chain(i),'  Resno ',res_name(i)
+     .                 chain(i),'  Resno ',resseqno(i)
                write(*,*)' Multiple conformations not permitted in ',
      .                   'interface atoms -'
                write(*,*)' these must be removed manually from the PDB',
diff -ruN ccp4-6.0.1-orig/src/sc_/setup.fh ccp4-6.0.1/src/sc_/setup.fh
--- ccp4-6.0.1-orig/src/sc_/setup.fh	2006-05-25 08:29:48.000000000 -0700
+++ ccp4-6.0.1/src/sc_/setup.fh	2006-07-04 08:11:01.000000000 -0700
@@ -17,7 +17,7 @@
 
       character*3 res_type(MAXATOMS)
       character*1 chain(MAXATOMS),alt(MAXATOMS)
-      character*4 res_name(MAXATOMS)
+      character*4 resseqno(MAXATOMS)
       character*4 atom_name(MAXATOMS)
       character*4 rad_res_type(MAXRAD),rad_atom_name(MAXRAD)
       character*80 ctoken1(MAXFIELDS)
@@ -27,7 +27,7 @@
 
       common /bl2/ctoken1,ltoken,ntokens
       common /bl1/ rad_res_type,rad_atom_name,nrad,rad,alt
-      common /bl3/x,y,z,rad_atom,chain,res_name,atom_name,
+      common /bl3/x,y,z,rad_atom,chain,resseqno,atom_name,
      .            n_atoms,res_type
       common /bl14/ included
 
