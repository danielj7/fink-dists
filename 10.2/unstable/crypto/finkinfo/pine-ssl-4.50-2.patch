--- pine4.50/pine/osdep/os-osx.h.orig	Wed Nov 21 13:28:51 2001
+++ pine4.50/pine/osdep/os-osx.h	Wed Nov 21 13:30:51 2001
@@ -89,7 +90,7 @@
    default-composer-hdrs or customized-hdrs to get at it. Instead of
    defining NEVER_ALLOW_CHANGING_FROM, an easier way of preventing From
    changing is to put the feature "no-allow-changing-from" in the
-   /usr/local/lib/pine.conf.fixed file.
+   @PREFIX@/etc/pine.conf.fixed file.
  ----*/
 /* #define NEVER_ALLOW_CHANGING_FROM */
 
@@ -175,8 +176,8 @@
 
 
 /*----- System-wide config file ----------------------------------------*/
-#define SYSTEM_PINERC             "/usr/local/lib/pine.conf"
-#define SYSTEM_PINERC_FIXED       "/usr/local/lib/pine.conf.fixed"
+#define SYSTEM_PINERC             "@PREFIX@/etc/pine.conf"
+#define SYSTEM_PINERC_FIXED       "@PREFIX@/etc/pine.conf.fixed"
 
 
 
--- pine4.50/pine/pine.hlp.orig	Fri Nov 30 09:56:26 2001
+++ pine4.50/pine/pine.hlp	Fri Nov 30 09:56:47 2001
@@ -596,8 +596,8 @@
  executable     &lt;Unix search path&gt;/pine
  persnl cfg     ~/.pinerc
  except cfg     ~/.pinercex
- global cfg     /usr/local/lib/pine.conf
- fixed cfg      /usr/local/lib/pine.conf.fixed
+ global cfg     @PREFIX@/etc/pine.conf
+ fixed cfg      @PREFIX@/etc/pine.conf.fixed
  local help     /usr/local/lib/pine.info
 
  interrupted    ~/.pine-interrupted-mail
@@ -1952,7 +1952,7 @@
 file, execute
 
 <PRE><CODE>
-		pine -conf > /usr/local/lib/pine.conf
+		pine -conf > @PREFIX@/etc/pine.conf
 </CODE></PRE>
 <P>
 
@@ -1960,7 +1960,7 @@
 system configuration file, execute
 
 <PRE><CODE>
-		pine -P old-pine.conf -conf > /usr/local/lib/pine.conf
+		pine -P old-pine.conf -conf > @PREFIX@/etc/pine.conf
 </CODE></PRE>
 <P>
 A system configuration file is not required.
@@ -2112,7 +2112,7 @@
 <DT> -P <EM>pinerc</EM>
 
 <DD> Uses the named file as the system wide configuration file instead of
-<EM>/usr/local/lib/pine.conf</EM> on UNIX, or nothing on <EM>PC-Pine</EM>.
+<EM>@PREFIX@/etc/pine.conf</EM> on UNIX, or nothing on <EM>PC-Pine</EM>.
 Pinerc may be either a local file or a remote configuration folder.
 <P>
 
@@ -2820,10 +2820,10 @@
 </OL>
 <P>
 The fixed configuration file is normally
-<CODE>/usr/local/lib/pine.conf.fixed</CODE>.
+<CODE>@PREFIX@/etc/pine.conf.fixed</CODE>.
 <P>
 The system-wide configuration file is normally
-<CODE>/usr/local/lib/pine.conf</CODE> for Unix Pine and is normally not
+<CODE>@PREFIX@/etc/pine.conf</CODE> for Unix Pine and is normally not
 set for PC-Pine.
 For PC-Pine, if the environment variable <EM>$PINECONF</EM> is set, that
 is used for the system-wide configuration.
diff -Naur pine4.50-orig/build pine4.50/build
--- pine4.50-orig/build	Tue Nov  5 18:17:56 2002
+++ pine4.50/build	Tue Nov 26 11:03:21 2002
@@ -1,6 +1,6 @@
 #!/bin/sh
 #
-# $Id: build,v 4.87 2002/11/06 02:17:29 jpf Exp $
+# $Id: build,v 4.88 2002/11/26 00:35:00 hubert Exp $
 #
 #            T H E    P I N E    M A I L   S Y S T E M
 #
@@ -241,6 +241,17 @@
 	    1) if [ "$LLIBS" != "1" ]
 	       then
 		 L1="'LDAPLIBS=../ldap/libraries/libldap.a ../ldap/libraries/liblber.a'"
+	       fi
+	       if [ "$LFLAGS" != "1" ]
+	       then
+		 L2="'LDAPCFLAGS=-DENABLE_LDAP -I../ldap/include'"
+	       fi
+	       echo "Including LDAP functionality"
+	       ;;
+
+	    11) if [ "$LLIBS" != "1" ]
+	       then
+		 L1="'LDAPLIBS=../ldap/libraries/libldap/.libs/libldap.a ../ldap/libraries/liblber/.libs/liblber.a'"
 	       fi
 	       if [ "$LFLAGS" != "1" ]
 	       then
diff -Naur pine4.50-orig/contrib/krb5-setup pine4.50/contrib/krb5-setup
--- pine4.50-orig/contrib/krb5-setup	Fri Feb  4 12:06:29 2000
+++ pine4.50/contrib/krb5-setup	Tue Nov 26 11:03:40 2002
@@ -74,11 +74,11 @@
 
 
 # This is where c-client expects the libraries to be.
-if [ \( -f krb5/lib/libgssapi_krb5.a -o -f krb5/lib/libgssapi_krb5.so \) -a \
-     \( -f krb5/lib/libkrb5.a        -o -f krb5/lib/libkrb5.so \)        -a \
+if [ \( -f krb5/lib/libgssapi_krb5.a -o -f krb5/lib/libgssapi_krb5.dylib \) -a \
+     \( -f krb5/lib/libkrb5.a        -o -f krb5/lib/libkrb5.dylib \)        -a \
      \( -f krb5/lib/libcrypto.a      -o -f krb5/lib/libk5crypto.a    -o \
-        -f krb5/lib/libcrypto.so     -o -f krb5/lib/libk5crypto.so \)    -a \
-     \( -f krb5/lib/libcom_err.a     -o -f krb5/lib/libcom_err.so \) ]
+        -f krb5/lib/libcrypto.dylib     -o -f krb5/lib/libk5crypto.dylib \)    -a \
+     \( -f krb5/lib/libcom_err.a     -o -f krb5/lib/libcom_err.dylib \) ]
 then
     exit 0
 fi
diff -Naur pine4.50-orig/contrib/ldap-setup pine4.50/contrib/ldap-setup
--- pine4.50-orig/contrib/ldap-setup	Wed Nov 21 09:19:46 2001
+++ pine4.50/contrib/ldap-setup	Tue Nov 26 11:03:25 2002
@@ -1,6 +1,6 @@
 #!/bin/sh
 #
-# $Id: ldap-setup,v 1.13 2001/11/21 17:19:07 hubert Exp $
+# $Id: ldap-setup,v 1.14 2002/11/26 00:31:34 hubert Exp $
 #
 #            T H E    P I N E    M A I L   S Y S T E M
 #
@@ -41,7 +41,7 @@
 #
 #  Helper script for setting up LDAP
 #
-# Pine has been successfully compiled with OpenLDAP 2.0.4, OpenLDAP 1.x,
+# Pine has been successfully compiled with OpenLDAP 2.1.8, 2.0.27, and 1.2.13;
 # the University of Michigan LDAP source (ldap-3.3), and with the
 # Netscape Directory SDK 1.0.
 #
@@ -76,7 +76,9 @@
 # The build script is looking for an exit value of 1, 2, 3, or 4 from this
 # script. 1 means this is a UMICH-style setup (with liblber.a) and 2 means
 # there is no liblber.a, just libldap.a. 3 means that the library is in a
-# standard location and so can be accessed with -lldap. 4 means don't attempt
+# standard location and so can be accessed with -lldap. 11 is like 1 with
+# two libraries but they are in ldap/libldap/.libs/libldap.a and
+# ldap/liblber/.libs/liblber.a instead. 4 means don't attempt
 # to include LDAP support. Anything else is an error.
 
 exitval=0
@@ -94,7 +96,7 @@
 if [ ! -d ldap ]
 then
     # User didn't configure LDAP but
-    # attempt automatic LDAP inclusion on Solaris
+    # attempt automatic LDAP inclusion on Solaris and MacOS X
     set `uname -s -r`
     exitval=6
     if [ "$1" = "SunOS" ]; then
@@ -111,6 +113,20 @@
 	  echo "/usr/lib/libldap.so not found"
 	fi
       fi
+    elif [ "$1" = "Darwin" ]; then
+      set `echo $2 | tr "." " "`
+      if [ "$1" -ge "6" ]; then
+        exitval=4
+        if [ -f /usr/lib/libldap.dylib ]; then
+	  if [ -f /usr/include/ldap.h ]; then
+	    exit 3				# EXIT successfull
+	  else
+	    echo "/usr/include/ldap.h not found"
+	  fi
+        else
+	  echo "/usr/lib/libldap.dylib not found"
+	fi
+      fi
     fi
 elif [ ! -d ldap/libraries ]
 then
@@ -127,9 +143,12 @@
 fi
 
 
+
 # Figure out if this is the Umich ldap-3.3 tree or something else, like
 # the Netscape SDK. Style 1 is umich, style 2 is Netscape SDK, style 3 is
 # mozilla.org.
+# Style 11 is similar to 1 but the libraries are in a subdir. This is
+# getting ridiculous.
 style=2
 if [ $exitval -eq 0 -a -d ldap/libraries/liblber ]
 then
@@ -139,11 +158,14 @@
 if [ $exitval -eq 0 -a \( $style -eq 2 -a -f ldap/libraries/liblber.a -a -f ldap/libraries/libldap.a \) ]
 then
     style=3
+elif [ $exitval -eq 0 -a \( $style -eq 1 -a -f ldap/libraries/liblber/.libs/liblber.a -a -f ldap/libraries/libldap/.libs/libldap.a \) ]
+then
+    style=11
 fi
 
 # This is a successful exit. The value of style tells build whether to include
 # the liblber.a library or not.
-if [ $exitval -eq 0 -a \( \( $style -eq 1 -a -f ldap/libraries/liblber.a -a -f ldap/libraries/libldap.a \) -o \( $style -eq 2 -a -f ldap/libraries/libldap.a \) -o \( $style -eq 3 \) \) ]
+if [ $exitval -eq 0 -a \( \( $style -eq 1 -a -f ldap/libraries/liblber.a -a -f ldap/libraries/libldap.a \) -o \( $style -eq 11 \) -o \( $style -eq 2 -a -f ldap/libraries/libldap.a \) -o \( $style -eq 3 \) \) ]
 then
     if [ $style -eq 3 ]
     then
diff -Naur pine4.50-orig/imap/src/c-client/auth_gss.c pine4.50/imap/src/c-client/auth_gss.c
--- pine4.50-orig/imap/src/c-client/auth_gss.c	Wed Nov 21 20:07:04 2001
+++ pine4.50/imap/src/c-client/auth_gss.c	Tue Nov 26 11:03:40 2002
@@ -125,10 +125,17 @@
   else {
     data = (*bn) (BLOCK_SENSITIVE,NIL);
 				/* negotiate with KDC */
+#ifdef OSX_HACK
+    dup2(0,6);
+    close(0);
+#endif
     smj = gss_init_sec_context (&smn,GSS_C_NO_CREDENTIAL,&ctx,crname,NIL,
 				GSS_C_MUTUAL_FLAG | GSS_C_REPLAY_FLAG,0,
 				GSS_C_NO_CHANNEL_BINDINGS,GSS_C_NO_BUFFER,NIL,
 				&resp,NIL,NIL);
+#ifdef OSX_HACK
+    dup2(6,0);
+#endif
     (*bn) (BLOCK_NONSENSITIVE,data);
     switch (smj) {
     case GSS_S_CONTINUE_NEEDED:
@@ -140,11 +147,18 @@
 	gss_release_buffer (&smn,&resp);
 	if (i) {		/* negotiate continuation with KDC */
 	  data = (*bn) (BLOCK_SENSITIVE,NIL);
+#ifdef OSX_HACK
+    dup2(0,6);
+    close(0);
+#endif
 	  smj = gss_init_sec_context (&smn,GSS_C_NO_CREDENTIAL,&ctx,crname,
 				      GSS_C_NO_OID,
 				      GSS_C_MUTUAL_FLAG|GSS_C_REPLAY_FLAG,0,
 				      GSS_C_NO_CHANNEL_BINDINGS,&chal,NIL,
 				      &resp,NIL,NIL);
+#ifdef OSX_HACK
+    dup2(6,0);
+#endif
 	  (*bn) (BLOCK_NONSENSITIVE,data);
 	}
       } while (i && (smj == GSS_S_CONTINUE_NEEDED));
diff -Naur pine4.50-orig/pine/adrbkcmd.c pine4.50/pine/adrbkcmd.c
--- pine4.50-orig/pine/adrbkcmd.c	Mon Nov  4 13:09:47 2002
+++ pine4.50/pine/adrbkcmd.c	Tue Nov 26 11:03:30 2002
@@ -1,5 +1,5 @@
 #if !defined(lint) && !defined(DOS)
-static char rcsid[] = "$Id: adrbkcmd.c,v 4.173 2002/11/04 21:09:09 hubert Exp $";
+static char rcsid[] = "$Id: adrbkcmd.c,v 4.174 2002/11/26 00:40:02 hubert Exp $";
 #endif
 /*----------------------------------------------------------------------
 
@@ -7287,17 +7287,35 @@
     LDAPMessage     *result;
     LDAP_SERV_S     *info;
     LDAP_SERV_RES_S *serv_res = NULL;
+    LDAPURLDesc     *ldapurl = NULL;
     WP_ERR_S wp_err;
 
     dprint(2, (debugfile, "url_local_ldap(%s)\n", url));
 
+    ld_err = ldap_url_parse(url, &ldapurl);
+    if(ld_err || !ldapurl){
+      sprintf(ebuf, "URL parse failed for %.200s", url);
+      q_status_message(SM_ORDER, 3, 5, ebuf);
+      return(retval);
+    }
+
+    if(!ldapurl->lud_host){
+      sprintf(ebuf, "No host in %.200s", url);
+      q_status_message(SM_ORDER, 3, 5, ebuf);
+      ldap_free_urldesc(ldapurl);
+      return(retval);
+    }
+    
     we_cancel = busy_alarm(1, "Searching for LDAP url", NULL, 1);
     intr_handling_on();
     ps_global->mangled_footer = 1;
 
-    if((ld = ldap_init(NULL, 0)) == NULL){
+#if (LDAPAPI >= 11)
+    if((ld = ldap_init(ldapurl->lud_host, ldapurl->lud_port)) == NULL)
+#else
+    if((ld = ldap_open(ldapurl->lud_host, ldapurl->lud_port)) == NULL)
+#endif
       q_status_message(SM_ORDER,3,5, "LDAP search failed: can't initialize");
-    }
     else if(!ps_global->intr_pending){
       if(ldap_v3_is_supported(ld) &&
 	 our_ldap_set_option(ld, LDAP_OPT_PROTOCOL_VERSION, &proto) == 0){
@@ -7311,10 +7329,13 @@
       our_ldap_set_option(ld, LDAP_OPT_RESTART, LDAP_OPT_ON);
 
       t.tv_sec = 30; t.tv_usec = 0;
-      if((ld_err = ldap_url_search_st(ld,url,0,&t,&result)) != LDAP_SUCCESS){
-	sprintf(ebuf, "LDAP search failed: %.200s", ldap_err2string(ld_err));
-	q_status_message(SM_ORDER, 3, 5, ebuf);
-	ldap_unbind(ld);
+      ld_err = ldap_search_st(ld, ldapurl->lud_dn, ldapurl->lud_scope,
+			      ldapurl->lud_filter, ldapurl->lud_attrs,
+			      0, &t, &result);
+      if(ld_err != LDAP_SUCCESS){
+	  sprintf(ebuf, "LDAP search failed: %.200s", ldap_err2string(ld_err));
+	  q_status_message(SM_ORDER, 3, 5, ebuf);
+	  ldap_unbind(ld);
       }
       else if(!ps_global->intr_pending){
 	intr_handling_off();
@@ -7357,6 +7378,9 @@
     intr_handling_off();
     if(we_cancel)
       cancel_busy_alarm(-1);
+
+    if(ldapurl)
+      ldap_free_urldesc(ldapurl);
 
     return(retval);
 }
--- pine4.50/imap/src/c-client/mail.c.orig	Sun Dec  1 13:54:33 2002
+++ pine4.50/imap/src/c-client/mail.c	Sun Dec  1 13:55:38 2002
@@ -3739,7 +3739,7 @@
 	if (!s->arrival) {
 				/* internal date unknown but can get? */
 	  if (!elt->day && !(stream->dtb->flags & DR_NOINTDATE)) {
-	    sprintf (tmp,"%lu",i);
+	    sprintf (tmp,"%lu",s->num);
 	    mail_fetch_fast (stream,tmp,NIL);
 	  }
 				/* wrong thing before 3-Jan-1970 */
