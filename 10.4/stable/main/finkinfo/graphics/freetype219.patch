diff -ruN freetype-2.2.1-orig/include/freetype/config/ftoption.h freetype-2.2.1/include/freetype/config/ftoption.h
--- freetype-2.2.1-orig/include/freetype/config/ftoption.h	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/include/freetype/config/ftoption.h	2006-12-02 22:33:51.000000000 -0800
@@ -448,7 +448,7 @@
   /* FT_PARAM_TAG_UNPATENTED_HINTING; or when the debug hook               */
   /* FT_DEBUG_HOOK_UNPATENTED_HINTING is globally activated.               */
   /*                                                                       */
-#define TT_CONFIG_OPTION_UNPATENTED_HINTING
+/* #define TT_CONFIG_OPTION_UNPATENTED_HINTING */
 
 
   /*************************************************************************/
diff -ruN freetype-2.2.1-orig/include/freetype/freetype.h freetype-2.2.1/include/freetype/freetype.h
--- freetype-2.2.1-orig/include/freetype/freetype.h	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/include/freetype/freetype.h	2006-12-02 22:33:51.000000000 -0800
@@ -17,11 +17,7 @@
 
 
 #ifndef FT_FREETYPE_H
-#error "`ft2build.h' hasn't been included yet!"
-#error "Please always use macros to include FreeType header files."
-#error "Example:"
-#error "  #include <ft2build.h>"
-#error "  #include FT_FREETYPE_H"
+#include <ft2build.h>
 #endif
 
 
diff -ruN freetype-2.2.1-orig/src/base/ftapi.c freetype-2.2.1/src/base/ftapi.c
--- freetype-2.2.1-orig/src/base/ftapi.c	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/src/base/ftapi.c	2006-12-02 22:33:51.000000000 -0800
@@ -117,5 +117,17 @@
     FT_Stream_ExitFrame( stream );
   }
                    
+  FT_BASE_DEF( FT_Short )
+  FT_Get_Short( FT_Stream stream )
+  {
+    return FT_GET_SHORT();
+  }
+
+
+  FT_BASE_DEF( FT_Long )
+  FT_Get_Long( FT_Stream stream )
+  {
+    return FT_GET_LONG();
+  }
 
 /* END */
diff -ruN freetype-2.2.1-orig/src/base/ftbase.c freetype-2.2.1/src/base/ftbase.c
--- freetype-2.2.1-orig/src/base/ftbase.c	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/src/base/ftbase.c	2006-12-02 22:33:51.000000000 -0800
@@ -30,6 +30,7 @@
 #include "ftobjs.c"
 #include "ftnames.c"
 #include "ftrfork.c"
+#include "ftapi.c"
 
 #if defined( __APPLE__ ) && !defined ( DARWIN_NO_CARBON )
 #include "ftmac.c"
diff -ruN freetype-2.2.1-orig/src/base/ftmac.c freetype-2.2.1/src/base/ftmac.c
--- freetype-2.2.1-orig/src/base/ftmac.c	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/src/base/ftmac.c	2006-12-02 22:33:51.000000000 -0800
@@ -53,6 +53,12 @@
     - If there is a TrueType font (an `sfnt' resource), read it into memory,
       wrap it into a memory stream, load the TrueType driver and delegate
       the rest of the work to it, by calling FT_Open_Face().
+
+    - Some suitcase fonts (notably Onyx) might point the `LWFN' file to
+      itself, even though it doesn't contains `POST' resources.  To handle
+      this special case without opening the file an extra time, we just
+      ignore errors from the `LWFN' and fallback to the `sfnt' if both are
+      available.
   */
 
 
@@ -64,11 +70,13 @@
   /* This is for Mac OS X.  Without redefinition, OS_INLINE */
   /* expands to `static inline' which doesn't survive the   */
   /* -ansi compilation flag of GCC.                         */
+#undef  OS_INLINE
 #define OS_INLINE   static __inline__
 #include <Carbon/Carbon.h>
 #else
 #include <Resources.h>
 #include <Fonts.h>
+#include <Endian.h>
 #include <Errors.h>
 #include <Files.h>
 #include <TextUtils.h>
@@ -536,7 +544,8 @@
     /* The count is 1 greater than the value in the FOND.  */
     /* Isn't that cute? :-)                                */
 
-    return 1 + *( (short*)( fond_data + sizeof ( FamRec ) ) );
+    return EndianS16_BtoN( *( (short*)( fond_data +
+                                        sizeof ( FamRec ) ) ) ) + 1;
   }
 
 
@@ -549,13 +558,14 @@
 
 
     fond     = (FamRec*)fond_data;
-    face_all = *( (short *)( fond_data + sizeof ( FamRec ) ) ) + 1;
+    face_all = EndianS16_BtoN( *( (short *)( fond_data +
+                                             sizeof ( FamRec ) ) ) ) + 1;
     assoc    = (AsscEntry*)( fond_data + sizeof ( FamRec ) + 2 );
     face     = 0;
 
     for ( i = 0; i < face_all; i++ )
     {
-      if ( 0 == assoc[i].fontSize )
+      if ( 0 == EndianS16_BtoN( assoc[i].fontSize ) )
         face++;
     }
     return face;
@@ -597,19 +607,19 @@
 
       /* if the face at this index is not scalable,
          fall back to the first one (old behavior) */
-      if ( assoc->fontSize == 0 )
+      if ( EndianS16_BtoN( assoc->fontSize ) == 0 )
       {
         *have_sfnt = 1;
-        *sfnt_id   = assoc->fontID;
+        *sfnt_id   = EndianS16_BtoN( assoc->fontID );
       }
       else if ( base_assoc->fontSize == 0 )
       {
         *have_sfnt = 1;
-        *sfnt_id   = base_assoc->fontID;
+        *sfnt_id   = EndianS16_BtoN( base_assoc->fontID );
       }
     }
 
-    if ( fond->ffStylOff )
+    if ( EndianS32_BtoN( fond->ffStylOff ) )
     {
       unsigned char*  p = (unsigned char*)fond_data;
       StyleTable*     style;
@@ -619,10 +629,10 @@
       int             i;
 
 
-      p += fond->ffStylOff;
+      p += EndianS32_BtoN( fond->ffStylOff );
       style = (StyleTable*)p;
       p += sizeof ( StyleTable );
-      string_count = *(unsigned short*)(p);
+      string_count = EndianS16_BtoN( *(short*)(p) );
       p += sizeof ( short );
 
       for ( i = 0; i < string_count && i < 64; i++ )
@@ -770,13 +780,13 @@
     Str255    lwfn_file_name;
     UInt8     buff[HFS_MAXPATHLEN];
     FT_Error  err;
+    short     num_faces;
 
 
     have_sfnt = have_lwfn = 0;
 
     HLock( fond );
     parse_fond( *fond, &have_sfnt, &sfnt_id, lwfn_file_name, 0 );
-    HUnlock( fond );
 
     if ( lwfn_file_name[0] )
     {
@@ -787,9 +797,12 @@
     }
 
     if ( have_lwfn && ( !have_sfnt || PREFER_LWFN ) )
-      return 1;
+      num_faces = 1;
     else
-      return count_faces_scalable( *fond );
+      num_faces = count_faces_scalable( *fond );
+
+    HUnlock( fond );
+    return num_faces;
   }
 
 
@@ -1010,6 +1023,8 @@
     error = FT_Open_Face( library, &args, face_index, aface );
     if ( error == FT_Err_Ok )
       (*aface)->face_flags &= ~FT_FACE_FLAG_EXTERNAL_STREAM;
+    else
+      FT_Stream_Free( stream, 0 );
 
     return error;
   }
@@ -1150,7 +1165,7 @@
     Str255    lwfn_file_name;
     UInt8     path_lwfn[HFS_MAXPATHLEN];
     OSErr     err;
-    FT_Error  error;
+    FT_Error  error = FT_Err_Ok;
 
 
     GetResInfo( fond, &fond_id, &fond_type, fond_name );
@@ -1233,19 +1248,21 @@
     }
 
     if ( have_lwfn && ( !have_sfnt || PREFER_LWFN ) )
-      return FT_New_Face_From_LWFN( library,
+      error = FT_New_Face_From_LWFN( library,
                                     path_lwfn,
                                     face_index,
                                     aface );
+    else
+      error = FT_Err_Unknown_File_Format;
 
   found_no_lwfn_file:
-    if ( have_sfnt )
-      return FT_New_Face_From_SFNT( library,
+    if ( have_sfnt && FT_Err_Ok != error )
+      error = FT_New_Face_From_SFNT( library,
                                     sfnt_id,
                                     face_index,
                                     aface );
 
-    return FT_Err_Unknown_File_Format;
+    return error;
   }
 
 
diff -ruN freetype-2.2.1-orig/src/base/ftrfork.c freetype-2.2.1/src/base/ftrfork.c
--- freetype-2.2.1-orig/src/base/ftrfork.c	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/src/base/ftrfork.c	2006-12-02 22:39:34.000000000 -0800
@@ -440,7 +440,7 @@
       return error;
 
     FT_MEM_COPY( newpath, base_file_name, base_file_len );
-    FT_MEM_COPY( newpath + base_file_len, "/rsrc", 6 );
+    FT_MEM_COPY( newpath + base_file_len, "/..namedfork/rsrc", 18 );
 
     *result_file_name = newpath;
     *result_offset    = 0;
diff -ruN freetype-2.2.1-orig/src/bdf/bdflib.c freetype-2.2.1/src/bdf/bdflib.c
--- freetype-2.2.1-orig/src/bdf/bdflib.c	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/src/bdf/bdflib.c	2006-12-02 22:33:51.000000000 -0800
@@ -1570,6 +1570,14 @@
         goto Exit;
       }
 
+      /* Check that the encoding is in the range [0, 65535] because       */
+      /* otherwise p->have (a bitmap with static size) overflows.         */
+      if ( p->glyph_enc >= sizeof(p->have) * 8 )
+      {
+        error = BDF_Err_Invalid_File_Format; /* Not the ideal error code */
+        goto Exit;
+      }
+
       /* Check to see whether this encoding has already been encountered. */
       /* If it has then change it to unencoded so it gets added if        */
       /* indicated.                                                       */
diff -ruN freetype-2.2.1-orig/src/pcf/pcfread.c freetype-2.2.1/src/pcf/pcfread.c
--- freetype-2.2.1-orig/src/pcf/pcfread.c	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/src/pcf/pcfread.c	2006-12-02 22:33:51.000000000 -0800
@@ -439,6 +439,14 @@
 
     for ( i = 0; i < nprops; i++ )
     {
+      /* 2006:0500 (mbarnes) - Detect invalid string length.
+       * XXX Is this is best error code to return? */
+      if ( props[i].name < 0 )
+      {
+        error = FT_Err_Invalid_File_Format;
+        goto Bail;
+      }
+
       /* XXX: make atom */
       if ( FT_NEW_ARRAY( properties[i].name,
                          ft_strlen( strings + props[i].name ) + 1 ) )
@@ -451,6 +459,14 @@
 
       if ( props[i].isString )
       {
+	/* 2006:0500 (mbarnes) - Detect invalid string length.
+         * XXX Is this the best error code to return? */
+        if ( props[i].value < 0 )
+        {
+          error = FT_Err_Invalid_File_Format;
+          goto Bail;
+        }
+
         if ( FT_NEW_ARRAY( properties[i].value.atom,
                            ft_strlen( strings + props[i].value ) + 1 ) )
           goto Bail;
diff -ruN freetype-2.2.1-orig/src/sfnt/ttmtx.c freetype-2.2.1/src/sfnt/ttmtx.c
--- freetype-2.2.1-orig/src/sfnt/ttmtx.c	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/src/sfnt/ttmtx.c	2006-12-02 22:33:51.000000000 -0800
@@ -169,7 +169,7 @@
     }
 
     if ( FT_QNEW_ARRAY( *longs,  num_longs  ) ||
-         FT_QNEW_ARRAY( *shorts, num_shorts ) )
+         (num_shorts > 0 && FT_QNEW_ARRAY( *shorts, num_shorts ) ) )
       goto Fail;
 
     if ( FT_FRAME_ENTER( table_len ) )
diff -ruN freetype-2.2.1-orig/src/truetype/ttgload.c freetype-2.2.1/src/truetype/ttgload.c
--- freetype-2.2.1-orig/src/truetype/ttgload.c	2006-12-02 22:33:25.000000000 -0800
+++ freetype-2.2.1/src/truetype/ttgload.c	2006-12-02 22:33:51.000000000 -0800
@@ -932,7 +932,7 @@
   {
     FT_Error     error;
     FT_Outline*  outline;
-
+    int i;
 
     outline = &loader->gloader->base.outline;
 
@@ -989,6 +989,12 @@
 
     tt_prepare_zone( &loader->zone, &loader->gloader->base,
                      start_point, start_contour );
+    /* Some points are likely touched during execution of
+     * instructions on components. So let's untouch them.
+     */
+    for (i = 0; i < loader->zone.n_points; i++)
+           loader->zone.tags[i] &= ~(FT_CURVE_TAG_TOUCH_X | FT_CURVE_TAG_TOUCH_Y);
+
     loader->zone.n_points += 4;
 
     return TT_Hint_Glyph( loader, 1 );
diff -ruN freetype-2.2.1-orig/modules.cfg freetype-2.2.1/modules.cfg
--- freetype-2.2.1-orig/modules.cfg	2006-03-01 02:01:21.000000000 +0900
+++ freetype-2.2.1/modules.cfg	2006-11-19 15:40:45.000000000 +0900
@@ -124,7 +124,7 @@
 
 # OpenType table validation.  Needs ftotval.c below.
 #
-# AUX_MODULES += otvalid
+AUX_MODULES += otvalid
 
 # Auxiliary PostScript driver component to share common code.
 #
